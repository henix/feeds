<div class="title-image"><img src="https://pic4.zhimg.com/v2-f701e05be4c42a0cc01c5d9148a6e8c3_b.jpg" alt=""></div><blockquote>人生若只如初见，何事秋风悲画扇。等闲变却故人心，却道故人心易变。<br/>                                                                               --《木兰花》 纳兰容若</blockquote><p>多因子模型的介绍文章汗牛充栋，但系统性的归纳整理首推石川博士的多因子系列文章，看完绝对让人有醍醐灌顶的感觉。其次大部分多因子文章都是聚焦于方法论层面的探讨，却很少有深入到代码实现层面的讲解，这对于大部分初次接触多因子模型的用户来说似乎总隔着一层窗户纸。秉着<b>Talk is cheap，show me the code</b>的理念，这里来和大家一起复现一下各券商金工研报中经常会提到的纯因子收益率的实现逻辑。由于是个人的理解，纰漏在所难免，欢迎指正。</p><p>那什么是纯因子收益率呢？它和我们通常谈论的多空组合因子收益率又有什么差异？</p><p><b>对于任意投资组合，如果该组合对于某个指定因子的暴露度为 1，而对其他因子的暴露度为 0，则称该投资组合为指定因子的纯因子组合</b>。纯因子收益率的实现不同于我们常说的高低分组，因为高低分组求出的多空收益率并不能完全保证投资组合在其他因子上的暴露度恰好为0，比如高低估值分组求估值因子的收益率便会面临着其在市值因子上也存在着明显暴露，因为通常而言，高估值组对应小市值，低估值组对应大市值。</p><p><img src="https://www.zhihu.com/equation?tex=%3E%3E+Weighted+Least+Square%28WLS%29" alt="&gt;&gt; Weighted Least Square(WLS)" eeimg="1"/> </p><p>为了解决投资组合在其他因子上存在风格暴露的问题，一般是通过使用基于截面回归的加权最小二乘法（Weigthed Least Square, WLS）来计算投资组合不同因子下对应的股票权重。在复现之前，我们来简单回顾一下BARRA CNE5中的多因子模型框架。</p><p>考虑一个包含 <img src="https://www.zhihu.com/equation?tex=n" alt="n" eeimg="1"/> 只股票的投资组合，其可以用 <img src="https://www.zhihu.com/equation?tex=k" alt="k" eeimg="1"/> 个因子进行解释， <img src="https://www.zhihu.com/equation?tex=k" alt="k" eeimg="1"/> 个因子中包括 <img src="https://www.zhihu.com/equation?tex=1" alt="1" eeimg="1"/> 个国家因子， <img src="https://www.zhihu.com/equation?tex=p" alt="p" eeimg="1"/> 个行业因子， <img src="https://www.zhihu.com/equation?tex=q" alt="q" eeimg="1"/> 个风格因子，即<img src="https://www.zhihu.com/equation?tex=k+%3D+1+%2B+p+%2B+q" alt="k = 1 + p + q" eeimg="1"/> 。一般表达式如下：</p><p><img src="https://www.zhihu.com/equation?tex=r_%7Bn%2C1%7D+%3D+X_%7Bn%2C+k%7D+f_%7Bk%2C+1%7D+%2B+%5Cepsilon_%7Bn%2C+1%7D" alt="r_{n,1} = X_{n, k} f_{k, 1} + \epsilon_{n, 1}" eeimg="1"/> </p><p>为了便于理解，通常转换成矩阵的表现形式：</p><p><img src="https://www.zhihu.com/equation?tex=%5Cleft%5B+%5Cbegin%7Bmatrix%7D+r_1+%5C%5C+r_2+%5C%5C+%5Cvdots+%5C%5C+r_n+%5Cend%7Bmatrix%7D+%5Cright%5D+%3D++%5Cleft%5B+%5Cbegin%7Bmatrix%7D+1++++++%26+x_%7B1%7D%5E%7BI_1%7D+%26+%5Ccdots+%26+x_%7B1%7D%5E%7BI_p%7D+%26+x_%7B1%7D%5E%7BS_1%7D+%26+%5Ccdots++%26+x_%7B1%7D%5E%7BS_q%7D+%5C%5C+1++++++%26+x_%7B2%7D%5E%7BI_1%7D+%26+%5Ccdots+%26+x_%7B2%7D%5E%7BI_p%7D+%26+x_%7B2%7D%5E%7BS_1%7D+%26+%5Ccdots++%26+x_%7B2%7D%5E%7BS_q%7D+%5C%5C+%5Cvdots+%26+%5Cvdots++++++%26+%5Cddots+%26+%5Cvdots++++++%26+%5Cvdots++++++%26+%5Cddots++%26+%5Cvdots++++++%5C%5C+1++++++%26+x_%7Bn%7D%5E%7BI_1%7D+%26+%5Ccdots+%26+x_%7Bn%7D%5E%7BI_p%7D+%26+x_%7Bn%7D%5E%7BS_1%7D+%26+%5Ccdots++%26+x_%7Bn%7D%5E%7BS_q%7D+%5C%5C+%5Cend%7Bmatrix%7D+%5Cright%5D++%5Cleft%5B+%5Cbegin%7Bmatrix%7D+f_C+%5C%5C+f_%7BI_1%7D+%5C%5C+%5Cvdots++%5C%5C+f_%7BI_p%7D+%5C%5C+f_%7BS_1%7D+%5C%5C+%5Cvdots++%5C%5C+f_%7BS_q%7D+%5C%5C+%5Cend%7Bmatrix%7D+%5Cright%5D+%2B+%5Cleft%5B+%5Cbegin%7Bmatrix%7D+%5Cepsilon_1+%5C%5C+%5Cepsilon_2+%5C%5C+%5Cvdots+%5C%5C+%5Cepsilon_n+%5Cend%7Bmatrix%7D+%5Cright%5D" alt="\left[ \begin{matrix} r_1 \\ r_2 \\ \vdots \\ r_n \end{matrix} \right] =  \left[ \begin{matrix} 1      &amp; x_{1}^{I_1} &amp; \cdots &amp; x_{1}^{I_p} &amp; x_{1}^{S_1} &amp; \cdots  &amp; x_{1}^{S_q} \\ 1      &amp; x_{2}^{I_1} &amp; \cdots &amp; x_{2}^{I_p} &amp; x_{2}^{S_1} &amp; \cdots  &amp; x_{2}^{S_q} \\ \vdots &amp; \vdots      &amp; \ddots &amp; \vdots      &amp; \vdots      &amp; \ddots  &amp; \vdots      \\ 1      &amp; x_{n}^{I_1} &amp; \cdots &amp; x_{n}^{I_p} &amp; x_{n}^{S_1} &amp; \cdots  &amp; x_{n}^{S_q} \\ \end{matrix} \right]  \left[ \begin{matrix} f_C \\ f_{I_1} \\ \vdots  \\ f_{I_p} \\ f_{S_1} \\ \vdots  \\ f_{S_q} \\ \end{matrix} \right] + \left[ \begin{matrix} \epsilon_1 \\ \epsilon_2 \\ \vdots \\ \epsilon_n \end{matrix} \right]" eeimg="1"/> </p><p>其中，各变量对应的含义如下：</p><p><img src="https://www.zhihu.com/equation?tex=r%3A" alt="r:" eeimg="1"/> 个股超额收益率向量   </p><p><img src="https://www.zhihu.com/equation?tex=X%3A" alt="X:" eeimg="1"/> 因子暴露度矩阵  </p><p><img src="https://www.zhihu.com/equation?tex=f%3A" alt="f:" eeimg="1"/> 因子收益率向量  </p><p><img src="https://www.zhihu.com/equation?tex=%5Cepsilon%3A" alt="\epsilon:" eeimg="1"/> 特异性收益率向量  </p><p>可以看到，在该框架下，新引入了一个国家因子，用来代表全市场的收益率。但由于任意一支股票在所有行业的暴露度之和始终为1（行业暴露度是0、1哑变量），而单支股票在国家因子上的暴露度又始终为1，所以导致了国家因子和行业因子之间存在明显的共线性，进而导致矩阵不可逆，使得模型不存在唯一解。为此，我们需要对行业的因子收益率做一定的约束，通常的做法是使行业因子收益率按流通市值加权的和等于0，写成表达式如下：</p><p><img src="https://www.zhihu.com/equation?tex=%5Csum_%7Bi%3D1%7D%5E%7Bp%7Df_%7BI_i%7Dw_%7BI_i%7D%3D0" alt="\sum_{i=1}^{p}f_{I_i}w_{I_i}=0" eeimg="1"/> </p><p>其中，<img src="https://www.zhihu.com/equation?tex=w_%7BI_i%7D" alt="w_{I_i}" eeimg="1"/> 表示行业 <img src="https://www.zhihu.com/equation?tex=i" alt="i" eeimg="1"/> 中所有股票的流通市值占全市场的流通市值的比例。考虑约束条件后，便可以将 <img src="https://www.zhihu.com/equation?tex=k" alt="k" eeimg="1"/> 个因子收益率转换成 <img src="https://www.zhihu.com/equation?tex=k-1" alt="k-1" eeimg="1"/> 个因子收益率的线性表达式，其中 <img src="https://www.zhihu.com/equation?tex=k-1+%3D+1+%2B+%28p-1%29+%2B+q" alt="k-1 = 1 + (p-1) + q" eeimg="1"/> 。假设第 <img src="https://www.zhihu.com/equation?tex=p" alt="p" eeimg="1"/> 个行业因子被扣除，则可以表述为以下矩阵形式：</p><p><img src="https://www.zhihu.com/equation?tex=%5Cleft%5B+%5Cbegin%7Bmatrix%7D+f_C+%5C%5C+f_%7BI_1%7D+%5C%5C+%5Cvdots++%5C%5C+f_%7BI_p%7D+%5C%5C+f_%7BS_1%7D+%5C%5C+%5Cvdots++%5C%5C+f_%7BS_q%7D+%5C%5C+%5Cend%7Bmatrix%7D+%5Cright%5D+%3D+%5Cleft%5B+%5Cbegin%7Bmatrix%7D++1++++++%26+0++++++%26+0++++++%26+%5Ccdots++%26+0++++++%26+0++++++%26+%5Ccdots++%26+0++++++%5C%5C+0++++++%26+1++++++%26+0++++++%26+%5Ccdots++%26+0++++++%26+0++++++%26+%5Ccdots++%26+0++++++%5C%5C+%5Cvdots+%26+%5Cvdots+%26+%5Cvdots+%26+%5Cddots++%26+%5Cvdots+%26+%5Cvdots+%26+%5Cddots++%26+%5Cvdots+%5C%5C++0++++++%26+-%5Cfrac%7Bw_%7BI_1%7D%7D%7Bw_%7BI_p%7D%7D++%26+-%5Cfrac%7Bw_%7BI_2%7D%7D%7Bw_%7BI_p%7D%7D++%26+%5Ccdots+++%26+-%5Cfrac%7Bw_%7BI_%7Bp-1%7D%7D%7D%7Bw_%7BI_p%7D%7D++%260++%26+%5Ccdots+%26+0++++++%5C%5C+0++++++%26+0++++++%26+0++++++%26+%5Ccdots++%26+0++++++%26+1++++++%26+%5Ccdots++%26+0++++++%5C%5C+%5Cvdots+%26+%5Cvdots+%26+%5Cvdots+%26+%5Cddots++%26+%5Cvdots+%26+%5Cvdots+%26+%5Cddots++%26+%5Cvdots+%5C%5C++0++++++%26+0++++++%26+0++++++%26+%5Ccdots++%26+0++++++%26+0++++++%26+%5Ccdots++%26+1++++++%5C%5C+%5Cend%7Bmatrix%7D+%5Cright%5D+%5Cleft%5B+%5Cbegin%7Bmatrix%7D+f_C+%5C%5C+f_%7BI_1%7D+%5C%5C+%5Cvdots++%5C%5C+f_%7BI_%7Bp-1%7D%7D+%5C%5C+f_%7BS_1%7D+%5C%5C+%5Cvdots++%5C%5C+f_%7BS_q%7D+%5C%5C+%5Cend%7Bmatrix%7D+%5Cright%5D" alt="\left[ \begin{matrix} f_C \\ f_{I_1} \\ \vdots  \\ f_{I_p} \\ f_{S_1} \\ \vdots  \\ f_{S_q} \\ \end{matrix} \right] = \left[ \begin{matrix}  1      &amp; 0      &amp; 0      &amp; \cdots  &amp; 0      &amp; 0      &amp; \cdots  &amp; 0      \\ 0      &amp; 1      &amp; 0      &amp; \cdots  &amp; 0      &amp; 0      &amp; \cdots  &amp; 0      \\ \vdots &amp; \vdots &amp; \vdots &amp; \ddots  &amp; \vdots &amp; \vdots &amp; \ddots  &amp; \vdots \\  0      &amp; -\frac{w_{I_1}}{w_{I_p}}  &amp; -\frac{w_{I_2}}{w_{I_p}}  &amp; \cdots   &amp; -\frac{w_{I_{p-1}}}{w_{I_p}}  &amp;0  &amp; \cdots &amp; 0      \\ 0      &amp; 0      &amp; 0      &amp; \cdots  &amp; 0      &amp; 1      &amp; \cdots  &amp; 0      \\ \vdots &amp; \vdots &amp; \vdots &amp; \ddots  &amp; \vdots &amp; \vdots &amp; \ddots  &amp; \vdots \\  0      &amp; 0      &amp; 0      &amp; \cdots  &amp; 0      &amp; 0      &amp; \cdots  &amp; 1      \\ \end{matrix} \right] \left[ \begin{matrix} f_C \\ f_{I_1} \\ \vdots  \\ f_{I_{p-1}} \\ f_{S_1} \\ \vdots  \\ f_{S_q} \\ \end{matrix} \right]" eeimg="1"/> </p><p>其中，中间的矩阵即为约束矩阵 <img src="https://www.zhihu.com/equation?tex=R" alt="R" eeimg="1"/> </p><p>在实际处理过程中，研究者发现不同股票的特质收益率是存在异方差现象的，且通常方差大小与股票的市值的平方根成反比关系。我们知道，当存在异方差现象时，普通最小二乘法（OLS）回归得到的结果虽然是线性无偏的，但不是有效的，此时显著性检验失去了作用，预测效果变得糟糕。基于此，通常采用加权最小二乘法（WLS）来代替普通最小二乘法（OLS）。为了实现异方差到同方差的转换，权重调整矩阵设定为对角阵，而对角阵对角线上的数值为每一支股票的流通市值的平方根占全部股票流通市值平方根之和的比率，这里用变量 <img src="https://www.zhihu.com/equation?tex=v_t" alt="v_t" eeimg="1"/> 表示，具体而言，</p><p><img src="https://www.zhihu.com/equation?tex=v_t+%3D+%5Cfrac%7B%5Csqrt%7Bs_t%7D%7D%7B%5Csum_%7Bi%3D1%7D%5E%7Bn%7D%5Csqrt%7Bs_i%7D%7D" alt="v_t = \frac{\sqrt{s_t}}{\sum_{i=1}^{n}\sqrt{s_i}}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=V+%3D++%5Cleft%5B+%5Cbegin%7Bmatrix%7D+v_1++++%26+0++++++%26+0++++++%26+0++++++%5C%5C+0++++++%26+v_2++++%26+0++++++%26+0++++++%5C%5C+%5Cvdots+%26+%5Cvdots+%26+%5Cddots+%26+%5Cvdots+%5C%5C++0++++++%26+0++++++%26+%5Ccdots+%26+v_n++++%5C%5C+%5Cend%7Bmatrix%7D+%5Cright%5D" alt="V =  \left[ \begin{matrix} v_1    &amp; 0      &amp; 0      &amp; 0      \\ 0      &amp; v_2    &amp; 0      &amp; 0      \\ \vdots &amp; \vdots &amp; \ddots &amp; \vdots \\  0      &amp; 0      &amp; \cdots &amp; v_n    \\ \end{matrix} \right]" eeimg="1"/> </p><p>准备工作就绪，我们来看看不同条件下线性回归结果的表现形式</p><ul><li>在无约束条件下，不考虑异方差时，通过OLS计算得到的投资组合权重为：</li></ul><p><img src="https://www.zhihu.com/equation?tex=W+%3D+%28X%5E%7BT%7DX%29%5E%7B-1%7DX%5E%7BT%7D" alt="W = (X^{T}X)^{-1}X^{T}" eeimg="1"/> </p><ul><li>在无约束条件下，若考虑异方差，通过WLS计算得到的投资组合权重为：                  </li></ul><p><img src="https://www.zhihu.com/equation?tex=W+%3D+%28X%5E%7BT%7DVX%29%5E%7B-1%7DX%5E%7BT%7DV" alt="W = (X^{T}VX)^{-1}X^{T}V" eeimg="1"/> </p><ul><li>在有约束，且考虑异方差时，通过WLS计算得到的投资组合权重为：</li></ul><p><img src="https://www.zhihu.com/equation?tex=W+%3D+R%28R%5E%7BT%7DX%5E%7BT%7DVXR%29%5E%7B-1%7DR%5E%7BT%7DX%5E%7BT%7DV" alt="W = R(R^{T}X^{T}VXR)^{-1}R^{T}X^{T}V" eeimg="1"/> </p><p>计算出投资组合权重后，根据公式 <img src="https://www.zhihu.com/equation?tex=f+%3D+W%5E%7BT%7Dr" alt="f = W^{T}r" eeimg="1"/> 可计算因子收益率</p><p>通过以上截面回归方法计算出来的纯因子收益率虽然能够满足对暴露度约束的要求，但是由于投资组合中存在股票的权重为负值的情况，因而在A股市场并不具有可投资性。为了使计算出来的纯因子收益率更贴合国内市场，大家开始另辟蹊径，采用二次规划的方法来计算投资组合的权重。</p><p><img src="https://www.zhihu.com/equation?tex=%3E%3E+WeightOptimization" alt="&gt;&gt; WeightOptimization" eeimg="1"/> </p><p>二次规划的目标函数通常会根据用户目的的不同而有不同的设置，比如常见的目标函数有最大化目标因子暴露度、最大化投资组合夏普率、最小化投资组合跟踪误差、最小化投资组合全局风险等。由于这里我们是求解纯因子收益率，所以目标函数可以设置为最大化目标因子暴露度。</p><p><img src="https://www.zhihu.com/equation?tex=max_%7Bw%7Dw%5E%7BT%7DX_%7Bj%7D" alt="max_{w}w^{T}X_{j}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=s.t.+w%5E%7BT%7DX_%7Bi%7D+%3D+0%2C+%5Cforall+i%5Cne+j+" alt="s.t. w^{T}X_{i} = 0, \forall i\ne j " eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%5Csum_%7Bi%3D1%7D%5E%7Bn%7Dw_%7Bi%7D+%3D+1" alt="\sum_{i=1}^{n}w_{i} = 1" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=w_%7Bi%7D+%5Cgeq+0%2C+%5Cforall+i" alt="w_{i} \geq 0, \forall i" eeimg="1"/> </p><p>值得注意的是，上面的约束条件仅能满足对其他因子暴露为0个单位，而对指定因子的暴露并没有严格约束为1个单位。若要满足对指定因子的暴露度约束，则可以添加以下公式：</p><p><img src="https://www.zhihu.com/equation?tex=w%5E%7BT%7DX_%7Bj%7D+%3D+1" alt="w^{T}X_{j} = 1" eeimg="1"/> </p><p>更近一步，如果我们想对行业进行中性化处理，对行业不做任何暴露，则可以添加以下公式：</p><p><img src="https://www.zhihu.com/equation?tex=w%5E%7BT%7DH+%3D+h+" alt="w^{T}H = h " eeimg="1"/> </p><p>当然，我们可以根据需要不断地增加约束条件，但需要注意的是，当约束过多的时候，有时无法得到收敛的解。</p><p>其中， <img src="https://www.zhihu.com/equation?tex=w" alt="w" eeimg="1"/> 表示指定因子投资组合中的股票权重向量，<img src="https://www.zhihu.com/equation?tex=X_%7Bj%7D" alt="X_{j}" eeimg="1"/> 表示指定因子的暴露度向量， <img src="https://www.zhihu.com/equation?tex=X_%7Bi%7D%2C+i%5Cne+j" alt="X_{i}, i\ne j" eeimg="1"/> 表示其他因子的暴露度矩阵， <img src="https://www.zhihu.com/equation?tex=H" alt="H" eeimg="1"/> 表示投资组合中股票的行业因子哑变量矩阵， <img src="https://www.zhihu.com/equation?tex=h" alt="h" eeimg="1"/> 表示基准组合对应的行业权重向量。</p><p><img src="https://www.zhihu.com/equation?tex=----------------------Cutting+Line-----------------------" alt="----------------------Cutting Line-----------------------" eeimg="1"/> </p><p>纯理论的东西终于啰嗦完了，下面进入实操环节。</p><ol><li>构建因子暴露度矩阵</li></ol><ul><li>构建风格因子暴露度矩阵 </li></ul><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-21a2b1bf368bd5b4ccfdc6667775b7ee_b.jpg" data-caption="" data-size="normal" data-rawwidth="1292" data-rawheight="476" class="origin_image zh-lightbox-thumb" width="1292" data-original="https://pic3.zhimg.com/v2-21a2b1bf368bd5b4ccfdc6667775b7ee_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-21a2b1bf368bd5b4ccfdc6667775b7ee_b.jpg" data-caption="" data-size="normal" data-rawwidth="1292" data-rawheight="476" class="origin_image zh-lightbox-thumb lazy" width="1292" data-original="https://pic3.zhimg.com/v2-21a2b1bf368bd5b4ccfdc6667775b7ee_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-21a2b1bf368bd5b4ccfdc6667775b7ee_b.jpg"/></figure><ul><ul><li>构建行业因子暴露度哑变量矩阵</li></ul></ul><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-773206db9d0abcfba0513a4893350dd1_b.jpg" data-caption="" data-size="normal" data-rawwidth="1812" data-rawheight="490" class="origin_image zh-lightbox-thumb" width="1812" data-original="https://pic2.zhimg.com/v2-773206db9d0abcfba0513a4893350dd1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-773206db9d0abcfba0513a4893350dd1_b.jpg" data-caption="" data-size="normal" data-rawwidth="1812" data-rawheight="490" class="origin_image zh-lightbox-thumb lazy" width="1812" data-original="https://pic2.zhimg.com/v2-773206db9d0abcfba0513a4893350dd1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-773206db9d0abcfba0513a4893350dd1_b.jpg"/></figure><ul><ul><li>构建国家因子暴露度向量</li></ul></ul><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-85757aa813da82f243cf594bc164f9c0_b.jpg" data-caption="" data-size="normal" data-rawwidth="1159" data-rawheight="437" class="origin_image zh-lightbox-thumb" width="1159" data-original="https://pic1.zhimg.com/v2-85757aa813da82f243cf594bc164f9c0_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-85757aa813da82f243cf594bc164f9c0_b.jpg" data-caption="" data-size="normal" data-rawwidth="1159" data-rawheight="437" class="origin_image zh-lightbox-thumb lazy" width="1159" data-original="https://pic1.zhimg.com/v2-85757aa813da82f243cf594bc164f9c0_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-85757aa813da82f243cf594bc164f9c0_b.jpg"/></figure><p>整合三者，得到最终的因子暴露度矩阵 <img src="https://www.zhihu.com/equation?tex=X" alt="X" eeimg="1"/> </p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-7b81d5d246e3482d3b4e0edda1cb5b18_b.jpg" data-caption="" data-size="normal" data-rawwidth="2007" data-rawheight="550" class="origin_image zh-lightbox-thumb" width="2007" data-original="https://pic1.zhimg.com/v2-7b81d5d246e3482d3b4e0edda1cb5b18_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-7b81d5d246e3482d3b4e0edda1cb5b18_b.jpg" data-caption="" data-size="normal" data-rawwidth="2007" data-rawheight="550" class="origin_image zh-lightbox-thumb lazy" width="2007" data-original="https://pic1.zhimg.com/v2-7b81d5d246e3482d3b4e0edda1cb5b18_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-7b81d5d246e3482d3b4e0edda1cb5b18_b.jpg"/></figure><p>2. 构建权重调整矩阵 <img src="https://www.zhihu.com/equation?tex=V" alt="V" eeimg="1"/> </p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-b188d96b99877834291fe5a3d397c993_b.jpg" data-caption="" data-size="normal" data-rawwidth="2012" data-rawheight="515" class="origin_image zh-lightbox-thumb" width="2012" data-original="https://pic4.zhimg.com/v2-b188d96b99877834291fe5a3d397c993_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-b188d96b99877834291fe5a3d397c993_b.jpg" data-caption="" data-size="normal" data-rawwidth="2012" data-rawheight="515" class="origin_image zh-lightbox-thumb lazy" width="2012" data-original="https://pic4.zhimg.com/v2-b188d96b99877834291fe5a3d397c993_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-b188d96b99877834291fe5a3d397c993_b.jpg"/></figure><p>3. 构建约束矩阵 <img src="https://www.zhihu.com/equation?tex=R" alt="R" eeimg="1"/> </p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-8bd08a2f6216363a05a41e1e2543d792_b.jpg" data-caption="" data-size="normal" data-rawwidth="1924" data-rawheight="1105" class="origin_image zh-lightbox-thumb" width="1924" data-original="https://pic3.zhimg.com/v2-8bd08a2f6216363a05a41e1e2543d792_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-8bd08a2f6216363a05a41e1e2543d792_b.jpg" data-caption="" data-size="normal" data-rawwidth="1924" data-rawheight="1105" class="origin_image zh-lightbox-thumb lazy" width="1924" data-original="https://pic3.zhimg.com/v2-8bd08a2f6216363a05a41e1e2543d792_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-8bd08a2f6216363a05a41e1e2543d792_b.jpg"/></figure><p>4. 根据截面回归的结果计算权重矩阵 <img src="https://www.zhihu.com/equation?tex=W" alt="W" eeimg="1"/> </p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-3fb7cce320c1a8fb1c3feecd54feed8a_b.jpg" data-caption="" data-size="normal" data-rawwidth="2013" data-rawheight="815" class="origin_image zh-lightbox-thumb" width="2013" data-original="https://pic3.zhimg.com/v2-3fb7cce320c1a8fb1c3feecd54feed8a_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-3fb7cce320c1a8fb1c3feecd54feed8a_b.jpg" data-caption="" data-size="normal" data-rawwidth="2013" data-rawheight="815" class="origin_image zh-lightbox-thumb lazy" width="2013" data-original="https://pic3.zhimg.com/v2-3fb7cce320c1a8fb1c3feecd54feed8a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-3fb7cce320c1a8fb1c3feecd54feed8a_b.jpg"/></figure><p>5. 根据公式计算因子收益率 <img src="https://www.zhihu.com/equation?tex=f" alt="f" eeimg="1"/> </p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-dd2f66708e3cd70179d25b4ddbbb1a1e_b.png" data-caption="" data-size="normal" data-rawwidth="1885" data-rawheight="246" class="origin_image zh-lightbox-thumb" width="1885" data-original="https://pic3.zhimg.com/v2-dd2f66708e3cd70179d25b4ddbbb1a1e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-dd2f66708e3cd70179d25b4ddbbb1a1e_b.png" data-caption="" data-size="normal" data-rawwidth="1885" data-rawheight="246" class="origin_image zh-lightbox-thumb lazy" width="1885" data-original="https://pic3.zhimg.com/v2-dd2f66708e3cd70179d25b4ddbbb1a1e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-dd2f66708e3cd70179d25b4ddbbb1a1e_b.png"/></figure><p>6. 反向验证计算结果准确性</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-dfcecf9df51bc841305e26404c301254_b.jpg" data-caption="" data-size="normal" data-rawwidth="1513" data-rawheight="749" class="origin_image zh-lightbox-thumb" width="1513" data-original="https://pic1.zhimg.com/v2-dfcecf9df51bc841305e26404c301254_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-dfcecf9df51bc841305e26404c301254_b.jpg" data-caption="" data-size="normal" data-rawwidth="1513" data-rawheight="749" class="origin_image zh-lightbox-thumb lazy" width="1513" data-original="https://pic1.zhimg.com/v2-dfcecf9df51bc841305e26404c301254_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-dfcecf9df51bc841305e26404c301254_b.jpg"/></figure><p>其中每一行表示该行所在因子在其他因子上的暴露。可以发现：</p><ul><li>国家纯因子组合对各行业纯因子都有暴露，对风格纯因子无暴露</li><li>行业纯因子组合100%做多本行业，100%做空国家因子</li><li>风格纯因子仅对自身有暴露，对任何其他因子暴露度为0</li></ul><p>正如前文所述，WLS计算出来的权重包含负值，与A股市场难以做空的环境差异巨大，为此尝试通过优化器来改进这个问题。</p><p>为了简化流程，对前文生成的相关变量继续运用，唯一需要注意的是，下文的矩阵 <img src="https://www.zhihu.com/equation?tex=X" alt="X" eeimg="1"/> 仅表示风格因子，而非所有因子。同时为了避免冗余，这里直接粘贴所有代码，不再一步步运行返回结果。</p><div class="highlight"><pre><code class="language-python3"><span class="c1"># 特定风格因子的预期暴露度最大化</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    w: 求解的最优权重[w1, w2, ..., wn]^T
</span><span class="s1">    X: 投资组合个股风格因子暴露度矩阵
</span><span class="s1">    H: 投资组合个股行业因子哑变量矩阵
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">loc</span><span class="p">])</span>

<span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_ids</span><span class="p">)</span>                   <span class="c1"># 股票数目</span>
<span class="n">w_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random_sample</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>    <span class="c1"># 生成介于[0, 1]之间的随机数</span>
<span class="n">init_w</span> <span class="o">=</span> <span class="n">w_</span> <span class="o">/</span> <span class="n">w_</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>               <span class="c1"># 随机初始化权重值</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">ss_style_data</span><span class="o">.</span><span class="n">values</span>      <span class="c1"># 表示N只股票的风格因子暴露度矩阵</span>
<span class="n">H</span> <span class="o">=</span> <span class="n">industry_data</span><span class="o">.</span><span class="n">values</span>      <span class="c1"># 表示N只股票的行业因子哑变量矩阵</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">industry_weights</span><span class="o">.</span><span class="n">values</span>   <span class="c1"># 表示基准指数对应的行业权重，与所选取的参照基准有关</span>
<span class="n">bnds</span> <span class="o">=</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">)</span> <span class="o">*</span> <span class="n">num</span>       <span class="c1"># 权重限定位于[0, 1]之间</span>

<span class="n">res_lst</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--&gt;&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
    <span class="n">X_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">cons</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">X_</span><span class="p">)},</span>            <span class="c1"># 数值为0的向量，向量长度等于风格因子数目减1</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">loc</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">},</span> <span class="c1"># 对本身的风格暴露度限定为1</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span><span class="o">-</span> <span class="n">h</span><span class="p">},</span>          <span class="c1"># 对行业因子暴露度与基准一致，由于不能做空，所以无法确保暴露度为0</span>
        <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">},</span>                 <span class="c1"># 不支持卖空，所以权重之和等于1，其中权重大于0的约束放在参数bounds里面</span>
        <span class="p">)</span>  


    <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">init_w</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">loc</span><span class="p">),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="n">res_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span></code></pre></div><p>程序运行时，可以看到其返回如下信息：</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-10bcd9a0b80b5b2deb71db3c84c4466a_b.jpg" data-caption="" data-size="normal" data-rawwidth="912" data-rawheight="424" class="origin_image zh-lightbox-thumb" width="912" data-original="https://pic3.zhimg.com/v2-10bcd9a0b80b5b2deb71db3c84c4466a_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-10bcd9a0b80b5b2deb71db3c84c4466a_b.jpg" data-caption="" data-size="normal" data-rawwidth="912" data-rawheight="424" class="origin_image zh-lightbox-thumb lazy" width="912" data-original="https://pic3.zhimg.com/v2-10bcd9a0b80b5b2deb71db3c84c4466a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-10bcd9a0b80b5b2deb71db3c84c4466a_b.jpg"/></figure><p>Exit Mode 0表示结果收敛，目标函数最小值为-1，说明对指定因子的暴露度恰好为1（求最大值转化为了求最小值），符合我们的约束条件。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-9dc3a7b39d8deb7d871942a1e43eecc9_b.jpg" data-caption="" data-size="normal" data-rawwidth="1185" data-rawheight="366" class="origin_image zh-lightbox-thumb" width="1185" data-original="https://pic2.zhimg.com/v2-9dc3a7b39d8deb7d871942a1e43eecc9_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-9dc3a7b39d8deb7d871942a1e43eecc9_b.jpg" data-caption="" data-size="normal" data-rawwidth="1185" data-rawheight="366" class="origin_image zh-lightbox-thumb lazy" width="1185" data-original="https://pic2.zhimg.com/v2-9dc3a7b39d8deb7d871942a1e43eecc9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-9dc3a7b39d8deb7d871942a1e43eecc9_b.jpg"/></figure><p>其中，每一行表示该行所在风格纯因子对应的不同股票的权重，可以发现很多股票的权重在约束条件下变为了0 。</p><p>若要绘制纯因子收益率的历史表现，仅需对以上代码进行ForLoop即可。</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-ee52206219db87b98bfb051d11a876db_b.jpg" data-caption="" data-size="normal" data-rawwidth="1229" data-rawheight="722" class="origin_image zh-lightbox-thumb" width="1229" data-original="https://pic4.zhimg.com/v2-ee52206219db87b98bfb051d11a876db_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-ee52206219db87b98bfb051d11a876db_b.jpg" data-caption="" data-size="normal" data-rawwidth="1229" data-rawheight="722" class="origin_image zh-lightbox-thumb lazy" width="1229" data-original="https://pic4.zhimg.com/v2-ee52206219db87b98bfb051d11a876db_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-ee52206219db87b98bfb051d11a876db_b.jpg"/></figure><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-cb59ad3e0f2d1b8b065aa307d97c81d0_b.jpg" data-caption="" data-size="normal" data-rawwidth="1227" data-rawheight="747" class="origin_image zh-lightbox-thumb" width="1227" data-original="https://pic1.zhimg.com/v2-cb59ad3e0f2d1b8b065aa307d97c81d0_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-cb59ad3e0f2d1b8b065aa307d97c81d0_b.jpg" data-caption="" data-size="normal" data-rawwidth="1227" data-rawheight="747" class="origin_image zh-lightbox-thumb lazy" width="1227" data-original="https://pic1.zhimg.com/v2-cb59ad3e0f2d1b8b065aa307d97c81d0_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-cb59ad3e0f2d1b8b065aa307d97c81d0_b.jpg"/></figure><p>行文至此，又到了说结束的时候。<b>大家如果觉得对自己有点用，欢迎点赞、收藏</b>。</p><p class="ztext-empty-paragraph"><br/></p><p><b>参考文献</b></p><p>【1】<a href="https://zhuanlan.zhihu.com/p/38280638" class="internal">正确理解Barra的纯因子模型</a></p><p>【2】<a href="https://zhuanlan.zhihu.com/p/39922829" class="internal">Barra因子模型截面回归求解</a></p><p>【3】基于组合权重优化的风格中性多因子选股策略 </p>