<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>无字母数字webshell之提高篇</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/46806125">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-1778d4b36ffe296eb341235973267fda_r.jpg" alt=""></div><p>作者： <a class="member_mention" href="http://www.zhihu.com/people/6f8ffd80705c262c2ee3fa4d9b3f8f06" data-hash="6f8ffd80705c262c2ee3fa4d9b3f8f06" data-hovercard="p$b$6f8ffd80705c262c2ee3fa4d9b3f8f06">@周佩雨</a> </p><p>[ Phith0n，现就职于长亭科技，长期关注并笔耕于安全编码、代码审计等方向]</p><p><br></p><p>前几天【<a href="https://www.leavesongs.com/PENETRATION/code-auditor-secret-group.html">代码审计知识星球</a>】里有同学提出了一个问题，大概代码如下：</p><img src="https://pic4.zhimg.com/v2-eb5cc03bcc57e155992866ddd0ca2f13_r.jpg" data-caption="" data-size="normal" data-rawwidth="550" data-rawheight="442" data-watermark="watermark" data-original-src="v2-eb5cc03bcc57e155992866ddd0ca2f13" data-watermark-src="v2-7f1a731c76f642b186fddff0387fec0a" data-private-watermark-src=""><p>这个代码如果要getshell，怎样利用？</p><p>这题可能来自是我曾写过的一篇文章：《<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">一些不包含数字和字母的webshell</a>》，里面介绍了如何构造无字母数字的webshell。其中有两个主要的思路：</p><ol><li>利用位运算</li><li>利用自增运算符</li></ol><p>当然，这道题多了两个限制：</p><ol><li>webshell长度不超过35位</li><li>除了不包含字母数字，还不能包含<code class="inline">$</code>和<code class="inline">_</code></li></ol><p>难点呼之欲出了，我前面文章中给出的所有方法，都用到了PHP中的变量，需要对变量进行变形、异或、取反等操作，最后动态执行函数。但现在，因为<code class="inline">$</code>不能使用了，所以我们无法构造PHP中的变量。</p><p>所以，如何解决这个问题？</p><h2><b><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html#php7">PHP7 下简单解决问题</a></b></h2><p>我们将上述代码放在index.php中，然后执行<code class="inline">docker run --rm -p 9090:80 -v `pwd`:/var/www/html php:7.2-apache</code>，启动一个php 7.2的服务器。</p><p>php7中修改了表达式执行的顺序：<a href="http://php.net/manual/zh/migration70.incompatible.php">http://php.net/manual/zh/migration70.incompatible.php</a> </p><img src="https://pic2.zhimg.com/v2-c5be0e9ab661cd441ef5f646421286ee_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="328" data-watermark="watermark" data-original-src="v2-c5be0e9ab661cd441ef5f646421286ee" data-watermark-src="v2-60436a6adec5c434f06407f98ebb01eb" data-private-watermark-src=""><p><br></p><p>PHP7前是不允许用<code class="inline">($a)();</code>这样的方法来执行动态函数的，但PHP7中增加了对此的支持。所以，我们可以通过<code class="inline">('phpinfo')();</code>来执行函数，第一个括号中可以是任意PHP表达式。</p><p>所以很简单了，构造一个可以生成<code class="inline">phpinfo</code>这个字符串的PHP表达式即可。payload如下（不可见字符用url编码表示）：</p><p>(~%8F%97%8F%96%91%99%90)(); </p><img src="https://pic3.zhimg.com/v2-79d5efef73e8ef691585251e82cadd5a_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="235" data-watermark="watermark" data-original-src="v2-79d5efef73e8ef691585251e82cadd5a" data-watermark-src="v2-1de91572067dbce8ee60057e1e2ad6d8" data-private-watermark-src=""><p><br></p><h2><b><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html#php5">PHP5的思考</a></b></h2><p>我们使用<code class="inline">docker run --rm -p 9090:80 -v `pwd`:/var/www/html php:5.6-apach</code>来运行一个php5.6的web环境。</p><p>此时，我们尝试用PHP7的payload，将会得到一个错误：</p><img src="https://pic1.zhimg.com/v2-1650a681e30b3a66f9b9c112d239a3b4_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="134" data-watermark="watermark" data-original-src="v2-1650a681e30b3a66f9b9c112d239a3b4" data-watermark-src="v2-6d0e39d3694a0eb6ee5a942bbcdaba4d" data-private-watermark-src=""><p>原因就是php5并不支持这种表达方式。</p><p>在我在知识星球里发出帖子的时候，其实还没想到如何用PHP5解决问题，但我有自信解决它，所以先发了这个小挑战。后来关上电脑仔细想想，发现当思路禁锢在一个点的时候，你将会钻进牛角尖；当你用大局观来看待问题，问题就迎刃而解。</p><p>当然，我觉得我的方法应该不是唯一的，不过一直没人出来公布答案，我就先抛砖引玉了。</p><p>大部分语言都不会是单纯的逻辑语言，一门全功能的语言必然需要和操作系统进行交互。操作系统里包含的最重要的两个功能就是“shell（系统命令）”和“文件系统”，很多木马与远控其实也只实现了这两个功能。</p><p>PHP自然也能够和操作系统进行交互，“反引号”就是PHP中最简单的执行shell的方法。那么，在使用PHP无法解决问题的情况下，为何不考虑用“反引号”+“shell”的方式来getshell呢？</p><h2><b><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html#php5shell">PHP5+shell打破禁锢</a></b></h2><p>因为反引号不属于“字母”、“数字”，所以我们可以执行系统命令，但问题来了：如何利用无字母、数字、<code class="inline">$</code>的系统命令来getshell？</p><p>好像问题又回到了原点：无字母、数字、<code class="inline">$</code>，在shell中仍然是一个难题。</p><p>此时我想到了两个有趣的Linux shell知识点：</p><ol><li>shell下可以利用<code class="inline">.</code>来执行任意脚本</li><li>Linux文件名支持用glob通配符代替</li></ol><p>第一点曾在《 <a href="https://www.leavesongs.com/SHARE/some-tricks-from-my-secret-group.html">小密圈里的那些奇技淫巧</a> 》露出过一角，但我没细讲。<code class="inline">.</code>或者叫period，它的作用和source一样，就是用当前的shell执行一个文件中的命令。比如，当前运行的shell是bash，则<code class="inline">. file</code>的意思就是用bash执行file文件中的命令。</p><p>用<code class="inline">. file</code>执行文件，是不需要file有x权限的。那么，如果目标服务器上有一个我们可控的文件，那不就可以利用<code class="inline">.</code>来执行它了吗？</p><p>这个文件也很好得到，我们可以发送一个上传文件的POST包，此时PHP会将我们上传的文件保存在临时文件夹下，默认的文件名是<code class="inline">/tmp/phpXXXXXX</code>，文件名最后6个字符是随机的大小写字母。</p><p>第二个难题接踵而至，执行<code class="inline">. /tmp/phpXXXXXX</code>，也是有字母的。此时就可以用到Linux下的glob通配符：</p><ul><li><code class="inline">*</code>可以代替0个及以上任意字符</li><li><code class="inline">?</code>可以代表1个任意字符</li></ul><p>那么，<code class="inline">/tmp/phpXXXXXX</code>就可以表示为<code class="inline">/*/?????????</code>或<code class="inline">/???/?????????</code>。</p><p>但我们尝试执行<code class="inline">. /???/?????????</code>，却得到如下错误：</p><img src="https://pic4.zhimg.com/v2-2e64e23b8eccfcabe964496693913b3f_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="82" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>这是因为，能够匹配上<code class="inline">/???/?????????</code>这个通配符的文件有很多，我们可以列出来：</p><img src="https://pic1.zhimg.com/v2-6e44eec7c622f864030642b68cdcdc6b_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="173" data-watermark="watermark" data-original-src="v2-6e44eec7c622f864030642b68cdcdc6b" data-watermark-src="v2-0f688db4597b165c1c5dc34a530904e8" data-private-watermark-src=""><p>可见，我们要执行的<code class="inline">/tmp/phpcjggLC</code>排在倒数第二位。然而，在执行第一个匹配上的文件（即<code class="inline">/bin/run-parts</code>）的时候就已经出现了错误，导致整个流程停止，根本不会执行到我们上传的文件。</p><p>思路又陷入了僵局，虽然方向没错。</p><h2><b><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html#glob">深入理解glob通配符</a></b></h2><p>大部分同学对于通配符，可能知道的都只有<code class="inline">*</code>和<code class="inline">?</code>。但实际上，阅读Linux的文档（ <a href="http://man7.org/linux/man-pages/man7/glob.7.html">http://man7.org/linux/man-pages/man7/glob.7.html</a> ），可以学到更多有趣的知识点。</p><p>其中，glob支持用<code class="inline">[^x]</code>的方法来构造“这个位置不是字符x”。那么，我们用这个姿势干掉<code class="inline">/bin/run-parts</code>：</p><img src="https://pic1.zhimg.com/v2-b2d147c6c09b69aab2efb7d8046a300b_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="97" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>排除了第4个字符是<code class="inline">-</code>的文件，同样我们可以排除包含<code class="inline">.</code>的文件：</p><img src="https://pic3.zhimg.com/v2-c59a4961ad319c98364487b9d85e226e_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="96" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>现在就剩最后三个文件了。但我们要执行的文件仍然排在最后，但我发现这三个文件名中都不包含特殊字符，那么这个方法似乎行不通了。</p><p>继续阅读glob的帮助，我发现另一个有趣的用法：</p><img src="https://pic2.zhimg.com/v2-32fbe858e9a5ed8fd8a883dbed958d65_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="170" data-watermark="watermark" data-original-src="v2-32fbe858e9a5ed8fd8a883dbed958d65" data-watermark-src="v2-a6b07ffa5c6f67881ac73be1cd4ba977" data-private-watermark-src=""><p><br></p><p>就跟正则表达式类似，glob支持利用<code class="inline">[0-9]</code>来表示一个范围。</p><p>我们再来看看之前列出可能干扰我们的文件：</p><img src="https://pic1.zhimg.com/v2-6e44eec7c622f864030642b68cdcdc6b_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="173" data-watermark="watermark" data-original-src="v2-6e44eec7c622f864030642b68cdcdc6b" data-watermark-src="v2-0f688db4597b165c1c5dc34a530904e8" data-private-watermark-src=""><p>所有文件名都是小写，只有PHP生成的临时文件包含大写字母。那么答案就呼之欲出了，我们只要找到一个可以表示“大写字母”的glob通配符，就能精准找到我们要执行的文件。</p><p>翻开ascii码表，可见大写字母位于<code class="inline">@</code>与<code class="inline">[</code>之间：</p><img src="https://pic1.zhimg.com/v2-40258a449e935251e496f5801e46cce2_r.jpg" data-caption="" data-size="normal" data-rawwidth="120" data-rawheight="500" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>那么，我们可以利用<code class="inline">[@-[]</code>来表示大写字母：</p><img src="https://pic2.zhimg.com/v2-f5c44c17f36e843d322560e580dfa6e1_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="113" data-watermark="watermark" data-original-src="v2-f5c44c17f36e843d322560e580dfa6e1" data-watermark-src="v2-7ea8ec12445ac8ccebb3f139c0614565" data-private-watermark-src=""><p>显然这一招是管用的。</p><h2><b><a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html#poc">构造POC，执行任意命令</a></b></h2><p>当然，php生成临时文件名是随机的，最后一个字符不一定是大写字母，不过多尝试几次也就行了。</p><p>最后，我传入的code为<code class="inline">?&gt;&lt;?=`. /???/????????[@-[]`;?&gt;</code>，发送数据包如下：</p><img src="https://pic1.zhimg.com/v2-f34dbd824e6fa5bb78c03114c7bf59f3_r.jpg" data-caption="" data-size="normal" data-rawwidth="650" data-rawheight="170" data-watermark="watermark" data-original-src="v2-f34dbd824e6fa5bb78c03114c7bf59f3" data-watermark-src="v2-ab8e8a046bdfceb32e20b22164a2908c" data-private-watermark-src=""><p>成功执行任意命令。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
</body>
</html>
