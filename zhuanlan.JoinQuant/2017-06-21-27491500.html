<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>【新手必看】MACD均线择时策略</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/27491500">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-84bd8486fec59df2b1187cd8896a1973_b.jpg" alt=""></div><p>上上篇文章：<a href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/6879%3Ff%3Dzhzl%26m%3D27491500" class=" wrap external" target="_blank" rel="nofollow noreferrer">【新手入门教程】白马股策略</a></p><p>上一篇文章：<a href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/6986%3Ff%3Dzhzl%26m%3D27491500" class=" wrap external" target="_blank" rel="nofollow noreferrer">【新手入门教程】多股票追涨杀跌策略</a></p><h2>本文：教写MACD均线择时策略</h2><p><b>&lt;学习内容&gt;</b></p><ul><li>学会技术指标择时策略</li><li>了解使用talib&gt; -学会大盘择时概念</li><li>自主完成MACD</li><li>向导式初体验</li></ul><br/><h3>1 确定策略内容</h3><p>在之前的教程中，我们学习了如何通过财务指标等对股票进行筛选等操作。今天我们将以MACD为例，探究如何利用技术指标进行策略的构建与实现。</p><p><b>&lt;MACD的组成&gt; </b></p><p>MACD（Moving Average Convergence and Divergence)即指数平滑移动平均线，由Geral Appel 于1970年提出，属于<em>大势趋势类指标</em>，它由<em>长期慢速均线DEA，短期快线的DIF，红色能量柱（多头），绿色能量柱（空头）、0轴（多空分界线）</em>五部分组成，即“两线两柱一轴”组合起来形成。<figure><noscript><img src="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_b.jpg" data-rawwidth="569" data-rawheight="432" class="origin_image zh-lightbox-thumb" width="569" data-original="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_b.jpg" data-rawwidth="569" data-rawheight="432" class="origin_image zh-lightbox-thumb lazy" width="569" data-original="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_b.jpg"/></figure></p><br/><p>在图中表示出来则为：<br/></p><figure><noscript><img src="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_b.jpg" data-rawwidth="514" data-rawheight="302" class="origin_image zh-lightbox-thumb" width="514" data-original="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_b.jpg" data-rawwidth="514" data-rawheight="302" class="origin_image zh-lightbox-thumb lazy" width="514" data-original="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_b.jpg"/></figure><p>图片来源：<a href="https://link.zhihu.com/?target=http%3A//mini.eastday.com/a/160224221510636.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">macd最通俗的诠释，让菜鸟变股神_财经频道_东方头条</a></p><p>图中水平线为零轴，又称多空分水岭，顾名思义上方为多头势力较强，下方则为空头势力较强。<br/>当短期快线DIF值和长期慢线DEA值上穿零轴，同时零轴之上出现红色柱状体，表示股价趋势当时属于多头市场，投资者可以考虑持股待涨。<br/>DIF值和DEA值下穿零轴，同时零轴之下出现绿色柱状体，则表示股价趋势当时属于空头市场，投资者应当空仓持币，规避风险。 </p><br/><p><b>&lt; MACD思想———均线位置与买卖时机判断&gt;</b></p><p>MACD是从双指数移动平均线发展而来的，由快的指数移动平均线（EMA12）减去慢的指数移动平均线（EMA26）得到快线DIF，再用2×（快线DIF-DEA）得到MACD柱。MACD的意义和双移动平均线相似，即由快、慢均线的离散、聚合来显示当前的多空状态和股价可能的发展变化趋势并对买进、卖出时机作出研判，但MACD阅读起来更方便。<br/>总体而言：<br/></p><ul><li><em>当MACD从负数转向正数，即买入信号</em></li><li><em>当MACD从正数转向负数，即卖出信号</em></li><li><em>当MACD以大角度变化，表示快的移动平均线和慢的移动平均线的差距非常迅速的拉开，代表了一个市场大趋势的转变</em></li></ul><br/><br/><p><b>&lt; DIF与DEA金叉的使用&gt; </b></p><p>当白线即短期快线DIF向上穿过黄色的长期慢线DEA时，即“快线高于慢线”，属于做多金叉信号。然而实际中需要进行“金叉+零轴”的综合考虑。<br/></p><ul><li>当零轴之下出现金叉时，股价属于弱势市场，金叉为弱势金叉，股价极有可能短期弱势反弹或暂时止跌后再度夭折，一般没有做多价值。</li><li>当零轴之上发生金叉时，股价属于强势市场，金叉为强势金叉，股价后市成功惯性上攻的概率较高。若零轴之上出现二次金叉信号时，又称零上二次红金叉，属于股价强势中的强势，此时跟进做多，股价往往容易出现加速上涨。属于短线极佳买点。</li></ul><br/><br/><figure><noscript><img src="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_b.jpg" data-rawwidth="522" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="522" data-original="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_b.jpg" data-rawwidth="522" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="522" data-original="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_b.jpg"/></figure><p><b>&lt; DIF与DEA死叉的使用&gt; </b></p><p>当白线即短期快线DIF向下穿过黄色的长期慢线DEA时，即“快线低于慢线”，属于做空死叉信号。死叉同样需要结合零轴。<br/></p><ul><li>当零轴之上出现死叉时，一般认为是股价上升趋势途中的短暂回调，后市股价仍有再次走强的可能。</li><li> 当零轴之下发生死叉时，一般认为是股价下跌趋势途中的继续回调，后市股价惯性下跌的概率较高，尤其是MACD零轴之下出现二次死叉时，股价更容易出现加速下跌行情，所以零轴之下，无论出现的是一次死叉或二次死叉，投资者都应当空仓观望，静观其变。</li></ul><br/><p>1）策略内容<br/>了解了MACD的基本情况，我们就能够制定本次利用技术指标构建的策略内容。</p><p>2）基本思路：<br/></p><ul><li> 筛选出符合：<br/></li></ul>30&lt;市盈率（pe_ratio）&lt;40, 市净率（pb_ratio)&lt;3, 净利润环比增长率(inc_net_profit_annual)&gt;0.3，净资产收益率(roe)&gt;0.2的股票，按照销售毛利率进行降序排列，选取前50只<br/>&gt; - 买入：DIF从下而上穿过DEA，即形成金叉<ul><li>卖出：DIF从上往下穿过DEA，即形成死叉<br/></li><li>股票持有数量为五只，十天一次调仓<br/></li></ul><br/><p>3）翻译成计算机语言即：<br/></p><ul><li>运用 get_fundalmentals 函数查询相关财务数据并筛选出符合条件的股票</li><li>运用 talib 读取 MACD 相关指标数值</li><li>利用if条件语句以及 and、or 逻辑语句进行买入卖出条件设置</li></ul><br/><h3>2 基本框架构建</h3><p>在之前的教程中，我们基本上已经整理出交易之前策略构成的基本框架。下面我们对这一内容再次进行细化：<br/>首先是 initialize() 函数的设置。这里我们沿用之前的做法，将其分为多个自定义函数的形式：</p><div class="highlight"><pre><code class="language-text">def initialize(context):
    set_params()    #设置相关参数
    set_backtest()  #设置回测基本数据
    run_daily(trade, &#39;every_bar&#39;)

def set_params():
    g.days=0        #起始日期为0
    g.refresh_rate=10   #调仓周期设置为10日

def set_backtest():
    set_benchmark(&#39;000905.XSHG&#39;)        #将基准设置为中证500
    set_option(&#39;use_real_price&#39;, True)  #开启动态复权
    log.set_level(&#39;order&#39;, &#39;error&#39;)     #设定报错等级
</code></pre></div><p>以及对滑点、手续费、过滤停牌、退市及ST股票的设置</p><div class="highlight"><pre><code class="language-text">#每天开盘前要做的事情
def before_trading_start(context):
    set_slip_fee(context)

# 根据不同的时间段设置滑点与手续费
def set_slip_fee(context):
    set_slippage(FixedSlippage(0.02)) 

    dt=context.current_dt
    if dt&gt;datetime.datetime(2013,1, 1):
        set_order_cost(OrderCost(open_tax=0, close_tax=0.001, open_commission=0.0003, close_commission=0.0003, close_today_commission=0, min_commission=5), type=&#39;stock&#39;)
    else:
        set_order_cost(OrderCost(open_tax=0, open_commission=0.003,close_commission=0.003, close_tax=0.001,min_commission=5), type=&#39;stock&#39;)

# 过滤停牌、退市和ST股票
def paused_filter(security_list):
    current_data = get_current_data()
    security_list = [stock for stock in security_list if not current_data[stock].paused]
    return security_list


def delisted_filter(security_list):
    current_data = get_current_data()
    security_list = [stock for stock in security_list if not &#39;退&#39; in current_data[stock].name]
    return security_list

def st_filter(security_list):
    current_data = get_current_data()
    security_list = [stock for stock in security_list if not current_data[stock].is_st]
    return security_list
</code></pre></div><h3>3 MACD数据读取</h3><p>根据我们策略的内容，我们采用的思路是：筛选出股票池中质量较高的股票--&gt;查询MACD指数--&gt;买入卖出条件<br/>再次复习我们熟悉的选股方法：财务指标。这里我们挑选出符合：<br/></p><ul><li>30&lt;市净率(pe_ratio)&lt;40，每股盈余(eps)&gt;0.3，净资产收益率(roe)&gt;0.2，净利润环比增长率&gt;0.3，并按照市净率进行升序排列，取前五十只。<br/></li></ul><br/><div class="highlight"><pre><code class="language-text">stock_to_choose = get_fundamentals(query(
        valuation.code, valuation.pe_ratio, 
        valuation.pb_ratio,valuation.market_cap, 
        indicator.eps, indicator.inc_net_profit_annual
    ).filter(
        valuation.pe_ratio &lt; 40,
        valuation.pe_ratio &gt; 30,
        indicator.eps &gt; 0.3,
        indicator.inc_net_profit_annual &gt; 0.30,
        indicator.roe &gt; 0.20
    ).order_by(
        valuation.pb_ratio.asc()
    ).limit(
        50), date=None)
</code></pre></div><p>将筛选后得到股票代码放置在stockpool的list列表中，以便之后对列表进行循环。</p><div class="highlight"><pre><code class="language-text">    stockpool = list(stock_to_choose[&#39;code&#39;])  #将筛选出的股票代码存入list中
    stockpool = paused_filter(stockpool)
    stockpool = delisted_filter(stockpool)
    stockpool = st_filter(stockpool)
    long_list = []     #买入列表
    short_list = []    #卖出列表
    hold = []          #持有列表
</code></pre></div><p>对于筛选出来的股票依次读取MACD数据。这里就需要用到talib库中MACD函数。TA-Lib中文全称为技术分析库，是一个广泛用在程序化交易中进行金融市场数据的技术分析的函数库。它提供了多种技术分析的函数，包含多种指标如<b>ADX, MACD, RSI, 布林轨道</b>等等，可以极大地方便我们量化投资中编程工作。</p><p>Talib中的MACD函数使用时格式为：</p><div class="highlight"><pre><code class="language-text">MACD(price, fastperiod=12, slowperiod=26, signalperiod=9)
</code></pre></div><p>传入函数的三个参数分别为短线周期、长线周期以及MACD的移动平滑周期。这里我们使用最常用的（12，26，9）组合。MACD()函数返回值共有三个，分别为<b>DIF，DEA和MACD</b></p><div class="highlight"><pre><code class="language-text">if g.days%g.refresh_rate == 0:
        for stock in stockpool:
            prices = attribute_history(stock,300, &#39;1d&#39;,[&#39;close&#39;])       #取较长周期的数据，这里为300日
            price = array(prices[&#39;close&#39;])                              #将price一列函数格式变为array
            macd_tmp = talib.MACD(price, fastperiod=12, slowperiod=26, signalperiod=20)   #将参数传入MACD函数中
            DIF = macd_tmp[0]           #返回的数据分别为短期慢线DIF、长期快线DEA及MACD
            DEA = macd_tmp[1]
            MACD = macd_tmp[2]
</code></pre></div><p><b>&lt;答疑与延伸&gt; </b><br/></p><ul><li>为什么要通过macd_tmp[0]来读取数据？ 因为MACD返回的是一个包括三个元素的序列array，和从list中取元素类似，我们通过在其后加上<a href="https://link.zhihu.com/?target=https%3A//image.joinquant.com/7585ddcc2aaca211a586069fd8d8ad9a" class=" wrap external" target="_blank" rel="nofollow noreferrer">0</a>的方式分别取第一个元素和第二个元素。</li><li>为什么要选取300日的历史数据？ MACD存在一个问题，即若选取时间较短，则可能出现不收敛的状况，因此这里我们选取300日的数据。</li></ul><br/><h3>4 买入卖出条件设置</h3><p>策略中我们要判断长线和短线的位置问题。这里我们做一些简化，判断当日和三日前的MACD正负情况。<br/>当日MACD为正且三日前MACD为负--&gt;金叉形成 买入<br/>当日MACD为负且三日前MACD为正--&gt;死叉形成 卖出 </p><p>将股票代码通过 append() 函数放在相应的买卖列表当中。</p><div class="highlight"><pre><code class="language-text">            if MACD[-1] &gt; 0 and MACD[-4] &lt; 0:
                long_list.append(stock)       #将出现金叉的股票代码放入long_list中
            elif MACD[-1] &lt; 0 and MACD[-4] &gt; 0:
                short_list.append(stock)      #将出现死叉的股票代码放入short_list中
            stockset = list(context.portfolio.positions.keys())   #获得当前持仓状况
</code></pre></div><p>当对筛选后保留的股票进行循环之后，符合条件的股票已经被放入买入或卖出列表中。下面查看当前所持有的股票，如果在卖出列表当中则全部卖出，不是则保留，并将股票代码放入hold[]列表中</p><div class="highlight"><pre><code class="language-text">            for stock in stockset:
                if stock in short_list:
                    order_target_value(stock, 0)      #卖出在short_list中的股票
                else:
                    hold.append(stock)                #保留不在short_list中的股票并将代码放在hold[]中,表示可以继续持有
</code></pre></div><p>买入long_list中除去已持有的股票：</p><div class="highlight"><pre><code class="language-text">        buy_list = []                  #设定一个新的空的list代表需要买入的股票
        for stock in long_list:
            if stock not in hold:
                buy_list.append(stock) #把在long_list中目前未持有的股票放入buy_list中代表接下来需要买入的股票
</code></pre></div><p>将可用资金根据股票数量进行均分。为避免出现除数为0的状况在这里进行一个判断。</p><div class="highlight"><pre><code class="language-text">        if len(buy_list)==0:    #如果要买入列表股票数量为0
            Cash = context.portfolio.available_cash
        else:
            Cash = context.portfolio.available_cash/len(buy_list)
            for stock in buy_list:
                order_target_value(stock, Cash)        
        g.days = 1         
    else:
        g.days += 1        #天数+1进行调仓周期的循环
</code></pre></div><h3>策略完成，进行回测</h3><p>把买入卖出的代码写好，策略就写完了，完整代码如下： </p><div class="highlight"><pre><code class="language-text">import pandas as pd
import numpy as np
import talib  ## 使用talib计算MACD的参数

def initialize(context):
    set_params()
    set_backtest()
    run_daily(trade, &#39;every_bar&#39;)

def set_params():
    g.days=0    
    g.refresh_rate=10 

def set_backtest():
    set_benchmark(&#39;000905.XSHG&#39;) 
    set_option(&#39;use_real_price&#39;, True)  
    log.set_level(&#39;order&#39;, &#39;error&#39;)

#每天开盘前要做的事情
def before_trading_start(context):
    set_slip_fee(context)

# 根据不同的时间段设置滑点与手续费
def set_slip_fee(context):
    set_slippage(FixedSlippage(0.02)) 

    dt=context.current_dt
    if dt&gt;datetime.datetime(2013,1, 1):
        set_order_cost(OrderCost(open_tax=0, close_tax=0.001, open_commission=0.0003, close_commission=0.0003, close_today_commission=0, min_commission=5), type=&#39;stock&#39;)
    else:
        set_order_cost(OrderCost(open_tax=0, open_commission=0.003,close_commission=0.003, close_tax=0.001,min_commission=5), type=&#39;stock&#39;)

# 过滤停牌、退市、ST股票
def paused_filter(security_list):
    current_data = get_current_data()
    security_list = [stock for stock in security_list if not current_data[stock].paused]
    return security_list


def delisted_filter(security_list):
    current_data = get_current_data()
    security_list = [stock for stock in security_list if not &#39;退&#39; in current_data[stock].name]
    return security_list

def st_filter(security_list):
    current_data = get_current_data()
    security_list = [stock for stock in security_list if not current_data[stock].is_st]
    return security_list

#######进行操作的过程#######   
def trade(context):
    stock_to_choose = get_fundamentals(query(
        valuation.code, valuation.pe_ratio, 
        valuation.pb_ratio,valuation.market_cap, 
        indicator.eps, indicator.inc_net_profit_annual
    ).filter(
        valuation.pe_ratio &lt; 40,
        valuation.pe_ratio &gt; 30,
        indicator.eps &gt; 0.3,
        indicator.inc_net_profit_annual &gt; 0.30,
        indicator.roe &gt; 0.20
    ).order_by(
        valuation.pb_ratio.asc()
    ).limit(
        50), date=None)

    stockpool = list(stock_to_choose[&#39;code&#39;])
    stockpool = paused_filter(stockpool)
    stockpool = delisted_filter(stockpool)
    stockpool = st_filter(stockpool)

    long_list = []
    short_list = []
    hold = []

    if g.days%g.refresh_rate == 0:
        for stock in stockpool:
            prices = attribute_history(stock,300, &#39;1d&#39;,[&#39;close&#39;])
            price = array(prices[&#39;close&#39;])
            macd_tmp = talib.MACD(price, fastperiod=12, slowperiod=26, signalperiod=20)
            DIF = macd_tmp[0]
            DEA = macd_tmp[1]
            MACD = macd_tmp[2]

            # 判断MACD走向
            if MACD[-1] &gt; 0 and MACD[-4] &lt; 0:
                long_list.append(stock)
            elif MACD[-1] &lt; 0 and MACD[-4] &gt; 0:
                short_list.append(stock)


        stockset = list(context.portfolio.positions.keys())

        for stock in stockset:
            if stock in short_list:
                order_target_value(stock, 0) 
            else:
                hold.append(stock)#如果不在卖出列表里则持有

        buy_list = []
        for stock in long_list:
            if stock not in hold:
                buy_list.append(stock)#新增的买入股票

        if len(buy_list)==0: 
            Cash = context.portfolio.available_cash
        else:
            Cash = context.portfolio.available_cash/len(buy_list)
            for stock in buy_list:
                order_target_value(stock, Cash)        
        g.days = 1
    else:
        g.days += 1
</code></pre></div><p>在2015.1.1-2016.12.31这段时间内进行回测，回测结果如图：</p><figure><noscript><img src="https://pic2.zhimg.com/v2-fc0b45c6f1dea1a09d93e29df3ccc3f5_b.jpg" data-rawwidth="1263" data-rawheight="640" class="origin_image zh-lightbox-thumb" width="1263" data-original="https://pic2.zhimg.com/v2-fc0b45c6f1dea1a09d93e29df3ccc3f5_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-fc0b45c6f1dea1a09d93e29df3ccc3f5_b.jpg" data-rawwidth="1263" data-rawheight="640" class="origin_image zh-lightbox-thumb lazy" width="1263" data-original="https://pic2.zhimg.com/v2-fc0b45c6f1dea1a09d93e29df3ccc3f5_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-fc0b45c6f1dea1a09d93e29df3ccc3f5_b.jpg"/></figure><h3>5 向导式初体验</h3><p>前段时期，致力于与时俱进的JoinQuant平台引入了高大上又因吹斯汀的功能--向导式。今天借着MACD的学习，我们一起来初步体验一下向导式的魅力吧！</p><p><b>&lt;新建策略&gt;</b><br/>首先点击上方“我的策略”，进入之后点击橘黄色的“策略生成器”就可以新建一个向导式策略啦！<figure><noscript><img src="https://pic4.zhimg.com/v2-fb3730c91bc6e170f1cecb2568ff66df_b.jpg" data-rawwidth="809" data-rawheight="153" class="origin_image zh-lightbox-thumb" width="809" data-original="https://pic4.zhimg.com/v2-fb3730c91bc6e170f1cecb2568ff66df_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-fb3730c91bc6e170f1cecb2568ff66df_b.jpg" data-rawwidth="809" data-rawheight="153" class="origin_image zh-lightbox-thumb lazy" width="809" data-original="https://pic4.zhimg.com/v2-fb3730c91bc6e170f1cecb2568ff66df_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-fb3730c91bc6e170f1cecb2568ff66df_b.jpg"/></figure><br/></p><p>打开之后呈现出的界面如下图所示。和平时写策略的思路一样，向导式分成几个大的部分：股票池的选取及筛选、个股买入设置、个股卖出设置、风险控制和其他参数。下面我们一部分一部分进行向导式的构建。<br/></p><figure><noscript><img src="https://pic3.zhimg.com/v2-8e80e932b2f21cfb596892eaf8ad4846_b.jpg" data-rawwidth="1489" data-rawheight="779" class="origin_image zh-lightbox-thumb" width="1489" data-original="https://pic3.zhimg.com/v2-8e80e932b2f21cfb596892eaf8ad4846_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-8e80e932b2f21cfb596892eaf8ad4846_b.jpg" data-rawwidth="1489" data-rawheight="779" class="origin_image zh-lightbox-thumb lazy" width="1489" data-original="https://pic3.zhimg.com/v2-8e80e932b2f21cfb596892eaf8ad4846_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-8e80e932b2f21cfb596892eaf8ad4846_b.jpg"/></figure><p><b> &lt;股票池的筛选&gt;</b><br/>在这一策略中，我们的选股条件是：沪深300成分股中，选择30&lt;市盈率（pe_ratio）&lt;40, 市净率（pb_ratio)&lt;3, 净利润环比增长率(inc_net_profit_annual)&gt;0.3，净资产收益率(roe)&gt;0.2的股票，并按照销售毛利率进行降序排列，选取前50只。<br/>在向导式中，每一指标旁边选项框的下拉箭头，分别根据需求设置股票池、ST选项以及是否过滤停牌和退市。<br/></p><figure><noscript><img src="https://pic3.zhimg.com/v2-7db7c4de78f895af19e3f436114cbe2a_b.jpg" data-rawwidth="943" data-rawheight="509" class="origin_image zh-lightbox-thumb" width="943" data-original="https://pic3.zhimg.com/v2-7db7c4de78f895af19e3f436114cbe2a_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-7db7c4de78f895af19e3f436114cbe2a_b.jpg" data-rawwidth="943" data-rawheight="509" class="origin_image zh-lightbox-thumb lazy" width="943" data-original="https://pic3.zhimg.com/v2-7db7c4de78f895af19e3f436114cbe2a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-7db7c4de78f895af19e3f436114cbe2a_b.jpg"/></figure><br/><p>策略中我们通过财务指标对股票进行了筛选。用动态市盈率的设定来举个栗子<br/></p><figure><noscript><img src="https://pic2.zhimg.com/v2-58e7bcc86d2c76bef7607cbe98efd909_b.jpg" data-rawwidth="932" data-rawheight="425" class="origin_image zh-lightbox-thumb" width="932" data-original="https://pic2.zhimg.com/v2-58e7bcc86d2c76bef7607cbe98efd909_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-58e7bcc86d2c76bef7607cbe98efd909_b.jpg" data-rawwidth="932" data-rawheight="425" class="origin_image zh-lightbox-thumb lazy" width="932" data-original="https://pic2.zhimg.com/v2-58e7bcc86d2c76bef7607cbe98efd909_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-58e7bcc86d2c76bef7607cbe98efd909_b.jpg"/></figure><br/><p>当鼠标点击“选股”按钮时，右侧就会出现选股指标。将鼠标放在想选择的指标名称上并单击左键，即可将该指标添加至左侧选股界面中，同时已经添加的指标会变成灰色表明不可重复添加。点击“动态市盈率”，这里我们需要将其限制在(30,40)区间中，在左侧界面“选项”下方下拉菜单选择“区间”并在后面将倍数相应改成30和40即可。</p><p>细心的朋友可能会注意到，在右侧“财务指标”栏旁边“附加条件”，点击之后可以看到这里我们可以添加股票池更新频率。在这个策略中我们更新频率是10个交易日，在左侧进行更改即可。 </p><figure><noscript><img src="https://pic1.zhimg.com/v2-6ea605f66c1abc67242b2ee77f28614c_b.jpg" data-rawwidth="1031" data-rawheight="290" class="origin_image zh-lightbox-thumb" width="1031" data-original="https://pic1.zhimg.com/v2-6ea605f66c1abc67242b2ee77f28614c_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-6ea605f66c1abc67242b2ee77f28614c_b.jpg" data-rawwidth="1031" data-rawheight="290" class="origin_image zh-lightbox-thumb lazy" width="1031" data-original="https://pic1.zhimg.com/v2-6ea605f66c1abc67242b2ee77f28614c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-6ea605f66c1abc67242b2ee77f28614c_b.jpg"/></figure><p>向导式还能够实现排序功能。在“选股”选项右侧有“排序”按钮，点击即可进入排序的设置。与选股指标类似，排序也是根据财务指标进行。</p><p>同时还可以对升序／降序进行选择<br/></p><figure><noscript><img src="https://pic2.zhimg.com/v2-ecfcaaaf6fdf910cc4498bea8b9ebfbd_b.jpg" data-rawwidth="918" data-rawheight="199" class="origin_image zh-lightbox-thumb" width="918" data-original="https://pic2.zhimg.com/v2-ecfcaaaf6fdf910cc4498bea8b9ebfbd_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-ecfcaaaf6fdf910cc4498bea8b9ebfbd_b.jpg" data-rawwidth="918" data-rawheight="199" class="origin_image zh-lightbox-thumb lazy" width="918" data-original="https://pic2.zhimg.com/v2-ecfcaaaf6fdf910cc4498bea8b9ebfbd_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-ecfcaaaf6fdf910cc4498bea8b9ebfbd_b.jpg"/></figure><p>向导式中添加指标时，点击对应项目下方的加号按钮即可添加项目，或者直接在右侧选项中单击指标即可将指标自动添加到左侧界面中。</p><p><b>&lt;个股买入设置&gt;</b><br/>类似的，我们设置买入内容。将鼠标放置在指标名称右侧灰色的圆圈套住的i标志上即可看到这一指标的含义及计算方法。<br/>在本策略中，我们用到的是技术指标MACD。单击MACD，在其中选择MACD项，可看到屏幕左侧相应指标栏中出现了MACD指标。<br/></p><figure><noscript><img src="https://pic3.zhimg.com/v2-3479091bdb98e6950ff5fe8168230e4e_b.jpg" data-rawwidth="868" data-rawheight="319" class="origin_image zh-lightbox-thumb" width="868" data-original="https://pic3.zhimg.com/v2-3479091bdb98e6950ff5fe8168230e4e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-3479091bdb98e6950ff5fe8168230e4e_b.jpg" data-rawwidth="868" data-rawheight="319" class="origin_image zh-lightbox-thumb lazy" width="868" data-original="https://pic3.zhimg.com/v2-3479091bdb98e6950ff5fe8168230e4e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-3479091bdb98e6950ff5fe8168230e4e_b.jpg"/></figure><p>我们本次策略是短期快线DIF向上穿过黄色的长期慢线DEA时，即出现做多金叉信号则买入。在向导式中我们直接在MACD指标中选择“金叉”即可。Joinquant平台默认的时间设置是（12，26，9），如果想进行更改则点击MACD所在行右侧图标进行快慢线时间跨度的更改。<br/></p><figure><noscript><img src="https://pic4.zhimg.com/v2-85a3177dbd76ce0f7ba4d27caa6a9f67_b.jpg" data-rawwidth="838" data-rawheight="333" class="origin_image zh-lightbox-thumb" width="838" data-original="https://pic4.zhimg.com/v2-85a3177dbd76ce0f7ba4d27caa6a9f67_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-85a3177dbd76ce0f7ba4d27caa6a9f67_b.jpg" data-rawwidth="838" data-rawheight="333" class="origin_image zh-lightbox-thumb lazy" width="838" data-original="https://pic4.zhimg.com/v2-85a3177dbd76ce0f7ba4d27caa6a9f67_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-85a3177dbd76ce0f7ba4d27caa6a9f67_b.jpg"/></figure><p><b>&lt; 个股卖出设置&gt;</b></p><p>卖出设置类比买入设置。在本策略中，我们卖出的条件是短期快线DIF向下穿过黄色的长期慢线DEA，即出现死叉信号。因此这里将MACD后面的类型改为“死叉”即可。同时保留默认设置，即不卖出欲买入股票。</p><br/><p><b>&lt; 风险控制&gt;</b></p><p>通过上一篇教程的学习，相信大家对于止盈止损的设置已经有了一定掌握。回想之前所介绍的个股止损方法，是通过函数利用当前价格和买入价格计算亏损比例实现的。因此我们至少需要一个自定义方程。向导式轻易解决了编写代码繁琐的问题。在向导式“风险控制”部分，我们可以直接设置个股止盈止损，还能选择多种止损方法如根据持仓价值、策略最大盈亏以及大盘信号等进行止损。之后我们会进一步进行介绍。<br/></p><figure><noscript><img src="https://pic4.zhimg.com/v2-10f03086d1b8742fae7b1f661ae38d6b_b.jpg" data-rawwidth="876" data-rawheight="244" class="origin_image zh-lightbox-thumb" width="876" data-original="https://pic4.zhimg.com/v2-10f03086d1b8742fae7b1f661ae38d6b_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-10f03086d1b8742fae7b1f661ae38d6b_b.jpg" data-rawwidth="876" data-rawheight="244" class="origin_image zh-lightbox-thumb lazy" width="876" data-original="https://pic4.zhimg.com/v2-10f03086d1b8742fae7b1f661ae38d6b_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-10f03086d1b8742fae7b1f661ae38d6b_b.jpg"/></figure><p><b> &lt;其他参数&gt;</b></p><p>“其他参数”模块和我们之前所提到的 initialize() 函数中的内容非常相似，即可以放入是否开启动态复权、设置滑点佣金、设置最大建仓数量等。<br/></p><figure><noscript><img src="https://pic1.zhimg.com/v2-ec067f7b10a6db900e19522f331c9d70_b.jpg" data-rawwidth="878" data-rawheight="362" class="origin_image zh-lightbox-thumb" width="878" data-original="https://pic1.zhimg.com/v2-ec067f7b10a6db900e19522f331c9d70_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-ec067f7b10a6db900e19522f331c9d70_b.jpg" data-rawwidth="878" data-rawheight="362" class="origin_image zh-lightbox-thumb lazy" width="878" data-original="https://pic1.zhimg.com/v2-ec067f7b10a6db900e19522f331c9d70_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-ec067f7b10a6db900e19522f331c9d70_b.jpg"/></figure><p><b>&lt;策略检验&gt;</b></p><p>和普通策略相同，向导式策略右上角可以设置回测时期、初始资金等，点击“更多”也可以进行基准和频率的设置。进行简单回测可以点击“快速回测”，想看到完整回测结果则点击：运行回测”。</p><p>以上就是我们从MACD择时策略出发对向导式进行的初步探究，之后我们也会对向导式陆续展开介绍。大家空闲时间可以对向导式进行进一步探索，以寻找更加高质量的策略！</p><h2>自测与自学</h2><p>1.是否掌握技术指标MACD的含义<br/>2.修改MACD函数，使得短线周期、长线周期以及MACD平滑周期分别为10、30、10，并尝试其他周期看是否能将结果进一步优化<br/>3.修改买入卖出条件设置，例如买入条件改为“在零轴之上形成金叉”，将卖出条件改为“在零轴下方”形成死叉”<br/>4.自主了解和MACD相关的一些走势概念，如佛手向上、小鸭出水、空中缆车等 </p><figure><noscript><img src="https://pic2.zhimg.com/v2-0098a7d8df973531e09dc3c3bd6cb6d1_b.png" data-rawwidth="874" data-rawheight="470" class="origin_image zh-lightbox-thumb" width="874" data-original="https://pic2.zhimg.com/v2-0098a7d8df973531e09dc3c3bd6cb6d1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-0098a7d8df973531e09dc3c3bd6cb6d1_b.png" data-rawwidth="874" data-rawheight="470" class="origin_image zh-lightbox-thumb lazy" width="874" data-original="https://pic2.zhimg.com/v2-0098a7d8df973531e09dc3c3bd6cb6d1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-0098a7d8df973531e09dc3c3bd6cb6d1_b.png"/></figure><br/><p>到JoinQuant查看策略源码，并与作者交流讨论：<a href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/7095%3Ff%3Dzhzl%26m%3D27491500" class=" wrap external" target="_blank" rel="nofollow noreferrer">【新手入门教程】MACD均线择时策略</a></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
