<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>关于 Padding Oracle 攻击【Hack The Box-I know Mag1k】</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/98964731">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-e167fdd2123e351beb93bb13ccc4082f_b.jpg" alt=""></div><p>直接开始吧，刚才做了一道 Hack The Box 的 web 题（可能上次的太“难”了，这次是 50 分的，可以了吧）。</p><a href="https://zhuanlan.zhihu.com/p/98483328" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-9a180a34ab747dfd5fd4970082207429_180x120.jpg" data-image-width="720" data-image-height="418" class="internal">二向箔安全学院：渗透测试在线练习平台：Hack The Box</a><h2>I know Mag1k</h2><blockquote>Can you get to the profile page of the admin?</blockquote><p>题意是让我们进入管理员的资料页。直接进入题目，打开是一个登录注册页面。</p><blockquote>会有以下思路：<br/>弱口令、爆破（一般只有登录入口时采用）<br/>SQL 绕过验证<br/>cookie验证<br/>注册登录<br/>......</blockquote><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-5b008144bca1d1fc21a9c58f1532918e_b.jpg" data-caption="" data-size="small" data-rawwidth="884" data-rawheight="651" class="origin_image zh-lightbox-thumb" width="884" data-original="https://pic3.zhimg.com/v2-5b008144bca1d1fc21a9c58f1532918e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-5b008144bca1d1fc21a9c58f1532918e_b.jpg" data-caption="" data-size="small" data-rawwidth="884" data-rawheight="651" class="origin_image zh-lightbox-thumb lazy" width="884" data-original="https://pic3.zhimg.com/v2-5b008144bca1d1fc21a9c58f1532918e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-5b008144bca1d1fc21a9c58f1532918e_b.jpg"/></figure><p>尝试弱口令登录，无果，报错信息为“用户名或密码错误”，无法判断是哪个错了，又试了几句SQLi，但没影响。so，换条路。</p><figure data-size="small"><noscript><img src="https://pic4.zhimg.com/v2-7a6421526f33370b128d1ee13fd698d7_b.jpg" data-caption="" data-size="small" data-rawwidth="782" data-rawheight="689" class="origin_image zh-lightbox-thumb" width="782" data-original="https://pic4.zhimg.com/v2-7a6421526f33370b128d1ee13fd698d7_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-7a6421526f33370b128d1ee13fd698d7_b.jpg" data-caption="" data-size="small" data-rawwidth="782" data-rawheight="689" class="origin_image zh-lightbox-thumb lazy" width="782" data-original="https://pic4.zhimg.com/v2-7a6421526f33370b128d1ee13fd698d7_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-7a6421526f33370b128d1ee13fd698d7_b.jpg"/></figure><p>注册一个帐号再登录。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-8823a061ddff44b17a4b68d3768d2200_b.jpg" data-caption="" data-size="normal" data-rawwidth="2532" data-rawheight="658" class="origin_image zh-lightbox-thumb" width="2532" data-original="https://pic1.zhimg.com/v2-8823a061ddff44b17a4b68d3768d2200_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-8823a061ddff44b17a4b68d3768d2200_b.jpg" data-caption="" data-size="normal" data-rawwidth="2532" data-rawheight="658" class="origin_image zh-lightbox-thumb lazy" width="2532" data-original="https://pic1.zhimg.com/v2-8823a061ddff44b17a4b68d3768d2200_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-8823a061ddff44b17a4b68d3768d2200_b.jpg"/></figure><p>注册了一个名为“admin”的帐号，说明管理员不叫“admin”，可知不是以名字判定管理员身份的，那一定存在其他标识。</p><p>用 Burpsuite 抓了个包。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-d5fb23acd1b0bd4ec134c1ac95a2a7e4_b.jpg" data-caption="" data-size="normal" data-rawwidth="1037" data-rawheight="506" class="origin_image zh-lightbox-thumb" width="1037" data-original="https://pic1.zhimg.com/v2-d5fb23acd1b0bd4ec134c1ac95a2a7e4_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-d5fb23acd1b0bd4ec134c1ac95a2a7e4_b.jpg" data-caption="" data-size="normal" data-rawwidth="1037" data-rawheight="506" class="origin_image zh-lightbox-thumb lazy" width="1037" data-original="https://pic1.zhimg.com/v2-d5fb23acd1b0bd4ec134c1ac95a2a7e4_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-d5fb23acd1b0bd4ec134c1ac95a2a7e4_b.jpg"/></figure><p>发现有一个 cookie 最耀眼，iknowmag1k 和题目相符。</p><div class="highlight"><pre><code class="language-text">uHhbKQ3eq+7RIE/+7FWzsoLgnaFTYJ+kKJiGpxqwuMbrArnkgEGnZQ==</code></pre></div><p>得到这串字符，可以说是一脸懵，毫无头绪，查阅了很多资料。都指向了同一个目标：Padding Oracle。</p><h2>Padding Oracle</h2><p>Padding Oracle 攻击是利用了服务器在 CBC（密码块链接模式）加密模式中的填充测试漏洞。</p><p><b>什么是 CBC 加密？</b></p><p>整个流程如下：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-b41e783213c6e8c8bb0b1cf303afd269_b.jpg" data-caption="" data-size="normal" data-rawwidth="623" data-rawheight="236" class="origin_image zh-lightbox-thumb" width="623" data-original="https://pic2.zhimg.com/v2-b41e783213c6e8c8bb0b1cf303afd269_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-b41e783213c6e8c8bb0b1cf303afd269_b.jpg" data-caption="" data-size="normal" data-rawwidth="623" data-rawheight="236" class="origin_image zh-lightbox-thumb lazy" width="623" data-original="https://pic2.zhimg.com/v2-b41e783213c6e8c8bb0b1cf303afd269_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-b41e783213c6e8c8bb0b1cf303afd269_b.jpg"/></figure><p>举个例子：</p><ul><li>001：AAAAAAAABBBBBBBBBBCCCCCCCC</li><li>002：AAAAAAAABBBBBBBBBBCCCC</li></ul><p>如果期望的块大小为 8，001 可被分为3个部分，块大小为8（8 A&#39;s + 8 B&#39;s + 8 C&#39;s）。但是对于 002，如果要将块大小为8，则将短4个字母。因此，引入了填充来绕过此限制。填充会在加密之前添加一些额外的位，以构成有意义的块，因此存在不同的填充方案。</p><p>分组完成后，随机生成一个 Initialization Vector（IV），将第一个明文分组与 IV 作异或运算，将结果进行加密，得到第一个明文分组的密文，从第二个明文分组开始，先将明文分组与上一组的密文作异或运算，再将结果进行加密，得到该分组的密文。</p><p>PCKS#5的填充方式为：明文的最后一个数据块包含N个字节的填充数据（N取决于明文最后一块的数据长度）。</p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-5ba0b9e2ac57b0231e7a7a6c49397b09_b.jpg" data-caption="" data-size="small" data-rawwidth="790" data-rawheight="437" class="origin_image zh-lightbox-thumb" width="790" data-original="https://pic2.zhimg.com/v2-5ba0b9e2ac57b0231e7a7a6c49397b09_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-5ba0b9e2ac57b0231e7a7a6c49397b09_b.jpg" data-caption="" data-size="small" data-rawwidth="790" data-rawheight="437" class="origin_image zh-lightbox-thumb lazy" width="790" data-original="https://pic2.zhimg.com/v2-5ba0b9e2ac57b0231e7a7a6c49397b09_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-5ba0b9e2ac57b0231e7a7a6c49397b09_b.jpg"/></figure><ul><li>一个0x01（0x01）</li><li>两个0x02（0x02，0x02）</li><li>三个0x03（0x03，0x03，0x03）</li><li>四个0x04（0x04，0x04，0x04，0x04）</li></ul><p>如果解密后的最后一个数据块末尾并非这些合法的字节序列，大部分加/解密程序都会抛出一个填充异常。这个异常对于攻击者尤为关键，它是 Padding Oracle 攻击的基础。</p><blockquote>异或（XOR）在编程语言中通常用“ ^”表示，是一种按位运算符，在加密中用于将两个值以可逆方式混合在一起。</blockquote><p>解密流程：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-191efcf8a882f7d4a6d748cc96d9f144_b.jpg" data-caption="" data-size="normal" data-rawwidth="1000" data-rawheight="403" class="origin_image zh-lightbox-thumb" width="1000" data-original="https://pic1.zhimg.com/v2-191efcf8a882f7d4a6d748cc96d9f144_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-191efcf8a882f7d4a6d748cc96d9f144_b.jpg" data-caption="" data-size="normal" data-rawwidth="1000" data-rawheight="403" class="origin_image zh-lightbox-thumb lazy" width="1000" data-original="https://pic1.zhimg.com/v2-191efcf8a882f7d4a6d748cc96d9f144_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-191efcf8a882f7d4a6d748cc96d9f144_b.jpg"/></figure><p><b>Padding Oracle 攻击</b></p><p>攻击者往往只需要知道给定密文是否产生具有有效填充的明文。也就是说，知道一个明文加密后的密文，便可解密任何经其加密的密文。</p><p>在 CBC 加密中，每个明文块在传递到密码之前都与前一个密文块进行异或。因此，在 CBC 解密中，每个密文都经过密文，然后与先前的密文块进行 XOR 运算，得到纯文本。</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-a090482c03b3a2b90f2ac198543a8b97_b.jpg" data-caption="" data-size="normal" data-rawwidth="542" data-rawheight="361" class="origin_image zh-lightbox-thumb" width="542" data-original="https://pic4.zhimg.com/v2-a090482c03b3a2b90f2ac198543a8b97_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-a090482c03b3a2b90f2ac198543a8b97_b.jpg" data-caption="" data-size="normal" data-rawwidth="542" data-rawheight="361" class="origin_image zh-lightbox-thumb lazy" width="542" data-original="https://pic4.zhimg.com/v2-a090482c03b3a2b90f2ac198543a8b97_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-a090482c03b3a2b90f2ac198543a8b97_b.jpg"/></figure><p>该攻击通过为每个密文计算解密的“中间值”来进行。</p><ul><li>I2 = C1 ^ P2</li><li>P2 = C1 ^ I2</li></ul><p>我们已经知道C1了，因为它只是密文的一部分，因此，如果找到I2，则可以轻松找到P2并解密密文。</p><p>因为我们输入的密文可以是任意值，但是异或之后得到的填充值可能出现错误，解密程序抛出异常，而正常的解密就不会异常，所以，我们可以根据服务器的反应来判断我们输入的值。从而可以进行爆破得出正确值，当然，这个过程比较繁琐，所以 PadBuster 上场了。</p><p><b>工具 PadBuster</b></p><p>项目：<a href="https://link.zhihu.com/?target=https%3A//github.com/AonCyberLabs/PadBuster" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/AonCyberLabs</span><span class="invisible">/PadBuster</span><span class="ellipsis"></span></a></p><p>kali 上有的，可直接使用。</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-b6a04b6f3c72c145c6b9210ca97c9dca_b.jpg" data-caption="" data-size="small" data-rawwidth="1337" data-rawheight="951" class="origin_image zh-lightbox-thumb" width="1337" data-original="https://pic3.zhimg.com/v2-b6a04b6f3c72c145c6b9210ca97c9dca_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-b6a04b6f3c72c145c6b9210ca97c9dca_b.jpg" data-caption="" data-size="small" data-rawwidth="1337" data-rawheight="951" class="origin_image zh-lightbox-thumb lazy" width="1337" data-original="https://pic3.zhimg.com/v2-b6a04b6f3c72c145c6b9210ca97c9dca_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-b6a04b6f3c72c145c6b9210ca97c9dca_b.jpg"/></figure><p>常用的参数：</p><ul><li>–cookies 指定要解密的cookie</li><li>–encoding 使用编码格式</li><li>–auth 用于认证</li></ul><p>回到刚才的题目，尝试解密那串字符，命令：</p><div class="highlight"><pre><code class="language-text">padbuster 目标url 加密样本（也就是iknowmag1k的值） 块大小 --cookies &#34;phpsessid和iknowmag1k&#34;</code></pre></div><p>解密结果为：</p><div class="highlight"><pre><code class="language-text">{&#34;user&#34;:&#34;admin&#34;,&#34;role&#34;:&#34;user&#34;}</code></pre></div><p>内容为用户的用户名，以及权限。所以，我们只需将“user”改为“admin”即可获得管理员权限。</p><p>获取加密后的文本，命令：</p><div class="highlight"><pre><code class="language-text">padbuster 目标url 加密样本 块大小 --cookies &#34;phpsessid和iknowmag1k&#34; --plaintext 需要加密的文本</code></pre></div><blockquote>这里需要注意的是要加 \ 转义，{\&#34;user\&#34;:\&#34;admin\&#34;,\&#34;role\&#34;:\&#34;user\&#34;}</blockquote><div class="highlight"><pre><code class="language-text">lqZWcelc1WbYpNcROwiTGIprI45i7IsYMAovrw2IGp8AAAAAAAAAAA%3D%3D</code></pre></div><p>得到加密文本后，再用 Burpsuite 提交请求，带入刚生成的 iknowmag1k 值。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-a236e50dc7041a77e2576fee5a3ed295_b.jpg" data-caption="" data-size="normal" data-rawwidth="2532" data-rawheight="529" class="origin_image zh-lightbox-thumb" width="2532" data-original="https://pic2.zhimg.com/v2-a236e50dc7041a77e2576fee5a3ed295_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-a236e50dc7041a77e2576fee5a3ed295_b.jpg" data-caption="" data-size="normal" data-rawwidth="2532" data-rawheight="529" class="origin_image zh-lightbox-thumb lazy" width="2532" data-original="https://pic2.zhimg.com/v2-a236e50dc7041a77e2576fee5a3ed295_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-a236e50dc7041a77e2576fee5a3ed295_b.jpg"/></figure><p>得到 flag。</p><p>想了解更多关于 <b>Hack The Box</b> 的靶场娱乐，欢迎关注 <a href="https://link.zhihu.com/?target=https%3A//twosecurity.cn/" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全学院</a> 。</p><p>可能有小白看不懂这些操作，什么是 <b>Burpsuite</b> ？什么是 <b>爆破</b> ？什么是 <b>flag</b> 等等。。。</p><p><a href="https://link.zhihu.com/?target=https%3A//twosecurity.cn/" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全学院</a> 最近推出了网络安全零基础入门集训，哪怕你什么都不懂，都能让你轻松（好吧，没那么简单，还是要付出努力的）入门网络安全。</p><a href="https://zhuanlan.zhihu.com/p/97763889" data-draft-node="block" data-draft-type="link-card" data-image="https://pic4.zhimg.com/v2-685d1b251edaac139b1ca1a08811e317_180x120.jpg" data-image-width="900" data-image-height="383" class="internal">二向箔安全学院：入门网络安全的统一解答【零基础入门集训营】</a><p>进行网络安全入门集训，短短 <b>2 个周</b> 快速入门。</p><p>当然，态度认真的学员（说白了就是都可以）可免费使用我们官方的 <b>在线强化训练集</b> （现含81道 CTF 题，随时更新ing）</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_b.jpg" data-caption="" data-size="small" data-rawwidth="2149" data-rawheight="1217" class="origin_image zh-lightbox-thumb" width="2149" data-original="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_b.jpg" data-caption="" data-size="small" data-rawwidth="2149" data-rawheight="1217" class="origin_image zh-lightbox-thumb lazy" width="2149" data-original="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_b.jpg"/></figure><p>本期 <b>限定两个班级</b>，招满即止。</p><p><a href="https://link.zhihu.com/?target=https%3A//submit.twosecurity.io/f/lF6ZMY" class=" wrap external" target="_blank" rel="nofollow noreferrer">填写资料并付款</a>，按付款时间顺序开班，<b>因人数超过限制而报名失败的学员将全额退款。</b></p><p>详情可咨询客服微信 <b>twosecurity02</b></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
