<div class="title-image"><img src="https://pic2.zhimg.com/v2-9b36ad42b47c6df771232307ad9ed78a_b.jpg" alt=""></div><p>MACD 是常用的技术指标。广泛应用于股票期货等投资品类中。本文抱着实验的心态，通过 MACD 被使用最普遍的的方法对该指标在中国商品期货市场的择时效果进行验证。</p><p>我们还加入了波动率过滤，和追踪止损模块，希望以此验证指标的有效性，同时在验证过程中对传统方法进行调整，以期获得更好的绩效。</p><h2><b>MACD 简介</b></h2><p>MACD分为三根线，分别是<b>快速线 DIF，慢速线 DEA，信号线 MACD</b>。</p><p>计算方法为：</p><p>DIF = EMA(〖Price〗_i) - EMA(〖Price〗_j)</p><p>DEA = EMA(〖DIF〗_n)</p><p>MACD = 2 * (DIF - DEA)</p><p><b>Price：</b>资产价格</p><p><b>i：</b>短周期参数</p><p><b>j：</b>长周期参数</p><p><b>n：</b>DEA 周期参数</p><p><b>EMA：</b>指数平均</p><h2><b>策略使用方法</b></h2><p>使用的是最普遍，也是最简单的 MACD 方法。即金叉买入，死叉卖出。</p><p>对于金叉和死叉的判定，也是众说纷纭。</p><p><b>1、最传统保守的论点是：</b>金叉，快速线 DIF，慢速线DEA同时大于 0，且DIF上穿 DEA，MACD 由负数变为正数；死叉：快速线 DIF，慢速线DEA同时小于 0，且DIF 下穿 DEA，MACD 由正数变为负数。</p><p><b>2、而另一种观点认为：</b>并不需要限制DIF和DEA的符号，只需要 DIF 上下穿 DEA 就可以判定金叉和死叉。</p><p><b>3、还有一种观点：</b>是我们最终放出来的这个代码，就是 DIF 和 DEA 都大于 0 时候做多，反之都小于 0 做空。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-dc8c20428523ee56bfb24bce5acc6315_b.jpg" data-caption="" data-size="normal" data-rawwidth="716" data-rawheight="157" class="origin_image zh-lightbox-thumb" width="716" data-original="https://pic2.zhimg.com/v2-dc8c20428523ee56bfb24bce5acc6315_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-dc8c20428523ee56bfb24bce5acc6315_b.jpg" data-caption="" data-size="normal" data-rawwidth="716" data-rawheight="157" class="origin_image zh-lightbox-thumb lazy" width="716" data-original="https://pic2.zhimg.com/v2-dc8c20428523ee56bfb24bce5acc6315_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-dc8c20428523ee56bfb24bce5acc6315_b.jpg"/></figure><p>在我们的模型中，我们最初使用了传统观点，因为无论是实际测试还是从逻辑出发推测，传统观点的严格性都能更好的界定价格突破的真实性。</p><p>之后发现，使用改进方法也确实取得了更好的绩效表现。但是做参数变化时，我们发现，其实更加有效的模块，是追踪止损。</p><p><b>小编有话说：聚宽已经实现了<u><a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s%3F__biz%3DMzI2ODAzNzQ0Mw%3D%3D%26mid%3D2650726531%26idx%3D1%26sn%3D2b89f4818d9de070ac0ee15dc49bd464%26chksm%3Df2fffcafc58875b9534a62f2ea2c4f21b51c590eea45b60722f56e5c750843017d17493bd0b4%26mpshare%3D1%26scene%3D21%26srcid%3D0322JoMiSgOCnGDApY2ilbkx%26key%3D593d1b6cca835b63ff92457ae84c5c425d164539d9715d4b7338609bb7784017de0b2b1e942958f6fc1adb2d7f5b712837cf7cf43de127c9460e0e74931f2e07b19932b54525e4a519dc5efe43e638cf%26ascene%3D1%26uin%3DMjE3NzI3NjE0NA%3D%3D%26devicetype%3DWindows%252010%26version%3D62060739%26lang%3Dzh_CN%26pass_ticket%3D%2Bksnws9s9/LBL9AG/kQMFeFdsNxf3OaDtbkbBg0te3Izs6g%2B%2Bi1oRaUV8BkL1UHn%23wechat_redirect" class=" wrap external" target="_blank" rel="nofollow noreferrer">期货实盘</a></u>，详情参见文末推荐阅读。有兴趣的朋友可以了解一下~</b></p><h2><b>模型参数</b></h2><p>一个好的策略首先就是要保证尽可能维持数据的鲁棒性。因此我们在对策略进行优化的过程，只对MACD中快速线周期，慢速线周期和信号线周期三个参数进行调整，其他条件都保持默认，因此来防止策略得过度拟合。</p><p><b>1、模型多参数下绩效表现：</b></p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-2525b4b3c7e4759b43d7fb190b7284e8_b.jpg" data-caption="" data-size="normal" data-rawwidth="1393" data-rawheight="548" class="origin_image zh-lightbox-thumb" width="1393" data-original="https://pic1.zhimg.com/v2-2525b4b3c7e4759b43d7fb190b7284e8_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-2525b4b3c7e4759b43d7fb190b7284e8_b.jpg" data-caption="" data-size="normal" data-rawwidth="1393" data-rawheight="548" class="origin_image zh-lightbox-thumb lazy" width="1393" data-original="https://pic1.zhimg.com/v2-2525b4b3c7e4759b43d7fb190b7284e8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-2525b4b3c7e4759b43d7fb190b7284e8_b.jpg"/></figure><p>我们可以看到，经过多组参数的测试。每个参数组都取得了正收益，说明该模型的确具有一定的择时能力。而事实上，表现最差的一组模型我们使用的是 13，26，9 的 MACD 原始默认参数。而其他参数组使用的参数周期均更短。因此我们判断， MACD 模型对于短期价格突破的预测能力更敏感。</p><p><b>2、模型多参数下最佳组绩效表现：</b></p><p>当参数 fastperior=3，slowperiod=7，signalperiod=7 时，模型取得了最好的绩效和 Sharpe Radio。绩效曲线如下：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-255d9feac1a95c4b3ecfd9ee611f654c_b.jpg" data-caption="" data-size="normal" data-rawwidth="1519" data-rawheight="394" class="origin_image zh-lightbox-thumb" width="1519" data-original="https://pic1.zhimg.com/v2-255d9feac1a95c4b3ecfd9ee611f654c_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-255d9feac1a95c4b3ecfd9ee611f654c_b.jpg" data-caption="" data-size="normal" data-rawwidth="1519" data-rawheight="394" class="origin_image zh-lightbox-thumb lazy" width="1519" data-original="https://pic1.zhimg.com/v2-255d9feac1a95c4b3ecfd9ee611f654c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-255d9feac1a95c4b3ecfd9ee611f654c_b.jpg"/></figure><h2><b>模型调整</b></h2><p>出于进一步探究的目的，我们对策略进行了一些调整，希望能取得更好的效果，各调整方法与有效性分析如下。</p><p><b>使用 80-20 周期波动率过滤方法：</b></p><p>80-20 方法，即计算 80 日到当前每一日的 20 日波动率，求平均，然后用当前 20 日波动率和这个平均值做对比，如果当前 20 日波动率更大，就认为该品种目前波动率过大趋势不明，该品种就不参与交易。</p><p>代码表达如下（实测效果并不好）：</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-5c223ca85786af528b440ec25ee2a1bb_b.jpg" data-caption="" data-size="normal" data-rawwidth="497" data-rawheight="304" class="origin_image zh-lightbox-thumb" width="497" data-original="https://pic4.zhimg.com/v2-5c223ca85786af528b440ec25ee2a1bb_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-5c223ca85786af528b440ec25ee2a1bb_b.jpg" data-caption="" data-size="normal" data-rawwidth="497" data-rawheight="304" class="origin_image zh-lightbox-thumb lazy" width="497" data-original="https://pic4.zhimg.com/v2-5c223ca85786af528b440ec25ee2a1bb_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-5c223ca85786af528b440ec25ee2a1bb_b.jpg"/></figure><p><b>使用截面波动率过滤方法：</b></p><p>截面波动率过滤方法即，计算全市场所有品种波动率Z分位数的均值，然后用当前品种波动率的 Z 分位数和这个平均值做对比，如果波动率更大，就认为该品种目前波动率过大趋势不明，该品种就不参与交易。</p><p>代码表达如下：</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-3c25ede6a9fb4284576899c781414a63_b.jpg" data-caption="" data-size="normal" data-rawwidth="1170" data-rawheight="319" class="origin_image zh-lightbox-thumb" width="1170" data-original="https://pic4.zhimg.com/v2-3c25ede6a9fb4284576899c781414a63_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-3c25ede6a9fb4284576899c781414a63_b.jpg" data-caption="" data-size="normal" data-rawwidth="1170" data-rawheight="319" class="origin_image zh-lightbox-thumb lazy" width="1170" data-original="https://pic4.zhimg.com/v2-3c25ede6a9fb4284576899c781414a63_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-3c25ede6a9fb4284576899c781414a63_b.jpg"/></figure><p>更新后模型的绩效得到了一些提升，上图不是很直观，我们直接使用数据进行绩效比：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-49836fb04035295402e40627278f98d4_b.png" data-caption="" data-size="normal" data-rawwidth="982" data-rawheight="85" class="origin_image zh-lightbox-thumb" width="982" data-original="https://pic1.zhimg.com/v2-49836fb04035295402e40627278f98d4_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-49836fb04035295402e40627278f98d4_b.png" data-caption="" data-size="normal" data-rawwidth="982" data-rawheight="85" class="origin_image zh-lightbox-thumb lazy" width="982" data-original="https://pic1.zhimg.com/v2-49836fb04035295402e40627278f98d4_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-49836fb04035295402e40627278f98d4_b.png"/></figure><p>可以看到绩效在几个参数下都有所所提升。说明截面波动率过滤方法达到了我们希望达到的效果。</p><p>下图为截面过滤后 MACD 策略收益风险矩阵图：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-ef80995cddbe404a0d3d714a7cacab51_b.jpg" data-caption="" data-size="normal" data-rawwidth="1380" data-rawheight="492" class="origin_image zh-lightbox-thumb" width="1380" data-original="https://pic2.zhimg.com/v2-ef80995cddbe404a0d3d714a7cacab51_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-ef80995cddbe404a0d3d714a7cacab51_b.jpg" data-caption="" data-size="normal" data-rawwidth="1380" data-rawheight="492" class="origin_image zh-lightbox-thumb lazy" width="1380" data-original="https://pic2.zhimg.com/v2-ef80995cddbe404a0d3d714a7cacab51_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-ef80995cddbe404a0d3d714a7cacab51_b.jpg"/></figure><p>鉴于过滤前数据缺失，而且过滤后柱状图并未显示具体数值，观察起来比较困难，我们直接出示绩效对比结论。过滤对于夏普比率的提升，最大回撤的减少并没有显著帮助，但是过滤后的策略绩效得到了提升。说明过滤过滤掉了不容易跟踪趋势的品种，存在一些效果。</p><p>模型截面波动率过滤后多参数下最佳参数组绩效表现：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-38387a3fec5375350747ff58f6f65120_b.jpg" data-caption="" data-size="normal" data-rawwidth="1515" data-rawheight="450" class="origin_image zh-lightbox-thumb" width="1515" data-original="https://pic1.zhimg.com/v2-38387a3fec5375350747ff58f6f65120_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-38387a3fec5375350747ff58f6f65120_b.jpg" data-caption="" data-size="normal" data-rawwidth="1515" data-rawheight="450" class="origin_image zh-lightbox-thumb lazy" width="1515" data-original="https://pic1.zhimg.com/v2-38387a3fec5375350747ff58f6f65120_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-38387a3fec5375350747ff58f6f65120_b.jpg"/></figure><p><b>最终，当我们想公开这些测试结论的时候，我发现回测中有 3 个问题：</b></p><p>1、手续费设置较低，所以我们改为万分之1单边手续费+万分之 1 滑点（在很多品种上，差不多就是 1 跳），然后重新测试了性能，结果绩效差异不大。</p><p>2、某些时刻，截面持仓数量会达到 20 个品种，此时，对每个品种在ATR头寸部分，分配 0.05 的资金量，会造成其他品种不够用。所以，我调整为 0.01，要知道海龟交易系统才 0.01。所以调整后，收益和回撤，都发生了下降，但是收益风险比、夏普比率这些值，没有变化，因为期货是保证金交易，我们只是用了更少资金，收益和回撤，都会等比例下降。</p><p>3、某些波动率太低的品种，常年无法择时获得正收益的品种，没必要去交易，为什么不剔除这些品种呢？就像股票模型的黑名单一样，这里不存在什么幸存者偏差，这些品种从基本面、交割制度、市场博弈层面就是存在问题的，完全可以剔除。说的就是这几个：&#39;ZN&#39;,&#39;SN&#39;,&#39;BU&#39;,&#39;A&#39;,&#39;CF&#39;,&#39;OI&#39;,&#39;AP&#39;,&#39;JM&#39;,&#39;FG&#39;</p><p>看看结果吧：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-ff967048912090b51b7de808f4f0ca71_b.jpg" data-caption="" data-size="normal" data-rawwidth="1064" data-rawheight="361" class="origin_image zh-lightbox-thumb" width="1064" data-original="https://pic2.zhimg.com/v2-ff967048912090b51b7de808f4f0ca71_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-ff967048912090b51b7de808f4f0ca71_b.jpg" data-caption="" data-size="normal" data-rawwidth="1064" data-rawheight="361" class="origin_image zh-lightbox-thumb lazy" width="1064" data-original="https://pic2.zhimg.com/v2-ff967048912090b51b7de808f4f0ca71_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-ff967048912090b51b7de808f4f0ca71_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>点击【<a href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/view/community/detail/17302" class=" wrap external" target="_blank" rel="nofollow noreferrer">阅读原文</a>】，即可查看完整源码~</p>