<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MPS教程三：制作一个简易语言（中）</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/26258595">原文</a></p>
<div class="title-image"><img src="https://pic3.zhimg.com/v2-719fcebf01f23aa889a26b075b6c7172_r.png" alt=""></div><p>在上一篇教程中，我们已经体验了MPS创建语言的流程的一半。 接下来，我们将进行Code Generation，把之前的“语言”生成的代码导出为Java代码，并运行它。</p><p>[ e | e &lt;- <a href="http://ice1000.org/2017/04/07/MakeSimpleLangWithMPS/" data-editable="true" data-title="MPS教程三：制作一个简易语言（中）">MPS教程三：制作一个简易语言（中）</a> , e == 原文]</p><h2>准备工作</h2><ul><li>阅读并跟随<a href="http://ice1000.org/2017/04/06/MakeSimpleLangWithMPS/" data-editable="true" data-title="上一篇博客">上一篇博客</a>完成之前的工作。</li><li>学会用Java写Hello World</li></ul><h2>本文主要内容</h2><p>你在看上篇教程的时候肯定以为是分成上下的，结果没想到出了个“中”，你一定很绝望吧。</p><p>其实不是这样的，我只是想把最初的三个概念分开说而已，MPS很简单的。</p><h3>有哪些新概念</h3><ul><li>没有新引入的概念</li></ul><h2>开始吧</h2><p>打开你的MPS，进入上次创建的工程。</p><p>打开左边的、昨天说的不会讲太多但是是今天的主菜的“Generator”， 并打开昨天我们自动生成的map_PrintlnSet。<img src="https://pic3.zhimg.com/v2-1ee2ede9a6287400b33c449bceccd7e3_r.png" data-rawwidth="959" data-rawheight="439"></p><p>你可以看到，这是一个命名非常不规范的Java类——一个空的Java类。不过这是生成的代码，不用担心。</p><p>对了，忘记介绍概念了。</p><h3>先复习一下</h3><p>上篇教程讲了<em>Concept这个概念</em>（这句话翻译成英语会很鬼畜，哈哈哈哈）——它：</p><ul><li>是AST的节点</li><li>可以拥有别的节点（作为父节点）</li><li>可选地成为一个根节点</li><li>上一篇没有提到的是，它可以拥有别的AST节点的引用。可惜我们暂时不会用到这个特性</li></ul><p>还有一些别的没有cover到的点，我将会在后期列出。</p><h3>为什么不现在说完</h3><p><strong>一下子甩一堆概念是一种耍流氓。狠狠地黑一波现在绝大多数国产书。</strong></p><p>看我的教程，你放心。我和那些半灌水不一样，我可是空灌水！</p><h3>Generator</h3><p><strong>MPS通过你的在破界神编辑器里编辑的AST，生成目标代码并编译</strong>。这也是为什么我之前说“java文件不是源码而是目标文件”的原因。</p><p>而这里的<strong>Generator</strong>，就是你<strong>进行代码生成的模板</strong>。可以理解吧？MPS按照这个模板来生成代码。 熟悉具有宏特性语言（i.e. Lisp系列, Rust, Scala, etc.）的人应该可以很容易理解：</p><ul><li>MPS的AST就是宏的参数</li><li>MPS的Generator就是宏的body</li><li>MPS的Generator非常强大，不过这个教程里的例子暂时体现不出来</li></ul><p>我们来编写最基本的部分，先写个main函数，里面写个输出语句。 请记得使用<a href="http://ice1000.org/2016/06/29/LearnIDEA3/" data-editable="true" data-title="Live Template">Live Template</a>哦。</p><p>（上面的链接指向的博客是我还不知道Live Template可以定制的时候写的，所以没往深处讲，不过内容是正确的）<img src="https://pic4.zhimg.com/v2-ce434f753a434c9dc22f1cc029cf0278_r.png" data-rawwidth="644" data-rawheight="248"></p><p>可以看到我已经写好了一个非常友善的输出语句。现在，我们要对它进行模板化处理——先选中这个输出语句。</p><h3>注意</h3><p>这是一个非常容易出错的地方，是绝大多数新人可能犯错的地方。在Java中，</p><br><code lang="java">System.out.println("")
</code><p>是一个<strong>表达式</strong>，而</p><br><code lang="java">System.out.println("");
</code><p>是一个<strong>语句</strong>。</p><p>区别（仅仅是这一个地方的区别，他是正确的，但是不具有普适性，读者也不需要了解普适性的区别，因为用不到）：</p>概念　　　　　　　语法上　　　　　　对应的语义上<p>表达式　　　　　　没分号　　　　　　有“返回值”</p><p>语句　　　　　　　有分号　　　　　　没有“返回值”，或者说返回Unit</p><p>然后我们这里是选中一个语句！对它使用<strong>Alt+Enter</strong>，选择<strong>LOOP开头clause结尾</strong>的那个。<img src="https://pic3.zhimg.com/v2-24339b6843987c88736396f425978a31_r.png" data-rawwidth="537" data-rawheight="311"></p><p>然后你看到了原本不可能出现在Java代码中的东西。这个东西原本是需要一个很长的过程创建的，MPS提供了快速创建的方法。<img src="https://pic1.zhimg.com/v2-9bfac5c0da1a870d7e78f2867eb58cc2_r.png" data-rawwidth="563" data-rawheight="169"></p><p>然后我们选中那个字符串的内容，<strong>不包含双引号</strong>，使用<strong>Alt+Enter</strong>，选择content结尾的那个：<img src="https://pic4.zhimg.com/v2-3e7e5fb65d1284c1e3ae52eec218e2ef_r.png" data-rawwidth="842" data-rawheight="410"></p><p>然后你又一次看到了那个美元符号+中括号组成的东西。<img src="https://pic2.zhimg.com/v2-6d24799af3b7f5424650b3bae39017c2_r.png" data-rawwidth="571" data-rawheight="146"></p><p>然后我们的工作就完成了！是不是很懵逼！什么都没懂！没关系！现在先完成语言，等会再解释。</p><h3>再次注意</h3><p>千万不要忘记编译！！！<strong>Ctrl+F9</strong>！！！</p><p>我在写教程的时候就忘了，Orz。</p><h3>回到刚才的语言</h3><p>回到昨天创建的那个PrintlnSet，我们在打开的编辑器里面右键，选择<strong>Preview Generated Text</strong>。<img src="https://pic3.zhimg.com/v2-1cb96566a8454aa14176c09bc626db1e_r.png" data-rawwidth="859" data-rawheight="555"></p><p>生成的代码是这样的：</p><br><code lang="text">package VerboseLang.sandbox;

/*Generated by MPS */


public class map_PrintlnSet {
  public static void main(String[] args) {
    System.out.println("Fuck you ZhiHu Editor!!!!");
    System.out.println("My name is Van, I'm an artist.");
    System.out.println("I'm a performance artist.");
  }
}

</code><p>但是你似乎并没有看到类似“Run”、“Execute”之类的字样，对吧？因为我们需要让它成为一个<strong>可执行</strong>的AST，才能运行它。</p><p>而不仅仅是需要有main函数。</p><p>我们对左边logical view的VerboseLang那个地方进行<strong>Alt+Enter</strong>，找到上篇博客提到过的“Dependency”，再添加这个叫</p><p>jetbrains.mps.execution.util</p><p>的Dependency：<img src="https://pic3.zhimg.com/v2-8ae081acd85a575942c05b3b0be30161_r.png" data-rawwidth="848" data-rawheight="648"></p><p>然后找到PrintlnSet的定义，让它实现一个接口——<strong>IMainClass</strong>：<img src="https://pic1.zhimg.com/v2-87229343b4a9ebfaa32a9386d3a98668_r.png" data-rawwidth="964" data-rawheight="390"></p><br><p>注意，MPS的接口和Java的接口也有一点不一样——</p>语言　　　　inheritance<p>Java 　　　　无，Java8以后可以使用default</p><p>MPS　　　　有</p><p>因此我们只要实现一个接口，也能获得它的功能。</p><p><strong>实现了IMainClass的AST节点，在作根节点时，这颗AST就是可以运行的。</strong></p><p>编译一下。</p><h2>运行吧</h2><p>还记得上次说的添加JDK这个Dependency吗？我有一处疏忽，别忘了给Sandbox也加上JDK，这样它才能调用Java类库：<img src="https://pic4.zhimg.com/v2-c60f24756c77f4aa4a7a13209486d418_r.png" data-rawwidth="917" data-rawheight="345"></p><br><p>右键你刚Preview了Generated Text的PrintlnSet，可以看到，Run的按钮出现了！<img src="https://pic2.zhimg.com/v2-51d34a1e1ca66518defa0cf77305770d_r.png" data-rawwidth="642" data-rawheight="726"></p><br><p>点一下，然后就可以看到运行结果了！<img src="https://pic1.zhimg.com/v2-5814190b757aad9b3d162a6ed2a89e6d_r.png" data-rawwidth="732" data-rawheight="230"></p><br><p>好累呀，终于整出了可以运行的语言呀~</p><h2>这Generator里面的东西到底是啥</h2><p>前文说过，Generator实际上就是宏，它是<strong>代码模板</strong>，MPS根据你写的AST，对Generator里面的代码进行一次map。</p><p>当它map到一个有macro的节点时（也就是刚才我们整进去的美元符号和方括号一家亲的东西）， 会根据这个macro的要求，将你在Sandbox里面写的AST的信息填进去。</p><p>而原本写在美元符号+方括号一家亲里面的东西，就只是一个占位用的东西，多数情况下，多数内容都会被替换掉。</p><p>回顾一下刚才那个AST，我们对一个“语句”加上了一个循环的macro，也就是所它会对所有的循环内容进行遍历， 然后对里面的内容分别进行填充，每个循环内容产生一份这个东西，然后对里面的macro带入这个循环内容进行处理。</p><p>而我们对字符串加上的那个macro，就是将那个“循环内容”，也就是那个Println，把它的content填进去，原本的就没了。</p><p>比如我们这个例子，MPS对很多个“Println”进行循环，那所有的Println就会被遍历，每个Println对应一个这个语句， 然后它们的content就会被依次填入字符串。</p><p>也就有了你看到的“Generated Text”的样子。</p><h2>预告</h2><p>不用你说我都知道，这语法：</p><br><code lang="text">println set { 

  clauses : 
    println { 
      content : ****马赛克***马赛克***马赛克****

    } 
    println { 
      content : My name is Van, I'm an artist. 

    } 
    println { 
      content : I'm a performance artist. 

    } 
}
</code><p><strong>丑死了！！！！！！！！！！！！！！！！</strong></p><p>下期讲怎么改变它的语法。</p><p>不用担心重构代码的问题，由于存储在MPS里的是AST，因此，你改变了语法之后，原本的代码也会随着语法的改变而改变。</p><p>这得益于LOP的伟大。晚安。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
