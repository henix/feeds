<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>严谨解决5种机器学习算法在预测股价的应用（代码+数据）</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/56507515">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-ffcec8bbcf52a90de785e9607a00729c_b.jpg" alt=""></div><p></p><figure><noscript><img src="https://pic2.zhimg.com/v2-e96895b3f9d106aef40902f9660c108d_b.jpg" data-caption="" data-size="normal" data-rawwidth="1000" data-rawheight="400" class="origin_image zh-lightbox-thumb" width="1000" data-original="https://pic2.zhimg.com/v2-e96895b3f9d106aef40902f9660c108d_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-e96895b3f9d106aef40902f9660c108d_b.jpg" data-caption="" data-size="normal" data-rawwidth="1000" data-rawheight="400" class="origin_image zh-lightbox-thumb lazy" width="1000" data-original="https://pic2.zhimg.com/v2-e96895b3f9d106aef40902f9660c108d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-e96895b3f9d106aef40902f9660c108d_b.jpg"></figure><p>本期作者：Yibin Ng</p><p>译者：1+1=6</p><h2><b>前言</b></h2><p>机器学习有很多应用，其中之一就是预测时间序列。一个最有趣（或者可能是最赚钱）的时间序列是股票价格。</p><p>今天，我们用更严谨的学术态度来解决这个问题。例如：移动平均、线性回归、KNN、Auto ARIMA和Prophet的预测范围为1年，而LSTM的预测范围为1天。<b>在一些文章有人说LSTM比我们目前看到的任何算法都要出色</b>。但很明显，我们并不是comparing apples to apples here。</p><p>代码+数据如下（<b>文末下载</b>）：</p><figure><noscript><img src="https://pic1.zhimg.com/v2-8cd4d2ee64127beea4db3e0eb7180598_b.jpg" data-caption="" data-size="normal" data-rawwidth="396" data-rawheight="420" class="content_image" width="396"></noscript><img src="https://pic1.zhimg.com/v2-8cd4d2ee64127beea4db3e0eb7180598_b.jpg" data-caption="" data-size="normal" data-rawwidth="396" data-rawheight="420" class="content_image lazy" width="396" data-actualsrc="https://pic1.zhimg.com/v2-8cd4d2ee64127beea4db3e0eb7180598_b.jpg"></figure><h2><b>1、问题陈述</b></h2><p>我们的目标是使用前N天的数据（即预测范围= 1）预测Vanguard Total Stock Market ETF（VTI）的每日调整收盘价 。我们将使用VTI从2015年11月25日至2018年11月23日三年的历史价格。可以从雅虎财经下载（<i><a href="http://link.zhihu.com/?target=https%3A//finance.yahoo.com/quote/VTI/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">finance.yahoo.com/quote</span><span class="invisible">/VTI/</span><span class="ellipsis"></span></a></i>），数据集如下:</p><p><b>获取全部代码，见文末</b></p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">rcParams</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span>

<span class="c1">#### Input params ##################</span>
<span class="n">stk_path</span> <span class="o">=</span> <span class="s2">"./data/VTI.csv"</span>
<span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.2</span>                 <span class="c1"># proportion of dataset to be used as test set</span>
<span class="n">cv_size</span> <span class="o">=</span> <span class="mf">0.2</span>                   <span class="c1"># proportion of dataset to be used as cross-validation set</span>
<span class="n">Nmax</span> <span class="o">=</span> <span class="mi">2</span>                       <span class="c1"># for feature at day t, we use lags from t-1, t-2, ..., t-N as features</span>
                               <span class="c1"># Nmax is the maximum N we are going to test</span>
<span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">ticklabelsize</span> <span class="o">=</span> <span class="mi">14</span>
</code></pre></div><figure><noscript><img src="https://pic4.zhimg.com/v2-76471666d1c0c54d629d42ba9aabb867_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="601" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic4.zhimg.com/v2-76471666d1c0c54d629d42ba9aabb867_r.jpg"></noscript><img src="https://pic4.zhimg.com/v2-76471666d1c0c54d629d42ba9aabb867_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="601" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic4.zhimg.com/v2-76471666d1c0c54d629d42ba9aabb867_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-76471666d1c0c54d629d42ba9aabb867_b.jpg"></figure><p>将数据集分为60%训练集、20%验证集和20%测试集。使用训练集对模型进行训练，使用验证集对模型超参数进行调整，最后使用测试集对模型的性能进行测试。</p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span> 

<span class="n">ax</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'adj_close'</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">'b-'</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'adj_close'</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">'y-'</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'adj_close'</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">'g-'</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">'train'</span><span class="p">,</span> <span class="s1">'validation'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"date"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"USD"</span><span class="p">)</span>
</code></pre></div><figure><noscript><img src="https://pic2.zhimg.com/v2-abed46e6ce42da57d96cceafe0f643e1_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="810" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic2.zhimg.com/v2-abed46e6ce42da57d96cceafe0f643e1_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-abed46e6ce42da57d96cceafe0f643e1_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="810" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic2.zhimg.com/v2-abed46e6ce42da57d96cceafe0f643e1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-abed46e6ce42da57d96cceafe0f643e1_b.jpg"></figure><p>为了评估我们的方法的有效性，我们将使用均方根误差（RMSE）和平均绝对百分比误差（MAPE）进行度量。对于这两个指标，值越低，预测效果越好。</p><h2><b>2、Last Value</b></h2><p>在Last Value方法中，我们将简单地将预测设置为最后一个观测值。这意味着我们将当前的复权收盘价设置为前一天的复权收盘价。这是最具成本效益的预测模型，通常用作比较更复杂模型的基准。这里不需要调优超参数。</p><p>下图显示了使用Last Value方法的预测。如果你仔细观察，<b>你会发现每一天的预测（红叉）仅仅是前一天的值（绿叉）</b>。</p><figure><noscript><img src="https://pic1.zhimg.com/v2-482a4f7d0af0076c03d503b341826d04_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="820" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-482a4f7d0af0076c03d503b341826d04_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-482a4f7d0af0076c03d503b341826d04_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="820" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-482a4f7d0af0076c03d503b341826d04_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-482a4f7d0af0076c03d503b341826d04_b.jpg"></figure><h2><b>3、移动平均线</b></h2><p>在移动平均法中，预测值将是前N个值的平均值。这意味着我们将当前复权收盘价设置为前N天复权收盘价的平均值。需要调整超参数N。</p><p>下图展示了验证集上实际值和预测值之间的RMSE，对于不同的N值，我们将使用N=2，因为它给出了最低的RMSE。</p><figure><noscript><img src="https://pic1.zhimg.com/v2-7aa622fe3050cc8551f4a64eaf7fcf8c_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="715" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-7aa622fe3050cc8551f4a64eaf7fcf8c_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-7aa622fe3050cc8551f4a64eaf7fcf8c_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="715" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-7aa622fe3050cc8551f4a64eaf7fcf8c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-7aa622fe3050cc8551f4a64eaf7fcf8c_b.jpg"></figure><div class="highlight"><pre><code class="language-python"><span></span><span class="n">est_list</span> <span class="o">=</span> <span class="n">get_preds_mov_avg</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">'adj_close'</span><span class="p">,</span> <span class="n">N_opt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_train</span><span class="o">+</span><span class="n">num_cv</span><span class="p">)</span>
<span class="n">test</span><span class="p">[</span><span class="s1">'est'</span> <span class="o">+</span> <span class="s1">'_N'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_opt</span><span class="p">)]</span> <span class="o">=</span> <span class="n">est_list</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"RMSE = </span><span class="si">%0.3f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">est_list</span><span class="p">,</span> <span class="n">test</span><span class="p">[</span><span class="s1">'adj_close'</span><span class="p">])))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"MAPE = </span><span class="si">%0.3f%%</span><span class="s2">"</span> <span class="o">%</span> <span class="n">get_mape</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">'adj_close'</span><span class="p">],</span> <span class="n">est_list</span><span class="p">))</span>
<span class="n">test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">RMSE</span> <span class="o">=</span> <span class="mf">1.270</span>
<span class="n">MAPE</span> <span class="o">=</span> <span class="mf">0.640</span><span class="o">%</span>
</code></pre></div><p>下图显示了移动平均法的预测结果：</p><figure><noscript><img src="https://pic4.zhimg.com/v2-7e1cbe74f002bad7831def78d42a55b7_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="821" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic4.zhimg.com/v2-7e1cbe74f002bad7831def78d42a55b7_r.jpg"></noscript><img src="https://pic4.zhimg.com/v2-7e1cbe74f002bad7831def78d42a55b7_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="821" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic4.zhimg.com/v2-7e1cbe74f002bad7831def78d42a55b7_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-7e1cbe74f002bad7831def78d42a55b7_b.jpg"></figure><h2><b>4、线性回归</b></h2><p>线性回归是对一个因变量和一个或多个自变量之间的关系进行建模的一种线性方法。我们在这里使用线性回归的方法是将线性回归模型与之前的N个值进行拟合，并用这个模型预测当前的值。下图是N=5的一个例子。实际复权收盘价显示为深蓝色的十字，我们想要预测第6天的值（黄色方块）。我们将通过前5个实际值拟合一条线性回归线（浅蓝色线），并用它来做第6天的预测（浅蓝色圆）。</p><p><b>获取全部代码，见文末</b></p><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># Specify the day you are interested in</span>
<span class="n">day</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">))</span>

<span class="c1"># Specify the maximum N you want to plot (If Nmax2 is too large it gets very cluttered) </span>
<span class="n">Nmax2</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">df_temp</span> <span class="o">=</span> <span class="n">cv</span><span class="p">[</span><span class="n">cv</span><span class="p">[</span><span class="s1">'date'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">day</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nmax2</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">df_temp</span><span class="p">[</span><span class="o">-</span><span class="n">Nmax2</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="s1">'adj_close'</span><span class="p">],</span> <span class="s1">'bx-'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Nmax2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">df_temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="s1">'adj_close'</span><span class="p">],</span> <span class="s1">'ys-'</span><span class="p">)</span>
<span class="n">legend_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'adj_close'</span><span class="p">,</span> <span class="s1">'actual_value'</span><span class="p">]</span>

<span class="c1"># Plot the linear regression lines and the predictions</span>
<span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'r'</span><span class="p">,</span> <span class="s1">'g'</span><span class="p">,</span> <span class="s1">'k'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'m'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">,</span> <span class="s1">'0.75'</span><span class="p">]</span>
<span class="n">marker_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">,</span> <span class="s1">'x'</span><span class="p">]</span>
<span class="n">regr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># Create linear regression object</span>
<span class="k">for</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">Nmax2</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
   <span class="c1"># Plot the linear regression lines</span>
   <span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_temp</span><span class="p">[</span><span class="s1">'adj_close'</span><span class="p">][</span><span class="o">-</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span> <span class="c1"># e.g. [0 1 2 3 4]</span>
   <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_temp</span><span class="p">[</span><span class="s1">'adj_close'</span><span class="p">][</span><span class="o">-</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># e.g. [2944 3088 3226 3335 3436]</span>
   <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     
   <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
   <span class="n">regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>            <span class="c1"># Train the model</span>
   <span class="n">y_est</span> <span class="o">=</span> <span class="n">regr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>         <span class="c1"># Get linear regression line</span>
   <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Nmax2</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">N</span><span class="p">,</span><span class="n">Nmax2</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y_est</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_temp</span><span class="p">[</span><span class="s1">'est_N'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">color_list</span><span class="p">)],</span> 
            <span class="n">marker</span><span class="o">=</span><span class="n">marker_list</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">marker_list</span><span class="p">)])</span>
   <span class="n">legend_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'est_N'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">+</span><span class="s1">'_lr'</span><span class="p">)</span>
   
   <span class="c1"># Plot the predictions</span>
   <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Nmax2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">df_temp</span><span class="p">[</span><span class="s1">'est_N'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span> 
            <span class="n">color</span><span class="o">=</span><span class="n">color_list</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">color_list</span><span class="p">)],</span> 
            <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">)</span>
   <span class="n">legend_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'est_N'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
   
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'timestep'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'USD'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_list</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'font.size'</span><span class="p">:</span> <span class="n">fontsize</span><span class="p">})</span>
</code></pre></div><figure><noscript><img src="https://pic3.zhimg.com/v2-e9b78dd5633e6e537c5056a5bff587b2_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="680" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-e9b78dd5633e6e537c5056a5bff587b2_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-e9b78dd5633e6e537c5056a5bff587b2_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="680" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-e9b78dd5633e6e537c5056a5bff587b2_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-e9b78dd5633e6e537c5056a5bff587b2_b.jpg"></figure><p>下面是我们用训练模型和做预测的代码：</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="k">def</span> <span class="nf">get_preds_lin_reg</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">pred_min</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
   <span class="sd">"""</span>
<span class="sd">   Given a dataframe, get prediction at each timestep</span>
<span class="sd">   Inputs</span>
<span class="sd">       df         : dataframe with the values you want to predict     </span>
<span class="sd">       target_col : name of the column you want to predict</span>
<span class="sd">       N          : use previous N values to do prediction</span>
<span class="sd">       pred_min   : all predictions should be &gt;= pred_min</span>
<span class="sd">       offset     : for df we only do predictions for df[offset:]</span>
<span class="sd">   Outputs</span>
<span class="sd">       pred_list  : the predictions for target_col</span>
<span class="sd">   """</span>
   <span class="c1"># Create linear regression object</span>
   <span class="n">regr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
   <span class="n">pred_list</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'adj_close'</span><span class="p">])):</span>
       <span class="n">X_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'adj_close'</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="n">N</span><span class="p">:</span><span class="n">i</span><span class="p">])))</span> 
       <span class="n">y_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'adj_close'</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="n">N</span><span class="p">:</span><span class="n">i</span><span class="p">])</span> 
       <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>     
       <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
       <span class="n">regr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>            <span class="c1"># Train the model</span>
       <span class="n">pred</span> <span class="o">=</span> <span class="n">regr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
   
       <span class="n">pred_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>  
   
   <span class="c1"># If the values are &lt; pred_min, set it to be pred_min</span>
   <span class="n">pred_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred_list</span><span class="p">)</span>
   <span class="n">pred_list</span><span class="p">[</span><span class="n">pred_list</span> <span class="o">&lt;</span> <span class="n">pred_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_min</span>
       
   <span class="k">return</span> <span class="n">pred_list</span>
</code></pre></div><p>下图显示了验证集的实际值和预测值之间的RMSE，对于N的不同值，我们将使用N=5，因为它给出了最低的RMSE。</p><figure><noscript><img src="https://pic4.zhimg.com/v2-a94e4b006dcda7dd5dbd90b16b0b0763_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="716" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic4.zhimg.com/v2-a94e4b006dcda7dd5dbd90b16b0b0763_r.jpg"></noscript><img src="https://pic4.zhimg.com/v2-a94e4b006dcda7dd5dbd90b16b0b0763_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="716" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic4.zhimg.com/v2-a94e4b006dcda7dd5dbd90b16b0b0763_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-a94e4b006dcda7dd5dbd90b16b0b0763_b.jpg"></figure><p>下图显示了<b>线性回归方法</b>的预测结果。可以观察到，<b>该方法不能很好地捕获方向的变化（即下降到上升趋势，反之亦然）</b>。</p><figure><noscript><img src="https://pic1.zhimg.com/v2-babeaa64c946468b16d9c710495f5388_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="836" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-babeaa64c946468b16d9c710495f5388_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-babeaa64c946468b16d9c710495f5388_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="836" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-babeaa64c946468b16d9c710495f5388_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-babeaa64c946468b16d9c710495f5388_b.jpg"></figure><h2><b>5、XGBoost</b></h2><p>XGBoost是以迭代的方式将弱学习者转化为强学习者的过程。自2014年推出以来，XGBoost已被证明是一种非常强大的机器学习算法，通常是许多机器学习竞赛中的首选算法。</p><p>我们将在训练集中训练XGBoost模型，使用验证集优化其超参数，最后在测试集中应用XGBoost模型并报告结果。使用的显著特征是过去N天的复权收盘价，以及过去N天的成交量。除了这些特征，我们还可以做一些特征工程。我们将构建的其他功能包括：</p><ul><li>过去N天，最高价和最低价每天的差值</li><li>过去N天，开盘价和收盘价每天的差值</li></ul><p>在构建这个模型的过程中，学到了一个有趣的事情，那就是<b>特征缩放对于模型的正常工作是非常重要的</b>。我们的第一个模型根本没有实现任何伸缩，下面的图显示了对验证集的预测。模型训练的是89到125之间的复权收盘价，因此模型只能输出这个范围内的预测。当模型试图预测验证集并且它看到超出了这个范围时，它不能很好地拓展使用。</p><figure><noscript><img src="https://pic1.zhimg.com/v2-0ac846bf6b4c8f9d8baeac9e669c5edc_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="827" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-0ac846bf6b4c8f9d8baeac9e669c5edc_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-0ac846bf6b4c8f9d8baeac9e669c5edc_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="827" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-0ac846bf6b4c8f9d8baeac9e669c5edc_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-0ac846bf6b4c8f9d8baeac9e669c5edc_b.jpg"></figure><p>如果没有正确地进行特征缩放，预测是非常不准的</p><p>接下来尝试将训练集规模缩放为均值0和方差1，并且在验证集上应用了相同的变换。但显然这不会起作用，因为在这里我们使用从训练集计算的均值和方差来转换验证集。由于来自验证集的值远大于来自列车集的值，因此在缩放后，值仍将更大。结果是预测仍然如上所述，只是缩放了y轴上的值。</p><p>最后，将序列集合的均值缩放为0，方差为1，然后用这个来训练模型。随后，当对验证集进行预测时，对每个样本的每个特征组进行缩放，使其均值为0，方差为1。例如，如果我们对第T天进行预测，我将取最近N天（T-N到T-1）的复权收盘价，并将其缩放为均值为0，方差为1。成交量特征也是一样的，我取前N天的成交量，将其缩放为均值为0，方差为1。使用与其他特征相同的操作。<b>然后我们使用这些缩放的特征来做预测。预测值也会被缩放，我们用它们对应的均值和方差进行逆变换。发现这种扩展方式提供了最好的性能</b>，如下所示。</p><p>下面是我们用来训练模型和做预测的代码：</p><p><b>获取全部代码，见文末</b></p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>
<span class="k">def</span> <span class="nf">get_mape</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span> 
   <span class="sd">"""</span>
<span class="sd">   Compute mean absolute percentage error (MAPE)</span>
<span class="sd">   """</span>
   <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
   <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_true</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="k">def</span> <span class="nf">train_pred_eval_model</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> \
                         <span class="n">y_train_scaled</span><span class="p">,</span> \
                         <span class="n">X_test_scaled</span><span class="p">,</span> \
                         <span class="n">y_test</span><span class="p">,</span> \
                         <span class="n">col_mean</span><span class="p">,</span> \
                         <span class="n">col_std</span><span class="p">,</span> \
                         <span class="n">seed</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> \
                         <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> \
                         <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> \
                         <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> \
                         <span class="n">min_child_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> \
                         <span class="n">subsample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> \
                         <span class="n">colsample_bytree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> \
                         <span class="n">colsample_bylevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> \
                         <span class="n">gamma</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
   <span class="sd">'''</span>
<span class="sd">   Train model, do prediction, scale back to original range and do </span>
<span class="sd">   evaluation</span>
<span class="sd">   Use XGBoost here.</span>
<span class="sd">   Inputs</span>
<span class="sd">       X_train_scaled     : features for training. Scaled to have </span>
<span class="sd">                            mean 0 and variance 1</span>
<span class="sd">       y_train_scaled     : target for training. Scaled to have </span>
<span class="sd">                            mean 0 and variance 1</span>
<span class="sd">       X_test_scaled      : features for test. Each sample is </span>
<span class="sd">                            scaled to mean 0 and variance 1</span>
<span class="sd">       y_test             : target for test. Actual values, not </span>
<span class="sd">                            scaled</span>
<span class="sd">       col_mean           : means used to scale each sample of </span>
<span class="sd">                            X_test_scaled. Same length as </span>
<span class="sd">                            X_test_scaled and y_test</span>
<span class="sd">       col_std            : standard deviations used to scale each </span>
<span class="sd">                            sample of X_test_scaled. Same length as </span>
<span class="sd">                            X_test_scaled and y_test</span>
<span class="sd">       seed               : model seed</span>
<span class="sd">       n_estimators       : number of boosted trees to fit</span>
<span class="sd">       max_depth          : maximum tree depth for base learners</span>
<span class="sd">       learning_rate      : boosting learning rate (xgb’s “eta”)</span>
<span class="sd">       min_child_weight   : minimum sum of instance weight(hessian) </span>
<span class="sd">                            needed in a child</span>
<span class="sd">       subsample          : subsample ratio of the training </span>
<span class="sd">                            instance</span>
<span class="sd">       colsample_bytree   : subsample ratio of columns when </span>
<span class="sd">                            constructing each tree</span>
<span class="sd">       colsample_bylevel  : subsample ratio of columns for each </span>
<span class="sd">                            split, in each level</span>
<span class="sd">       gamma              : minimum loss reduction required to make </span>
<span class="sd">                            a further partition on a leaf node of </span>
<span class="sd">                            the tree</span>
<span class="sd">   Outputs</span>
<span class="sd">       rmse               : root mean square error of y_test and </span>
<span class="sd">                            est</span>
<span class="sd">       mape               : mean absolute percentage error of </span>
<span class="sd">                            y_test and est</span>
<span class="sd">       est                : predicted values. Same length as y_test</span>
<span class="sd">   '''</span>
   <span class="n">model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">model_seed</span><span class="p">,</span>
                        <span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span>
                        <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span>
                        <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
                        <span class="n">min_child_weight</span><span class="o">=</span><span class="n">min_child_weight</span><span class="p">,</span>
                        <span class="n">subsample</span><span class="o">=</span><span class="n">subsample</span><span class="p">,</span>
                        <span class="n">colsample_bytree</span><span class="o">=</span><span class="n">colsample_bytree</span><span class="p">,</span>
                        <span class="n">colsample_bylevel</span><span class="o">=</span><span class="n">colsample_bylevel</span><span class="p">,</span>
                        <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
   
   <span class="c1"># Train the model</span>
   <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_scaled</span><span class="p">)</span>
   
   <span class="c1"># Get predicted labels and scale back to original range</span>
   <span class="n">est_scaled</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
   <span class="n">est</span> <span class="o">=</span> <span class="n">est_scaled</span> <span class="o">*</span> <span class="n">col_std</span> <span class="o">+</span> <span class="n">col_mean</span>
   <span class="c1"># Calculate RMSE</span>
   <span class="n">rmse</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">est</span><span class="p">))</span>
   <span class="n">mape</span> <span class="o">=</span> <span class="n">get_mape</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">est</span><span class="p">)</span>
   
   <span class="k">return</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">mape</span><span class="p">,</span> <span class="n">est</span>
</code></pre></div><p>下图显示了验证集上实际值和预测值之间的RMSE，对于不同的N值，我们将使用N=3，因为它给出了最低的RMSE。</p><figure><noscript><img src="https://pic3.zhimg.com/v2-18b1c49b1bccad86e5145652b9f062be_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="1018" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-18b1c49b1bccad86e5145652b9f062be_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-18b1c49b1bccad86e5145652b9f062be_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="1018" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-18b1c49b1bccad86e5145652b9f062be_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-18b1c49b1bccad86e5145652b9f062be_b.jpg"></figure><p>优化前后的超参数和性能如下所示：</p><figure><noscript><img src="https://pic3.zhimg.com/v2-d28db10d605a581f6745802c859eced6_b.jpg" data-caption="" data-size="normal" data-rawwidth="1056" data-rawheight="1250" class="origin_image zh-lightbox-thumb" width="1056" data-original="https://pic3.zhimg.com/v2-d28db10d605a581f6745802c859eced6_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-d28db10d605a581f6745802c859eced6_b.jpg" data-caption="" data-size="normal" data-rawwidth="1056" data-rawheight="1250" class="origin_image zh-lightbox-thumb lazy" width="1056" data-original="https://pic3.zhimg.com/v2-d28db10d605a581f6745802c859eced6_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-d28db10d605a581f6745802c859eced6_b.jpg"></figure><p>下图显示了使用XGBoost方法的预测结果：</p><figure><noscript><img src="https://pic2.zhimg.com/v2-384f3a5592b83e2ef22d18eff0227555_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="828" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic2.zhimg.com/v2-384f3a5592b83e2ef22d18eff0227555_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-384f3a5592b83e2ef22d18eff0227555_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="828" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic2.zhimg.com/v2-384f3a5592b83e2ef22d18eff0227555_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-384f3a5592b83e2ef22d18eff0227555_b.jpg"></figure><h2><b>6、LSTM</b></h2><p>LSTM是一种深度学习模型，用于解决长序列中的梯度消失问题。LSTM有三个门：更新门、遗忘门和输出门。更新和忘记门决定是否更新单元的每个元素。输出门决定了作为下一层的激活而输出的信息量。</p><p>下面我们将使用LSTM结构。使用两层LSTM模块并在其间设置一个drop-layer以避免过度拟合。</p><figure><noscript><img src="https://pic1.zhimg.com/v2-fd274c62d9a0b4c9b87203d182d623d8_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="775" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-fd274c62d9a0b4c9b87203d182d623d8_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-fd274c62d9a0b4c9b87203d182d623d8_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="775" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-fd274c62d9a0b4c9b87203d182d623d8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-fd274c62d9a0b4c9b87203d182d623d8_b.jpg"></figure><p><b>训练N：</b></p><div class="highlight"><pre><code class="language-python"><span></span><span class="n">param_label</span> <span class="o">=</span> <span class="s1">'N'</span>
<span class="n">param_list</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

<span class="n">error_rate</span> <span class="o">=</span> <span class="p">{</span><span class="n">param_label</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'rmse'</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">'mape_pct'</span><span class="p">:</span> <span class="p">[]}</span>
<span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">tqdm_notebook</span><span class="p">(</span><span class="n">param_list</span><span class="p">):</span>
   
   <span class="c1"># Split train into x and y</span>
   <span class="n">x_train_scaled</span><span class="p">,</span> <span class="n">y_train_scaled</span> <span class="o">=</span> <span class="n">get_x_y</span><span class="p">(</span><span class="n">train_scaled</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>

   <span class="c1"># Split cv into x and y</span>
   <span class="n">x_cv_scaled</span><span class="p">,</span> <span class="n">y_cv_scaled</span> <span class="o">=</span> <span class="n">get_x_y</span><span class="p">(</span><span class="n">train_cv_scaled</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">num_train</span><span class="p">)</span>
   
   <span class="c1"># Train, predict and eval model</span>
   <span class="n">rmse</span><span class="p">,</span> <span class="n">mape</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">train_pred_eval_model</span><span class="p">(</span><span class="n">x_train_scaled</span><span class="p">,</span> \
                                         <span class="n">y_train_scaled</span><span class="p">,</span> \
                                         <span class="n">x_cv_scaled</span><span class="p">,</span> \
                                         <span class="n">y_cv_scaled</span><span class="p">,</span> \
                                         <span class="n">scaler</span><span class="p">,</span> \
                                         <span class="n">lstm_units</span><span class="o">=</span><span class="n">lstm_units</span><span class="p">,</span> \
                                         <span class="n">dropout_prob</span><span class="o">=</span><span class="n">dropout_prob</span><span class="p">,</span> \
                                         <span class="n">optimizer</span><span class="o">=</span><span class="s1">'adam'</span><span class="p">,</span> \
                                         <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> \
                                         <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
   
   <span class="c1"># Collect results</span>
   <span class="n">error_rate</span><span class="p">[</span><span class="n">param_label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
   <span class="n">error_rate</span><span class="p">[</span><span class="s1">'rmse'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
   <span class="n">error_rate</span><span class="p">[</span><span class="s1">'mape_pct'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mape</span><span class="p">)</span>
   
<span class="n">error_rate</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">error_rate</span><span class="p">)</span>
<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Minutes taken = "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">toc</span><span class="o">-</span><span class="n">tic</span><span class="p">)</span><span class="o">/</span><span class="mf">60.0</span><span class="p">))</span>
<span class="n">error_rate</span>   

<span class="n">Minutes</span> <span class="n">taken</span> <span class="o">=</span> <span class="mf">37.21444189945857</span>


<span class="c1"># Plot RMSE </span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span> <span class="c1"># width 10, height 8</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">error_rate</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'N'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'rmse'</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">'bx-'</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">error_rate</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'N'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'mape_pct'</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">'rx-'</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"N"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"RMSE/MAPE(%)"</span><span class="p">)</span>
</code></pre></div><figure><noscript><img src="https://pic3.zhimg.com/v2-00378d660d06deff18be5452137aa65a_b.jpg" data-caption="" data-size="normal" data-rawwidth="603" data-rawheight="483" class="origin_image zh-lightbox-thumb" width="603" data-original="https://pic3.zhimg.com/v2-00378d660d06deff18be5452137aa65a_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-00378d660d06deff18be5452137aa65a_b.jpg" data-caption="" data-size="normal" data-rawwidth="603" data-rawheight="483" class="origin_image zh-lightbox-thumb lazy" width="603" data-original="https://pic3.zhimg.com/v2-00378d660d06deff18be5452137aa65a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-00378d660d06deff18be5452137aa65a_b.jpg"></figure><p><b>训练模型——优化器</b></p><figure><noscript><img src="https://pic4.zhimg.com/v2-4b332489a54fa1f150e2093b2b7ee62f_b.jpg" data-caption="" data-size="normal" data-rawwidth="876" data-rawheight="1042" class="origin_image zh-lightbox-thumb" width="876" data-original="https://pic4.zhimg.com/v2-4b332489a54fa1f150e2093b2b7ee62f_r.jpg"></noscript><img src="https://pic4.zhimg.com/v2-4b332489a54fa1f150e2093b2b7ee62f_b.jpg" data-caption="" data-size="normal" data-rawwidth="876" data-rawheight="1042" class="origin_image zh-lightbox-thumb lazy" width="876" data-original="https://pic4.zhimg.com/v2-4b332489a54fa1f150e2093b2b7ee62f_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-4b332489a54fa1f150e2093b2b7ee62f_b.jpg"></figure><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># Plot RMSE </span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span> <span class="c1"># width 10, height 8</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">error_rate</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'optimizer'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'rmse'</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">'bx-'</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">error_rate</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'optimizer'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'mape_pct'</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">'rx-'</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Optimizer"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"RMSE/MAPE(%)"</span><span class="p">)</span>
<span class="n">Text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">'RMSE/MAPE(%)'</span><span class="p">)</span>
</code></pre></div><figure><noscript><img src="https://pic2.zhimg.com/v2-a7a1054ca9feb8fbbdd7772877881bb5_b.jpg" data-caption="" data-size="normal" data-rawwidth="609" data-rawheight="491" class="origin_image zh-lightbox-thumb" width="609" data-original="https://pic2.zhimg.com/v2-a7a1054ca9feb8fbbdd7772877881bb5_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-a7a1054ca9feb8fbbdd7772877881bb5_b.jpg" data-caption="" data-size="normal" data-rawwidth="609" data-rawheight="491" class="origin_image zh-lightbox-thumb lazy" width="609" data-original="https://pic2.zhimg.com/v2-a7a1054ca9feb8fbbdd7772877881bb5_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-a7a1054ca9feb8fbbdd7772877881bb5_b.jpg"></figure><div class="highlight"><pre><code class="language-python"><span></span><span class="c1"># Get optimum value for param and param2</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">error_rate</span><span class="p">[</span><span class="n">error_rate</span><span class="p">[</span><span class="s1">'rmse'</span><span class="p">]</span> <span class="o">==</span> <span class="n">error_rate</span><span class="p">[</span><span class="s1">'rmse'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()]</span>
<span class="n">optimizer_opt</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">param_label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"min RMSE = </span><span class="si">%0.3f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">error_rate</span><span class="p">[</span><span class="s1">'rmse'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"min MAPE = </span><span class="si">%0.3f%%</span><span class="s2">"</span> <span class="o">%</span> <span class="n">error_rate</span><span class="p">[</span><span class="s1">'mape_pct'</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"optimum "</span> <span class="o">+</span> <span class="n">param_label</span> <span class="o">+</span> <span class="s2">" = "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">optimizer_opt</span><span class="p">))</span>
<span class="nb">min</span> <span class="n">RMSE</span> <span class="o">=</span> <span class="mf">1.650</span>
<span class="nb">min</span> <span class="n">MAPE</span> <span class="o">=</span> <span class="mf">0.835</span><span class="o">%</span>
<span class="n">optimum</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">adam</span>
</code></pre></div><p>下面是我们用来训练模型和做预测的代码：<br>获取全部代码，见文末</p><div class="highlight"><pre><code class="language-python"><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">LSTM</span>
<span class="k">def</span> <span class="nf">train_pred_eval_model</span><span class="p">(</span><span class="n">x_train_scaled</span><span class="p">,</span> \
                         <span class="n">y_train_scaled</span><span class="p">,</span> \
                         <span class="n">x_test_scaled</span><span class="p">,</span> \
                         <span class="n">y_test</span><span class="p">,</span> \
                         <span class="n">mu_test_list</span><span class="p">,</span> \
                         <span class="n">std_test_list</span><span class="p">,</span> \
                         <span class="n">lstm_units</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> \
                         <span class="n">dropout_prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> \
                         <span class="n">optimizer</span><span class="o">=</span><span class="s1">'adam'</span><span class="p">,</span> \
                         <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> \
                         <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
   <span class="sd">'''</span>
<span class="sd">   Train model, do prediction, scale back to original range and do </span>
<span class="sd">   evaluation</span>
<span class="sd">   Use LSTM here.</span>
<span class="sd">   Returns rmse, mape and predicted values</span>
<span class="sd">   Inputs</span>
<span class="sd">       x_train_scaled  : e.g. x_train_scaled.shape=(451, 9, 1). </span>
<span class="sd">                         Here we are using the past 9 values to  </span>
<span class="sd">                         predict the next value</span>
<span class="sd">       y_train_scaled  : e.g. y_train_scaled.shape=(451, 1)</span>
<span class="sd">       x_test_scaled   : use this to do predictions </span>
<span class="sd">       y_test          : actual value of the predictions</span>
<span class="sd">       mu_test_list    : list of the means. Same length as </span>
<span class="sd">                         x_test_scaled and y_test</span>
<span class="sd">       std_test_list   : list of the std devs. Same length as </span>
<span class="sd">                         x_test_scaled and y_test</span>
<span class="sd">       lstm_units      : dimensionality of the output space</span>
<span class="sd">       dropout_prob    : fraction of the units to drop for the </span>
<span class="sd">                         linear transformation of the inputs</span>
<span class="sd">       optimizer       : optimizer for model.compile()</span>
<span class="sd">       epochs          : epochs for model.fit()</span>
<span class="sd">       batch_size      : batch size for model.fit()</span>
<span class="sd">   Outputs</span>
<span class="sd">       rmse            : root mean square error</span>
<span class="sd">       mape            : mean absolute percentage error</span>
<span class="sd">       est             : predictions</span>
<span class="sd">   '''</span>
   <span class="c1"># Create the LSTM network</span>
   <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
   <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">lstm_units</span><span class="p">,</span> 
                  <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                  <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">x_train_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span>
   <span class="c1"># Add dropput with a probability of 0.5</span>
   <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_prob</span><span class="p">))</span> 
   <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">lstm_units</span><span class="p">))</span>
   <span class="c1"># Add dropput with a probability of 0.5</span>
   <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_prob</span><span class="p">))</span> 
   <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
   <span class="c1"># Compile and fit the LSTM network</span>
   <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">'mean_squared_error'</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">)</span>
   <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train_scaled</span><span class="p">,</span> <span class="n">y_train_scaled</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>   
             <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
   
   <span class="c1"># Do prediction</span>
   <span class="n">est_scaled</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_test_scaled</span><span class="p">)</span>
   <span class="n">est</span> <span class="o">=</span> <span class="p">(</span><span class="n">est_scaled</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">std_test_list</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> 
         <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mu_test_list</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
   
   <span class="c1"># Calculate RMSE and MAPE</span>
   <span class="n">rmse</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">est</span><span class="p">))</span>
   <span class="n">mape</span> <span class="o">=</span> <span class="n">get_mape</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">est</span><span class="p">)</span>
   
   <span class="k">return</span> <span class="n">rmse</span><span class="p">,</span> <span class="n">mape</span><span class="p">,</span> <span class="n">est</span>
</code></pre></div><p>我们将使用与XGBoost中相同的方法来缩放数据集。验证集调优前后LSTM网络的超参数和性能如下所示：</p><figure><noscript><img src="https://pic1.zhimg.com/v2-5cfd38acab900b5020177b6572e0e1f4_b.jpg" data-caption="" data-size="normal" data-rawwidth="926" data-rawheight="1008" class="origin_image zh-lightbox-thumb" width="926" data-original="https://pic1.zhimg.com/v2-5cfd38acab900b5020177b6572e0e1f4_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-5cfd38acab900b5020177b6572e0e1f4_b.jpg" data-caption="" data-size="normal" data-rawwidth="926" data-rawheight="1008" class="origin_image zh-lightbox-thumb lazy" width="926" data-original="https://pic1.zhimg.com/v2-5cfd38acab900b5020177b6572e0e1f4_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-5cfd38acab900b5020177b6572e0e1f4_b.jpg"></figure><p>下图显示了使用LSTM的预测：</p><figure><noscript><img src="https://pic3.zhimg.com/v2-9d715ef4df3dba7191fcd71b4d2232ee_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="835" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-9d715ef4df3dba7191fcd71b4d2232ee_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-9d715ef4df3dba7191fcd71b4d2232ee_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="835" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-9d715ef4df3dba7191fcd71b4d2232ee_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-9d715ef4df3dba7191fcd71b4d2232ee_b.jpg"></figure><h2><b>研究结果及改进</b></h2><p>下面，我们在同一张图绘制上面使用的所有方法。很明显，使用线性方法的预测最差。除此之外，从视觉上很难判断哪种方法提供了最好的预测。</p><figure><noscript><img src="https://pic3.zhimg.com/v2-abd3ab05ee6f6adfa7092c06c46af23a_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="787" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-abd3ab05ee6f6adfa7092c06c46af23a_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-abd3ab05ee6f6adfa7092c06c46af23a_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="787" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-abd3ab05ee6f6adfa7092c06c46af23a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-abd3ab05ee6f6adfa7092c06c46af23a_b.jpg"></figure><p>下面是我们所探讨的各种方法的RMSE和MAPE的并列比较。我们看到last value给出了最低的RMSE和MAPE，然后是XGBoost，然后是LSTM。有趣的是，<b>简单的last value方法优于所有其他更复杂的方法，但这很可能是因为我们的预测范围只有1。对于较长的预测范围，我们认为其他方法比last value更能捕捉趋势和季节性。</b></p><figure><noscript><img src="https://pic2.zhimg.com/v2-645c34adeda747d6ac3de49763a3e785_b.jpg" data-caption="" data-size="normal" data-rawwidth="956" data-rawheight="670" class="origin_image zh-lightbox-thumb" width="956" data-original="https://pic2.zhimg.com/v2-645c34adeda747d6ac3de49763a3e785_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-645c34adeda747d6ac3de49763a3e785_b.jpg" data-caption="" data-size="normal" data-rawwidth="956" data-rawheight="670" class="origin_image zh-lightbox-thumb lazy" width="956" data-original="https://pic2.zhimg.com/v2-645c34adeda747d6ac3de49763a3e785_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-645c34adeda747d6ac3de49763a3e785_b.jpg"></figure><p><br></p><h2><b>如何获取代码</b></h2><a href="http://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Q82YzANWDMkKWm5k2XmPkA" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-b1f9e2d11730a3f683270bca835f7bad_180x120.jpg" data-image-width="1280" data-image-height="544" class=" wrap external" target="_blank" rel="nofollow noreferrer">严谨解决5种机器学习算法在预测股价的应用（代码+数据）</a><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
</body>
</html>
