<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>使用BloodHound查找Active Directory攻击路径</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/121552304">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-e7678fe72fba342cad680ca460ab7a3b_b.jpg" alt=""></div><p>作为内部渗透测试或红队评估期间的攻击者或分析人员，会经常遇到这类问题，比如说“如何才能使用这个刚刚被入侵的帐户？”，“如何从这台受感染的计算机上快速转移到特权较高的帐户？”，作为防御者，可以考虑“谁可以访问这些有价值的目标？” 或“该外部承包商可以获得什么特权？”这些问题，从而在Active Directory环境中查找和修补攻击路径，而仅仅通过查看Active Directory用户和计算机控制台，GPO等，无法轻松解决这些问题，而BloodHound就可以做到。</p><h2>从BloodHound可以获得的5条有用信息</h2><h3>1.本地管理员</h3><p>(u:User) - [:AdminTo] -&gt; (c:Computer)</p><p>攻击者可以借助计算机上的本地管理员权限，可以读取磁盘和内存中的所有数据，包括其他用户的潜在证书。在浏览用户时，只需使用“ First Degree Local Admin”和“Group Delegated Local Admin Rights”功能，就可以知道用户在哪台计算机上进行管理：</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-db8e6bc978ad0e2219e5647a6b58f7af_b.jpg" data-caption="" data-size="normal" data-rawwidth="1024" data-rawheight="636" class="origin_image zh-lightbox-thumb" width="1024" data-original="https://pic4.zhimg.com/v2-db8e6bc978ad0e2219e5647a6b58f7af_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-db8e6bc978ad0e2219e5647a6b58f7af_b.jpg" data-caption="" data-size="normal" data-rawwidth="1024" data-rawheight="636" class="origin_image zh-lightbox-thumb lazy" width="1024" data-original="https://pic4.zhimg.com/v2-db8e6bc978ad0e2219e5647a6b58f7af_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-db8e6bc978ad0e2219e5647a6b58f7af_b.jpg"/></figure><p> 如果想知道哪个用户在给定计算机上具有管理权限，可以执行反向操作。这些功能叫做“Explicit Admins”和“Unrolled Admins”：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-3f172de0ce8e3bc900ffb10bd77983dd_b.jpg" data-caption="" data-size="normal" data-rawwidth="1024" data-rawheight="634" class="origin_image zh-lightbox-thumb" width="1024" data-original="https://pic2.zhimg.com/v2-3f172de0ce8e3bc900ffb10bd77983dd_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-3f172de0ce8e3bc900ffb10bd77983dd_b.jpg" data-caption="" data-size="normal" data-rawwidth="1024" data-rawheight="634" class="origin_image zh-lightbox-thumb lazy" width="1024" data-original="https://pic2.zhimg.com/v2-3f172de0ce8e3bc900ffb10bd77983dd_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-3f172de0ce8e3bc900ffb10bd77983dd_b.jpg"/></figure><h3>2.会议</h3><p>(u:User) - [:HasSession] -&gt; (c:Computer)</p><p>攻击者的目标是尽快获得特权访问，但是有时很难确定哪个机器值得尝试以获取特权用户的证书。Bloodhound允许列出用户的当前会话，例如可以了解Domain Administrators是否已连接到工作站：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-1735033ebd1539895ce27969f472b7b0_b.jpg" data-caption="" data-size="normal" data-rawwidth="942" data-rawheight="312" class="origin_image zh-lightbox-thumb" width="942" data-original="https://pic1.zhimg.com/v2-1735033ebd1539895ce27969f472b7b0_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-1735033ebd1539895ce27969f472b7b0_b.jpg" data-caption="" data-size="normal" data-rawwidth="942" data-rawheight="312" class="origin_image zh-lightbox-thumb lazy" width="942" data-original="https://pic1.zhimg.com/v2-1735033ebd1539895ce27969f472b7b0_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-1735033ebd1539895ce27969f472b7b0_b.jpg"/></figure><p>所以可以了解哪些用户在给定计算机上进行了会话：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-4add7ee3ee3647536f7c682b35b4d614_b.jpg" data-caption="" data-size="normal" data-rawwidth="998" data-rawheight="315" class="origin_image zh-lightbox-thumb" width="998" data-original="https://pic1.zhimg.com/v2-4add7ee3ee3647536f7c682b35b4d614_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-4add7ee3ee3647536f7c682b35b4d614_b.jpg" data-caption="" data-size="normal" data-rawwidth="998" data-rawheight="315" class="origin_image zh-lightbox-thumb lazy" width="998" data-original="https://pic1.zhimg.com/v2-4add7ee3ee3647536f7c682b35b4d614_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-4add7ee3ee3647536f7c682b35b4d614_b.jpg"/></figure><h3>3. ACL</h3><p>(u:User) - [:GenericAll] -&gt; (g:Group)</p><p>可以通过ACL获得更多特权。服务端用户通常可以重置用户密码，管理员通常可以完全控制许多其他AD对象。BloodHound允许跟踪以下ACL：</p><ul><li>ForceChangePassword,</li><li>AddMembers,</li><li>GenericAll,</li><li>GenericWrite,</li><li>WriteOwner,</li><li>WriteDACL,</li><li>AllExtendedRights,</li><li>Owns,</li><li>ReadLAPSPassword</li></ul><p>查询示例以显示用户之间的所有直接ACL：</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-31bb76b7d430b70e3e23afdda1bb327a_b.jpg" data-caption="" data-size="normal" data-rawwidth="544" data-rawheight="384" class="origin_image zh-lightbox-thumb" width="544" data-original="https://pic3.zhimg.com/v2-31bb76b7d430b70e3e23afdda1bb327a_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-31bb76b7d430b70e3e23afdda1bb327a_b.jpg" data-caption="" data-size="normal" data-rawwidth="544" data-rawheight="384" class="origin_image zh-lightbox-thumb lazy" width="544" data-original="https://pic3.zhimg.com/v2-31bb76b7d430b70e3e23afdda1bb327a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-31bb76b7d430b70e3e23afdda1bb327a_b.jpg"/></figure><h3>4.不受限制的委托</h3><p>(c:Computer {UnconstrainedDelegation:true})</p><p>攻击者可能会滥用允许无限制委派的计算机来假冒该域中的几乎所有用户。因此，它们非常敏感，需要识别。</p><p>以下自定义查询（源）列出了所有允许不受限制的委派unconstrained delegation：</p><p>MATCH (dc:Computer)-[:MemberOf*1..]-&gt;(g:Group) WHERE g.objectsid ENDS WITH &#34;516&#34; WITH COLLECT(dc) as domainControllers MATCH p = (d:Domain)-[:Contains*1..]-&gt;(c:Computer {unconstraineddelegation:true}) WHERE NOT c in domainControllers RETURN p</p><h3>5.Domain Admins的最短路径</h3><p>MATCH (n:User), (m:Group {name: &#34;DOMAIN ADMINS@DOMAIN.LOCAL&#34;}), p=shortestPath((n)-[*1..]-&gt;(m)) RETURN p</p><p>通过结合以上信息，您可以在AD环境中找到短的路径，该查询将显示您通过组成员身份，管理，会话，ACL等从用户到Domain Admins组的路径。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-d90bc614ddf5e0269066cbc6de07c2a4_b.jpg" data-caption="" data-size="normal" data-rawwidth="1024" data-rawheight="488" class="origin_image zh-lightbox-thumb" width="1024" data-original="https://pic1.zhimg.com/v2-d90bc614ddf5e0269066cbc6de07c2a4_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-d90bc614ddf5e0269066cbc6de07c2a4_b.jpg" data-caption="" data-size="normal" data-rawwidth="1024" data-rawheight="488" class="origin_image zh-lightbox-thumb lazy" width="1024" data-original="https://pic1.zhimg.com/v2-d90bc614ddf5e0269066cbc6de07c2a4_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-d90bc614ddf5e0269066cbc6de07c2a4_b.jpg"/></figure><h2>结论</h2><p>BloodHound提供了易于使用的图形界面，以可视化方式显示Active Directory中其他复杂的关系。它为攻击者和防御者提供了有关其环境的新的方式。这里介绍了一些基本查询，但是当我们使用Cypher查询语言时，可以自定义查询。</p><p>下载地址：<a href="https://link.zhihu.com/?target=https%3A//github.com/BloodHoundAD/BloodHound/releases/tag/3.0.3" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/BloodHoundAD</span><span class="invisible">/BloodHound/releases/tag/3.0.3</span><span class="ellipsis"></span></a></p><p>今天的内容就分享到这里,希望对你有所帮助最近。<a href="https://link.zhihu.com/?target=https%3A//www.baidu.com/link%3Furl%3DOcGTJIGtwpNYrGru7tSszpEf10ZQ0xIE7SvER9ejNcCar00KI-fG2lu214M4WKPc%26wd%3D%26eqid%3Da24dabb2002f492b000000065e13d46a" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a>推出了<b>漏洞挖掘实战班</b>，小白入门到挖洞大佬，从扫码上车开始。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-47fd8b123045a74e4854a2b1e8c545c9_b.jpg" data-caption="" data-size="normal" data-rawwidth="720" data-rawheight="405" class="origin_image zh-lightbox-thumb" width="720" data-original="https://pic2.zhimg.com/v2-47fd8b123045a74e4854a2b1e8c545c9_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-47fd8b123045a74e4854a2b1e8c545c9_b.jpg" data-caption="" data-size="normal" data-rawwidth="720" data-rawheight="405" class="origin_image zh-lightbox-thumb lazy" width="720" data-original="https://pic2.zhimg.com/v2-47fd8b123045a74e4854a2b1e8c545c9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-47fd8b123045a74e4854a2b1e8c545c9_b.jpg"/></figure><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
