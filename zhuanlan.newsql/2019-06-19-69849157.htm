<div class="title-image"><img src="https://pic3.zhimg.com/v2-c57c79c148273959defa990675b8eea9_b.jpg" alt=""></div><p>作者：lan</p><p>本文为 DM 源码阅读系列文章的第八篇，<a href="https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/dm-source-code-reading-7/" class=" wrap external" target="_blank" rel="nofollow noreferrer">上篇文章</a> 对 DM 中的定制化数据同步功能进行详细的讲解，包括库表路由（Table routing）、黑白名单（Black &amp; white table lists）、列值转化（Column mapping）、binlog 过滤（Binlog event filter）四个主要功能的实现。</p><p>本篇文章将会以 gh-ost 为例，详细地介绍 DM 是如何支持一些 MySQL 上的第三方 online schema change 方案同步，内容包括 online schema change 方案的简单介绍，online schema change 同步方案，以及同步实现细节。</p><h2>MySQL 的 Online Schema Change 方案</h2><p>目前有一些第三方工具支持在 MySQL 上面进行 Online Schema Change，比较主流的包括 <a href="https://link.zhihu.com/?target=https%3A//www.percona.com/doc/percona-toolkit/LATEST/pt-online-schema-change.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">pt-online-schema-change</a> 和 <a href="https://link.zhihu.com/?target=https%3A//github.com/github/gh-ost" class=" wrap external" target="_blank" rel="nofollow noreferrer">gh-ost</a>。</p><p>这些工具的实现原理比较类似，本文会以 gh-ost 为例来进行分析讲解。</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-bf6622c323dacdadcb395afdf12a1463_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="420" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic4.zhimg.com/v2-bf6622c323dacdadcb395afdf12a1463_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-bf6622c323dacdadcb395afdf12a1463_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="420" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic4.zhimg.com/v2-bf6622c323dacdadcb395afdf12a1463_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-bf6622c323dacdadcb395afdf12a1463_b.jpg"/></figure><p>从上图可以大致了解到 gh-ost 的逻辑处理流程：</p><ol><li>在操作目标数据库上使用 <code>create table ghost table like origin table</code> 来创建 ghost 表；</li><li>按照需求变更表结构，比如 <code>add column/index</code>；</li><li>gh-ost 自身变为 MySQL replica slave，将原表的全量数据和 binlog 增量变更数据同步到 ghost 表；</li><li>数据同步完成之后执行 <code>rename origin table to table_del, table_gho to origin table</code> 完成 ghost 表和原始表的切换</li></ol><p>pt-online-schema-change 通过 trigger 的方式来实现数据同步，剩余流程类似。</p><p>在 DM 的 task 配置中可以通过设置 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/dm/config/task.go%23L244" class=" wrap external" target="_blank" rel="nofollow noreferrer">online-ddl-scheme</a></code> 来配置的 online schema change 方案，目前仅支持 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/dm/config/task.go%23L32" class=" wrap external" target="_blank" rel="nofollow noreferrer">gh-ost/pt</a> 两个配置选项。</p><h2>DM Online Schema Change 同步方案</h2><p>根据上个章节介绍的流程，pt 和 gh-ost 除了 replicate 数据的方式不一样之外，其他流程都类似，并且这种 native 的模式可以使得 binlog replication 几乎不需要修改就可以同步数据。但是 DM 为了减少同步的数据量，简化一些场景（如 shard tables merge）下的处理流程，并做了额外的优化，即，不同步 ghost 表的数据。</p><p>继续分析 online schema change 的流程，从数据同步的角度看有下面这些需要关注的点：</p><ul><li>原始表的增量数据同步模式有没有变化</li><li>ghost 表会产生跟原始表几乎一样的冗余 binlog events</li><li>通过  <code>rename origin table to table_del, table_gho to origin table</code> 完成 ghost 表和原始表的切换</li></ul><p>如果使用 ghost 表的 <code>alter DDL</code> 替换掉  <code>rename origin table to table_del, table_gho to origin table</code> ，那么就可以实现我们的不同步 ghost 表数据的目的。</p><h2>DM Online Schema Change 同步实现细节</h2><p>Online schema change 模块代码实现如下：</p><ul><li><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/ghost.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">gh-ost 同步代码实现</a></li><li><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/pt_osc.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">pt-online-schema-change 同步代码实现</a></li></ul><p>DM 将 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/online_ddl.go%23L62" class=" wrap external" target="_blank" rel="nofollow noreferrer">同步的表分为三类</a>：</p><ul><li>real table - 原始表</li><li>trash table - online schema change 过程中产生的非关键数据表，比如以 <code>_ghc</code>, <code>_del</code> 为后缀的表</li><li>ghost table - 与原始表对应的经过 DDL 变更的数据表，比如以 <code>_gho</code> 为后缀的表</li></ul><p>当 DM 遇到 DDL 的时候，都会 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/ddl.go%23L210" class=" wrap external" target="_blank" rel="nofollow noreferrer">调用 online schema change 模块的代码进行处理</a>，首先判断表的类型，接着针对不同类型作出不同的处理：</p><ul><li>real table - <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/ghost.go%23L55" class=" wrap external" target="_blank" rel="nofollow noreferrer">对 rename table statement 进行模式检查，直接返回执行</a></li><li>trash table - <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/ghost.go%23L70" class=" wrap external" target="_blank" rel="nofollow noreferrer">对 rename table statement 做一些模式检查，直接忽略同步</a></li><li>ghost table</li><ul><li>如果 DDL 是 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/ghost.go%23L86" class=" wrap external" target="_blank" rel="nofollow noreferrer">create/drop table statement</a> ，则 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/ghost.go%23L87" class=" wrap external" target="_blank" rel="nofollow noreferrer">清空内存中的残余信息后忽略这个 DDL 继续同步</a></li><li>如果 DDL 是 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/ghost.go%23L96" class=" wrap external" target="_blank" rel="nofollow noreferrer">rename table statement</a> ，则 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/ghost.go%23L103" class=" wrap external" target="_blank" rel="nofollow noreferrer">返回内存中保存的 ghost table 的 DDLs</a></li><li>如果是其他类型 DDL，<a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/syncer/ghost.go%23L119" class=" wrap external" target="_blank" rel="nofollow noreferrer">则把这些 DDL 保存在内存中</a></li></ul></ul><p>下面是一个执行示例，方便大家对照着来理解上面的代码逻辑：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-28d5afa0816aadb045ecc52ce5f1fc7d_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="427" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic2.zhimg.com/v2-28d5afa0816aadb045ecc52ce5f1fc7d_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-28d5afa0816aadb045ecc52ce5f1fc7d_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="427" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic2.zhimg.com/v2-28d5afa0816aadb045ecc52ce5f1fc7d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-28d5afa0816aadb045ecc52ce5f1fc7d_b.jpg"/></figure><ol><li>Section 1： 使用 create table like statement 创建 ghost table，DM 会清空内存中 <code>online_ddl</code>.<code>_t2_gho</code> 对应的 DDL 信息</li><li>Section 2： 执行 alter table statement，DM 会保存 DDL 到内存中</li><li>Section 3：trash table 的 DDLs 会被忽略</li><li>Section 4：遇到 ghost table 的 rename table statement 会替换成 Section 2 的 DDL, 并且将该 DDL 的 table name 更换成对应 real table name 去执行</li></ol><p>注意： rename table statement 模式检查主要是为了确保在 online schema change 变更过程中除了  <code>rename origin table to table_del, table_gho to origin table</code> 之外没有其他 rename table statement，避免同步状态的复杂化。</p><h2>小结</h2><p>本篇文章详细地介绍 DM 对 online schema change 方案的同步支持，内容包含 online schema change 方案的简单介绍， online schema change 同步方案，以及同步实现细节。下一章会对 DM 的 shard DDL merge 方案进行详细的讲解，敬请期待。</p><p><b>原文阅读：</b></p><a href="https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/dm-source-code-reading-8/" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg" data-image-width="1200" data-image-height="1200" class=" wrap external" target="_blank" rel="nofollow noreferrer">DM 源码阅读系列文章（八）Online Schema Change 同步支持</a><p></p>