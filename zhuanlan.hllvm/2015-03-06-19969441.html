<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Hack Tech Talk 2015/03/05</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/19969441">原文</a></p>
今晚去<a href="https://www.facebook.com/" data-editable="true" data-title="Facebook">Facebook</a>的<a href="https://www.google.com/maps/place/1+Hacker+Way,+Menlo+Park,+CA+94025/@37.4838448,-122.1489573,19z/" data-editable="true" data-title="Menlo Park主园区">Menlo Park主园区</a>听了个<a href="http://facebooktechtalkhack.splashthat.com/" data-editable="true" data-title="关于Hack Type System的tech talk">关于Hack Type System的tech talk</a>。挺有趣的，稍微写点啥发出来吧。新鲜滚热辣 &gt;_&lt;<p>第一次去，进到Facebook园区觉得里面就像一个小型城市一样。有点回到了阿里西厂园区的感觉——只是占地面积更大的感觉。</p><p>本文不关心Zend PHP、HHVM、Hack之间的爱恨恩怨。那些话题留给language zealot们慢慢咬。</p><p>内容慢慢更新嗯。</p><h2><b>Hack项目与Hack类型系统</b></h2><p>今晚的活动由manager（Damien Sereni）开场，然后由Josh Watzman主讲。演讲有录像，日后会放出。等出来之后我会把链接更新过来。</p><p>更新（2015-03-27）：录像总算放出来了：<a href="https://www.youtube.com/watch?v=aN22-V-b8RM" data-editable="true" data-title="youtube.com 的页面" class="">Heresy! Combining type systems with PHP</a>（请自备梯子）</p><p>演讲内容主要是：</p><ul><li>Hack项目概要、与PHP的关系<br></li><li>Hack的类型系统的功能和当前实现的局限</li><li>Hack的类型检查器（type checker）的实现细节</li></ul><p>首先Hack项目是什么。</p><p>官网：<a href="http://hacklang.org/" data-editable="true" data-title="hacklang.org 的页面">http://hacklang.org/</a></p><p>GitHub代码仓库：<a href="https://github.com/facebook/hhvm/tree/master/hphp/hack" data-editable="true" data-title="hhvm/hphp/hack at master · facebook/hhvm · GitHub" class="">https://github.com/facebook/hhvm/tree/master/hphp/hack</a></p><p>Hack项目包括：</p><ul><li>一门编程语言语言：Hack Programming Language。</li><li>一个类型系统，及其对应的类型检查器</li><li>与HHVM衔接的前端编译器</li></ul><p>Hack编程语言是<a href="http://php.net/" data-editable="true" data-title="PHP">PHP</a>的方言，在PHP 5的基础上添加了一套类型系统和与其配套的类型标注语法，另外还添加了一套集合库和一些方便的语言特性，例如比PHP的闭包更简洁的lambda语法、async语法之类。最重要的是它仍然可以完全兼容原本的PHP 5，所以可以从现有的PHP代码平滑过渡到使用越来越多的Hack特性。当前的facebook.com就跑在Hack上——当然，既然原本的PHP也可以算作Hack，那⋯ &gt;_&lt;</p><p>Hack非常非常强调“实用主义”（pragmatism），不玩纯学术，不做高大全。一切皆为Facebook的具体使用环境而设计。Facebook已经有非常大量的PHP，完全替换掉它们迁移到一种新语言不现实而且也没必要。PHP的开发效率确实还不错，（只要知道它的坑在哪里之后别掉坑里）开发－调试－发布循环可以很块。但程序的错误一定要到调试运行时才有机会看到也时普遍让开发者头疼的问题。</p><br><p>Hack语言的设计目的主要是为了相对PHP提高开发效率，而并非提高运行效率——后者还是交给HHVM自己解决。Hack给PHP添加了类型标注主要也是为了给开发者提供友善、有用但不碍事的类型检查提示信息，把程序里潜在的类型错误报告出来，让开发者能尽早发现和修复bug，而不必等到运行时。因此Hack的类型系统不是为了赶时髦，而是尽可能的适应原本PHP的语义，让原本PHP就存在的类型变得更明显、更容易检查。就这个意义上说，Hack与PHP的关系跟TypeScript与JavaScript（<a href="http://www.ecma-international.org/ecma-262/5.1/" data-editable="true" data-title="ECMAScript 5" class="">ECMAScript 5</a> / <a href="https://people.mozilla.org/~jorendorff/es6-draft.html" data-editable="true" data-title="6">6</a>）的关系相似。</p><p>Hack的类型系统使用了渐进式类型系统（gradual typing）的设计，也就是说类型系统能接受从完全没写类型标注到完全标注好的程序。它从<a href="https://github.com/edwinsmith" data-editable="true" data-title="Edwin Smith" class="">Edwin Smith</a>得到了大量影响。Edwin以前在<a href="http://www.adobe.com/" data-editable="true" data-title="Adobe">Adobe</a>的<a href="https://github.com/adobe-research/ActionScript4" data-editable="true" data-title="ActionScript 4" class="">ActionScript 4</a>的主要成员之一；Hack的gradual typing受ActionScript 4的影响非常深。之前我以为<a href="http://en.wikipedia.org/wiki/Erik_Meijer_(computer_scientist)" data-title="Erik Meijer" class="" data-editable="true">Erik Meijer</a>在Hack的设计上有更大的影响，但去参加这个活动都没怎么听大家提起梅姐，略失落。</p><p>当下有不少较新的语言都采用了gradual typing设计，例如<a href="https://www.dartlang.org/" data-title="Dart" class="" data-editable="true">Dart</a>、<a href="http://www.typescriptlang.org/" data-editable="true" data-title="TypeScript">TypeScript</a>、<a href="http://perl6.org/" data-editable="true" data-title="Perl 6">Perl 6</a>等。</p><p>关于ActionScript 4的gradual typing设计，可以参考这篇论文：<a href="http://www.cs.umd.edu/~avik/projects/iogti/paper.pdf" data-editable="true" data-title="The Ins and Outs of Gradual Type Inference" class="">The Ins and Outs of Gradual Type Inference</a>。论文和实验虽然都是在ActionScript 3上做的，但其实它是为ActionScript 4做的铺垫。 </p><p>关于gradual typing的更多资料，可以参考这里：<a href="https://github.com/samth/gradual-typing-bib" data-editable="true" data-title="samth/gradual-typing-bib · GitHub" class="">samth/gradual-typing-bib · GitHub</a>，还有<a href="http://siek.blogspot.com/2012/10/is-typescript-gradually-typed-part-1.html" data-editable="true" data-title="这个">这个</a>。</p><p>除了gradual typing外，Hack的类型系统还包含别的当下流行的特性：</p><ul><li><a href="http://docs.hhvm.com/manual/en/hack.generics.php" data-editable="true" data-title="泛型（generics）">泛型（generics）</a>。支持协变/逆变（covariance / contravariance）。支持<a href="http://docs.hhvm.com/manual/en/hack.generics.constraints.php" data-editable="true" data-title="类型约束（type constraints）">类型约束（type constraints）</a>。</li><li><a href="http://docs.hhvm.com/manual/en/hack.nullable.php" data-editable="true" data-title="可空类型（nullable types）" class="">可空类型（nullable types）</a>。Hack里的类型默认不可空（不可以为null），要允许null的话必须显式声明为可空类型。</li><li><a href="http://docs.hhvm.com/manual/en/hack.collections.php" data-editable="true" data-title="集合类型（collections）">集合类型（collections）</a>。为了更明确表明意图，也便于类型检查，Hack把<a href="http://php.net/manual/en/language.types.array.php" data-editable="true" data-title="PHP的数组">PHP的数组</a>用法细分为若干集合类型，例如<a href="http://docs.hhvm.com/manual/en/hack.collections.vector.php" data-title="Vector&lt;Tv&gt;" class="" data-editable="true">Vector&lt;Tv&gt;</a>、<a href="http://docs.hhvm.com/manual/en/hack.collections.set.php" data-editable="true" data-title="Set&lt;Tv&gt;">Set&lt;Tv&gt;</a>、<a href="http://docs.hhvm.com/manual/en/hack.collections.map.php" data-editable="true" data-title="Map&lt;Tk, Tv&gt;">Map&lt;Tk, Tv&gt;</a>、<a href="http://docs.hhvm.com/manual/en/hack.collections.pair.php" data-editable="true" data-title="Pair&lt;Tv1, Tv2&gt;">Pair&lt;Tv1, Tv2&gt;</a>。</li></ul><br><p>目前能运行Hack编程语言的主要就是<a href="http://hhvm.com/" data-editable="true" data-title="HHVM">HHVM</a>。虽然也有<a href="http://hhvm.com/blog/6863/announcing-the-hack-transpiler" data-editable="true" data-title="Hack Transpiler" class="">Hack Transpiler</a>可以把Hack转换为PHP以便在普通PHP环境里运行（就像TypeScript编译为JavaScript那样），但始终不咋受关注。</p><p>Hack的实际代码分为两部分：<a href="https://github.com/facebook/hhvm/tree/master/hphp/hack" data-editable="true" data-title="类型检查器">类型检查器</a>与<a href="https://github.com/facebook/hhvm/blob/master/hphp/parser/hphp.y#L2900" data-editable="true" data-title="HHVM的前端">HHVM的前端</a>。类型检查器的任务是分析Hack源码，做类型检查并报告错误。它并不做任何代码生成；而HHVM一侧，在原本的PHP语言的前端编译器之外另外专门写了一个Hack语言的前端，将Hack语言编译为<a href="https://github.com/facebook/hhvm/blob/master/hphp/doc/bytecode.specification" data-editable="true" data-title="HHBC（HipHop Bytecode）">HHBC（HipHop Bytecode）</a>然后交给HHVM的后端去执行。</p><p>历史原因使得这两部分没有任何交互而且存在大量重复代码。Josh表示<a href="http://hhvm.com/blog/8405/coming-soon-in-hhvm" data-editable="true" data-title="今年内有望把类型检查器改造得与HHVM更紧密的整合起来" class="">今年内有望把类型检查器改造得与HHVM更紧密的整合起来</a>，让它成能够直接生成HHBC，届时就不必维护两个有大量重复代码的项目了。但要让HHVM有效使用Hack的类型标注的好处，必须略为改造HHBC让它能记录更多类型信息才行。<br></p><p>Hack类型检查器和HHVM的JIT编译器都要做类型检查，但两者的出发点和取舍还是有所不同。前者的目标是“prove the negative”，找出肯定有类型错误的地方，并相应报错；后者是“prove the positive”，找出某个变量在某处肯定是某个特定类型而不是其它类型的情况，并相应优化。这使得Hack类型检查器报告的类型信息比HHVM的JIT编译器做优化所需的类型信息弱，因而也不能直接用于优化。</p><br><p>这次演讲的主角就是Hack的类型检查器。它大部分用<a href="https://ocaml.org/" data-editable="true" data-title="OCaml" class="">OCaml</a>实现，并有少量C代码实现些特殊功能。</p><p>Hack类型检查器主要由<a href="https://github.com/pikatchu" data-editable="true" data-title="Julien Verlaguet" class="">Julien Verlaguet</a>和<a href="https://github.com/jwatzman" data-editable="true" data-title="Josh Watzman" class="">Josh Watzman</a>实现。Julien来自法国<a href="http://www.upmc.fr/en/" data-editable="true" data-title="Paris VI University">Paris VI University</a>，所以很自然的选择了用OCaml。</p><p>Hack官网上有个<a href="http://hacklang.org/tutorial/" class="" data-editable="true" data-title="hacklang.org 的页面">Tutorial</a>，里面可以直接在页面上对用户输入的Hack代码做类型检查。这是通过把OCaml编写的类型检查器编译成JavaScript来在浏览器里运行的。<br></p><p>类型检查器的工作流程分为5个步骤（phase）。每个步骤都只依赖之前的步骤计算所得数据而不需要同步骤内别的部分的计算数据，便于并行化，以便应对Facebook庞大的PHP/Hack代码量。</p><p>这5个步骤是：</p><ul><li><a href="https://github.com/facebook/hhvm/blob/7127f2b0d6104d6040f08a80a308b407ee6ac043/hphp/hack/src/parsing/parsing_service.ml#L87" data-editable="true" data-title="Parsing">Parsing</a>：将Hack源码解析为<a href="https://github.com/facebook/hhvm/blob/master/hphp/hack/src/parsing/ast.ml" data-title="AST" class="" data-editable="true">AST</a></li><li><a href="https://github.com/facebook/hhvm/blob/7127f2b0d6104d6040f08a80a308b407ee6ac043/hphp/hack/src/naming/naming.ml#L700" data-editable="true" data-title="Global Environment">Global Environment</a>：扫描AST，把所有类和函数声明记录到一个全局符号表</li><li><a href="https://github.com/facebook/hhvm/blob/7127f2b0d6104d6040f08a80a308b407ee6ac043/hphp/hack/src/typing/typing_decl.ml#L344-L346" data-title="Naming" class="" data-editable="true">Naming</a>：</li><li><a href="https://github.com/facebook/hhvm/blob/7127f2b0d6104d6040f08a80a308b407ee6ac043/hphp/hack/src/typing/typing_decl.ml#L894" data-editable="true" data-title="Declaration">Declaration</a>：</li><li><a href="https://github.com/facebook/hhvm/blob/7127f2b0d6104d6040f08a80a308b407ee6ac043/hphp/hack/src/typing/typing_check_service.ml#L40" data-editable="true" data-title="Typing">Typing</a>：真正去做类型检查，以函数为单位。</li></ul><br><p>这个流程的大入口（之一）可以在这里找到：<a href="https://github.com/facebook/hhvm/blob/7127f2b0d6104d6040f08a80a308b407ee6ac043/hphp/hack/src/server/serverTypeCheck.ml#L193" data-editable="true" data-title="hhvm/serverTypeCheck.ml at 7127f2b0d6104d6040f08a80a308b407ee6ac043 · facebook/hhvm · GitHub" class="">type_check</a></p><p>Josh很热心的回答了我的问题，把5个步骤在代码中的入口位置都指出来了：<a href="http://pastebin.com/6rVfpY3f" class="">http://pastebin.com/6rVfpY3f</a></p><p>实际代码的结构并不直接反映出上述的5个步骤。Josh解释说<a href="https://twitter.com/jvwatzman/status/574030103501389824" data-title="“The actual code is pretty messy and poorly factored.”" class="" data-editable="true">“The actual code is pretty messy and poorly factored.”</a></p><p>（未完待续）</p><br><br><h2><b>TypeScript, AtScript与Flow</b></h2><p>TypeScript: <a href="http://www.typescriptlang.org/" data-editable="true" data-title="Welcome to TypeScript" class="">Welcome to TypeScript</a></p><p>AtScript: <a href="https://docs.google.com/document/d/11YUzC-1d0V1-Q3V0fQ7KSit97HnZoKVygDxpWzEYW0U/edit" class="" data-editable="true" data-title="google.com 的页面">AtScript Primer</a></p><p>Flow: <a href="http://flowtype.org/" data-editable="true" data-title="Flow: A Static Type Checker for JavaScript" class="">Flow: A Static Typechecker for JavaScript</a></p><p>Damien Sereni提到在Facebook，用JavaScript写前端的开发工程师跟用PHP写数据部分的开发工程师的风格不太一样。这使得他们对工具的需求也不同。所以Flow虽然跟Hack是同一个团队开发的，但设计却非常不一样。</p><p>Facebook尝试过用TypeScript，但发现TypeScript无法满足他们的需要，然后才觉得自己开发Flow。TypeScript的类型检查边界是函数级别的，函数的参数和返回值类型都要声明才能有效的做类型检查；而Flow的类型检查边界是文件级别的——只要在文件层面上声明类型即可。</p><p>Flow同样用OCaml实现，然后也有少量C。它与Hack类型检查器有一些共享代码。</p><p>Flow团队有跟微软的TypeScript团队和Google的AtScript团队协调，让这三种JavaScript方言可以尽可能兼容。Flow能够<a href="https://github.com/facebook/flow/tree/master/src/dts" data-editable="true" data-title="直接读取和使用TypeScript的.d.ts Definition File" class="">直接读取和使用TypeScript的.d.ts Definition File</a>。</p><br><h2><b>八卦部分</b></h2><p>聊天的时候听说了各种以前没咋关心的八卦。其实有些想想似乎更早之前也听说过，然后就忘记了。</p><p>一个是Hack语言的名字的八卦。这门语言的名字似乎是公认的糟糕，Josh的说法是“跟Go共为最糟糕命名” &gt;_&lt;<br></p><p>一个是HHVM的开发团队的八卦。HHVM Open Source、Hack、Flow这几个项目都是同一个manager——前面提到的Damien Sereni——带的。而HHVM内部开发团队在Facebook叫做“HHVM JIT team”。</p><p>这“HHVM JIT team”与“HHVM Open Source team”的关系是：前者是原本的HHVM团队，继续肩负着开发HHVM核心的任务；后者主要是为了支持外部的HHVM用户，修补外部用户遇到的bug、从PHP移植外部用户需要（但Facebook自己没用到）的扩展，例如MongoDB扩展啥的。两个团队是在同一份代码上工作，但任务和受众不同。</p><p>HHVM Open Source team主要服务的对象是像百度、Etsy之类的HHVM外部客户。Facebook能养着一个组专门服务外部客户真好⋯</p><p>一个是<a href="http://www.playstation.com/en-us/explore/ps4/" data-editable="true" data-title="PS4">PS4</a>的<a href="https://www.freebsdnews.com/2013/06/24/freebsd-based-orbis-os-powering-sony-ps4/" data-title="Orbit OS是基于FreeBSD裁剪和定制的" class="" data-editable="true">Orbit OS是基于FreeBSD裁剪和定制的</a>。内核裁剪和写死了一些东西，例如semaphore的数量有个写死的上限之类的；然后新写了些驱动程序。然后PS4的主菜单界面程序VShell，整个是用C#写的，基于<a href="http://www.mono-project.com/" data-editable="true" data-title="Mono">Mono</a>运行在PS4上。这个Mono实例只用于运行VShell，而不用于运行任何其它东西（例如游戏）。Sony最近还试着给Mono提交了写patch来修PS4平台上遇到的问题。</p><p>看到<a href="https://github.com/dotnet/coreclr/" data-editable="true" data-title="CoreCLR">CoreCLR</a>开源他们似乎也很激动⋯咳咳。搞不好以后PS4上就流淌着微软代码的血液了（扭头看向XBox One⋯</p><p>一个是<a href="http://www.windriver.com/" data-editable="true" data-title="Wind River">Wind River</a>重启了GCC小组，重新开始大搞编译器。真好。被Intel大财主收购之后的Wind River仍然有自由做自己的项目，只是Intel点名要做的项目无法忽略了而已。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
