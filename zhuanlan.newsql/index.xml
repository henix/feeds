<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:media="http://search.yahoo.com/mrss/">
<channel>
<title>TiDB çš„åèŠ±å›­</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/</link>
<description></description>
<language>zh-cn</language>
<lastBuildDate>Tue, 30 Jul 2019 18:03:14 +0800</lastBuildDate>
<item>
<title>TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆåä¸€ï¼‰Storage - äº‹åŠ¡æ§åˆ¶å±‚</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-29-75708576.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/75708576&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-1d12480f0214931303d33ba3ad7a94f2_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;ä½œè€…ï¼šå¼ é‡‘é¹&lt;/p&gt;&lt;h2&gt;èƒŒæ™¯çŸ¥è¯†&lt;/h2&gt;&lt;p&gt;TiKV æ˜¯ä¸€ä¸ªå¼ºä¸€è‡´çš„æ”¯æŒäº‹åŠ¡çš„åˆ†å¸ƒå¼ KV å­˜å‚¨ã€‚TiKV é€šè¿‡ raft æ¥ä¿è¯å¤šå‰¯æœ¬ä¹‹é—´çš„å¼ºä¸€è‡´ï¼Œäº‹åŠ¡è¿™å— TiKV å‚è€ƒäº† Google çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//ai.google/research/pubs/pub36726&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Percolator äº‹åŠ¡æ¨¡å‹&lt;/a&gt;ï¼Œå¹¶è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ã€‚&lt;/p&gt;&lt;p&gt;å½“ TiKV çš„ Service å±‚æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œä¼šæ ¹æ®è¯·æ±‚çš„ç±»å‹æŠŠè¿™äº›è¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„æ¨¡å—è¿›è¡Œå¤„ç†ã€‚å¯¹äºä» TiDB ä¸‹æ¨çš„è¯»è¯·æ±‚ï¼Œæ¯”å¦‚ sumï¼Œavg æ“ä½œï¼Œä¼šè½¬å‘åˆ° Coprocessor æ¨¡å—è¿›è¡Œå¤„ç†ï¼Œå¯¹äº KV è¯·æ±‚ä¼šç›´æ¥è½¬å‘åˆ° Storage è¿›è¡Œå¤„ç†ã€‚&lt;/p&gt;&lt;p&gt;KV æ“ä½œæ ¹æ®åŠŸèƒ½å¯ä»¥è¢«åˆ’åˆ†ä¸º Raw KV æ“ä½œä»¥åŠ Txn KV æ“ä½œä¸¤å¤§ç±»ã€‚Raw KV æ“ä½œåŒ…æ‹¬ raw putã€raw getã€raw deleteã€raw batch getã€raw batch putã€raw batch deleteã€raw scan ç­‰æ™®é€š KV æ“ä½œã€‚ Txn KV æ“ä½œæ˜¯ä¸ºäº†å®ç°äº‹åŠ¡æœºåˆ¶è€Œè®¾è®¡çš„ä¸€ç³»åˆ—æ“ä½œï¼Œå¦‚ prewrite å’Œ commit åˆ†åˆ«å¯¹åº”äº 2PC ä¸­çš„ prepare å’Œ commit é˜¶æ®µçš„æ“ä½œã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;æœ¬æ–‡å°†ä¸ºå¤§å®¶ä»‹ç» TiKV æºç ä¸­çš„ Storage æ¨¡å—ï¼Œå®ƒä½äº Service ä¸åº•å±‚ KV å­˜å‚¨å¼•æ“ä¹‹é—´ï¼Œä¸»è¦è´Ÿè´£äº‹åŠ¡çš„å¹¶å‘æ§åˆ¶ã€‚TiKV ç«¯äº‹åŠ¡ç›¸å…³çš„å®ç°éƒ½åœ¨ Storage æ¨¡å—ä¸­ã€‚&lt;/b&gt;&lt;/p&gt;&lt;h2&gt;æºç è§£æ&lt;/h2&gt;&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä» Engineã€Latchesã€Scheduler å’Œ MVCC ç­‰å‡ ä¸ªæ–¹é¢æ¥è®²è§£ Storage ç›¸å…³çš„æºç ã€‚&lt;/p&gt;&lt;h3&gt;1. Engine trait&lt;/h3&gt;&lt;p&gt;TiKV æŠŠåº•å±‚ KV å­˜å‚¨å¼•æ“æŠ½è±¡æˆä¸€ä¸ª Engine traitï¼ˆtrait ç±»ä¼¼å…¶ä»–è¯­è¨€çš„ interfaceï¼‰ï¼Œå®šä¹‰è§ &lt;code&gt;storage/kv/mod.rs&lt;/code&gt;ã€‚Engint trait ä¸»è¦æä¾›äº†è¯»å’Œå†™ä¸¤ä¸ªæ¥å£ï¼Œåˆ†åˆ«ä¸º &lt;code&gt;async_snapshot&lt;/code&gt; å’Œ &lt;code&gt;async_write&lt;/code&gt;ã€‚è°ƒç”¨è€…æŠŠè¦å†™çš„å†…å®¹äº¤ç»™ &lt;code&gt;async_write&lt;/code&gt;ï¼Œ&lt;code&gt;async_write&lt;/code&gt; é€šè¿‡å›è°ƒçš„æ–¹å¼å‘Šè¯‰è°ƒç”¨è€…å†™æ“ä½œæˆåŠŸå®Œæˆäº†æˆ–è€…é‡åˆ°é”™è¯¯äº†ã€‚åŒæ ·çš„ï¼Œ&lt;code&gt;async_snapshot&lt;/code&gt;é€šè¿‡å›è°ƒçš„æ–¹å¼æŠŠæ•°æ®åº“çš„å¿«ç…§è¿”å›ç»™è°ƒç”¨è€…ï¼Œä¾›è°ƒç”¨è€…è¯»ï¼Œæˆ–è€…æŠŠé‡åˆ°çš„é”™è¯¯è¿”å›ç»™è°ƒç”¨è€…ã€‚&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;pub trait Engine: Send + Clone + &amp;#39;static {
    type Snap: Snapshot;
    fn async_write(&amp;amp;self, ctx: &amp;amp;Contect, batch: Vec&amp;lt;Modify&amp;gt;, callback: Callback&amp;lt;()&amp;gt;) -&amp;gt; Result&amp;lt;()&amp;gt;;
    fn async_snapshot(&amp;amp;self, ctx: &amp;amp;Context, callback: Callback&amp;lt;Self::Snap&amp;gt;) -&amp;gt; Result&amp;lt;()&amp;gt;;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åªè¦å®ç°äº†ä»¥ä¸Šä¸¤ä¸ªæ¥å£ï¼Œéƒ½å¯ä»¥ä½œä¸º TiKV çš„åº•å±‚ KV å­˜å‚¨å¼•æ“ã€‚åœ¨ 3.0 ç‰ˆæœ¬ä¸­ï¼ŒTiKV æ”¯æŒäº†ä¸‰ç§ä¸åŒçš„ KV å­˜å‚¨å¼•æ“ï¼ŒåŒ…æ‹¬å•æœº RocksDB å¼•æ“ã€å†…å­˜ B æ ‘å¼•æ“å’Œ RaftKV å¼•æ“ï¼Œåˆ†åˆ«ä½äº &lt;code&gt;storage/kv&lt;/code&gt; æ–‡ä»¶å¤¹ä¸‹é¢çš„ &lt;code&gt;rocksdb_engine.rs&lt;/code&gt;ã€&lt;code&gt;btree_engine.rs&lt;/code&gt; å’Œ &lt;code&gt;raftkv.rs&lt;/code&gt;ã€‚å…¶ä¸­å•æœº RocksDB å¼•æ“å’Œå†…å­˜çº¢é»‘æ ‘å¼•æ“ä¸»è¦ç”¨äºå•å…ƒæµ‹è¯•å’Œåˆ†å±‚ benchmarkï¼ŒTiKV çœŸæ­£ä½¿ç”¨çš„æ˜¯ RaftKV å¼•æ“ã€‚å½“è°ƒç”¨ RaftKV çš„ &lt;code&gt;async_write&lt;/code&gt; è¿›è¡Œå†™å…¥æ“ä½œæ—¶ï¼Œå¦‚æœ &lt;code&gt;async_write&lt;/code&gt; é€šè¿‡å›è°ƒæ–¹å¼æˆåŠŸè¿”å›äº†ï¼Œè¯´æ˜å†™å…¥æ“ä½œå·²ç»é€šè¿‡ raft å¤åˆ¶ç»™äº†å¤§å¤šæ•°å‰¯æœ¬ï¼Œå¹¶ä¸”åœ¨ leader èŠ‚ç‚¹ï¼ˆè°ƒç”¨è€…æ‰€åœ¨ TiKVï¼‰å®Œæˆå†™å…¥äº†ï¼Œåç»­ leader èŠ‚ç‚¹ä¸Šçš„è¯»å°±èƒ½å¤Ÿçœ‹åˆ°ä¹‹å‰å†™å…¥çš„å†…å®¹ã€‚&lt;/p&gt;&lt;h3&gt;2. Raw KV æ‰§è¡Œæµç¨‹&lt;/h3&gt;&lt;p&gt;Raw KV ç³»åˆ—æ¥å£æ˜¯ç»•è¿‡äº‹åŠ¡ç›´æ¥æ“çºµåº•å±‚æ•°æ®çš„æ¥å£ï¼Œæ²¡æœ‰äº‹åŠ¡æ§åˆ¶ï¼Œæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥åœ¨ä»‹ç»æ›´å¤æ‚çš„äº‹åŠ¡ KV çš„æ‰§è¡Œæµç¨‹å‰ï¼Œæˆ‘ä»¬å…ˆä»‹ç» Raw KV çš„æ‰§è¡Œæµç¨‹ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Raw put&lt;/b&gt;&lt;/p&gt;&lt;p&gt;raw put æ“ä½œä¸éœ€è¦ Storage æ¨¡å—åšé¢å¤–çš„å·¥ä½œï¼Œç›´æ¥æŠŠè¦å†™çš„å†…å®¹é€šè¿‡ engine çš„ &lt;code&gt;async_write&lt;/code&gt; æ¥å£å‘é€ç»™åº•å±‚çš„ KV å­˜å‚¨å¼•æ“å°±å¥½äº†ã€‚è°ƒç”¨å †æ ˆä¸º &lt;code&gt;service/kv.rs: raw_put&lt;/code&gt; -&amp;gt; &lt;code&gt;storage/mod.rs: async_raw_put&lt;/code&gt;ã€‚&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;impl&amp;lt;E: Engine&amp;gt; Storage&amp;lt;E&amp;gt; {
    pub fn async_raw_put(
        &amp;amp;self,
        ctx: Context,
        cf: String,
        key: Vec&amp;lt;u8&amp;gt;,
        value: Vec&amp;lt;u8&amp;gt;,
        callback: Callback&amp;lt;()&amp;gt;,
    ) -&amp;gt; Result&amp;lt;()&amp;gt; {
        // Omit some limit checks about key and value here...
        self.engine.async_write(
            &amp;amp;ctx,
            vec![Modify::Put(
                Self::rawkv_cf(&amp;amp;cf),
                Key::from_encoded(key),
                value,
            )],
            Box::new(|(_, res)| callback(res.map_err(Error::from))),
        )?;
        Ok(())
    }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;b&gt;Raw get&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åŒæ ·çš„ï¼Œraw get åªéœ€è¦è°ƒç”¨ engine çš„ &lt;code&gt;async_snapshot&lt;/code&gt; æ‹¿åˆ°æ•°æ®åº“å¿«ç…§ï¼Œç„¶åç›´æ¥è¯»å–å°±å¯ä»¥äº†ã€‚å½“ç„¶å¯¹äº RaftKV å¼•æ“ï¼Œ&lt;code&gt;async_snapshot&lt;/code&gt; åœ¨è¿”å›æ•°æ®åº“å¿«ç…§ä¹‹å‰ä¼šåšä¸€äº›æ£€æŸ¥å·¥ä½œï¼Œæ¯”å¦‚ä¼šæ£€æŸ¥å½“å‰è®¿é—®çš„å‰¯æœ¬æ˜¯å¦æ˜¯ leaderï¼ˆ3.0.0 ç‰ˆæœ¬åªæ”¯æŒä» leader è¿›è¡Œè¯»æ“ä½œï¼Œfollower read ç›®å‰ä»ç„¶åœ¨å¼€å‘ä¸­ï¼‰ï¼Œå¦å¤–ä¹Ÿä¼šæ£€æŸ¥è¯·æ±‚ä¸­æºå¸¦çš„ region ç‰ˆæœ¬ä¿¡æ¯æ˜¯å¦è¶³å¤Ÿæ–°ã€‚&lt;/p&gt;&lt;h3&gt;3. Latches&lt;/h3&gt;&lt;p&gt;åœ¨äº‹åŠ¡æ¨¡å¼ä¸‹ï¼Œä¸ºäº†é˜²æ­¢å¤šä¸ªè¯·æ±‚åŒæ—¶å¯¹åŒä¸€ä¸ª key è¿›è¡Œå†™æ“ä½œï¼Œè¯·æ±‚åœ¨å†™è¿™ä¸ª key ä¹‹å‰å¿…é¡»å…ˆè·å–è¿™ä¸ª key çš„å†…å­˜é”ã€‚ä¸ºäº†å’Œäº‹åŠ¡ä¸­çš„é”è¿›è¡ŒåŒºåˆ†ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªå†…å­˜é”ä¸º latchï¼Œå¯¹åº”çš„æ˜¯ &lt;code&gt;storage/txn/latch.rs&lt;/code&gt; æ–‡ä»¶ä¸­çš„ Latch ç»“æ„ä½“ã€‚æ¯ä¸ª Latch å†…éƒ¨åŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œæ²¡æœ‰æ‹¿åˆ° latch çš„è¯·æ±‚æŒ‰å…ˆåé¡ºåºæ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œé˜Ÿé¦–çš„è¯·æ±‚è¢«è®¤ä¸ºæ‹¿åˆ°äº†è¯¥ latchã€‚&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;#[derive(Clone)]
struct Latch {
    pub waiting: VecDeque&amp;lt;u64&amp;gt;,
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Latches æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ª Latch çš„ç»“æ„ä½“ï¼Œå†…éƒ¨åŒ…å«ä¸€ä¸ªå›ºå®šé•¿åº¦çš„ Vectorï¼ŒVector çš„æ¯ä¸ª slot å¯¹åº”ä¸€ä¸ª Latchã€‚é»˜è®¤é…ç½®ä¸‹ Latches å†…éƒ¨ Vector çš„é•¿åº¦ä¸º 2048000ã€‚æ¯ä¸ª TiKV æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª Latches å®ä¾‹ï¼Œä½äº &lt;code&gt;Storage.Scheduler&lt;/code&gt; ä¸­ã€‚&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;pub struct Latches {
    slots: Vec&amp;lt;Mutex&amp;lt;Latch&amp;gt;&amp;gt;,
    size: usize,
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Latches çš„ &lt;code&gt;gen_lock&lt;/code&gt; æ¥å£ç”¨äºè®¡ç®—å†™å…¥è¯·æ±‚æ‰§è¡Œå‰æ‰€éœ€è¦è·å–çš„æ‰€æœ‰ latchã€‚&lt;code&gt;gen_lock&lt;/code&gt; é€šè¿‡è®¡ç®—æ‰€æœ‰ key çš„ hashï¼Œç„¶åç”¨è¿™äº› hash å¯¹ Vector çš„é•¿åº¦è¿›è¡Œå–æ¨¡å¾—åˆ°å¤šä¸ª slotsï¼Œå¯¹è¿™äº› slots ç»è¿‡æ’åºå»é‡å¾—åˆ°è¯¥å‘½ä»¤éœ€è¦çš„æ‰€æœ‰ latchã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­çš„æ’åºæ˜¯ä¸ºäº†ä¿è¯è·å– latch çš„é¡ºåºæ€§é˜²æ­¢å‡ºç°æ­»é”æƒ…å†µã€‚&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;impl Latches {
    pub fn gen_lock&amp;lt;H: Hash&amp;gt;(&amp;amp;self, keys: &amp;amp;[H]) -&amp;gt; Lock {
        // prevent from deadlock, so we sort and deduplicate the index.
        let mut slots: Vec&amp;lt;usize&amp;gt; = keys.iter().map(|x|
        self.calc_slot(x)).collect();
        slots.sort();
        slots.dedup();
        Lock::new(slots)
    }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3&gt;4. Storage å’Œäº‹åŠ¡è°ƒåº¦å™¨ Scheduler&lt;/h3&gt;&lt;p&gt;&lt;b&gt;Storage&lt;/b&gt;&lt;/p&gt;&lt;p&gt;Storage å®šä¹‰åœ¨ &lt;code&gt;storage/mod.rs&lt;/code&gt; æ–‡ä»¶ä¸­ï¼Œä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸‹ Storage å‡ ä¸ªé‡è¦çš„æˆå‘˜ï¼š&lt;/p&gt;&lt;p&gt;&lt;code&gt;engine&lt;/code&gt;ï¼šä»£è¡¨çš„æ˜¯åº•å±‚çš„ KV å­˜å‚¨å¼•æ“ã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;sched&lt;/code&gt;ï¼šäº‹åŠ¡è°ƒåº¦å™¨ï¼Œè´Ÿè´£å¹¶å‘äº‹åŠ¡è¯·æ±‚çš„è°ƒåº¦å·¥ä½œã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;read_pool&lt;/code&gt;ï¼šè¯»å–çº¿ç¨‹æ± ï¼Œæ‰€æœ‰åªè¯» KV è¯·æ±‚ï¼ŒåŒ…æ‹¬äº‹åŠ¡çš„éäº‹åŠ¡çš„ï¼Œå¦‚ raw getã€txn kv get ç­‰æœ€ç»ˆéƒ½ä¼šåœ¨è¿™ä¸ªçº¿ç¨‹æ± å†…æ‰§è¡Œã€‚ç”±äºåªè¯»è¯·æ±‚ä¸éœ€è¦è·å– latchesï¼Œæ‰€ä»¥ä¸ºå…¶åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ± ç›´æ¥æ‰§è¡Œï¼Œè€Œä¸æ˜¯ä¸éåªè¯»äº‹åŠ¡å…±ç”¨äº‹åŠ¡è°ƒåº¦å™¨ã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;gc_worker&lt;/code&gt;ï¼šä» 3.0 ç‰ˆæœ¬å¼€å§‹ï¼ŒTiKV æ”¯æŒåˆ†å¸ƒå¼ GCï¼Œæ¯ä¸ª TiKV æœ‰ä¸€ä¸ª &lt;code&gt;gc_worker&lt;/code&gt; çº¿ç¨‹è´Ÿè´£å®šæœŸä» PD æ›´æ–° safepointï¼Œç„¶åè¿›è¡Œ GC å·¥ä½œã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;pessimistic_txn_enabled&lt;/code&gt;ï¼š å¦å¤– 3.0 ç‰ˆæœ¬ä¹Ÿæ”¯æŒæ‚²è§‚äº‹åŠ¡ï¼Œ&lt;code&gt;pessimistic_txn_enabled&lt;/code&gt; ä¸º true è¡¨ç¤º TiKV ä»¥æ”¯æŒæ‚²è§‚äº‹åŠ¡çš„æ¨¡å¼å¯åŠ¨ï¼Œå…³äºæ‚²è§‚äº‹åŠ¡åç»­ä¼šæœ‰ä¸€ç¯‡æºç é˜…è¯»æ–‡ç« ä¸“é—¨ä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆè·³è¿‡ã€‚&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;pub struct Storage&amp;lt;E: Engine&amp;gt; {
    engine: E,
    sched: Scheduler&amp;lt;E&amp;gt;,
    read_pool: ReadPool,
    gc_worker: GCWorker&amp;lt;E&amp;gt;,
    pessimistic_txn_enabled: bool,
    // Other fields...
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯¹äºåªè¯»è¯·æ±‚ï¼ŒåŒ…æ‹¬ txn get å’Œ txn scanï¼ŒStorage è°ƒç”¨ engine çš„ &lt;code&gt;async_snapshot&lt;/code&gt; è·å–æ•°æ®åº“å¿«ç…§ä¹‹åäº¤ç»™ &lt;code&gt;read_pool&lt;/code&gt;çº¿ç¨‹æ± è¿›è¡Œå¤„ç†ã€‚å†™å…¥è¯·æ±‚ï¼ŒåŒ…æ‹¬ prewriteã€commitã€rollback ç­‰ï¼Œç›´æ¥äº¤ç»™ Scheduler è¿›è¡Œå¤„ç†ã€‚Scheduler çš„å®šä¹‰åœ¨ &lt;code&gt;storage/txn/scheduler.rs&lt;/code&gt; ä¸­ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Scheduler&lt;/b&gt;&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;pub struct Scheduler&amp;lt;E: Engine&amp;gt; {
    engine: Option&amp;lt;E&amp;gt;,
    inner: Arc&amp;lt;SchedulerInner&amp;gt;,
}

struct SchedulerInner {
    id_alloc, AtomicU64,
    task_contexts: Vec&amp;lt;Mutex&amp;lt;HashMap&amp;lt;u64, TaskContext&amp;gt;&amp;gt;&amp;gt;,
    lathes: Latches,
    sched_pending_write_threshold: usize,
    worker_pool: SchedPool,
    high_priority_pool: SchedPool,
    // Some other fields...
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ¥ä¸‹æ¥ç®€å•ä»‹ç»ä¸‹ Scheduler å‡ ä¸ªé‡è¦çš„æˆå‘˜ï¼š&lt;/p&gt;&lt;p&gt;&lt;code&gt;id_alloc&lt;/code&gt;ï¼šåˆ°è¾¾ Scheduler çš„è¯·æ±‚éƒ½ä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ command idã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;latches&lt;/code&gt;ï¼šå†™è¯·æ±‚åˆ°è¾¾ Scheduler ä¹‹åä¼šå°è¯•è·å–æ‰€éœ€è¦çš„ latchï¼Œå¦‚æœæš‚æ—¶è·å–ä¸åˆ°æ‰€éœ€è¦çš„ latchï¼Œå…¶å¯¹åº”çš„ command id ä¼šè¢«æ’å…¥åˆ° latch çš„ waiting list é‡Œï¼Œå½“å‰é¢çš„è¯·æ±‚æ‰§è¡Œç»“æŸåä¼šå”¤é†’ waiting list é‡Œçš„è¯·æ±‚ç»§ç»­æ‰§è¡Œï¼Œè¿™éƒ¨åˆ†é€»è¾‘æˆ‘ä»¬å°†ä¼šåœ¨ä¸‹ä¸€èŠ‚ prewrite è¯·æ±‚åœ¨ scheduler ä¸­çš„æ‰§è¡Œæµç¨‹ä¸­ä»‹ç»ã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;task_contexts&lt;/code&gt;ï¼šç”¨äºå­˜å‚¨ Scheduler ä¸­æ‰€æœ‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚æš‚æ—¶æœªèƒ½è·å–æ‰€éœ€ latch çš„è¯·æ±‚éƒ½ä¼šè¢«æš‚å­˜åœ¨ &lt;code&gt;task_contexts&lt;/code&gt; ä¸­ã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;sched_pending_write_threshold&lt;/code&gt;ï¼šç”¨äºç»Ÿè®¡ Scheduler å†…æ‰€æœ‰å†™å…¥è¯·æ±‚çš„å†™å…¥æµé‡ï¼Œå¯ä»¥é€šè¿‡è¯¥æŒ‡æ ‡å¯¹ Scheduler çš„å†™å…¥æ“ä½œè¿›è¡Œæµæ§ã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;worker_pool&lt;/code&gt;ï¼Œ&lt;code&gt;high_priority_pool&lt;/code&gt;ï¼šä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œå†™è¯·æ±‚åœ¨è°ƒç”¨ engine çš„ async_write ä¹‹å‰éœ€è¦è¿›è¡Œäº‹åŠ¡çº¦æŸçš„æ£€éªŒå·¥ä½œï¼Œè¿™äº›å·¥ä½œéƒ½æ˜¯åœ¨è¿™ä¸ªä¸¤ä¸ªçº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;prewrite è¯·æ±‚åœ¨ Scheduler ä¸­çš„æ‰§è¡Œæµç¨‹&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ä¸‹é¢æˆ‘ä»¬ä»¥ prewrite è¯·æ±‚ä¸ºä¾‹å­æ¥è®²è§£ä¸‹å†™è¯·æ±‚åœ¨ Scheduler ä¸­æ˜¯å¦‚ä½•å¤„ç†çš„ï¼š&lt;/p&gt;&lt;p&gt;1ï¼‰Scheduler æ”¶åˆ° prewrite è¯·æ±‚çš„æ—¶å€™é¦–å…ˆä¼šè¿›è¡Œæµæ§åˆ¤æ–­ï¼Œå¦‚æœ Scheduler é‡Œçš„è¯·æ±‚è¿‡å¤šï¼Œä¼šç›´æ¥è¿”å› &lt;code&gt;SchedTooBusy&lt;/code&gt;é”™è¯¯ï¼Œæç¤ºç­‰ä¸€ä¼šå†å‘é€ï¼Œå¦åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚&lt;/p&gt;&lt;p&gt;2ï¼‰æ¥ç€ä¼šå°è¯•è·å–æ‰€éœ€è¦çš„ latchï¼Œå¦‚æœè·å– latch æˆåŠŸé‚£ä¹ˆç›´æ¥è¿›å…¥ä¸‹ä¸€æ­¥ã€‚å¦‚æœè·å– latch å¤±è´¥ï¼Œè¯´æ˜æœ‰å…¶ä»–è¯·æ±‚å ä½äº† latchï¼Œè¿™ç§æƒ…å†µè¯´æ˜å…¶ä»–è¯·æ±‚å¯èƒ½ä¹Ÿæ­£åœ¨å¯¹ç›¸åŒçš„ key è¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆå½“å‰ prewrite è¯·æ±‚ä¼šè¢«æš‚æ—¶æŒ‚èµ·æ¥ï¼Œè¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¼šæš‚å­˜åœ¨ Scheduler çš„ &lt;code&gt;task_contexts&lt;/code&gt; é‡Œé¢ã€‚å½“å‰é¢çš„è¯·æ±‚æ‰§è¡Œç»“æŸä¹‹åä¼šå°†è¯¥ prewrite è¯·æ±‚é‡æ–°å”¤é†’ç»§ç»­æ‰§è¡Œã€‚&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;impl&amp;lt;E: Engine&amp;gt; Scheduler&amp;lt;E&amp;gt; {
    fn try_to_wake_up(&amp;amp;self, cid: u64) {
        if self.inner.acquire_lock(cid) {
            self.get_snapshot(cid);
        }
    }
    fn release_lock(&amp;amp;self, lock: &amp;amp;Lock, cid: u64) {
        let wakeup_list = self.inner.latches.release(lock, cid);
        for wcid in wakeup_list {
            self.try_to_wake_up(wcid);
        }
    }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;3ï¼‰è·å– latch æˆåŠŸä¹‹åä¼šè°ƒç”¨ Scheduler çš„ &lt;code&gt;get_snapshot&lt;/code&gt; æ¥å£ä» engine è·å–æ•°æ®åº“çš„å¿«ç…§ã€‚&lt;code&gt;get_snapshot&lt;/code&gt; å†…éƒ¨å®é™…ä¸Šå°±æ˜¯è°ƒç”¨ engine çš„ &lt;code&gt;async_snapshot&lt;/code&gt; æ¥å£ã€‚ç„¶åæŠŠ prewrite è¯·æ±‚ä»¥åŠåˆšåˆšè·å–åˆ°çš„æ•°æ®åº“å¿«ç…§äº¤ç»™ &lt;code&gt;worker_pool&lt;/code&gt; è¿›è¡Œå¤„ç†ã€‚å¦‚æœè¯¥ prewrite è¯·æ±‚ä¼˜å…ˆçº§å­—æ®µæ˜¯ &lt;code&gt;high&lt;/code&gt; å°±ä¼šè¢«åˆ†å‘åˆ° &lt;code&gt;high_priority_pool&lt;/code&gt; è¿›è¡Œå¤„ç†ã€‚&lt;code&gt;high_priority_pool&lt;/code&gt; æ˜¯ä¸ºäº†é‚£äº›é«˜ä¼˜å…ˆçº§è¯·æ±‚è€Œè®¾è®¡çš„ï¼Œæ¯”å¦‚ TiDB ç³»ç»Ÿå†…éƒ¨çš„ä¸€äº›è¯·æ±‚è¦æ±‚ TiKV å¿«é€Ÿè¿”å›ï¼Œä¸èƒ½ç”±äº &lt;code&gt;worker_pool&lt;/code&gt; ç¹å¿™è€Œè¢«å¡ä½ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›®å‰ &lt;code&gt;high_priority_pool&lt;/code&gt; ä¸ &lt;code&gt;worker_pool&lt;/code&gt; ä»…ä»…æ˜¯è¯­ä¹‰ä¸Šä¸åŒçš„ä¸¤ä¸ªçº¿ç¨‹æ± ï¼Œå®ƒä»¬å†…éƒ¨å…·æœ‰ç›¸åŒçš„æ“ä½œç³»ç»Ÿè°ƒåº¦ä¼˜å…ˆçº§ã€‚&lt;/p&gt;&lt;p&gt;4ï¼‰&lt;code&gt;worker_pool&lt;/code&gt; æ”¶åˆ° prewrite è¯·æ±‚ä¹‹åï¼Œä¸»è¦å·¥ä½œæ˜¯ä»æ‹¿åˆ°çš„æ•°æ®åº“å¿«ç…§é‡Œç¡®è®¤å½“å‰ prewrite è¯·æ±‚æ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œï¼Œæ¯”å¦‚æ˜¯å¦å·²ç»æœ‰æ›´å¤§ ts çš„äº‹åŠ¡å·²ç»å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œå…·ä½“çš„ç»†èŠ‚å¯ä»¥å‚è€ƒ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//ai.google/research/pubs/pub36726&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Percolator è®ºæ–‡&lt;/a&gt;ï¼Œæˆ–è€…å‚è€ƒæˆ‘ä»¬çš„å®˜æ–¹åšå®¢ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-transaction-model/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ã€ŠTiKV äº‹åŠ¡æ¨¡å‹æ¦‚è§ˆã€‹&lt;/a&gt;ã€‚å½“åˆ¤æ–­ prewrite æ˜¯å¯ä»¥æ‰§è¡Œçš„ï¼Œä¼šè°ƒç”¨ engine çš„ &lt;code&gt;async_write&lt;/code&gt; æ¥å£æ‰§è¡ŒçœŸæ­£çš„å†™å…¥æ“ä½œã€‚è¿™éƒ¨åˆ†çš„å…·ä½“çš„ä»£ç è§ &lt;code&gt;storage/txn/process.rs&lt;/code&gt; ä¸­çš„ &lt;code&gt;process_write_impl&lt;/code&gt; å‡½æ•°ã€‚&lt;/p&gt;&lt;p&gt;5ï¼‰å½“ &lt;code&gt;async_write&lt;/code&gt; æ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥ä¹‹åï¼Œä¼šè°ƒç”¨ Scheduler çš„ &lt;code&gt;release_lock&lt;/code&gt; å‡½æ•°æ¥é‡Šæ”¾ latch å¹¶ä¸”å”¤é†’ç­‰å¾…åœ¨è¿™äº› latch ä¸Šçš„è¯·æ±‚ç»§ç»­æ‰§è¡Œã€‚&lt;/p&gt;&lt;h3&gt;5. MVCC&lt;/h3&gt;&lt;p&gt;TiKV MVCC ç›¸å…³çš„ä»£ç ä½äº &lt;code&gt;storage/mvcc&lt;/code&gt; æ–‡ä»¶å¤¹ä¸‹ï¼Œå¼ºçƒˆå»ºè®®å¤§å®¶åœ¨é˜…è¯»è¿™éƒ¨åˆ†ä»£ç ä¹‹å‰å…ˆé˜…è¯» &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//ai.google/research/pubs/pub36726&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Percolator è®ºæ–‡&lt;/a&gt;ï¼Œæˆ–è€…æˆ‘ä»¬çš„å®˜æ–¹åšå®¢ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-transaction-model/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ã€ŠTiKV äº‹åŠ¡æ¨¡å‹æ¦‚è§ˆã€‹&lt;/a&gt;ã€‚&lt;/p&gt;&lt;p&gt;MVCC ä¸‹é¢æœ‰ä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„ç»“æ„ä½“ï¼Œåˆ†åˆ«ä¸º &lt;code&gt;MvccReader&lt;/code&gt; å’Œ &lt;code&gt;MvccTxn&lt;/code&gt;ã€‚&lt;code&gt;MvccReader&lt;/code&gt; ä½äº &lt;code&gt;storage/mvcc/reader/reader.rs&lt;/code&gt; æ–‡ä»¶ä¸­ï¼Œå®ƒä¸»è¦æä¾›è¯»åŠŸèƒ½ï¼Œå°†å¤šç‰ˆæœ¬çš„å¤„ç†ç»†èŠ‚éšè—åœ¨å†…éƒ¨ã€‚æ¯”å¦‚ &lt;code&gt;MvccReader&lt;/code&gt; çš„ &lt;code&gt;get&lt;/code&gt; æ¥å£ï¼Œä¼ å…¥éœ€è¦è¯»çš„ key ä»¥åŠ tsï¼Œè¿”å›è¿™ä¸ª ts å¯ä»¥çœ‹åˆ°çš„ç‰ˆæœ¬æˆ–è€…è¿”å› &lt;code&gt;key is lock&lt;/code&gt; é”™è¯¯ç­‰ã€‚&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;impl&amp;lt;S: Snapshot&amp;gt; MvccReader&amp;lt;S&amp;gt; {
    pub fn get(&amp;amp;mut self, key: &amp;amp;Key, mut ts: u64) -&amp;gt; Result&amp;lt;Option&amp;lt;Value&amp;gt;&amp;gt;;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;MvccTxn&lt;/code&gt; ä½äº &lt;code&gt;storage/mvcc/txn.rs&lt;/code&gt; æ–‡ä»¶ä¸­ï¼Œå®ƒä¸»è¦æä¾›å†™ä¹‹å‰çš„äº‹åŠ¡çº¦æŸæ£€éªŒåŠŸèƒ½ï¼Œä¸Šä¸€èŠ‚ prewrite è¯·æ±‚çš„å¤„ç†æµç¨‹ä¸­ç¬¬å››æ­¥å°±æ˜¯é€šè¿‡è°ƒç”¨ &lt;code&gt;MvccTxn&lt;/code&gt; çš„ prewrite æ¥å£æ¥è¿›è¡Œçš„äº‹åŠ¡çº¦æŸæ£€éªŒã€‚&lt;/p&gt;&lt;h2&gt;å°ç»“&lt;/h2&gt;&lt;p&gt;TiKV ç«¯äº‹åŠ¡ç›¸å…³çš„å®ç°éƒ½ä½äº Storage æ¨¡å—ä¸­ï¼Œè¯¥æ–‡å¸¦å¤§å®¶ç®€å•æ¦‚è§ˆäº†ä¸‹è¿™éƒ¨åˆ†å‡ ä¸ªå…³é”®çš„ç‚¹ï¼Œæƒ³äº†è§£æ›´å¤šç»†èŠ‚çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»è¿™éƒ¨åˆ†çš„æºç ï¼ˆcode talks XDï¼‰ã€‚å¦å¤–ä» 3.0 ç‰ˆæœ¬å¼€å§‹ï¼ŒTiDB å’Œ TiKV æ”¯æŒæ‚²è§‚äº‹åŠ¡ï¼ŒTiKV ç«¯å¯¹åº”çš„ä»£ç ä¸»è¦ä½äº &lt;code&gt;storage/lock_manager&lt;/code&gt; ä»¥åŠä¸Šé¢æåˆ°çš„ MVCC æ¨¡å—ä¸­ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;åŸæ–‡é˜…è¯»&lt;/b&gt;ï¼š&lt;/p&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/tikv-soucre-code-reading-11/&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg&quot; data-image-width=&quot;1200&quot; data-image-height=&quot;1200&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆåä¸€ï¼‰Storage - äº‹åŠ¡æ§åˆ¶å±‚ | PingCAP&lt;/a&gt;&lt;p&gt;&lt;b&gt;æ›´å¤š TiKV æºç é˜…è¯»ï¼š&lt;/b&gt;&lt;/p&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/%23TiKV-%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg&quot; data-image-width=&quot;1200&quot; data-image-height=&quot;1200&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Blog-cns | PingCAP&lt;/a&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2019-07-29-75708576</guid>
<pubDate>Mon, 29 Jul 2019 00:00:00 +0800</pubDate>
</item>
<item>
<title>æ–‡ç¨¿åˆ†äº«è®°å½•ï¼šTiDB Operator è®¾è®¡ä¸å®ç°</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-23-74897388.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/74897388&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-2d703c5defe9201ab3017cfe917a6c32_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;blockquote&gt;åˆšåˆšåœ¨ DockOne å¾®ä¿¡ç¾¤åšäº†ä¸€æ¬¡æ–‡ç¨¿åˆ†äº«ï¼Œç”±äºä¸´åˆ°å¼€å§‹å‰æ‰çŸ¥é“åˆ†äº«å½¢å¼æ˜¯çº¯æ–‡ç¨¿çš„ï¼Œæ‰€ä»¥åªåˆ—äº†ä¸€ä¸‹æçº²ï¼Œæ²¡æœ‰ markdown æ ¼å¼çš„æ­£æ–‡ï¼Œå°±å…ˆå‘åˆ°ä¸“æ é‡Œï¼ˆæ–¹ä¾¿è´´å›¾ï¼‰æ˜å¤©å†æ•´ç†åˆ° &lt;a href=&quot;https://link.zhihu.com/?target=http%3A//aleiwu.com/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;aleiwu.com&lt;/a&gt; ä¸Šã€‚&lt;br/&gt;å…¨æ–‡æ— æ”¹åŠ¨ï¼ŒåŸæ±åŸå‘³è¿˜åŸåˆ†äº«ç°åœºğŸ¤£ï¼ˆä»€ä¹ˆé¬¼ï¼‰&lt;/blockquote&gt;&lt;h2&gt;æ­£æ–‡&lt;/h2&gt;&lt;p&gt;å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ PingCAP çš„ Cloud å·¥ç¨‹å¸ˆå´å¶ç£Šï¼Œç›®å‰åœ¨åš TiDB Operator ç›¸å…³çš„å¼€å‘å·¥ä½œï¼Œå¾ˆé«˜å…´ä»Šå¤©èƒ½è·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹ TiDB Operator è¿™ä¸ªé¡¹ç›®èƒŒåçš„ä¸€äº›ä¸œè¥¿ã€‚(è‡ªå·±æ•´ç†è‡ªå·±çš„åˆ†äº«æ„Ÿè§‰å¥½å¥‡æ€ªå•Šã€‚ã€‚ã€‚è™½ç„¶åªæ˜¯å¤åˆ¶ç²˜è´´ï¼‰&lt;/p&gt;&lt;p&gt;é¦–å…ˆè¦è¯´çš„å½“ç„¶æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦åš TiDB Operatorï¼Œè¿™å¾—ä» TiDB æœ¬èº«çš„æ¶æ„å¼€å§‹è¯´èµ·ã€‚ä¸‹é¢æ˜¯ TiDB çš„æ¶æ„å›¾ï¼š&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-4baf6db8e1c8e1b4ca66419711418382_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1198&quot; data-rawheight=&quot;742&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1198&quot; data-original=&quot;https://pic3.zhimg.com/v2-4baf6db8e1c8e1b4ca66419711418382_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-4baf6db8e1c8e1b4ca66419711418382_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1198&quot; data-rawheight=&quot;742&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1198&quot; data-original=&quot;https://pic3.zhimg.com/v2-4baf6db8e1c8e1b4ca66419711418382_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-4baf6db8e1c8e1b4ca66419711418382_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;å…¶ä¸­ï¼ŒTiKV æ˜¯ä¸€å¥—åˆ†å¸ƒå¼çš„ Key-Value å­˜å‚¨å¼•æ“ï¼Œå®ƒæ˜¯æ•´ä¸ªæ•°æ®åº“çš„å­˜å‚¨å±‚ï¼Œåœ¨ TiKV ä¸­ï¼Œæ•°æ®è¢«åˆ†ä¸ºä¸€ä¸ªä¸ª Regionï¼Œè€Œä¸€ä¸ª Region å°±å¯¹åº”ä¸€ä¸ª Raft Groupï¼Œä½¿ç”¨ Raft åè®®åš Log Replication æ¥ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚é‚£ä¹ˆè‡ªç„¶å®¹æ˜“æƒ³åˆ°ï¼Œæˆ‘ä»¬åªè¦æ°´å¹³å¢åŠ  TiKV èŠ‚ç‚¹æ•°ï¼Œå†æŠŠæ•°æ®åˆ‡æˆæ›´å¤šçš„ Region å‡åŒ€åˆ†å¸ƒåœ¨è¿™äº›èŠ‚ç‚¹ä¸Šï¼Œå°±èƒ½å®ç°å­˜å‚¨å±‚çš„æ°´å¹³æ‰©å±•ã€‚&lt;/p&gt;&lt;p&gt;TiDB åˆ™æ˜¯è®¡ç®—æ‰§è¡Œå±‚ï¼Œè´Ÿè´£ SQL çš„è§£æå’ŒæŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–ï¼ŒçœŸæ­£æ‰§è¡Œ SQL æ—¶åˆ™é€šè¿‡ TiKV æä¾›çš„ API æ¥è®¿é—®æ•°æ®ã€‚&lt;/p&gt;&lt;p&gt;æœ€åæ˜¯ PDï¼ŒPD æ˜¯é›†ç¾¤çš„â€œå¤§è„‘â€ï¼Œå®ƒä¸€æ–¹é¢æ˜¯æ˜¯é›†ç¾¤çš„ metadata serverï¼ŒTiKV ä¸­çš„æ•°æ®åˆ†å¸ƒæƒ…å†µéƒ½ä¼šé€šè¿‡å¿ƒè·³ä¸ŠæŠ¥ç»™ PD å­˜å‚¨èµ·æ¥ï¼›å¦ä¸€æ–¹é¢åˆæ‰¿æ‹…é›†ç¾¤æ•°æ®è°ƒåº¦çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬å‰é¢è¯´ TiKV è¦æŠŠæ•°æ®æ‹†æˆæ›´å¤šçš„ Region å‡åŒ€åˆ†å¸ƒåˆ°èŠ‚ç‚¹ä¸Šï¼Œä»€ä¹ˆæ—¶å€™æ‹†ã€æ€ä¹ˆæ‹†ã€æ‹†å®Œåˆ†é…åˆ°å“ªäº›èŠ‚ç‚¹ä¸Šè¿™äº›äº‹æƒ…å°±éƒ½æ˜¯ PD é€šè¿‡è°ƒåº¦ç®—æ³•æ¥å†³å®šçš„ã€‚ä»ç›´è§‚ä¸Šï¼ŒPD å…¶å®æœ‰ç‚¹åƒ Kubernetes é‡Œçš„ Control Planeã€‚&lt;/p&gt;&lt;p&gt;è¿™ä¹ˆä¸€å¥—æ¶æ„çš„ä¼˜åŠ¿æ˜¯åˆ†å±‚æ¸…æ™°ï¼ŒæŒ‡è´£æ˜ç¡®ï¼Œæ¯ä¸€å±‚éƒ½å¯ä»¥ç‹¬ç«‹åœ°åšåŠŸèƒ½æ‰©å±•å’Œè§„æ¨¡ä¸Šçš„æ°´å¹³ä¼¸ç¼©ã€‚ä½†æ˜¯è¿™å¯¹äºè¿ç»´ç®¡ç†æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªå·¨å¤§çš„æŒ‘æˆ˜ï¼Œå†åŠ ä¸Š TiDB æœ¬èº«çš„ä¸€äº›æ¯”è¾ƒå¤æ‚çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•å’Œäº‹åŠ¡ç®—æ³•ï¼Œå¯ä»¥è¯´æ˜¯æŠŠæ•´ä¸ª TiDB çš„è¿ç»´å…¥é—¨é—¨æ§›æ‹‰å¾—ç›¸å½“é«˜ã€‚å¦ä¸€æ–¹é¢ï¼Œä¼ ç»Ÿçš„åŸºäºè™šæ‹Ÿæœºçš„éƒ¨ç½²æ–¹å¼ä¹Ÿä¸èƒ½å¾ˆå¥½åœ°å‘æŒ¥ TiDB æ°´å¹³ä¼¸ç¼©å’Œæ•…éšœè‡ªåŠ¨è½¬ç§»çš„æ½œåŠ›ã€‚æ‰€ä»¥å…¶å®æˆ‘ä»¬åœ¨å†…éƒ¨å¾ˆæ—©å°±åœ¨å°è¯•ä½¿ç”¨ Kubernetes æ¥ç¼–æ’ç®¡ç† TiDB é›†ç¾¤ï¼Œç”šè‡³åœ¨è¿™ä¸ªå¼€æºçš„ TiDB Operator ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ç‰ˆåºŸå¼ƒæ‰çš„ TiDB Operatorã€‚æœ€åçš„äº‹å®ä¹Ÿç¡®å®è¯æ˜æˆ‘ä»¬ä¸€ç›´ä»¥æ¥çš„é€‰æ‹©å’ŒæŠ•å…¥æ˜¯æ­£ç¡®çš„ï¼Œç›¸ä¿¡å¤§å®¶å¬äº†åé¢çš„åˆ†æï¼Œä¹Ÿä¼šè®¤åŒè¿™ä¸€ç‚¹ã€‚&lt;/p&gt;&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬æ­£å¼è¿›å…¥ TiDB Operator çš„è§£è¯»ã€‚å…¶å® Operator æ¨¡å¼åœ¨ Kubernetes ç¤¾åŒºå·²ç»ä¸æ–°é²œäº†ï¼Œç°åœ¨å¤§éƒ¨åˆ†æµè¡Œçš„æœ‰çŠ¶æ€åº”ç”¨éƒ½æœ‰è‡ªå·±çš„ Operatorã€‚ä½†å›é¡¾ä¸€ä¸‹ Operator çš„ä¸€äº›æ¦‚å¿µä»ç„¶éå¸¸å¿…è¦ã€‚&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬çŸ¥é“ Kubernetes é‡Œä¸¤ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå°±æ˜¯å£°æ˜å¼ API å’Œæ§åˆ¶å¾ªç¯ã€‚æ‰€æœ‰çš„ API å¯¹è±¡éƒ½æ˜¯å¯¹ç”¨æˆ·æ„å›¾çš„è®°å½•ï¼Œå†ç”±æ§åˆ¶å™¨å» watch è¿™äº›æ„å›¾ï¼Œå¯¹æ¯”å®é™…çŠ¶æ€ï¼Œæ‰§è¡Œè°ƒè°ï¼ˆreconcileï¼‰æ“ä½œæ¥é©±åŠ¨é›†ç¾¤è¾¾æˆç”¨æˆ·æ„å›¾ã€‚Kubernetes æœ¬èº«æœ‰å¾ˆå¤šçš„å†…ç½® API å¯¹è±¡ï¼Œæ¯”å¦‚ ReplicaSet è¡¨è¾¾æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåº”ç”¨æœ‰å‡ ä¸ªå®ä¾‹ï¼ŒDaemonSet è¡¨è¾¾æˆ‘ä»¬å¸Œæœ›åœ¨éƒ¨åˆ†è¢«é€‰ä¸­çš„èŠ‚ç‚¹ä¸Šæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸”åªè¿è¡Œä¸€ä¸ªå®ä¾‹ã€‚é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆå‘ Kubernetes è¡¨è¾¾ â€œæˆ‘éœ€è¦ä¸€ä¸ª TiDB é›†ç¾¤å‘¢â€œï¼Ÿç­”æ¡ˆå°±æ˜¯å®šä¹‰ä¸€ä¸ªç”¨äºæè¿° TiDB é›†ç¾¤çš„å¯¹è±¡ï¼Œåœ¨ Kubernetes ä¸­ï¼Œç›®å‰æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å®šä¹‰ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œä¸€æ˜¯ CustomResourceDefinitionï¼ˆCRDï¼‰ã€äºŒæ˜¯ Aggregation ApiServerï¼ˆAAï¼‰ï¼Œå…¶ä¸­ CRD æ˜¯ç›¸å¯¹ç®€å•ä¹Ÿæ˜¯ç›®å‰åº”ç”¨æ¯”è¾ƒå¹¿çš„æ–¹æ³•ã€‚TiDB Operator å°±ç”¨ CRD å®šä¹‰äº†ä¸€ä¸ª â€TidbClusterâ€ å¯¹è±¡ã€‚&lt;/p&gt;&lt;p&gt;æœ‰äº†å¯¹è±¡è¿˜æ²¡å®Œï¼Œè¿™ä¸ªå¯¹è±¡ç°åœ¨è°éƒ½è¿˜ä¸è®¤è¯†å®ƒå‘¢ã€‚è¿™æ—¶å€™å°±æ˜¯è‡ªå®šä¹‰æ§åˆ¶å™¨å‡ºåœºçš„æ—¶å€™äº†ï¼Œæˆ‘ä»¬çš„è‡ªå®šä¹‰æ§åˆ¶å™¨å« tidb-controller-managerï¼Œå®ƒä¼š watch TidbCluster å¯¹è±¡å’Œå…¶å®ƒä¸€äº›ç›¸å…³å¯¹è±¡ï¼Œå¹¶ä¸”æŒ‰ç…§æˆ‘ä»¬ç¼–å†™çš„é€»è¾‘åšè°ƒè°æ¥é©±åŠ¨çœŸå®çš„ TiDB é›†ç¾¤å‘æˆ‘ä»¬å®šä¹‰çš„ç»ˆæ€è½¬ç§»ã€‚&lt;/p&gt;&lt;p&gt;CRD åŠ ä¸Šæ§åˆ¶å™¨å°±æ˜¯å…¸å‹çš„ Operator æ¨¡å¼äº†ã€‚å½“ç„¶è¿™è¿˜æ²¡å®Œï¼Œå¾ˆå¤šé€»è¾‘æ§åˆ¶å™¨ä¹Ÿæ˜¯æ— èƒ½ä¸ºåŠ›çš„ï¼Œæ¯”å¦‚ Pod çš„è°ƒåº¦é€»è¾‘ã€‚è¿™ä¸€å—ä¸ºäº†å®ç° TiDB å®¹å™¨çš„è‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥ï¼Œæˆ‘ä»¬ç¼–å†™äº† Scheduler Extenderã€‚è¿˜æœ‰ä¸€äº›éªŒè¯é€»è¾‘ï¼Œæ¯”å¦‚æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦é˜»æ­¢é›†ç¾¤çš„å˜æ›´ï¼Œè¿™æ ·çš„é€»è¾‘å°±ç”¨ Admission Webhook æ¥å®ç°ã€‚è€Œåœ¨ç”¨æˆ·ä¾§ï¼Œæˆ‘ä»¬åˆ™å¼€å‘äº† kubectl plugin æ¥åš TiDB çš„ä¸€äº›ç‰¹å®šæ“ä½œã€‚æ‰€ä»¥å¤§å®¶å°±å¯ä»¥çŸ¥é“ï¼ŒTiDB Operator å…¶å®ä¸æ­¢äº Operatorï¼Œæˆ‘ä»¬çš„æ ¸å¿ƒç†å¿µæ˜¯åˆ©ç”¨ Kubernetes å¤§é‡çš„æ‰©å±•ç‚¹ï¼Œä¸º Kubernetes å…¨é¢æ³¨å…¥ TiDB çš„é¢†åŸŸçŸ¥è¯†ï¼ŒæŠŠ Kubernetes æ‰“é€ æˆ TiDB çš„ä¸€ä¸ªæœ€ä½³åº•åº§ã€‚&lt;/p&gt;&lt;p&gt;è¿™æ ·åšæœ‰ä¸¤å¤§å¥½å¤„(åˆ’é‡ç‚¹ï¼‰ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;b&gt;ä¸€æ˜¯åœ¨ Kubernetes åŸºäºæ§åˆ¶å¾ªç¯çš„è‡ªè¿ç»´æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ TiDB çš„è¿ç»´é—¨æ§›é™åˆ°æœ€ä½ï¼Œè®©å…¥é—¨ç”¨æˆ·ä¹Ÿèƒ½è½»æ¾æå®šæ°´å¹³ä¼¸ç¼©å’Œæ•…éšœè½¬ç§»è¿™äº›é«˜çº§ç©æ³•ï¼›&lt;/b&gt;&lt;/li&gt;&lt;li&gt;&lt;b&gt;äºŒæ˜¯æˆ‘ä»¬åŸºäº Kubernetes çš„ Restful API æä¾›äº†ä¸€å¥—æ ‡å‡†çš„é›†ç¾¤ç®¡ç† APIï¼Œç”¨æˆ·å¯ä»¥æ‹¿ç€è¿™ä¸ª API æŠŠ TiDB é›†æˆåˆ°è‡ªå·±çš„å·¥å…·é“¾æˆ– PaaS å¹³å°ä¸­ï¼ŒçœŸæ­£èµ‹èƒ½ç”¨æˆ·å»æŠŠ TiDB ç©å¥½ç©ç²¾ã€‚&lt;/b&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ä¸Šé¢è¯´äº†ä¸€äº›æ¯”è¾ƒç„ä¹çš„ã€æ–¹æ³•è®ºä¸Šçš„ä¸œè¥¿ï¼Œå¯èƒ½å¤§å®¶éƒ½è§‰å¾—è„šå¿«å¤Ÿä¸ç€åœ°äº† ã€‚ä¸‹é¢æˆ‘ä»¬å°±è®²ä¸€äº›æŠ€æœ¯å¹²è´§ï¼Œç”¨ä¸€äº›åŠŸèƒ½åœºæ™¯æ¥è§£æ TiDB Operator çš„å®ç°æœºåˆ¶ï¼Œæ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™é‡Œé¢çš„ä¸€äº›å¥—è·¯å¯¹äºåœ¨ Kubernetes ä¸Šç®¡ç†æœ‰çŠ¶æ€åº”ç”¨æ˜¯é€šç”¨çš„ï¼Œå¯èƒ½èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›å¯å‘ã€‚&lt;/p&gt;&lt;p&gt;ç¬¬ä¸€æ˜¯ TiDB Operator è¯¥æ€ä¹ˆå»æ„å»ºä¸€ä¸ª TiDB é›†ç¾¤ã€‚æˆ‘ä»¬å°è¯•è¿‡ç›´æ¥æ“ä½œ Podï¼Œæœ€åçš„ç»“è®ºæ˜¯å·¥ä½œé‡å¤ªå¤§äº†ï¼Œk8s è‡ªå·±çš„æ§åˆ¶å™¨é‡Œå¤„ç†äº†å¤§é‡çš„ corner caseï¼Œå¹¶ä¸”æœ‰å¤§é‡çš„å•æµ‹å’Œ e2e æµ‹è¯•æ¥ä¿éšœæ­£ç¡®æ€§ï¼Œæˆ‘ä»¬è¦è‡ªå·±å†å»å®ç°ä¸€éæˆæœ¬å¾ˆé«˜ã€‚å› æ­¤æˆ‘ä»¬æœ€åçš„é€‰å‹æ˜¯ TiDB Operator åˆ†åˆ«ä¸º PDã€TiKVã€TiDB åˆ›å»ºä¸€ä¸ª StatefulSetï¼Œå†å»ç®¡ç†è¿™äº› StatefulSet æ¥å®ç°ä¼˜é›…å‡çº§å’Œæ•…éšœè½¬ç§»ç­‰åŠŸèƒ½ã€‚å¤§å®¶ä¹Ÿå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šç¤¾åŒºçš„ Operator éƒ½æ˜¯è¿™ä¹ˆåšçš„ï¼Œè€Œä¸”éƒ¨åˆ†æ²¡æœ‰è¿™ä¹ˆåšçš„ Operator å·²ç»å¼€å§‹åæ€äº†ï¼Œæ¯”å¦‚ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/elastic/cloud-on-k8s/issues/1173&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/elastic/clou&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;d-on-k8s/issues/1173&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;ã€‚ç¡®å®æŒ‰ç…§æˆ‘ä»¬çš„ç»éªŒï¼Œç®¡ç†æœ‰çŠ¶æ€åº”ç”¨çš„ Operator å¾€å¾€åšåˆ°åæ¥å‘ç°æ˜¯éœ€è¦è‡ªå·±å®ç° statefulset 80%çš„åŠŸèƒ½çš„ï¼Œé€‰æ‹©ç›´æ¥ç®¡ç†è£¸ Pod å°±æœ‰ç‚¹åƒåŠ›ä¸è®¨å¥½äº† ã€‚ğŸ¤”&lt;/p&gt;&lt;p&gt;ç¬¬äºŒä¸ªæ˜¯ Local PVï¼Œå¤§éƒ¨åˆ†å­˜å‚¨å‹åº”ç”¨å¯¹ç£ç›˜æ€§èƒ½æ˜¯ç›¸å½“æ•æ„Ÿçš„ï¼Œå› æ­¤ Local PV æ˜¯ä¸€ä¸ªå¿…é€‰é¡¹ã€‚å¥½åœ¨ç°åœ¨ Kubernetes çš„ Local PV æ”¯æŒå·²ç»æ¯”è¾ƒæˆç†Ÿäº†ï¼Œä¹Ÿæœ‰ local-pv-provisioner æ¥è¾…åŠ©åˆ›å»º Local PVã€‚ä½†ä¸€ä¸ªå¾ˆè®©äººå¤´å¤§çš„é—®é¢˜æ˜¯ç”¨äº† Local PV ä¹‹åï¼ŒPod å°±å’Œç‰¹å®šèŠ‚ç‚¹ç»‘æ­»äº†ï¼ŒèŠ‚ç‚¹æ•…éšœåè¦è°ƒåº¦åˆ°å…¶å®ƒæœºå™¨å¿…é¡»æ‰‹åŠ¨åˆ é™¤ PVCï¼Œè¿™å…¶å®ä¸æ˜¯ç¼–æ’å±‚èƒ½è§£å†³çš„é—®é¢˜ï¼Œå› ä¸ºæœ¬åœ°ç£ç›˜ç›¸æ¯”äºèƒŒåé€šå¸¸ä¼šæœ‰ä¸‰å‰¯æœ¬çš„ç½‘ç»œå­˜å‚¨æœ¬èº«å°±æ˜¯ä¸å¯é çš„ï¼Œä½¿ç”¨æœ¬åœ°ç£ç›˜çš„åº”ç”¨å¿…é¡»å¾—åœ¨åº”ç”¨å±‚åšæ•°æ®å†—ä½™ã€‚å½“ç„¶ï¼ŒTiDB çš„å­˜å‚¨å±‚ TiKV æœ¬èº«å°±æ˜¯å¤šå‰¯æœ¬é«˜å¯ç”¨çš„ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬é‡‡å–çš„ç­–ç•¥æ˜¯ä¸ç®¡æ—§çš„ Podï¼Œç›´æ¥åˆ›å»ºæ–° Pod æ¥åšæ•…éšœè½¬ç§»ï¼Œåˆ©ç”¨ TiKV æœ¬èº«çš„æ•°æ®è°ƒåº¦æŠŠæ•°æ®åœ¨æ–° Pod ä¸Šè¡¥é½ã€‚&lt;/p&gt;&lt;p&gt;æ¥ä¸‹æ¥å°±æ˜¯æ•…éšœè½¬ç§»æ€ä¹ˆåšçš„é—®é¢˜ã€‚æˆ‘ä»¬çŸ¥é“ StatefulSet æä¾›çš„è¯­ä¹‰ä¿è¯æ˜¯ç›¸åŒåå­—çš„ Pod é›†ç¾¤ä¸­åŒæ—¶æœ€å¤šåªæœ‰ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯å‡å¦‚å‘ç”Ÿäº†èŠ‚ç‚¹å®•æœºï¼ŒStatefulSet æ˜¯ä¸ä¼šå¸®åŠ©æˆ‘ä»¬åšæ•…éšœè½¬ç§»çš„ï¼Œå› ä¸ºè¿™æ—¶å€™ Kubernetes å¹¶ä¸çŸ¥é“æ˜¯èŠ‚ç‚¹å®•æœºè¿˜æ˜¯ç½‘ç»œåˆ†åŒºï¼Œä¹Ÿå°±æ˜¯å®ƒæ— æ³•ç¡®å®šèŠ‚ç‚¹ä¸Šçš„ Pod è¿˜åœ¨ä¸åœ¨è·‘ã€‚æˆ‘ä»¬å‡è®¾æŒ‚æ‰çš„ Pod å« tikv-0ï¼Œé‚£è¿™æ—¶å€™ k8s å†åˆ›å»ºä¸€ä¸ª tikv-0 å°±è„‘è£‚äº†ã€‚å½“ç„¶äº†ï¼Œåœ¨å…¬æœ‰äº‘ä¸Šä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºå…¬æœ‰äº‘ä¸Š Node Controller ä¼šé€šè¿‡å…¬æœ‰äº‘ API æ£€æŸ¥èŠ‚ç‚¹æ˜¯ä¸æ˜¯çœŸçš„æ¶ˆå¤±äº†ï¼Œå‡å¦‚æ˜¯çš„è¯å°±ä¼šç§»é™¤èŠ‚ç‚¹ï¼Œé‚£ k8s å°±çŸ¥é“ tikv-0 ä¸å¯èƒ½å†è¿è¡Œï¼Œå¯ä»¥åšæ•…éšœè½¬ç§»äº†ã€‚å¯æƒœä¸€éš¾æ¥ä¸€éš¾ğŸ˜‚ï¼Œæ•…éšœè½¬ç§»ä¹‹å Pod åˆä¼šç¢°åˆ°æ‰¾ä¸åˆ° Local PV çš„é—®é¢˜è€Œ PendingğŸ¤£â€¦â€¦&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬æœ€ç»ˆçš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ Tide cluster å¯¹è±¡çš„ status ä¸­è®°å½•å½“å‰æŒ‚æ‰çš„ Podï¼Œè¿™ä¸ªæŒ‚æ‰æ˜¯æŒ‡ä¸€æ–¹é¢ k8s è®¤ä¸º Pod æŒ‚äº†ï¼Œå¦ä¸€æ–¹é¢ï¼ŒTiDB é›†ç¾¤ï¼Œä¹Ÿå°±æ˜¯ PD ä¹Ÿè®¤ä¸ºè¿™ä¸ªå®ä¾‹æŒ‚äº†ï¼Œè¿™ä¸ªéå¸¸é‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬å®é™…åœºæ™¯ä¸­å°±é‡åˆ°è¿‡å› ä¸ºå•è¾¹ç½‘ç»œé—®é¢˜ apiserver è®¤ä¸ºèŠ‚ç‚¹æ‰çº¿è€Œå…¶å®æ­£å¸¸è¿è¡Œçš„ï¼Œè¿™æ—¶å€™ PD å°±æ•‘äº†æˆ‘ä»¬ä¸€å‘½ã€‚æˆ‘ä»¬åœ¨æ§åˆ¶å¾ªç¯ä¸­ä¸“é—¨åŒæ­¥è¿™äº›çŠ¶æ€ï¼Œä¸€æ—¦ä¸¤é¢éƒ½ç¡®è®¤æŸä¸ª Pod ä»¥åŠ Pod ä¸­çš„å®ä¾‹æŒ‚äº†ï¼Œæˆ‘ä»¬å°±åœ¨ status é‡Œè®°å½•ä¸‹æ¥ã€‚è€Œå¦ä¸€ä¸ªæ‰©ç¼©å®¹æ§åˆ¶å¾ªç¯ä¼šæ£€æŸ¥è¿™ä¸ª statusï¼Œå‡å¦‚æœ‰æŒ‚æ‰çš„å®ä¾‹ï¼Œå°±ç»™ StatefulSet çš„å‰¯æœ¬æ•°+1ï¼Œå®ç°æ•…éšœè½¬ç§»ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-7badeb6addf2614d20ab4687868e4262_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1126&quot; data-rawheight=&quot;492&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1126&quot; data-original=&quot;https://pic3.zhimg.com/v2-7badeb6addf2614d20ab4687868e4262_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-7badeb6addf2614d20ab4687868e4262_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1126&quot; data-rawheight=&quot;492&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1126&quot; data-original=&quot;https://pic3.zhimg.com/v2-7badeb6addf2614d20ab4687868e4262_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-7badeb6addf2614d20ab4687868e4262_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œæ§åˆ¶å™¨é‡Œæ˜¯ç»“åˆäº† k8s çš„ä¿¡æ¯å’Œ PD çš„ä¿¡æ¯å»æ›´æ–°è¿™ä¸ª failureStore å­—æ®µã€‚&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-f2452dd2a881e9be8ca0b5d35fcaaca7_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1242&quot; data-rawheight=&quot;590&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1242&quot; data-original=&quot;https://pic4.zhimg.com/v2-f2452dd2a881e9be8ca0b5d35fcaaca7_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-f2452dd2a881e9be8ca0b5d35fcaaca7_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1242&quot; data-rawheight=&quot;590&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1242&quot; data-original=&quot;https://pic4.zhimg.com/v2-f2452dd2a881e9be8ca0b5d35fcaaca7_r.jpg&quot; data-actualsrc=&quot;https://pic4.zhimg.com/v2-f2452dd2a881e9be8ca0b5d35fcaaca7_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;å½“æˆ‘ä»¬ç¡®è®¤ k8s å±‚é¢å’Œä¸šåŠ¡å±‚é¢ï¼ˆPDï¼‰éƒ½è®¤ä¸ºå®ä¾‹æ¢å¤æ­£å¸¸åï¼Œæˆ‘ä»¬å°±ä¼šä» failureStore ä¸­åˆ é™¤å¯¹åº”å®ä¾‹ï¼Œè‡ªåŠ¨æŠŠå®ä¾‹æ•°é™ä¸‹æ¥ï¼Œå½“ç„¶å¯¹äº PD æˆ‘ä»¬æ˜¯è¿™ä¹ˆåšçš„ï¼Œå¯¹äº TiKVï¼Œæˆ‘ä»¬æŠŠåˆ é™¤ failureStore è¿™ä¸€æ­¥äº¤ç»™äº†ç”¨æˆ·ï¼Œé¿å…èŠ‚ç‚¹è¿ç§»æ¬¡æ•°è¿‡å¤šï¼Œæ•°æ®è¿ç§»å¤ªé¢‘ç¹å½±å“é›†ç¾¤æ€§èƒ½ã€‚ä»è¿™ä¸ª case æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è‡ªå®šä¹‰æ§åˆ¶å™¨é‡Œç³…åˆä¸šåŠ¡çŠ¶æ€ï¼ˆæ¥è‡ªä¸šåŠ¡ï¼Œæ¯”å¦‚ TiDB çš„ PDï¼‰ä¸åŸºç¡€è®¾æ–½çŠ¶æ€ï¼ˆæ¥è‡ª k8sï¼‰æ˜¯é‡è¦ä¸”å¿…è¦çš„ã€‚&lt;/p&gt;&lt;p&gt;ç¬¬ä¸‰ä¸ªæƒ³è¯´çš„æ˜¯ä¼˜é›…å‡çº§ï¼Œä»¥ TiKV ä¸ºä¾‹ï¼Œä¼˜é›…å‡çº§å°±æ˜¯åœ¨å‡çº§å‰ä¸»åŠ¨é€å‡ºå¾…å‡çº§å®ä¾‹ä¸Šçš„æ‰€æœ‰ Raft Group çš„ Leaderï¼Œé¿å…å‡ºç°è¯·æ±‚å¤±è´¥ã€‚å¤§å®¶å¯èƒ½ä¼šè¯´è¿™ä¸ªç”¨ preStopHook å¯ä»¥åšï¼Œä½† preStopHook çš„è¶…æ—¶æ—¶é—´æ˜¯ä¸€ä¸ªæ¯”è¾ƒéš¾ç¡®å®šçš„ä¸œè¥¿ï¼Œè€Œä¸”ä¹Ÿä¸å¤Ÿçµæ´»ï¼Œæˆ‘ä»¬æœ€åé€‰æ‹©æ˜¯åœ¨ Controller ä¸­å®ç°ï¼Œç¤ºæ„å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-3cae228a8c4095275d78230dbc307b88_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1238&quot; data-rawheight=&quot;656&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1238&quot; data-original=&quot;https://pic1.zhimg.com/v2-3cae228a8c4095275d78230dbc307b88_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-3cae228a8c4095275d78230dbc307b88_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1238&quot; data-rawheight=&quot;656&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1238&quot; data-original=&quot;https://pic1.zhimg.com/v2-3cae228a8c4095275d78230dbc307b88_r.jpg&quot; data-actualsrc=&quot;https://pic1.zhimg.com/v2-3cae228a8c4095275d78230dbc307b88_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å…¶å®ç”¨ StatefulSet çš„ partition å­—æ®µæ¥æ§åˆ¶å“ªäº›åºå·å¯ä»¥è¢«å‡çº§åˆ°æ–°ç‰ˆæœ¬ï¼Œå“ªäº›è¦å‘†åœ¨æ—§ç‰ˆæœ¬ã€‚å‡çº§å¼€å§‹æ—¶ï¼Œpartition = èŠ‚ç‚¹æ•°-1&lt;b&gt;ï¼ˆè¿™é‡Œåˆ†äº«æ—¶å†™é”™äº†ï¼Œè§åæ–‡ QAï¼‰&lt;/b&gt;ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„ Pod éƒ½ä¸å‡çº§ï¼Œç„¶åå‘¢ï¼Œæˆ‘ä»¬ä¼šå»åˆ¤æ–­ä¸‹ä¸€ä¸ªå¾…å‡çº§çš„ Pod ä¸Šæ˜¯å¦å­˜åœ¨ Leaderï¼Œå‡å¦‚å­˜åœ¨å°±è¿›è¡Œé€å‡ºï¼Œé€å‡ºä¹‹åå°± return äº†ï¼Œå› ä¸ºæ§åˆ¶å¾ªç¯ä¼šä¸æ–­è¿›å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¼šä¸æ–­æ£€æŸ¥ç›®æ ‡ Pod ä¸Šçš„ leader æ˜¯å¦é€å‡ºå®Œäº†ï¼Œä¸€æ—¦é€å‡ºå®Œæ¯•ï¼Œå°±ä¼šå¾€ä¸‹èµ°ï¼Œå°† partition - 1ï¼Œè®© k8s æŠŠç›®æ ‡ Pod å‡çº§åˆ°æ–°ç‰ˆæœ¬ï¼Œè¿™æ ·ä¸æ–­å¾ªç¯ï¼Œç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹åœ¨å‡çº§å‰éƒ½å·²ç»æ¸…å¹²å‡€äº† leaderï¼Œåšåˆ°ä¸šåŠ¡å®Œå…¨æ— æŸã€‚åç»­å‘¢ï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠè¿™ä¸ªåŠŸèƒ½æ”¾åˆ° ValidatingAdmissionWebhook ä¸Šæ¥å®ç°ï¼Œè¿™æ ·å‘¢ï¼Œå¯ä»¥åšåˆ°åŠŸèƒ½ä¸ controller å®Œå…¨æ­£äº¤ï¼Œå¤§å¤§æå‡å¯ç»´æŠ¤æ€§ï¼Œå…·ä½“çš„æ–¹æ¡ˆæˆ‘åœ¨ä¸ªäººåšå®¢é‡Œä¹Ÿæœ‰è®°å½• &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//aleiwu.com/post/tidb-opeartor-webhook/&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;aleiwu.com/post/tidb-op&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;eartor-webhook/&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt; (ä¸æ˜¯å¹¿å‘Šï¼ˆæ‰æ€ª ğŸ¤ª&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬åœ¨æ§åˆ¶å™¨é‡Œè¿˜æœ‰å¾ˆå¤šè¿™æ ·å’Œ TiDB æœ¬èº«çš„æ¶æ„å’Œç‰¹æ€§æ·±åº¦é›†æˆçš„åŠŸèƒ½è®¾è®¡ï¼Œæ‰€ä»¥å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œåšä¸€ä¸ª Operator çš„å‰ææ¡ä»¶æ˜¯è¦å¯¹ä½ è¦è¿ç»´çš„ç³»ç»Ÿæ¶æ„åšåˆ°äº†è‹¥æŒ‡æŒï¼Œç”šè‡³å¯¹æºç ä¹Ÿè¦æœ‰æ‰€äº†è§£ã€‚&lt;/p&gt;&lt;p&gt;è¯´äº†å¾ˆå¤šçš„ tidb-controller-managerï¼Œæœ€åè¯´ä¸€ä¸‹ tidb-schedulerï¼Œtidb-scheduler å…¶å®æ˜¯åˆ©ç”¨ k8s æœ¬èº«çš„è°ƒåº¦å™¨æ‰©å±•æœºåˆ¶å¼€å‘çš„ï¼Œæˆ‘ä»¬æŠŠ kube-scheduler å’Œ tidb-scheduler æ‰“åˆ°äº†ä¸€ä¸ª pod é‡Œï¼Œå¹¶ä¸”æ•´ä¸ªæ³¨å†Œä¸º â€tidb-schedulerâ€œï¼Œè¿™æ ·æ‰€æœ‰æ ‡è®°äº†ä½¿ç”¨è¯¥ schduler çš„ pod å°±èƒ½èµ°åˆ°æˆ‘ä»¬æ‰€å®šåˆ¶çš„è°ƒåº¦é€»è¾‘ã€‚&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-ad261d417077a8043d7b4c567b3ee49d_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1818&quot; data-rawheight=&quot;786&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1818&quot; data-original=&quot;https://pic2.zhimg.com/v2-ad261d417077a8043d7b4c567b3ee49d_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-ad261d417077a8043d7b4c567b3ee49d_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1818&quot; data-rawheight=&quot;786&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1818&quot; data-original=&quot;https://pic2.zhimg.com/v2-ad261d417077a8043d7b4c567b3ee49d_r.jpg&quot; data-actualsrc=&quot;https://pic2.zhimg.com/v2-ad261d417077a8043d7b4c567b3ee49d_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;è¿™é‡Œè®²ä¸€ä¸ªè°ƒåº¦ç­–ç•¥ä½œä¸ºä¾‹å­ï¼ŒPD çš„é«˜å¯ç”¨è°ƒåº¦ï¼ŒPD é‡Œå†…åµŒäº†ä¸€ä¸ª etcdï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªåŸºäº quorum çš„å…±è¯†ç³»ç»Ÿï¼Œéœ€è¦ majority ä¹Ÿå°±æ˜¯è¶…è¿‡ä¸€åŠçš„èŠ‚ç‚¹å­˜æ´»æ¥ä¿è¯å¯ç”¨æ€§ï¼Œæˆ‘ä»¬çš„è°ƒåº¦ç›®æ ‡å°±æ˜¯ä¸åœ¨ä¸€å°æœºå™¨ä¸Šéƒ¨ç½²è¶…è¿‡åŠæ•°çš„ PD èŠ‚ç‚¹ã€‚ä½ å¯èƒ½è®¤ä¸ºç”¨ inter-pod anti-affinity ä¹Ÿèƒ½å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œä½†å…¶å®ä¸æ˜¯è¿™æ ·çš„ã€‚&lt;/p&gt;&lt;p&gt;anti-affinity æœ‰ä¸¤ç§ï¼Œsoft å’Œ hardï¼Œå¯¹äº soft çš„åäº²å’Œæ€§ï¼Œå½“æ— æ³•æ»¡è¶³åäº²å’Œæ—¶ï¼ŒPod ä»ä¼šè¢«è°ƒåº¦åˆ°åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œ hard åˆ™ç¦æ­¢è¿™ç§æƒ…å†µå‡ºç°ã€‚æˆ‘ä»¬ä¸¾ä¸ªä¸€ä¸ªçœ‹çœ‹åäº²å’Œæ€§ä¸ºä»€ä¹ˆä¸èƒ½å®Œç¾æ»¡è¶³ quorum based çš„ç³»ç»Ÿè°ƒåº¦éœ€æ±‚ï¼š&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬å‡è®¾ç°åœ¨æœ‰ 3 ä¸ª nodeï¼Œ5 ä¸ª pd å®ä¾‹ï¼Œé‚£ä¹ˆä¸‹é¢è¿™æ ·çš„æ’å¸ƒæ˜¯èƒ½æ¥å—çš„ï¼š&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-65751c7a52f445794fb18b26ebe8baab_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1056&quot; data-rawheight=&quot;470&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1056&quot; data-original=&quot;https://pic4.zhimg.com/v2-65751c7a52f445794fb18b26ebe8baab_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-65751c7a52f445794fb18b26ebe8baab_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1056&quot; data-rawheight=&quot;470&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1056&quot; data-original=&quot;https://pic4.zhimg.com/v2-65751c7a52f445794fb18b26ebe8baab_r.jpg&quot; data-actualsrc=&quot;https://pic4.zhimg.com/v2-65751c7a52f445794fb18b26ebe8baab_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;ul&gt;&lt;li&gt;å‡å¦‚æˆ‘ä»¬ä½¿ç”¨ hard çš„åäº²å’Œæ€§ï¼Œè¿™ä¸ªæ‹“æ‰‘æ— æ³•æ¥å—ï¼›&lt;/li&gt;&lt;li&gt;å‡å¦‚æˆ‘ä»¬ä½¿ç”¨ soft çš„ fåäº²å’Œæ€§ï¼Œå‡è®¾ç°åœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆ Pod å°±ä¼šè½¬ç§»åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šï¼Œè¿™æ—¶å€™ç”±äº k8s æ²¡æœ‰ de-schedule æœºåˆ¶ï¼Œå³ä½¿æˆ‘ä»¬æ¢å¤äº†æŒ‚æ‰çš„èŠ‚ç‚¹ï¼Œé›†ç¾¤æ‹“æ‰‘ä¹Ÿä¸ä¼šè½¬ç§»å›æ¥ï¼›&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;é‚£ä¹ˆ tidb-scheduler ä¸­æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿç­–ç•¥ä¹Ÿå¾ˆç®€å•ï¼Œå¯¹äºæ¯ä¸ª Nodeï¼Œæˆ‘ä»¬å‡è®¾ Pod è°ƒåº¦åˆ°äº†ç›®æ ‡ Node ä¸Šï¼Œå†è®¡ç®—ä¸Šé¢çš„å®ä¾‹æ•°æ˜¯å¦å¤§äºä¸€åŠï¼Œå‡å¦‚æ˜¯çš„è¯ï¼Œå°±åœ¨ filter é˜¶æ®µå‰”é™¤è¿™ä¸ª Podã€‚ä½¿ç”¨äº†è¿™æ ·çš„ç­–ç•¥ä¹‹åï¼Œå¤§å®¶å¯ä»¥æ¨æ¼”ä¸€ä¸‹ï¼Œä¸Šé¢çš„æ‹“æ‰‘æ˜¯å¯ä»¥è°ƒåº¦å‡ºæ¥çš„ï¼Œè€Œä¸”å½“èŠ‚ç‚¹æŒ‚æ‰ä¹‹åï¼ŒPD å®ä¾‹ä¼š Pendingï¼Œä¸ä¼šå¸¦æ¥ä¸€ä¸ªå­˜åœ¨é£é™©çš„æ‹“æ‰‘ç»“æ„ã€‚&lt;/p&gt;&lt;p&gt;æ—¶é—´æœ‰é™ï¼Œåªèƒ½åˆ†äº«è¿™ä¹ˆå¤šäº†ã€‚æœ€åå‘¢ï¼Œæ˜¯ç”¨ operator ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨çš„ä¸€ç‚¹ç‚¹æ€»ç»“ï¼š&lt;/p&gt;&lt;p&gt;1.ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œå°½é‡å¤ç”¨ k8s åŸç”Ÿå¯¹è±¡ï¼›&lt;/p&gt;&lt;p&gt;2.ä½¿ç”¨ local pv å¿…é¡»åœ¨åº”ç”¨å±‚å®ç°æ•°æ®å†—ä½™ï¼›&lt;/p&gt;&lt;p&gt;3.operator è¦å°½å¯èƒ½å¤šåœ°å»ç»“åˆä¸šåŠ¡çŠ¶æ€ï¼Œé€šè¿‡ apiserver æ¨å¯¼å‡ºçš„ä¸šåŠ¡çŠ¶æ€åœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸‹æœªå¿…å‡†ç¡®ï¼›&lt;/p&gt;&lt;p&gt;4.ä¸è¦åªç€çœ¼äºè‡ªå®šä¹‰æ§åˆ¶å™¨ï¼Œk8s çš„æ‰©å±•ç‚¹è¿˜æœ‰å¾ˆå¤šï¼Œå–„åŠ åˆ©ç”¨èƒ½å¤Ÿå¤§å¹…é™ä½å¤æ‚åº¦ï¼›&lt;/p&gt;&lt;p&gt;æœ€åçš„æœ€åï¼ŒTiDB Operator &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-operator&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/tidb&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;-operator&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt; ä¹Ÿå³å°†åœ¨æœ¬æœˆ GA äº†ï¼Œè¿˜æœ‰å¾ˆå¤šæ¥ä¸åŠåˆ†äº«çš„ç‰¹æ€§ç­‰ç€å¤§å®¶ï¼Œæ¬¢è¿å¤§å®¶åˆ°æ—¶å€™å…³æ³¨ã€‚&lt;/p&gt;&lt;h2&gt;QA&lt;/h2&gt;&lt;p&gt;Q1ï¼šå‡çº§å¼€å§‹æ—¶ï¼Œpartition = èŠ‚ç‚¹æ•°-1ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„ Pod éƒ½ä¸å‡çº§,ä¸ºå•¥æ˜¯partition = èŠ‚ç‚¹æ•°-1ï¼Ÿ&lt;/p&gt;&lt;p&gt;Aï¼šè¿™é‡Œè¦çº é”™ä¸€ä¸‹ï¼Œæ˜¯ pod ordinal ä» 0 å¼€å§‹è®¡æ•°ï¼Œå¤§äºæˆ–ç­‰äº partition åºå·çš„ pod ä¼šè¢«å‡çº§ ï¼Œæ‰€ä»¥æœ€å¤§çš„åºå·æ˜¯èŠ‚ç‚¹æ•°-1ï¼Œæœ€å¼€å§‹çš„ partition æ˜¯ç­‰äºèŠ‚ç‚¹æ•°ï¼Œåˆ†äº«æ—¶è¡¨è¾¾é”™äº†ï¼ˆæˆ‘è‡ªå·±ä¹Ÿè®°é”™äº†ï¼‰ï¼ŒæŠ±æ­‰ğŸ˜…ï¼›&lt;/p&gt;&lt;p&gt;ï¼ˆè¿™é‡Œå…¶å®æ˜¯æˆ‘åœ¨åˆ†äº«æ—¶çŠ¯é”™äº†ï¼Œè™½ç„¶çœ‹åˆ°é—®é¢˜ååº”è¿‡æ¥äº†ï¼Œä½†è¿˜æ˜¯éå¸¸å°´å°¬ï¼Œæ„Ÿè§‰è‡ªå·±åƒä¸ªæ²™é›•ï¼‰&lt;/p&gt;&lt;p&gt;Q2ï¼šè¿˜æœ‰å°±æ˜¯é©±é€leaderæˆåŠŸäº†æ€ä¹ˆé˜²æ­¢è¦å‡çº§çš„podé‡æ–°è¢«é€‰ä¸ºleader&lt;/p&gt;&lt;p&gt;Aï¼šæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨ PD ä¸­æäº¤äº†ä¸€ä¸ªé©±é€ leader çš„ä»»åŠ¡ï¼ŒPD ä¼šæŒç»­ä¿è¯é©±é€å®Œæ¯•åæ²¡æœ‰æ–° leader è¿›æ¥ï¼Œç›´åˆ°å‡çº§å®Œæ¯•åï¼Œç”±æ§åˆ¶å™¨ç§»é™¤è¿™ä¸ªä»»åŠ¡ï¼›&lt;/p&gt;&lt;p&gt;Q3ï¼šé›†ç¾¤è§„æ¨¡å¤šå¤§ï¼Ÿå¤šå°‘ pod node ?&lt;/p&gt;&lt;p&gt;Aï¼šæˆ‘ä»¬åœ¨ Kubernetes ä¸Šå†…éƒ¨æµ‹è¯•çš„è§„æ¨¡è¾ƒå¤§çš„é›†ç¾¤æœ‰ 100 + TiKV èŠ‚ç‚¹ 50+ TiDB èŠ‚ç‚¹ï¼Œè€Œæ¯ä½ç ”å‘éƒ½ä¼šéƒ¨ç½²è‡ªå·±çš„é›†ç¾¤è¿›è¡Œæ€§èƒ½æµ‹è¯•æˆ–åŠŸèƒ½æµ‹è¯•ï¼›&lt;/p&gt;&lt;p&gt;Q4ï¼š è¯·é—®ä½ ä»¬å®ç°ç²¾å‡†ä¸‹çº¿æŸä¸€ä¸ªpod çš„åŠŸèƒ½äº†å˜›ï¼Œå› ä¸ºstatefulsetæ˜¯é¡ºåºçš„ï¼Ÿå¦‚ä½•å®ç°çš„ï¼Ÿå¯ä»¥åˆ†äº«ä¸‹æ€è·¯å˜›ï¼Ÿ &lt;/p&gt;&lt;p&gt;Aï¼šè¿™ä¸ªåŠŸèƒ½åœ¨ 1.0 ä¸­è¿˜æ²¡æœ‰å®ç°ï¼Œæˆ‘ä»¬è®¡åˆ’åœ¨ 1.1 ä¸­å®ç°è¿™ä¸ªç‰¹æ€§ã€‚&lt;/p&gt;&lt;p&gt;Q5ï¼šæƒ³äº†è§£ä¸‹æ•°æ®åº“å®¹å™¨åŒ–ï¼Œæ¨èä½¿ç”¨localpvå—ï¼Œæœ‰æ²¡æœ‰å“ªäº›å‘æˆ–æœ€ä½³å®è·µæ¨èï¼Ÿæˆ‘ä»¬åœ¨è€ƒè™‘mysqlæ•°æ®åº“å®¹å™¨åŒ–ä»¥åŠä¸­é—´ä»¶å®¹å™¨åŒ–ï¼Œæ˜¯é€‰æ‹©localpvè¿˜æ˜¯çº¿ä¸‹è‡ªå»ºcephé›†ç¾¤ï¼Ÿ&lt;/p&gt;&lt;p&gt;Aï¼šLocal PV å…¶å®ä¸æ˜¯ä¸€ä¸ªé€‰é¡¹ï¼Œè€Œæ˜¯ä¸€ä¸ªå¼ºåˆ¶å› ç´ ï¼Œå› ä¸ºç½‘ç»œç›˜çš„ IOPS æ˜¯è¾¾ä¸åˆ°åœ¨çº¿å­˜å‚¨åº”ç”¨çš„ç”Ÿäº§ç¯å¢ƒéœ€æ±‚çš„ï¼Œæˆ–è€…è¯´ä¸æ˜¯è¯´çº¿ä¸Šå®Œå…¨ä¸èƒ½ç”¨ï¼Œè€Œæ˜¯æ²¡æ³•æ”¯æ’‘å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ã€‚MySQL çš„è¿ç»´æˆ‘ç›¸å¯¹ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œå‡å¦‚ MM èƒ½å¤Ÿåšåˆ°åŒå‰¯æœ¬å†—ä½™å¼ºä¸€è‡´çš„è¯ï¼Œé‚£ç†è®ºä¸Šå°±èƒ½ç”¨ã€‚å¤§å¤šæ•°ä¸­é—´ä»¶æ¯”å¦‚ Kafkaã€Cassandra éƒ½æœ‰æ•°æ®å†—ä½™ï¼Œè¿™äº›ä½¿ç”¨ local pv åœ¨ç†è®ºä¸Šéƒ½æ˜¯æ²¡é—®é¢˜çš„ã€‚&lt;/p&gt;&lt;p&gt;Q6ï¼šçœ‹ä½ çš„æ–¹æ¡ˆæ„Ÿè§‰k8så’Œpdçš„é€»è¾‘ç»“åˆåœ¨ä¸€èµ·äº†ï¼ŒäºŒè€…ä¹‹é—´å¦‚ä½•äº’é€šï¼Ÿä¼šæœ‰ä»£ç äº’ç›¸ä¾µå…¥å—ï¼Ÿæ˜ç™½äº†ï¼Œå°±å¥½åƒé—®é¢˜2é©±é€é—®é¢˜ï¼Œpdæ”¶åˆ°é©±é€ä»»åŠ¡ï¼Œk8sæ§åˆ¶å™¨ä¸æ–­çš„æ£€æŸ¥æ˜¯å¦é©±é€æˆåŠŸï¼Œå¦‚æœæˆåŠŸå°±å¼€å§‹å‡çº§ï¼Œå¯¹å§ï¼Ÿ&lt;/p&gt;&lt;p&gt;Aï¼šè¿™å°±æ˜¯è‡ªå®šä¹‰æ§åˆ¶å™¨çš„ç»ä½³åœºæ™¯äº†ï¼Œk8s å’Œ pd æœ¬èº«å®Œå…¨æ²¡æœ‰äº¤äº’ï¼Œæ˜¯æ§åˆ¶å¾ªç¯åœ¨åŒæ­¥ä¸¤è¾¹çš„çŠ¶æ€ï¼Œä¸€æ–¹é¢æ§åˆ¶å¾ªç¯ä¼šæŠŠ PD è®°å½•çš„é›†ç¾¤çŠ¶æ€å¡åˆ° TidbCluster å¯¹è±¡çš„ status é‡Œé¢ï¼Œå¦ä¸€æ–¹é¢æ§åˆ¶å¾ªç¯åœ¨å°†å®é™…çŠ¶æ€å‘æœŸæœ›çŠ¶æ€è½¬ç§»æ—¶ï¼Œä¹Ÿä¼šç”Ÿæˆä¸€äº› PD çš„ä»»åŠ¡å’Œæ“ä½œå­ï¼ˆOpeartorï¼‰æäº¤åˆ° PD ä¸­æ¥è°ƒè°é›†ç¾¤çŠ¶æ€ã€‚&lt;/p&gt;&lt;h2&gt;æœ€å&lt;/h2&gt;&lt;p&gt;æœ€åå½“ç„¶æ˜¯æ‹›äººå•¦ï¼Œå‡å¦‚ä½ å¯¹æˆ‘ä»¬æ­£åœ¨åšçš„äº‹æƒ…æ„Ÿå…´è¶£ï¼Œæ— è®ºæ˜¯ Cloud ä¹Ÿå¥½æ•°æ®åº“ç ”å‘ä¹Ÿå¥½ï¼Œéƒ½ä»¥è”ç³» wuyelei@pingcap.com æŠ•é€’ç®€å†å‹¾æ­ã€‚&lt;/p&gt;</description>
<author>å´å¶ç£Š</author>
<guid isPermaLink="false">2019-07-23-74897388</guid>
<pubDate>Tue, 23 Jul 2019 00:00:00 +0800</pubDate>
</item>
<item>
<title>DM æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆåï¼‰æµ‹è¯•æ¡†æ¶çš„å®ç°</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-23-74873268.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/74873268&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-0e7419982b6c2b2cd4a4b4f88e89c20b_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;ä½œè€…ï¼šæ¨é&lt;/p&gt;&lt;p&gt;æœ¬æ–‡ä¸º DM æºç é˜…è¯»ç³»åˆ—æ–‡ç« çš„ç¬¬åç¯‡ï¼Œä¹‹å‰çš„æ–‡ç« å·²ç»è¯¦ç»†ä»‹ç»è¿‡ DM æ•°æ®åŒæ­¥å„ç»„ä»¶çš„å®ç°åŸç†å’Œä»£ç è§£æï¼Œç›¸ä¿¡å¤§å®¶å¯¹ DM çš„å®ç°ç»†èŠ‚å·²ç»æœ‰äº†æ·±å…¥çš„äº†è§£ã€‚æœ¬ç¯‡æ–‡ç« å°†ä»è´¨é‡ä¿è¯çš„è§’åº¦æ¥ä»‹ç» DM æµ‹è¯•æ¡†æ¶çš„è®¾è®¡å’Œå®ç°ï¼Œæ¢è®¨å¦‚ä½•é€šè¿‡å¤šç»´åº¦çš„æµ‹è¯•æ–¹æ³•ä¿è¯ DM çš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚&lt;/p&gt;&lt;h2&gt;æµ‹è¯•ä½“ç³»&lt;/h2&gt;&lt;p&gt;DM å®Œæ•´çš„æµ‹è¯•ä½“ç³»åŒ…æ‹¬ä»¥ä¸‹å››ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;&lt;h3&gt;1. å•å…ƒæµ‹è¯•&lt;/h3&gt;&lt;p&gt;ä¸»è¦ç”¨äºæµ‹è¯•æ¯ä¸ª go æ¨¡å—å’Œå…·ä½“å‡½æ•°å®ç°çš„æ­£ç¡®æ€§ï¼Œæµ‹è¯•ç”¨ä¾‹ç¼–å†™å’Œæµ‹è¯•è¿è¡Œæ–¹å¼ä¾ç…§ go å•å…ƒæµ‹è¯•çš„æ ‡å‡†ï¼Œæµ‹è¯•ä»£ç è·Ÿéšé¡¹ç›®æºä»£ç ä¸€èµ·å‘å¸ƒã€‚å…·ä½“æµ‹è¯•ç”¨ä¾‹ç¼–å†™ä½¿ç”¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/check&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;pingcap/check&lt;/a&gt; å·¥å…·åŒ…ï¼Œè¯¥å·¥å…·åŒ…æ˜¯åœ¨ go åŸç”Ÿæµ‹è¯•å·¥å…·åŸºç¡€ä¸Šè¿›è¡Œçš„æ‰©å±•ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/check/blob/67f458068fc864dabf17e38d4d337f28430d13ed/run.go%23L98-L131&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æŒ‰ç…§ suite åˆ†ç»„è¿›è¡Œæµ‹è¯•&lt;/a&gt;ï¼Œæä¾›åŒ…æ‹¬æ›´ä¸°å¯Œçš„æ£€æµ‹è¯­æ³•ç³–ã€å¹¶è¡Œæµ‹è¯•ã€åºåˆ—åŒ–æµ‹è¯•åœ¨å†…çš„ä¸€äº›æ‰©å±•ç‰¹æ€§ã€‚å•å…ƒæµ‹è¯•çš„è®¾è®¡å‡ºå‘ç‚¹æ˜¯ç™½ç›’æµ‹è¯•ï¼Œæµ‹è¯•ç”¨ä¾‹ä¸­é€šè¿‡å°½å¯èƒ½æ˜ç¡®çš„æµ‹è¯•è¾“å…¥å¾—åˆ°æœŸæœ›çš„æµ‹è¯•è¾“å‡ºã€‚&lt;/p&gt;&lt;h3&gt;2. é›†æˆæµ‹è¯•&lt;/h3&gt;&lt;p&gt;ç”¨äºæµ‹è¯•å„ä¸ªç»„ä»¶ä¹‹é—´äº¤äº’çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ•°æ®åŒæ­¥æµç¨‹çš„æ­£ç¡®æ€§ï¼Œå®Œæ•´çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/tree/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/tests&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æµ‹è¯•ç”¨ä¾‹é›†åˆå’Œæµ‹è¯•å·¥å…·åœ¨é¡¹ç›®ä»£ç çš„ tests ç›®å½•&lt;/a&gt; å‘å¸ƒã€‚é›†æˆæµ‹è¯•é¦–å…ˆè‡ªå®šä¹‰äº†ä¸€äº› &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/tree/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/tests/_utils&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM åŸºç¡€æµ‹è¯•å·¥å…·é›†&lt;/a&gt;ï¼ŒåŒ…æ‹¬å¯åŠ¨ DM ç»„ä»¶ï¼Œç”Ÿæˆã€å¯¼å…¥æµ‹è¯•æ•°æ®ï¼Œæ£€æµ‹åŒæ­¥çŠ¶æ€ã€ä¸Šä¸‹æ¸¸æ•°æ®ä¸€è‡´æ€§ç­‰ bash è„šæœ¬ï¼Œæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒæ­¥åœºæ™¯ï¼Œé€šè¿‡è„šæœ¬å®ç°æ•°æ®å‡†å¤‡ã€å¯åŠ¨ DM é›†ç¾¤ã€æ¨¡æ‹Ÿä¸Šæ¸¸æ•°æ®è¾“å…¥ã€ç‰¹å®šå¼‚å¸¸å’Œæ¢å¤ã€æ•°æ®åŒæ­¥æ ¡éªŒç­‰æµ‹è¯•æµç¨‹ã€‚é›†æˆæµ‹è¯•çš„è®¾è®¡å‡ºå‘ç‚¹æ˜¯ç¡®å®šæ€§çš„æ¨¡æ‹Ÿæµ‹è¯•åœºæ™¯ï¼Œä¸ºäº†èƒ½å¤Ÿç¡®å®šæ€§çš„æ¨¡æ‹Ÿä¸€äº›ç‰¹å®šçš„åŒæ­¥åœºæ™¯ï¼Œä¸ºæ­¤æˆ‘ä»¬è¿˜å¼•å…¥äº† &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/failpoint&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;failpoint&lt;/a&gt; æ¥æ³¨å…¥æµ‹è¯•ã€æ§åˆ¶æµ‹è¯•æµç¨‹ï¼Œ ä»¥åŠ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/tree/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/pkg/tracing&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;trace&lt;/a&gt; æœºåˆ¶æ¥æ›´å‡†ç¡®åœ°è·å–ç¨‹åºå†…å­˜çŠ¶æ€ã€è¾…åŠ©æ§åˆ¶æµ‹è¯•æµç¨‹ï¼Œå…·ä½“çš„å®ç°ç»†èŠ‚ä¼šåœ¨åæ–‡è¯¦ç»†ä»‹ç»ã€‚&lt;/p&gt;&lt;h3&gt;3. ç ´åæ€§æµ‹è¯•&lt;/h3&gt;&lt;p&gt;çœŸå®çš„è½¯ä»¶è¿è¡Œç¯å¢ƒä¸­ä¼šé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜ï¼ŒåŒ…æ‹¬å„ç±»ç¡¬ä»¶æ•…éšœã€ç½‘ç»œå»¶è¿Ÿå’Œéš”ç¦»ã€èµ„æºä¸è¶³ç­‰ç­‰ã€‚DM åœ¨æ•°æ®åŒæ­¥è¿‡ç¨‹ä¸­ä¹ŸåŒæ ·ä¼šé‡åˆ°è¿™äº›é—®é¢˜ï¼Œå€ŸåŠ©äº &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//thenewstack.io/chaos-tools-and-techniques-for-testing-the-tidb-distributed-newsql-database/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;PingCAP å†…éƒ¨çš„è‡ªåŠ¨åŒ–æ··æ²Œæµ‹è¯•å¹³å° schrodinger&lt;/a&gt;ï¼Œæˆ‘ä»¬è®¾è®¡äº†å¤šä¸ªç ´åæ€§æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒ…æ‹¬åœ¨åŒæ­¥è¿‡ç¨‹ä¸­éšæœº kill DM-worker èŠ‚ç‚¹ï¼ŒåŒæ­¥è¿‡ç¨‹ä¸­é‡å¯éƒ¨åˆ† DM-worker èŠ‚ç‚¹ï¼Œåˆ†å‘ä¸å…¼å®¹ DDL è¯­å¥ç­‰æµ‹è¯•åœºæ™¯ã€‚è¿™ä¸€ç±»æµ‹è¯•çš„å…³æ³¨ç‚¹æ˜¯åœ¨å„ç±»ç ´åæ€§æ“ä½œä¹‹åæ•°æ®åŒæ­¥èƒ½å¦æ­£å¸¸æ¢å¤ä»¥åŠéªŒè¯åœ¨è¿™äº›åœºæ™¯ä¸‹æ•°æ®ä¸€è‡´æ€§çš„ä¿è¯ï¼Œæµ‹è¯•ç”¨ä¾‹é€šå¸¸ä»¥é»‘ç›’çš„å½¢å¼å»è¿è¡Œï¼Œå¹¶ä¸”é•¿æœŸã€åå¤åœ°è¿›è¡Œæµ‹è¯•ã€‚&lt;/p&gt;&lt;h3&gt;4. ç¨³å®šæ€§æµ‹è¯•&lt;/h3&gt;&lt;p&gt;ç›®å‰è¯¥ç±»æµ‹è¯•è¿è¡Œåœ¨ PingCAP å†…éƒ¨çš„ K8s é›†ç¾¤ä¸Šï¼Œé€šå¸¸æ¯ä¸ªæµ‹è¯•çš„åº”ç”¨è§„æ¨¡ä¼šæ¯”è¾ƒå¤§ï¼Œè­¬å¦‚æœ‰ä¸€äº› 100+ ä¸Šæ¸¸å®ä¾‹ï¼Œ300+ åˆ†åº“åˆ†è¡¨åˆå¹¶çš„æµ‹è¯•åœºæ™¯ï¼Œæ•°æ®è´Ÿè½½ä¹Ÿä¼šç›¸å¯¹è¾ƒé«˜ï¼Œç›®æ ‡åœ¨äºæµ‹è¯•å¤§è§„æ¨¡ DM é›†ç¾¤åœ¨é«˜è´Ÿè½½ä¸‹é•¿æœŸè¿è¡Œçš„ç¨³å®šæ€§ã€‚è¯¥ç±»æµ‹è¯•ä¹Ÿå±äºé»‘ç›’æµ‹è¯•ï¼Œæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹å†…ä¼šæ ¹æ®ä»»åŠ¡é…ç½®å¯åŠ¨ä¸Šæ¸¸çš„ MySQL é›†ç¾¤ã€DM é›†ç¾¤ã€ä¸‹æ¸¸ TiDB é›†ç¾¤å’Œæ•°æ®å¯¼å…¥é›†ç¾¤ã€‚ä¸Šæ¸¸æ•°æ®è¾“å…¥å·¥å…·æœ‰å¤šç§ï¼ŒåŒ…æ‹¬ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/amyangfei/data-dam&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;éšæœº DML ç”Ÿæˆå·¥å…·&lt;/a&gt;ï¼Œschrodinger æµ‹è¯•ç”¨ä¾‹é›†ç­‰ã€‚å…·ä½“çš„æµ‹è¯• case å’Œ K8s éƒ¨ç½²è„šæœ¬å¯ä»¥åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/csuzhangxc/dm-k8s&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;dm-K8s ä»“åº“&lt;/a&gt; æ‰¾åˆ°ã€‚&lt;/p&gt;&lt;h3&gt;5. æµ‹è¯•æ–¹æ³•å¯¹æ¯”&lt;/h3&gt;&lt;p&gt;æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹çš„è¡¨æ ¼å¯¹æ¯”ä¸åŒæµ‹è¯•ç»´åº¦åœ¨æµ‹è¯•ä½“ç³»ä¸­å‘æŒ¥çš„ä½œç”¨å’Œå®ƒä»¬ä¹‹é—´çš„äº’è¡¥æ€§ã€‚&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-147a4197ffd090538bcfe391be1b116e_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1220&quot; data-rawheight=&quot;926&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1220&quot; data-original=&quot;https://pic3.zhimg.com/v2-147a4197ffd090538bcfe391be1b116e_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-147a4197ffd090538bcfe391be1b116e_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1220&quot; data-rawheight=&quot;926&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1220&quot; data-original=&quot;https://pic3.zhimg.com/v2-147a4197ffd090538bcfe391be1b116e_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-147a4197ffd090538bcfe391be1b116e_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;h2&gt;æµ‹è¯• case ä¸æµ‹è¯•å·¥å…·çš„å®ç° &lt;/h2&gt;&lt;h3&gt;1. åœ¨å•å…ƒæµ‹è¯•ä¸­è¿›è¡Œ mock&lt;/h3&gt;&lt;p&gt;æˆ‘ä»¬åœ¨å•å…ƒæµ‹è¯•è¿è¡Œè¿‡ç¨‹ä¸­å¸Œæœ›å°½é‡å‡å°‘å¤–éƒ¨ç¯å¢ƒæˆ–å†…éƒ¨ç»„ä»¶çš„ä¾èµ–ï¼Œè­¬å¦‚æµ‹è¯• relay æ¨¡å—æ—¶æˆ‘ä»¬å¹¶ä¸å¸Œæœ›ä»ä¸Šæ¸¸çš„ MySQL æ‹‰å– binlogï¼Œæˆ–è€…æµ‹è¯•åˆ°ä¸‹æ¸¸çš„ä¸€äº›æ•°æ®åº“è¯»å†™æ“ä½œå¹¶ä¸å¸Œæœ›çœŸæ­£éƒ¨ç½²ä¸€ä¸ªä¸‹æ¸¸ TiDBï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦å¯¹æµ‹è¯• case è¿›è¡Œé€‚å½“çš„ mockã€‚åœ¨å•å…ƒæµ‹è¯•ä¸­é’ˆå¯¹ä¸åŒçš„åœºæ™¯é‡‡ç”¨äº†å¤šç§ mock æ–¹æ¡ˆã€‚æ¥ä¸‹æ¥æˆ‘ä»¬é€‰å–å‡ ç§å…·æœ‰ä»£è¡¨æ€§çš„æ–¹æ¡ˆè¿›è¡Œä»‹ç»ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Mock golang interface&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨ golang ä¸­åªè¦è°ƒç”¨è€…æœ¬èº«å®ç°äº†æ¥å£çš„å…¨éƒ¨æ–¹æ³•ï¼Œå°±é»˜è®¤å®ç°äº†è¯¥æ¥å£ï¼Œè¿™ä¸€ç‰¹æ€§ä½¿å¾—ä½¿ç”¨æ¥å£æ–¹æ³•è°ƒç”¨çš„ä»£ç å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼Œå¯¹äºæµ‹è¯•ä¹Ÿæä¾›äº†å¤©ç„¶çš„ mock æ–¹æ³•ã€‚ä»¥ worker å†…éƒ¨å„ subtask çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/worker/subtask_test.go%23L258&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ä»»åŠ¡æš‚åœã€æ¢å¤çš„æµ‹è¯•ç”¨ä¾‹&lt;/a&gt; ä¸ºä¾‹ï¼Œæµ‹è¯•è¿‡ç¨‹ä¸­ä¼šæ¶‰åŠåˆ° dump unit å’Œ load unit çš„è¿è¡Œã€å‡ºé”™ã€æš‚åœå’Œæ¢å¤ç­‰æ“ä½œã€‚æˆ‘ä»¬å®šä¹‰ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/worker/subtask_test.go%23L67-L76&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;MockUnit&lt;/a&gt; å¹¶ä¸”å®ç°äº† &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/unit/unit.go%23L24&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;unit interface&lt;/a&gt; çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/worker/subtask_test.go%23L86-L124&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å…¨éƒ¨æ–¹æ³•&lt;/a&gt;ï¼Œå°±å¯ä»¥åœ¨å•å…ƒæµ‹è¯•é‡Œæ¨¡æ‹Ÿä»»åŠ¡ä¸­ unit çš„å„ç±»æ“ä½œã€‚è¿˜å¯ä»¥å®šä¹‰ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/worker/subtask_test.go%23L126-L143&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å„ç±»æ³¨å…¥å‡½æ•°&lt;/a&gt;ï¼Œå®ç°æ§åˆ¶æŸäº›é€»è¾‘æµç¨‹ä¸­çš„å‡ºé”™æµ‹è¯•å’Œæ‰§è¡Œè·¯å¾„æ§åˆ¶ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;è‡ªå®šä¹‰ binlog ç”Ÿæˆå·¥å…·&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨å‰æ–‡å·²ç»ä»‹ç»è¿‡ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/dm-source-code-reading-6/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;relay å¤„ç†å•å…ƒä»ä¸Šæ¸¸è¯»å– binlog å¹¶å†™å…¥æœ¬åœ°æ–‡ä»¶&lt;/a&gt; çš„å®ç°ç»†èŠ‚ï¼Œè¿™ä¸€è¿‡ç¨‹é‡åº¦ä¾èµ–äº MySQL binlog çš„å¤„ç†å’Œè§£æã€‚ä¸ºäº†åœ¨å•å…ƒæµ‹è¯•ä¸­å®Œå–„æ¨¡æ‹Ÿ binlog æ•°æ®æµï¼ŒDM ä¸­å®ç°äº†ä¸€ä¸ª &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/tree/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/pkg/binlog/event&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;binlog ç”Ÿæˆå·¥å…·&lt;/a&gt;ï¼Œè¯¥å·¥å…·åŒ…æä¾›äº†é€šç”¨çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/pkg/binlog/event/generator.go%23L25&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;generator&lt;/a&gt; ç”¨äºè¿ç»­ç”Ÿæˆ Event ä»¥åŠç›¸å¯¹åº•å±‚çš„ç”Ÿæˆç‰¹å®š Event çš„æ¥å£ï¼Œæ”¯æŒ MySQL å’Œ MariaDB ä¸¤ç§æ•°æ®åº“çš„ binlog åè®®ã€‚generator æä¾›çš„ç”Ÿæˆæ¥å£ä¼šè¿”å›ä¸€ä¸ª go-mysql çš„ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/siddontang/go-mysql/blob/7ed1210c02a2867a8d4570f526422af9fcd4246b/replication/event.go%23L25&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;BinlogEvent&lt;/a&gt;&lt;/code&gt; åˆ—è¡¨å’Œ binlog å¯¹åº”çš„ byte æ•°ç»„ï¼ŒåŒæ—¶åœ¨ generator ä¸­è‡ªåŠ¨æ›´æ–° binlog ä½ç½®ä¿¡æ¯å’Œ &lt;code&gt;GTID&lt;/code&gt; ä¿¡æ¯ã€‚ç±»ä¼¼çš„ï¼Œæ›´åº•å±‚çš„ç”Ÿæˆ Event æ¥å£ä¼šè¦æ±‚æä¾›æ•°æ®ç±»å‹ã€&lt;code&gt;serverID&lt;/code&gt;ã€&lt;code&gt;latestPos&lt;/code&gt;ã€&lt;code&gt;latestGTID&lt;/code&gt; ä»¥åŠå¯èƒ½éœ€è¦çš„åº“åã€è¡¨åã€SQL è¯­å¥ç­‰ä¿¡æ¯ï¼Œç”Ÿæˆçš„ç»“æœæ˜¯ä¸€ä¸ª &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/pkg/binlog/event/common.go%23L28&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DDLDMLResult&lt;/a&gt;&lt;/code&gt; å¯¹è±¡ã€‚&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬é€šè¿‡æµ‹è¯•ä¸­çš„ä¸€ä¸ª case æ¥äº†è§£å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼Œä»¥ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L370&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;relay æ¨¡å—è¯»å–åˆ°å¤šä¸ª binlog event å†™å…¥æ–‡ä»¶çš„æ­£ç¡®æ€§æµ‹è¯•&lt;/a&gt; è¿™ä¸ª case ä¸ºä¾‹ï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=h%3Ccode%3Ettps%3A//g%3C/code%3Ei%3Ccode%3Ethub%3C/code%3E.co%3Ccode%3Em/p%3C/code%3Eingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L371-L387&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;é¦–å…ˆé…ç½®æ•°æ®åº“ç±»å‹ï¼ŒserverIDï¼ŒGTID å’Œ XID ç›¸å…³ä¿¡æ¯ï¼Œåˆå§‹åŒ– relay log å†™å…¥ç›®å½•å’Œæ–‡ä»¶å&lt;/a&gt;&lt;/li&gt;&lt;li&gt;ref=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L390&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/dm/b&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;lob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go#L390&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&amp;#34;&amp;gt;åˆå§‹åŒ– allEvents æ•°ç»„ï¼Œç”¨äºæ¨¡æ‹Ÿä»ä¸Šæ¸¸æ¥æ”¶åˆ°çš„ &lt;code&gt;replication.BinlogEvent&lt;/code&gt;ï¼›ref=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L391&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/dm/b&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;lob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go#L391&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&amp;#34;&amp;gt;åˆå§‹åŒ– allDataï¼Œ&lt;code&gt;allData&lt;/code&gt; å­˜å‚¨ binlog binary æ•°æ®ï¼Œç”¨äºåç»­ relay log å†™å…¥çš„éªŒè¯ï¼›ref=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L392&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/dm/b&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;lob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go#L392&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&amp;#34;&amp;gt;åˆå§‹åŒ– generator&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=http%3Ccode%3Es%3A//github.co%3C/code%3Em/ping%3Ccode%3Ecap/dm/blob/7cba6d21d78%3C/code%3Edd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L396&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;é€šè¿‡ generator GenFileHeader æ¥å£ç”Ÿæˆ replication.BinlogEvent å’Œ binlog æ•°æ®&lt;/a&gt;ï¼ˆå¯¹åº”çš„ binlog ä¸­åŒ…å« &lt;code&gt;FormatDescriptionEvent&lt;/code&gt; å’Œ &lt;code&gt;PreviousGTIDsEvent&lt;/code&gt;ï¼‰ã€‚ç”Ÿæˆçš„ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github%3C/code%3E.com/%3Ccode%3Epingcap/d%3C/code%3Em/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L398&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;replication.BinlogEvent ä¿å­˜åˆ° allEvents&lt;/a&gt;ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=http%3Ccode%3Es%3A//git%3C/code%3Ehub.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L399&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;binlog æ•°æ®ä¿å­˜åˆ° allData&lt;/a&gt;ã€‚&lt;/code&gt;&lt;/li&gt;&lt;li&gt;æŒ‰ç…§ 3 çš„æ“ä½œæµç¨‹åˆ†åˆ«href=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//gi&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;gi&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;code&gt;thub.com/pin&lt;/code&gt;gcap/&lt;code&gt;dm/blo&lt;/code&gt;b/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go#L402-L421&amp;#34;&amp;gt;ç”Ÿæˆ CREATE DATABASEï¼ŒCREATE TABLE å’Œä¸€æ¡ INSERT è¯­å¥å¯¹åº”çš„ event/binlog æ•°æ®å¹¶ä¿å­˜&lt;/li&gt;&lt;li&gt;href=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/dm/&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;code&gt;blob/7cba6d21d78dd16e9a&lt;/code&gt;b159e9c0300efcbdeb1e4a/relay/writer/file_test.go#L424-L430&amp;#34;&amp;gt;åˆ›å»º relay.FileWriterï¼ŒæŒ‰ç…§é¡ºåºè¯»å– 3, 4 æ­¥éª¤ä¸­ä¿å­˜çš„ replication.BinlogEventï¼Œå‘é…ç½®çš„ relay log æ–‡ä»¶ä¸­å†™å…¥ relay log&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.%3Ccode%3Ecom/pin%3C/code%3Egcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L432&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æ£€æŸ¥ relay log æ–‡ä»¶å†™å…¥çš„æ•°æ®é•¿åº¦ä¸ allData å­˜å‚¨çš„æ•°æ®é•¿åº¦ç›¸åŒ&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.%3Ccode%3Ecom/pin%3C/code%3Egcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/relay/writer/file_test.go%23L435-L438&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;è¯»å– relay log æ–‡ä»¶ï¼Œæ£€æŸ¥æ•°æ®å†…å®¹å’Œ allData å­˜å‚¨çš„æ•°æ®å†…å®¹ç›¸åŒ&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;è‡³æ­¤æˆ‘ä»¬å°±ç»“åˆ binlog ç”Ÿæˆå·¥å…·å®Œæˆäº†ä¸€ä¸ª relay æ¨¡å—çš„æµ‹è¯• caseã€‚ç›®å‰ DM å·²ç»åœ¨å¾ˆå¤š case ä¸­ä½¿ç”¨ binlog ç”Ÿæˆå·¥å…·æ¨¡æ‹Ÿç”Ÿæˆ binlogï¼Œä»ç„¶å­˜åœ¨çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/syncer/syncer_test.go&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å°‘é‡ case&lt;/a&gt; ä¾èµ–ä¸Šæ¸¸æ•°æ®åº“ç”Ÿæˆ binlogï¼Œæˆ‘ä»¬å·²ç»è®¡åˆ’å€ŸåŠ© binlog ç”Ÿæˆå·¥å…·ç§»é™¤è¿™äº›å¤–éƒ¨ä¾èµ–ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;å…¶ä»– mock å·¥å…·&lt;/b&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;åœ¨éªŒè¯æ•°æ®åº“è¯»å†™æ“ä½œé€»è¾‘æ­£ç¡®æ€§çš„æµ‹è¯•ä¸­ï¼Œä½¿ç”¨äº† &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/DATA-DOG/go-sqlmock&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;go-sqlmock&lt;/a&gt; æ¥ mock sql driver çš„è¡Œä¸ºã€‚&lt;/li&gt;&lt;li&gt;åœ¨éªŒè¯ gRPC äº¤äº’é€»è¾‘çš„æ­£ç¡®æ€§æµ‹è¯•ä¸­ï¼Œä½¿ç”¨äº† &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/golang/mock&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å®˜æ–¹æä¾›çš„ mock å·¥å…·&lt;/a&gt;ï¼Œé’ˆå¯¹ gRPC æ¥å£ç”Ÿæˆ mock æ–‡ä»¶ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæµ‹è¯• gRPC æ¥å£å’Œåº”ç”¨é€»è¾‘çš„æ­£ç¡®æ€§ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;h3&gt;2. é›†æˆæµ‹è¯•çš„æ–¹æ³•å’Œç›¸å…³å·¥å…·&lt;/h3&gt;&lt;p&gt;&lt;b&gt;Trace ä¿¡æ¯æ”¶é›†&lt;/b&gt;&lt;/p&gt;&lt;p&gt;DM å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„ä¿¡æ¯ trace æ”¶é›†å·¥å…·ï¼Œå…¶è®¾è®¡ç›®æ ‡æ˜¯åœ¨ DM è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡å¢åŠ ä»£ç å†…éƒ¨çš„åŸ‹ç‚¹ï¼Œå®šæœŸæ”¶é›†ç³»ç»Ÿè¿è¡Œæ—¶çš„å„ç±»ä¿¡æ¯ã€‚trace å·¥å…·åŒ…å«ä¸€ä¸ªæä¾› gRPC ä¸ŠæŠ¥ä¿¡æ¯æ¥å£å’Œ HTTP æ§åˆ¶æ¥å£çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/tree/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/tracer&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;tracer æœåŠ¡å™¨&lt;/a&gt; å’Œæä¾›åŸ‹ç‚¹ä»¥åŠåå°æ”¶é›†ä¿¡æ¯ä¸Šä¼ åŠŸèƒ½çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/tree/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/pkg/tracing&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;tracing åŒ…&lt;/a&gt;ã€‚tracing æ¨¡å—ä¸Šä¼ åˆ° tracer æœåŠ¡å™¨çš„äº‹ä»¶æ•°æ®é€šè¿‡ &lt;code&gt;protobuf&lt;/code&gt; è¿›è¡Œå®šä¹‰ï¼Œ&lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/proto/tracer_base.proto%23L11-L18&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;BaseEvent&lt;/a&gt;&lt;/code&gt; å®šä¹‰äº†æœ€åŸºæœ¬çš„ trace äº‹ä»¶ï¼ŒåŒ…å«äº†è¿è¡Œä»£ç æ–‡ä»¶åã€ä»£ç è¡Œã€äº‹ä»¶æ—¶é—´æˆ³ã€äº‹ä»¶ IDã€äº‹ä»¶ç»„ ID å’Œäº‹ä»¶ç±»å‹ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„äº‹ä»¶éœ€è¦åŒ…å« &lt;code&gt;BaseEvent&lt;/code&gt;ã€‚tracing æ¨¡å—ä¼š &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/pkg/tracing/tracer.go%23L129&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å®šæœŸå‘ tracer æœåŠ¡å™¨åŒæ­¥å…¨å±€æ—¶é—´æˆ³&lt;/a&gt;ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¿è¯å¤šèŠ‚ç‚¹ä¸åŒçš„ trace äº‹ä»¶ä¼šä¿æŒå¤§è‡´çš„æ—¶é—´é¡ºåºï¼ˆæ³¨æ„è¿™é‡Œå¹¶ä¸æ˜¯ä¸¥æ ¼çš„æ—¶é—´åºï¼Œä¼šä¾èµ–äºæ¯åˆ†é’Ÿå†…æœ¬åœ°æ—¶é’Ÿçš„å‡†ç¡®æ€§ï¼Œä»ç„¶æœ‰å„ç§å‡ºç°ä¹±åºçš„å¯èƒ½ï¼‰ã€‚è®¾è®¡ tracing æ¨¡å—çš„ä¸»è¦ç›®çš„æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;å¯¹äºåŒä¸€ä¸ª DM ç»„ä»¶ï¼ˆDM-master/DM-workerï¼‰ï¼Œå¸Œæœ›è®°å½•ä¸€äº›é‡è¦å†…å­˜ä¿¡æ¯çš„æ•°æ®æµå†å²ã€‚ä¾‹å¦‚åœ¨ binlog replication å¤„ç†å•å…ƒå¤„ç†ä¸€æ¡ query event è¿‡ç¨‹ä¸­ä¼šç»å†å¤„ç† binlog event ã€ç”Ÿæˆ ddl jobã€æ‰§è¡Œ job è¿™ä¸‰ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬å°†è¿™ä¸‰ä¸ªå¤„ç†é€»è¾‘æŠ½è±¡ä¸ºä¸‰ä¸ªäº‹ä»¶ï¼Œä¸‰ä¸ªäº‹ä»¶åœ¨æ—¶é—´ä¸Šæ˜¯æœ‰å…ˆåå…³ç³»çš„ï¼Œåœ¨é€»è¾‘ä¸Šå…³è”äº†åŒä¸€ä¸ª binlog çš„å¤„ç†æµç¨‹ï¼Œåœ¨ DM ä¸­è®°å½•è¿™ä¸‰ä¸ªäº‹ä»¶çš„ trace event æ—¶ä½¿ç”¨äº†åŒä¸€ä¸ª &lt;code&gt;traceID&lt;/code&gt;ï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/syncer/syncer.go%23L1597&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å¤„ç† binlog event ç”Ÿæˆä¸€ä¸ªæ–°çš„ traceID&lt;/a&gt;ï¼Œè¯¥ &lt;code&gt;traceID&lt;/code&gt; è®°å½•åœ¨ ddl job ä¸­ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/syncer/syncer.go%23L688&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;åˆ†å‘ ddl job æ—¶è®°å½•çš„ trace äº‹ä»¶ä¼šå¤ç”¨æ­¤ traceID&lt;/a&gt;ï¼›&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cb%3Ccode%3Ea6d21d7%3C/code%3E8dd16e9ab159e9c0300efcbdeb1e4a/syncer/syncer.go%23L864&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;åœ¨ executor ä¸­æœ€åæ‰§è¡Œ ddl job çš„è¿‡ç¨‹ä¸­è®°å½•çš„ trace äº‹ä»¶ä¹Ÿä¼šå¤ç”¨æ­¤ traceID&lt;/a&gt;ï¼‰ï¼Œè¿™æ ·å°±å°†ä¸‰ä¸ªäº‹ä»¶å…³è”èµ·æ¥ï¼Œå› ä¸ºåœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œä»–ä»¬çš„æ—¶é—´æˆ³çœŸå®åæ˜ äº†æ—¶é—´ç»´åº¦ä¸Šçš„é¡ºåºå…³ç³»ã€‚&lt;/li&gt;&lt;li&gt;ç”±äº DM æä¾›äº† shard DDL çš„æœºåˆ¶ï¼Œå¤šä¸ª DM-worker ä¹‹é—´çš„æ•°æ®ä¼šå­˜åœ¨å…³è”ï¼Œè­¬å¦‚åœ¨è¿›è¡Œ shard DDL çš„è¿‡ç¨‹ä¸­ï¼Œå¤„äºåŒä¸€ä¸ª shard group å†…çš„å¤šä¸ª DM-worker çš„ DDL æ˜¯å…³è”åœ¨ä¸€èµ·çš„ã€‚&lt;code&gt;BaseEvent&lt;/code&gt; å®šä¹‰ä¸­çš„ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/proto/tracer_base.proto%23L16&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;groupID&lt;/a&gt;&lt;/code&gt; å­—æ®µå°±æ˜¯ç”¨æ¥è§£å†³å¤šè¿›ç¨‹é—´ trace äº‹ä»¶å…³è”æ€§çš„é—®é¢˜ï¼Œå®šä¹‰å…·æœ‰ç›¸åŒ &lt;code&gt;groupID&lt;/code&gt; çš„äº‹ä»¶å±äºåŒä¸€ä¸ªäº‹ä»¶ç»„ï¼Œè¡¨ç¤ºå®ƒä»¬ä¹‹é—´åœ¨é€»è¾‘ä¸Šæœ‰ä¸€å®šå…³è”æ€§ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ shard DDL è¿™ä¸ªåœºæ™¯ä¸‹ï¼ŒDM-master åè°ƒ shard DDL æ—¶ä¼šåˆ†åˆ« &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/master/server.go%23L1423-L1432&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å‘ DDL owner åˆ†å‘æ‰§è¡Œ SQL çš„è¯·æ±‚&lt;/a&gt;ï¼Œä»¥åŠ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/dm/master/server.go%23L1457-L1466&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å‘é owner åˆ†å‘å¿½ç•¥ DDL çš„è¯·æ±‚&lt;/a&gt;ï¼Œåœ¨è¿™ä¸¤ç»„è¯·æ±‚ä¸­æºå¸¦äº†ç›¸åŒçš„ &lt;code&gt;groupID&lt;/code&gt;ï¼Œbinlog replication åˆ†å‘ ddl job æ—¶ä¼šè·å–åˆ° &lt;code&gt;groupID&lt;/code&gt;ï¼Œè¿™æ ·å°±å°†ä¸åŒè¿›ç¨‹é—´ shard DDL çš„æ‰§è¡Œå…³è”äº†èµ·æ¥ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ”¶é›†çš„ trace ä¿¡æ¯è¾…åŠ©éªŒè¯æ•°æ®åŒæ­¥çš„æ­£ç¡®æ€§ã€‚è­¬å¦‚åœ¨ href=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/tree/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/tests/safe_mode&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/dm/t&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;ree/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/tests/safe_mode&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&amp;#34;&amp;gt;éªŒè¯ safe_mode é€»è¾‘æ­£ç¡®æ€§çš„æµ‹è¯• ä¸­ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=http%3Ccode%3Es%3A//githu%3C/code%3Eb.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/tests/safe_mode/run.sh%23L35&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æˆ‘ä»¬å°† DM å¯åŠ¨é˜¶æ®µçš„ safe_mode æ—¶é—´è°ƒçŸ­ä¸º 0s&lt;/a&gt;ï¼ŒæœŸæœ›éªŒè¯å¯¹äºä¸Šæ¸¸ update æ“ä½œäº§ç”Ÿçš„ binlogï¼Œå¦‚æœè¯¥æ“ä½œå‘ç”Ÿæ—¶ä¸Šä¸‹æ¸¸ shard DDL æ²¡æœ‰å®Œå…¨åŒæ­¥ï¼Œé‚£ä¹ˆåŒæ­¥è¯¥ binlog æ—¶çš„ &lt;code&gt;safe_mode&lt;/code&gt; ä¸º trueï¼›åä¹‹å¦‚æœè¯¥æ“ä½œå‘ç”Ÿæ—¶ä¸Šä¸‹æ¸¸æ²¡æœ‰è¿›è¡Œ shard DDL æˆ– shard DDL å·²ç»åŒæ­¥ï¼Œé‚£ä¹ˆ &lt;code&gt;safe_mode&lt;/code&gt; ä¸º falseã€‚é€šè¿‡ trace æœºåˆ¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“ä» &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/tests/_dmctl_tools/check_safe_mode.go%23L42-L55&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;tracer server çš„æ¥å£è·å–æµ‹è¯•è¿‡ç¨‹ä¸­çš„æ‰€æœ‰äº‹ä»¶ä¿¡æ¯&lt;/a&gt;ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/tests/_dmctl_tools/check_safe_mode.go%23L123-L133&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å¹¶ä¸”æŠ½å–å‡º update DMLï¼ŒDDL ç­‰å¯¹åº”çš„ trace event ä¿¡æ¯&lt;/a&gt;ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=htt%3Ccode%3Eps%3A//gith%3C/code%3Eub.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/tests/_dmctl_tools/check_safe_mode.go%23L167-L180&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;è¿›ä¸€æ­¥é€šè¿‡è¿™äº›ä¿¡æ¯éªŒè¯ safe_mode åœ¨ shard DDL åŒæ­¥åœºæ™¯ä¸‹å·¥ä½œçš„æ­£ç¡®æ€§&lt;/a&gt;ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Failpoint çš„ä½¿ç”¨&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨é›†æˆæµ‹è¯•ä¸­ï¼Œä¸ºäº†å¯¹ç‰¹å®šçš„åŒæ­¥æµç¨‹æˆ–è€…ç‰¹å®šçš„é”™è¯¯ä¸­æ–­åšç¡®å®šæ€§æµ‹è¯•ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ªåä¸º &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/failpoint&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;failpoint&lt;/a&gt; çš„é¡¹ç›®ï¼Œç”¨æ¥åœ¨ä»£ç ä¸­æ³¨å…¥ç‰¹å®šçš„é”™è¯¯ã€‚ç°é˜¶æ®µ DM é›†æˆæµ‹è¯•çš„ case éƒ½æ˜¯ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/7cba6d21d78dd16e9ab159e9c0300efcbdeb1e4a/tests/safe_mode/run.sh%23L35-L38&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æå‰è®¾å®šç¯å¢ƒå˜é‡ï¼Œç„¶åå¯åŠ¨ DM ç›¸å…³è¿›ç¨‹æ¥æ§åˆ¶æ³¨å…¥ç‚¹çš„ç”Ÿæ•ˆä¸å¦&lt;/a&gt;ã€‚ç›®å‰æˆ‘ä»¬æ­£åœ¨æ¢ç´¢å°† trace å’Œ failpoint ç»“åˆçš„æ–¹æ¡ˆï¼Œé€šè¿‡ trace è·å–è¿›ç¨‹å†…éƒ¨çŠ¶æ€ï¼Œå€ŸåŠ© failpoint æä¾›çš„ http æ¥å£åŠ¨æ€è°ƒæ•´æ³¨å…¥ç‚¹ï¼Œä»¥å®ç°æ›´æ™ºèƒ½ã€æ›´é€šç”¨çš„é”™è¯¯æ³¨å…¥æµ‹è¯•ã€‚&lt;/p&gt;&lt;h3&gt;3. ç ´åæ€§æµ‹è¯•å’Œå¤§è§„æ¨¡æµ‹è¯•çš„åŸç†ä¸å±•æœ›&lt;/h3&gt;&lt;p&gt;&lt;b&gt;ç ´åæ€§æµ‹è¯•ä¸­çš„é”™è¯¯æ³¨å…¥&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç›®å‰ç ´åæ€§æµ‹è¯•çš„æµ‹è¯• case å¹¶æ²¡æœ‰å¯¹å¤–å¼€æºï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä»‹ç» DM ç ´åæ€§æµ‹è¯•ä¸­æ‰€ä½¿ç”¨çš„éƒ¨åˆ†æ•…éšœæ³¨å…¥&lt;/p&gt;&lt;ul&gt;&lt;li&gt;ä½¿ç”¨ &lt;code&gt;kill -9&lt;/code&gt; å¼ºåˆ¶ç»ˆæ­¢ DM-worker è¿›ç¨‹ï¼Œæˆ–è€…ä½¿ç”¨ &lt;code&gt;kill&lt;/code&gt; æ¥ä¼˜é›…åœ°ç»ˆæ­¢è¿›ç¨‹ï¼Œç„¶åé‡æ–°å¯åŠ¨&lt;/li&gt;&lt;li&gt;æ¨¡æ‹Ÿä¸Šæ¸¸å†™å…¥ TiDB ä¸å…¼å®¹çš„ DDLï¼Œé€šè¿‡ &lt;code&gt;sql-skip/sql-replace&lt;/code&gt; è·³è¿‡æˆ–æ›¿æ¢ä¸å…¼å®¹ DDL æ¢å¤åŒæ­¥çš„åœºæ™¯&lt;/li&gt;&lt;li&gt;æ¨¡æ‹Ÿä¸Šæ¸¸å‘ç”Ÿä¸»ä»åˆ‡æ¢æ—¶ DM è¿›è¡Œä¸»ä»åˆ‡æ¢å¤„ç†çš„æ­£ç¡®æ€§&lt;/li&gt;&lt;li&gt;æ¨¡æ‹Ÿä¸‹æ¸¸ TiDB/TiKV æ•…éšœä¸å¯å†™å…¥çš„åœºæ™¯&lt;/li&gt;&lt;li&gt;æ¨¡æ‹Ÿç½‘ç»œå‡ºç°ä¸¢åŒ…æˆ–é«˜å»¶è¿Ÿçš„åœºæ™¯&lt;/li&gt;&lt;li&gt;åœ¨æœªæ¥ DM æä¾›é«˜å¯ç”¨æ”¯æŒä¹‹åï¼Œè¿˜ä¼šå¢åŠ æ›´å¤šçš„é«˜å¯ç”¨ç›¸å…³æµ‹è¯•åœºæ™¯ï¼Œè­¬å¦‚ç£ç›˜ç©ºé—´å†™æ»¡ã€DM-worker èŠ‚ç‚¹å®•æœºè‡ªåŠ¨æ¢å¤ç­‰&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;b&gt;å¤§è§„æ¨¡æµ‹è¯•&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å¤§è§„æ¨¡æµ‹è¯•ä¸­çš„ä¸Šæ¸¸è´Ÿè½½å¤ç”¨äº†å¾ˆå¤šåœ¨ TiDB ä¸­çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè­¬å¦‚é“¶è¡Œè½¬è´¦ã€å¤§è§„æ¨¡ DDL æ“ä½œç­‰æµ‹è¯•åœºæ™¯ã€‚è¯¥æµ‹è¯•æ‰€æœ‰ case å‡è¿è¡Œåœ¨ K8s ä¸­ï¼ŒåŸºäº K8s deployment yaml éƒ¨ç½²ä¸€ç³»åˆ—çš„ statefusetï¼Œé€šè¿‡ &lt;code&gt;configmap&lt;/code&gt; ä¼ é€’æ‹“æ‰‘ä¿¡æ¯ã€‚ç›®å‰ DM æ­£åœ¨è§„åˆ’å®ç° DM-operator ä»¥åŠè¿è¡Œäº K8s ä¹‹ä¸Šçš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œé¢„æœŸåœ¨æœªæ¥å¯ä»¥æ›´ä¾¿æ·åœ°éƒ¨ç½²åœ¨ K8s ç¯å¢ƒä¸Šï¼Œåç»­çš„å¤§è§„æ¨¡æµ‹è¯•ä¹Ÿä¼šåŸºäºæ­¤ç»§ç»­å±•å¼€ã€‚&lt;/p&gt;&lt;h2&gt;æ€»ç»“&lt;/h2&gt;&lt;p&gt;æœ¬ç¯‡æ–‡ç« è¯¦ç»†åœ°ä»‹ç»äº† DM çš„æµ‹è¯•ä½“ç³»ï¼Œæµ‹è¯•ä¸­ä½¿ç”¨åˆ°çš„å·¥å…·å’Œä¸€äº› case çš„å®ä¾‹åˆ†æï¼Œåˆ†æå¦‚ä½•é€šè¿‡å¤šç»´åº¦çš„æµ‹è¯•ä¿è¯ DM çš„æ­£ç¡®æ€§ã€ç¨³å®šæ€§ã€‚ç„¶è€Œå°½ç®¡å·²ç»æœ‰äº†å¦‚æ­¤å¤šçš„æµ‹è¯•ï¼Œæˆ‘ä»¬ä»ä¸èƒ½ä¿è¯ bug freeï¼Œä¹Ÿä¸èƒ½ä¿è¯æµ‹è¯• case å¯¹äºå„ç±»åœºæ™¯å’Œé€»è¾‘è·¯å¾„è¿›è¡Œäº†ç™¾åˆ†ä¹‹ç™¾çš„è¦†ç›–ï¼Œå¯¹äºæµ‹è¯•æ–¹æ³•å’Œæµ‹è¯• case çš„å®Œå–„ä»éœ€è¦ä¸æ–­çš„æ¢ç´¢ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;è‡³æ­¤ DM çš„æºç é˜…è¯»ç³»åˆ—å°±æš‚æ—¶å‘Šä¸€æ®µè½äº†ï¼Œä½†æ˜¯ DM è¿˜åœ¨ä¸æ–­åœ°å‘å±•æ¼”åŒ–ï¼ŒDM ä¸­é•¿æœŸçš„è§„åˆ’ä¸­æœ‰å¾ˆå¤šæ¿€åŠ¨äººå¿ƒçš„æ”¹åŠ¨å’Œä¼˜åŒ–ï¼Œè­¬å¦‚é«˜å¯ç”¨æ–¹æ¡ˆçš„è½åœ°ã€DM on K8sã€å®æ—¶æ•°æ®æ ¡éªŒã€æ›´æ˜“ç”¨çš„æ•°æ®è¿ç§»å¹³å°ç­‰ï¼ˆæœªæ¥å¯¹äº DM çš„ä¸€äº›æ–°ç‰¹æ€§å¯èƒ½ä¼šæœ‰ç•ªå¤–ç¯‡ï¼‰ã€‚å¸Œæœ›æ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥æŒç»­å…³æ³¨ DM çš„å‘å±•ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æä¾›æ”¹è¿›çš„å»ºè®®å’Œæ&lt;/b&gt; &lt;b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/pulls&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;PR&lt;/a&gt;ã€‚&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;åŸæ–‡é˜…è¯»ï¼š&lt;/b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/dm-source-code-reading-10/&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://www.&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;pingcap.com/blog-cn/dm-&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;source-code-reading-10/&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;æ›´å¤š DM æºç é˜…è¯»ï¼š&lt;/b&gt;&lt;/p&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/%23DM-%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg&quot; data-image-width=&quot;1200&quot; data-image-height=&quot;1200&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Blog-cns | PingCAP&lt;/a&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2019-07-23-74873268</guid>
<pubDate>Tue, 23 Jul 2019 00:00:00 +0800</pubDate>
</item>
<item>
<title>PingCAP å”åˆ˜ï¼šå¦‚ä½•åˆ©ç”¨æ··æ²Œå·¥ç¨‹æ‰“é€ å¥å£®çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Ÿ</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-22-74717464.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/74717464&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-a888a9babe11aed8a2c5f839eb3c8092_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;ä½œè€…ï¼šèµµé’°è¹&lt;/p&gt;&lt;p&gt;&lt;i&gt;æœ¬æ–‡è½¬è½½äº InfoQã€‚&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;i&gt;åŸæ–‡é“¾æ¥ï¼š&lt;/i&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.infoq.cn/article/EEKM947YbboGtD_zQuLw&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://www.&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;infoq.cn/article/EEKM94&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;7YbboGtD_zQuLw&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;blockquote&gt;ä½œä¸ºæ··æ²Œå·¥ç¨‹çš„é‡è¦æ¨åŠ¨è€…ï¼ŒNetflix åœ¨æ··æ²Œå·¥ç¨‹æ‰‹å†Œï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.infoq.cn/article/AsN34J2T9QDXB0s-t9JN&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://www.&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;infoq.cn/article/AsN34J&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;2T9QDXB0s-t9JN&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;ï¼‰ä¸­è°ˆåˆ°ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œè½¯ä»¶éªŒè¯çš„æƒ³æ³•é€šå¸¸ä¼šè¢«å˜²ç¬‘ã€‚è¿‡å»ï¼Œè¿™å¥è¯åŸºæœ¬éƒ½è¢«ç¿»è¯‘ä¸ºâ€œæˆ‘ä»¬åœ¨å‘å¸ƒä¹‹å‰ä¸æ‰“ç®—å®Œå–„åœ°éªŒè¯è¿™äº›ä»£ç â€ã€‚åœ¨ç»å…¸çš„æµ‹è¯•é“¾è·¯ä¸­ï¼Œå¯»æ‰¾è½¯ä»¶ç¼ºé™·çš„æ™®éä¿¡æ¡æ˜¯ç¦»ç”Ÿäº§ç¯å¢ƒè¶Šè¿œè¶Šå¥½ã€‚ä¾‹å¦‚ï¼Œåœ¨å•å…ƒæµ‹è¯•ä¸­å‘ç°ç¼ºé™·è¦æ¯”åœ¨é›†æˆæµ‹è¯•ä¸­å‘ç°æ›´å¥½ï¼Œè¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šç¦»ç”Ÿäº§ç¯å¢ƒè¶Šè¿œï¼Œæˆ–è€…æ˜¯ç¦»å‘å¸ƒè¶Šè¿œçš„æ—¶å€™ï¼Œå‘ç°çš„ç¼ºé™·å°±è¶Šå®¹æ˜“è¢«æ‰¾åˆ°æ ¹æœ¬åŸå› å¹¶å½»åº•ä¿®å¤ã€‚&lt;br/&gt;å¯¹äºæ··æ²Œå·¥ç¨‹è€Œè¨€ï¼Œæ•´ä¸ªé“¾è·¯åˆšå¥½åè¿‡æ¥ï¼šåœ¨ç¦»ç”Ÿäº§ç¯å¢ƒè¶Šè¿‘çš„åœ°æ–¹è¿›è¡Œå®éªŒè¶Šå¥½ï¼Œç†æƒ³çš„å®è·µå°±æ˜¯ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ‰§è¡Œã€‚å¯¹äºè½¯ä»¶å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œæœ€éš¾çš„è«è¿‡äºï¼Œç³»ç»Ÿç”¨æˆ·æ°¸è¿œä¸ä¼šå¦‚é¢„æœŸé‚£æ ·ä¸ç³»ç»Ÿè¿›è¡Œäº¤äº’ï¼Œæ··æ²Œå·¥ç¨‹æ˜¯è§£å†³è¿™ä¸€é—®é¢˜çš„ç†æƒ³æ–¹æ³•ï¼Œå¯ä»¥è®©å¼€å‘è€…äº†è§£é™¤ä»£ç ä¹‹å¤–ï¼Œæ•´ä¸ªç³»ç»Ÿå…¶ä»–æ–¹é¢çš„æƒ…å†µï¼Œç‰¹åˆ«æ˜¯çŠ¶æ€ã€è¾“å…¥ã€ä»¥åŠç¬¬ä¸‰æ–¹ç³»ç»Ÿå¯¼è‡´çš„éš¾ä»¥é¢„è§çš„è¡Œä¸ºã€‚&lt;/blockquote&gt;&lt;p&gt;&lt;b&gt;æ®äº†è§£ï¼Œåœ¨ TiDB çš„ç ”å‘åˆæœŸï¼ŒPingCAP å°±å¼•å…¥äº†æ··æ²Œå·¥ç¨‹ï¼Œä»¥æ­¤ä¿è¯ TiDB åœ¨å„ç§æç«¯æƒ…å†µä¸‹çš„ç¨³å®šæ€§ã€‚åœ¨ ArchSummit å…¨çƒæ¶æ„å¸ˆå³°ä¼šï¼ˆæ·±åœ³ç«™ï¼‰2019 å¤§ä¼šæœŸé—´ï¼ŒInfoQ å°±æ··æ²Œå·¥ç¨‹ç†å¿µåŠå®è·µè¿™ä¸€è¯é¢˜é‡‡è®¿äº† PingCAP é¦–å¸­æ¶æ„å¸ˆ &lt;/b&gt;&lt;a class=&quot;member_mention&quot; href=&quot;https://www.zhihu.com/people/df9ec6a48ca50364852daa71b20a6192&quot; data-hash=&quot;df9ec6a48ca50364852daa71b20a6192&quot; data-hovercard=&quot;p$b$df9ec6a48ca50364852daa71b20a6192&quot;&gt;@å”åˆ˜&lt;/a&gt;&lt;b&gt; ï¼Œä»¥æ­¤äº†è§£ PingCAP çš„å®è·µå†ç¨‹ã€‚&lt;/b&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-3f06f4ce9ef11ea8e6f94d5a5dfd60e8_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;720&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1080&quot; data-original=&quot;https://pic1.zhimg.com/v2-3f06f4ce9ef11ea8e6f94d5a5dfd60e8_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-3f06f4ce9ef11ea8e6f94d5a5dfd60e8_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;720&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1080&quot; data-original=&quot;https://pic1.zhimg.com/v2-3f06f4ce9ef11ea8e6f94d5a5dfd60e8_r.jpg&quot; data-actualsrc=&quot;https://pic1.zhimg.com/v2-3f06f4ce9ef11ea8e6f94d5a5dfd60e8_b.jpg&quot;/&gt;&lt;figcaption&gt;å”åˆ˜ï¼ŒPingCAP é¦–å¸­æ¶æ„å¸ˆï¼Œä¸»è¦è´Ÿè´£åˆ†å¸ƒå¼ Key-Value æ•°æ®åº“ TiKV çš„ç ”å‘å·¥ä½œï¼Œä¹Ÿä¼šæŠ˜è…¾ä¸‹ TiDB æ•´ä¸ªäº§å“çš„æµ‹è¯•ï¼Œå·¥å…·å¼€å‘ç­‰å·¥ä½œã€‚&lt;/figcaption&gt;&lt;/figure&gt;&lt;h2&gt;&lt;b&gt;æ··æ²Œå·¥ç¨‹ä¸åˆ†å¸ƒå¼ç³»ç»Ÿ&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;ç†è§£æ˜¯å®è·µçš„å‰æä¹‹ä¸€ï¼Œå”åˆ˜åœ¨é‡‡è®¿ä¸­å¦è¨€ï¼Œæ··æ²Œå·¥ç¨‹è¿™ä¸ªåå­—æ¯”è¾ƒå®¹æ˜“è®©äººå›°æƒ‘ï¼ŒåŒ…æ‹¬å…¶è‹±æ–‡â€œChaos Engineeringâ€ï¼Œåˆæ¬¡å¬åˆ°è¿™ä¸ªå•è¯æ—¶ç¡®å®ä¸å¤ªå¥½ç†è§£ã€‚&lt;b&gt;å”åˆ˜è¡¨ç¤ºï¼šâ€œæœ€å¼€å§‹ï¼Œæˆ‘å°±æ˜¯æŠŠå®ƒå½“æˆä¸€ç§æ³¨å…¥æµ‹è¯•çš„æ–¹æ³•ï¼Œåæ¥æ‰å‘ç°è¿™å…¶å®æ˜¯ä¸€é—¨å·¥ç¨‹å­¦ç§‘ï¼Œé€šè¿‡å®éªŒçš„æ–¹å¼å‘ç°é—®é¢˜å¹¶è§£å†³é—®é¢˜ã€‚â€&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å…¶å®ï¼Œæ··æ²Œå·¥ç¨‹çš„ç†å¿µå¾ˆæ—©ä¹‹å‰å°±å­˜åœ¨ï¼Œå”åˆ˜è¡¨ç¤ºï¼Œè¿‡å»ä½¿ç”¨çš„é”™è¯¯æ³¨å…¥å°±å¯ä»¥ç†è§£ä¸ºæ··æ²Œå·¥ç¨‹çš„ä¸€ç§è¡¨ç°æ–¹å¼ï¼Œåªä¸è¿‡ Netflix å°†å…¶æç‚¼å‡ºæ¥å˜æˆäº†é€šç”¨å‡†åˆ™ï¼Œåªè¦ç…§ç€ç›¸å…³æ–¹æ³•å°±èƒ½å®æ–½æ··æ²Œå·¥ç¨‹ï¼Œè€Œè¿™ä¸€æŠ€æœ¯è¯ç”Ÿä¹‹é™…å°±ä¸åˆ†å¸ƒå¼ç³»ç»Ÿå¯†åˆ‡ç›¸å…³ï¼Œåœ¨ã€ŠChaos Engineeringã€‹ä¸€ä¹¦ä¸­æ˜¯è¿™æ ·è¡¨è¿°çš„ï¼š&lt;/p&gt;&lt;blockquote&gt;æ··æ²Œå·¥ç¨‹æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸Šè¿›è¡Œå®éªŒçš„å­¦ç§‘ , ç›®çš„æ˜¯å»ºç«‹å¯¹ç³»ç»ŸæŠµå¾¡ç”Ÿäº§ç¯å¢ƒä¸­å¤±æ§æ¡ä»¶çš„èƒ½åŠ›ä»¥åŠä¿¡å¿ƒ ã€‚&lt;br/&gt;æ³¨ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿå°±æ˜¯ï¼Œå…¶ä¸­æœ‰å°ä½ æ ¹æœ¬ä¸çŸ¥é“çš„æœºå™¨æ•…éšœäº†ï¼Œæœ‰å¯èƒ½ä¼šè®©ä½ è‡ªå·±çš„æœåŠ¡ä¹Ÿæ•…éšœã€‚â€”â€”Leslie Lamport&lt;/blockquote&gt;&lt;p&gt;å³ä½¿å¯é¢„è§æ‰€æœ‰åœ¨æ§åˆ¶èŒƒå›´å†…ç³»ç»Ÿçš„çŠ¶æ€ï¼Œä¹Ÿæ€»æ˜¯ä¼šå‡ºç°æ„å¤–æƒ…å†µï¼Œæ¯”å¦‚ç³»ç»Ÿä¾é çš„æŸäº›å¤–éƒ¨æœåŠ¡çªå‘å®•æœºï¼Œè¿™åœ¨ç³»ç»Ÿæ¬è¿ä¸Šäº‘åå°¤ä¸ºæ˜æ˜¾ï¼Œäº‘æœåŠ¡ä¹Ÿå¹¶ä¸æ€»æ˜¯ç¨³å®šå¯é çš„ã€‚é‡‡è®¿ä¸­ï¼Œå”åˆ˜è§£é‡Šé“ï¼Œæ··æ²Œå·¥ç¨‹ä¸»è¦æ˜¯è§£å†³å¸¸è§„æµ‹è¯•ä¸èƒ½è¦†ç›–çš„é—®é¢˜ã€‚å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œå› ä¸ºå…¶å¼‚å¸¸çš„å¤æ‚æ€§ï¼ŒåŠ ä¸Šé”™è¯¯å¯èƒ½åœ¨ä»»ä½•æ—¶å€™ã€ä»»ä½•åœ°ç‚¹å‘ç”Ÿï¼Œä¼—å¤šå¸¸è§„æµ‹è¯•æ–¹æ³•å¹¶ä¸èƒ½ä¿è¯ç³»ç»Ÿæ­£ç¡®ã€‚&lt;/p&gt;&lt;p&gt;å½“ç„¶ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œå®è·µæ˜¯éå¸¸å›°éš¾ä¸”ä¸å¯ç”¨çš„ï¼Œæ¯”å¦‚å°†å¹²æ‰°ç›´æ¥æ³¨å…¥åˆ°è¡Œé©¶ä¸­çš„è‡ªåŠ¨é©¾é©¶æ±½è½¦çš„ä¼ æ„Ÿå™¨ä¸Šï¼Œè¿™æ˜¯æ¯”è¾ƒå±é™©çš„ï¼Œä½†å¤§éƒ¨åˆ†ç”¨æˆ·åº”è¯¥éƒ½ä¸æ˜¯åœ¨æ“ä½œè¿™ç±»ç”Ÿæ­»æ”¸å…³çš„ç³»ç»Ÿã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;ç›¸æ¯”è¾ƒè€Œè¨€ï¼Œå”åˆ˜è®¤ä¸ºæ··æ²Œå·¥ç¨‹æ¯”è¾ƒé€‚åˆå¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ã€‚&lt;/b&gt;æ­¤å¤–ï¼Œå¦‚æœä¸šåŠ¡å¯¹æ•…éšœå®¹é”™æœ‰æ‰€æ‰¿è¯ºï¼Œä¹Ÿéœ€è¦é€šè¿‡æ··æ²Œå·¥ç¨‹éªŒè¯ç³»ç»Ÿæ˜¯å¦å¯ä»¥æ”¯æŒå®¹é”™ã€‚é‡åŒ–åˆ°å…·ä½“æŒ‡æ ‡æ¥çœ‹ï¼Œå¦‚æœå¼€å‘äººå‘˜ç¡®å®šç³»ç»Ÿä¼šå®•æœºå¹¶ä¸”æ¸…æ¥šå®•æœºä¹‹åä¼šé€ æˆè¾ƒå¤§æŸå¤±ï¼Œå¯ä»¥é€šè¿‡â€œæ”¯æŒå¿«é€Ÿç»ˆæ­¢å®éªŒâ€å’Œâ€œæœ€å°åŒ–å®éªŒé€ æˆçš„â€˜çˆ†ç‚¸åŠå¾„â€™â€ç­‰æ–¹å¼å®æ–½æ··æ²Œå·¥ç¨‹ã€‚&lt;/p&gt;&lt;p&gt;å½“æ‰§è¡Œä»»ä½•æ··æ²Œå·¥ç¨‹å®éªŒå‰ï¼Œåº”è¯¥å…ˆæœ‰ä¸€ä¸ªç”¨æ¥ç«‹å³ç»ˆæ­¢å®éªŒçš„â€œçº¢è‰²æŒ‰é’®â€ï¼Œæ›´å¥½çš„æ–¹æ³•åˆ™æ˜¯è‡ªåŠ¨åŒ–è¯¥åŠŸèƒ½ï¼Œå½“å…¶ç›‘æµ‹åˆ°å¯¹ç¨³å®šçŠ¶æ€æœ‰æ½œåœ¨å±å®³æ—¶ç«‹å³è‡ªåŠ¨ç»ˆæ­¢å®éªŒã€‚ç¬¬äºŒä¸ªç­–ç•¥æ¶‰åŠåœ¨è®¾è®¡å®éªŒæ—¶ï¼Œè€ƒè™‘ä»å®éªŒä¸­è·å¾—æœ‰æ„ä¹‰ç»“è®ºçš„åŒæ—¶ï¼Œå…¼é¡¾æœ€å°åŒ–å®éªŒå¯èƒ½é€ æˆçš„æ½œåœ¨å±å®³ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;æ— è®ºæ˜¯æ¶æ„å¸ˆã€å¼€å‘äººå‘˜è¿˜æ˜¯æµ‹è¯•äººå‘˜ï¼Œå”åˆ˜éƒ½å»ºè®®å…³æ³¨è¿™ä¸€æŠ€æœ¯ï¼Œè¿™ç›¸å½“äºä»å¦ä¸€ä¸ªè§†è§’å®¡è§†ç³»ç»Ÿï¼Œå°¤å…¶æ˜¯å¯¹å¼€å‘è€…è€Œè¨€ã€‚å”åˆ˜è¡¥å……é“ï¼Œå¼€å‘ä¸€ä¸ªä¼˜ç§€çš„ç³»ç»Ÿå¹¶ä¸åªæ˜¯å†™ä»£ç å°±è¶³å¤Ÿäº†ï¼Œæµ‹è¯•ä¸åº”è¯¥ä»…ä»…ä¾é æµ‹è¯•äººå‘˜ï¼Œä»–ä¸€ç›´ç›¸ä¿¡ï¼š&lt;/b&gt;&lt;/p&gt;&lt;blockquote&gt;&lt;b&gt;ä¼˜ç§€çš„å¼€å‘è€…ä¸€å®šæ˜¯ä¼˜ç§€çš„æµ‹è¯•äººå‘˜ã€‚&lt;/b&gt;&lt;/blockquote&gt;&lt;h2&gt;&lt;b&gt;PingCAP æ··æ²Œå·¥ç¨‹å®è·µ&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;å¦‚ä¸Šæ–‡æ‰€è¨€ï¼Œåœ¨å¼€å§‹ç ”å‘ TiDB æ—¶ï¼ŒPingCAP å°±å†³å®šå¼•å…¥æ··æ²Œå·¥ç¨‹ï¼Œåº”è¯¥ç®—æ˜¯å›½å†…åƒèƒèŸ¹çš„å›¢é˜Ÿä¹‹ä¸€ã€‚è°ˆåˆ°å½“åˆçš„å¼•å…¥åŸå› ï¼Œå”åˆ˜è¡¨ç¤ºï¼Œèµ·åˆå¼€å‘åˆ†å¸ƒå¼æ•°æ®åº“æ—¶ï¼Œæ•´ä¸ªå›¢é˜Ÿå¾ˆè‡ªç„¶å°±æƒ³åˆ°éœ€è¦ä¿è¯å¼€å‘çš„æ•°æ®åº“èƒ½å¤Ÿè®©ç”¨æˆ·æ”¾å¿ƒä½¿ç”¨ï¼Œè¿™å°±éœ€è¦è¿›è¡Œå„ç§å„æ ·çš„æµ‹è¯•ã€‚å½“æ—¶ï¼ŒNetflix å¼€å‘çš„ Chaos Monkey å·²ç»éå¸¸çŸ¥åï¼Œå¾—ç›Šäº Netflix æˆåŠŸçš„éƒ¨ç½²ç»éªŒï¼ŒPingCAP å›¢é˜Ÿæƒ³åˆ°åˆ©ç”¨è¯¥å·¥å…·è§£å†³ç¨³å®šæ€§é—®é¢˜ã€‚&lt;/p&gt;&lt;p&gt;å›é¡¾æ•´ä¸ªå®è·µå†ç¨‹ï¼Œå”åˆ˜è¡¨ç¤ºå¤§æ¦‚å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯ 2017 å¹´ä¹‹å‰ï¼Œé‚£æ—¶å¹¶æ²¡æœ‰è‡ªåŠ¨åŒ–çš„æ¦‚å¿µï¼Œæ‰€æœ‰å®éªŒå…¨éƒ¨éœ€è¦æ‰‹åŠ¨å®Œæˆï¼ŒåŒ…æ‹¬ç”³è¯·æœºå™¨ã€æ‰‹åŠ¨éƒ¨ç½²ç­‰ã€‚è™½ç„¶æ¯”è¾ƒç¹çï¼Œä½†ä¹Ÿåœ¨ç³»ç»Ÿä¸Šçº¿ä¹‹å‰å‘ç°äº†ä¸å°‘é—®é¢˜ã€‚&lt;/p&gt;&lt;p&gt;ç¬¬äºŒä¸ªé˜¶æ®µæ˜¯ä» 2017 å¹´åˆ° 2019 å¹´åˆï¼ŒPingCAP åŸºäº K8s æ­å»ºäº†ä¸€å¥—è‡ªåŠ¨åŒ– chaos æ¡†æ¶ï¼Œå«åš Schrodingerï¼Œè¿™å¥—ç³»ç»Ÿæå¤§æå‡äº†æ•´ä½“ç”Ÿäº§åŠ›ï¼Œåªéœ€è‡ªå®šä¹‰è¦åšçš„å®éªŒï¼ŒSchrodinger å°±èƒ½æå®šã€‚&lt;/p&gt;&lt;p&gt;ç¬¬ä¸‰ä¸ªé˜¶æ®µåˆ™æ˜¯ 2019 å¹´åˆè‡³ä»Šï¼ŒPingCAP ä¸€ç›´åœ¨åš Schrodinger Cloudï¼ŒSchrodinger ä¸»è¦æ˜¯ä¸ºæµ‹è¯• TiDBï¼Œä¹Ÿå¯ç”¨æ¥æµ‹è¯• TiDB çš„å‘¨è¾¹å·¥å…·ï¼Œç”šè‡³æ˜¯åˆä½œä¼™ä¼´çš„ä¸šåŠ¡ã€‚é¢å¯¹è¿™äº›éœ€æ±‚ï¼ŒPingCAP è€ƒè™‘åŸºäº K8s åšä¸€å¥—æ›´åŠ é€šç”¨çš„ Chaos æ¡†æ¶ï¼Œé‡‡ç”¨ Operator çš„æ–¹å¼ï¼Œä»»ä½• Chaos åœ¨ K8s é‡Œé¢éƒ½æ˜¯ CRDï¼Œç”¨æˆ·åªéœ€è¦å®šä¹‰å¥½è‡ªå·±çš„ CRDï¼ŒSchrodinger å°±å¯ä»¥è‡ªåŠ¨å®Œæˆåç»­äº‹å®œã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;åœ¨å¼€å‘æ··æ²Œå·¥ç¨‹å®éªŒæ—¶ï¼Œå”åˆ˜å»ºè®®å¯éµå¾ªä»¥ä¸‹åŸåˆ™ï¼Œå°†æœ‰åŠ©äºå®éªŒè®¾è®¡ï¼š&lt;/b&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;b&gt;å»ºç«‹ç¨³å®šçŠ¶æ€çš„å‡è®¾ï¼›&lt;/b&gt;&lt;/li&gt;&lt;li&gt;&lt;b&gt;å¤šæ ·åŒ–ç°å®ä¸–ç•Œäº‹ä»¶ï¼›&lt;/b&gt;&lt;/li&gt;&lt;li&gt;&lt;b&gt;åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œå®éªŒï¼›&lt;/b&gt;&lt;/li&gt;&lt;li&gt;&lt;b&gt;æŒç»­è‡ªåŠ¨åŒ–è¿è¡Œå®éªŒï¼›&lt;/b&gt;&lt;/li&gt;&lt;li&gt;&lt;b&gt;æœ€å°åŒ–â€œçˆ†ç‚¸åŠå¾„â€ã€‚&lt;/b&gt;&lt;/li&gt;&lt;/ul&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-dd76c78a6c85421662be48143f680da4_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;614&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1080&quot; data-original=&quot;https://pic1.zhimg.com/v2-dd76c78a6c85421662be48143f680da4_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-dd76c78a6c85421662be48143f680da4_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;614&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1080&quot; data-original=&quot;https://pic1.zhimg.com/v2-dd76c78a6c85421662be48143f680da4_r.jpg&quot; data-actualsrc=&quot;https://pic1.zhimg.com/v2-dd76c78a6c85421662be48143f680da4_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;å…·ä½“æ¥è¯´ï¼Œç³»ç»Ÿç¨³æ€å¯ä»¥é€šè¿‡ä¸€äº›æŒ‡æ ‡ï¼Œæ¯”å¦‚å»¶è¿Ÿå’Œ QPS æ•°æ®ç­‰æ¥å®šä¹‰ï¼Œå½“ç³»ç»ŸæŒ‡æ ‡åœ¨æµ‹è¯•å®Œæˆåï¼Œæ— æ³•å¿«é€Ÿæ¢å¤ç¨³æ€è¦æ±‚ï¼Œå¯ä»¥è®¤ä¸ºè¿™ä¸ªç³»ç»Ÿæ˜¯ä¸ç¨³å®šçš„ï¼›å…¶æ¬¡ï¼Œå¼•è¿›å¤šæ ·åŒ–çš„ç°å®å˜é‡ï¼Œæ¯”å¦‚ç½‘å¡ã€ç£ç›˜æ•…éšœç­‰ï¼›ç„¶åï¼Œæœ€ä¸ºé‡è¦çš„æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡ŒéªŒè¯ï¼Œè¿™æ ·åšæ˜¯å­˜åœ¨é£é™©çš„ï¼Œå› æ­¤æœ€å¥½æå‰ä¸åä½œéƒ¨é—¨åŒæ­¥ï¼›æœ€åï¼Œè‡ªåŠ¨åŒ–å¯ä»¥è®©æ•´ä¸ªè¿‡ç¨‹çš„æ•ˆç‡æ›´é«˜ï¼Œæœ€å°åŒ–â€œçˆ†ç‚¸åŠå¾„â€å¯ä»¥é¿å…ä¸å¿…è¦çš„æŸå¤±ã€‚&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-383b2924cf827fc0927010056ea66e99_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;608&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1080&quot; data-original=&quot;https://pic2.zhimg.com/v2-383b2924cf827fc0927010056ea66e99_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-383b2924cf827fc0927010056ea66e99_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;608&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1080&quot; data-original=&quot;https://pic2.zhimg.com/v2-383b2924cf827fc0927010056ea66e99_r.jpg&quot; data-actualsrc=&quot;https://pic2.zhimg.com/v2-383b2924cf827fc0927010056ea66e99_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;ä¸¾ä¾‹æ¥è¯´ï¼Œå¯¹äºä¸€ä¸ªä¸‰å‰¯æœ¬çš„ç³»ç»Ÿè€Œè¨€ï¼Œå¯ä»¥é€šè¿‡éšæœºæ€æ­» Leader èŠ‚ç‚¹çš„æ–¹å¼æ¥éªŒè¯ç³»ç»Ÿæ˜¯å¦å¯ä»¥ä¿æŒç¨³æ€ã€‚å¯é¢„æƒ³çš„æƒ…å†µæ˜¯ç³»ç»Ÿåœ¨ä¸»èŠ‚ç‚¹è¢«æ€æ­»åä¼šå‡ºç°ä¸€æ®µæŠ–åŠ¨ï¼Œéšåæ¢å¤æ­£å¸¸åˆ™è¯æ˜ç³»ç»Ÿæ˜¯å…·å¤‡å®¹é”™èƒ½åŠ›çš„ï¼Œåä¹‹ï¼Œåˆ™è¯æ˜ç³»ç»Ÿå­˜åœ¨é—®é¢˜ã€‚&lt;/p&gt;&lt;p&gt;åœ¨è¿™ä¹‹ä¸­ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªå¤§æ–¹å‘ï¼šä¸€æ˜¯å‘ç°é”™è¯¯ï¼›äºŒæ˜¯æ³¨å…¥é”™è¯¯ã€‚TiDB ä¸»è¦é€šè¿‡ Metricsï¼ˆPrometheus é¡¹ç›®ï¼‰ã€Log å’Œ Tracing ä¸‰ç§æ–¹å¼åˆ†æç³»ç»ŸçŠ¶æ€ã€‚å…¶ä¸­ï¼ŒTiDB é»˜è®¤ä¸å¼€å¯ Tracing æ–¹å¼ï¼Œå› ä¸ºè¿™ä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸€å®šå½±å“ï¼Œä»…åœ¨å¿…è¦æ—¶å¯åŠ¨è¯¥æ–¹æ³•ã€‚è‡³äºæ³¨å…¥é”™è¯¯ï¼Œåº”ç”¨ã€å­˜å‚¨ã€ç½‘ç»œã€CPU ç­‰å­˜åœ¨å¤šç§æ•…éšœæ–¹å¼ï¼Œå”åˆ˜åœ¨åˆ†äº«ä¸­æåˆ°äº†å¦‚ä¸‹éƒ¨åˆ†ï¼Œä¾›å¼€å‘è€…å‚è€ƒï¼š&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-2b8ff1edae7473ebf99fbecde6ad46a3_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;761&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1080&quot; data-original=&quot;https://pic4.zhimg.com/v2-2b8ff1edae7473ebf99fbecde6ad46a3_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-2b8ff1edae7473ebf99fbecde6ad46a3_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;761&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1080&quot; data-original=&quot;https://pic4.zhimg.com/v2-2b8ff1edae7473ebf99fbecde6ad46a3_r.jpg&quot; data-actualsrc=&quot;https://pic4.zhimg.com/v2-2b8ff1edae7473ebf99fbecde6ad46a3_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;æ ¹æ®è¿‡å¾€å®è·µç»éªŒï¼Œå”åˆ˜å»ºè®®å¸Œæœ›ä½¿ç”¨æ··æ²Œå·¥ç¨‹çš„å¼€å‘è€…å¯ä»¥å‚è€ƒæ··æ²Œå·¥ç¨‹ä¸»é¡µï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//principlesofchaos.org/&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;principlesofchaos.org/&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;&lt;/span&gt;&lt;/a&gt;ï¼‰ åˆ—å‡ºçš„æ­¥éª¤å’ŒåŸåˆ™ã€‚ä½†æ˜¯ï¼Œè¦æƒ³çœŸæ­£å®è·µï¼Œè¿˜éœ€è¦åšå¾ˆå¤šå·¥ä½œï¼ŒåŒ…æ‹¬æ›´å¥½åœ°å¯¹ç³»ç»Ÿè¿›è¡Œé”™è¯¯æ³¨å…¥ï¼Œæ›´å¥½åœ°å‘ç°ç³»ç»Ÿé—®é¢˜ï¼Œè¿™äº›å…¶å®ä¸šç•Œæ²¡æœ‰é€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå› æ­¤å®è·µèµ·æ¥è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚é‡‡è®¿ä¸­ï¼Œå”åˆ˜æ¨èå¯ä»¥é˜…è¯» Netflix çš„ã€ŠChaos Engineeringã€‹ä¸€ä¹¦ï¼ˆä¸­æ–‡ç¿»è¯‘ç‰ˆï¼š&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.infoq.cn/theme/13&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://www.&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;infoq.cn/theme/13&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;&lt;/span&gt;&lt;/a&gt;ï¼‰ï¼ŒGitHub ä¸Šæœ‰ä¸€ä¸ª awesome-chaos-engineeringçš„ Repoï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/dastergon/awesome-chaos-engineering&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/dastergon/aw&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;esome-chaos-engineering&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;ï¼‰ä¹Ÿå¯ä»¥å‚è€ƒã€‚æ­¤å¤–ï¼Œå¦‚æœæ•´ä¸ªå¼€å‘å›¢é˜Ÿæœ¬æ¥å¯¹æµ‹è¯•å°±ä¸å¤ªé‡è§†ï¼Œè®¤ä¸ºè¿™å®Œå…¨æ˜¯æµ‹è¯•å›¢é˜Ÿçš„äº‹æƒ…ï¼Œé‚£å¯èƒ½ä¹Ÿå¾ˆéš¾æ¨åŠ¨æ··æ²Œå·¥ç¨‹è½åœ°ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ç»“æŸè¯­&lt;/b&gt;&lt;/h2&gt;&lt;blockquote&gt;ä¸‰å¹´å‰ï¼Œæˆ‘å¾ˆå°‘å¬åˆ°æœ‰äººè°ˆè®ºæ··æ²Œå·¥ç¨‹ï¼Œç°åœ¨å·²ç»è›®å¤šäº†ã€‚&lt;/blockquote&gt;&lt;p&gt;é‡‡è®¿æœ€åï¼Œ &lt;a class=&quot;member_mention&quot; href=&quot;https://www.zhihu.com/people/df9ec6a48ca50364852daa71b20a6192&quot; data-hash=&quot;df9ec6a48ca50364852daa71b20a6192&quot; data-hovercard=&quot;p$b$df9ec6a48ca50364852daa71b20a6192&quot;&gt;@å”åˆ˜&lt;/a&gt; è¡¨ç¤ºå¦‚ä»Šçš„æ··æ²Œå·¥ç¨‹åœ¨å›½å†…å·²ç»æ¯”è¾ƒå‡ºåï¼Œè¿™ä¸ªæ¦‚å¿µåº”è¯¥å·²ç»è¿›å…¥æ™®åŠé˜¶æ®µã€‚ä½†æ®å”åˆ˜çš„äº†è§£ï¼Œå›½å†…çœŸæ­£å¯¹å…¶åº”ç”¨å¾ˆå¥½çš„ï¼Œå¹¶æ²¡æœ‰ç‰¹åˆ«å¤šå…¬å¸ï¼Œå¤§éƒ¨åˆ†ä»ç„¶å¤„äºç†æ¸…æ¦‚å¿µï¼Œä½†ä¸çŸ¥é“å¦‚ä½•å®æ–½çš„é˜¶æ®µã€‚&lt;b&gt;åœ¨è¿™ç§èƒŒæ™¯ä¸‹ï¼Œä¼ä¸šå¯èƒ½æœ€éœ€è¦å…³æ³¨çš„æ˜¯å¦‚ä½•å»ºç«‹èµ·è‡ªå·±çš„ä¸€æ•´å¥—è‡ªåŠ¨åŒ–æµ‹è¯•å¹³å°ï¼Œå®ç°å¯¹ç³»ç»Ÿçš„è‡ªåŠ¨é”™è¯¯æ³¨å…¥ï¼Œå¹¶è‡ªåŠ¨å‘ç°ç³»ç»Ÿé—®é¢˜ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œä¼ä¸šå¯ä»¥æ ¹æ®ä¸šåŠ¡æƒ…å†µè€ƒè™‘æ·±å…¥å®è·µæ··æ²Œå·¥ç¨‹ã€‚&lt;/b&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2019-07-22-74717464</guid>
<pubDate>Mon, 22 Jul 2019 00:00:00 +0800</pubDate>
</item>
<item>
<title>DM æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆä¹ï¼‰shard DDL ä¸ checkpoint æœºåˆ¶çš„å®ç°</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-18-74205520.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/74205520&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-cfe2dd456c96422b7941425773b6833b_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;ä½œè€…ï¼šå¼ å­¦ç¨‹&lt;/p&gt;&lt;p&gt;æœ¬æ–‡ä¸º DM æºç é˜…è¯»ç³»åˆ—æ–‡ç« çš„ç¬¬ä¹ç¯‡ï¼Œåœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/dm-source-code-reading-8/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ä¸Šç¯‡æ–‡ç« &lt;/a&gt; ä¸­æˆ‘ä»¬è¯¦ç»†ä»‹ç»äº† DM å¯¹ online schema change æ–¹æ¡ˆçš„åŒæ­¥æ”¯æŒï¼Œå¯¹ online schema change åŒæ­¥æ–¹æ¡ˆä»¥åŠå®ç°ç»†èŠ‚ç­‰é€»è¾‘è¿›è¡Œäº†åˆ†æã€‚&lt;/p&gt;&lt;p&gt;åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹ shard DDL åŒæ­¥æœºåˆ¶ä»¥åŠ checkpoint æœºåˆ¶ç­‰è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ï¼Œå†…å®¹åŒ…æ‹¬ shard group çš„å®šä¹‰ã€shard DDL çš„åŒæ­¥åè°ƒå¤„ç†æµç¨‹ã€checkpoint æœºåˆ¶ä»¥åŠä¸ä¹‹ç›¸å…³çš„ safe mode æœºåˆ¶ã€‚&lt;/p&gt;&lt;h2&gt;shard DDL æœºåˆ¶çš„å®ç°&lt;/h2&gt;&lt;p&gt;DM ä¸­é€šè¿‡ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/dm-source-code-reading-7/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;åº“è¡¨è·¯ç”±ä¸åˆ—å€¼è½¬æ¢&lt;/a&gt; åŠŸèƒ½ï¼Œå®ç°äº†å¯¹åˆ†åº“åˆ†è¡¨åˆå¹¶åœºæ™¯ä¸‹ DML çš„åŒæ­¥æ”¯æŒã€‚ä½†å½“éœ€è¦åŒæ­¥çš„å„åˆ†è¡¨å­˜åœ¨ DDL å˜æ›´æ—¶ï¼Œè¿˜éœ€è¦å¯¹ DDL çš„åŒæ­¥è¿›è¡Œæ›´å¤šé¢å¤–çš„å¤„ç†ã€‚æœ‰å…³åˆ†è¡¨åˆå¹¶æ—¶ shard DDL åŒæ­¥éœ€è¦å¤„ç†çš„é—®é¢˜ä»¥åŠ DM ä¸­çš„åŒæ­¥æ”¯æŒåŸç†ï¼Œè¯·å…ˆé˜…è¯» &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-ecosystem-tools-3/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;TiDB Ecosystem Tools åŸç†è§£è¯»ç³»åˆ—ï¼ˆä¸‰ï¼‰TiDB-DM æ¶æ„è®¾è®¡ä¸å®ç°åŸç†&lt;/a&gt;ã€‚&lt;/p&gt;&lt;h3&gt;shard group&lt;/h3&gt;&lt;p&gt;åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-ecosystem-tools-3/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;è¿™ç¯‡æ–‡ç« &lt;/a&gt; ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† DM åœ¨å¤„ç† shard DDL åŒæ­¥æ—¶å¼•å…¥äº†ä¸¤çº§ shard group çš„æ¦‚å¿µï¼Œå³ç”¨äºæ‰§è¡Œåˆ†è¡¨åˆå¹¶åŒæ­¥ä»»åŠ¡çš„å„ DM-worker ç»„æˆçš„ shard groupã€æ¯ä¸ª DM-worker å†…éœ€è¦è¿›è¡Œåˆè¡¨åŒæ­¥çš„å„ä¸Šæ¸¸åˆ†è¡¨ç»„æˆçš„ shard groupã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;DM-worker ç»„æˆçš„ shard group&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç”± DM-worker ç»„æˆçš„ shard group æ˜¯ç”±é›†ç¾¤éƒ¨ç½²æ‹“æ‰‘åŠåŒæ­¥ä»»åŠ¡é…ç½®å†³å®šçš„ï¼Œå³ä»»åŠ¡é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„éœ€è¦è¿›è¡Œåˆè¡¨åŒæ­¥çš„æ‰€æœ‰ä¸Šæ¸¸ MySQL å®ä¾‹å¯¹åº”çš„æ‰€æœ‰ DM-worker å®ä¾‹å³ç»„æˆäº†ä¸€ä¸ª shard groupã€‚ä¸ºäº†è¡¨ç¤ºåŒæ­¥è¿‡ç¨‹ä¸­çš„ç›¸å…³åŠ¨æ€ä¿¡æ¯ï¼ŒDM-master å†…éƒ¨å¼•å…¥äº†ä¸¤ä¸ªæ¦‚å¿µï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/lock.go%23L24&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Lock&lt;/a&gt;ï¼šå¯¹äºæ¯ç»„éœ€è¦è¿›è¡Œåˆå¹¶çš„è¡¨ï¼Œå…¶ä¸­æ¯ä¸€æ¡éœ€è¦è¿›è¡ŒåŒæ­¥åè°ƒçš„ shard DDLï¼Œç”±ä¸€ä¸ª Lock å®ä¾‹è¿›è¡Œè¡¨ç¤ºï¼›æ¯ä¸ª Lock å®ä¾‹åœ¨æœ‰ shard DDL éœ€è¦åè°ƒåŒæ­¥æ—¶è¢«åˆ›å»ºã€åœ¨åè°ƒåŒæ­¥å®Œæˆåè¢«é”€æ¯ï¼›åœ¨ dmctl ä¸­ä½¿ç”¨ show-ddl-locks å‘½ä»¤æŸ¥çœ‹åˆ°çš„æ¯ä¸€ä¸ª Lock ä¿¡æ¯å³å¯¹åº”ä¸€ä¸ªè¯¥å®ä¾‹&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/ddl_lock.go%23L91&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;LockKeeper&lt;/a&gt;ï¼šç»´æŠ¤æ‰€æœ‰çš„ Lock å®ä¾‹ä¿¡æ¯å¹¶æä¾›ç›¸å…³çš„æ“ä½œæ¥å£&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Lock ä¸­å„ä¸»è¦æˆå‘˜å˜é‡çš„ä½œç”¨å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-0a92b55c1b60ed26df9a59da855cbc89_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1256&quot; data-rawheight=&quot;686&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1256&quot; data-original=&quot;https://pic2.zhimg.com/v2-0a92b55c1b60ed26df9a59da855cbc89_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-0a92b55c1b60ed26df9a59da855cbc89_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1256&quot; data-rawheight=&quot;686&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1256&quot; data-original=&quot;https://pic2.zhimg.com/v2-0a92b55c1b60ed26df9a59da855cbc89_r.jpg&quot; data-actualsrc=&quot;https://pic2.zhimg.com/v2-0a92b55c1b60ed26df9a59da855cbc89_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;&lt;b&gt;DM-worker å†…åˆ†è¡¨ç»„æˆçš„ shard group&lt;/b&gt;&lt;/p&gt;&lt;p&gt;æ¯ä¸ª DM-worker å†…çš„ shard group æ˜¯ç”±å¯¹åº”ä¸Šæ¸¸ MySQL å®ä¾‹å†…åˆ†è¡¨åŠåŒæ­¥ä»»åŠ¡é…ç½®å†³å®šçš„ï¼Œå³ä»»åŠ¡é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„å¯¹åº” MySQL å®ä¾‹å†…éœ€è¦è¿›è¡Œåˆå¹¶åŒæ­¥åˆ°åŒä¸€ä¸ªä¸‹æ¸¸ç›®æ ‡è¡¨çš„æ‰€æœ‰åˆ†è¡¨ç»„æˆä¸€ä¸ª shard groupã€‚åœ¨ DM-worker å†…éƒ¨ï¼Œæˆ‘ä»¬ç»´æŠ¤äº†ä¸‹é¢ä¸¤ä¸ªå¯¹è±¡ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/sharding_group.go%23L87&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ShardingGroup&lt;/a&gt;ï¼šå¯¹äºæ¯ä¸€ç»„éœ€è¦è¿›è¡Œåˆå¹¶çš„è¡¨ï¼Œç”±ä¸€ä¸ª ShardingGroup å®ä¾‹è¿›è¡Œè¡¨ç¤ºï¼›æ¯ä¸ª ShardGroup å®ä¾‹åœ¨åŒæ­¥ä»»åŠ¡å¯åŠ¨é˜¶æ®µè¢«åˆ›å»ºï¼Œåœ¨ä»»åŠ¡åœæ­¢æ—¶è¢«é”€æ¯&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/sharding_group.go%23L395&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ShardingGroupKeeper&lt;/a&gt;ï¼šç»´æŠ¤æ‰€æœ‰çš„ ShardingGroup å®ä¾‹ä¿¡æ¯å¹¶æä¾›ç›¸å…³çš„æ“ä½œæ¥å£&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ShardingGroup ä¸­å„ä¸»è¦æˆå‘˜å˜é‡çš„ä½œç”¨å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;h3&gt;shard DDL åŒæ­¥æµç¨‹&lt;/h3&gt;&lt;p&gt;å¯¹äºä¸¤çº§ shard groupï¼ŒDM å†…éƒ¨åœ¨ä¾æ¬¡å®Œæˆä¸¤ä¸ªçº§åˆ«çš„ ç›¸åº”çš„ shard DDL åŒæ­¥åè°ƒã€‚&lt;/p&gt;&lt;ol&gt;&lt;li&gt;å¯¹äº DM-worker å†…ç”±å„åˆ†è¡¨ç»„æˆçš„ shard groupï¼Œå…¶ shard DDL çš„åŒæ­¥åœ¨å¯¹åº” DM-worker å†…éƒ¨è¿›è¡Œåè°ƒ&lt;/li&gt;&lt;li&gt;å¯¹äºç”±å„ DM-worker ç»„æˆçš„ shard groupï¼Œå…¶ shard DDL çš„åŒæ­¥ç”± DM-master è¿›è¡Œåè°ƒ&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;&lt;b&gt;DM-worker é—´ shard DDL åè°ƒæµç¨‹&lt;/b&gt;&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬åŸºäºåœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-ecosystem-tools-3/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;è¿™ç¯‡æ–‡ç« &lt;/a&gt; ä¸­å±•ç¤ºè¿‡çš„ä»…åŒ…å«ä¸¤ä¸ª DM-worker çš„ shard DDL åè°ƒæµç¨‹ç¤ºä¾‹ï¼ˆå¦‚ä¸‹å›¾ï¼‰æ¥äº†è§£ DM å†…éƒ¨çš„å…·ä½“å®ç°ã€‚&lt;/p&gt;&lt;p class=&quot;ztext-empty-paragraph&quot;&gt;&lt;br/&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-6ccd31fea26ecf270f373f9eb9337498_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;447&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic1.zhimg.com/v2-6ccd31fea26ecf270f373f9eb9337498_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-6ccd31fea26ecf270f373f9eb9337498_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;447&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic1.zhimg.com/v2-6ccd31fea26ecf270f373f9eb9337498_r.jpg&quot; data-actualsrc=&quot;https://pic1.zhimg.com/v2-6ccd31fea26ecf270f373f9eb9337498_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;ol&gt;&lt;li&gt;DM-worker-1 å°† shard DDL ä¿¡æ¯å‘é€ç»™ DM-master&lt;br/&gt;a. å½“ DM-worker-1 å†…éƒ¨ shard DDL åè°ƒå®Œæˆæ—¶ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1727&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-worker-1 å°†å¯¹åº”çš„ shard DDL ä¿¡æ¯ä¿å­˜åœ¨ channel ä¸­&lt;/a&gt;ä¾› DM-master é€šè¿‡ gRPC è·å–&lt;br/&gt;b. DM-master åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1243&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;fetchWorkerDDLInfo&lt;/a&gt; æ–¹æ³•ä¸­&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1277&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ä»¥ gRPC streaming çš„æ–¹å¼è¯»å–åˆ° DM-worker-1 çš„ shard DDL ä¿¡æ¯&lt;/a&gt;&lt;br/&gt;c. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1308&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-master è°ƒç”¨ ShardingGroupKeeper çš„ TrySync æ–¹æ³•åˆ›å»ºå¯¹åº”çš„ lock ä¿¡æ¯&lt;/a&gt;ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/lock.go%23L77&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å¹¶åœ¨ lock ä¸­æ ‡è®°å·²æ”¶åˆ° DM-worker-1 çš„ shard DDL ä¿¡æ¯&lt;/a&gt;&lt;/li&gt;&lt;li&gt;DM-master å°† lock ä¿¡æ¯å‘å›ç»™ DM-worker-1&lt;br/&gt;a. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1319&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-master ä»¥ gRPC streaming çš„æ–¹å¼å°† lock ä¿¡æ¯å‘é€ç»™ DM-worker-1&lt;/a&gt;&lt;br/&gt;b. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/worker/subtask.go%23L535&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-worker-1 å°†æ¥è‡ª DM-master çš„ lock ä¿¡æ¯ä¿å­˜åœ¨å†…å­˜ä¸­&lt;/a&gt;ç”¨äºåœ¨ DM-master è¯·æ±‚ DM-worker æ‰§è¡Œ/è·³è¿‡ shard DDL æ—¶è¿›è¡ŒéªŒè¯&lt;/li&gt;&lt;li&gt;DM-worker-2 å°† shard DDL ä¿¡æ¯å‘é€ç»™ DM-masterï¼ˆæµç¨‹ä¸ step.1 ä¸€è‡´ï¼‰&lt;/li&gt;&lt;li&gt;DM-master å°† lock ä¿¡æ¯å‘å›ç»™ DM-worker-2ï¼ˆæµç¨‹ä¸ step.2 ä¸€è‡´ï¼‰&lt;/li&gt;&lt;li&gt;DM-master åè°ƒ DM-worker-1 å‘ä¸‹æ¸¸åŒæ­¥ shard DDL&lt;br/&gt;a. DM-master æ ¹æ® step.1 ä¸ step.3 æ—¶æ”¶åˆ°çš„ shard DDL ä¿¡æ¯&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/lock.go%23L80&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;åˆ¤å®šå·²ç»æ”¶åˆ° shard group å†…æ‰€æœ‰ DM-worker çš„ shard DDL ä¿¡æ¯&lt;/a&gt;&lt;br/&gt;b. DM-master åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1360&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;resolveDDLLock&lt;/a&gt; æ–¹æ³•ä¸­&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1431&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å‘ DM-worker-1 å‘é€å‘ä¸‹æ¸¸åŒæ­¥ shard DDL çš„è¯·æ±‚&lt;/a&gt;ï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1427&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Exec å‚æ•°ä¸º true&lt;/a&gt;ï¼‰&lt;/li&gt;&lt;li&gt;DM-worker-1 å‘ä¸‹æ¸¸åŒæ­¥ shard DDL&lt;br/&gt;a. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1732&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-worker-1 æ¥æ”¶åˆ°æ¥è‡ª DM-master çš„å‘ä¸‹æ¸¸æ‰§è¡Œ shard DDL çš„è¯·æ±‚&lt;/a&gt;&lt;br/&gt;b. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1773&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-worker-1 æ„é€  DDL job å¹¶æ·»åŠ åˆ° DDL æ‰§è¡Œé˜Ÿåˆ—ä¸­&lt;/a&gt;&lt;br/&gt;c. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L874&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-worker-1 å°† shard DDL æ‰§è¡Œç»“æœä¿å­˜åœ¨ channel ä¸­&lt;/a&gt;ä¾› DM-master é€šè¿‡ gRPC è·å–&lt;/li&gt;&lt;li&gt;DM-worker-2 å¿½ç•¥å‘ä¸‹æ¸¸åŒæ­¥ shard DDL&lt;br/&gt;a. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1436&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-master è·å– DM-worker-1 å‘ä¸‹æ¸¸åŒæ­¥ shard DDL çš„ç»“æœ&lt;/a&gt;åˆ¤æ–­å¾—çŸ¥ DM-worker-1 åŒæ­¥ shard DDL æˆåŠŸ&lt;br/&gt;b. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1486&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-master å‘ DM-worker-2 å‘é€å¿½ç•¥å‘ä¸‹æ¸¸åŒæ­¥ shard DDL çš„è¯·æ±‚&lt;/a&gt;ï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/dm/master/server.go%23L1461&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Exec å‚æ•°ä¸º false&lt;/a&gt;ï¼‰&lt;br/&gt;c. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L843&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-worker-2 æ ¹æ® DM-master è¯·æ±‚å¿½ç•¥å‘ä¸‹æ¸¸åŒæ­¥ shard DDL&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;&lt;b&gt;DM-worker å†… shard DDL åŒæ­¥æµç¨‹&lt;/b&gt;&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬åŸºäºåœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-ecosystem-tools-3/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å®ç°åŸç†æ–‡ç« &lt;/a&gt; ä¸­å±•ç¤ºè¿‡çš„ä¸€ä¸ª DM-worker å†…ä»…åŒ…å«ä¸¤ä¸ªåˆ†è¡¨ &lt;code&gt;ï¼ˆtable_1ï¼Œtable_2ï¼‰&lt;/code&gt; çš„ shard DDLï¼ˆä»…ä¸€æ¡ DDLï¼‰åè°ƒå¤„ç†æµç¨‹ç¤ºä¾‹æ¥äº†è§£ DM å†…éƒ¨çš„å…·ä½“å®ç°ã€‚&lt;/p&gt;&lt;ol&gt;&lt;li&gt;DM-worker æ”¶åˆ° &lt;code&gt;table_1&lt;/code&gt; çš„ DDL&lt;br/&gt;a. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1659&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æ ¹æ® DDL åŠ binlog event position ç­‰ä¿¡æ¯æ›´æ–°å¯¹åº”çš„ shard group&lt;/a&gt;&lt;br/&gt;b. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1675&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ç¡®ä¿ binlog replication è¿‡ç¨‹å·²è¿›å…¥ safe mode&lt;/a&gt;ï¼ˆåæ–‡ä»‹ç» checkpoint æœºåˆ¶æ—¶ä¼šå†ä»‹ç» safe modeï¼‰&lt;br/&gt;c. href=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1683&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/dm/b&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;lob/369933f31b/syncer/syncer.go#L1683&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&amp;#34;&amp;gt;æ›´æ–° table_1 çš„ checkpointï¼ˆåæ–‡ä¼šè¯¦ç»†ä»‹ç» checkpoint æœºåˆ¶ï¼‰&lt;/li&gt;&lt;li&gt;DM-worker ç»§ç»­è§£æåç»­çš„ binlog event&lt;br/&gt;æ ¹æ® step.1 æ—¶è¿”å›çš„æ›´æ–°åçš„ shard group ä¿¡æ¯å¾—çŸ¥è¿˜&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1684&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æœªæ”¶åˆ° shard group å†…æ‰€æœ‰åˆ†è¡¨å¯¹åº”çš„ shard DDL&lt;/a&gt;ï¼Œä¸å‘ä¸‹æ¸¸åŒæ­¥ shard DDL å¹¶&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1686&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ç»§ç»­åç»­è§£æ&lt;/a&gt;&lt;/li&gt;&lt;li&gt;å¿½ç•¥ &lt;code&gt;table_1&lt;/code&gt; çš„ DML å¹¶åŒæ­¥ &lt;code&gt;table_2&lt;/code&gt; çš„ DML&lt;br/&gt;href=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1331&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/dm/b&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;lob/369933f31b/syncer/syncer.go#L1331&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&amp;#34;&amp;gt;ç”±äº table_1 å·²æ”¶åˆ° shard DDL ä½† shard DDL è‡ªèº«è¿˜æœªå®ŒæˆåŒæ­¥ï¼Œref=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1335&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/dm/b&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;lob/369933f31b/syncer/syncer.go#L1335&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&amp;#34;&amp;gt;å¿½ç•¥å¯¹ table_1 ç›¸å…³ DML çš„åŒæ­¥&lt;/li&gt;&lt;li&gt;DM-worker æ”¶åˆ° &lt;code&gt;table_2&lt;/code&gt; çš„ DDLï¼ˆæµç¨‹ä¸ step.1 ä¸€è‡´ï¼‰&lt;/li&gt;&lt;li&gt;DM-worker å‘ä¸‹æ¸¸åŒæ­¥ shard DDL&lt;br/&gt;a. æ ¹æ® step.4 æ—¶è¿”å›çš„æ›´æ–°åçš„ shard group ä¿¡æ¯å¾—çŸ¥å·²ç»æ”¶åˆ° shard group å†…æ‰€æœ‰åˆ†è¡¨å¯¹åº”çš„ shard DDL&lt;br/&gt;b. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1690&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å°è¯•è®© binlog replication è¿‡ç¨‹é€€å‡º safe mode&lt;/a&gt;&lt;br/&gt;c. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1707&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å°†å½“å‰ shard DDL åŒæ­¥å®Œæˆå re-sync æ—¶é‡æ–°åŒæ­¥ step.3 å¿½ç•¥çš„ DML æ‰€éœ€çš„ç›¸å…³ä¿¡æ¯ä¿å­˜åœ¨ channel ä¸­&lt;/a&gt;&lt;br/&gt;d. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1716&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ç­‰å¾…å·²åˆ†å‘çš„æ‰€æœ‰ DML åŒæ­¥å®Œæˆ&lt;/a&gt;ï¼ˆç¡®ä¿ç­‰å¾…å¹¶å‘åŒæ­¥çš„ DML éƒ½åŒæ­¥åˆ°ä¸‹æ¸¸åå†å¯¹ä¸‹æ¸¸ schema è¿›è¡Œå˜æ›´ï¼‰&lt;br/&gt;e. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1727&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å°† shard DDL ç›¸å…³ä¿¡æ¯ä¿å­˜åœ¨ channel ä¸­ä»¥è¿›è¡Œ DM-worker é—´çš„åŒæ­¥&lt;/a&gt;ï¼ˆè§å‰æ–‡ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/dm-source-code-reading-9/%23dm-worker-%25E9%2597%25B4-shard-ddl-%25E5%258D%258F%25E8%25B0%2583%25E6%25B5%2581%25E7%25A8%258B&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-worker é—´ shard DDL åè°ƒæµç¨‹&lt;/a&gt;ï¼‰&lt;br/&gt;f. å¾… DM-worker é—´åè°ƒå®Œæˆåï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L846&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å‘ä¸‹æ¸¸åŒæ­¥ shard DDL&lt;/a&gt;&lt;/li&gt;&lt;li&gt;å°† binlog çš„è§£æä½ç½®é‡å®šå‘å› step.1 å¯¹åº” DDL åçš„ binlog event position è¿›å…¥ re-sync é˜¶æ®µ&lt;br/&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1074&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æ ¹æ® step.5 ä¸­ä¿å­˜çš„ä¿¡æ¯&lt;/a&gt;ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1080&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å°† binlog çš„è§£æä½ç½®é‡å®šå‘å› step.1 å¯¹åº”çš„ DDL åçš„ binlog event position&lt;/a&gt;&lt;/li&gt;&lt;li&gt;é‡æ–°è§£æ binlog event&lt;/li&gt;&lt;li&gt;å¯¹äºä¸åŒè¡¨çš„ DML åšä¸åŒçš„å¤„ç†&lt;br/&gt;a. å¯¹äº &lt;code&gt;table_1&lt;/code&gt; åœ¨ step.3 æ—¶å¿½ç•¥çš„ DMLï¼Œè§£æåå‘ä¸‹æ¸¸åŒæ­¥&lt;br/&gt;b. href=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1310&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/dm/b&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;lob/369933f31b/syncer/syncer.go#L1310&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&amp;#34;&amp;gt;å¯¹äº table_2 çš„ DMLï¼Œæ ¹æ® checkpoint ä¿¡æ¯å¿½ç•¥å‘ä¸‹æ¸¸åŒæ­¥&lt;/li&gt;&lt;li&gt;è§£æåˆ°è¾¾ step.4 æ—¶ DDL å¯¹åº”çš„ binlog positionï¼Œre-sync é˜¶æ®µå®Œæˆ&lt;br/&gt;a. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1296&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;è§£æ binlog position åˆ°è¾¾ step.4 çš„ DDL&lt;/a&gt;&lt;br/&gt;b. &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1298&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ç»“æŸ re-sync è¿‡ç¨‹&lt;/a&gt;&lt;/li&gt;&lt;li&gt;ç»§ç»­è¿›è¡Œåç»­çš„ DDL ä¸ DML çš„åŒæ­¥&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸Šè¿° step.1 ä¸ step.4 ä¹‹é—´ï¼Œå¦‚æœæœ‰æ”¶åˆ° &lt;code&gt;table_1&lt;/code&gt; çš„å…¶ä»– DDLï¼Œåˆ™å¯¹äºè¯¥ shard groupï¼Œéœ€è¦åè°ƒåŒæ­¥ç”±ä¸€ç»„ shard DDL ç»„æˆçš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/sharding-meta/shardmeta.go%23L53&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ShardingSequence&lt;/a&gt;ã€‚å½“åœ¨ step.9 å¯¹å…¶ä¸­æŸä¸€æ¡ shard DDL åŒæ­¥å®Œæˆåï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1051&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å¦‚æœæœ‰æ›´å¤šçš„æœªåŒæ­¥çš„ shard DDL éœ€è¦åè°ƒå¤„ç†&lt;/a&gt;ï¼Œåˆ™ä¼š&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1057&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;é‡å®šå‘åˆ°å¾…å¤„ç†çš„ä¸‹ä¸€æ¡ shard DDL å¯¹åº”çš„ä½ç½®é‡æ–°å¼€å§‹è§£æ binlog event&lt;/a&gt;ã€‚&lt;/p&gt;&lt;h2&gt;checkpoint æœºåˆ¶çš„å®ç°&lt;/h2&gt;&lt;p&gt;DM ä¸­é€šè¿‡ checkpoint æœºåˆ¶æ¥å®ç°åŒæ­¥ä»»åŠ¡ä¸­æ–­åæ¢å¤æ—¶çš„ç»­ä¼ åŠŸèƒ½ã€‚å¯¹äº load é˜¶æ®µï¼Œå…¶ checkpoint æœºåˆ¶çš„å®ç°åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/dm-source-code-reading-4/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆå››ï¼‰dump/load å…¨é‡åŒæ­¥çš„å®ç°&lt;/a&gt; æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»è¿›è¡Œäº†ä»‹ç»ï¼Œæœ¬æ–‡ä¸å†èµ˜è¿°ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç» binlog replication å¢é‡åŒæ­¥é˜¶æ®µçš„ checkpoint æœºåˆ¶çš„å®ç°åŠä¸ä¹‹ç›¸å…³çš„ safe mode æœºåˆ¶çš„å®ç°ã€‚&lt;/p&gt;&lt;h3&gt;checkpoint æœºåˆ¶&lt;/h3&gt;&lt;p&gt;DM åœ¨ binlog replication é˜¶æ®µä»¥ binlog event å¯¹åº”çš„ position ä¸º checkpointï¼ŒåŒ…æ‹¬ä¸¤ç±»ï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;å…¨å±€ checkpiontï¼šå¯¹åº”å·²æˆåŠŸè§£æå¹¶åŒæ­¥åˆ°ä¸‹æ¸¸çš„ binlog event çš„ positionï¼ŒåŒæ­¥ä»»åŠ¡ä¸­æ–­æ¢å¤åå°†ä»è¯¥ä½ç½®é‡æ–°è¿›è¡Œè§£æä¸åŒæ­¥&lt;/li&gt;&lt;li&gt;æ¯ä¸ªéœ€è¦åŒæ­¥ table çš„ checkpointï¼šå¯¹åº”è¯¥ table å·²æˆåŠŸè§£æå¹¶åŒæ­¥åˆ°ä¸‹æ¸¸çš„ binlog event çš„ positionï¼Œä¸»è¦ç”¨äºåœ¨ re-sync è¿‡ç¨‹ä¸­é¿å…å¯¹å·²åŒæ­¥çš„æ•°æ®è¿›è¡Œé‡å¤åŒæ­¥&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;DM çš„ checkpoint ä¿¡æ¯ä¿å­˜åœ¨ä¸‹æ¸¸æ•°æ®åº“ä¸­ï¼Œé€šè¿‡ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/checkpoint.go%23L174&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;RemoteCheckPoint&lt;/a&gt;&lt;/code&gt; å¯¹è±¡è¿›è¡Œè¯»å†™ï¼Œå…¶ä¸»è¦æˆå‘˜å˜é‡åŒ…æ‹¬ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/checkpoint.go%23L197&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;globalPoint&lt;/a&gt;&lt;/code&gt;ï¼šç”¨äºä¿å­˜å…¨å±€ checkpoint&lt;/li&gt;&lt;li&gt;&lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/checkpoint.go%23L189&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;points&lt;/a&gt;&lt;/code&gt;ï¼šç”¨äºä¿å­˜å„ table çš„ checkpoint&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;checkpoint ä¿¡æ¯åœ¨ä¸‹æ¸¸æ•°æ®åº“ä¸­å¯¹åº”çš„ schema é€šè¿‡ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/checkpoint.go%23L453&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;createTable&lt;/a&gt;&lt;/code&gt; æ–¹æ³•è¿›è¡Œåˆ›å»ºï¼Œå…¶ä¸­å„ä¸»è¦å­—æ®µçš„å«ä¹‰ä¸ºï¼š&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-304a3fa97bd59f5a36ceb66e6431d3bc_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1252&quot; data-rawheight=&quot;422&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1252&quot; data-original=&quot;https://pic1.zhimg.com/v2-304a3fa97bd59f5a36ceb66e6431d3bc_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-304a3fa97bd59f5a36ceb66e6431d3bc_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1252&quot; data-rawheight=&quot;422&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1252&quot; data-original=&quot;https://pic1.zhimg.com/v2-304a3fa97bd59f5a36ceb66e6431d3bc_r.jpg&quot; data-actualsrc=&quot;https://pic1.zhimg.com/v2-304a3fa97bd59f5a36ceb66e6431d3bc_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;å¯¹äºå…¨å±€ checkpointï¼Œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¼šæ›´æ–°å†…å­˜ä¸­çš„ä¿¡æ¯ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L652&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æ”¶åˆ° XID event æ—¶&lt;/a&gt;ï¼ˆè¡¨ç¤ºä¸€ä¸ª DML äº‹åŠ¡çš„ç»“æŸï¼‰&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L696&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DDL å‘ä¸‹æ¸¸åŒæ­¥æˆåŠŸå&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;å¯¹äºå„ table checkpointï¼Œåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¼šæ›´æ–°å†…å­˜ä¸­çš„ä¿¡æ¯ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L705&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DML å‘ä¸‹æ¸¸åŒæ­¥æˆåŠŸå&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L696&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DDL å‘ä¸‹æ¸¸åŒæ­¥æˆåŠŸå&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1683&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æ”¶åˆ° shard DDL ä¸”æˆåŠŸæ›´æ–°äº† shard groupï¼Œä½†æœªå‘ä¸‹æ¸¸åŒæ­¥ shard DDL æ—¶&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;å¯¹äºå…¨å±€ä¸ table çš„ checkpointï¼Œä¼šåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ flush åˆ°ä¸‹æ¸¸æ•°æ®åº“ä¸­ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L663&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æ”¶åˆ° flush é€šçŸ¥&lt;/a&gt;ï¼ˆå¦‚åŒæ­¥ä»»åŠ¡å°†æš‚åœæˆ–åœæ­¢æ—¶ï¼‰&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L710&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å·²åˆ†å‘çš„ä»»åŠ¡æˆåŠŸåŒæ­¥åˆ°ä¸‹æ¸¸&lt;/a&gt;ï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L635&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DDL åŒæ­¥åˆ°ä¸‹æ¸¸&lt;/a&gt;ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L639&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;è¶…è¿‡æŒ‡å®šæ—¶é—´é˜ˆå€¼ flush&lt;/a&gt;ï¼‰&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ shard DDL æœªåŒæ­¥åˆ°ä¸‹æ¸¸ä¹‹å‰ï¼Œä¸ºç¡®ä¿ä¸­æ–­æ¢å¤åä»èƒ½ç»§ç»­æ•´ä¸ª shard DDL çš„åè°ƒè¿‡ç¨‹ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L718&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM ä¸ä¼šå°†å…¨å±€ checkpoint æ›´æ–°ä¸ºæ¯” shard DDL èµ·å§‹ position æ›´å¤§çš„ position&lt;/a&gt;ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L757&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM ä¹Ÿä¸ä¼šå°† shard DDL åè°ƒè¿‡ç¨‹ä¸­å¯¹åº” table çš„ checkpoint flush åˆ°ä¸‹æ¸¸&lt;/a&gt;ã€‚&lt;/p&gt;&lt;h3&gt;safe mode æœºåˆ¶&lt;/h3&gt;&lt;p&gt;å½“åŒæ­¥ä»»åŠ¡ä¸­æ–­æ¢å¤åï¼ŒDM åœ¨ binlog replication é˜¶æ®µé€šè¿‡ checkpoint æœºåˆ¶ä¿è¯äº†é‡æ–°å¼€å§‹åŒæ­¥çš„èµ·å§‹ç‚¹å‰çš„æ•°æ®éƒ½å·²ç»æˆåŠŸåŒæ­¥åˆ°äº†ä¸‹æ¸¸æ•°æ®åº“ä¸­ï¼Œå³ä¿è¯äº† at-least-once è¯­ä¹‰ã€‚ä½†ç”±äº flush checkpoint ä¸åŒæ­¥ DDLã€DML åˆ°ä¸‹æ¸¸ä¸æ˜¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆçš„ï¼Œå› æ­¤ä» checkpoint å¼€å§‹é‡æ–°åŒæ­¥æ—¶ï¼Œå¯èƒ½å­˜åœ¨éƒ¨åˆ†æ•°æ®è¢«é‡å¤åŒæ­¥çš„å¯èƒ½ï¼Œå³ä¸èƒ½ä¿è¯ at-most-once ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ DM çš„ binlog replication é˜¶æ®µï¼Œé€šè¿‡å¢åŠ  safe mode æœºåˆ¶ç¡®ä¿äº†é‡å¤åŒæ­¥æ•°æ®æ—¶çš„å¯é‡å…¥ï¼Œå³ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt; href=&amp;#34;https&lt;code&gt;://gith&lt;/code&gt;ub.com/pingcap/dm/blob/369933f31b/syncer/dml.go#L132&amp;#34;&amp;gt;å°† INSERT æ“ä½œè½¬ä¸º REPLACE æ“ä½œ&lt;/li&gt;&lt;li&gt; href=&amp;#34;https&lt;code&gt;://git&lt;/code&gt;hub.com/pingcap/dm/blob/369933f31b/syncer/dml.go#L195&amp;#34;&amp;gt;å°† UPDATE æ“ä½œè½¬ä¸º DELETE æ“ä½œå’Œ &lt;code&gt;=&amp;#34;https://github.com/pingcap/dm/blob/369933f31b/syncer/dml.go#L200&amp;#34;&amp;gt;REPLACE æ“ä½œ&lt;/code&gt;&lt;/li&gt;&lt;li&gt; href=&amp;#34;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//gith&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;gith&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;code&gt;ub.com&lt;/code&gt;/pingcap/dm/blob/369933f31b/syncer/dml.go#L265&amp;#34;&amp;gt;å¯¹ DELETE æ“ä½œä¸è¿›è¡Œè½¬æ¢ä»ä¿æŒä¸º DELETE&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ç›®å‰ï¼Œsafe mode ä¼šåœ¨ä»¥ä¸‹æƒ…å†µæ—¶å¯ç”¨ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1023&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å¯åŠ¨æˆ–æ¢å¤ä»»åŠ¡æ—¶çš„å‰ 5 åˆ†é’Ÿ&lt;/a&gt;ï¼Œç¡®ä¿ä» checkpoint ä½ç½®å¼€å§‹è¢«é‡å¤åŒæ­¥çš„éƒ¨åˆ†æ•°æ®æœ€ç»ˆä¸€è‡´&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/syncer.go%23L1675&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-worker å†…è¿›è¡Œ shard DDL åŒæ­¥åè°ƒæ—¶&lt;/a&gt;ï¼ˆè§å‰æ–‡ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/dm-source-code-reading-9/%23dm-worker-%25E5%2586%2585-shard-ddl-%25E5%2590%258C%25E6%25AD%25A5%25E6%25B5%2581%25E7%25A8%258B&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;DM-worker å†… shard DDL åŒæ­¥æµç¨‹&lt;/a&gt;ï¼‰ï¼Œç¡®ä¿å³ä½¿ shard DDL åè°ƒè¿‡ç¨‹ä¸­å¼‚å¸¸é‡å¯ä¸” 5 åˆ†é’Ÿå†…æ— æ³•é‡å¤åŒæ­¥å®Œä¹‹å‰å·²åŒæ­¥æ•°æ®ä¹Ÿèƒ½æœ€ç»ˆä¸€è‡´&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/369933f31b/syncer/mode.go%23L33&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ç”¨æˆ·åœ¨åŒæ­¥ä»»åŠ¡é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†å¯ç”¨ safe mode&lt;/a&gt;ï¼Œç”¨äºå…¶ä»–éœ€è¦ä»¥ safe mode åŒæ­¥è¶… 5 åˆ†é’Ÿçš„åœºæ™¯&lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;å°ç»“&lt;/h2&gt;&lt;p&gt;æœ¬ç¯‡æ–‡ç« è¯¦ç»†åœ°ä»‹ç»äº† shard DDL æœºåˆ¶ä¸ checkpoint æœºåˆ¶çš„å®ç°ï¼Œå†…å®¹åŒ…æ‹¬äº†ä¸¤çº§ shard group çš„å®šä¹‰ä¸ DM-worker é—´åŠ DM-worker å†…çš„ shard DDL åŒæ­¥åè°ƒå¤„ç†æµç¨‹ã€checkpoint æœºåˆ¶åŠä¸ä¹‹ç›¸å…³çš„ safe mode æœºåˆ¶ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ç”¨äºä¿è¯ DM æ­£ç¡®æ€§ä¸ç¨³å®šæ€§çš„æµ‹è¯•æ¡†æ¶çš„å®ç°ï¼Œæ•¬è¯·æœŸå¾…ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;åŸæ–‡é˜…è¯»ï¼š&lt;/b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/dm-source-code-reading-9/&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://www.&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;pingcap.com/blog-cn/dm-&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;source-code-reading-9/&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;æ›´å¤š DM æºç é˜…è¯»ï¼š&lt;/b&gt;&lt;/p&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/%23DM-%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg&quot; data-image-width=&quot;1200&quot; data-image-height=&quot;1200&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;åšå®¢ | PingCAP&lt;/a&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2019-07-18-74205520</guid>
<pubDate>Thu, 18 Jul 2019 00:00:00 +0800</pubDate>
</item>
<item>
<title>æˆ‘ä»¬æ˜¯å¦‚ä½•è®¾è®¡ Rust &amp; åˆ†å¸ƒå¼å­˜å‚¨æ•™ç¨‹çš„ï¼Ÿ | Talent Plan èƒŒåçš„æ•…äº‹</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-17-73950816.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/73950816&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-8679d48307d8ac03f45e6bf43469dc43_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;ä½œè€…ï¼šæ²ˆæ³°å® å”åˆ˜&lt;/p&gt;&lt;blockquote&gt;è®¸å¤šäººçœ¼ä¸­çš„ PingCAP Talent Plan å¯èƒ½å°±æ˜¯ &lt;a href=&quot;https://link.zhihu.com/?target=http%3A//github.com/pingcap/talent-plan&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;http://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/tale&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;nt-plan&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt; è¿™ä¸ªé¡¹ç›®ï¼Œä½†ä»å†…å®¹è§’åº¦æ¥è¯´å¹¶ä¸å®Œæ•´ï¼Œè¿™ä¸ª Repo åªæ˜¯çº¿ä¸Šè¯¾ç¨‹çš„å†…å®¹ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸å…¶é…å¥—çš„çº¿ä¸‹è¯¾ç¨‹ã€‚&lt;br/&gt;æœ¬æ–‡å°†ä»è¯¾ç¨‹è®¾è®¡çš„è§’åº¦å’Œå¤§å®¶èŠä¸€èŠ PingCAP Talent Planï¼ˆTiKV æ–¹å‘ï¼‰è¯¾ç¨‹ï¼ŒåŒ…æ‹¬è¯¾ç¨‹è®¾è®¡çš„é€»è¾‘ã€è¯¾ç¨‹è®¾è®¡ä¸­é‡åˆ°çš„å›°éš¾ï¼Œä»¥åŠå¤§å®¶åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­å¸¸è§çš„é—®é¢˜å’Œè§£ç­”ç­‰ã€‚&lt;/blockquote&gt;&lt;h2&gt;&lt;b&gt;PingCAP Talent Plan æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;TiDB æ˜¯ä¸€ä¸ªæ–°å‹çš„å¼€æºåˆ†å¸ƒå¼å…³ç³»å‹æ•°æ®åº“ï¼Œç›®æ ‡æ˜¯å¸Œæœ›åœ¨å¤§æ•°æ®å’Œäº‘æ—¶ä»£çš„æ–°çš„ä¸šåŠ¡éœ€æ±‚ä¸‹ï¼Œå¸®åŠ©å¤§å®¶æ›´å¥½åœ°è§£å†³æ•°æ®å¤§è§„æ¨¡å­˜å‚¨å’Œå®æ—¶è®¡ç®—çš„é—®é¢˜ã€‚æˆ‘ä»¬å¬è¯´å¾ˆå¤šåŒå­¦è·Ÿæˆ‘ä»¬åæ˜ ä»–ä»¬å¾ˆæƒ³å‚ä¸åˆ°è¿™äº›é¡¹ç›®ä¸­å»ï¼Œä½†é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;ç¼–ç¨‹è¯­è¨€æ˜¯å‚ä¸é¡¹ç›®çš„æ•²é—¨ç –ã€‚Golang å’Œ Rust éƒ½æ¯”è¾ƒæ–°ï¼Œéœ€è¦ä¸€å®šçš„å­¦ä¹ ï¼Œæ˜¯æœ€ç›´æ¥çš„é«˜é—¨æ§›ã€‚&lt;/li&gt;&lt;li&gt;ç†è®ºçŸ¥è¯†æ˜¯æ·±åº¦å‚ä¸çš„åŸºç¡€ã€‚ä»ç†è®ºåˆ°å®è·µæœ‰ä¸€é“é¸¿æ²Ÿï¼Œå¹¶ä¸æ˜¯è¿™ä¹ˆå®¹æ˜“è·¨è¶Šã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å¯åŠ¨äº† PingCAP Talent Planã€‚ç›®å‰è¯¾ç¨‹ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ–¹å‘ï¼Œé¢å‘ SQL ä¼˜åŒ–å™¨ã€åˆ†å¸ƒå¼è®¡ç®—çš„ &lt;b&gt;TiDB æ–¹å‘&lt;/b&gt;ï¼Œå’Œé¢å‘å¤§è§„æ¨¡ã€ä¸€è‡´æ€§çš„åˆ†å¸ƒå¼å­˜å‚¨çš„ &lt;b&gt;TiKV æ–¹å‘&lt;/b&gt;ã€‚è¯¾ç¨‹å¤§ä½“åˆ†æˆçº¿ä¸Šå­¦ä¹ é˜¶æ®µå’Œçº¿ä¸‹å­¦ä¹ é˜¶æ®µï¼Œçº¿ä¸Šè¯¾ç¨‹çš„ä¸»è¦ç›®æ ‡æ˜¯å¸®åŠ©å¤§å®¶ä»ç¼–ç¨‹è¯­è¨€å¼€å§‹ï¼Œå­¦ä¹ å¹¶æŒæ¡ Golang å’Œ Rustï¼Œé€æ­¥å­¦ä¹ å…³é”®çš„ç†è®ºçŸ¥è¯†ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;TiKV æ–¹å‘è¯¾ç¨‹å†…å®¹&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;TiKV æ˜¯ TiDB çš„åˆ†å¸ƒå¼å­˜å‚¨å±‚ï¼Œå®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€å¯æ°´å¹³æ‰©å±•ã€æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡çš„ Key-Value æ•°æ®åº“ï¼Œç›®å‰å·²ç»æˆä¸ºäº† CNCF çš„å­µåŒ–é¡¹ç›®ã€‚åœ¨è¯¾ç¨‹å†…å®¹çš„åˆ¶å®šä¸Šï¼Œæˆ‘ä»¬ä¸»è¦å‚è€ƒäº† TiKV ç°æœ‰çš„æŠ€æœ¯æ ˆï¼š&lt;/p&gt;&lt;p&gt;&lt;b&gt;1. Rust ç¼–ç¨‹è¯­è¨€ã€‚&lt;/b&gt;TiKV ä¸»è¦ä½¿ç”¨ Rust å¼€å‘ï¼Œæ ¹æ® GitHub ç»Ÿè®¡ï¼Œ99.5% çš„ä»£ç æ˜¯ Rustã€‚æˆ‘ä»¬é€‰æ‹© Rust ä¸»è¦çœ‹ä¸­äº†å®ƒçš„å†…å­˜å®‰å…¨å’Œé«˜æ€§èƒ½ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;2. Raft ä¸€è‡´æ€§ç®—æ³•ã€‚&lt;/b&gt;Raft ä¸€è‡´æ€§ç®—æ³•ä¸»æ‰“å¯ç†è§£æ€§ï¼Œä¸šç•Œä¹Ÿæœ‰æˆç†Ÿçš„å®ç°ï¼ŒTiKV ä½¿ç”¨ Raft ç®—æ³•åŒæ­¥èŠ‚ç‚¹ä¹‹é—´çš„çŠ¶æ€ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;3. Percolator åˆ†å¸ƒå¼äº‹åŠ¡ç®—æ³•ã€‚&lt;/b&gt;åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ TiKV å¾ˆé‡è¦çš„åŠŸèƒ½ï¼ŒTiDB çš„äº‹åŠ¡ä¹Ÿæ˜¯åŸºäºè¿™ä¸ªç®—æ³•æ”¹è¿›çš„ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;è¯­è¨€çœŸçš„æ˜¯é—¨æ§›å—ï¼Ÿ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åŠé—´ä¼ é—» Rust å­¦ä¹ æ›²çº¿éå¸¸é™¡å³­ï¼Œ&lt;i&gt;ã€Œrust steep learning curveã€&lt;/i&gt; å…³é”®è¯åœ¨ Google ä¸Šæœ‰è¶…è¿‡ 70 ä¸‡æ¡æœç´¢ç»“æœã€‚è¯šç„¶ï¼ŒRust æœ‰äº›æ¦‚å¿µç¡®å®æ¯”è¾ƒéšæ™¦ï¼Œæ¯”å¦‚ &amp;#39;static lifetimeï¼ŒSync å’Œ Sendï¼Œä½†å®ƒä»¬ä¹Ÿä»…ä»…çŸ¥è¯†éšæ™¦ç½¢äº†ï¼Œç†è§£èµ·æ¥å¹¶ä¸å›°éš¾ï¼Œç»“åˆæˆ‘ä»¬çš„ä¸ªäººç»éªŒæ¥çœ‹ï¼Œåœ¨å®é™…ç¼–å†™ Rust ä»£ç è¿‡ç¨‹ä¸­ä¹Ÿå¾ˆå°‘é‡åˆ°ä¸æ˜æ‰€ä»¥çš„ç¼–è¯‘é—®é¢˜ï¼ŒRust ç¼–è¯‘å™¨å¯¹äºå¤§éƒ¨åˆ†çš„é”™è¯¯éƒ½æä¾›äº†è¯¦ç»†çš„è§£é‡Šï¼Œæˆ‘ä»¬åªè¦æŒ‰ç…§ç¼–è¯‘å™¨çš„æŒ‡å¯¼ä¿®æ”¹ä»£ç å³å¯ã€‚æ‰€ä»¥â€œRust å­¦ä¹ æ›²çº¿é™¡å³­â€æˆ–è®¸æ˜¯æˆ‘ä»¬çš„åˆ»æ¿å°è±¡å¯¼è‡´çš„ã€‚&lt;/p&gt;&lt;p&gt;çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œæˆ‘ä»¬ä¸€è‡´è®¤ä¸ºå­¦ä¹ ä¸€é—¨è¯­è¨€çš„æœ€ä½³æ–¹æ³•å°±æ˜¯ã€ŒåŠ¨æ‰‹å»å†™ã€ã€‚ä¸ºäº†è®©å¤§å®¶æ”¹å˜å¯¹ Rust çš„å°è±¡ï¼Œä¹Ÿä¸ºäº†è®©æ–°æ‰‹èƒ½æœ‰ä¸€ä¸ªå¹³ç¼“çš„å¼€å§‹ï¼ŒBrianï¼ˆTiKV æˆå‘˜ï¼ŒRust è¯­è¨€ä¸»è¦å¼€å‘è€…ï¼‰ç¼–å†™äº†ä¸€å¥—æ‰‹æŠŠæ‰‹çš„ Rust æ•™ç¨‹â€”â€”&lt;i&gt;&lt;b&gt;Practical Networked Applications in Rust&lt;/b&gt;&lt;/i&gt;ï¼Œè¿™ä¸ªæ•™ç¨‹çš„ç›®æ ‡æ˜¯å¸¦é¢†å¤§å®¶å¾ªåºæ¸è¿›åœ°å¼€å‘ä¸€ä¸ª KV å­˜å‚¨æœåŠ¡ã€‚&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;b&gt;Tools&lt;/b&gt;ï¼šRust æä¾›äº†å®Œæ•´å‘¨è¾¹å¼€å‘å·¥å…·ï¼Œæ¯”å¦‚åŒ…ç®¡ç†å·¥å…· - Cargoï¼Œä»£ç æ ¼å¼åŒ–å·¥å…· - rustfmtï¼Œä»£ç  linter - clippyï¼Œå®ƒä»¬å°†ç»™æˆ‘ä»¬çš„å¼€å‘å¸¦æ¥æå¤§å¸®åŠ©ã€‚&lt;/li&gt;&lt;li&gt;&lt;b&gt;I/O&lt;/b&gt;ï¼šåœ¨è¿™ä¸ªç« èŠ‚æˆ‘ä»¬å°†å­¦ä¹  Rust ä¸­çš„ I/O æ“ä½œï¼Œé”™è¯¯å¤„ç†ï¼Œæ¯”è¾ƒå¹¶ä½¿ç”¨ä¸åŒçš„ collection ç±»å‹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å°†ä½¿ç”¨ failure å’Œ serde è¿™ä¸¤ä¸ªåº“æ¥æ„å»ºå¼ºå¥çš„æŒä¹…åŒ– KV å­˜å‚¨ã€‚&lt;/li&gt;&lt;li&gt;&lt;b&gt;Networking&lt;/b&gt;ï¼šRust æ ‡å‡†åº“æä¾›äº†å®Œæ•´çš„ç½‘ç»œæ¥å£ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ ‡å‡†åº“å®ç° client-server çš„æŒä¹…åŒ– KV æœåŠ¡ï¼ŒæœŸé—´å°†å­¦ä¹  Rust å¼ºå¤§çš„ trait ç³»ç»Ÿï¼Œlogging å’Œ benchmarkingã€‚&lt;/li&gt;&lt;li&gt;&lt;b&gt;Concurrency&lt;/b&gt;ï¼šç›¸ä¿¡å†™è¿‡å¹¶å‘ç¼–ç¨‹çš„åŒå­¦ä¸€å®šä¹Ÿå†™è¿‡æ•°æ®ç«äº‰ ğŸ™‚ï¼Œåœ¨ Rust ä¸­è¿™å°†ä¸å¤å­˜åœ¨ã€‚è¿™ä¸ªç« èŠ‚æˆ‘ä»¬å°†æ·±å…¥ä»‹ç» Sync å’Œ Sendï¼Œä½“éªŒ Rust çš„ã€ŒFearless Concurrencyã€ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;æ•™ç¨‹çš„å†…å®¹è¶³å¤Ÿæ·±å…¥ï¼Œç›¸ä¿¡å¤§å®¶åœ¨å®Œæˆåèƒ½æ— éšœç¢åœ°ä½¿ç”¨ Rust è¿›è¡Œæ—¥å¸¸å¼€å‘ã€‚è¯­è¨€å°†ä¸å†æ˜¯é—¨æ§›é—®é¢˜ã€‚&lt;/p&gt;&lt;p&gt;PSï¼šç›®å‰è¯¾ç¨‹è¿˜åœ¨å¼€å‘ä¸­ï¼Œä¹‹åå°†æ·»åŠ å¼‚æ­¥ç« èŠ‚ï¼Œæ•™å¤§å®¶ä½¿ç”¨ Future è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;å¸¦ä½ çªç ´ä¸¤ä¸ªé‡è¦çš„åˆ†å¸ƒå¼ç®—æ³•&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å¤§å®¶åœ¨é˜…è¯» TiKV æºç æ—¶ï¼Œå¦‚æœä¸äº†è§£ Raft å’Œ Percolator ç®—æ³•ï¼Œå°±å¾ˆå®¹æ˜“è¿·å¤±æ–¹å‘ï¼Œä¸çŸ¥å¦‚ä½•ä¸‹æ‰‹ã€‚å°±ç®—äº†è§£è¿™ä¸¤ä¸ªç®—æ³•ï¼Œå®æ“è¿‡ç¨‹ä¸­ä¹Ÿæœ‰å¯èƒ½å‡ºç°â€œçŸ¥é“å¤§ä½“åšä»€ä¹ˆï¼Œå´ä¸æ˜ç™½ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšâ€çš„æƒ…å†µã€‚å› æ­¤åœ¨ Rust è¯­è¨€è¯¾ç¨‹å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å°†ç»§ç»­å¸¦å¤§å®¶å­¦ä¹ è¿™ä¸¤ä¸ªé‡è¦çš„åˆ†å¸ƒå¼ç®—æ³•ã€‚&lt;/p&gt;&lt;p&gt;å…³äº Raftï¼Œæˆ‘ä»¬ç›´æ¥é‡‡ç”¨ MIT 6.824 è¯¾ç¨‹ï¼Œå¹¶å°† Golang çš„æ•™æç§»æ¤åˆ°äº† Rustã€‚6.824 æä¾›ä¸°å¯Œçš„æµ‹è¯•ï¼Œä» leader é€‰ä¸¾ä¸€è·¯æµ‹åˆ°çº¿æ€§ä¸€è‡´æ€§ã€‚åœ¨ç§»æ¤æ•™ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³å°½å¯èƒ½åœ°ä½¿ç”¨æœ€ç®€å•çš„ä»£ç æ¥å®ç°ï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£è¯¾ç¨‹å†…å®¹ã€‚ä½†æ˜¯ç§»æ¤è¿‡ç¨‹å¹¶éä¸€å¸†é£é¡ºï¼Œå…¶ä¸­æœ€å¤§å›°éš¾æ˜¯ goroutine çš„ä»£ç ã€‚åœ¨ Golang å¯ä»¥éšæ—¶å¼€å¯ goroutine æ‰§è¡Œå¼‚æ­¥çš„ä»£ç ï¼Œä½†æ˜¯ Rust æ²¡æœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼Œè€ƒè™‘å†ä¸‰ï¼Œæˆ‘ä»¬æœ€åå†³å®šä½¿ç”¨ Future æ¥å†™è¿™ç±»ä»£ç ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ç§»æ¤å®Œä»£ç åï¼Œæˆ‘ä»¬è¿˜éªŒè¯äº†ä»£ç çš„æ­£ç¡®æ€§ï¼ŒéªŒè¯ Raft çš„æµ‹è¯•æ¡†æ¶æ•™ç¨‹çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œç”¨ä¸€ä¸ªæ­£ç¡®å®ç°äº† Raft çš„åº“æ¥è·‘ä¸€éæ•™ç¨‹ä¸­çš„è€ƒæ ¸æµ‹è¯•ã€‚æˆ‘ä»¬é€‰æ‹©äº† &lt;a href=&quot;https://link.zhihu.com/?target=http%3A//github.com/pingcap/raft-rs&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;http://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/raft&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;-rs&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt; è¿™ä¸ªé¡¹ç›®ï¼Œæµ‹è¯•ä¸€éåä¿®å¤äº†å‡ ä¸ª BUGã€‚ä¸è¿‡äº‹å®è¯æ˜åªæµ‹è¯•ä¸€éæ˜¯ä¸å¤Ÿçš„ï¼Œè¯¾ç¨‹å‘å¸ƒåç¤¾åŒºå°ä¼™ä¼´åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œåˆé™†é™†ç»­ç»­å‘ç°å¹¶è§£å†³äº†å‡ ä¸ª BUGï¼Œåœ¨è¿™é‡Œç‰¹åˆ«æ„Ÿè°¢ @wjhuang å’Œ @NingLin-P ä¸¤ä½åŒå­¦çš„è´¡çŒ®ã€‚&lt;/p&gt;&lt;p&gt;è‡³äº Percolatorï¼Œç”±äºæ²¡æœ‰ç°æˆçš„æ•™å­¦è¯¾ç¨‹ï¼Œæˆ‘ä»¬å†³å®šä»é›¶å¼€å§‹è®¾è®¡ã€‚å¥½åœ¨æœ‰ä¸€éƒ¨åˆ†å¯ä»¥ç›´æ¥å¤ç”¨ 6.824 ä»£ç ï¼Œæ¯”å¦‚ç½‘ç»œæ¡†æ¶ï¼Œå®ƒæ˜¯æ¯”è¾ƒé€šç”¨çš„ç½‘ç»œæµ‹è¯•æ¡†æ¶ï¼Œå¯ä»¥æ¨¡æ‹Ÿå¤šç§å¸¸è§çš„ç½‘ç»œé”™è¯¯ï¼Œæ¯”å¦‚ä¸¢åŒ…ã€ä¹±åºç­‰ã€‚Percolator çš„æµ‹è¯•ä¹Ÿæ¯”è¾ƒä¸°å¯Œï¼Œä» TSO åˆ° lost update å†åˆ° read/write skew æœ€ååˆ°ç½‘ç»œé”™è¯¯ï¼Œéƒ½æœ‰è¦†ç›–ã€‚&lt;/p&gt;&lt;p&gt;å­¦å®Œè¿™ä¸¤ä¸ªç®—æ³•åï¼Œç›¸ä¿¡å¤§å®¶èƒ½è¾¾åˆ°â€œçŸ¥å…¶ç„¶ï¼ŒåˆçŸ¥å…¶æ‰€ä»¥ç„¶â€çš„ç¨‹åº¦ï¼Œå†çœ‹ TiKV ä»£ç çš„æ—¶å€™ä¸ä¼šä¸€å¤´é›¾æ°´ã€‚ä¹‹åæˆ‘ä»¬è¿˜å°†è¡¥å……æ›´å¤šå†…å®¹ï¼Œæ¯”å¦‚ multi-raftã€é›†ç¾¤è°ƒåº¦ç­‰ï¼Œç»ˆæç›®æ ‡æ˜¯è®©å¤§å®¶å¯ä»¥å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆ TiKVã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨çº¿ä¸‹è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ç€é‡ä»‹ç» TiDB/TiKV æ¶æ„ï¼Œå¸¦é¢†å¤§å®¶äº†è§£å®ç°åŸç†ä¸ç»†èŠ‚ï¼Œè¿˜æœ‰ä¸“é—¨çš„ Mentor æŒ‡å¯¼å¤§å®¶æ·±åº¦å‚ä¸ TiDB/TiKV å¼€å‘ã€‚&lt;/b&gt;æ›´å¤šçš„ç»†èŠ‚å·²åœ¨ &lt;u&gt;&lt;a href=&quot;https://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzI3NDIxNTQyOQ%3D%3D%26mid%3D2247489103%26idx%3D1%26sn%3D7de7c0ce7733e6d18eb3f0e95fc5e426%26chksm%3Deb163125dc61b83341aa265ad7b908e93800fce82876a9f1475d09fc13bd2901fc383ebb66b1%26scene%3D21%23wechat_redirect&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;è¿™ç¯‡æ–‡ç« &lt;/a&gt;&lt;/u&gt; ä¸­æŠ«éœ²ï¼Œåœ¨è¿™å°±ä¸èµ˜è¿°äº†ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;FAQ&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;PingCAP Talent Plan å·²ç»æˆåŠŸä¸¾åŠäº†ä¸¤æœŸï¼ŒæœŸé—´æˆ‘ä»¬æ”¶é›†äº†å­¦å‘˜çš„ä¸€äº›é—®é¢˜ï¼Œåœ¨è¿™é‡ŒæŒ‘å‡ ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Q1ï¼š&lt;a href=&quot;https://link.zhihu.com/?target=http%3A//github.com/pingcap/talent-plan&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;http://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/tale&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;nt-plan&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt; æ˜¯å¦‚ä½•ç»„ç»‡å†…å®¹çš„ï¼Ÿ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;A1ï¼štalent-plan repo é‡Œé¢æœ‰ 3 ä¸ªæ–‡ä»¶å¤¹ï¼Œ/tidb å­˜æ”¾ç€ TiDB ç›¸å…³å®éªŒï¼Œ/rust å­˜æ”¾ Rust è¯¾ç¨‹ï¼Œ/dss å­˜æ”¾ Raft å’Œ Percolatorã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Q2ï¼šdss æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;A2ï¼šå¥½é—®é¢˜ï¼Œå¯èƒ½æˆ‘ä»¬å†…éƒ¨äººå‘˜éƒ½ä¸ä¸€å®šçŸ¥é“ã€‚dss å…¶å®æ˜¯ Distributed Storage System çš„ç¼©å†™ã€‚ğŸ˜‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Q3ï¼šRaft æµ‹è¯•ä¸ºä»€ä¹ˆä¼šå¡ä½ï¼Ÿ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;A3ï¼šå¤§éƒ¨åˆ†æƒ…å†µæ˜¯åœ¨ RPC çš„ handler é‡Œé¢å†™äº†ä¼šé˜»å¡çš„ä»£ç ï¼Œå—é™äº Rust çš„ Future æœºåˆ¶ï¼Œæˆ‘ä»¬ä¸èƒ½ 100% åœ°æ¨¡æ‹Ÿ goroutineï¼Œåå°æ‰§è¡Œ Future çš„çº¿ç¨‹æ•°é‡æ˜¯æœ‰é™çš„ï¼Œå¦‚æœ RPC ä¼šé˜»å¡ï¼Œå¹¶å‘ä¸Šæ¥åå°±ä¼šå¡ä½ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Q4ï¼šdss ä¸ºä»€ä¹ˆä¼š&lt;/b&gt; #[allow(dead_code,unused)]&lt;b&gt;ï¼Ÿ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;A4ï¼šè¿™æ˜¯å› ä¸ºæˆ‘ä»¬ç•™äº†ä¸€äº›å…¬å¼€ API äº¤ç”±å­¦å‘˜å®ç°æ—¶ä½¿ç”¨ï¼Œæµ‹è¯•æœ¬èº«ä¸ä¼šç›´æ¥ç”¨åˆ°ï¼Œè¿™å°±å¯¼è‡´äº† dead code çš„è¯¯æŠ¥ã€‚è¿™äº› allow æˆ‘ä»¬æ˜¯è¦æ±‚å­¦å‘˜åœ¨æäº¤çš„ä½œä¸šçš„æ—¶å€™å»æ‰çš„ã€‚æœ‰ä¸å°‘å­¦å‘˜æ²¡æœ‰æ³¨æ„è¿™ç‚¹è€Œè¢«æ‰£åˆ†äº†ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Q5ï¼šdss éœ€ä¸éœ€è¦å†™æ³¨é‡Šï¼Ÿ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;A5ï¼šéœ€è¦ï¼ä¸å†™ä¼šæ‰£åˆ†ã€‚æˆ‘ä»¬åšä¿¡æ³¨é‡Šæ˜¯ä»£ç çš„ä¸€éƒ¨åˆ†ã€‚&lt;/p&gt;&lt;p&gt;å…³äº PingCAP Talent Plan çš„ TiKV æ–¹å‘çš„è¯¾ç¨‹æš‚æ—¶å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œæœ€åå‘ MIT 6.824 çš„å·¥ä½œäººå‘˜è‡´è°¢ï¼Œæ„Ÿè°¢ä»–ä»¬å¼€æºäº†ä¼˜ç§€çš„ Raft æ•™æã€‚&lt;/p&gt;&lt;blockquote&gt;&lt;u&gt;&lt;a href=&quot;https://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzI3NDIxNTQyOQ%3D%3D%26mid%3D2247489103%26idx%3D1%26sn%3D7de7c0ce7733e6d18eb3f0e95fc5e426%26chksm%3Deb163125dc61b83341aa265ad7b908e93800fce82876a9f1475d09fc13bd2901fc383ebb66b1%26scene%3D21%23wechat_redirect&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;PingCAP Talent Plan ç¬¬ä¸‰æœŸçº¿ä¸‹è¯¾ç¨‹&lt;/a&gt;&lt;/u&gt; å·²äºæ˜¨æ—¥å¼€å¯ï¼Œæˆ‘ä»¬æ¥åˆ°äº†åä¸­ç§‘æŠ€å¤§å­¦å¼€å§‹ä¸ºæœŸä¸€å‘¨çš„é›†ä¸­æˆè¯¾ï¼Œä¹‹åå­¦å‘˜ä»¬å°†å‰å¾€ PingCAP åŒ—äº¬æ€»éƒ¨åœ¨ Mentor çš„å¸¦é¢†ä¸‹ç»§ç»­å­¦ä¹  TiDB/TiKV ç›¸å…³çŸ¥è¯†å¹¶ä¸Šæ‰‹å®æ“ï¼Œåœ¨è¿™é‡Œé¢„ç¥å¤§å®¶é¡ºåˆ©ç»“ä¸šï¼&lt;/blockquote&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2019-07-17-73950816</guid>
<pubDate>Wed, 17 Jul 2019 00:00:00 +0800</pubDate>
</item>
<item>
<title>TiDB åœ¨å°çº¢ä¹¦ä» 0 åˆ° 200+ èŠ‚ç‚¹çš„æ¢ç´¢å’Œåº”ç”¨</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-12-73262030.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/73262030&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-7cedfad69983a016a11bce6570e03733_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;blockquote&gt;ä½œè€…ä»‹ç»ï¼š&lt;br/&gt;å¼ ä¿Šéªï¼Œå°çº¢ä¹¦æ•°æ®åº“ä¸ä¸­é—´ä»¶å›¢é˜Ÿè´Ÿè´£äºº&lt;/blockquote&gt;&lt;p&gt;å°çº¢ä¹¦ä½¿ç”¨ TiDB å†å²å¯ä»¥è¿½æº¯åˆ° 2017 å¹´ç”šè‡³æ›´æ—©ï¼Œé‚£æ—¶åœ¨ç‰©æµã€ä»“åº“ç­‰å¯¹æ–°æŠ€æœ¯æ¯”è¾ƒæ„Ÿå…´è¶£çš„åœºæ™¯ä¸‹åº”ç”¨ï¼Œåœ¨ 2018 å¹´ 5 æœˆä¹‹åï¼Œæˆ‘ä»¬å°±å¼€å§‹é€æ­¥é“ºå¼€ï¼Œå»¶å±•åˆ°å…¶ä»–é€‚åˆ TiDB çš„åœºæ™¯ä¸­å»ã€‚&lt;b&gt;æˆªæ­¢ç›®å‰ï¼Œå°çº¢ä¹¦ä½¿ç”¨çš„ TiDB èŠ‚ç‚¹æ•°åœ¨ 200+ ä¸ªï¼Œæœªæ¥ä¹Ÿæœ‰æ›´å¤§æ‰©å±•ç©ºé—´ã€‚&lt;/b&gt;&lt;/p&gt;&lt;p&gt;æœ¬æ–‡æ ¹æ®è¿‘ä¸¤å¹´ TiDB åœ¨å°çº¢ä¹¦çš„è½åœ°è¿‡ç¨‹ï¼Œå’Œå¤§å®¶ä¸€èµ·æ¢è®¨ä¸€ä¸‹ï¼Œå°çº¢ä¹¦åœ¨æ–°æ•°æ®åº“é€‰å‹çš„è€ƒè™‘å› ç´ ã€ä»¥åŠ TiDB ä»åœºæ™¯åˆ†ç±»çš„è§’åº¦æ˜¯å¦‚ä½•è€ƒé‡åŠé€æ­¥æ¨å¹¿ä½¿ç”¨çš„ã€‚å…·ä½“åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š&lt;/p&gt;&lt;p&gt;1. ç›®å‰å°çº¢ä¹¦æ•°æ®æœåŠ¡æ•´ä½“æ¶æ„ï¼Œä»¥åŠä»æ•°æ®æµè§’åº¦å¦‚ä½•å¯¹ä¸åŒæ•°æ®åº“æœåŠ¡è¿›è¡Œå®šä¹‰å’Œåˆ’åˆ†ã€‚&lt;/p&gt;&lt;p&gt;2. ä»åŸºæœ¬åŠŸèƒ½ã€æ•°æ®åŒæ­¥ã€éƒ¨ç½²ç®¡ç†ã€è¿ç»´ã€äºŒæ¬¡å¼€å‘åŠä¼˜åŒ–ã€å®‰å…¨ç­‰å¤šä¸ªç»´åº¦è§£è¯»å°çº¢ä¹¦åœ¨æ•°æ®åº“é€‰å‹çš„è€ƒè™‘å› ç´ åŠæ€è€ƒã€‚&lt;/p&gt;&lt;p&gt;3. TiDB çš„é€‚ç”¨åœºæ™¯ï¼Œä»¥åŠåœ¨å°çº¢ä¹¦å¦‚ä½•è¿›è¡Œåœºæ™¯é€‰æ‹©ã€å¦‚ä½•é€æ­¥è¿›è¡Œä¸Šçº¿è§„åˆ’ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ä¸€ã€å°çº¢ä¹¦æ•°æ®æœåŠ¡æ•´ä½“æ¶æ„&lt;/b&gt;&lt;/h2&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-327bbd12cd411a5bf8138b4d71d0cbee_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;527&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-327bbd12cd411a5bf8138b4d71d0cbee_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-327bbd12cd411a5bf8138b4d71d0cbee_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;527&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-327bbd12cd411a5bf8138b4d71d0cbee_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-327bbd12cd411a5bf8138b4d71d0cbee_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 1&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;å¦‚å›¾ 1 æ‰€ç¤ºï¼Œå°çº¢ä¹¦æ•°æ®æœåŠ¡æ•´ä½“æ¶æ„æœ€ä¸Šå±‚æ˜¯åœ¨çº¿åº”ç”¨å±‚ï¼ˆonline appï¼‰ï¼Œåº”ç”¨å±‚å¾€ä¸‹è‚¯å®šä¼šä¾èµ–ä¸€äº›ç¦»çº¿ï¼ˆofflineï¼‰æˆ–è€…åœ¨çº¿ï¼ˆonlineï¼‰çš„ databaseï¼ˆå…¶å®å®ƒæ›´å¤šçš„æ„ä¹‰åº”è¯¥ç®—å­˜å‚¨ï¼Œæ¯”å¦‚ Redis ä¹Ÿè¢«æˆ‘ä»¬ç†è§£ä¸º databaseï¼Œæ‰€ä»¥ç§°ä¹‹ä¸ºâ€œæ•°æ®æœåŠ¡â€å¯èƒ½ä¼šæ›´å¥½ï¼‰ï¼Œè¿™äº›åœ¨çº¿æ•°æ®æœåŠ¡ï¼ˆonline databaseï¼‰ä¼šæœ‰ä¸¤æ¡çº¿ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;é€šè¿‡å®æ—¶æ•°æ®æµï¼ˆdataflowï¼‰å°†æ•°æ®å¯¼å…¥åˆ°ç¦»çº¿æ•°æ®åº“ï¼ˆoffline databaseï¼‰æ”¯æ’‘ç¦»çº¿åˆ†æä»¥åŠå®æ—¶å±•ç¤ºçš„åœºæ™¯ï¼Œä¹Ÿå°±æ˜¯å›¾ 1 æœ€ä¸‹å±‚çš„å±•ç¤ºç±»æœåŠ¡ï¼ˆpresentationï¼‰å’Œæ•°ä»“ï¼ˆdata warehouseï¼‰ã€‚&lt;/li&gt;&lt;li&gt;è¿™äº›æ•°æ®è¿˜å¯èƒ½ä¼šå›çŒåˆ°çº¿ä¸Šå…¶ä»– database ä¸Šï¼Œæœ‰äº›æ˜¯ç¦»çº¿ï¼Œæœ‰äº›æ˜¯å®æ—¶ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;å›¾ 1 è“æ¡†ä¸­çš„éƒ¨åˆ†åŸºæœ¬ä¸Šéƒ½ç”±æˆ‘ä»¬å›¢é˜Ÿè´Ÿè´£ã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦ä¿è¯åœ¨çº¿æ•°æ®åº“ï¼ˆonline databaseï¼‰ çš„ç¨³å®šæ€§ã€å®‰å…¨æ€§ä»¥åŠæ€§èƒ½ä¼˜åŒ–ç­‰ï¼Œå…¶æ¬¡æˆ‘ä»¬çš„å¤šç§æ•°æ®åº“æ•°æ®åŒæ­¥æœåŠ¡ï¼ˆdatabase to database replicationï¼‰ æœ‰ç‚¹åƒé˜¿é‡Œæå‡ºçš„ data replication center è¿™ä¸ªæ¦‚å¿µï¼Œè¿™éƒ¨åˆ†ä¹ŸåŸºæœ¬ä¸Šç”±æˆ‘ä»¬å›¢é˜Ÿå…¨æƒè´Ÿè´£ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;äºŒã€å°çº¢ä¹¦æ•°æ®æœåŠ¡ç»„ä»¶é€‰å‹ RoadMap&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;å¯¹äºä¸€ä¸ªæ–°çš„æ•°æ®åº“æˆ–æ•°æ®æœåŠ¡ç»„ä»¶é€‰å‹ï¼ˆå¦‚ TiDBï¼‰ï¼Œæˆ‘ä»¬è¯¥ä»å“ªäº›æ–¹é¢å»å…¥æ‰‹ææ¸…æ¥šå®ƒçš„ç‰¹æ€§ï¼Ÿä¸‹é¢åˆ†äº«ä¸€ä¸‹æˆ‘ä»¬çš„ç»éªŒã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;1. äº§å“çš„åŸºæœ¬åŠŸèƒ½&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦è€ƒå¯Ÿè¯¥æ•°æ®æœåŠ¡/ç»„ä»¶çš„åŸºæœ¬åŠŸèƒ½ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬è¦äº†è§£å®ƒçš„è¯»å†™åœºæ™¯ï¼ŒåŒ…æ‹¬ç‚¹æŸ¥ã€æ‰¹é‡è·å–ï¼ˆbatch getï¼‰ã€èŒƒå›´æ‰«æï¼ˆrange scanï¼‰ã€è¿‡æ»¤æŸ¥è¯¢ï¼ˆfilter queryï¼‰ã€èšåˆæŸ¥è¯¢ï¼ˆaggregationï¼‰ç­‰ç­‰ã€‚ç„¶åæˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦ç¬¦åˆå“åº”æ—¶é—´ï¼ˆlatencyï¼‰ ä»¥åŠå¸¦å®½ï¼ˆbandwidthï¼Œå³èƒ½æ‰¿æ¥å¤šå°‘å¹¶å‘ï¼‰çš„è¦æ±‚ã€‚æœ€åæˆ‘ä»¬ä¼šå…³æ³¨å¯æ‰©å±•æ€§ï¼Œæ¯”å¦‚ TiDB å¯èƒ½æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯æ‰©å±•æ€§éå¸¸å¥½ã€‚è¿™å‡ ç‚¹æ˜¯å¤§å®¶éƒ½ä¼šæƒ³åˆ°çš„æœ€åŸºæœ¬çš„è¦æ±‚ï¼Œè¿™é‡Œæˆ‘å°±ä¸€ç¬”ç•¥è¿‡ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;2. æ•°æ®åŒæ­¥ä¸å¤„ç†ç›¸å…³è§£å†³æ–¹æ¡ˆ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç¬¬äºŒéƒ¨åˆ†æ˜¯æ•°æ®åŒæ­¥ä¸å¤„ç†ç›¸å…³è§£å†³æ–¹æ¡ˆã€‚è¿™é‡Œæˆ‘ä»¬æœ‰ä»¥ä¸‹ 4 ç‚¹è€ƒè™‘ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;é¦–å…ˆè€ƒè™‘è¿™ä¸ªæ•°æ®æœåŠ¡ç»„ä»¶çš„æ•°æ®åŒæ­¥æ˜¯åŒæ„æˆ–å¼‚æ„çš„åœºæ™¯ï¼ŒåŒæ„çš„åŒæ­¥æ¯”å¦‚ Redis to Redisã€MongoDB to MongoDBï¼Œå¼‚æ„çš„åŒæ­¥æ¯”å¦‚ TiDB åˆ° Kafka ç­‰ç­‰ã€‚è¿™ä¸ªæƒ…å†µåŸºæœ¬ä¸Šå¤§å®¶ä¹Ÿä¼šé‡åˆ°ï¼Œå› ä¸ºä¸€ä¸ªæ•°æ®æœåŠ¡å¾ˆéš¾åŒæ—¶æ”¯æŒä¸¤ç§æˆ–æ›´å¤šçš„åœºæ™¯ï¼Œä¸åŒçš„æ•°æ®æœåŠ¡ä¹‹é—´çš„æ•°æ®è¦ä¿æŒä¸€è‡´ï¼Œå°±ä¼šäº§ç”Ÿæ•°æ®åŒæ­¥çš„é—®é¢˜ã€‚&lt;/li&gt;&lt;li&gt;æ¥ä¸‹æ¥è€ƒå¯Ÿç¦»çº¿å¯¼å‡ºï¼Œæ¯”å¦‚å¦‚æœæˆ‘ä»¬ä¾èµ– Hiveã€ Spark åšç¦»çº¿åˆ†æï¼Œé‚£ä¹ˆå¯èƒ½è¦æ”¾åœ¨ HDFSã€S3 ç­‰å¯¹è±¡å­˜å‚¨ä¸Šï¼Œå°±éœ€è¦ç¦»çº¿å¯¼å‡ºï¼Œä¸€èˆ¬æ˜¯æ¯å¤©å¯¼å‡ºä¸€æ¬¡ã€‚&lt;/li&gt;&lt;li&gt;ç¬¬ä¸‰ç‚¹æ˜¯å®æ—¶å¯¼å‡ºï¼Œå³åœ¨å®æ—¶åœºæ™¯ä¸‹å¯èƒ½éœ€è¦å¯¼å‡ºåˆ°æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ¯”å¦‚ Kafkaã€RocketMQ ç­‰ã€‚&lt;/li&gt;&lt;li&gt;ç¬¬å››ç‚¹æ˜¯ç¦»çº¿å¯¼å…¥ï¼Œå¯¼å…¥çš„åœºæ™¯ä¸€èˆ¬æ˜¯åœ¨ç¦»çº¿çš„å¼•æ“è®¡ç®—çš„ç»“æœï¼Œä½œä¸ºè¯„ä¼°çš„æŒ‡æ ‡å†å†™å…¥çº¿ä¸Šçš„ database æä¾›æ•°æ®æœåŠ¡ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-d72434b8eb0020dcefa97c0fd4ee44bf_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic4.zhimg.com/v2-d72434b8eb0020dcefa97c0fd4ee44bf_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-d72434b8eb0020dcefa97c0fd4ee44bf_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic4.zhimg.com/v2-d72434b8eb0020dcefa97c0fd4ee44bf_r.jpg&quot; data-actualsrc=&quot;https://pic4.zhimg.com/v2-d72434b8eb0020dcefa97c0fd4ee44bf_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 2&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;&lt;b&gt;3. äº§å“çš„éƒ¨ç½²åŠç®¡ç†&lt;/b&gt;&lt;/p&gt;&lt;p&gt;éƒ¨ç½²å…¶å®éå¸¸é‡è¦ï¼Œå®ƒæ¶µç›–ä»¥ä¸‹ 5 ä¸ªæ–¹é¢ã€‚&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;b&gt;ç¬¬ä¸€ç‚¹æ˜¯ç»„ä»¶ç®¡ç†ç•Œé¢ã€‚&lt;/b&gt;å½“é›†ç¾¤å¤šåˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œå¦‚æœä½ æ²¡æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç®¡ç†ç•Œé¢ï¼Œä¼šè¿è‡ªå·±ç”¨çš„æ˜¯ä»€ä¹ˆé›†ç¾¤éƒ½è®°ä¸æ¸…æ¥šã€‚æ‰€ä»¥ç®¡ç†ç•Œé¢éå¸¸å¿…è¦ï¼Œè€Œä¸”æœ€åˆå¯èƒ½æ˜¯ 1 ä¸ªé›†ç¾¤ 1 ä¸ªç®¡ç†ç•Œé¢ï¼Œç„¶åæ˜¯ 100 ä¸ªé›†ç¾¤ 1 ä¸ªç®¡ç†ç•Œé¢ã€‚&lt;/li&gt;&lt;li&gt;&lt;b&gt;ç¬¬äºŒç‚¹æ˜¯é€‰ç‰ˆæœ¬å’Œæœºå‹ã€‚&lt;/b&gt;åœ¨ç‰ˆæœ¬é€‰æ‹©æ–¹é¢ï¼Œä¸åŒç‰ˆæœ¬æä¾›çš„åŠŸèƒ½ä¸ä¸€æ ·ï¼ŒåŒæ—¶ä¹Ÿè¦è€ƒè™‘ç‰ˆæœ¬å‡çº§çš„æˆæœ¬ã€‚åœ¨æœºå‹çš„é€‰æ‹©æ–¹é¢ï¼Œæ— è®ºæ˜¯è‡ªå»ºæœºæˆ¿ã€ç”¨äº‘ä¸»æœºï¼Œè¿˜æ˜¯ä½¿ç”¨æœ€è¿‘æ¨å‡ºæ¥çš„æ–°æ¦‚å¿µâ€œBare-Metalâ€ï¼ˆè£¸é‡‘å±ï¼‰ï¼Œæœºå‹é€‰æ‹©éƒ½æ˜¯éå¸¸ç—›è‹¦çš„äº‹æƒ…ï¼Œä½†åŒæ—¶æœºå‹é€‰æ‹©å¯¹å­˜å‚¨æ¥è¯´è‡³å…³é‡è¦ã€‚æˆ‘ä»¬ç›®å‰ç»å¤§å¤šæ•°éƒ½æ˜¯éƒ¨ç½²åœ¨è…¾è®¯äº‘å’Œ AWS ä¸Šï¼Œå¹¶ä¸”å¼€å§‹æ…¢æ…¢å°è¯•åœ¨ Bare-Metal ä¸Šçš„åº”ç”¨ã€‚&lt;/li&gt;&lt;li&gt;&lt;b&gt;ç¬¬ä¸‰ç‚¹æ˜¯ç›‘æ§ã€æŠ¥è­¦ã€æ—¥å¿—æ”¶é›†ã€‚&lt;/b&gt;æˆ‘å°†è¿™ä¸ªé—®é¢˜åˆ†ä¸ºä¸‰ä¸ªçº§åˆ«ï¼šæœºå™¨çº§ã€åº”ç”¨çº§å’Œä¸šåŠ¡çº§ã€‚æœºå™¨çº§æŒ‡æœºå™¨ä¸»æœºä¸Šçš„é—®é¢˜ï¼ŒåŒ…æ‹¬å¦‚ä½•åšç›‘æ§ã€æŠ¥è­¦ã€æ—¥å¿—æ”¶é›†ï¼Œè™½ç„¶è¿™ç‚¹ä¸è¯¥æ•°æ®æœåŠ¡ç»„ä»¶æ²¡æœ‰å¤ªå¤§å…³ç³»ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶éœ€è¦å…³æ³¨ï¼›åº”ç”¨çº§æŒ‡è¯¥æ•°æ®æœåŠ¡ç»„ä»¶çš„æŠ¥è­¦ã€ç›‘æ§ã€æ—¥å¿—æ”¶é›†å…·ä½“æ˜¯æ€ä¹ˆåšçš„ï¼›ä¸šåŠ¡çº§æŒ‡ç‰¹å®šçš„ä¸šåŠ¡æœ‰ç‰¹å®šçš„æŠ¥è­¦éœ€æ±‚ï¼Œä¾‹å¦‚ä¸€ä¸ªè®¢å•è¡¨çªç„¶æœ‰å‡ åä¸‡çš„ QPS å†™å…¥ï¼Œåœ¨å¹³æ—¶å±äºå¼‚å¸¸çš„æƒ…å†µï¼Œè¿™ç§å¼‚å¸¸æ˜¯éœ€è¦è‡ªå®šä¹‰çš„ï¼Œç”šè‡³éœ€è¦æˆ‘ä»¬åœ¨æŸäº›ç‰¹å®šä½ç½®åŸ‹ç‚¹å¹¶è¾“å‡ºç»“è®ºï¼Œå› ä¸ºå¦‚æœä¸å…³æ³¨è¿™äº›å¼‚å¸¸æƒ…å†µï¼Œå°±å¾ˆå¯èƒ½å¯¼è‡´è¿™ä¸‰ä»¶äº‹ç”¨ä¸‰ç§ä¸åŒæ¶æ„ï¼Œæœ€åéƒ¨ç½²çš„é›†ç¾¤æå…¶å¤æ‚ç¹çï¼Œä¸‰ä¸ªçº§åˆ«ç”¨äº†ä¸‰ä¸ªä¸åŒçš„ç›‘æ§å·¥å…·ï¼Œçœ‹åˆ°ä¸‰ä¸ªä¸åŒçš„ç›‘æ§ç•Œé¢ï¼Œå¯¼è‡´è¿ç»´æˆæœ¬å¢åŠ ã€‚&lt;/li&gt;&lt;li&gt;&lt;b&gt;ç¬¬å››ç‚¹æ˜¯è·¨åŒº/è·¨äº‘éƒ¨ç½²ã€‚&lt;/b&gt;è¿™ä¸€ç‚¹å¯èƒ½æ˜¯äº’è”ç½‘å…¬å¸çš„æ¯”è¾ƒå¤§çš„éœ€æ±‚ã€‚åœ¨é‡åˆ°è·¨åŒº/è·¨äº‘çš„éƒ¨ç½²çš„æ—¶å€™ï¼Œéœ€è¦è€ƒå¯Ÿè¯¥æ•°æ®æœåŠ¡ç»„ä»¶æ˜¯å¦å¤©ç”Ÿæ”¯æŒè·¨åŒº/è·¨äº‘ã€‚å¦‚æœä¸æ”¯æŒï¼Œéœ€è¦å†è€ƒè™‘æ˜¯å¦éœ€è¦å†å¯åŠ¨æ•°æ®åŒæ­¥ã€‚&lt;/li&gt;&lt;li&gt;&lt;b&gt;ç¬¬äº”ç‚¹æ˜¯è€ƒå¯Ÿé™„å±ç»„ä»¶ï¼Œ&lt;/b&gt;ä¹Ÿå°±æ˜¯ä¸è¯¥æ•°æ®æœåŠ¡ç»„ä»¶å¼ºç»‘å®šçš„å…¶ä»–ç»„ä»¶ï¼Œæ¯”å¦‚ zkã€lbã€jmx_exporter ç­‰ç­‰ï¼Œè¿™äº›ç»„ä»¶çš„éƒ¨ç½²æˆæœ¬ä¹Ÿéœ€è¦è€ƒè™‘ã€‚æˆ‘ä»¬éœ€è¦å‡å°‘ OPS æˆæœ¬ï¼Œæˆ–è€…è¯´ï¼Œä¸€ä¸ªå¥½çš„æ•´ä½“æ¶æ„è®¾è®¡èƒ½å¤Ÿé˜²æ­¢ä¸šåŠ¡ç–¯ç‹‚ä¸Šçº¿æ—¶å¾ˆå¤šæ„å¤–çš„å‡ºç°ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;b&gt;4. è¿ç»´çš„æ˜“ç”¨æ€§&lt;/b&gt;&lt;/p&gt;&lt;p&gt;è¿ç»´åŒ…æ‹¬æ‰©å®¹ã€ç¼©å®¹ã€è¿ç§»ï¼Œå…¶ä¸­è¿ç§»å¯èƒ½è¦è€ƒè™‘è·¨åŒºè¿ç§»ã€æœºå‹å‡çº§è¿ç§»ç­‰ã€‚åœ¨ä½¿ç”¨ç»´æŠ¤æŸä¸ªç»„ä»¶çš„æ—¶å€™ä¼šäº§å‡ºâ€œXX ç»„ä»¶çš„è¿ç»´æ‰‹å†Œâ€ï¼Œè¿™æ ·ä¸‹æ¬¡é‡åˆ°é—®é¢˜çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆå»çœ‹çœ‹è¿ç»´æ‰‹å†Œé‡Œå®ƒæ˜¯å¦æ˜¯ä¸€ä¸ªå·²çŸ¥é—®é¢˜ï¼Œæœ‰æ²¡æœ‰ç°æˆçš„è§£å†³æ–¹æ¡ˆã€‚åœ¨å…¬å¸äººå‘˜å˜åŠ¨æ¯”è¾ƒé¢‘ç¹æˆ–è€…ä¸šåŠ¡æ–¹ç›´æ¥ä»‹å…¥åˆ°è¿™ä¸ªåœºæ™¯çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰è¿ç»´æ‰‹å†Œï¼Œæœ‰äº›é¡¹ç›®å¾ˆéš¾è½åœ°ã€‚&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-9568e361d555d5aceb6ef272a9b62962_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-9568e361d555d5aceb6ef272a9b62962_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-9568e361d555d5aceb6ef272a9b62962_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-9568e361d555d5aceb6ef272a9b62962_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-9568e361d555d5aceb6ef272a9b62962_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 3&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;&lt;b&gt;5. äº§å“å¯ä¼˜åŒ–çš„ç©ºé—´&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ä¼˜åŒ–éƒ¨åˆ†åŸºæœ¬ä¸Šåˆ†ä¸ºé…ç½®è°ƒä¼˜ã€å®¢æˆ·ç«¯ä»£ç è°ƒä¼˜ã€äºŒæ¬¡å¼€å‘ã€ä¸‰æ¬¡å¼€å‘ã€‚å…¶ä¸­äºŒæ¬¡å¼€å‘å°±æ˜¯åœ¨ç°æœ‰çš„å¼€æºäº§å“ä¸Šå†å¼€å‘ï¼Œä¿®å¤ bug æˆ–è€…è‡ªå·±å®ç°æŸäº›æ–°å¢åŠŸèƒ½/å·¥å…·ï¼Œæœªæ¥å¯èƒ½è¿˜ä¼šè´¡çŒ®ç»™ç¤¾åŒºï¼›è€Œä¸‰æ¬¡å¼€å‘åˆ™æ˜¯è‡ªå·±å†™ä¸€ä¸ªå’ŒæŸäº›ç»„ä»¶ç±»ä¼¼çš„ä¸œè¥¿ï¼Œç›´æ¥æ›¿æ¢æ‰ã€‚åœ¨å°çº¢ä¹¦å†…éƒ¨ï¼ŒäºŒæ¬¡å¼€å‘æ˜¯æ¯”è¾ƒä¸»æµçš„ï¼Œä¸‰æ¬¡å¼€å‘å¾ˆå°‘ï¼Œæ¯•ç«Ÿä»é›¶å¼€å§‹è‡ªç ”ä¸€ä¸ªç»„ä»¶åˆ°é€‚åº”ç‰¹å®šä¸šåŠ¡åœºæ™¯ï¼Œå…¶å®æ˜¯è·Ÿä¸ä¸Šæˆ‘ä»¬çš„ä¸šåŠ¡ä¸Šçº¿èŠ‚å¥çš„ï¼Œæ‰€ä»¥ä¸‰æ¬¡å¼€å‘è‡³å°‘çœ¼ä¸‹ä¸é€‚åˆä½œä¸ºæˆ‘ä»¬ä¸»è¦çš„æ”»åšæ–¹å‘ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;6. å…¶ä»–è€ƒè™‘å› ç´ &lt;/b&gt;&lt;/p&gt;&lt;p&gt;æœªæ¥åœ¨å°çº¢ä¹¦æ•°æ®æœåŠ¡ç»„ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬ä¼šåšå¾ˆå¤šå®Œå–„å·¥ä½œï¼Œæ¯”å¦‚å®‰å…¨ã€å®¡è®¡ã€æœåŠ¡åŒ–ã€å®¹å™¨åŒ–ç­‰æ–¹é¢çš„äº‹æƒ…ã€‚è­¬å¦‚æˆ‘ä»¬ç›®å‰åœ¨éƒ¨ç½²ä¸€ä¸ªç»„ä»¶çš„æ—¶å€™ï¼Œå®¹å™¨åŒ–è¿˜æ²¡æœ‰åœ¨è®¨è®ºèŒƒå›´ä¹‹å†…ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ç”¨å®¹å™¨éƒ¨ç½²å°±å®¹å™¨éƒ¨ç½²ï¼Œéœ€è¦åœ¨è™šæ‹Ÿæœºä¸Šéƒ¨ç½²å°±åœ¨è™šæ‹Ÿæœºä¸Šéƒ¨ç½²ï¼Œå¹¶æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„ç»“è®ºå€¾å‘ã€‚å½“ç„¶ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæœªæ¥å®¹å™¨åŒ–æ˜¯ä¸€ä¸ªä¸»æµè¶‹åŠ¿ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;ä»¥ä¸Šå°±æ˜¯å°çº¢ä¹¦çš„æ•°æ®æœåŠ¡ç»„ä»¶é€‰å‹çš„ RoadMapï¼Œçœ‹èµ·æ¥è·Ÿæ¥ä¸‹æ¥è¦è®²çš„â€œTiDB åœ¨å°çº¢ä¹¦å¤šåœºæ™¯ä¸‹çš„åº”ç”¨â€æ²¡æœ‰å¤ªå¤§çš„å…³ç³»ï¼Œä½†æˆ‘è®¤ä¸ºåœ¨åšåº”ç”¨ä¹‹å‰åº”è¯¥å…ˆæŠŠä¸Šé¢åˆ—ä¸¾çš„è¿™äº›æ–¹å‘æ€è€ƒæ¸…æ¥šï¼Œè¿™æ ·ä¼šå¯¹æœªæ¥è½åœ°å·¥ä½œçš„æŠ•å…¥äº§å‡ºæ¯”äº§ç”Ÿéå¸¸å¤§çš„å½±å“ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ€è¿‘æŒ‰ç…§ä¸Šé¢çš„æ–¹å‘è°ƒç ” Tidis å’Œ TiFlash çš„æ—¶å€™é€Ÿåº¦å°±å¿«å¾ˆå¤šã€‚&lt;/b&gt;&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ä¸‰ã€TiDB åœ¨å°çº¢ä¹¦å¤šåœºæ™¯ä¸‹çš„åº”ç”¨&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;&lt;b&gt;åœºæ™¯ 1ï¼šå±•ç¤ºç±»ä¸šåŠ¡&lt;/b&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-93a05a95399afc0a9be78f895e21c6a2_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;522&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-93a05a95399afc0a9be78f895e21c6a2_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-93a05a95399afc0a9be78f895e21c6a2_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;522&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-93a05a95399afc0a9be78f895e21c6a2_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-93a05a95399afc0a9be78f895e21c6a2_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 4&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;TiDB åœ¨å°çº¢ä¹¦çš„ç¬¬ä¸€ä¸ªåº”ç”¨åœºæ™¯æ˜¯å±•ç¤ºç±»ä¸šåŠ¡ï¼Œå®ƒçš„ pipeline å¦‚å›¾ 4 ä¸­çº¢è‰²éƒ¨åˆ†æ‰€ç¤ºï¼Œçº¿ä¸Šä¸€èˆ¬æ˜¯ MongoDB æˆ–è€… MySQLï¼Œé€šè¿‡ä¸€æ¡å®æ—¶æ•°æ®æµï¼ˆrealtime dataflowï¼‰ è¿æ¥ Redis æˆ–è€… TiDBï¼Œæœ€åå®ç° presentation åŠŸèƒ½ã€‚æ¥ä¸‹æ¥ä»‹ç»è¿™ç±»åœºæ™¯ä¸‹çš„ä¸¤ä¸ªå…·ä½“é¡¹ç›®ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;é¡¹ç›® 1ï¼šå¤§ä¿ƒå®æ—¶çœ‹æ¿&lt;/b&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-3fa8ab771e479bfb23ea140e996900ee_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-3fa8ab771e479bfb23ea140e996900ee_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-3fa8ab771e479bfb23ea140e996900ee_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-3fa8ab771e479bfb23ea140e996900ee_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-3fa8ab771e479bfb23ea140e996900ee_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 5&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;ç¬¬ä¸€ä¸ªé¡¹ç›®æ˜¯å¤§ä¿ƒå®æ—¶çœ‹æ¿ï¼Œåœ¨å»å¹´åŒåä¸€æœŸé—´ä¸Šçº¿ï¼Œå½“æ—¶æˆ‘ä»¬çš„èŠ‚å¥ä¹Ÿæ¯”è¾ƒå¿«ï¼Œ7ã€8 æœˆå¼€å§‹è°ƒç ”ï¼Œ11 æœˆå°±ä¸Šå¤§ä¿ƒä¸šåŠ¡ã€‚&lt;/p&gt;&lt;p&gt;å½“æ—¶è¯¥é¡¹ç›®ä¸‹ä¸€å…±æœ‰ 8 ä¸ªå®æ—¶æŠ¥è¡¨ï¼ŒQPS å†™å…¥å‡å€¼ 5Kï¼Œå¤§ä¿ƒæ´»åŠ¨å¼€å§‹æ—¶ QPS å³°å€¼æ¥è¿‘ 200K/ç§’ï¼Œæ¯è¿‡ 2s ä¼šæœ‰è¾ƒå¤§çš„èšåˆæŸ¥è¯¢ queryï¼Œèšåˆç»“æœè¿˜éœ€è¦å†™å…¥ Redis å† pop åˆ° TiDBï¼Œé›†ç¾¤è§„æ¨¡æ–¹é¢åªç”¨äº† 10 ä¸ª TiKV å’Œ 3 ä¸ª PDã€‚è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æä¸€ä¸‹ï¼Œå½“æ—¶æ¯ä¸ªèŠ‚ç‚¹æŒ‚äº† 3.5T * 4 å—çš„ NVME SSDï¼Œä½†æ˜¯åæ¥äº‹å®è¯æ˜è¿™ä¸ªé€‰å‹æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºå¤§ä¿ƒçš„æ—¶å€™æˆ‘ä»¬äººäººéƒ½åœ¨ç›¯ç€ï¼Œç£ç›˜åäº†ä¼šç«‹åˆ»å¾—åˆ°è§£å†³ï¼Œæ‰€ä»¥å³ä½¿æŠŠå››å—ç›˜åšäº† raid0ï¼Œç„¶åä¸Šçº¿äº†ï¼Œæ ¹æœ¬æ— æ³•ç¡®å®š NVME ç›˜å‡ºé—®é¢˜çš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Œåæ¥å·®ä¸å¤šæ¯ä¸ªæœˆä¼šå‡ºç°ä¸€ä¸¤æ¬¡ç±»ä¼¼çš„æ•…éšœï¼Œæ•…éšœç‡å¾ˆé«˜ï¼Œè™½ç„¶æˆ‘ç›¸ä¿¡æœªæ¥ NVME ä¼šåšå¾—æ›´å¥½ï¼Œä½†è¿™æ ·é«˜çš„æ•…éšœç‡ä»è®¾è®¡è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªé€‰å‹å°±æœªå¿…æ˜¯æœ€åˆé€‚çš„ã€‚&lt;/p&gt;&lt;p&gt;åœ¨å®ç°ä¸Šï¼Œæˆ‘ä»¬é‡åˆ°çš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ä¿è¯æœ€ç»ˆä¸€è‡´æ€§çš„å†™å…¥ã€‚æˆ‘ä»¬åšäº†å¤šçº¿ç¨‹å†™å…¥ï¼Œæ¯ä¸ªçº¿ç¨‹å†™å…¥ç‰¹å®šçš„è®°å½•ï¼Œä¿è¯çº¿ç¨‹ä¹‹é—´ä¸ä¼šå†²çªã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜åšäº†ä¸€äº›è°ƒä¼˜å·¥ä½œï¼Œ&lt;b&gt;æˆ‘ä»¬å‘ç°æ¯ä¸€ä¸ªäº‹åŠ¡çš„ batch insert size è®¾ç½®ä¸º 100 æ—¶èƒ½è¾¾åˆ°ååã€å»¶è¿Ÿç»¼åˆæœ€ä¼˜çš„è¦æ±‚ã€‚&lt;/b&gt;æœ€åˆä¸šåŠ¡ä¾§è®¾ç½®çš„ batch size éå¸¸å¤§ï¼Œåæ¥å‘ç°äº‹åŠ¡ä¹‹é—´å†²çªçš„æ¦‚ç‡ã€å“åº”çš„æ—¶é—´ç­‰ç­‰éƒ½ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œä½† batch size è®¾ç½®ä¸º 1ï¼Œé‚£ä¹ˆå¹¶å‘åˆä¼šæˆä¸ºä¸€ä¸ªé—®é¢˜ã€‚æ‰€ä»¥ç»è¿‡äº†ä¸€æ®µæ—¶é—´çš„è°ƒä¼˜ï¼Œæœ€åå¾—åˆ°äº†å‰é¢çš„ç»“è®ºã€‚è¿™ä¸ªå‚æ•°å¤§å®¶å¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå·±è°ƒæ•´ï¼Œç”¨äºŒåˆ†æ³•/æŠ˜çº¸æ³•è¯•éªŒå°±å¯ä»¥å¾—åˆ°ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;è¿™ä¸ªé¡¹ç›®æœ€ç»ˆå…¨ç¨‹å†™å…¥å’ŒæŸ¥è¯¢åœ¨å¤§ä¿ƒæœŸé—´ä¿æŒç¨³å®šï¼Œå†™å…¥æ—¶å»¶å°äº 20msï¼ŒæŸ¥è¯¢æ—¶å»¶å°äº 1s&lt;/b&gt;ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ 2s åšä¸€æ¬¡æŸ¥è¯¢ï¼Œè¿™ä¸ªå“åº”æ—¶é—´æ˜¯èƒ½æ»¡è¶³è¦æ±‚çš„ã€‚&lt;/p&gt;&lt;h3&gt;&lt;b&gt;é¡¹ç›® 2ï¼šå®æ—¶ä¸šåŠ¡æ•°æ®å±•ç¤º&lt;/b&gt;&lt;/h3&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-668e675eef2bc8590d0fce00b72c1f40_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic1.zhimg.com/v2-668e675eef2bc8590d0fce00b72c1f40_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-668e675eef2bc8590d0fce00b72c1f40_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic1.zhimg.com/v2-668e675eef2bc8590d0fce00b72c1f40_r.jpg&quot; data-actualsrc=&quot;https://pic1.zhimg.com/v2-668e675eef2bc8590d0fce00b72c1f40_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 6&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;è¿™ä¸ªé¡¹ç›®èƒŒæ™¯æœ‰ä¸¤ç‚¹ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;ç¬¬ä¸€ï¼Œæˆ‘ä»¬ä¸šåŠ¡æ–¹æœ‰å®æ—¶åˆ†æçš„éœ€æ±‚ï¼Œéœ€è¦å®æ—¶è§‚æµ‹çº¿ä¸Šåº“å†™å…¥å†…å®¹ï¼Œå¯èƒ½æ˜¯é’ˆå¯¹æŸä¸ªç”¨æˆ·åšä¸€äº›æŸ¥è¯¢ï¼Œè¿˜å¯èƒ½æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„ queryï¼Œæ¯”å¦‚éœ€è¦å¿«é€Ÿçœ‹åˆ°æ–°ä¸Šçº¿åŠŸèƒ½çš„æ•ˆæœï¼Œå°¤å…¶æ˜¯åœ¨å®éªŒä»¥åŠé£æ§ç­‰é¡¹ç›®ä¸Šå“åº”æ—¶é—´è¦æ±‚éå¸¸é«˜ã€‚&lt;/li&gt;&lt;li&gt;å…¶æ¬¡éœ€è¦ä½œä¸ºç¦»çº¿ ETL ä»»åŠ¡çš„æ•°æ®æºï¼ŒåŒæ—¶éœ€è¦é¢„å¤‡æ”¹ä¸ºçº¿ä¸ŠæœåŠ¡ã€‚ç›˜ç®—ä¸€ä¸‹ä¸šåŠ¡é‡ï¼Œæ€»å…±æ”¯æŒéœ€è¦è¶…è¿‡ä¸€ç™¾ä¸ª MongoDB æˆ– MySQL æ•°æ®åº“çš„å®æ—¶å±•ç¤ºï¼Œå³°å€¼æ€»è¯»å†™ QPS è¶…è¿‡ 500Kï¼Œç°åœ¨çš„ä¸šåŠ¡éœ€æ±‚å¤§æ¦‚è¿™ä¸ªé‡çº§ï¼Œæœªæ¥å¯èƒ½ä¼šæ›´é«˜ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;æˆ‘ä»¬å½“å‰è€ƒè™‘æ˜¯æŒ‰ä¸šåŠ¡çº¿å»æ‹†åˆ†é›†ç¾¤ï¼Œéƒ¨åˆ†æ ¸å¿ƒè¡¨ä¸€å¼å¤šä»½ã€‚æ¯”å¦‚ç”¨æˆ·è¡¨å¯èƒ½æœ‰å¤šä¸ªä¸šåŠ¡ä¾èµ–ï¼Œæ¯”å¦‚ç¤¾åŒºä¸šåŠ¡ã€è®¢å•ç‰©æµä¸šåŠ¡ç­‰ç­‰ï¼Œä½†å¦‚æœæŒ‰ç…§ä¸šåŠ¡çº¿æ‹†åˆ†é›†ç¾¤ä¹‹åï¼Œå°±æ— æ³•åš Join äº†ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸èƒ½æ¥å—çš„ï¼Œæ‰€ä»¥å¯¹æ ¸å¿ƒè¡¨ä¼šä»¥ä¸€å¼å¤šä»½çš„å½¢å¼å­˜åœ¨ã€‚å®é™…ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ç‚¹æŸ¥ï¼Œæ¯”å¦‚æŸ¥ç‰¹å®šç”¨æˆ·ã€ç‰¹å®šè®¢å•çš„çº¿ä¸ŠçŠ¶æ€ï¼ŒåŒæ—¶æœ‰å°‘é‡çš„å•è¡¨èšåˆæŸ¥è¯¢å’Œè·¨è¡¨ Join æŸ¥è¯¢ã€‚æ¢å¥è¯è¯´ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå®æ—¶çš„æ•°æ®ä»“åº“ï¼Œä½†åˆä¸åšå¤æ‚ ETLï¼Œæ›´å¤šä¾èµ–çº¿ä¸ŠçœŸå®æ•°æ®ã€‚&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬çš„è®¾è®¡æ–¹æ¡ˆæ˜¯æŠŠ TiDB ä½œä¸ºä¸€ä¸ª MySQL/MongoDB çš„ä»åº“ï¼Œä½†å¯¹äº MongoDB æ¥è¯´å¯èƒ½è¿˜è¦åšä¸€ç‚¹åŒæ­¥ä»»åŠ¡çš„æ•°æ®æ”¹é€ å·¥ä½œã€‚ç°åœ¨è§„æ¨¡æ˜¯ 10 èŠ‚ç‚¹ TiKV + 3 èŠ‚ç‚¹ PD çš„é›†ç¾¤æ€»å…±æœ‰ 3 ä¸ªï¼Œåé¢å¯èƒ½ä¼šæŒ‰éœ€æ±‚æ‰©å¢ã€‚&lt;/p&gt;&lt;p&gt;åœ¨å®è·µç»†èŠ‚ä¸Šï¼Œé¦–å…ˆæˆ‘ä»¬ä¼šåŸºäº Canal å»åš oplog/binlog çš„å®æ—¶åŒæ­¥ã€‚å…¶æ¬¡ï¼Œç›®å‰æˆ‘ä»¬å¯¹åŠ åˆ—ä¹‹å¤–çš„ DDL æ”¯æŒå¾—ä¸å¤Ÿå¥½ï¼Œè¿™éƒ¨åˆ†è¿˜éœ€è¦ DBA æ‰‹å·¥ä»‹å…¥ï¼Œä½†åœ¨æœªæ¥ä¼šæœ‰ä¸€äº›æ”¹è¿›ã€‚æœ€åæ˜¯å¤šç§Ÿæˆ·é—®é¢˜ï¼Œæ¯”å¦‚åˆ¤æ–­æŸä¸ªéƒ¨é—¨çš„åŒäº‹æ˜¯å¦æœ‰æƒé™è®¿é—®å¦ä¸€ä¸ªéƒ¨é—¨çš„æ•°æ®åº“ï¼Œè¿™ä»¶äº‹åœ¨çº¿ä¸Šä¼šéå¸¸å¤´ç–¼ï¼Œç°åœ¨åœ¨æ¥å…¥å±‚è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å†…éƒ¨æœ‰ä¸€ä¸ªå« venus çš„å±•ç¤ºå¹³å°ï¼Œå°†ä¸Šå±‚å…¨é“¾æ§åˆ¶ã€è®¤è¯ç­‰äº‹æƒ…å»æ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸ç”¨å…³æ³¨è¿™ä»¶äº‹äº†ï¼Œè‡³å°‘çœ¼ä¸‹ä¸ç”¨å…³æ³¨ã€‚è¿™ä¸ªé¡¹ç›®å·²ç»å¼€å§‹é€æ­¥ä¸Šçº¿ï¼ŒåŸºæœ¬ä¸Šæ¶æ„å·²ç»ç¡®å®šã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;åœºæ™¯ 2ï¼šåˆ†æç±»ä¸šåŠ¡&lt;/b&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-b69e82426b3c57bf15d37dbe9453cdc8_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic1.zhimg.com/v2-b69e82426b3c57bf15d37dbe9453cdc8_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-b69e82426b3c57bf15d37dbe9453cdc8_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic1.zhimg.com/v2-b69e82426b3c57bf15d37dbe9453cdc8_r.jpg&quot; data-actualsrc=&quot;https://pic1.zhimg.com/v2-b69e82426b3c57bf15d37dbe9453cdc8_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 7&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;åˆ†æç±»ä¸šåŠ¡çš„ pipeline å¦‚å›¾ 7 æ‰€ç¤ºï¼Œæœ€åçš„ data warehouse æ„å»ºåœ¨ AWS ä¸Šã€‚&lt;/p&gt;&lt;h3&gt;&lt;b&gt;é¡¹ç›® 3ï¼šåˆ†åº“åˆ†è¡¨ MySQL ETL&lt;/b&gt;&lt;/h3&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-bfbf658472f0fdcc53ade07cf3b9f26c_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic1.zhimg.com/v2-bfbf658472f0fdcc53ade07cf3b9f26c_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-bfbf658472f0fdcc53ade07cf3b9f26c_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic1.zhimg.com/v2-bfbf658472f0fdcc53ade07cf3b9f26c_r.jpg&quot; data-actualsrc=&quot;https://pic1.zhimg.com/v2-bfbf658472f0fdcc53ade07cf3b9f26c_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 8&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;è¿™ä¸ªåœºæ™¯ä¸‹çš„ç¬¬ä¸€ä¸ªé¡¹ç›®æ˜¯åšåˆ†åº“åˆ†è¡¨çš„ MySQL ETLã€‚ä»¥æœ€å¤§çš„è¡¨ä¸ºä¾‹ï¼Œä¸Šæ¸¸ 10 èŠ‚ç‚¹çš„MySQLï¼Œå…±è®¡ 10000 ä¸ªåˆ†è¡¨ï¼Œå­˜é‡æ•°æ® 1000 äº¿æ¡å·¦å³ï¼Œæ¯æ—¥å¢é‡ 10 äº¿+ï¼ŒQPS å†™å…¥å‡å€¼ 3000 æ¡/sï¼Œå³°å€¼æ¥è¿‘ 10000 æ¡/sï¼Œå¹³å°ä¿ƒé”€æ´»åŠ¨å¯¹è¿™éƒ¨åˆ†å½±å“ä¹Ÿä¸å¤§ï¼Œç”šè‡³åè€Œä¼šé™ä½ï¼Œå› ä¸ºæ´»åŠ¨ä¸»è¦æ˜¯ç”µå•†éƒ¨é—¨åœ¨åšï¼Œç¤¾åŒºçš„æŸ¥è¯¢éœ€æ±‚åè€Œå˜å°‘ã€‚æˆ‘ä»¬åœ¨ TiDB ç¦»çº¿åº“ä¿ç•™äº†å¤§çº¦ 30 å¤©å¢é‡ç›‘æ§æ•°æ®ï¼Œå…¨é‡æ•°æ®å­˜åœ¨ S3 ä¸Šï¼Œæ¯æ—¥å¤œé—´ï¼ˆç™½å¤©å¶å°”ï¼‰ä¼šæœ‰åŸºäº sqoop çš„æŠ½æ•°ä»»åŠ¡è§¦å‘ã€‚é›†ç¾¤è§„æ¨¡æ–¹é¢ï¼Œç›®å‰ä½¿ç”¨ 10 èŠ‚ç‚¹ TiKV + 3 èŠ‚ç‚¹ PDã€‚&lt;/p&gt;&lt;p&gt;åœ¨å®è·µç»†èŠ‚æ–¹é¢ï¼Œé¦–å…ˆæˆ‘ä»¬å¯¹ MySQL è‡ªå¢ ID è¿›è¡Œäº†å¤„ç†ï¼Œç„¶åå¯¹ sqoop è¿›è¡Œäº†ä¸€äº›åŸºäº TiDB çš„ç»†èŠ‚ä¸Šé€‚é…ï¼Œæœ€åè°ƒæ•´ TiDB çš„ max transaction size ä»¥ä¼˜åŒ–æŠ½å–ç‡ã€‚&lt;b&gt;é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå€¼å¾—ä¸€æçš„äº‹æƒ…ï¼Œå› ä¸ºå®ä½“æ•°æ®ï¼ˆç”¨æˆ·/ç¬”è®°/è®¢å•æ•°æ®ç­‰ï¼‰ä¸å®œç¡¬åˆ é™¤ï¼Œä½†æ˜¯åœ¨ MySQL å…³ç³»è¡¨åšè½¯åˆ é™¤æ˜¯éå¸¸å¯æ€•çš„äº‹æƒ…ï¼Œæœ€åå¯èƒ½ä¼šå› ä¸ºæ•°æ®é‡å¤ªè¿‡äºåºå¤§é€ æˆé›ªå´©ã€‚ä½† TiDB ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬æŠŠçº¿ä¸Šçš„ç¡¬åˆ é™¤å˜æˆäº† TiDB çš„è½¯åˆ é™¤ï¼Œè¿™å¯¹äºæ•°ä»“æ¥è¯´æ˜¯éå¸¸æœ‰ä»·å€¼çš„äº‹æƒ…ã€‚&lt;/b&gt;å¯¹äºæ¯å¤©å…¨é‡æŠ½æ•°çš„è¡¨æ¥è¯´ï¼Œæ— è®ºè½¯ç¡¬åˆ é™¤ï¼Œç¬¬äºŒå¤©æ•°ä»“é‡Œçš„æ•°æ®æ€»æ˜¯å¯¹çš„ã€‚ä½†æ˜¯å¯¹äºå¤§æ•°é‡çš„åœºæ™¯ï¼Œå…¨é‡æŠ½æ•°ä»£ä»·è¿‡é«˜ï¼Œå°±ä¼šé‡‡å–å¢é‡æŠ½å–çš„æ–¹å¼ï¼Œå³è®¾ç½®ä¸€ä¸ªæ¡ä»¶ï¼Œä¸€èˆ¬æ˜¯ update_time ä¸ºä»Šå¤©ã€‚è¿™æ—¶å€™ç¡¬åˆ é™¤å°±å­˜åœ¨é—®é¢˜äº†ï¼šä¸Šé¢çš„ query æ¡ä»¶æ— æ³•åˆ¤æ–­ä¸€æ¡è®°å½•ç©¶ç«Ÿæ˜¯è¢«åˆ é™¤äº†ï¼Œè¿˜æ˜¯åœ¨å½“å¤©æ²¡æœ‰è¢«æ›´æ–°ã€‚è€Œå‰é¢åˆæåˆ°ï¼Œå…³ç³»è¡¨ä¸Šæ˜¯ä¸é€‚åˆåšè½¯åˆ é™¤çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨åš ETL çš„æ—¶å€™ï¼Œçº¿ä¸Šåš delete çš„æ“ä½œï¼Œæˆ‘ä»¬åœ¨ TiDB ä¸Šä¼šæ–°å¢ä¸€ä¸ª is_deleted å­—æ®µï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º trueã€‚è¿™ä¸ªæ—¶å€™æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œåˆ é™¤è¿™ä¸ªæ“ä½œçš„æ—¶é—´æˆ³æ€ä¹ˆè®¾ç½®ã€‚åˆ é™¤è¿™ä¸ªæ“ä½œæ—¶çš„æ—¶é—´æˆ³æ˜¯è·Ÿæ™®é€šå†™å…¥çš„æ—¶é—´æˆ³ä¸ä¸€æ ·çš„ã€‚æ™®é€šçš„å†™å…¥ï¼Œæ—¶é—´æˆ³å°±æ˜¯çº¿ä¸Šåº“çš„ update timeï¼Œä½†æ˜¯åˆ é™¤çš„æ—¶å€™æ˜¯ä¸ä¼šå¸¦ä¸Šçº¿ä¸Šçš„ update_time çš„ï¼Œæ‰€ä»¥å› ä¸ºè¿™æ¡è®°å½•è¢«ç¡¬åˆ é™¤äº†ï¼Œæ—¶é—´æˆ³éƒ½æ‰¾ä¸åˆ°äº†ï¼Œè¿™æ—¶æˆ‘ä»¬åªèƒ½ç”¨æ”¶åˆ°è¿™æ¡æ¶ˆæ¯çš„ update_time å»åšå®ƒçš„æ—¶é—´æˆ³ï¼Œè¿™æ—¶å°±ä¼šæœ‰äº›å°é—®é¢˜ï¼Œå½“ç„¶è¿™ä¸ªé—®é¢˜æˆ‘ä»¬è¿˜æ²¡æœ‰å®Œå…¨è§£å†³æ‰ï¼Œå‡è®¾å¤§å®¶æœ‰ç±»ä¼¼çš„éœ€æ±‚çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ç§ä¸‹äº¤æµè®¨è®ºã€‚ç›®å‰è¿™ä¸ªé¡¹ç›®å·²ç»ä¸Šçº¿ï¼Œè¿è¡Œç¨³å®šã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;é¡¹ç›® 4ï¼šMySQL å½’æ¡£&lt;/b&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-a0c4c6eec24a31c2d3c0b500a561d3b6_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-a0c4c6eec24a31c2d3c0b500a561d3b6_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-a0c4c6eec24a31c2d3c0b500a561d3b6_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-a0c4c6eec24a31c2d3c0b500a561d3b6_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-a0c4c6eec24a31c2d3c0b500a561d3b6_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 9 &lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;é¡¹ç›® 4 MySQL å½’æ¡£æ˜¯åŸºäºé¡¹ç›® 3 çš„æ¼”è¿›ã€‚ä¸šåŠ¡èƒŒæ™¯æ–¹é¢ï¼Œä»¥æœ€å¤§çš„è¡¨ä¸ºä¾‹ï¼Œä¸»è¦ä¸ºç‰©æµä»“å‚¨éƒ¨é—¨çš„è®¢å•åŠè¡ç”Ÿä¿¡æ¯ï¼Œå­˜é‡éå¸¸éå¸¸å¤§ï¼Œæ¯æœˆè¿›è¡Œå½’æ¡£åˆ° TiDB çš„æ•°æ®æœ‰æ•°åäº¿ï¼Œä½†å¯¹ QPS è¦æ±‚ä¸æ˜¯å¾ˆé«˜ï¼Œä¸ä¸šåŠ¡æ–¹è®¨è®ºä¹‹åæš‚å®šï¼Œè¿‡å»ä¸€å¹´åŠçš„è®°å½•å­˜æ”¾åœ¨ TiDB ä¾›ä¸šåŠ¡æ–¹æŸ¥è¯¢ï¼Œæ›´ä¹…è¿œçš„è®°å½•å½’æ¡£åˆ° S3/Cos ä¸Šã€‚&lt;/p&gt;&lt;p&gt;é¡¹ç›® 4 ä¸é¡¹ç›® 3 ä»£ç ç›¸æ¯”å¤„ç†çš„åœºæ™¯æ›´å¤æ‚ä¸€äº›ï¼Œå› ä¸ºå®ƒä¹‹å‰ MySQL çš„åˆ†åº“åˆ†è¡¨é€»è¾‘ä¸åƒé¡¹ç›® 3 é‚£äº›æ¸…æ™°ï¼Œé›†ç¾¤è§„æ¨¡ä¹Ÿä¼šç›¸å¯¹å¤§ä¸€äº›ï¼Œç›®å‰æ˜¯ 25 ä¸ª TiKV èŠ‚ç‚¹ + 3 ä¸ª PD èŠ‚ç‚¹ï¼Œæœªæ¥å¯æœ‰æ‰©å®¹çš„éœ€æ±‚ã€‚å®ç°ç»†èŠ‚ä¸Šï¼Œé¡¹ç›® 4 å’Œé¡¹ç›® 3 ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;åœºæ™¯ 3ï¼šçº¿ä¸ŠæœåŠ¡&lt;/b&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-385b457fceacd6bdf22300a0ea3ae60e_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-385b457fceacd6bdf22300a0ea3ae60e_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-385b457fceacd6bdf22300a0ea3ae60e_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-385b457fceacd6bdf22300a0ea3ae60e_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-385b457fceacd6bdf22300a0ea3ae60e_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 10&lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;TiDB æ¥å…¥å®æ—¶æ•°æ®å†™å…¥æœåŠ¡çš„ä¸šåŠ¡æœ‰ä»¥ä¸‹å››ä¸ªè€ƒè™‘ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;ç¬¬ä¸€ç‚¹æ˜¯ä»£ç æ›´æ”¹æˆæœ¬ï¼Œè¿™ä¸€é¡¹æˆæœ¬å·²ç»æ¯”è¾ƒä½äº†ï¼Œå› ä¸ºåŸºæœ¬ä¸Šéƒ½æ˜¯ jdbc è¿æ¥ï¼Œä½†å¤šå¤šå°‘å°‘ä¼šæœ‰ä¸€äº›å˜æ›´ã€‚&lt;/li&gt;&lt;li&gt;ç¬¬äºŒç‚¹æ˜¯æ•°æ®è¿ç§»æˆæœ¬ï¼Œå¯¹äºå·²ç»ä¸Šçº¿çš„ä¸šåŠ¡æ¥è¯´ï¼Œè¿ç§»æ•°æ®éƒ½æ˜¯ä¸€ä»¶éå¸¸è´¹åŠ²çš„äº‹æƒ…ï¼Œå°¤å…¶æ˜¯æˆ‘ä»¬è¿˜è¦æ±‚ä¸åœæœåŠ¡è¿›è¡Œçƒ­è¿ç§»çš„è¯ã€‚&lt;/li&gt;&lt;li&gt;ç¬¬ä¸‰ç‚¹æ˜¯è¿ç»´æˆæœ¬ï¼Œä»åŸæœ¬çš„ MySQL åˆ‡æ¢åˆ°æˆ‘ä»¬è‡ªå·±ç»´æŠ¤ TiDB ï¼Œå…¶å®æ— å½¢ä¸­å¢åŠ äº†è¿ç»´æˆæœ¬ï¼Œå°¤å…¶æ˜¯åœ¨æŒ‚ç›˜ç‡æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸‹ã€‚&lt;/li&gt;&lt;li&gt;ç¬¬å››ç‚¹æ˜¯æŠ€æœ¯æ ˆæˆæœ¬ï¼Œå› ä¸ºæœ‰äº›äººå¯¹ TiDB ä¸ç†Ÿæ‚‰ï¼Œä¼šæ¯”è¾ƒå®³æ€•æ¥è§¦å’Œä½¿ç”¨ï¼Œç»å¤§éƒ¨åˆ†äººæ›´æ„¿æ„ç”¨è‡ªå·±ç†Ÿæ‚‰çš„ä¸œè¥¿ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªçŸ¥è¯†å­¦ä¹ çš„è¿‡ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªæˆæœ¬ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;b&gt;ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰ä¸€éƒ¨åˆ†çº¿ä¸Šä¸šåŠ¡ä» Hive ç¦»çº¿å¯¼å…¥åˆ° TiDB åš T+1 çº§åˆ«æ•°æ®æœåŠ¡ï¼Œè€Œä¸”æˆ‘ä»¬æ–°ä¸Šçº¿ä¸šåŠ¡çš„å…³ç³»å‹æ•°æ®åº“é€‰å‹å·²ç»å¼€å§‹å€¾å‘äº TiDBï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒçš„æ‰©å±•æ€§ä¸ºæˆ‘ä»¬èŠ‚çœäº†å¾ˆå¤§çš„æ—¶é—´æˆæœ¬ï¼Œå°¤å…¶æ˜¯ä¸šåŠ¡å¢é•¿æ¯”è¾ƒå¿«çš„æƒ…å†µä¸‹ï¼Œé€‰æ‹© MySQL åˆ†åº“åˆ†è¡¨å…¶å®æ˜¯ä¸€ä»¶ä»£ä»·æå…¶å¤§çš„äº‹æƒ…ã€‚&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;æˆ‘è®°å¾—ä¹‹å‰æœ‰åŒäº‹é—®äº†ä¸€ä¸ªé—®é¢˜ï¼Œè¯´è¿™ä¸ªåœºæ™¯ç”¨åˆ«çš„ä¸œè¥¿ä¹Ÿå¯ä»¥åšï¼Œä¸ºä»€ä¹ˆä¸€å®šè¦ç”¨ TiDB å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨ç‰›åˆ€æ¥æ€ä¸€åªé¸¡å‘¢ï¼Ÿæˆ‘å›ç­”ä»–ï¼šæœ‰ç§æƒ…å†µæ˜¯ä½ æ‰¾ä¸åˆ°ä¸€åªç‰›æ¥æ€ï¼Œåªèƒ½å…ˆâ€œæ€é¸¡â€æˆåŠŸäº†ï¼Œæœªæ¥æ‰æœ‰â€œæ€ç‰›â€çš„æœºä¼šï¼Œä½†æ˜¯å¤§å®¶ä¸è¦è®¤ä¸ºâ€œæ€é¸¡ç”¨ç‰›åˆ€â€æ˜¯ä¸€ä»¶å¾ˆè ¢äº‹æƒ…ï¼Œè¿™å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé‰´å®šæˆ–è€…æµ‹è¯•çš„è¿‡ç¨‹ã€‚&lt;/b&gt;&lt;/p&gt;&lt;h2&gt;&lt;b&gt;å››ã€æœªæ¥ TiDB åœ¨å°çº¢ä¹¦çš„æ¥å…¥è®¡åˆ’&lt;/b&gt;&lt;/h2&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-6f472f6a5b7fe362ef1f5bc68c5f95ba_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-6f472f6a5b7fe362ef1f5bc68c5f95ba_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-6f472f6a5b7fe362ef1f5bc68c5f95ba_b.jpg&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;525&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-6f472f6a5b7fe362ef1f5bc68c5f95ba_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-6f472f6a5b7fe362ef1f5bc68c5f95ba_b.jpg&quot;/&gt;&lt;figcaption&gt;å›¾ 11 &lt;/figcaption&gt;&lt;/figure&gt;&lt;p&gt;æœ€ååˆ†äº«ä¸€ä¸‹ TiDB æœªæ¥åœ¨å°çº¢ä¹¦çš„æ¥å…¥æ–¹å‘ã€‚&lt;/p&gt;&lt;ul&gt;&lt;li&gt;é¦–å…ˆåœ¨ ETL æ–¹é¢ï¼ŒTiDB çš„äº‹åŠ¡éš”ç¦»æ€§å¯¹æŸäº›åœºæ™¯æ¥è¯´æœ‰ç‚¹é«˜ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½è‡ªå®šä¹‰äº‹åŠ¡éš”ç¦»éœ€æ±‚ï¼Œæ¯”å¦‚ä¸¤ä¸ªäº‹åŠ¡æœ‰å†²çªï¼Œä½†æˆ‘ä»¬å®é™…çš„å†™å…¥éœ€æ±‚åªè¦æœ€ç»ˆä¸€è‡´æ€§ã€‚ä½†æ˜¯ä»ç›®å‰ TiDB çš„è®¾è®¡æ¥è¯´ï¼Œè¿™ä¸ªéœ€æ±‚å¯èƒ½æ¯”è¾ƒå›°éš¾ï¼Œä½†æ˜¯ä¹Ÿä¸æ’é™¤å°†è¿™ä¸ªäº‹æƒ… raise èµ·æ¥çš„å¯èƒ½æ€§ã€‚&lt;/li&gt;&lt;li&gt;ç¬¬äºŒä¸ªå¾ˆé‡è¦çš„äº‹æƒ…æ˜¯è·¨æ•°æ®ä¸­å¿ƒçš„éƒ¨ç½²ï¼Œè¿™æ˜¯æˆ‘ä»¬æœªæ¥ä¼šé‡ç‚¹å…³æ³¨çš„æ–¹å‘ï¼Œå¯èƒ½æœ€ç»ˆä¼šå¾—åˆ°ä¸€ä¸ªé€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œç›®å‰çš„è§„åˆ’è¿˜ä¸æ˜¯ç‰¹åˆ«æ˜æ™°ï¼Œå› ä¸ºæœªæ¥ä¸šåŠ¡å¯èƒ½åœ¨ä¸åŒçš„äº‘ä¼šæœ‰ä¸åŒçš„å½¢æ€ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½æ‰¾åˆ°æˆæœ¬ç›¸å¯¹æ›´ä½çš„è§£å†³æ–¹æ¡ˆã€‚&lt;/li&gt;&lt;li&gt;ç¬¬ä¸‰ç‚¹æ˜¯è‡ªåŠ¨åŒ–è¿ç»´ï¼Œç›®å‰æ˜¯å¾€ TiDB + K8s çš„æ–¹å‘æ¨åŠ¨ï¼Œæ›´å¥½çš„è§£å†³é›†ç¾¤éƒ¨ç½²é—®é¢˜ï¼Œå› ä¸ºåœ¨è™šæœºä¸Šéƒ¨ç½²è¿˜æ˜¯æ¯”è¾ƒç—›è‹¦çš„ã€‚&lt;/li&gt;&lt;li&gt;æœ€åï¼Œæˆ‘ä»¬å·²ç»æœ‰åŒäº‹è´Ÿè´£è°ƒç ” TiFlashã€Tidisï¼Œä½†ç›®å‰è¿˜æ²¡æœ‰çº¿ä¸Šåº”ç”¨åœ¨ä¾èµ–ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿåœ¨åš CK å’Œ TiFlash çš„å¯¹æ¯”è°ƒç ”ï¼Œç›®å‰ CK å·²ç»åœ¨çº¿ä¸Šæä¾›æœåŠ¡ï¼Œæœªæ¥å¦‚æœ TiFlash çš„è°ƒç ”ç»“è®ºæ˜¯æ¯”è¾ƒä¼˜ç§€çš„ï¼Œè‚¯å®šä¹Ÿä¼šæœ‰è®¡åˆ’æ›¿æ¢ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;æœ¬æ–‡æ ¹æ®å¼ ä¿Šéªè€å¸ˆåœ¨ TiDB TechDay 2019 ä¸Šæµ·ç«™ä¸Šçš„æ¼”è®²æ•´ç†ã€‚&lt;/p&gt;&lt;p&gt;- END - &lt;/p&gt;&lt;p&gt;&lt;b&gt;æ›´å¤šæ¡ˆä¾‹é˜…è¯»ï¼š&lt;/b&gt;&lt;/p&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/cases-cn/&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg&quot; data-image-width=&quot;1200&quot; data-image-height=&quot;1200&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;æ¡ˆä¾‹&lt;/a&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2019-07-12-73262030</guid>
<pubDate>Fri, 12 Jul 2019 00:00:00 +0800</pubDate>
</item>
<item>
<title>TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆåï¼‰Snapshot çš„å‘é€å’Œæ¥æ”¶</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-09-72880848.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/72880848&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-72226a1aa2a61516be7404c2f7b95548_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;ä½œè€…ï¼šé»„æ¢¦é¾™&lt;/p&gt;&lt;h2&gt;èƒŒæ™¯çŸ¥è¯†&lt;/h2&gt;&lt;p&gt;TiKV ä½¿ç”¨ Raft ç®—æ³•æ¥æä¾›é«˜å¯ç”¨ä¸”å…·æœ‰å¼ºä¸€è‡´æ€§çš„å­˜å‚¨æœåŠ¡ã€‚åœ¨ Raft ä¸­ï¼ŒSnapshot æŒ‡çš„æ˜¯æ•´ä¸ª State Machine æ•°æ®çš„ä¸€ä»½å¿«ç…§ï¼Œå¤§ä½“ä¸Šæœ‰ä»¥ä¸‹è¿™å‡ ç§æƒ…å†µéœ€è¦ç”¨åˆ° Snapshotï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;æ­£å¸¸æƒ…å†µä¸‹ leader ä¸ follower/learner ä¹‹é—´æ˜¯é€šè¿‡ append log çš„æ–¹å¼è¿›è¡ŒåŒæ­¥çš„ï¼Œå‡ºäºç©ºé—´å’Œæ•ˆç‡çš„è€ƒè™‘ï¼Œleader ä¼šå®šæœŸæ¸…ç†è¿‡è€çš„ logã€‚å‡å¦‚ follower/learner å‡ºç°å®•æœºæˆ–è€…ç½‘ç»œéš”ç¦»ï¼Œæ¢å¤ä»¥åå¯èƒ½æ‰€ç¼ºçš„ log å·²ç»åœ¨ leader èŠ‚ç‚¹è¢«æ¸…ç†æ‰äº†ï¼Œæ­¤æ—¶åªèƒ½é€šè¿‡ Snapshot çš„æ–¹å¼è¿›è¡ŒåŒæ­¥ã€‚&lt;/li&gt;&lt;li&gt;Raft åŠ å…¥æ–°çš„èŠ‚ç‚¹çš„ï¼Œç”±äºæ–°èŠ‚ç‚¹æ²¡åŒæ­¥è¿‡ä»»ä½•æ—¥å¿—ï¼Œåªèƒ½é€šè¿‡æ¥æ”¶ Snapshot çš„æ–¹å¼æ¥åŒæ­¥ã€‚å®é™…ä¸Šè¿™ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ 1 çš„ä¸€ç§ç‰¹æ®Šæƒ…å½¢ã€‚&lt;/li&gt;&lt;li&gt;å‡ºäºå¤‡ä»½/æ¢å¤ç­‰éœ€æ±‚ï¼Œåº”ç”¨å±‚éœ€è¦ dump ä¸€ä»½ State Machine çš„å®Œæ•´æ•°æ®ã€‚&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;TiKV æ¶‰åŠåˆ°çš„æ˜¯ 1 å’Œ 2 è¿™ä¸¤ç§æƒ…å†µã€‚åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼ŒSnapshot æ€»æ˜¯ç”± Region leader æ‰€åœ¨çš„ TiKV ç”Ÿæˆï¼Œé€šè¿‡ç½‘ç»œå‘é€ç»™ Region follower/learner æ‰€åœ¨çš„ TiKVã€‚&lt;/p&gt;&lt;p&gt;ç†è®ºä¸Šè®²ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠ Snapshot å½“ä½œæ™®é€šçš„ &lt;code&gt;RaftMessage&lt;/code&gt; æ¥å‘é€ï¼Œä½†è¿™æ ·åšå®è·µä¸Šä¼šäº§ç”Ÿä¸€äº›é—®é¢˜ï¼Œä¸»è¦æ˜¯å› ä¸º Snapshot æ¶ˆæ¯çš„å°ºå¯¸è¿œå¤§äºå…¶ä»– &lt;code&gt;RaftMessage&lt;/code&gt;ï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Snapshot æ¶ˆæ¯éœ€è¦èŠ±è´¹æ›´é•¿çš„æ—¶é—´æ¥å‘é€ï¼Œå¦‚æœå…±ç”¨ç½‘ç»œè¿æ¥å®¹æ˜“å¯¼è‡´ç½‘ç»œæ‹¥å¡ï¼Œè¿›è€Œå¼•èµ·å…¶ä»– Region å‡ºç° Raft é€‰ä¸¾è¶…æ—¶ç­‰é—®é¢˜ã€‚&lt;/li&gt;&lt;li&gt;æ„å»ºå¾…å‘é€ Snapshot æ¶ˆæ¯éœ€è¦æ¶ˆè€—æ›´å¤šçš„å†…å­˜ã€‚&lt;/li&gt;&lt;li&gt;è¿‡å¤§çš„æ¶ˆæ¯å¯èƒ½å¯¼è‡´è¶…å‡º gRPC çš„ Message Size é™åˆ¶ç­‰é—®é¢˜ã€‚&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;åŸºäºä¸Šé¢çš„åŸå› ï¼ŒTiKV å¯¹ Snapshot çš„å‘é€å’Œæ¥æ”¶è¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ï¼Œä¸ºæ¯ä¸ª Snapshot åˆ›å»ºå•ç‹¬çš„ç½‘ç»œè¿æ¥ï¼Œå¹¶å°† Snapshot æ‹†åˆ†æˆ 1M å¤§å°çš„å¤šä¸ª Chunk è¿›è¡Œä¼ è¾“ã€‚&lt;/p&gt;&lt;h2&gt;æºç è§£è¯»&lt;/h2&gt;&lt;p&gt;ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«ä» RPC åè®®ã€å‘é€ Snapshotã€æ”¶å– Snapshot ä¸‰ä¸ªæ–¹é¢æ¥è§£è¯»ç›¸å…³æºä»£ç ã€‚æœ¬æ–‡çš„æ‰€æœ‰å†…å®¹éƒ½åŸºäº v3.0.0-rc.2 ç‰ˆæœ¬ã€‚&lt;/p&gt;&lt;h3&gt;Snapshot RPC call çš„å®šä¹‰&lt;/h3&gt;&lt;p&gt;ä¸æ™®é€šçš„ raft message ç±»ä¼¼ï¼ŒSnapshot æ¶ˆæ¯ä¹Ÿæ˜¯ä½¿ç”¨ gRPC è¿œç¨‹è°ƒç”¨çš„æ–¹å¼æ¥ä¼ è¾“çš„ã€‚åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/kvproto&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;pingcap/kvproto&lt;/a&gt; é¡¹ç›®ä¸­å¯ä»¥æ‰¾åˆ°ç›¸å…³ RPC Call çš„å®šä¹‰ï¼Œå…·ä½“åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/kvproto/blob/5cb23649b361013f929e0d46a166ae24848fbcbb/proto/tikvpb.proto%23L57&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;tikvpb.proto&lt;/a&gt; å’Œ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/kvproto/blob/5cb23649b361013f929e0d46a166ae24848fbcbb/proto/raft_serverpb.proto%23L42-L47&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;raft_serverpb.proto&lt;/a&gt; æ–‡ä»¶ä¸­ã€‚&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;rpc Snapshot(stream raft_serverpb.SnapshotChunk) returns (raft_serverpb.Done) {}
...
message SnapshotChunk {
  RaftMessage message = 1;
  bytes data = 2;
}

message Done {}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯ä»¥çœ‹å‡ºï¼ŒSnapshot è¢«å®šä¹‰æˆ client streaming è°ƒç”¨ï¼Œå³å¯¹äºæ¯ä¸ª Callï¼Œå®¢æˆ·ç«¯ä¾æ¬¡å‘æœåŠ¡å™¨å‘é€å¤šä¸ªç›¸åŒç±»å‹çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥æ”¶å¹¶å¤„ç†å®Œæ‰€æœ‰è¯·æ±‚åï¼Œå‘å®¢æˆ·ç«¯è¿”å›å¤„ç†ç»“æœã€‚å…·ä½“åœ¨è¿™é‡Œï¼Œæ¯ä¸ªè¯·æ±‚çš„ç±»å‹æ˜¯ &lt;code&gt;SnapshotChunk&lt;/code&gt;ï¼Œå…¶ä¸­åŒ…å«äº† Snapshot å¯¹åº”çš„ &lt;code&gt;RaftMessage&lt;/code&gt;ï¼Œæˆ–è€…æºå¸¦ä¸€æ®µ Snapshot æ•°æ®ï¼›å›å¤æ¶ˆæ¯æ˜¯ä¸€ä¸ªç®€å•çš„ç©ºæ¶ˆæ¯ &lt;code&gt;Done&lt;/code&gt;ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨è¿™é‡Œå®é™…ä¸éœ€è¦è¿”å›ä»»ä½•ä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼Œåªéœ€è¦å…³é—­å¯¹åº”çš„ streamã€‚&lt;/p&gt;&lt;h3&gt;Snapshot çš„å‘é€æµç¨‹&lt;/h3&gt;&lt;p&gt;Snapshot çš„å‘é€è¿‡ç¨‹çš„å¤„ç†æ¯”è¾ƒç®€å•ç²—æš´ï¼Œç›´æ¥åœ¨å°†è¦å‘é€ &lt;code&gt;RaftMessage&lt;/code&gt; çš„åœ°æ–¹æˆªè· Snapshot ç±»å‹çš„æ¶ˆæ¯ï¼Œè½¬è€Œé€šè¿‡ç‰¹æ®Šçš„æ–¹å¼è¿›è¡Œå‘é€ã€‚ç›¸å…³ä»£ç å¯ä»¥åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/892c12039e0213989940d29c232bddee9cbe4686/src/server/transport.rs%23L313-L344&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;server/transport.rs&lt;/a&gt; ä¸­æ‰¾åˆ°ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;fn write_data(&amp;amp;self, store_id: u64, addr: &amp;amp;str, msg: RaftMessage) {
  if msg.get_message().has_snapshot() {
      return self.send_snapshot_sock(addr, msg);
  }
  if let Err(e) = self.raft_client.wl().send(store_id, addr, msg) {
      error!(&amp;#34;send raft msg err&amp;#34;; &amp;#34;err&amp;#34; =&amp;gt; ?e);
  }
}

fn send_snapshot_sock(&amp;amp;self, addr: &amp;amp;str, msg: RaftMessage) {
  ...
  if let Err(e) = self.snap_scheduler.schedule(SnapTask::Send {
      addr: addr.to_owned(),
      msg,
      cb,
  }) {
      ...
  }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œç®€å•åœ°æŠŠå¯¹åº”çš„ &lt;code&gt;RaftMessage&lt;/code&gt; åŒ…è£…æˆä¸€ä¸ª &lt;code&gt;SnapTask::Send&lt;/code&gt; ä»»åŠ¡ï¼Œå¹¶å°†å…¶äº¤ç»™ç‹¬ç«‹çš„ &lt;code&gt;snap-worker&lt;/code&gt; å»å¤„ç†ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ &lt;code&gt;RaftMessage&lt;/code&gt; åªåŒ…å« Snapshot çš„å…ƒä¿¡æ¯ï¼Œè€Œä¸åŒ…æ‹¬çœŸæ­£çš„å¿«ç…§æ•°æ®ã€‚TiKV ä¸­æœ‰ä¸€ä¸ªå•ç‹¬çš„æ¨¡å—å«åš &lt;code&gt;SnapManager&lt;/code&gt; ï¼Œç”¨æ¥ä¸“é—¨å¤„ç†æ•°æ®å¿«ç…§çš„ç”Ÿæˆä¸è½¬å­˜ï¼Œç¨åæˆ‘ä»¬å°†ä¼šçœ‹åˆ°ä» &lt;code&gt;SnapManager&lt;/code&gt; æ¨¡å—è¯»å– Snapshot æ•°æ®å—å¹¶è¿›è¡Œå‘é€çš„ç›¸å…³ä»£ç ã€‚&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬ä¸å¦¨é¡ºè—¤æ‘¸ç“œæ¥çœ‹çœ‹ &lt;code&gt;snap-worker&lt;/code&gt; æ˜¯å¦‚ä½•å¤„ç†è¿™ä¸ªä»»åŠ¡çš„ï¼Œç›¸å…³ä»£ç åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/892c12039e0213989940d29c232bddee9cbe4686/src/server/snap.rs%23L329-L398&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;server/snap.rs&lt;/a&gt;ï¼Œç²¾ç®€æ‰éæ ¸å¿ƒé€»è¾‘åçš„ä»£ç å¼•ç”¨å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;fn run(&amp;amp;mut self, task: Task) {
  match task {
      Task::Recv { stream, sink } =&amp;gt; {
           ...
           let f = recv_snap(stream, sink, ...).then(move |result| {
               ...
           });
           self.pool.spawn(f).forget();
      }
      Task::Send { addr, msg, cb } =&amp;gt; {
          ...
          let f = future::result(send_snap(..., &amp;amp;addr, msg))
              .flatten()
              .then(move |res| {
                  ...
              });
          self.pool.spawn(f).forget();
      }
  }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;snap-worker&lt;/code&gt; ä½¿ç”¨äº† &lt;code&gt;future&lt;/code&gt; æ¥å®Œæˆæ”¶å‘ Snapshot ä»»åŠ¡ï¼šé€šè¿‡è°ƒç”¨ &lt;code&gt;send_snap()&lt;/code&gt; æˆ– &lt;code&gt;recv_snap()&lt;/code&gt; ç”Ÿæˆä¸€ä¸ª future å¯¹è±¡ï¼Œå¹¶å°†å…¶äº¤ç»™ &lt;code&gt;FuturePool&lt;/code&gt; å¼‚æ­¥æ‰§è¡Œã€‚&lt;/p&gt;&lt;p&gt;ç°åœ¨æˆ‘ä»¬æš‚ä¸”åªå…³æ³¨ &lt;code&gt;send_snap()&lt;/code&gt; çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/892c12039e0213989940d29c232bddee9cbe4686/src/server/snap.rs%23L103-L175&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å®ç°&lt;/a&gt;ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;fn send_snap(
  ...
  addr: &amp;amp;str,
  msg: RaftMessage,
) -&amp;gt; Result&amp;lt;impl Future&amp;lt;Item = SendStat, Error = Error&amp;gt;&amp;gt; {
  ...
  let key = {
      let snap = msg.get_message().get_snapshot();
      SnapKey::from_snap(snap)?
  };
  ...
  let s = box_try!(mgr.get_snapshot_for_sending(&amp;amp;key));
  if !s.exists() {
      return Err(box_err!(&amp;#34;missing snap file: {:?}&amp;#34;, s.path()));
  }
  let total_size = s.total_size()?;
  let chunks = {
      let mut first_chunk = SnapshotChunk::new();
      first_chunk.set_message(msg);

      SnapChunk {
          first: Some(first_chunk),
          snap: s,
          remain_bytes: total_size as usize,
      }
  };

  let cb = ChannelBuilder::new(env);
  let channel = security_mgr.connect(cb, addr);
  let client = TikvClient::new(channel);
  let (sink, receiver) = client.snapshot()?;

  let send = chunks.forward(sink).map_err(Error::from);
  let send = send
      .and_then(|(s, _)| receiver.map_err(Error::from).map(|_| s))
      .then(move |result| {
          ...
      });
  Ok(send)
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™ä¸€æ®µæµç¨‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼šå…ˆæ˜¯ç”¨ Snapshot å…ƒä¿¡æ¯ä» &lt;code&gt;SnapManager&lt;/code&gt; å–åˆ°å¾…å‘é€çš„å¿«ç…§æ•°æ®ï¼Œç„¶åå°† &lt;code&gt;RaftMessage&lt;/code&gt; å’Œ &lt;code&gt;Snap&lt;/code&gt; ä¸€èµ·å°è£…è¿› &lt;code&gt;SnapChunk&lt;/code&gt; ç»“æ„ï¼Œæœ€ååˆ›å»ºå…¨æ–°çš„ gRPC è¿æ¥åŠä¸€ä¸ª Snapshot stream å¹¶å°† &lt;code&gt;SnapChunk&lt;/code&gt; å†™å…¥ã€‚è¿™é‡Œå¼•å…¥ &lt;code&gt;SnapChunk&lt;/code&gt; æ˜¯ä¸ºäº†é¿å…å°†æ•´å— Snapshot å¿«ç…§ä¸€æ¬¡æ€§åŠ è½½è¿›å†…å­˜ï¼Œå®ƒ impl äº† &lt;code&gt;futures::Stream&lt;/code&gt; è¿™ä¸ª trait æ¥è¾¾æˆæŒ‰éœ€åŠ è½½æµå¼å‘é€çš„æ•ˆæœã€‚å¦‚æœæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒå®ƒçš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/892c12039e0213989940d29c232bddee9cbe4686/src/server/snap.rs%23L55-L92&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å…·ä½“å®ç°&lt;/a&gt;ï¼Œæœ¬æ–‡å°±æš‚ä¸å±•å¼€äº†ã€‚&lt;/p&gt;&lt;h3&gt;Snapshot çš„æ”¶å–æµç¨‹&lt;/h3&gt;&lt;p&gt;æœ€åæˆ‘ä»¬æ¥ç®€å•çœ‹ä¸€ä¸‹ Snapshot çš„æ”¶å–æµç¨‹ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ gRPC Call çš„ server ç«¯å¯¹åº”çš„å¤„ç†ï¼Œæ•´ä¸ªæµç¨‹çš„å…¥å£æˆ‘ä»¬å¯ä»¥åœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/892c12039e0213989940d29c232bddee9cbe4686/src/server/service/kv.rs%23L714-L729&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;server/service/kv.rs&lt;/a&gt; ä¸­æ‰¾åˆ°ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;fn snapshot(
  &amp;amp;mut self,
  ctx: RpcContext&amp;lt;&amp;#39;_&amp;gt;,
  stream: RequestStream&amp;lt;SnapshotChunk&amp;gt;,
  sink: ClientStreamingSink&amp;lt;Done&amp;gt;,
) {
  let task = SnapTask::Recv { stream, sink };
  if let Err(e) = self.snap_scheduler.schedule(task) {
      ...
  }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸å‘é€è¿‡ç¨‹ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç›´æ¥æ„å»º &lt;code&gt;SnapTask::Recv&lt;/code&gt; ä»»åŠ¡å¹¶è½¬å‘ç»™ &lt;code&gt;snap-worker&lt;/code&gt; äº†ï¼Œè¿™é‡Œä¼šè°ƒç”¨ä¸Šé¢å‡ºç°è¿‡çš„ &lt;code&gt;recv_snap()&lt;/code&gt; å‡½æ•°ï¼Œ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/892c12039e0213989940d29c232bddee9cbe4686/src/server/snap.rs%23L237-L291&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å…·ä½“å®ç°&lt;/a&gt; å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;fn recv_snap&amp;lt;R: RaftStoreRouter + &amp;#39;static&amp;gt;(
  stream: RequestStream&amp;lt;SnapshotChunk&amp;gt;,
  sink: ClientStreamingSink&amp;lt;Done&amp;gt;,
  ...
) -&amp;gt; impl Future&amp;lt;Item = (), Error = Error&amp;gt; {
  ...
  let f = stream.into_future().map_err(|(e, _)| e).and_then(
      move |(head, chunks)| -&amp;gt; Box&amp;lt;dyn Future&amp;lt;Item = (), Error = Error&amp;gt; + Send&amp;gt; {
          let context = match RecvSnapContext::new(head, &amp;amp;snap_mgr) {
              Ok(context) =&amp;gt; context,
              Err(e) =&amp;gt; return Box::new(future::err(e)),
          };

          ...
          let recv_chunks = chunks.fold(context, |mut context, mut chunk| -&amp;gt; Result&amp;lt;_&amp;gt; {
              let data = chunk.take_data();
              ...
              if let Err(e) = context.file.as_mut().unwrap().write_all(&amp;amp;data) {
                  ...
              }
              Ok(context)
          });

          Box::new(
              recv_chunks
                  .and_then(move |context| context.finish(raft_router))
                  .then(move |r| {
                      snap_mgr.deregister(&amp;amp;context_key, &amp;amp;SnapEntry::Receiving);
                      r
                  }),
          )
      },
  );
  f.then(move |res| match res {
      ...
  })
  .map_err(Error::from)
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å€¼å¾—ç•™æ„çš„æ˜¯ stream ä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼ˆå…¶ä¸­åŒ…å«æœ‰ &lt;code&gt;RaftMessage&lt;/code&gt;ï¼‰è¢«ç”¨æ¥åˆ›å»º &lt;code&gt;RecvSnapContext&lt;/code&gt; å¯¹è±¡ï¼Œå…¶åçš„æ¯ä¸ª chunk æ”¶å–åéƒ½ä¾æ¬¡å†™å…¥æ–‡ä»¶ï¼Œæœ€åè°ƒç”¨ &lt;code&gt;context.finish()&lt;/code&gt; æŠŠä¹‹å‰ä¿å­˜çš„ &lt;code&gt;RaftMessage&lt;/code&gt; å‘é€ç»™ &lt;code&gt;raftstore&lt;/code&gt; å®Œæˆæ•´ä¸ªæ¥æ”¶è¿‡ç¨‹ã€‚&lt;/p&gt;&lt;h2&gt;æ€»ç»“&lt;/h2&gt;&lt;p&gt;ä»¥ä¸Šå°±æ˜¯ TiKV å‘é€å’Œæ¥æ”¶ Snapshot ç›¸å…³çš„ä»£ç è§£æäº†ã€‚è¿™æ˜¯ TiKV ä»£ç åº“ä¸­è¾ƒå°çš„ä¸€ä¸ªæ¨¡å—ï¼Œå®ƒå¾ˆå¥½åœ°è§£å†³äº†ç”±äº Snapshot æ¶ˆæ¯ç‰¹æ®Šæ€§æ‰€å¸¦æ¥çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œå……åˆ†åº”ç”¨äº† &lt;code&gt;grpc-rs&lt;/code&gt; ç»„ä»¶åŠ &lt;code&gt;futures&lt;/code&gt;/&lt;code&gt;FuturePool&lt;/code&gt; æ¨¡å‹ï¼Œå¤§å®¶å¯ä»¥ç»“åˆæœ¬ç³»åˆ—æ–‡ç« çš„ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tikv-source-code-reading-7/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ç¬¬ä¸ƒç¯‡&lt;/a&gt; å’Œ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tikv-source-code-reading-8/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;ç¬¬å…«ç¯‡&lt;/a&gt; è¿›ä¸€æ­¥æ‹“å±•å­¦ä¹ ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;åŸæ–‡é˜…è¯»ï¼š&lt;/b&gt;&lt;/p&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tikv-source-code-reading-10/&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg&quot; data-image-width=&quot;1200&quot; data-image-height=&quot;1200&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆåï¼‰Snapshot çš„å‘é€å’Œæ¥æ”¶&lt;/a&gt;&lt;p&gt;&lt;b&gt;æ›´å¤š TiKV æºç é˜…è¯»ï¼š&lt;/b&gt;&lt;/p&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/%23TiKV-%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg&quot; data-image-width=&quot;1200&quot; data-image-height=&quot;1200&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;åšå®¢ | PingCAP&lt;/a&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2019-07-09-72880848</guid>
<pubDate>Tue, 09 Jul 2019 00:00:00 +0800</pubDate>
</item>
<item>
<title>TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆä¹ï¼‰Service å±‚å¤„ç†æµç¨‹è§£æ</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-08-72640867.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/72640867&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-3505224dad3b818557ddf813893b94ba_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;ä½œè€…ï¼šå‘¨æŒ¯é–&lt;/p&gt;&lt;p&gt;ä¹‹å‰çš„ TiKV æºç è§£æç³»åˆ—æ–‡ç« ä»‹ç»äº† TiKV ä¾èµ–çš„å‘¨è¾¹åº“ï¼Œä»æœ¬ç¯‡æ–‡ç« å¼€å§‹ï¼Œæˆ‘ä»¬å°†å¼€å§‹ä»‹ç» TiKV è‡ªèº«çš„ä»£ç ã€‚æœ¬æ–‡é‡ç‚¹ä»‹ç» TiKV æœ€å¤–é¢çš„ä¸€å±‚â€”â€”Service å±‚ã€‚&lt;/p&gt;&lt;p&gt;TiKV çš„ Service å±‚çš„ä»£ç ä½äº &lt;code&gt;src/server&lt;/code&gt; æ–‡ä»¶å¤¹ä¸‹ï¼Œå…¶èŒè´£åŒ…æ‹¬æä¾› RPC æœåŠ¡ã€å°† store id è§£ææˆåœ°å€ã€TiKV ä¹‹é—´çš„ç›¸äº’é€šä¿¡ç­‰ã€‚è¿™ä¸€éƒ¨åˆ†çš„ä»£ç å¹¶ä¸æ˜¯ç‰¹åˆ«å¤æ‚ã€‚æœ¬ç¯‡å°†ä¼šç®€è¦åœ°ä»‹ç» Service å±‚çš„æ•´ä½“ç»“æ„å’Œç»„æˆ Service å±‚çš„å„ä¸ªç»„ä»¶ã€‚&lt;/p&gt;&lt;h2&gt;æ•´ä½“ç»“æ„&lt;/h2&gt;&lt;p&gt;ä½äº &lt;code&gt;src/server/server.rs&lt;/code&gt; æ–‡ä»¶ä¸­çš„ &lt;code&gt;Server&lt;/code&gt; æ˜¯æˆ‘ä»¬æœ¬æ¬¡ä»‹ç»çš„ Service å±‚çš„ä¸»ä½“ã€‚å®ƒå°è£…äº† TiKV åœ¨ç½‘ç»œä¸Šæä¾›æœåŠ¡å’Œ Raft group æˆå‘˜ä¹‹é—´ç›¸äº’é€šä¿¡çš„é€»è¾‘ã€‚&lt;code&gt;Server&lt;/code&gt; æœ¬èº«çš„ä»£ç æ¯”è¾ƒç®€çŸ­ï¼Œå¤§éƒ¨åˆ†ä»£ç éƒ½è¢«åˆ†ç¦»åˆ° &lt;code&gt;RaftClient&lt;/code&gt;ï¼Œ&lt;code&gt;Transport&lt;/code&gt;ï¼Œ&lt;code&gt;SnapRunner&lt;/code&gt; å’Œå‡ ä¸ª gRPC service ä¸­ã€‚ä¸Šè¿°ç»„ä»¶çš„å±‚æ¬¡å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-845da5f93f6e1ce8015f4f61dfde6101_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1288&quot; data-rawheight=&quot;618&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;1288&quot; data-original=&quot;https://pic2.zhimg.com/v2-845da5f93f6e1ce8015f4f61dfde6101_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-845da5f93f6e1ce8015f4f61dfde6101_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1288&quot; data-rawheight=&quot;618&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;1288&quot; data-original=&quot;https://pic2.zhimg.com/v2-845da5f93f6e1ce8015f4f61dfde6101_r.jpg&quot; data-actualsrc=&quot;https://pic2.zhimg.com/v2-845da5f93f6e1ce8015f4f61dfde6101_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»è¿™äº›ç»„ä»¶ã€‚&lt;/p&gt;&lt;h2&gt;Resolver&lt;/h2&gt;&lt;p&gt;åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œæ¯ä¸ª TiKV å®ä¾‹éƒ½ç”±ä¸€ä¸ªå”¯ä¸€çš„ store id è¿›è¡Œæ ‡è¯†ã€‚Resolver çš„åŠŸèƒ½æ˜¯å°† store id è§£ææˆ TiKV çš„åœ°å€å’Œç«¯å£ï¼Œç”¨äºå»ºç«‹ç½‘ç»œé€šä¿¡ã€‚&lt;/p&gt;&lt;p&gt;Resolver æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ç»„ä»¶ï¼Œå…¶æ¥å£ä»…åŒ…å«ä¸€ä¸ªå‡½æ•°ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;pub trait StoreAddrResolver: Send + Clone {
   fn resolve(&amp;amp;self, store_id: u64, cb: Callback) -&amp;gt; Result&amp;lt;()&amp;gt;;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å…¶ä¸­ &lt;code&gt;Callback&lt;/code&gt; ç”¨äºå¼‚æ­¥åœ°è¿”å›ç»“æœã€‚&lt;code&gt;PdStoreAddrResolver&lt;/code&gt; å®ç°äº†è¯¥ traitï¼Œå®ƒçš„ &lt;code&gt;resolve&lt;/code&gt; æ–¹æ³•çš„å®ç°åˆ™æ˜¯ç®€å•åœ°å°†æŸ¥è¯¢ä»»åŠ¡é€šè¿‡å…¶ &lt;code&gt;sched&lt;/code&gt; æˆå‘˜å‘é€ç»™ &lt;code&gt;Runner&lt;/code&gt;ã€‚è€Œ &lt;code&gt;Runner&lt;/code&gt; åˆ™å®ç°äº† &lt;code&gt;Runnable&amp;lt;Task&amp;gt;&lt;/code&gt;ï¼Œå…¶æ„ä¹‰æ˜¯ &lt;code&gt;Runner&lt;/code&gt; å¯ä»¥åœ¨è‡ªå·±çš„ä¸€ä¸ªçº¿ç¨‹é‡Œè¿è¡Œï¼Œå¤–ç•Œå°†ä¼šå‘ &lt;code&gt;Runner&lt;/code&gt; å‘é€ &lt;code&gt;Task&lt;/code&gt; ç±»å‹çš„æ¶ˆæ¯ï¼Œ&lt;code&gt;Runner&lt;/code&gt; å°†å¯¹æ”¶åˆ°çš„ &lt;code&gt;Task&lt;/code&gt; è¿›è¡Œå¤„ç†ã€‚ è¿™é‡Œä½¿ç”¨äº†ç”± TiKV çš„ util æä¾›çš„ä¸€ä¸ªå•çº¿ç¨‹ worker æ¡†æ¶ï¼Œåœ¨ TiKV çš„å¾ˆå¤šå¤„ä»£ç ä¸­éƒ½æœ‰åº”ç”¨ã€‚&lt;code&gt;Runner&lt;/code&gt; çš„ &lt;code&gt;store_addrs&lt;/code&gt; å­—æ®µæ˜¯ä¸ª cacheï¼Œå®ƒåœ¨æ‰§è¡Œä»»åŠ¡æ—¶é¦–å…ˆå°è¯•åœ¨è¿™ä¸ª cache ä¸­æ‰¾ï¼Œæ‰¾ä¸åˆ°åˆ™å‘ PD å‘é€ RPC è¯·æ±‚æ¥è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœæ·»åŠ è¿› cache é‡Œã€‚&lt;/p&gt;&lt;h2&gt;RaftClient&lt;/h2&gt;&lt;p&gt;TiKV æ˜¯ä¸€ä¸ª Multi Raft çš„ç»“æ„ï¼ŒRegion çš„å‰¯æœ¬ä¹‹é—´ï¼Œå³ Raft group çš„æˆå‘˜ä¹‹é—´éœ€è¦ç›¸äº’é€šä¿¡ï¼Œ&lt;code&gt;RaftClient&lt;/code&gt; çš„ä½œç”¨ä¾¿æ˜¯ç®¡ç† TiKV ä¹‹é—´çš„è¿æ¥ï¼Œå¹¶ç”¨äºå‘å…¶å®ƒ TiKV èŠ‚ç‚¹å‘é€ Raft æ¶ˆæ¯ã€‚&lt;code&gt;RaftClient&lt;/code&gt; å¯ä»¥å’Œå¦ä¸€ä¸ªèŠ‚ç‚¹å»ºç«‹å¤šä¸ªè¿æ¥ï¼Œå¹¶æŠŠä¸åŒ Region çš„è¯·æ±‚å‡æ‘Šåˆ°è¿™äº›è¿æ¥ä¸Šã€‚è¿™éƒ¨åˆ†ä»£ç çš„ä¸»è¦çš„å¤æ‚æ€§å°±åœ¨äºè¿æ¥çš„å»ºç«‹ï¼Œä¹Ÿå°±æ˜¯ &lt;code&gt;Conn::new&lt;/code&gt; è¿™ä¸ªå‡½æ•°ã€‚å»ºç«‹è¿æ¥çš„ä»£ç çš„å…³é”®éƒ¨åˆ†å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;let client1 = TikvClient::new(channel);

let (tx, rx) = batch::unbounded::&amp;lt;RaftMessage&amp;gt;(RAFT_MSG_NOTIFY_SIZE);
let rx = batch::BatchReceiver::new(rx, RAFT_MSG_MAX_BATCH_SIZE, Vec::new, |v, e| v.push(e));
let rx1 = Arc::new(Mutex::new(rx));

let (batch_sink, batch_receiver) = client1.batch_raft().unwrap();
let batch_send_or_fallback = batch_sink
   .send_all(Reusable(rx1).map(move |v| {
       let mut batch_msgs = BatchRaftMessage::new();
       batch_msgs.set_msgs(RepeatedField::from(v));
       (batch_msgs, WriteFlags::default().buffer_hint(false))
   })).then(/*...*/);

client1.spawn(batch_send_or_fallback.map_err(/*...*/));&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¸Šè¿°ä»£ç å‘æŒ‡å®šåœ°å€è°ƒç”¨äº† &lt;code&gt;batch_raft&lt;/code&gt; è¿™ä¸ª gRPC æ¥å£ã€‚&lt;code&gt;batch_raft&lt;/code&gt; å’Œ &lt;code&gt;raft&lt;/code&gt; éƒ½æ˜¯ stream æ¥å£ã€‚å¯¹ &lt;code&gt;RaftClient&lt;/code&gt; è°ƒç”¨ &lt;code&gt;send&lt;/code&gt; æ–¹æ³•ä¼šå°†æ¶ˆæ¯å‘é€åˆ°å¯¹åº”çš„ &lt;code&gt;Conn&lt;/code&gt; çš„ &lt;code&gt;stream&lt;/code&gt; æˆå‘˜ï¼Œå³ä¸Šè¿°ä»£ç çš„ &lt;code&gt;tx&lt;/code&gt; ä¸­ï¼Œè€Œåœ¨ gRPC çš„çº¿ç¨‹ä¸­åˆ™ä¼šä» &lt;code&gt;rx&lt;/code&gt; ä¸­å–å‡ºè¿™äº›æ¶ˆæ¯ï¼ˆè¿™äº›æ¶ˆæ¯è¢« &lt;code&gt;BatchReceiver&lt;/code&gt; è¿™ä¸€å±‚ batch èµ·æ¥ä»¥æå‡æ€§èƒ½ï¼‰ï¼Œå¹¶é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ã€‚&lt;/p&gt;&lt;p&gt;å¦‚æœå¯¹æ–¹ä¸æ”¯æŒ batchï¼Œåˆ™ä¼š fallback åˆ° &lt;code&gt;raft&lt;/code&gt; æ¥å£ã€‚è¿™ç§æƒ…å†µé€šå¸¸ä»…åœ¨ä»æ—§ç‰ˆæœ¬å‡çº§çš„è¿‡ç¨‹ä¸­å‘ç”Ÿã€‚&lt;/p&gt;&lt;h2&gt;RaftStoreRouter ä¸ Transport&lt;/h2&gt;&lt;p&gt;&lt;code&gt;RaftStoreRouter&lt;/code&gt; è´Ÿè´£å°†æ”¶åˆ°çš„ Raft æ¶ˆæ¯è½¬å‘ç»™ raftstore ä¸­å¯¹åº”çš„ Regionï¼Œè€Œ &lt;code&gt;Transport&lt;/code&gt; è´Ÿè´£å°† Raft æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šçš„ storeã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;ServerRaftStoreRouter&lt;/code&gt; æ˜¯åœ¨ TiKV å®é™…è¿è¡Œæ—¶å°†ä¼šä½¿ç”¨çš„ &lt;code&gt;RaftStoreRouter&lt;/code&gt; çš„å®ç°ï¼Œå®ƒåŒ…å«ä¸€ä¸ªå†…å±‚çš„ã€ç”± raftstore æä¾›çš„ &lt;code&gt;RaftRouter&lt;/code&gt; å¯¹è±¡å’Œä¸€ä¸ª &lt;code&gt;LocalReader&lt;/code&gt; å¯¹è±¡ã€‚æ”¶åˆ°çš„è¯·æ±‚å¦‚æœæ˜¯ä¸€ä¸ªåªè¯»çš„è¯·æ±‚ï¼Œåˆ™ä¼šç”± &lt;code&gt;LocalReader&lt;/code&gt; å¤„ç†ï¼›å…¶å®ƒæƒ…å†µåˆ™æ˜¯äº¤ç»™å†…å±‚çš„ router æ¥å¤„ç†ã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;ServerTransport&lt;/code&gt; åˆ™æ˜¯ TiKV å®é™…è¿è¡Œæ—¶ä½¿ç”¨çš„ &lt;code&gt;Transport&lt;/code&gt; çš„å®ç°ï¼ˆ&lt;code&gt;Transport&lt;/code&gt; trait çš„å®šä¹‰åœ¨ raftstore ä¸­ï¼‰ï¼Œå…¶å†…éƒ¨åŒ…å«ä¸€ä¸ª &lt;code&gt;RaftClient&lt;/code&gt; ç”¨äºè¿›è¡Œ RPC é€šä¿¡ã€‚å‘é€æ¶ˆæ¯æ—¶ï¼Œ&lt;code&gt;ServerTransport&lt;/code&gt; é€šè¿‡ä¸Šé¢è¯´åˆ°çš„ Resolver å°†æ¶ˆæ¯ä¸­çš„ store id è§£æä¸ºåœ°å€ï¼Œå¹¶å°†è§£æçš„ç»“æœå­˜å…¥ &lt;code&gt;raft_client.addrs&lt;/code&gt; ä¸­ï¼›ä¸‹æ¬¡å‘åŒä¸€ä¸ª store å‘é€æ¶ˆæ¯æ—¶ä¾¿ä¸å†éœ€è¦å†æ¬¡è§£æã€‚æ¥ä¸‹æ¥ï¼Œå†é€šè¿‡ &lt;code&gt;RaftClient&lt;/code&gt; è¿›è¡Œ RPC è¯·æ±‚ï¼Œå°†æ¶ˆæ¯å‘é€å‡ºå»ã€‚&lt;/p&gt;&lt;h2&gt;Node&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Node&lt;/code&gt; å¯ä»¥è®¤ä¸ºæ˜¯å°† raftstore çš„å¤æ‚çš„åˆ›å»ºã€å¯åŠ¨å’Œåœæ­¢é€»è¾‘è¿›è¡Œå°è£…çš„ä¸€å±‚ï¼Œå…¶å†…éƒ¨çš„ &lt;code&gt;RaftBatchSystem&lt;/code&gt; ä¾¿æ˜¯ raftstore çš„æ ¸å¿ƒã€‚åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼ˆå³ &lt;code&gt;Node&lt;/code&gt; çš„ &lt;code&gt;start&lt;/code&gt; å‡½æ•°ä¸­ï¼‰ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹æ˜¯ä¸€ä¸ªæ–°å»ºçš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼šè¿›è¡Œ bootstrap çš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬åˆ†é… store idã€åˆ†é…ç¬¬ä¸€ä¸ª Region ç­‰æ“ä½œã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;Node&lt;/code&gt; å¹¶æ²¡æœ‰ç›´æ¥åŒ…å«åœ¨ &lt;code&gt;Server&lt;/code&gt; ä¹‹å†…ï¼Œä½†æ˜¯ raftstore çš„è¿è¡Œéœ€è¦æœ‰ç”¨äºå‘å…¶å®ƒ TiKV å‘é€æ¶ˆæ¯çš„ &lt;code&gt;Transport&lt;/code&gt;ï¼Œè€Œ &lt;code&gt;Transport&lt;/code&gt; ä½œä¸ºæä¾›ç½‘ç»œé€šä¿¡åŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™æ˜¯åŒ…å«åœ¨ &lt;code&gt;Server&lt;/code&gt; å†…ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ &lt;code&gt;src/binutil/server.rs&lt;/code&gt;æ–‡ä»¶çš„ &lt;code&gt;run_raft_server&lt;/code&gt; ä¸­ï¼ˆè¢« tikv-server çš„ &lt;code&gt;main&lt;/code&gt; å‡½æ•°è°ƒç”¨ï¼‰ï¼Œå¯åŠ¨è¿‡ç¨‹ä¸­éœ€è¦å…ˆåˆ›å»º &lt;code&gt;Server&lt;/code&gt;ï¼Œç„¶ååˆ›å»ºå¹¶å¯åŠ¨ &lt;code&gt;Node&lt;/code&gt; å¹¶æŠŠ &lt;code&gt;Server&lt;/code&gt; æ‰€åˆ›å»ºçš„ &lt;code&gt;Transport&lt;/code&gt; ä¼ ç»™ &lt;code&gt;Node&lt;/code&gt;ï¼Œæœ€åå†å¯åŠ¨ &lt;code&gt;Node&lt;/code&gt;ã€‚&lt;/p&gt;&lt;h2&gt;Service&lt;/h2&gt;&lt;p&gt;TiKV åŒ…å«å¤šä¸ª gRPC serviceã€‚å…¶ä¸­ï¼Œæœ€é‡è¦çš„ä¸€ä¸ªæ˜¯ &lt;code&gt;KvService&lt;/code&gt;ï¼Œä½äº &lt;code&gt;src/server/service/kv.rs&lt;/code&gt; æ–‡ä»¶ä¸­ã€‚&lt;/p&gt;&lt;p&gt;&lt;code&gt;KvService&lt;/code&gt; å®šä¹‰äº† TiKV çš„ &lt;code&gt;kv_get&lt;/code&gt;ï¼Œ&lt;code&gt;kv_scan&lt;/code&gt;ï¼Œ&lt;code&gt;kv_prewrite&lt;/code&gt;ï¼Œ&lt;code&gt;kv_commit&lt;/code&gt; ç­‰äº‹åŠ¡æ“ä½œçš„ APIï¼Œç”¨äºæ‰§è¡Œ TiDB ä¸‹æ¨ä¸‹æ¥çš„å¤æ‚æŸ¥è¯¢å’Œè®¡ç®—çš„ &lt;code&gt;coprocessor&lt;/code&gt; APIï¼Œä»¥åŠ &lt;code&gt;raw_get&lt;/code&gt;ï¼Œ&lt;code&gt;raw_put&lt;/code&gt; ç­‰ Raw KV APIã€‚&lt;code&gt;batch_commands&lt;/code&gt; æ¥å£åˆ™æ˜¯ç”¨äºå°†ä¸Šè¿°çš„æ¥å£ batch èµ·æ¥ï¼Œä»¥ä¼˜åŒ–é«˜ååé‡çš„åœºæ™¯ã€‚å½“æˆ‘ä»¬è¦ä¸º TiKV æ·»åŠ ä¸€ä¸ªæ–°çš„ API æ—¶ï¼Œé¦–å…ˆå°±è¦åœ¨ kvproto é¡¹ç›®ä¸­æ·»åŠ ç›¸å…³æ¶ˆæ¯ä½“çš„å®šä¹‰ï¼Œå¹¶åœ¨è¿™é‡Œæ·»åŠ ç›¸å…³ä»£ç ã€‚å¦å¤–ï¼ŒTiKV çš„ Raft group å„æˆå‘˜ä¹‹é—´é€šä¿¡ç”¨åˆ°çš„ &lt;code&gt;raft&lt;/code&gt; å’Œ &lt;code&gt;batch_raft&lt;/code&gt; æ¥å£ä¹Ÿæ˜¯åœ¨è¿™é‡Œæä¾›çš„ã€‚&lt;/p&gt;&lt;p&gt;ä¸‹é¢ä»¥ &lt;code&gt;kv_prewrite&lt;/code&gt; ä¸ºä¾‹ï¼Œä»‹ç» TiKV å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„æµç¨‹ã€‚é¦–å…ˆï¼Œæ— è®ºæ˜¯ç›´æ¥è°ƒç”¨è¿˜æ˜¯é€šè¿‡ &lt;code&gt;batch_commands&lt;/code&gt; æ¥å£è°ƒç”¨ï¼Œéƒ½ä¼šè°ƒç”¨ &lt;code&gt;future_prewrite&lt;/code&gt; å‡½æ•°ï¼Œå¹¶åœ¨è¯¥å‡½æ•°è¿”å›çš„ future é™„åŠ ä¸Šæ ¹æ®ç»“æœå‘é€å“åº”çš„æ“ä½œï¼Œå†å°†å¾—åˆ°çš„ future spawn åˆ° &lt;code&gt;RpcContext&lt;/code&gt;ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± é‡Œã€‚&lt;code&gt;future_prewrite&lt;/code&gt; çš„é€»è¾‘å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;// ä»è¯·æ±‚ä½“ä¸­å–å‡ºè°ƒç”¨ prewrite æ‰€éœ€çš„å‚æ•°

let (cb, f) = paired_future_callback();
let res = storage.async_prewrite(/*å…¶å®ƒå‚æ•°*/, cb);

AndThenWith::new(res, f.map_err(Error::from)).map(|v| {
   let mut resp = PrewriteResponse::new();
   if let Some(err) = extract_region_error(&amp;amp;v) {
       resp.set_region_error(err);
   } else {
       resp.set_errors(RepeatedField::from_vec(extract_key_errors(v)));
   }
   resp
})&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¿™é‡Œçš„ &lt;code&gt;paired_future_callback&lt;/code&gt; æ˜¯ä¸€ä¸ª util å‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ªé—­åŒ… &lt;code&gt;cb&lt;/code&gt; å’Œä¸€ä¸ª future &lt;code&gt;f&lt;/code&gt;ï¼Œå½“ &lt;code&gt;cb&lt;/code&gt; è¢«è°ƒç”¨æ—¶ &lt;code&gt;f&lt;/code&gt; å°±ä¼šè¿”å›è¢«ä¼ å…¥ &lt;code&gt;cb&lt;/code&gt; çš„å€¼ã€‚ä¸Šè¿°ä»£ç ä¼šç«‹åˆ»è¿”å›ï¼Œä½† future ä¸­çš„é€»è¾‘åœ¨ &lt;code&gt;async_prewrite&lt;/code&gt; ä¸­çš„å¼‚æ­¥æ“ä½œå®Œæˆä¹‹åæ‰ä¼šæ‰§è¡Œã€‚ä¸€æ—¦ prewrite æ“ä½œå®Œæˆï¼Œ&lt;code&gt;cb&lt;/code&gt; ä¾¿ä¼šè¢«è°ƒç”¨ï¼Œå°†ç»“æœä¼ ç»™ &lt;code&gt;f&lt;/code&gt;ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†™åœ¨ &lt;code&gt;future&lt;/code&gt; ä¸­çš„åˆ›å»ºå’Œå‘é€ Response çš„é€»è¾‘ä¾¿ä¼šç»§ç»­æ‰§è¡Œã€‚&lt;/p&gt;&lt;h2&gt;æ€»ç»“&lt;/h2&gt;&lt;p&gt;ä»¥ä¸Šå°±æ˜¯ TiKV çš„ Service å±‚çš„ä»£ç è§£æã€‚å¤§å®¶å¯ä»¥çœ‹åˆ°è¿™äº›ä»£ç å¤§é‡ä½¿ç”¨ trait å’Œæ³›å‹ï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿å°†å…¶ä¸­ä¸€äº›ç»„ä»¶æ›¿æ¢æˆå¦å¤–ä¸€äº›å®ç°ï¼Œæ–¹ä¾¿ç¼–å†™æµ‹è¯•ä»£ç ã€‚å¦å¤–ï¼Œåœ¨ &lt;code&gt;src/server/snap.rs&lt;/code&gt; ä¸­ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªä¸“é—¨ç”¨äºå¤„ç† Snapshot çš„æ¨¡å—ï¼Œç”±äº Snapshot æ¶ˆæ¯çš„ç‰¹æ®Šæ€§ï¼Œåœ¨å…¶å®ƒæ¨¡å—ä¸­ä¹Ÿæœ‰ä¸€äº›é’ˆå¯¹ snapshot çš„ä»£ç ã€‚å…³äº Snapshotï¼Œæˆ‘ä»¬å°†åœ¨å¦ä¸€ç¯‡æ–‡ç« é‡Œè¿›è¡Œè¯¦ç»†è®²è§£ï¼Œæ•¬è¯·æœŸå¾…ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;åŸæ–‡é˜…è¯»ï¼š&lt;/b&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/tikv-source-code-reading-9/&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://www.&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;pingcap.com/blog-cn/tik&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;v-source-code-reading-9/&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;æ›´å¤š TiKV æºç é˜…è¯»ï¼š&lt;/b&gt;&lt;/p&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/%23TiKV-%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg&quot; data-image-width=&quot;1200&quot; data-image-height=&quot;1200&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;åšå®¢ | PingCAP&lt;/a&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2019-07-08-72640867</guid>
<pubDate>Mon, 08 Jul 2019 00:00:00 +0800</pubDate>
</item>
<item>
<title>TiDB Binlog æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆäºŒï¼‰åˆè¯† TiDB Binlog æºç </title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2019-07-05-72306986.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/72306986&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-7e9b57ad1e4c1ebaae5bfabfa6d28ffb_b.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;ä½œè€…ï¼šsatoru&lt;/p&gt;&lt;h2&gt;TiDB Binlog æ¶æ„ç®€ä»‹&lt;/h2&gt;&lt;p&gt;TiDB Binlog ä¸»è¦ç”± Pump å’Œ Drainer ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ Pump è´Ÿè´£å­˜å‚¨ TiDB äº§ç”Ÿçš„ binlog å¹¶å‘ Drainer æä¾›æŒ‰æ—¶é—´æˆ³æŸ¥è¯¢å’Œè¯»å– binlog çš„æœåŠ¡ï¼ŒDrainer è´Ÿè´£å°†è·å–åçš„ binlog åˆå¹¶æ’åºå†ä»¥åˆé€‚çš„æ ¼å¼ä¿å­˜åˆ°å¯¹æ¥çš„ä¸‹æ¸¸ç»„ä»¶ã€‚&lt;br/&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;402&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;402&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_r.jpg&quot; data-actualsrc=&quot;https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;&lt;br/&gt;&lt;b&gt;åœ¨ã€Š&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-ecosystem-tools-1/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;TiDB Binlog æ¶æ„æ¼”è¿›ä¸å®ç°åŸç†&lt;/a&gt;ã€‹ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯¹ TiDB Binlog æ•´ä½“æ¶æ„æœ‰æ›´è¯¦ç»†çš„è¯´æ˜ï¼Œå»ºè®®å…ˆè¡Œé˜…è¯»è¯¥æ–‡ã€‚&lt;/b&gt;&lt;/p&gt;&lt;h2&gt;ç›¸å…³æºç ä»“åº“&lt;/h2&gt;&lt;p&gt;TiDB Binlog çš„å®ç°ä¸»è¦åˆ†å¸ƒåœ¨ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-tools/&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;tidb-tools&lt;/a&gt; å’Œ &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;tidb-binlog&lt;/a&gt; ä¸¤ä¸ªæºç ä»“åº“ä¸­ï¼Œæˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹è¿™ä¸¤ä¸ªæºç ä»“åº“ä¸­çš„å…³é”®ç›®å½•ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;1. tidb-tools&lt;/b&gt;&lt;/p&gt;&lt;p&gt;Repo: &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-tools/&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/tidb&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;-tools/&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;è¿™ä¸ªä»“åº“é™¤äº† TiDB Binlog è¿˜æœ‰å…¶ä»–å·¥å…·çš„ç»„ä»¶ï¼Œåœ¨è¿™é‡Œä¸ TiDB Binlog å…³ç³»æœ€å¯†åˆ‡çš„æ˜¯ &lt;code&gt;tidb-binlog/pump_client&lt;/code&gt; è¿™ä¸ª packageã€‚&lt;code&gt;pump_client&lt;/code&gt; å®ç°äº† Pump çš„å®¢æˆ·ç«¯æ¥å£ï¼Œå½“ binlog åŠŸèƒ½å¼€å¯æ—¶ï¼ŒTiDB ä½¿ç”¨å®ƒæ¥ç»™ pump &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-tools/blob/v3.0.0-rc.3/tidb-binlog/pump_client/client.go%23L242&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;å‘é€ binlog&lt;/a&gt; ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;2. tidb-binlog&lt;/b&gt;&lt;/p&gt;&lt;p&gt;Repo: &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;github.com/pingcap/tidb&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;-binlog&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;TiDB-Binlog çš„æ ¸å¿ƒç»„ä»¶éƒ½åœ¨è¿™ä¸ªä»“åº“ï¼Œä¸‹é¢æ˜¯å„ä¸ªå…³é”®ç›®å½•ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;code&gt;cmd&lt;/code&gt;ï¼šåŒ…å« &lt;code&gt;pump&lt;/code&gt;ï¼Œ&lt;code&gt;drainer&lt;/code&gt;ï¼Œ&lt;code&gt;binlogctl&lt;/code&gt;ï¼Œ&lt;code&gt;reparo&lt;/code&gt;ï¼Œ&lt;code&gt;arbiter&lt;/code&gt; ç­‰ 5 ä¸ªå­ç›®å½•ï¼Œåˆ†åˆ«å¯¹åº” 5 ä¸ªåŒåå‘½ä»¤è¡Œå·¥å…·ã€‚è¿™äº›å­ç›®å½•ä¸‹é¢çš„ &lt;code&gt;main.go&lt;/code&gt; æ˜¯å¯¹åº”å‘½ä»¤è¡Œå·¥å…·çš„å…¥å£ï¼Œè€Œä¸»è¦åŠŸèƒ½çš„å®ç°åˆ™ä¾èµ–ä¸‹é¢å°†ä»‹ç»åˆ°çš„å„ä¸ªåŒå packagesã€‚&lt;/li&gt;&lt;li&gt;&lt;code&gt;pump&lt;/code&gt;ï¼šPump æºç ï¼Œä¸»è¦å…¥å£æ˜¯ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/pump/server.go%23L103&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;pump.NewServer&lt;/a&gt;&lt;/code&gt; å’Œ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/pump/server.go%23L313&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Server.Start&lt;/a&gt;&lt;/code&gt;ï¼›æœåŠ¡å¯åŠ¨åï¼Œä¸»è¦çš„åŠŸèƒ½æ˜¯ &lt;code&gt;WriteBinlog&lt;/code&gt;ï¼ˆé¢å‘ &lt;code&gt;TiDB/pump_client&lt;/code&gt;ï¼‰ å’Œ &lt;code&gt;PullBinlogs&lt;/code&gt;ï¼ˆé¢å‘ &lt;code&gt;Drainer&lt;/code&gt;ï¼‰ã€‚&lt;/li&gt;&lt;li&gt;&lt;code&gt;drainer&lt;/code&gt;ï¼šDrainer æºç ï¼Œä¸»è¦å…¥å£æ˜¯ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/drainer/server.go%23L88&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;drainer.NewServer&lt;/a&gt;&lt;/code&gt; å’Œ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/drainer/server.go%23L238&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Server.Start&lt;/a&gt;&lt;/code&gt;ï¼›æœåŠ¡å¯åŠ¨åï¼ŒDrainer ä¼šå…ˆæ‰¾åˆ°æ‰€æœ‰ Pump èŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨ Pump èŠ‚ç‚¹çš„ &lt;code&gt;PullBinlogs&lt;/code&gt; æ¥å£åŒæ­¥ binlog åˆ°ä¸‹æ¸¸ã€‚ç›®å‰æ”¯æŒçš„ä¸‹æ¸¸æœ‰ï¼šmysql/tidbï¼Œfileï¼ˆæ–‡ä»¶å¢é‡å¤‡ä»½ï¼‰ï¼Œkafka ã€‚&lt;/li&gt;&lt;li&gt;&lt;code&gt;binlogctl&lt;/code&gt;ï¼šBinlogctl æºç ï¼Œå®ç°ä¸€äº›å¸¸ç”¨çš„ Binlog è¿ç»´æ“ä½œï¼Œä¾‹å¦‚ç”¨ &lt;code&gt;-cmd pumps&lt;/code&gt; å‚æ•°å¯ä»¥æŸ¥çœ‹å½“å‰æ³¨å†Œçš„å„ä¸ª Pump èŠ‚ç‚¹ä¿¡æ¯ï¼Œç›¸åº”çš„å®ç°å°±æ˜¯ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/binlogctl/nodes.go%23L37&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;QueryNodesByKind&lt;/a&gt;&lt;/code&gt;ã€‚&lt;/li&gt;&lt;li&gt;&lt;code&gt;reparo&lt;/code&gt;ï¼šReparo æºç ï¼Œå®ç°ä»å¤‡ä»½æ–‡ä»¶ï¼ˆDrainer é€‰æ‹© file ä¸‹æ¸¸æ—¶ä¿å­˜çš„æ–‡ä»¶ï¼‰æ¢å¤æ•°æ®åˆ°æŒ‡å®šæ•°æ®åº“çš„åŠŸèƒ½ã€‚&lt;/li&gt;&lt;li&gt;&lt;code&gt;arbiter&lt;/code&gt;ï¼šArbiter æºç ï¼Œå®ç°ä» Kafka æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å– binlog åŒæ­¥åˆ°æŒ‡å®šæ•°æ®åº“çš„åŠŸèƒ½ï¼Œbinlog åœ¨æ¶ˆæ¯ä¸­ä»¥ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-tools/blob/v3.0.0-rc.3/tidb-binlog/slave_binlog_proto/proto/binlog.proto%23L85&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Protobuf&lt;/a&gt;&lt;/code&gt; æ ¼å¼ç¼–ç ã€‚&lt;/li&gt;&lt;li&gt;&lt;code&gt;pkg&lt;/code&gt;ï¼šå„ä¸ªå·¥å…·å…¬ç”¨çš„ä¸€äº›è¾…åŠ©ç±»çš„ packagesï¼Œä¾‹å¦‚ &lt;code&gt;pkg/util&lt;/code&gt; ä¸‹é¢æœ‰ç”¨äºé‡è¯•å‡½æ•°æ‰§è¡Œçš„ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/pkg/util/util.go%23L145&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;RetryOnError&lt;/a&gt;&lt;/code&gt;ï¼Œpkg/version ä¸‹é¢æœ‰ç”¨äºæ‰“å°ç‰ˆæœ¬ä¿¡æ¯çš„ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/pkg/version/version.go%23L45&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;PrintVersionInfo&lt;/a&gt;&lt;/code&gt;ã€‚&lt;/li&gt;&lt;li&gt;&lt;code&gt;tests&lt;/code&gt;ï¼šé›†æˆæµ‹è¯•ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;å¯åŠ¨æµ‹è¯•é›†ç¾¤&lt;/h2&gt;&lt;p&gt;ä¸Šä¸ªå°èŠ‚æåˆ°çš„ &lt;code&gt;tests&lt;/code&gt; ç›®å½•é‡Œæœ‰ä¸€ä¸ªåä¸º &lt;code&gt;run.sh&lt;/code&gt; è„šæœ¬ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨ &lt;code&gt;&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/Makefile%23L68&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;make integration_test&lt;/a&gt;&lt;/code&gt; å‘½ä»¤ï¼Œé€šè¿‡è¯¥è„šæœ¬æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„é›†æˆæµ‹è¯•ï¼Œä¸è¿‡ç°åœ¨æˆ‘ä»¬å…ˆä»‹ç»å¦‚ä½•ç”¨å®ƒæ¥å¯åŠ¨ä¸€ä¸ªæµ‹è¯•é›†ç¾¤ã€‚&lt;br/&gt;å¯åŠ¨æµ‹è¯•é›†ç¾¤å‰ï¼Œéœ€è¦åœ¨ &lt;code&gt;bin&lt;/code&gt; ç›®å½•ä¸‹å‡†å¤‡å¥½ç›¸å…³ç»„ä»¶çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;pd-serverï¼šä¸‹è½½é“¾æ¥ï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//download.pingcap.org/pd-master-linux-amd64.tar.gz&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Linux&lt;/a&gt; / &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//download.pingcap.org/pd-master-darwin-amd64.tar.gz&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;macOS&lt;/a&gt;ï¼‰&lt;/li&gt;&lt;li&gt;tikv-serverï¼šä¸‹è½½é“¾æ¥ï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//download.pingcap.org/tikv-master-linux-amd64.tar.gz&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Linux&lt;/a&gt; / &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//download.pingcap.org/tikv-master-darwin-amd64.tar.gz&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;macOS&lt;/a&gt;ï¼‰&lt;/li&gt;&lt;li&gt;tidb-serverï¼šä¸‹è½½é“¾æ¥ï¼ˆ&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//download.pingcap.org/tidb-master-linux-amd64.tar.g&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;Linux&lt;/a&gt; / &lt;a href=&quot;https://link.zhihu.com/?target=https%3A//download.pingcap.org/tidb-master-darwin-amd64.tar.gz&quot; class=&quot; wrap external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;macOS&lt;/a&gt;ï¼‰&lt;/li&gt;&lt;li&gt;&lt;code&gt;pump&lt;/code&gt;, &lt;code&gt;drainer&lt;/code&gt;, &lt;code&gt;binlogctl&lt;/code&gt;ï¼šåœ¨ tidb-binlog ç›®å½•æ‰§è¡Œ &lt;code&gt;make build&lt;/code&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;è„šæœ¬ä¾èµ– MySQL å‘½ä»¤è¡Œå®¢æˆ·ç«¯æ¥ç¡®å®š TiDB å·²ç»æˆåŠŸå¯åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å®‰è£…ä¸€ä¸ª MySQL å®¢æˆ·ç«¯ã€‚&lt;/p&gt;&lt;p&gt;å‡†å¤‡å¥½ä»¥ä¸Šä¾èµ–ï¼Œè¿è¡Œ &lt;code&gt;tests/run.sh --debug&lt;/code&gt;ï¼Œå°±å¯ä»¥å¯åŠ¨ä¸€ä¸ªæµ‹è¯•é›†ç¾¤ã€‚å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè¾“å‡ºä¸€äº›è¿›åº¦ä¿¡æ¯ï¼Œçœ‹åˆ°ä»¥ä¸‹æç¤ºå°±è¯´æ˜å·²æˆåŠŸå¯åŠ¨ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;Starting Drainer... 
You may now debug from another terminal. Press [ENTER] to continue.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æµ‹è¯•é›†ç¾¤åŒ…å«ä»¥ä¸‹æœåŠ¡ï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;2 ä¸ªä½œä¸ºä¸Šæ¸¸çš„ TiDB å®ä¾‹ï¼Œåˆ†åˆ«ä½¿ç”¨ç«¯å£ 4000 å’Œ 4001&lt;/li&gt;&lt;li&gt;1 ä¸ªä½œä¸ºä¸‹æ¸¸çš„ TiDB å®ä¾‹ï¼Œ ä½¿ç”¨ç«¯å£ 3306&lt;/li&gt;&lt;li&gt;PD å®ä¾‹ï¼Œä½¿ç”¨ç«¯å£ 2379&lt;/li&gt;&lt;li&gt;TiKVï¼Œä½¿ç”¨ç«¯å£ 20160&lt;/li&gt;&lt;li&gt;Pump ï¼Œä½¿ç”¨ç«¯å£ 8250&lt;/li&gt;&lt;li&gt;Drainerï¼Œä½¿ç”¨ç«¯å£ 8249&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;ä½¿ç”¨ MySQL å®¢æˆ·ç«¯è¿æ¥ä»»æ„ä¸€ä¸ªä¸Šæ¸¸ TiDBï¼Œå¯ä»¥ç”¨ &lt;code&gt;SHOW PUMP STATUS&lt;/code&gt; å’Œ &lt;code&gt;SHOW DRAINER STATUS&lt;/code&gt; æŸ¥è¯¢å¯¹åº”å·¥å…·çš„è¿è¡ŒçŠ¶æ€ï¼Œä¾‹å¦‚ï¼š&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;350&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;350&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_r.jpg&quot; data-actualsrc=&quot;https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;&lt;br/&gt;é€šè¿‡ &lt;code&gt;binlogctl&lt;/code&gt; ä¹Ÿå¯ä»¥æŸ¥è¯¢åˆ°åŒæ ·çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š&lt;/p&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;$ bin/binlogctl -pd-urls=localhost:2379 -cmd pumps
[2019/06/26 14:36:29.158 +08:00] [INFO] [nodes.go:49] [&amp;#34;query node&amp;#34;] [type=pump] [node=&amp;#34;{NodeID: pump:8250, Addr: 127.0.0.1:8250, State: online, MaxCommitTS: 409345979065827329, UpdateTime: 2019-06-26 14:36:27 +0800 CST}&amp;#34;]&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;br/&gt;æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ç”¨ MySQL å®¢æˆ·ç«¯è¿æ¥ä¸Šç«¯å£ä¸º 4000 æˆ– 4001 çš„ TiDB æ•°æ®åº“ï¼Œæ’å…¥ä¸€äº›æµ‹è¯•æ•°æ®ã€‚&lt;br/&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;295&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;295&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_r.jpg&quot; data-actualsrc=&quot;https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;p&gt;&lt;br/&gt;ä¸Šå›¾çš„æ¼”ç¤ºä¸­åˆ›å»ºäº†ä¸€ä¸ªå« &lt;code&gt;hello_binlog&lt;/code&gt; çš„ databaseï¼Œåœ¨é‡Œé¢æ–°å»ºäº† &lt;code&gt;user_info&lt;/code&gt; è¡¨å¹¶æ’å…¥äº†ä¸¤è¡Œæ•°æ®ã€‚å®Œæˆä¸Šè¿°æ“ä½œåï¼Œå°±å¯ä»¥è¿æ¥åˆ°ç«¯å£ä¸º 3306 çš„ä¸‹æ¸¸æ•°æ®åº“éªŒè¯åŒæ­¥æ˜¯å¦æˆåŠŸï¼š&lt;br/&gt;&lt;/p&gt;&lt;figure data-size=&quot;normal&quot;&gt;&lt;noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;252&quot; class=&quot;origin_image zh-lightbox-thumb&quot; width=&quot;939&quot; data-original=&quot;https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_r.jpg&quot;/&gt;&lt;/noscript&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_b.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;939&quot; data-rawheight=&quot;252&quot; class=&quot;origin_image zh-lightbox-thumb lazy&quot; width=&quot;939&quot; data-original=&quot;https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_r.jpg&quot; data-actualsrc=&quot;https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_b.jpg&quot;/&gt;&lt;/figure&gt;&lt;h2&gt;&lt;br/&gt;å°ç»“&lt;/h2&gt;&lt;p&gt;æœ¬æ–‡ç®€å•ä»‹ç»äº† tidb-tools å’Œ tidb-binlog åŠå…¶ä¸­çš„ç›®å½•ï¼Œå¹¶ä¸”å±•ç¤ºäº†å¦‚ä½•å¯åŠ¨æµ‹è¯•é›†ç¾¤ã€‚æœ‰äº†è¿™äº›å‡†å¤‡ï¼Œå¤§å®¶å°±å¯ä»¥è¿›ä¸€æ­¥äº†è§£å„ä¸ªåŠŸèƒ½çš„æºç å®ç°ã€‚ä¸‹ç¯‡æ–‡ç« å°†ä¼šä»‹ç» &lt;code&gt;pump_client&lt;/code&gt; å¦‚ä½•å°†ä¸€æ¡ binlog å‘é€å¾€ Pump Serverã€‚&lt;/p&gt;&lt;p&gt;&lt;br/&gt;åŸæ–‡é“¾æ¥ï¼š&lt;a href=&quot;https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-binlog-source-code-reading-2/&quot; class=&quot; external&quot; target=&quot;_blank&quot; rel=&quot;nofollow noreferrer&quot;&gt;&lt;span class=&quot;invisible&quot;&gt;https://&lt;/span&gt;&lt;span class=&quot;visible&quot;&gt;pingcap.com/blog-cn/tid&lt;/span&gt;&lt;span class=&quot;invisible&quot;&gt;b-binlog-source-code-reading-2/&lt;/span&gt;&lt;span class=&quot;ellipsis&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;å»¶å±•é˜…è¯»ï¼š&lt;/p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/69587196&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;https://pic3.zhimg.com/v2-c3da67191753fc9376f711e1c9dbec9a_180x120.jpg&quot; data-image-width=&quot;1280&quot; data-image-height=&quot;593&quot; class=&quot;internal&quot;&gt;ZoeyZhaiï¼šTiDB Binlog æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆä¸€ï¼‰åº&lt;/a&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2019-07-05-72306986</guid>
<pubDate>Fri, 05 Jul 2019 00:00:00 +0800</pubDate>
</item>
</channel>
</rss>
