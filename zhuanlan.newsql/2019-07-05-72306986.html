<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>TiDB Binlog 源码阅读系列文章（二）初识 TiDB Binlog 源码</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/72306986">原文</a></p>
<div class="title-image"><img src="https://pic3.zhimg.com/v2-7e9b57ad1e4c1ebaae5bfabfa6d28ffb_b.jpg" alt=""></div><p>作者：satoru</p><h2>TiDB Binlog 架构简介</h2><p>TiDB Binlog 主要由 Pump 和 Drainer 两部分组成，其中 Pump 负责存储 TiDB 产生的 binlog 并向 Drainer 提供按时间戳查询和读取 binlog 的服务，Drainer 负责将获取后的 binlog 合并排序再以合适的格式保存到对接的下游组件。<br/></p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="402" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="402" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-57c2652749ce0db78f97e527819d1c36_b.jpg"/></figure><p><br/><b>在《<a href="https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-ecosystem-tools-1/" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiDB Binlog 架构演进与实现原理</a>》一文中，我们对 TiDB Binlog 整体架构有更详细的说明，建议先行阅读该文。</b></p><h2>相关源码仓库</h2><p>TiDB Binlog 的实现主要分布在 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-tools/" class=" wrap external" target="_blank" rel="nofollow noreferrer">tidb-tools</a> 和 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog" class=" wrap external" target="_blank" rel="nofollow noreferrer">tidb-binlog</a> 两个源码仓库中，我们先介绍一下这两个源码仓库中的关键目录。</p><p><b>1. tidb-tools</b></p><p>Repo: <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-tools/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/pingcap/tidb</span><span class="invisible">-tools/</span><span class="ellipsis"></span></a></p><p>这个仓库除了 TiDB Binlog 还有其他工具的组件，在这里与 TiDB Binlog 关系最密切的是 <code>tidb-binlog/pump_client</code> 这个 package。<code>pump_client</code> 实现了 Pump 的客户端接口，当 binlog 功能开启时，TiDB 使用它来给 pump <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-tools/blob/v3.0.0-rc.3/tidb-binlog/pump_client/client.go%23L242" class=" wrap external" target="_blank" rel="nofollow noreferrer">发送 binlog</a> 。</p><p><b>2. tidb-binlog</b></p><p>Repo: <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/pingcap/tidb</span><span class="invisible">-binlog</span><span class="ellipsis"></span></a></p><p>TiDB-Binlog 的核心组件都在这个仓库，下面是各个关键目录：</p><ul><li><code>cmd</code>：包含 <code>pump</code>，<code>drainer</code>，<code>binlogctl</code>，<code>reparo</code>，<code>arbiter</code> 等 5 个子目录，分别对应 5 个同名命令行工具。这些子目录下面的 <code>main.go</code> 是对应命令行工具的入口，而主要功能的实现则依赖下面将介绍到的各个同名 packages。</li><li><code>pump</code>：Pump 源码，主要入口是 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/pump/server.go%23L103" class=" wrap external" target="_blank" rel="nofollow noreferrer">pump.NewServer</a></code> 和 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/pump/server.go%23L313" class=" wrap external" target="_blank" rel="nofollow noreferrer">Server.Start</a></code>；服务启动后，主要的功能是 <code>WriteBinlog</code>（面向 <code>TiDB/pump_client</code>） 和 <code>PullBinlogs</code>（面向 <code>Drainer</code>）。</li><li><code>drainer</code>：Drainer 源码，主要入口是 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/drainer/server.go%23L88" class=" wrap external" target="_blank" rel="nofollow noreferrer">drainer.NewServer</a></code> 和 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/drainer/server.go%23L238" class=" wrap external" target="_blank" rel="nofollow noreferrer">Server.Start</a></code>；服务启动后，Drainer 会先找到所有 Pump 节点，然后调用 Pump 节点的 <code>PullBinlogs</code> 接口同步 binlog 到下游。目前支持的下游有：mysql/tidb，file（文件增量备份），kafka 。</li><li><code>binlogctl</code>：Binlogctl 源码，实现一些常用的 Binlog 运维操作，例如用 <code>-cmd pumps</code> 参数可以查看当前注册的各个 Pump 节点信息，相应的实现就是 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/binlogctl/nodes.go%23L37" class=" wrap external" target="_blank" rel="nofollow noreferrer">QueryNodesByKind</a></code>。</li><li><code>reparo</code>：Reparo 源码，实现从备份文件（Drainer 选择 file 下游时保存的文件）恢复数据到指定数据库的功能。</li><li><code>arbiter</code>：Arbiter 源码，实现从 Kafka 消息队列中读取 binlog 同步到指定数据库的功能，binlog 在消息中以 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-tools/blob/v3.0.0-rc.3/tidb-binlog/slave_binlog_proto/proto/binlog.proto%23L85" class=" wrap external" target="_blank" rel="nofollow noreferrer">Protobuf</a></code> 格式编码。</li><li><code>pkg</code>：各个工具公用的一些辅助类的 packages，例如 <code>pkg/util</code> 下面有用于重试函数执行的 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/pkg/util/util.go%23L145" class=" wrap external" target="_blank" rel="nofollow noreferrer">RetryOnError</a></code>，pkg/version 下面有用于打印版本信息的 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/pkg/version/version.go%23L45" class=" wrap external" target="_blank" rel="nofollow noreferrer">PrintVersionInfo</a></code>。</li><li><code>tests</code>：集成测试。</li></ul><h2>启动测试集群</h2><p>上个小节提到的 <code>tests</code> 目录里有一个名为 <code>run.sh</code> 脚本，我们一般会使用 <code><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-binlog/blob/v3.0.0-rc.3/Makefile%23L68" class=" wrap external" target="_blank" rel="nofollow noreferrer">make integration_test</a></code> 命令，通过该脚本执行一次完整的集成测试，不过现在我们先介绍如何用它来启动一个测试集群。<br/>启动测试集群前，需要在 <code>bin</code> 目录下准备好相关组件的可执行文件：</p><ol><li>pd-server：下载链接（<a href="https://link.zhihu.com/?target=https%3A//download.pingcap.org/pd-master-linux-amd64.tar.gz" class=" wrap external" target="_blank" rel="nofollow noreferrer">Linux</a> / <a href="https://link.zhihu.com/?target=https%3A//download.pingcap.org/pd-master-darwin-amd64.tar.gz" class=" wrap external" target="_blank" rel="nofollow noreferrer">macOS</a>）</li><li>tikv-server：下载链接（<a href="https://link.zhihu.com/?target=https%3A//download.pingcap.org/tikv-master-linux-amd64.tar.gz" class=" wrap external" target="_blank" rel="nofollow noreferrer">Linux</a> / <a href="https://link.zhihu.com/?target=https%3A//download.pingcap.org/tikv-master-darwin-amd64.tar.gz" class=" wrap external" target="_blank" rel="nofollow noreferrer">macOS</a>）</li><li>tidb-server：下载链接（<a href="https://link.zhihu.com/?target=https%3A//download.pingcap.org/tidb-master-linux-amd64.tar.g" class=" wrap external" target="_blank" rel="nofollow noreferrer">Linux</a> / <a href="https://link.zhihu.com/?target=https%3A//download.pingcap.org/tidb-master-darwin-amd64.tar.gz" class=" wrap external" target="_blank" rel="nofollow noreferrer">macOS</a>）</li><li><code>pump</code>, <code>drainer</code>, <code>binlogctl</code>：在 tidb-binlog 目录执行 <code>make build</code></li></ol><p>脚本依赖 MySQL 命令行客户端来确定 TiDB 已经成功启动，所以我们还需要安装一个 MySQL 客户端。</p><p>准备好以上依赖，运行 <code>tests/run.sh --debug</code>，就可以启动一个测试集群。启动过程中会输出一些进度信息，看到以下提示就说明已成功启动：</p><div class="highlight"><pre><code class="language-text">Starting Drainer... 
You may now debug from another terminal. Press [ENTER] to continue.</code></pre></div><p>测试集群包含以下服务：</p><ol><li>2 个作为上游的 TiDB 实例，分别使用端口 4000 和 4001</li><li>1 个作为下游的 TiDB 实例， 使用端口 3306</li><li>PD 实例，使用端口 2379</li><li>TiKV，使用端口 20160</li><li>Pump ，使用端口 8250</li><li>Drainer，使用端口 8249</li></ol><p>使用 MySQL 客户端连接任意一个上游 TiDB，可以用 <code>SHOW PUMP STATUS</code> 和 <code>SHOW DRAINER STATUS</code> 查询对应工具的运行状态，例如：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="350" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="350" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-97f89c164e7fbb354e60b91e05cc20f1_b.jpg"/></figure><p><br/>通过 <code>binlogctl</code> 也可以查询到同样的信息，例如：</p><div class="highlight"><pre><code class="language-text">$ bin/binlogctl -pd-urls=localhost:2379 -cmd pumps
[2019/06/26 14:36:29.158 +08:00] [INFO] [nodes.go:49] [&#34;query node&#34;] [type=pump] [node=&#34;{NodeID: pump:8250, Addr: 127.0.0.1:8250, State: online, MaxCommitTS: 409345979065827329, UpdateTime: 2019-06-26 14:36:27 +0800 CST}&#34;]</code></pre></div><p><br/>接下来我们可以用 MySQL 客户端连接上端口为 4000 或 4001 的 TiDB 数据库，插入一些测试数据。<br/></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="295" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="295" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-a01bc8e8c6aaff1836551d65bf7db725_b.jpg"/></figure><p><br/>上图的演示中创建了一个叫 <code>hello_binlog</code> 的 database，在里面新建了 <code>user_info</code> 表并插入了两行数据。完成上述操作后，就可以连接到端口为 3306 的下游数据库验证同步是否成功：<br/></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="252" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="252" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-b1d08efefc8e02fb49c2342dd8a00d73_b.jpg"/></figure><h2><br/>小结</h2><p>本文简单介绍了 tidb-tools 和 tidb-binlog 及其中的目录，并且展示了如何启动测试集群。有了这些准备，大家就可以进一步了解各个功能的源码实现。下篇文章将会介绍 <code>pump_client</code> 如何将一条 binlog 发送往 Pump Server。</p><p><br/>原文链接：<a href="https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tidb-binlog-source-code-reading-2/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">pingcap.com/blog-cn/tid</span><span class="invisible">b-binlog-source-code-reading-2/</span><span class="ellipsis"></span></a></p><p>延展阅读：</p><a href="https://zhuanlan.zhihu.com/p/69587196" data-draft-node="block" data-draft-type="link-card" data-image="https://pic3.zhimg.com/v2-c3da67191753fc9376f711e1c9dbec9a_180x120.jpg" data-image-width="1280" data-image-height="593" class="internal">ZoeyZhai：TiDB Binlog 源码阅读系列文章（一）序</a><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
