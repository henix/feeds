<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>沅有芷兮：类型系统的数学之美</title>
</head>
<body>
<p><a href="https://mp.weixin.qq.com/s?timestamp=1560957130&amp;src=3&amp;ver=1&amp;signature=nqjLrMvTEWHBKIvLLa4C95CFvbHR8Gn7wbz0p81B7SfjIwf18-3MqoIkEpZYq1wyxIWcm34o-444oGA1IjWvKA*7b7ooz4sF4Zw*85fzKyW*2bJFQJvnnyiF5DX9FzC*lkhbrFE5lDT07fa8ZjbGQzBEa-ew7zJileuLUxDf1bY=">原文</a></p>
<div id="js_top_ad_area" class="top_banner"/>
<div class="rich_media_inner">

        
        
		<div id="page-content" class="rich_media_area_primary">

		  <div class="rich_media_area_primary_inner">

            
                          
                        

            <div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">
                    
                    
                    
            沅有芷兮：类型系统的数学之美
                      </h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                            <span id="copyright_logo" class="rich_media_meta rich_media_meta_text meta_tag_text">原创：</span>
                                                            <span class="rich_media_meta rich_media_meta_text">
                                                <span id="js_author_name" class="rich_media_meta_link" data-rewardsn="" data-timestamp="" data-canreward="0">陈小天</span>
                                            </span>
                                        
                                                                                                            <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" id="js_name">
                        程序人生                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">程序人生</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt=""/>

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">programmer_life</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">十年漫漫程序人生，打过各种杂，也做过让我骄傲的软件；管理过数十人的团队，还带领一班兄弟姐妹创过业，目前在硅谷一家创业公司担任 VP。关注程序人生，了解程序猿，学做程序猿，做好程序猿，让我们的程序人生精彩满满。</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"/>
                              <i class="profile_arrow arrow_in"/>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text"/>





                </div>
                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <p style="margin-right: 10px;margin-bottom: 20px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);line-height: 28px;background-color: rgb(255, 255, 255);font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size: 16px;box-sizing: border-box !important;overflow-wrap: break-word !important;">昨天的文章删了，因为我的 vscode 把 markdown 里的 * 自动替换成了 _，导致一些公式的表述变得异常奇怪。另外，原创忘记打开了。<img src="https://res.wx.qq.com/mpres/htmledition/images/icon/common/emotion_panel/emoji_wx/2_05.png" data-ratio="1" data-w="20" style="display:inline-block;width:20px;vertical-align:text-bottom;"/> 原文区别不大，看过的，点个看过就好了，多谢！</p><hr style="border-style: solid;border-width: 1px 0 0;border-color: rgba(0,0,0,0.1);-webkit-transform-origin: 0 0;-webkit-transform: scale(1, 0.5);transform-origin: 0 0;transform: scale(1, 0.5);"/><p style="margin-right: 10px;margin-bottom: 20px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);line-height: 28px;background-color: rgb(255, 255, 255);font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size: 16px;box-sizing: border-box !important;overflow-wrap: break-word !important;">最近两周在给 team 培训 rust。虽然去年汉东给我们北京的 team 做过一次 rust 讲座，我的好友旭东也跟我布道过不少 rust 的美妙之处，但我真正开始系统性学习 rust，也就是三周之前。对大多数人而言，rust 最令人兴奋的是所有权的概念，零成本抽象的能力，以及通过合适的约束巧妙解决内存安全和线程安全两大难题的优雅 —— 记得看过一个统计，linux kernel 里面这两类 bug 占据了 1/2 强。也就是说，你只要学会了 rust，就躺着消弭了 50% 的难啃的让 kernel developer 都闻之变色的 bug。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);line-height: 28px;background-color: rgb(255, 255, 255);font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size: 16px;box-sizing: border-box !important;overflow-wrap: break-word !important;">但对我来说，rust 的美妙之处在于其为如此底层的语言注入了如此高级的吸收了大量 Haskell 精髓的类型系统。如果你接触过 Haskell / F# / Scala，你大概能了解我的兴奋之处。我们所处的世界往往是鱼与熊掌不可兼得 —— Haskell 长于类型系统，但让程序员失去了对数据在内存中如何排布的控制；C 长于对数据在内存中的精确控制，但没有一个像样的类型系统。rust 几乎做到了二者兼得。虽然我的 haskell 之旅最终从入门走向了放弃，但就像冰火岛上对武功秘籍懵懵懂懂的无忌，那些 monad，monoid，semigroup，sum type，product type 等概念还是烙在我的脑海里，它们尘封着，等待一个契机，让自己重见天日。这个契机，便是 rust。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);line-height: 28px;background-color: rgb(255, 255, 255);font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size: 16px;box-sizing: border-box !important;overflow-wrap: break-word !important;">本文借用 rust，谈谈我对类型系统的一知半解。文章本身和 rust 并不太大，有其它编程语言经验的朋友想必也能读懂。</p><section class="level2" style="color: rgb(0, 0, 0);font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><h2 style="margin-top: 38px;margin-bottom: 10px;font-weight: bold;-webkit-font-smoothing: subpixel-antialiased;cursor: text;font-size: 24px;border-bottom: 2px solid rgb(0, 179, 139);color: rgb(0, 179, 138);height: 57px;line-height: 62px;display: inline-block;">primitive type</h2><p style="margin-right: 10px;margin-bottom: 20px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">primitive type，基本类型。基本上每种编程语言都有 —— integer，string，bool，array，list/vector 等。它们就像元素周期表里的一个个元素，不多，但构成了我们这个花花世界。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">基本类型没有什么好讲的，不过在我们深入下面的话提前，我们需要问自己一个问题：什么是类型？</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">对于 u8 来说，它是 [0, 255] 之间的一个整数，是一个集合，可以这么表述：<code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">{ x | x ∈ [0, 255]}</code>。对于 String 来说，它是任意字符串的一个集合，<code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">{x | x ∈ ["", "a", ..., "War and Pease", ...]}</code>。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">所以，类型在数学上的意义是集合。</p></section><section class="level2" style="color: rgb(0, 0, 0);font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><h2 style="margin-top: 38px;margin-bottom: 10px;font-weight: bold;-webkit-font-smoothing: subpixel-antialiased;cursor: text;font-size: 24px;border-bottom: 2px solid rgb(0, 179, 139);color: rgb(0, 179, 138);height: 57px;line-height: 62px;display: inline-block;">product type</h2><p style="margin-right: 10px;margin-bottom: 20px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">product type 是几乎我们所知道的编程语言都有的数据类型 —— 在某些语言中它被称作 record (delphi, erlang)，另一些语言中被称作 struct (elixir, rust, go) 或者 object (javascript)。我们平时在软件开发中，最离不开的数据类型就是 product type，就像分子把不同元素的原子组合起来一样，product type 大大丰富了类型的可能性，从而很好地辅助我们做 DDD (Domain Driven Design)。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">我们看 product type 数学上的意义。product type，顾名思义，是不同类型的乘积。类型的乘积究竟是什么东西呢？假设 x 的定义域是集合 int，y 的定义域是集合 string，x * y 展开便是 (…, -2, -1, 0, 1, 2, …) * (“”, “a”, “ab”, “hello world”, …)，也就是说对于 int 里的任意一个值，都有 string 里的任意一个值与其配对，看起来有些眼熟对不对？这就是笛卡尔积 (Cartesian product)。如图所示：</p><figure><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="0.760546875" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/SER9L29WQ089EOMQx0AcB2xNYjFWTwMsIaZWAoZtz59Ng6KHx5WXZlqwzyeCs07CcF3MGXtlVyBicLCV6AM6Oww/640?wx_fmt=png" data-type="png" data-w="2560" style=""/></p><figcaption><br/></figcaption></figure><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">比如在 rust 里，我们可以这样为一个 user 建模：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/><li/><li/><li/><li/><li/></ul><pre class="code-snippet__js" data-lang="properties"><code><span class="code-snippet_outer"><span class="code-snippet__attr">struct</span> <span class="code-snippet__string">User {</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">username</span>: <span class="code-snippet__string">String,</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">nickname</span>: <span class="code-snippet__string">String,</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">email</span>: <span class="code-snippet__string">String,</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">email_verified</span>: <span class="code-snippet__string">bool,</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">}</span></span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">这个 User 类型的集合的取值范围，就是它内部的所有类型的笛卡尔积。<br/></p></section><section class="level2" style="color: rgb(0, 0, 0);font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><h2 style="margin-top: 38px;margin-bottom: 10px;font-weight: bold;-webkit-font-smoothing: subpixel-antialiased;cursor: text;font-size: 24px;border-bottom: 2px solid rgb(0, 179, 139);color: rgb(0, 179, 138);height: 57px;line-height: 62px;display: inline-block;">sum type</h2><p style="margin-right: 10px;margin-bottom: 20px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">笛卡尔积固然能帮助我们构建各式各样的复合类型，但它无法描述这样的场景：我们想为 User 添加一个 payment 的类型，它可以是信用卡，现金，微信，以及 ABT 其中的一种。自然，我们可以这样描述：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/><li/><li/><li/><li/><li/></ul><pre class="code-snippet__js" data-lang="swift"><code><span class="code-snippet_outer"><span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> <span class="code-snippet__title">Payment</span> </span>{</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">Creditcard</span>,</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">Cash</span>,</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">Wechat</span>,</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">Abt</span>,</span></code><code><span class="code-snippet_outer">}</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">但这样的类型并不完备 —— 如果用户选择了信用卡，那么需要信用卡号，过期时间，持卡人等信息，而选择 ABT，则需要钱包地址及其公钥。这该怎么办？我们需要类似于这样的类型：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/><li/><li/><li/></ul><pre class="code-snippet__js" data-lang="ruby"><code><span class="code-snippet_outer">Creditcard(CreditcardType) <span class="code-snippet__params">| </span></span></code><code><span class="code-snippet_outer"><span class="code-snippet_outer">Cash(f64) |</span> </span></code><code><span class="code-snippet_outer">... <span class="code-snippet__params">| </span></span></code><code><span class="code-snippet_outer">Abt(WalletType)</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">在集合论中，这被称作 disjoint union（不相交集），表述为 A + B。如图：</p><figure><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="1" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/SER9L29WQ089EOMQx0AcB2xNYjFWTwMs4cB6JWj1vIfRsfGWOf804ic2ribkibYDaNLqrGksu1hd0G3FbJ5dCp3UA/640?wx_fmt=png" data-type="png" data-w="1920" style=""/></p><figcaption><br/></figcaption></figure><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">不相交集在数据类型中往往被称作 tagged union (C++) 或者 sum type (haskell, rust)。和 product type 相反的是，大部分编程语言没有 sum type。我们看 rust 是如何使用 sum type 来解决上面的问题的：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/><li/></ul><pre class="code-snippet__js" data-lang="properties"><code><span class="code-snippet_outer"><span class="code-snippet__attr">struct</span> <span class="code-snippet__string">CreditcardInfo {</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">number</span>: <span class="code-snippet__string">String,</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">expiration</span>: <span class="code-snippet__string">chrono::NaiveDate,</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">holder</span>: <span class="code-snippet__string">String,</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">}</span></span></code><code><span class="code-snippet_outer"><br/></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">struct</span> <span class="code-snippet__string">WalletType {</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">address</span>: <span class="code-snippet__string">String,</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">pk</span>: <span class="code-snippet__string">[u8; 32]</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">}</span></span></code><code><span class="code-snippet_outer"><br/></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">enum</span> <span class="code-snippet__string">CreditcardType {</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">Creditcard(CreditcardInfo),</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">Cash(f64),</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">Wechat(AccountInfo),</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">Abt(WalletType)</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">}</span></span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">sum type 的美妙之处是它解决了类型系统中基本类型和复合类型潜在的不够严谨的问题，比如说这样一个函数：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/></ul><pre class="code-snippet__js" data-lang="nginx"><code><span class="code-snippet_outer"><span class="code-snippet__attribute">fn</span> div(x: f64, y: f64) -&gt; f64 { <span class="code-snippet__attribute">x</span> / y }</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">从 type signature 上看，似乎没有问题，但在实现层面上，我们很快发现 <code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">x / y</code> 有约束条件：y 不能是 0。我们要么设计一种新的数据类型 non_zero_f64 把零从中排除出去（这在大多数语言里都很困难），从输入的角度让这个函数的 type signature 完备；要么让返回的结果是一种特殊的类型，它可能是 f64，可能为空。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">由于大多数语言不支持 sum type，这种情况就只好用两种方式来解决：</p><ul style="" class=" list-paddingleft-2"><li><p><span style="color: rgb(0, 0, 0);">函数的返回值可能是 f64，可能是 null。</span><span style="color: rgb(0, 0, 0);">如果一门语言不支持异常，那么就只好检查一下输入，当为 0 时返回 null。</span></p></li><li><p><span style="color: rgb(0, 0, 0);">函数的返回值依旧是 f64，但除零的时候会抛出异常。</span><span style="color: rgb(0, 0, 0);">对于支持异常的语言，除了上一种方式，我们还可以抛出异常。</span></p></li></ul><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">第一种方式损害了类型的完备性，因为 type signature 不再有权威 —— 调用者不敢肯定自己一定会拿回一个 f64，所以只好也做相应的条件判断，把这种对于类型的泄露一层层传递出去。第二种方式也是对类型完备性的一种损伤，因为调用者需要知道并且选择处理或者不处理那些「意外」。因为意外不是返回类型的一部分，所以，额外的逻辑是必不可少的。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">上面 div 函数的问题只是冰山的一角。我们除了学习写代码和写 PoC 的代码外，其余的时刻都不可能只为 happy ending 写代码，毕竟我们面对的不是童话世界。错误和意外几乎伴随着任何一次互动 —— 和 IO 的互动，和类库（别人的代码）的互动，和系统调用的互动等。Scott Wlaschin 在他著名的 Railway Oriented Programming 里把一个又一个这样的情况拎出来寻求解决之道，而 sum type，就是最佳的选择。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">在 Rust 里，我们有类似于 Maybe Monad 的 Option：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/><li/><li/><li/></ul><pre class="code-snippet__js" data-lang="swift"><code><span class="code-snippet_outer"><span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> <span class="code-snippet__title">Option</span>&lt;<span class="code-snippet__title">T</span>&gt; </span>{</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">Some</span>(<span class="code-snippet__type">T</span>),</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">None</span></span></code><code><span class="code-snippet_outer">}</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">对于上面的函数，我们可以用 <code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">Option&lt;f64&gt;</code> 来完善其 type signature:</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/></ul><pre class="code-snippet__js" data-lang="cs"><code><span class="code-snippet_outer"><span class="code-snippet__function">fn <span class="code-snippet__title">div</span>(<span class="code-snippet__params">x: f64, y: f64</span>) -&gt; Option&lt;f64&gt;</span>;</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">当 y 为零，返回 None；不为零，返回 Some(x / y)。表面上看它似乎和上面第一种方式没有区别，但一个形式化完备的类型让很多事情变成了可能。这个函数可以被 pipe，被 compose，调用者不必担心类型的泄露 —— 所有信息都已经在 type signature 里面了，编译器可以做更合适更严格的检查，也可以适当优化 —— 更重要的是，围绕着这个类型，我们可以把一堆原本不断出现在用户代码中的对结果判断的 if else / try catch 抽象出来，成为 Option 类型的一组 behavior，这样让用户代码变得清晰。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">同样的思路，在 Rust 里，exception 被抛弃，取而代之的是是 Result，也是一个 sum type:</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/><li/><li/><li/></ul><pre class="code-snippet__js" data-lang="swift"><code><span class="code-snippet_outer"><span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> <span class="code-snippet__title">Result</span>&lt;<span class="code-snippet__title">T</span>, <span class="code-snippet__title">E</span>&gt; </span>{</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">Ok</span>(<span class="code-snippet__type">T</span>),</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">Err</span>(<span class="code-snippet__type">E</span>),</span></code><code><span class="code-snippet_outer">}</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">和 IO 的互动，和别人家的代码的互动，大家都可以通过 Result 来完成。围绕着 Result，也有一组标准的 behavior 和宏，处理其结果。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">围绕着编程语言是否需要 exception，exception 是良药还是毒药，有诸多争议，java / python 是建制派，C++ / haskell 是骑墙派，rust / go 是反对派，erlang / elixir 是无政府主义者，这里就不展开。你问我支持哪派？我当然是支持尤达大师啦（Do not 也蕴含着 Let it crash 的神韵）：</p><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="0.36941176470588233" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/SER9L29WQ089EOMQx0AcB2xNYjFWTwMsQMBE0npAwhBFbhLvZtgS6PDhqF1ddVcvJTJfp7YrULOtiaWda5GqQcg/640?wx_fmt=jpeg" data-type="jpeg" data-w="850" style=""/></p></section><section class="level2" style="color: rgb(0, 0, 0);font-family: -apple-system, &quot;SF UI Text&quot;, Arial, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);"><h2 style="margin-top: 38px;margin-bottom: 10px;font-weight: bold;-webkit-font-smoothing: subpixel-antialiased;cursor: text;font-size: 24px;border-bottom: 2px solid rgb(0, 179, 139);color: rgb(0, 179, 138);height: 57px;line-height: 62px;display: inline-block;">generics type</h2><p style="margin-right: 10px;margin-bottom: 20px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">Generics type，或者说泛型，是让人又爱又恨的类型。它简化了代码，提升了抽象程度，但程序员为之付出的代价是陡升的学习曲线。抛开泛型的好坏不提，我们先看看泛型的数学意义是什么。还是以 Option 类型来说事：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/><li/><li/><li/></ul><pre class="code-snippet__js" data-lang="swift"><code><span class="code-snippet_outer"><span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> <span class="code-snippet__title">Option</span>&lt;<span class="code-snippet__title">T</span>&gt; </span>{</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">Some</span>(<span class="code-snippet__type">T</span>),</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">None</span></span></code><code><span class="code-snippet_outer">}</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">T 代表任意类型，Option<t>是 T 映射到这个 enum 的结果。所以换个角度，我们可以认为泛型是作用在类型上的一种特殊的函数，它接受一种或者多种类型，返回一种新的类型。我们知道，编译器在处理具体的数据时会将泛型展开，比如说 <code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">Option&lt;u8&gt;</code> 展开后就是：</t></p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/><li/><li/><li/></ul><pre class="code-snippet__js" data-lang="swift"><code><span class="code-snippet_outer"><span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> <span class="code-snippet__title">Option</span> </span>{</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">Some</span>(u8),</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">None</span></span></code><code><span class="code-snippet_outer">}</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">这种展开可以无限制延伸下去，但彼此又并不想交，就好像 sum type：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/><li/><li/><li/><li/><li/><li/><li/><li/></ul><pre class="code-snippet__js" data-lang="swift"><code><span class="code-snippet_outer"><span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> <span class="code-snippet__title">Options</span> </span>{</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">U8</span>(<span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> </span>{ <span class="code-snippet__type">Some</span>(u8), <span class="code-snippet__type">None</span> }),</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">U16</span>(<span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> </span>{ <span class="code-snippet__type">Some</span>(u16), <span class="code-snippet__type">None</span> }),</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">String</span>(<span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> </span>{ <span class="code-snippet__type">Some</span>(<span class="code-snippet__type">String</span>), <span class="code-snippet__type">None</span> }),</span></code><code><span class="code-snippet_outer">  ...</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">VectorU8</span>(<span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> </span>{ <span class="code-snippet__type">Some</span>(<span class="code-snippet__type">Vec</span>&lt;u8&gt;), <span class="code-snippet__type">None</span> }),</span></code><code><span class="code-snippet_outer">  <span class="code-snippet__type">VectorU16</span>(<span class="code-snippet__class"><span class="code-snippet__keyword">enum</span> </span>{ <span class="code-snippet__type">Some</span>(<span class="code-snippet__type">Vec</span>&lt;u16&gt;), <span class="code-snippet__type">None</span> }),</span></code><code><span class="code-snippet_outer">  ...</span></code><code><span class="code-snippet_outer">}</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">这个结果就很有意思了。我们知道 sum type 的数学意义是类型之和，我们把 primitive type 记作 X，那么这里就有 n 个 X，<code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">Vector&lt;T&gt;</code> 可以是 <code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">Option&lt;T&gt;</code> 的一种类型，因而 <code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">Vector&lt;T&gt;</code> 可以展开成 nX，类似 <code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">Vector&lt;T&gt;</code> 这样的类型也有 n 个，那么到现在为止展开的 Options 可以记作 nX + n * nX，同理 HashMap&lt;T, E&gt; 是 n * nX，而 n 个类似 HashMap&lt;T, E&gt; 展开的选项为 n * n * nX，以此类推我们可以得出泛型代表着：</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li/></ul><pre class="code-snippet__js" data-lang="nginx"><code><span class="code-snippet_outer"><span class="code-snippet__attribute">n</span> + n^<span class="code-snippet__number">2</span> + n^<span class="code-snippet__number">3</span> + n^<span class="code-snippet__number">4</span> + ....</span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">种数据类型的集合。这是一个等比级数，其结果是 <code style="font-family: Consolas, &quot;Liberation Mono&quot;, Courier, monospace;font-size: 12px;margin-right: 2px;margin-left: 2px;padding-right: 5px;padding-left: 5px;white-space: nowrap;border-width: 1px;border-style: solid;border-color: rgb(234, 234, 234);background-color: rgb(248, 248, 248);border-radius: 3px;color: rgb(51, 51, 51);">n(1 - n^n) / (1 - n)</code>。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">以上。<br/></p><hr style="border-style: solid;border-width: 1px 0 0;border-color: rgba(0,0,0,0.1);-webkit-transform-origin: 0 0;-webkit-transform: scale(1, 0.5);transform-origin: 0 0;transform: scale(1, 0.5);"/><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">我们 ArcBlock 还在招募 iOS 工程师和后端工程师，如果你对技术有热情，欢迎发送简历给我：tyr at arcblock.io。想了解更多关于 ArcBlock 和区块链的信息，可以戳：<br/></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzA3NDM0ODQwMw==&amp;mid=2649828178&amp;idx=1&amp;sn=c5d0120098f2e51f12b16a05af4bd18b&amp;chksm=8704a94eb0732058916b6b04c20611bb5dd7fda3bf4bb0ff91ac14fc595f8ba5fd2ed79a5ba7&amp;scene=21#wechat_redirect" target="_blank" data-itemshowtype="0" data-linktype="2">ArcBlock 一周年</a><br/></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzA3NDM0ODQwMw==&amp;mid=2649828161&amp;idx=1&amp;sn=ba80c0212ecdd4e23c16263fb1cb8bb1&amp;chksm=8704a95db073204b3947117d1ea77d4ceb6650c0ae9279f0ce45fb2b706e7534e62847d42810&amp;scene=21#wechat_redirect" target="_blank" data-itemshowtype="0" data-linktype="2">ABT network 部署记</a><br/></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzA3NDM0ODQwMw==&amp;mid=2649828088&amp;idx=1&amp;sn=3fd4d3c48dde5aaf6c0d70848d945af0&amp;chksm=8704a8e4b07321f21a73393a16a874d0f5c3cb9deae88f611a6af15e39ac55b3a1aff593c33a&amp;scene=21#wechat_redirect" target="_blank" data-itemshowtype="0" data-linktype="2">在程序中时间旅行</a><br/></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzA3NDM0ODQwMw==&amp;mid=2649828078&amp;idx=1&amp;sn=5a16285e2cd2253be306e14229e58254&amp;chksm=8704a8f2b07321e48b60aba5b07a3b065564efeb4f9a9113183691c2684d0c8c2090fc0da04b&amp;scene=21#wechat_redirect" target="_blank" data-itemshowtype="0" data-linktype="2">区块链和数据库：致虚极，守静笃</a><br/></p></section><p><br/></p>
                </div>
                <script nonce="166920516" type="text/javascript"><![CDATA[
                    var first_sceen__time = (+new Date());

                    if ("" == 1 && document.getElementById('js_content')) {
                        document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });
                    }

                    
                    (function(){
                        if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                            var link = document.createElement('link');
                            var head = document.getElementsByTagName('head')[0];
                            link.rel = 'stylesheet';
                            link.type = 'text/css';
                            link.href = "//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg_new/winwx464c32.css";
                            head.appendChild(link);
                        }
                    })();
                ]]></script>

                
  <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display: none;"/>


                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_reward_area" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_reward_avatar">
                        <img src="" alt="" id="js_reward_author_head"/>
                    </div>
                    
                                                                    <div class="reward-author" style="display: none;" id="js_reward_author">陈小天</div>
                                                                                    <p>
                        <a class="reward_button" id="js_reward_link" href="##"><span id="js_reward_link_text">赞赏</span></a>
                    </p>
                    <div id="js_reward_inner" class="reward_area_inner" style="display:none;">
                        <p class="weui-loadmore weui-loadmore_line reward_user_tips" id="js_reward_total_parent">
                          <span class="weui-loadmore__tips">
                            <a href="##" id="js_reward_total"/> <span id="js_reward_total_text">人赞赏</span>
                        </span>
                        </p>
                        
                        <div id="js_reward_list" class="reward_user_list"/>
                    </div>
                </div>
                                <div class="reward_qrcode_area reward_area tc" id="js_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                                        <p class="reward_tips"/>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" id="js_reward_qrcode_img"/></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                                                
                
                            </div>
                                    
                        


                        
            <ul id="js_hotspot_area" class="article_extend_area"/>


            

            


<div class="rich_media_tool" id="js_toobar3">

            <div id="js_read_area3" class="media_tool_meta tips_global_primary meta_primary" style="display:none;">

    <span id="readTxt">阅读</span>

    <span id="readNum3"/>
    </div>


    <span style="display:none;" class="media_tool_meta meta_extra meta_praise" id="like_old">
        <i class="icon_praise_gray"/><span class="praise_num" id="likeNum_old"/>
    </span>

      
    <span class="media_tool_meta meta_extra meta_share" style="display: none;">
        <button class="share_btn" id="js_share_btn">分享</button>
    </span>
    <span style="display:none;" class="media_tool_meta meta_extra meta_like" id="like3">
        <button class="like_btn" id="js_like_btn"> 
          <span id="js_like_wording"> 在看</span><span class="like_num" id="likeNum3"/>
        </button>
    </span>

      <div style="display:none">
        <div class="weui-mask"/>
        <div class="weui-dialog weui-dialog_haokan">
        <div class="weui-dialog__hd"><strong class="weui-dialog__title" id="educate_title">已同步到看一看</strong></div>
        <div class="weui-dialog__bd">
        </div>
        <div class="weui-dialog__ft" id="educate_btn" style="display: none">
          <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default" id="js_cancel">取消</a>
          <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="js_confirm">发送</a>
        </div>
        <div class="weui-dialog__ft" id="educate_btn2" style="display: none">
          <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="js_acknowledge">我知道了</a>
        </div>
        </div>
    </div>

    
    </div>

<div style="display: none;" id="js_like_educate" class="like_skin_primary like_comment_primary_pop">
  <div id="js_like_educate_wrapper" class="like_comment_primary_wrp like_comment_primary_pos_top">
    <div class="like_comment_primary_inner">
      <div class="like_comment_primary_hd">
        <h4 class="like_comment_primary_title">
          朋友会在“发现-看一看”看到你“在看”的内容        </h4>
        <button id="js_b_like_confirm" class="like_comment_primary_btn">确定</button>
      </div>
      <div class="like_comment_primary_bd">
        <img class="pic_haokan" src="//res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_haokan4516f7.png"/>
      </div>
    </div>
  </div>
  <div class="like_comment_primary_mask" id="js_mask_3"/>
</div>

  
  <div class="like_comment_wrp" id="js_a_like_comment" style="display: none;">
    <div class="like_comment_inner">
      <div class="like_comment_hd" style="display:none" id="js_like_title"/>
      <div class="like_comment_bd">
        <div class="tips_global_primary like_comment_tips">
          <i class="weui-icon-success"/><i class="icon-success-primary"/>已同步到看一看<a href="javascript:;" class="like_comment_share_link" id="js_a_like_comment_share">写下你的想法</a>
        </div>
      </div>
      <div class="like_comment_ft">
        <span id="js_a_like_comment_msg" class="like_comment_msg" style="visibility:hidden">最多200字，当前共<span id="js_a_like_current_cnt"/>字</span>
        <button class="like_comment_btn" disabled="disabled" id="js_a_like_confirm">发送</button>
      </div>
    </div>
  </div>

<div id="js_like_toast" style="display: none;">
  <div class="weui-mask_transparent"/>
  <div class="weui-toast">
    <i class="weui-icon-success-no-circle weui-icon_toast"/>
    <p class="weui-toast__content" id="js_toast_msg">已发送</p>
  </div>
</div>


<div style="display: none;" id="js_b_comment_panel" class="like_comment_primary_pop">
  <div class="like_comment_primary_wrp" id="js_b_wrp">
    <div class="like_comment_primary_inner">
      <div class="like_comment_primary_hd">
        <h4 class="like_comment_primary_title">
          朋友将在看一看看到        </h4>
        <button id="js_b_like_confirm" class="like_comment_primary_btn">确定</button>
      </div>
      <div id="js_b_comment_text_first" class="like_comment_primary_bd">
        <span class="tips_global_primary">
          写下你的想法...        </span>
      </div>
    </div>
  </div>
  <div class="like_comment_primary_mask" id="js_mask_1"/>
</div>

<div style="display: none;" id="js_b_comment_final">
  <div class="like_comment_primary_wrp editing" id="js_comment_wrp">
    <div class="like_comment_primary_inner">
      <div class="like_comment_primary_hd">
        <button class="like_comment_primary_cancel" id="js_b_comment_cancel">取消</button>
        <h4 class="like_comment_primary_title"> 发布到看一看 </h4>
        <button class="like_comment_primary_btn" id="js_b_comment_confirm">确定</button>
      </div>
      <div class="like_comment_primary_bd">
        <textarea class="like_comment_textarea weui-textarea" placeholder="写下你的想法..." id="js_b_comment_text_second"/>
      </div>
      <span class="like_comment_msg" id="js_b_like_comment_msg" style="visibility: hidden;">最多200字，当前共<span id="js_b_like_current_cnt"/>字</span>
    </div>
  </div>
  <div class="like_comment_primary_mask" id="js_mask_2"/>
</div>

<div id="js_loading" style=" display: none;">
    <div class="weui-mask_transparent"/>
    <div class="weui-toast">
        <i class="weui-loading weui-icon_toast"/>
        <p class="weui-toast__content">发送中</p>
    </div>
</div>



                        <div class="rich_media_tool" id="js_sg_bar">

                                
            </div>
                      </div>
        </div>

        <div class="rich_media_area_primary sougou" id="sg_tj" style="display:none"/>


        
        <div class="rich_media_area_extra">
          <div class="rich_media_area_extra_inner">
              
              <div id="js_share_appmsg">
              </div>

              
  
      <div class="mpda_bottom_container" id="js_bottom_ad_area"/>
                
              <div id="js_iframetest" style="display:none;"/>
                            
                            
              <div class="rich_media_extra rich_media_extra_discuss" id="js_cmt_container" style="display:none">
                

                
                <div class="discuss_mod" id="js_friend_cmt_area" style="display:none">
                  
                  
                  
                </div>

                                <div class="discuss_mod" id="js_cmt_area" style="display:none">
                </div>
                              </div>
          </div>
        </div>

        
        <div id="js_pc_qr_code" class="qr_code_pc_outer" style="display:none;">
            <div class="qr_code_pc_inner">
                <div class="qr_code_pc">
                    <img id="js_pc_qr_code_img" class="qr_code_pc_img"/>
                    <p>微信扫一扫<br/>关注该公众号</p>
                </div>
            </div>
        </div>
    </div>

<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
