<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>å…±ç”¨çš„æŠ½è±¡æ¨¡å‹ï¼ˆå®¢æˆ·åŠæœåŠ¡å™¨ç«¯ï¼‰- è½¬ï¼è§£ç  ä»¥åŠ Jsonï¼XML å¤„ç†</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/25052175">åŸæ–‡</a></p>
<p><b>è½¬ç ï¼è§£ç </b></p><p><a href="http://tools.ietf.org/html/rfc7231#section-3.1.2.1" data-editable="true" data-title="HTTP è§„èŒƒ">HTTP è§„èŒƒ</a> å®šä¹‰äº†ä¸€ä¸ª <u>Content-Encoding</u> å¤´åŸŸç”¨äºæ ‡ç¤º HTTP ä¿¡æ¯ä¸­çš„æ­£æ–‡å†…å®¹ä¸º â€œå·²è½¬ç â€ï¼Œä»¥åŠå¯¹åº”çš„ç®—æ³•ã€‚è€Œåœ¨è¯¥å¤´åŸŸä¸­å”¯ä¸€é€šç”¨çš„è½¬ç ç®—æ³•åˆ™æ˜¯å‹ç¼©ç±»ç®—æ³•ã€‚<br></p><p>ç›®å‰ Akka HTTP æ”¯æŒ HTTP è¯·æ±‚å’Œå“åº”çš„åŠ ï¼è§£å‹ç®—æ³•ï¼ˆ<u>gzip</u> æˆ– <u>deflate</u> è½¬ç ï¼‰ã€‚ç›¸å…³çš„æ ¸å¿ƒé€»è¾‘åœ¨ <a href="http://github.com/akka/akka-http/tree/v10.0.3/akka-http/src/main/scala/akka/http/scaladsl/coding" data-editable="true" data-title="akka.http.scaladsl.coding">akka.http.scaladsl.coding</a> åŒ…ä¸­<br></p><p><i>æœåŠ¡å™¨ç«¯</i><br></p><p>ç›¸å…³æ”¯æŒå¹¶æ²¡æœ‰è‡ªåŠ¨å¼€å¯ï¼Œè€Œéœ€è¦ç‰¹æ„æ ‡æ˜ã€‚ä½¿ç”¨ <a href="http://doc.akka.io/docs/akka-http/current/scala/http/routing-dsl/index.html#http-high-level-server-side-api" data-editable="true" data-title="è·¯ç”± DSL">è·¯ç”± DSL</a> å¯åŠ¨ä¿¡æ¯çš„ è½¬ï¼è§£ç åŠŸèƒ½è¯·å‚è€ƒ <a href="http://doc.akka.io/docs/akka-http/current/scala/http/routing-dsl/directives/coding-directives/index.html#codingdirectives" data-editable="true" data-title="CodingDirectives">CodingDirectives</a>.</p><p><i>å®¢æˆ·ç«¯</i></p><p>ç›®å‰å®¢æˆ·ç«¯å¹¶æ²¡æœ‰å¯¹äºå“åº”ä¿¡æ¯çš„é«˜é˜¶æˆ–è‡ªåŠ¨åŒ–çš„è§£ç åŠŸèƒ½æ”¯æŒã€‚</p><p>ä»¥ä¸‹çš„ä¾‹å­å¯ä»¥ä½œä¸ºæ‰‹åŠ¨å¤„ç†å“åº”ä¿¡æ¯è§£ç çš„å‚è€ƒã€‚</p><p><a href="http://github.com/akka/akka-http/tree/master/docs/src/main/paradox/scala/http/common/de-coding.md" data-editable="true" data-title="æºç é“¾æ¥">æºç é“¾æ¥</a></p><code lang="scala">import akka.actor.ActorSystem
import akka.http.scaladsl.Http
import akka.http.scaladsl.coding.{ Gzip, Deflate, NoCoding }
import akka.http.scaladsl.model._, headers.HttpEncodings
import akka.stream.ActorMaterializer

import scala.concurrent.Future

implicit val system = ActorSystem()
implicit val materializer = ActorMaterializer()
import system.dispatcher

val http = Http()

val requests: Seq[HttpRequest] = Seq(
  "https://httpbin.org/gzip", // Content-Encoding: å“åº”ä¿¡æ¯ä¸ºgzip
  "https://httpbin.org/deflate", // Content-Encoding: å“åº”ä¿¡æ¯ä¸ºdeflate
  "https://httpbin.org/get" // å“åº”ä¿¡æ¯æ—  Content-Encoding
).map(uri â‡’ HttpRequest(uri = uri))

def decodeResponse(response: HttpResponse): HttpResponse = {
  val decoder = response.encoding match {
    case HttpEncodings.gzip â‡’
      Gzip
    case HttpEncodings.deflate â‡’
      Deflate
    case HttpEncodings.identity â‡’
      NoCoding
  }

  decoder.decode(response)
}

val futureResponses: Future[Seq[HttpResponse]] =
  Future.traverse(requests)(http.singleRequest(_).map(decodeResponse))</code><br><p><b>JSON ï¼XML ç›¸å…³æ”¯æŒ</b></p><p>Akka HTTP çš„ç¼–é›†ï¼åç¼–é›†æ¶æ„ä½¿å¾—å¼€å‘è€…èƒ½ç›¸å¯¹å®¹æ˜“åœ°ä¸ºå…¶åº”ç”¨å¼€å‘çš„æ•°æ®ç»“æ„æä¾›å¯¹åº”çš„é€šè®¯æ ¼å¼ï¼ˆå¦‚JSONï¼ŒXMLç”šè‡³äºŒè¿›åˆ¶æ ¼å¼ï¼‰ã€‚</p><br>Akka HTTP ç›®å‰é€šè¿‡ <a href="https://github.com/spray/spray-json" data-title="spray-json" class="" data-editable="true">spray-json</a> ï¼ˆç»“åˆ <u>akka-http-spray-json</u> æ¨¡å—ï¼‰æä¾›ç›¸åº”çš„ JSON æ”¯æŒã€‚ è€Œ XML åˆ™æ˜¯ é€šè¿‡ <a href="https://github.com/scala/scala-xml" data-editable="true" data-title="Scala XML">Scala XML</a> (ç»“åˆ <u>akka-http-xml</u> æ¨¡å—) æä¾›ç›¸åº” XML æ”¯æŒã€‚<br><p>å¦‚æœå®˜æ–¹æ¨¡å—ä¸ç¬¦åˆå¼€å‘è€…éœ€æ±‚ï¼Œç¤¾åŒºä¹Ÿæä¾›äº†å…¶å®ƒçš„ JSON åº“ä»¥ä¾›é€‰æ‹©ã€‚å¯å‚è€ƒç›¸å…³åˆ—è¡¨ã€‚</p><p><i><b>Spray-json æ”¯æŒ</b></i></p><p><a href="http://github.com/akka/akka-http/tree/v10.0.3/akka-http-marshallers-scala/akka-http-spray-json/src/main/scala/akka/http/scaladsl/marshallers/sprayjson/SprayJsonSupport.scala" data-editable="true" data-title="SprayJsonSupport" class="">SprayJsonSupport</a> trait ä¸ºå„ç§ï¼ˆå·²ç»æ‹¥æœ‰ <u>spray.json.RootJsonReader</u> å’Œï¼æˆ– <u>spray.json.RootJsonWriter</u> çš„ï¼‰ç±»å‹ T æä¾›äº†ä¸€ä¸ª FromEntityUnmarshaller[T] å’Œ ToEntityMarshaller[T] ã€‚</p><p>ï¼ˆè¯‘æ³¨ï¼šğŸçš„ï¼Œè¿™ä¸ªå®˜æ–¹è§£é‡Šç­‰äºæ²¡è§£é‡Š...éšå‡½çŸ¥è¯†ç‚¹å¤ªå¤šã€‚ç®€å•å‡ å¥ï¼Œå³ä½¿åœ¨ Akka HTTP ä½“ç³»ä»¥å¤–ï¼ŒScala çš„ JSON ä¸ T ç±»å‹é—´è½¬æ¢å¾ˆå¤šæ—¶å€™éœ€è¦ä¾èµ–å¯¹åº”çš„ Readerï¼Writer è¿›è¡Œå’Œ æ ¼å¼è½¬æ¢ã€‚è¿™ä¸ªå¯ä»¥å¦å¤–æ‰¾æ—¶é—´çœ‹çœ‹ã€‚è€Œæ”¾åˆ° Akka HTTP è¿™ä¸ªæ¶æ„ä¸‹ï¼Œåˆ™éœ€è¦å†ä¸º mashaller/unmarshaller æä¾›äºŒæ¬¡è½¬æ¢çš„æœºåˆ¶ã€‚å¦‚æœåŸæœ‰çš„ Readerï¼Writer å­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªäºŒæ¬¡è½¬æ¢çš„å°è£… å¯ä»¥è‡ªåŠ¨å®Œæˆï¼Œå‚è€ƒä¸‹æ–‡ç»†èŠ‚ã€‚ï¼‰</p><p>å¦‚éœ€å¯ç”¨ <a href="https://github.com/spray/spray-json" data-editable="true" data-title="spray-json">spray-json</a> çš„ç¼–é›†ï¼åç¼–é›†åŠŸèƒ½çš„è‡ªåŠ¨åŒ–æ”¯æŒï¼Œè¯·åœ¨åº”ç”¨ä¸­åŠ å…¥ä»¥ä¸‹çš„ä¾èµ–åº“</p><code lang="text">"com.typesafe.akka" %% "akka-http-spray-json" % "10.0.3"</code><p>ç„¶åï¼Œä¸ºå¼€å‘è€…æ‰€éœ€çš„ç±»å‹æä¾›ä¸€ä¸ª<u> RootJsonFormat[T] </u>å¹¶å¼•å…¥åˆ°å½“å‰å¯è§†åŸŸä¸­. å…·ä½“åšæ³•å¯ä»¥å‚è€ƒ <a href="https://github.com/spray/spray-json" data-editable="true" data-title="spray-json" class="">spray-json</a> çš„ç›¸å…³æ–‡æ¡£ã€‚</p><p>ï¼ˆè¯‘æ³¨ï¼šFormat æœ¬èº«å°±æ˜¯ Reader/Writer çš„åˆå¹¶ç±»å‹ï¼Œè¿™æ˜¯ç®—æ˜¯ Scala æ¯”è¾ƒä¸»æµçš„ä¸€ç§è®¾è®¡æ¨¡å¼ï¼‰</p><br><p>æœ€åï¼Œå¦‚ä»¥ä¸‹çš„ä¾‹å­èˆ¬ä» <u>SprayJsonSupport</u> ä¸­ç›´æ¥å¯¼å…¥éšå¼å‚æ•° <u>FromEntityUnmarshaller[T]</u> ä»¥åŠ <u>ToEntityMarshaller[T]</u>  æˆ–è€… ç³…åˆ <u>akka.http.scaladsl.marshallers.sprayjson.SprayJsonSupport</u> trait è‡³å¼€å‘è€…ç›¸å¯¹åº”çš„ JSON æ”¯æŒæ¨¡å—ä¸­</p><br><p>å½“ä¸Šè¿°æ­¥éª¤å®Œæˆåï¼Œ å¼€å‘è€…åº”è¯¥å¯ä»¥æ— ç¼ä½¿ç”¨å®¢åˆ¶ç±»å‹ T ä¸ JSON é—´çš„ ç¼–é›†å’Œåç¼–é›† è½¬æ¢ã€‚<br></p><code lang="scala">import akka.http.scaladsl.server.Directives
import akka.http.scaladsl.marshallers.sprayjson.SprayJsonSupport
import spray.json._

// é¢†åŸŸæ¨¡å‹
final case class Item(name: String, id: Long)
final case class Order(items: List[Item])

// æŠŠå¼€å‘è€…çš„ json æ ¼å¼å¤„ç†ï¼ˆFormat æœ¬èº«æä¾› Reader/Writerï¼‰å…¨æ”¾åˆ°ä¸€ä¸ªè¾…åŠ© trait é‡Œ:
trait JsonSupport extends SprayJsonSupport with DefaultJsonProtocol {
  implicit val itemFormat = jsonFormat2(Item)
  implicit val orderFormat = jsonFormat1(Order) // contains List[Item]
}

// å½“éœ€è¦ json ç¼–é›†ï¼åç¼–é›† æ—¶ä½¿ç”¨
class MyJsonService extends Directives with JsonSupport {

  // format: OFF
  val route =
    get {
      pathSingleSlash {
        complete(Item("thing", 42)) // ä¼šç¼–é›†ä¸º JSON
      }
    } ~
    post {
      entity(as[Order]) { order =&gt; // ä¼šä» JSON åç¼–é›†åˆ° Order
        val itemsCount = order.items.size
        val itemNames = order.items.map(_.name).mkString(", ")
        complete(s"Ordered $itemsCount items: $itemNames")
      }
    }
  // format: ON
}</code><p><i><b>ç¾åŒ–è¾“å‡º</b></i></p><p>spray-json ä¼šé¢„è®¾æŠŠå¼€å‘è€…çš„ç±»å‹ç”¨ <u>CompactPrinter</u> è¿™ä¸ªéšå¼è½¬æ¢å·¥å…·ä»¥ç´§å‡‘å‹çš„æ ¼å¼è¾“å‡º JSON, å¦‚ä¸‹:</p><code lang="scala">implicit def sprayJsonMarshallerConverter[T](writer: RootJsonWriter[T])(implicit printer: JsonPrinter = CompactPrinter): ToEntityMarshaller[T] =
  sprayJsonMarshaller[T](writer, printer)</code><p>å¦‚æœå¼€å‘è€…éœ€è¦ç±»å‹ä»¥ç¾åŒ–å‹çš„æ ¼å¼è¾“å‡º JSONï¼Œå¯ä»¥å¼•å…¥ <u>PrettyPrinter</u> åˆ°å½“å‰å¯è§†åŸŸè¿›è¡Œéšå¼è½¬æ¢ã€‚</p><code lang="scala">import akka.http.scaladsl.marshallers.sprayjson.SprayJsonSupport._
import spray.json._

// é¢†åŸŸæ¨¡å‹
final case class PrettyPrintedItem(name: String, id: Long)

object PrettyJsonFormatSupport {
  import DefaultJsonProtocol._
  implicit val printer = PrettyPrinter
  implicit val prettyPrintedItemFormat = jsonFormat2(PrettyPrintedItem)
}

// å½“éœ€è¦ json ç¼–é›†ï¼åç¼–é›†æ—¶ä½¿ç”¨
class MyJsonService extends Directives {
  import PrettyJsonFormatSupport._

  // format: OFF
  val route =
    get {
      pathSingleSlash {
        complete {
          PrettyPrintedItem("akka", 42) // will render as JSON
        }
      }
    }
  // format: ON
}

val service = new MyJsonService

// ç¡®è®¤ JSON ä»¥ç¾åŒ–æ ¼å¼è¾“å‡º
Get("/") ~&gt; service.route ~&gt; check {
  responseAs[String] shouldEqual
    """{""" + "\n" +
    """  "name": "akka",""" + "\n" +
    """  "id": 42""" + "\n" +
    """}"""
}</code><p>ç›¸å…³ä¾‹å­è¯¦æƒ… å‚è€ƒ<a href="http://github.com/akka/akka-http/tree/master/docs/src/main/paradox/scala/http/common/json-support.md" data-title="é“¾æ¥" class="" data-editable="true">é“¾æ¥</a><br></p><p>æ›´å¤šå…³äº Spray-Json å¼€å‘çš„ <a href="https://github.com/spray/spray-json" data-editable="true" data-title="æ–‡æ¡£" class="">æ–‡æ¡£</a>.<br></p><p><i><b>Scala XML æ”¯æŒ</b></i></p><p><a href="http://github.com/akka/akka-http/tree/v10.0.3/akka-http-marshallers-scala/akka-http-xml/src/main/scala/akka/http/scaladsl/marshallers/xml/ScalaXmlSupport.scala" data-editable="true" data-title="ScalaXmlSupport" class="">ScalaXmlSupport</a> trait æä¾›äº†ä¸€ä¸ª FromEntityUnmarshaller[NodeSeq] å’Œ ToEntityMarshaller[NodeSeq] ä»¥ä¾¿å¼€å‘è€…ç›´æ¥ä½¿ç”¨æˆ–è€…äºŒæ¬¡å¼€å‘ç›¸å…³çš„ XML ç¼–é›†ï¼åç¼–é›†åŠŸèƒ½ã€‚</p><p>å¼€å‘è€…å¯ä»¥æŒ‰ç…§ä»¥ä¸‹çš„æ–¹å¼å¯ç”¨ <a href="https://github.com/scala/scala-xml" data-editable="true" data-title="Scala XML" class="">Scala XML</a><u>NodeSeq</u> æä¾›çš„ XML ç¼–é›†ï¼åç¼–é›†æ”¯æŒ</p><ol><li>æ·»åŠ ä¾èµ–åº“ "com.typesafe.akka" %% "akka-http-xml" % "1.x".<br></li><li>å¯¼å…¥ <u>akka.http.scaladsl.marshallers.xml.ScalaXmlSupport._</u> æˆ–è€…ç³…å…¥ <u>akka.http.scaladsl.marshallers.xml.ScalaXmlSupport</u> trait.<br></li></ol><br><p>å½“ä¸Šè¿°æ­¥éª¤å®Œæˆåï¼Œ å¼€å‘è€…åº”è¯¥å¯ä»¥æ— ç¼ä½¿ç”¨å®¢åˆ¶ç±»å‹ T ä¸ XML åŠ NodeSeq é—´çš„ ç¼–é›†å’Œåç¼–é›† è½¬æ¢ã€‚<br></p><p>ç›¸å…³ä¾‹å­è¯¦æƒ… å‚è€ƒ<a href="http://github.com/akka/akka-http/tree/master/docs/src/main/paradox/scala/http/common/xml-support.md" data-title="é“¾æ¥" class="" data-editable="true">é“¾æ¥</a></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
