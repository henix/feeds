<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>资源 | Pandas on Ray：仅需改动一行代码，即可让Pandas加速四倍</title>
</head>
<body>
<p><a href="https://mp.weixin.qq.com/s?timestamp=1522689258&amp;src=3&amp;ver=1&amp;signature=5-wKOuoHyR7tI9hkcQIVi3kCHApcf8GngAPwH1lsN60l4V*hF5xny5GJcS76-V444eD9tXGHcS6cJXCTU1RfGhjp2dfIDZo7-vLOyqN-OOWbdABdEwQthniBX8LTZm7X8B7wyRFVzzFog0kb60umOcwtW6kqwxTFDCT2a9CHZxo=">原文</a></p>
<div id="img-content">
                
                <h2 class="rich_media_title" id="activity-name">
                    资源 | Pandas on Ray：仅需改动一行代码，即可让Pandas加速四倍                                    </h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                            <em id="post-date" class="rich_media_meta rich_media_meta_text">2018-03-24</em>

                                        <a class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="##" id="post-user">机器之心</a>
                    <span class="rich_media_meta rich_media_meta_text rich_media_meta_nickname">机器之心</span>


                    <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                        <div class="profile_inner">
                            <strong class="profile_nickname">机器之心</strong>
                            <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                            <p class="profile_meta">
                            <label class="profile_meta_label">微信号</label>
                            <span class="profile_meta_value">almosthuman2014</span>
                            </p>

                            <p class="profile_meta">
                            <label class="profile_meta_label">功能介绍</label>
                            <span class="profile_meta_value">专业的人工智能媒体和产业服务平台</span>
                            </p>
                            
                        </div>
                        <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                            <i class="profile_arrow arrow_out"></i>
                            <i class="profile_arrow arrow_in"></i>
                        </span>
                    </div>
                </div>
                
                
                
                
                                                
                                                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <section style="max-width: 100%;white-space: normal;background-color: rgb(255, 255, 255);line-height: 28.4444px;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section data-id="85660" data-custom="rgb(117, 117, 118)" data-color="rgb(117, 117, 118)" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section data-id="85660" data-custom="rgb(117, 117, 118)" data-color="rgb(117, 117, 118)" style="max-width: 100%;border-width: 0px;border-style: initial;border-color: currentcolor;font-family: 微软雅黑;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="margin-top: 2em;padding-top: 0.5em;padding-bottom: 0.5em;max-width: 100%;border-style: solid none;font-family: inherit;text-decoration: inherit;border-top-color: rgb(204, 204, 204);border-bottom-color: rgb(204, 204, 204);border-top-width: 1px;border-bottom-width: 1px;box-sizing: border-box !important;word-wrap: break-word !important;"><p style="color: rgb(62, 62, 62);font-size: 16px;margin-top: -1.2em;max-width: 100%;min-height: 1em;text-align: center;line-height: 1.75em;border-width: initial;border-style: initial;border-color: currentcolor;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(255, 255, 255);background-color: rgb(117, 117, 118);box-sizing: border-box !important;word-wrap: break-word !important;">选自UC Berkeley Rise Lab</span></p><section data-style="white-space: normal; text-align: left;font-size: 14px;line-height: 1.5em; color: rgb(12, 12, 12);" style="padding: 16px 16px 10px;max-width: 100%;font-family: inherit;box-sizing: border-box !important;word-wrap: break-word !important;"><p style="color: rgb(62, 62, 62);font-size: 16px;max-width: 100%;min-height: 1em;text-align: center;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 12px;color: rgb(136, 136, 136);box-sizing: border-box !important;word-wrap: break-word !important;">作者：Devin Petersohn</span></strong></p><p style="color: rgb(62, 62, 62);font-size: 16px;max-width: 100%;min-height: 1em;text-align: center;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 12px;color: rgb(136, 136, 136);box-sizing: border-box !important;word-wrap: break-word !important;">机器之心编译</span></strong></p><p style="max-width: 100%;min-height: 1em;text-align: center;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="color:#888888;"><span style="font-size: 12px;"><strong>参与：Nurhachu Null、路雪</strong></span></span></p></section></section></section></section></section></section></section></section></section></section></section></section><p style="max-width: 100%;min-height: 1em;text-align: justify;line-height: 1.75em;box-sizing: border-box !important;word-wrap: break-word !important;"><br></p><blockquote><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;color: rgb(136, 136, 136);">本文中，来自 UC Berkeley 的 Devin Petersohn 发布文章介绍了其参与的项目 Pandas on Ray，使用这款工具，无需对代码进行太多改动即可加速 Pandas，遇到大型数据集也不怕。作者还对 Pandas on Ray、Pandas 进行了对比评估。机器之心对此文进行了编译介绍。</span></p></blockquote><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;color: rgb(123, 12, 0);">项目链接：https://github.com/ray-project/ray</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">最近，我和一位使用 100 多 TB 生物数据的朋友讨论了数据科学库的一些局限性。当面临这种规模的数据时，Pandas 成了最受喜爱的工具；然而，当你开始处理 TB 级别的基因数据时，单核运行的 Pandas 就会变得捉襟见肘。如果我们拥有更多的处理器核，或者要打开数十 TB 规模的文件时，我们希望 Pandas 运行得更快。目前，Apache Spark 是最高性能的分布式选择了，但是如果未对 Pandas 代码做出足够多的修改，你无法使用 Apache Spark 运行 Pandas 代码。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">大规模数据科学任务向来都是丢给分布式计算专家来做的，或者至少是熟悉此类概念的人员。大多数分布式系统的设计者给用户提供了调节「旋钮」，并留下了大量的系统配置。因此，高系统性能需要用明显更加陡峭的学习曲线来折中。大多数现有用户可能只是想让 Pandas 运行得更快，并不希望在特定的硬件环境中优化他们的工作流。在我的案例中，我想在 10KB 和 10TB 的数据上使用相同的 Pandas 脚本，并且希望 Pandas 在处理这两种不同量级的数据时速度一样快（如果我有足够的硬件资源的话）。为了完成这些目标，我们开启了一个 Pandas on Ray 项目。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我们对系统进行了初步测评，Pandas on Ray 可以在一台 8 核的机器上将 Pandas 的查询速度提高了四倍，而这仅需用户在 notebooks 中修改一行代码。我们为现在的 Pandas 用户设计了该系统，旨在帮助他们的程序运行得更快，并且无需大量代码改动就能够进行更好的扩展。这项工作的最终目标就是在云环境中使用 Pandas。</span></p><p><br></p><p style="text-align: center;line-height: 1.75em;"><strong><span style="font-size: 16px;">简介</span></strong></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Pandas on Ray 是 DataFrame 库的早期阶段，DataFrame 库封装了 Pandas，并且透明地分配数据和计算。使用 Pandas on Ray，用户不需要知道他们的系统或集群有多少个核心，也不需要指定如何分配数据。事实上，在 Pandas on Ray 上体验可观的加速时，用户可以继续使用之前的 Pandas notebook，甚至是在同一台机器上。仅仅需要按照下面描述的修改 import 语句。一旦修改了 import 语句，你就可以像使用 Pandas 一样使用 Pandas on Ray 了。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Pandas on Ray 主要针对的是希望在不切换 API 的情况下提高性能和运行速度的 Pandas 用户。我们正在积极实现与 Pandas 所有 API 的对等功能，并且已经实现了 API 的一个子集。我们会介绍目前进展的一些细节，并且给出一些使用示例。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><strong><span style="font-size: 14px;">使用的数据集</span></strong></p><p><br></p><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">标普 500 股市数据：29.6MB（https://www.kaggle.com/camnugent/sandp500/data）</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><strong><span style="font-size: 14px;">导入 Pandas on Ray</span></strong></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># import pandas as pd</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">import</span><span class="pln" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> ray.dataframe </span><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">as</span><span class="pln" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> pd</span></code></span></p></li></ol></pre><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Waiting for redis server at 127.0.0.1:21844 to respond...</span></p><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">Waiting for redis server at 127.0.0.1:41713 to respond...</span></p><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">Starting local scheduler with the following resources: {'GPU': 0, 'CPU': 8}.</span></p><p><br></p><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">======================================================================</span></p><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">View the web UI at http://localhost:8890/notebooks/ray_ui62630.ipynb?token=bcf6d5b6cb9c2c478207f025384869100d7a25dcc27d7a56</span></p><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">======================================================================</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Ray 将根据可用内核的数量进行自动初始化。现在你可以开始运行 Pandas 命令，它们将被并行化。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pln" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">stocks_df = pd.read_csv(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"all_stocks_5yr.csv"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(type(stocks_df))</span></code></span></p></li></ol></pre><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我们也可以开始检查数据。让我们来看一下坐标轴。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(stocks_df.axes)</span></code></span></p></li></ol></pre><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">[RangeIndex(start=0, stop=619040, step=1), Index(['date', 'open', 'high', 'low', 'close', 'volume', 'Name'], dtype='object')]</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">让我们运行一个简单的数据查询（just for fun），看看有多少天是以正收益结束的。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pln" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">positive_stocks_df = stocks_df.query(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"close &gt; open"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(positive_stocks_df[</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">'date'</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">].head(n=</span><span class="lit" style="box-sizing: border-box;color: rgb(223, 83, 32);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">10</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">))</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"\nNumber of positive days:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">, positive_stocks_df.size)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"\nRatio of positive days to total days:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">, positive_stocks_df.size/stocks_df.size)</span></code></span></p></li></ol></pre><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">0 2013-02-13</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">1 2013-02-15</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">2 2013-02-26</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">3 2013-02-27</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">4 2013-03-01</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">5 2013-03-04</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">6 2013-03-05</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">7 2013-03-06</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">8 2013-03-07</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">9 2013-03-11</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Name: date, dtype: object</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Number of positive days: 2232790</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Ratio of positive days to total days: 0.5152655724993538</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我不喜欢使用默认索引，那么让我们来看一下「date」是不是一个好的索引。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(stocks_df[</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">'date'</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">].head(n=</span><span class="lit" style="box-sizing: border-box;color: rgb(223, 83, 32);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">10</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">))</span></code></span></p></li></ol></pre><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">0 2013-02-08</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">1 2013-02-11</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">2 2013-02-12</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">3 2013-02-13</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">4 2013-02-14</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">5 2013-02-15</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">6 2013-02-19</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">7 2013-02-20</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">8 2013-02-21</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">9 2013-02-22</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Name: date, dtype: object</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">看上去是个正确的选择，因为我可能希望基于日期查询。让我们修改一下 DataFrame 中的索引，以便设置基于日期的查询。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pln" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">stocks_df.set_index(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">'date'</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">, inplace=</span><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">True</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(stocks_df.axes)</span></code></span></p></li></ol></pre><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">[Index(['2013-02-08', '2013-02-11', '2013-02-12', '2013-02-13', '2013-02-14',</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;"> '2013-02-15', '2013-02-19', '2013-02-20', '2013-02-21', '2013-02-22',</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;"> ...</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;"> '2018-01-25', '2018-01-26', '2018-01-29', '2018-01-30', '2018-01-31',</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;"> '2018-02-01', '2018-02-02', '2018-02-05', '2018-02-06', '2018-02-07'],</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;"> dtype='object', name='date', length=619040), Index(['open', 'high', 'low', 'close', 'volume', 'Name'], dtype='object')]</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我们可以查询数据来收集更多的信息。我们可以找到股票收益为正的日期。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">这个小例子旨在演示一些 Pandas 操作，这些操作作为并行实现可在 Pandas on Ray 上找到。下面，我们会展示一些性能对比，以及我们可以利用机器上更多的资源来实现更快的运行速度，甚至是在很小的数据集上。</span></p><p><br></p><p style="text-align: center;line-height: 1.75em;"><span style="font-size: 16px;"><strong>转置</strong></span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">分布式转置是 DataFrame 操作所需的更复杂的功能之一。在以后的博客中，我们将讨论我们的实现和一些优化。目前，转置功能相对粗糙，也不是特别快，但是我们可以实现一些简单优化来获得更好的性能。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(stocks_df.T[:])</span></code></span></p></li></ol></pre><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">date   2013-02-08 2013-02-11 2013-02-12 2013-02-13 2013-02-14 2013-02-15  \</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">open        15.07      14.89      14.45       14.3      14.94      13.93   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">high        15.12      15.01      14.51      14.94      14.96      14.61   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">low         14.63      14.26       14.1      14.25      13.16      13.93   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">close       14.75      14.46      14.27      14.66      13.99       14.5   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">volume    8407500    8882000    8126000   10259500   31879900   15628000   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Name          AAL        AAL        AAL        AAL        AAL        AAL   </span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">date   2013-02-19 2013-02-20 2013-02-21 2013-02-22    ...     2018-01-25  \</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">open        14.33      14.17      13.62      13.57    ...          78.47   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">high        14.56      14.26      13.95       13.6    ...          79.38   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">low         14.08      13.15       12.9      13.21    ...         78.345   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">close       14.26      13.33      13.37      13.57    ...          79.25   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">volume   11354400   14725200   11922100    6071400    ...        2327262   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Name          AAL        AAL        AAL        AAL    ...            ZTS   </span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">date   2018-01-26 2018-01-29 2018-01-30 2018-01-31 2018-02-01 2018-02-02  \</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">open        79.49      79.81      78.44      78.49      76.84      77.53   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">high        80.13      79.95      78.69      78.77      78.27      78.12   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">low         79.38      79.11      77.91      76.54      76.69      76.73   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">close       80.09      79.18      78.35      76.73      77.82      76.78   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">volume    2532808    2662383    3808707    4136360    2982259    2595187   </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Name          ZTS        ZTS        ZTS        ZTS        ZTS        ZTS   </span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">date   2018-02-05 2018-02-06 2018-02-07  </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">open        76.64      72.74       72.7  </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">high        76.92      74.56         75  </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">low         73.18      72.13      72.69  </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">close       73.83      73.27      73.86  </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">volume    2962031    4924323    4534912  </span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Name          ZTS        ZTS        ZTS  </span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">[6 rows x 619040 columns]</span></p><p><br></p><p style="text-align: center;line-height: 1.75em;"><span style="font-size: 16px;"><strong>基准测试</strong></span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">接下来，我们要比较一下 Pandas 和 Ray on Pandas。尽管我们目前还没有支持完整的 Pandas 功能 API，但是我们展示了一些初步的基准测试，证明我们的方法是有潜力的。我们会在以下对比中做到尽可能的公平。需要注意的是，我们没有在 Pandas on Ray 上做任何特殊的优化，一切都使用默认设置。还需要注意的是，Ray 使用了 eager execution，因此我们无法进行任何查询规划，也无法掌握计算给定工作流的最佳方法。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><strong><span style="font-size: 14px;">所用的数据集</span></strong></p><p><br></p><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">全球健康数据：1.79GB（https://www.kaggle.com/census/international-data/data）</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># we are importing Pandas to benchmark against it</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">import</span><span class="pln" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> pandas </span><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">as</span><span class="pln" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"> old_pd</span></code></span></p></li></ol></pre><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">首先我们要检查加载一个 CSV 文件所需的时间。这个文件相对较大（1.7GB），所以使用 Pandas 和使用 Pandas on Ray 的加载时间会有所不同。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># Pandas on Ray</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"Pandas on Ray:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">%time pandas_on_ray = pd.read_csv(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"midyear_population_age_country_code.csv"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># Pandas</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"\nPandas:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">%time pandas_native = old_pd.read_csv(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"midyear_population_age_country_code.csv"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li></ol></pre><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Pandas on Ray:</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">CPU times: user 48.5 ms, sys: 19.1 ms, total: 67.6 ms</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Wall time: 68 ms</span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Pandas:</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">CPU times: user 49.3 s, sys: 4.09 s, total: 53.4 s</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Wall time: 54.3 s</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我们看到的结果是：Pandas on Ray 的加载速度大约是 Pandas 的 675 倍。尽管这些数字令人印象深刻，但是 Pandas on Ray 的很多实现将工作从主线程转移到更异步的线程。文件是并行读取的，运行时间的很多改进可以通过异步构建 DataFrame 组件来解释。让我们将所有线程的结果汇总到一起，看看它需要多长时间。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># Pandas on Ray</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"Pandas on Ray:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">%time entire_df = pandas_on_ray[:]</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># Pandas</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"\nPandas:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">%time entire_df = pandas_native[:]</span></code></span></p></li></ol></pre><p><br></p><p><span style="font-size: 14px;">Pandas on Ray:</span></p><p><span style="font-size: 14px;">CPU times: user 2.59 s, sys: 2.52 s, total: 5.11 s</span></p><p><span style="font-size: 14px;">Wall time: 9.09 s</span></p><p><br></p><p><span style="font-size: 14px;">Pandas:</span></p><p><span style="font-size: 14px;">CPU times: user 16 ms, sys: 240 ms, total: 257 ms</span></p><p><span style="font-size: 14px;">Wall time: 256 ms</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">这里我们可以看到，如果我们使用 [:] 运算符将所有的数据收集到一起，Pandas on Ray 速度大约是之前的 1/36。这是因为并行化。所有的线程以并行的方式读取文件，然后将读取结果串行化。主线程又对这些值进行去串行化，这样它们又变得可用了，所以（去）串行化就是我们在这里看到的主要开销。熟悉 Spark 的人可能会记得，这类似于一个.collect() 调用。它使任务不再并行执行，将它们转移动单独的线程中。所以，尽管它读取文件更快，但是将这些片段重新组合在一起的开销意味着 Pandas on Ray 应该不仅仅被用于文件读取。让我们看一下文件加载完成后索引会发生什么。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># Pandas on Ray</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"Pandas on Ray:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">%time pandas_on_ray.index</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"\nPandas:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># Pandas</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">%time pandas_native.index</span></code></span></p></li></ol></pre><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Pandas on Ray:</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">CPU times: user 12 µs, sys: 1 µs, total: 13 µs</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Wall time: 16 µs</span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Pandas:</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">CPU times: user 4 µs, sys: 0 ns, total: 4 µs</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Wall time: 7.15 µs</span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">RangeIndex(start=0, stop=3058280, step=1)</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">请注意，两种方法都在缓存.index 调用的结果，所以我们调用一次 .index 之后看到的是原始时间，再一次调用的时候看到的是缓存访问时间。Pandas on Ray 大约慢了 10 µs，但是维持一个分布式索引的复杂度更高。这显示了底层 Ray 基础架构的效率，它能够快速检索数据。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">现在让我们尝试加速一次示例查询，看看 Pandas 和 Pandas on Ray 的性能对比。</span></p><p><br></p><pre class="prettyprint linenums prettyprinted" style="box-sizing: border-box;margin-top: 0px;margin-bottom: 0px;padding: 8px 0px 6px;background-color: rgb(241, 239, 238);border-radius: 0px;overflow-y: auto;color: rgb(80, 97, 109);font-size: 10px;line-height: 12px;"><ol class="linenums list-paddingleft-2" style="list-style-type: none;"><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># Pandas on Ray</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"Pandas on Ray:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">%timeit q0 = pandas_on_ray.query(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">'max_age &gt; 100'</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="com" style="box-sizing: border-box;color: rgb(156, 148, 145);line-height: 20px;font-size: 13px !important;white-space: inherit !important;"># Pandas</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="kwd" style="box-sizing: border-box;color: rgb(102, 102, 234);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">print</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">"\nPandas:"</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li><li><p><span style="box-sizing: border-box;color: rgb(74, 74, 74);display: block;line-height: 22px;font-size: 14px !important;word-break: inherit !important;"><code class="python language-python" style="box-sizing: border-box;margin-left: -20px;display: flex;overflow: initial;line-height: 12px;word-wrap: normal;border-width: 0px;border-style: initial;border-color: initial;font-size: 10px;font-family: inherit !important;white-space: pre !important;"><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">%timeit q1 = pandas_native.query(</span><span class="str" style="box-sizing: border-box;color: rgb(123, 151, 38);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">'max_age &gt; 100'</span><span class="pun" style="box-sizing: border-box;color: rgb(27, 25, 24);line-height: 20px;font-size: 13px !important;white-space: inherit !important;">)</span></code></span></p></li></ol></pre><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Pandas on Ray:</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">100 loops, best of 3: 4.14 ms per loop</span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">Pandas:</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">The slowest run took 32.21 times longer than the fastest. This could mean that an intermediate result is being cached.</span></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">1 loop, best of 3: 17.3 ms per loop</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">在这次 timeit 调用中，我们看到 Pandas on Ray 的速度大约是 Pandas 的 4 倍。这是在一台 8 核的机器上运行的，由于开销的因素，加速并不是特别完美。尽管如此，通过仅仅修改 import 语句，原始 Pandas 上的运行时间和 Pandas on Ray 上的运行时间还是有显著差别的。</span></p><p><br></p><p style="text-align: center;line-height: 1.75em;"><span style="font-size: 16px;"><strong>在 Dask 上进行实验</strong></span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">DataFrame 库 Dask 提供可在其并行处理框架上运行的分布式 DataFrame，Dask 还实现了 Pandas API 的一个子集。一般来说，目前 Dask 在绝大多数操作上都比 Pandas on Ray 快一些。Dask 为 Pandas 用户提供精细调整的定制，而 Pandas on Ray 则提供一种以最少的工作量实现更快性能的方法，且不需要多少分布式计算的专业知识。Pandas on Ray 针对的不是目前的 Dask（或 Spark）用户，而是希望在无需学习新 API 的情况下提升现有和未来工作负载的性能和可扩展性的 Pandas 用户。在 columnar operation 上，Dask 比 Pandas on Ray 快，但是它需要一些超出传统 Pandas 之外的知识。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Dask 中存在两个主要的差别，而 Pandas on Ray 则尝试解决这两个差别：</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">1. 用户需要一直意识到：数据是分布式的，计算是懒惰的。</span></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">2. 多线程和多进程之间的权衡是可扩展性和性能之间的权衡。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><strong><span style="font-size: 14px;">数据科学家应该用 DataFrame 来思考，而不是动态的任务图</span></strong></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Dask 用户一直这样问自己：</span></p><p><br></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我什么时候应该通过 .compute() 触发计算，我什么时候应该调用一种方法来创建动态任务图？</span></p></li><li><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我什么时候应该调用 .persist() 将 DataFrame 保存在内存中？</span></p></li><li><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">这个调用在 Dask 的分布式数据帧中是不是有效的？</span></p></li><li><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我什么时候应该重新分割数据帧？</span></p></li><li><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">这个调用返回的是 Dask 数据帧还是 Pandas 数据帧？</span></p></li></ul><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">使用 Pandas 的数据科学家不一定非得是分布式计算专家，才能对数据进行高效分析。Dask 要求用户不断了解为计算而构建的动态任务图。此外，默认情况下，懒惰计算使每个熟悉的 Pandas 调用返回一个意外的结果。这些差异为 Dask 提供了更好的性能配置，但对于某些用户来说，学习新 API 的开销太高。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">使用 Pandas on Ray 的时候，用户看到的数据帧就像他们在看 Pandas 数据帧一样。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><strong><span style="font-size: 14px;">我们要速度，也要扩展性</span></strong></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Dask 默认是以多线程的模式运行的，这意味着一个 Dask 数据帧的所有分割部分都在一个单独的 Python 进程中。尽管多线程模式让一些计算变得更快，但是一个单独的 Python 进程并不能利用机器的多个核心。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">或者，Dask 数据帧可以以多进程模式运行，这种模式能够生成多个 Python 进程。然而，如果一个 Python 进程需要将一个小的 Pandas 数据帧发送到另一个进程，则该数据帧必须通过 Pickle 进行串行化处理，然后在另一个进程中进行去串行化处理，因为这两个进程没有共享内存。串行化、拷贝以及去串行化，这三步会带来高性能损失。即使这个解决方案可以扩展到多个核心，但是高昂的通信成本会对整体性能造成影响。</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/KmXPKA19gWicIrdDjmMc759A0JbY5SCZP7icOpQb4ibrNYPUbfTL2FHfecrvNm7icskIRAjLMnT1RsMPfWjUpwicMyA/640?wx_fmt=png" data-type="png" style="" data-ratio="0.8363136176066025" data-w="727"></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">如上图所示，由于串行化和拷贝操作，Dask 的多进程模式损伤了 read_csv 操作的性能。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">Pandas on Ray 既可以以多线程模式运行，也可以以多进程模式运行。Ray 的默认模式是多进程，因此它可以从一台本地机器的多个核心扩展到一个机器集群上。至于通信方面，Ray 使用共享内存，并且通过 Apache Arrow 实现零拷贝串行化，显著降低了进程之间的通信代价。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">使用 Pandas on Ray，你的 Pandas 工作流可以同时实现快速运行和可扩展性。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><strong><span style="font-size: 14px;">read_csv 案例研究</span></strong></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">在 AWS m5.2x 大型实例（8 个虚拟核、32GB 内存）上，我们使用 Pandas、Ray 和 Dask（多线程模式）进行了 read_csv 实验。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我们采用了从 60KB 到 2GB 大小不等的四个数据集：</span></p><p><br></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">泰坦尼克数据集：60KB（https://www.kaggle.com/c/titanic/data）</span></p></li><li><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">Yelp 数据集：31MB（https://www.kaggle.com/c/titanic/data）</span></p></li><li><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">Kiva Loan 数据集：187MB（https://www.kaggle.com/kiva/data-science-for-good-kiva-crowdfunding/data）</span></p></li><li><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">NYC Parking Tickets 数据集：2GB（https://www.kaggle.com/new-york-city/nyc-parking-tickets/data）</span></p></li></ul><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">结果显示 Ray 的性能是快速且可扩展的，在多个数据集上都优于 Dask。</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.8328125" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/KmXPKA19gWicIrdDjmMc759A0JbY5SCZP9oeS5Wgn5DqYPSkEhh5a7qkhRRBHvPLI4n54fGdgbjQgacN9ZYdSqA/640?wx_fmt=png" data-type="png" data-w="1280" style=""></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">注：第一个图表明，在像泰坦尼克数据集这样的小数据集上，分发数据会损害性能，因为并行化的开销很大。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><strong><span style="font-size: 14px;">MAX 案例研究</span></strong></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">为了查看逐行操作和逐列操作时三者的对比结果，我们继续在相同的环境中进行实验。</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.66640625" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/KmXPKA19gWicIrdDjmMc759A0JbY5SCZPVljWEAMbukeV0bmich5agQaExwKZb37uPejGv9gbQOwQR8qhjC2rsIQ/640?wx_fmt=png" data-type="png" data-w="1280" style=""></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">除了在最小的文件上 Pandas 是最快的以外，Pandas on Ray 的逐行操作速度大约是 Pandas 和 Dask 的三倍。在逐列操作上，它大约慢了 2.5 倍，这是因为目前的 Pandas on Ray 实现尚未针对 columnar operation 进行优化。值得注意的是，Dask 的惰性计算和查询执行规划不能在单个操作中使用。</span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">通常情况下，Pandas on Ray 是异步运行的，但是出于实验目的，我们强制执行同步，以便对 Pandas 和 Dask 进行正确的评估。</span></p><p><br></p><p style="text-align: center;line-height: 1.75em;"><span style="font-size: 16px;"><strong>结论</strong></span></p><p><br></p><p style="text-align: justify;line-height: 1.75em;"><span style="font-size: 14px;">我们已经开始构建 Pandas on Ray，这是一个仅更改 import 语句就可以使 Pandas 工作流并行化的库。到今天为止，我们已经在大约 45 天内实现了 Pandas DataFrame API 的 25%。目前，我们仅在单个节点上加速 Pandas，但很快我们将具备在集群环境中运行 Pandas 的功能。</span></p><p><br></p><p style="text-align: left;line-height: 1.75em;"><span style="font-size: 14px;">如果您想试用 Pandas on Ray，请按照 readthedocs 文档说明（http://ray.readthedocs.io/）从源代码开始构建。此处使用的代码目前位于 Ray 的主分支上，但尚未将其转换为发布版本。 <img class="" data-copyright="0" data-ratio="0.3287671232876712" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/KmXPKA19gW8Zfpicd40EribGuaFicDBCRH6IOu1Rnc4T3W3J1wE0j6kQ6GorRSgicib0fmNrj3yzlokup2jia9Z0YVeA/640?wx_fmt=png" data-type="png" data-w="73" style="color: rgb(62, 62, 62);text-align: justify;white-space: normal;background-color: rgb(255, 255, 255);font-size: 16px;box-sizing: border-box !important;word-wrap: break-word !important;visibility: visible !important;width: 44px !important;" width="44px"></span></p><p><br></p><p style="line-height: 1.75em;"><span style="color: rgb(136, 136, 136);"><em><span style="font-size: 12px;">原文链接：https://rise.cs.berkeley.edu/blog/pandas-on-ray/</span></em></span></p><p><br></p><p><br></p><p style="margin-bottom: 20px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);line-height: 1.75em;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;text-align: justify;line-height: 25.6px;font-family: 微软雅黑;font-size: 14px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(127, 127, 127);box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;color: rgb(62, 62, 62);line-height: 25.6px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(127, 127, 127);box-sizing: border-box !important;word-wrap: break-word !important;">本文为机器之心编译，<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">转载请联系本公众号获得授权</span></strong></span></strong>。</span></strong></p><p style="margin-bottom: 5px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);white-space: normal;background-color: rgb(255, 255, 255);font-size: 18px;line-height: 1.75em;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(127, 127, 127);line-height: 25.6px;font-family: 微软雅黑;text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;">✄------------------------------------------------</span></p><p style="margin-bottom: 5px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);white-space: normal;background-color: rgb(255, 255, 255);font-size: 18px;font-family: 微软雅黑;text-align: center;line-height: 1.75em;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(217, 33, 66);font-size: 12px;box-sizing: border-box !important;word-wrap: break-word !important;">加入机器之心（全职记者/实习生）：hr@jiqizhixin.com</span></strong></p><p style="max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);white-space: normal;background-color: rgb(255, 255, 255);font-size: 18px;font-family: 微软雅黑;text-align: center;line-height: 1.75em;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(217, 33, 66);line-height: 1.6;font-size: 12px;box-sizing: border-box !important;word-wrap: break-word !important;">投稿或寻求报道：editor@jiqizhixin.com</span></strong></p><p style="max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);white-space: normal;background-color: rgb(255, 255, 255);font-size: 18px;font-family: 微软雅黑;text-align: center;line-height: 1.75em;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 12px;color: rgb(217, 33, 66);line-height: 1.6;box-sizing: border-box !important;word-wrap: break-word !important;">广告&amp;商务合作：bd@jiqizhixin.com</span></strong></p>
                </div>
                <script nonce="1287163755" type="text/javascript">
                    var first_sceen__time = (+new Date());

                    if ("" == 1 && document.getElementById('js_content')) {
                        document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });
                    }

                    
                    (function(){
                        if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                            var link = document.createElement('link');
                            var head = document.getElementsByTagName('head')[0];
                            link.rel = 'stylesheet';
                            link.type = 'text/css';
                            link.href = "//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_winwx31619e.css";
                            head.appendChild(link);
                        }
                    })();
                </script>
                
                
                                
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display:none;"></div>

                
                                <div class="reward_area tc" id="js_preview_reward" style="display:none;">
                    <p id="js_preview_reward_wording" class="tips_global reward_tips" style="display:none;"></p>
                    <p>
                        <a class="reward_access" id="js_preview_reward_link" href="##"><span class="icon-reward"></span>赞赏</a>

                    </p>
                </div>
                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="//res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x3534dd.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div><div class="rich_media_tool" id="js_toobar3">
                
                                
                                            <div id="js_read_area3" class="media_tool_meta tips_global meta_primary" style="display:none;">阅读 <span id="readNum3"></span></div>

                <span style="display:none;" class="media_tool_meta meta_primary tips_global meta_praise" id="like3">
                    <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum3"></span>
                </span>

                <a id="js_report_article3" style="display:none;" class="media_tool_meta tips_global meta_extra" href="##">投诉</a>

            </div><div class="rich_media_tool" id="js_sg_bar">
                
                                
                                
            </div>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
