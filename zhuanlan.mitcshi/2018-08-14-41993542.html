<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>为什么要进行因子正交化处理？</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/41993542">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-ffeb3a745e02996636484b501d9b0604_r.jpg" alt=""></div><h2><b>摘要</b></h2><p>选股多因子模型中常进行因子正交化处理。如果因子之间不满足正交性，则它们会相互影响各自的回归系数，这可能造成回归系数过大的估计误差，对因子的评价产生负面影响。</p><h2><b>1 多因子模型求解</b></h2><p>在选股多因子模型中，人们常提到的一个概念是<b>因子正交化处理</b>。本文就从多因子截面回归求解的角度来简单说说为什么我们喜欢相互正交的因子，以及如果因子之间不正交对回归系数会有什么影响。</p><p>一个多因子模型可以写成如下的形式：</p><p><equation>\mathbf y=\mathbf X\mathbf b+\mathbf ε</equation> </p><p>其中 <equation>\mathbf y</equation> 是 <equation>N × 1</equation> 阶股票下一期的收益率向量， <equation>\mathbf X</equation> 为 <equation>N × K</equation> 阶当期的因子暴露矩阵， <equation>\mathbf b</equation> 为 <equation>K × 1</equation> 阶待通过回归求解得到的因子收益率向量， <equation>\mathbf ε</equation>  为 <equation>N × 1</equation> 阶残差向量。假设  <equation>\mathbf X</equation> 满足列满秩，则上述模型的 OLS（ordinary least squares）回归求解为：</p><p><equation>\mathbf b=\left(\mathbf X^T\mathbf X\right)^{-1}\mathbf{X}^T\mathbf y</equation> </p><p>需要注意的是，在上面这个模型以及  <equation>\mathbf b</equation>  的表达式中，<b>因子向量 </b><equation>\mathbf X</equation><b> 已经包括了所有的 regressors，因此回归模型右侧没有额外的截距项</b>。这意味着，如果我们假设截距项也是一个因子，则它对应的 <equation>N × 1</equation> 阶向量 <equation>[1,1,…,1]^T</equation> 已经作为  <equation>\mathbf X</equation>  的某一列（通常是第一列）存在于  <equation>\mathbf X</equation>  之中了；如果我们假设截距项不是一个因子，则  <equation>\mathbf X</equation>  中没有 <equation>[1,1,…,1]^T</equation> 这一列。</p><p>在 Barra 的多因子模型 CNE5 中考虑了国家因子，所有个股在该因子上的暴露都是 1，因此它的作用就相当于一个截距因子； <equation>[1,1,…,1]^T</equation> 这个向量在 Barra 模型中正是  <equation>\mathbf X</equation>  的第一列。另外，对于我们最熟悉的 simple regression model，它的右侧只有一个截距和一个解释变量：</p><p><equation>y_i=a+bx_i+\varepsilon_i</equation> </p><p>按照上述说明，该模型对应的矩阵  <equation>\mathbf X</equation>  包括两列：一列对应截距，一列对应真正的解释变量  <equation>\mathbf x</equation> ：</p><p><equation>\mathbf X=\left[ \begin{array}{cc} 1&amp;x_1\\ 1&amp;x_2\\ \vdots&amp;\vdots\\ 1&amp;x_N \end{array} \right] </equation> </p><p>从  <equation>\mathbf b</equation>  的表达式来看，它和 <equation>\mathbf X^T\mathbf X</equation> 有关。<b>当 </b><equation>\mathbf X</equation><b> 的各列（即回归模型中的不同解释变量，或我们研究问题中的不同因子暴露向量）之间不正交时，则在计算</b> <equation>\mathbf X^T\mathbf X</equation><b> 乃至最终的 </b><equation>\mathbf b</equation><b> 时，</b> <equation>\mathbf X</equation> <b> 不同列之间是相互影响的，而这种影响不是什么好事儿。</b></p><h2><b>2 简单一元回归</b></h2><p>让我们从最简单的一元回归（simple univariate regression）说起。</p><p>假设有一元回归模型 <equation>\mathbf y = b\mathbf x + \mathbf ε</equation> （模型右侧只有一个解释变量，<b>没有截距项</b>）。对于两个同阶向量 <equation>\mathbf m</equation> 和  <equation>\mathbf n</equation> ，令 <equation>\langle\mathbf m, \mathbf n\rangle</equation> 表示它们的內积，即 <equation>\langle\mathbf m, \mathbf n\rangle=\sum m_in_i</equation> ，则该一元回归模型的 OLS 解为（求解对象就是标量  <equation>b</equation> ）：</p><p><equation>\displaystyle b=\frac{\langle\mathbf x,\mathbf y\rangle}{\langle\mathbf x,\mathbf x\rangle}</equation> </p><p>这个结论非常简单，但是它十分重要。在上一节中，我们给出了多元回归 OLS 求解的表达式：</p><p><equation>\mathbf b=\left(\mathbf X^T\mathbf X\right)^{-1}\mathbf{X}^T\mathbf y</equation> </p><p>比较一元回归模型的标量  <equation>b</equation>  和多元回归模型的向量  <equation>\mathbf b</equation>  不难发现如下现象：在多元回归模型中，如果所有的解释变量两两正交，即 <equation>\langle\mathbf x_i, \mathbf x_j\rangle=0,i\ne j</equation> ，则向量  <equation>\mathbf b</equation>  中的每一个系数  <equation>b_i</equation>  恰恰等于：</p><p><equation>\displaystyle b_i=\frac{\langle\mathbf x_i,\mathbf y\rangle}{\langle\mathbf x_i,\mathbf x_i\rangle}</equation> </p><p>这是因为 <equation>\langle\mathbf x_i, \mathbf x_j\rangle=0</equation> 保证了 <equation>\mathbf X^T\mathbf X</equation> 的所有非对角元素都是 0，因此它是一个对角阵。对角阵的逆矩阵就是把该对角阵对角线上的元素都取倒数，所以逆矩阵仍然是对角阵。因此， <equation>\mathbf X^T\mathbf X</equation>  的第 <equation>i</equation> 个对角元素为 <equation>1/\langle\mathbf x_i, \mathbf x_i\rangle</equation> 。另一方面， <equation>\mathbf X^T\mathbf y</equation> 是一个 <equation>K × 1</equation> 向量，它的第 <equation>i</equation> 个元素是 <equation>\mathbf x_i</equation> <equation>\mathbf y</equation> 和 <b>y</b> 的內积，即 <equation>\langle\mathbf x_i, \mathbf y\rangle</equation> 。最终，多元回归的 <equation>b_i</equation> 正是 <equation>\langle\mathbf x_i, \mathbf y\rangle/\langle\mathbf x_i, \mathbf x_i\rangle</equation> 。</p><p>怎么样？ <equation>b_i</equation> 和一元回归中的 <equation>b</equation> 的表达式一模一样，说明<b>当所有解释变量相互正交时，不同的因子（即 </b><equation>\mathbf x_i</equation> <b>）对彼此的参数估计（即</b> <equation>b_i</equation> <b>，因子收益率）没有任何影响。</b>这便是正交的好处。</p><p>那么，当因子（解释变量）之间不正交时又会怎样呢？为了回答这个问题，我们首先来看看回归的几何意义。</p><h2><b>3 回归的几何意义</b></h2><p>将  <equation>\mathbf b</equation>  的表达式代入回归模型得到  <equation>\mathbf ε</equation>  的表达式，并计算  <equation>\mathbf X</equation>  和  <equation>\mathbf ε</equation>  的內积有；</p><p><equation>\begin{array}{rll} \mathbf X^T\mathbf\varepsilon&amp;=&amp;\mathbf X^T(\mathbf y-\mathbf X\mathbf b)\\ &amp;=&amp;\mathbf X^T(\mathbf y-\mathbf X\left(\mathbf X^T\mathbf X\right)^{-1}\mathbf{X}^T\mathbf y)\\ &amp;=&amp;\mathbf X^T\mathbf y-\left(\mathbf X^T\mathbf X\right)\left(\mathbf X^T\mathbf X\right)^{-1}\mathbf{X}^T\mathbf y\\ &amp;=&amp;\mathbf X^T\mathbf y-\mathbf X^T\mathbf y\\ &amp;=&amp;\mathbf 0 \end{array} </equation> </p><p>上式说明，OLS 的残差  <equation>\mathbf ε</equation>  和解释变量  <equation>\mathbf X</equation>  正交。来看看这在几何上意味着什么。</p><p>首先考虑最简单的情况，即一元回归 <equation>\mathbf y = b\mathbf x + \mathbf ε</equation> （再次提醒，没有截距项）。它的几何意义如下图所示：</p><img src="https://pic2.zhimg.com/v2-185db899e9c6f53b227b89ad493572d3_r.jpg" data-caption="" data-size="normal" data-rawwidth="554" data-rawheight="251" data-watermark="watermark" data-original-src="v2-185db899e9c6f53b227b89ad493572d3" data-watermark-src="v2-0f1ed0d3b9202ea4cd7de3fd6908685f" data-private-watermark-src=""><p>这个图说明，OLS 回归实际上将  <equation>\mathbf y</equation> <b>垂直投影到（orthogonally projected onto）</b> <equation>\mathbf x</equation> <b> 之上</b>，使得 <equation>\mathbf y</equation> 和其在 <equation>\mathbf x</equation> 上的投影之间的距离（ <equation>\mathbf ε</equation>  的长度）最短（残差平方和最小）。这就是 OLS 的几何意义。</p><p>再来看看二元回归 <equation>\mathbf y = b_1\mathbf x_1 + b_2\mathbf x_2 + \mathbf ε</equation> ，并首先<b>假设 </b><equation>\mathbf x_1</equation> <b>和 </b><equation>\mathbf x_2</equation> <b>之间是正交的</b>。该回归的几何意义如下：</p><img src="https://pic3.zhimg.com/v2-ccc579278e4407ffdb1f948524cfc859_r.jpg" data-caption="" data-size="normal" data-rawwidth="601" data-rawheight="442" data-watermark="watermark" data-original-src="v2-ccc579278e4407ffdb1f948524cfc859" data-watermark-src="v2-567923869b016a6a04053f7258459c2b" data-private-watermark-src=""><p>对于二元回归，它的几何意义是将 <equation>\mathbf y</equation> 垂直投影到由 <equation>\mathbf x_1</equation> 和 <equation>\mathbf x_2</equation> 生成的超平面内，其投影正如上图中绿色向量所示。此外，我们可以分别、独立的将  <equation>\mathbf y</equation>  投影到 <equation>\mathbf x_1</equation> 和 <equation>\mathbf x_2</equation> 上（图中两个橘黄色向量）。在本例中，<b>由于 </b><equation>\mathbf x_1</equation> <b>和 </b><equation>\mathbf x_2</equation> <b>相互正交（垂直），因此绿色向量恰好等于两个橘黄色向量之和。</b>这说明当 <equation>\mathbf x_1</equation> 和 <equation>\mathbf x_2</equation> 正交时，回归系数 <equation>b_i</equation> 仅由 <equation>\mathbf x_1</equation> 和 <equation>\mathbf y</equation> 决定、其他任何解释变量 <equation>\mathbf x_j (j ≠ i)</equation> 对 <equation>b_i</equation> 均没有影响。</p><p>下面来看看 <equation>\mathbf x_1</equation> 和 <equation>\mathbf x_2</equation> <b>非正交</b>的情况。该二元回归的几何意义如下：</p><img src="https://pic3.zhimg.com/v2-63a95ce036a4d0c955e92dfc0d6d2458_r.jpg" data-caption="" data-size="normal" data-rawwidth="552" data-rawheight="444" data-watermark="watermark" data-original-src="v2-63a95ce036a4d0c955e92dfc0d6d2458" data-watermark-src="v2-0884ca75f3adae05eb3615cdd6e9ea4d" data-private-watermark-src=""><p>它和前一种情况最大的区别是，<b>当 </b><equation>\mathbf x_1</equation> <b>和 </b><equation>\mathbf x_2</equation> <b>非正交时，</b> <equation>\mathbf y</equation> <b> 在由 </b><equation>\mathbf x_1</equation> <b>和 </b><equation>\mathbf x_2</equation> <b>生成的超平面内的投影不等于 </b> <equation>\mathbf y</equation> <b> 分别在 </b><equation>\mathbf x_1</equation> <b>和 </b><equation>\mathbf x_2</equation> <b>上的投影之和。</b>在这种情况下，解释变量之间对各自的回归系数有不同的作用，因此 OLS 的回归系数 <equation>b_i</equation> <b>不再等于</b> <equation>\langle\mathbf x_i, \mathbf y\rangle/\langle\mathbf x_i, \mathbf x_i\rangle</equation> 。</p><p>非正交 <equation>\mathbf x_i</equation> 之间的相互作用如何影响回归系数 <equation>b_i</equation> 呢？通过连续正交化来求解多元线性回归可以回答这个问题。</p><h2><b>4 用正交化过程求解多元回归</b></h2><p>还是拿我们最熟悉的 simple regression model 为例；该模型有两个解释变量 —— 截距项和  <equation>\mathbf x</equation> 。</p><p><equation>y_i=a+bx_i+\varepsilon_i</equation> </p><p>令 <equation>\mathbf x_0</equation> 表示截距项对应的解释变量，即 <equation>\mathbf x_0 = [1,1,…,1]^T</equation> ； <equation>\mathbf x_1</equation> 表示上式中的解释变量  <equation>\mathbf x</equation> 。假设 <equation>\mathbf x_0</equation> 和 <equation>\mathbf x_1</equation> 非正交（正交的话我们就不用费劲了）。对于简单回归模型，回归系数  <equation>a</equation> （对应 <equation>\mathbf x_0</equation> ）和 <equation>b</equation> （对应 <equation>\mathbf x_1</equation> ）的解为：</p><p><equation>\begin{array}{rll} b&amp;=&amp;\displaystyle\frac{\sum x_iy_i-\frac{1}{n}\sum x_i\sum y_i}{\sum x_i^2-\frac{1}{n}(\sum x_i)^2}\\ a&amp;=&amp;\displaystyle\frac{1}{n}\sum y_i-b\left(\frac{1}{n}\sum x_i\right) \end{array} </equation> </p><p>下面就来看看如何通过正交化求解 <equation>a</equation> 和 <equation>b</equation> 。由于 <equation>\mathbf x_0</equation> 和 <equation>\mathbf x_1</equation> 非正交，首先需要构造出一组正交向量。令 <equation>\mathbf z_0 = \mathbf x_0</equation> 为其中的一个向量，将 <equation>\mathbf x_1</equation> 用 <equation>\mathbf z_0</equation> 进行一元回归（不带截距）得到的残差就是和 <equation>\mathbf z_0</equation> 互相垂直（正交）的向量，记为 <equation>\mathbf z_1</equation> 。由一元回归的性质可知：</p><p><equation>\mathbf z_1=\displaystyle\mathbf x_1-\frac{\langle\mathbf z_0,\mathbf x_1\rangle}{\langle\mathbf z_0,\mathbf z_0\rangle}\mathbf z_0=\mathbf x_1-\bar x\mathbf 1</equation> </p><p>其中 <equation>\bar x</equation> 表示  <equation>\mathbf x</equation>  的均值， <equation>\mathbf 1</equation> 表示列向量 <equation>[1,1,…,1]^T</equation> ，即 <equation>\mathbf z_0</equation> 。</p><p>So far so good？接下来，注意了：</p><p><b>将 </b> <equation>\mathbf y</equation> <b> 用上面得到的 </b><equation>\mathbf z_1</equation> <b>进行一元回归（不带截距），得到的回归系数就是上述 simple regression model 中解释变量 </b> <equation>\mathbf x</equation> <b> 的回归系数</b> <equation>b</equation> <b>！</b></p><p><equation>\begin{array}{rll} b&amp;=&amp;\displaystyle\frac{\langle\mathbf z_1,\mathbf y\rangle}{\langle\mathbf z_1,\mathbf z_1\rangle}=\displaystyle\frac{\langle\mathbf x_1-\bar x\mathbf 1,\mathbf y\rangle}{\langle\mathbf x_1-\bar x\mathbf 1,\mathbf x_1-\bar x\mathbf 1\rangle}\\ &amp;=&amp;\displaystyle\frac{\sum x_iy_i-\bar x\sum y_i}{\sum(x_i-\bar x)^2}=\displaystyle\frac{\sum x_iy_i-\frac{1}{n}\sum x_i\sum y_i}{\sum(x_i^2-2x_i\bar x+\bar x^2)}\\ &amp;=&amp;\displaystyle\frac{\sum x_iy_i-\frac{1}{n}\sum x_i\sum y_i}{\sum x_i^2-2(\sum x_i)\bar x+n\bar x^2}=\displaystyle\frac{\sum x_iy_i-\frac{1}{n}\sum x_i\sum y_i}{\sum x_i^2-2n\bar x^2+n\bar x^2}\\ &amp;=&amp;\displaystyle\frac{\sum x_iy_i-\frac{1}{n}\sum x_i\sum y_i}{\sum x_i^2-n\bar x^2}=\displaystyle\frac{\sum x_iy_i-\frac{1}{n}\sum x_i\sum y_i}{\sum x_i^2-\frac{1}{n}(\sum x_i)^2} \end{array}</equation> </p><p>怎么样？我们并没有直接对该模型求解，而是通过正交化的方式就求出了解释变量 <equation>\mathbf x_1</equation> 的回归系数  <equation>b</equation> 。反应快的小伙伴也许马上会问  <equation>a</equation>  呢？ <equation>a</equation>  是否等于 <equation>\langle\mathbf z_0, \mathbf y\rangle/\langle\mathbf z_0, \mathbf z_0\rangle</equation> 呢？别急，我们一会儿就聊 <equation>a</equation> ，但是在那之前先来看一个<b>通过连续正交化求解多元回归的算法</b>（Hastie et al. 2016）：</p><img src="https://pic1.zhimg.com/v2-4ebccf87b8461860673a45e28cc187e5_r.jpg" data-caption="" data-size="normal" data-rawwidth="924" data-rawheight="499" data-watermark="watermark" data-original-src="v2-4ebccf87b8461860673a45e28cc187e5" data-watermark-src="v2-48dc8bfabe3410e71700b618533b16f9" data-private-watermark-src=""><p><b>该算法的核心是通过连续的正交化计算把一组非两两正交的向量 </b><equation>\mathbf x_i</equation> <b>转换成一组两两正交的向量 </b><equation>\mathbf z_i</equation> <b>，并以此方便的求出最后一个被正交化的解释变量的多元回归系数。</b>虽然它只有三步，但是每一步都值得解读一下：</p><p><b>1.</b> 第一步是初始化，在所有解释变量中（如果回归中有截距项，就把 <equation>[1,1,…,1]^T</equation> 看做一个解释变量）任意挑选一个当作 <equation>\mathbf x_0</equation> 进行初始化 <equation>\mathbf z_0 = \mathbf x_0</equation> 。</p><p><b>2.</b> 第二步是<b>根据我们自己选定的递归顺序（任意顺序都可以）</b>，对 <equation>\mathbf x_1, \mathbf x_2,\cdots, \mathbf x_p</equation> 依次进行正交化。例如，对 <equation>\mathbf x_j</equation> 的正交化处理就是用它和之前已经被处理过后的正交向量 <equation>\mathbf z_0, \mathbf z_1,\cdots, \mathbf z_{j-1}</equation> <b>逐一独立</b>一元回归得到系数  <equation>\langle\mathbf z_k, \mathbf x_j\rangle/\langle\mathbf z_k, \mathbf z_k\rangle, k=0,1,\cdots,j-1</equation> ，进而用  <equation>\mathbf x_j</equation>  减去 <equation>(\langle\mathbf z_k, \mathbf x_j\rangle/\langle\mathbf z_k, \mathbf z_k\rangle)\mathbf z_k, k=0,1,\cdots,j-1</equation> 之和，得到的残差就是最新的正交化后的向量  <equation>\mathbf z_j</equation> 。</p><p><b>3.</b> 使用  <equation>\mathbf y</equation>  和 <equation>\mathbf z_p</equation> 进行一元回归，得到的系数 <equation>\langle\mathbf z_p, \mathbf y\rangle/\langle\mathbf z_p, \mathbf z_p\rangle</equation> 正是这个多元回归 OLS 求解中原始解释变量 <equation>\mathbf x_p</equation> 的回归系数 <equation>b_p</equation> 。注意，这一结论仅对<b>最后一个</b>（第 <equation>p</equation> 个）被正交化后的解释变量成立。换句话说，对于别的解释变量 <equation>j&lt;p</equation> ， <equation>\langle\mathbf z_j, \mathbf y\rangle/\langle\mathbf z_j, \mathbf z_j\rangle</equation> 并不是多元回归中原解释变量 <equation>\mathbf x_j</equation> 的回归系数。</p><p>看到这里，有的小伙伴可能会问，这个算法确实不错，但是费了半天劲算出了一大堆相互正交的向量 <equation>\mathbf z_j</equation> ，但是求解回归系数的结论仅对最后一个被正交化的解释变量成立，这不是坑爹吗？</p><p>答案是并不坑爹！这是因为上述算法中的关键一点是，<b>正交化这些解释变量的顺序是任意的</b>。我们可以选任何一个来初始化，也可以选任何一个作为最后一个被正交化的解释变量。无论我们怎么选，上述过程都保证了最后一个被正交化的解释变量的回归系数满足 <equation>b_p=\langle\mathbf z_p, \mathbf y\rangle/\langle\mathbf z_p, \mathbf z_p\rangle</equation> 。因此，<b>我们只需要依次挑选这些解释变量作为最后一个被正交化的，就可以通过上述步骤方便的求出它们的回归系数。</b>而它所反映出来的本质是：</p><p><b>在多元线性回归中，解释变量 </b><equation>\mathbf x_j</equation> <b>的回归系数 </b><equation>b_j</equation> <b>等于 </b><equation>\mathbf x_j</equation> <b>在被其他 </b><equation>\mathbf x_0, \mathbf x_1,\cdots, \mathbf x_{j-1}, \mathbf x_{j+1},\cdots, \mathbf x_p</equation> <b>调整之后（即正交化，从而排除其他 </b><equation>\mathbf x_i</equation> <b>对 </b><equation>\mathbf x_j</equation> <b>的影响）仍能够对 </b> <equation>\mathbf y</equation> <b> 产生的增量贡献。</b></p><p><b>这个算法叫作多元回归的 Gram-Schmidt（格拉姆-施密特）正交化过程。</b></p><p>本小节开始的 simple regression model 已经验证了上述结论。我们使用 <equation>\mathbf x_0</equation> 将 <equation>\mathbf x_1</equation> 正交化处理得到 <equation>\mathbf z_1</equation> ，然后用 <equation>\mathbf y</equation> 和 <equation>\mathbf z_1</equation> 回归得到的正是 <equation>\mathbf x_1</equation> 的回归系数  <equation>b</equation> ；如果将 <equation>\mathbf x_1</equation> 选为 <equation>\mathbf z_0</equation> ，然后用它正交化 <equation>\mathbf x_0 = [1,1,…,1]^T</equation> ，就可以方便的求出回归系数  <equation>a</equation> 。</p><p>让我们来好好审视一下这个结论，即：</p><p><equation>\displaystyle b_p=\frac{\langle\mathbf z_p,\mathbf y\rangle}{\langle\mathbf z_p,\mathbf z_p\rangle}</equation> </p><p>上式说明，解释变量 <equation>\mathbf x_p</equation> 的回归系数 <equation>b_p</equation> 和正交化后的 <equation>\mathbf z_p</equation> 的大小（ <equation>\mathbf z_p</equation> 自己的內积为分母）有关。<b>如果 </b><equation>\mathbf x_p</equation> <b>和其他解释变量高度相关（即非常不正交），那么 </b><equation>\mathbf z_p</equation> <b>就会很小，则会导致</b> <equation>b_p</equation> <b>非常不稳定（一点点样本数据的变化都会导致</b> <equation>b_p</equation> <b>的大幅变化）。</b>当 <equation>y_i</equation> 满足独立同分布时，假设它的方差为 <equation>\sigma^2</equation> ，可以证明回归系数 <equation>b_p</equation> 的方差和 <equation>\mathbf z_p</equation> 的大小成反比，即 <equation>\|\mathbf z_p\|^2</equation> 越小， <equation>b_p</equation> 的误差越大：</p><p><equation>\displaystyle \mbox{var}(b_p)=\frac{\sigma^2}{\langle\mathbf z_p,\mathbf z_p\rangle}=\frac{\sigma^2}{\|\mathbf z_p\|^2}</equation> </p><p>在多因子模型中， <equation>b_p</equation> 代表的是因子  <equation>p</equation>  的收益率。<b>为避免因子收益率的估计非常不稳定，要求不同的因子之间尽量满足正交化。</b>举例来说，在 Barra 的 CNE5 模型中，非线性规模因子和规模因子之间进行了正交化处理；残差波动率因子和规模以及 BETA 因子也进行了正交化处理。</p><p>在结束本小节的讨论之前，我还想介绍一个有意思也有用的特性。本节的论述说明我们可以任选一个解释变量作为最后一个，然后根据连续正交化方便的求出它的回归系数。这意味着如果我们有 20个解释变量，需要进行 20 次上述操作。那么，<b>是否存在什么办法仅通过进行一次连续正交化就求出所有的回归系数</b> <equation>b_j, j = 0, 1,\cdots, p</equation> <b>呢？答案是肯定的。</b></p><p>假设我们按照某给定顺序 <equation>\mathbf x_0, \mathbf x_1,\cdots, \mathbf x_p</equation> 进行了连续正交化过程，得到了 <equation>\mathbf z_0, \mathbf z_1,\cdots, \mathbf z_p</equation> ，且我们现在知道 <equation>b_p=\langle\mathbf z_p,\mathbf y\rangle/\langle\mathbf z_p,\mathbf z_p\rangle</equation> 。由于 <equation>b_p</equation> 正是解释变量 <equation>\mathbf x_p</equation> 的回归系数，因此 <equation>b_p\mathbf x_p</equation> 正是 <equation>\mathbf x_p</equation> 所解释的 <equation>\mathbf y</equation> 的部分。如果从 <equation>\mathbf y</equation> 中剔除 <equation>b_p\mathbf x_p</equation> ，并把得到的 <equation>\mathbf y-b_p\mathbf x_p</equation> 用 <equation>\mathbf x_0, \mathbf x_1,\cdots, \mathbf x_{p-1}</equation> 回归，则结果就和 <equation>\mathbf x_p</equation> 无关了。在这个新的回归中， <equation>\mathbf x_{p-1}</equation> 就变成了最后一个被正交化的解释变量，其对应的正交向量为 <equation>\mathbf z_{p-1}</equation> 。因此， <equation>\mathbf x_{p-1}</equation> 的回归系数就是用新的 <equation>\mathbf y-b_p\mathbf x_p</equation> 和 <equation>\mathbf z_{p-1}</equation> 回归的结果：</p><p><equation>\displaystyle b_{p-1}=\frac{\langle\mathbf z_{p-1}, \mathbf y-b_p\mathbf x_p\rangle}{\langle\mathbf z_{p-1}, \mathbf z_{p-1}\rangle}</equation> </p><p>以此类推，我们可以按照 <equation>b_p, b_{p-1},\cdots, b_0</equation> 的<b>倒序</b>求解出多元回归中所有解释变量的回归系数 <equation>b_j</equation> （Drygas 2011）：</p><p><equation>\begin{array}{rll} b_p&amp;=&amp;\displaystyle\frac{\langle\mathbf z_{p}, \mathbf y\rangle}{\langle\mathbf z_{p}, \mathbf z_{p}\rangle}\\ \displaystyle b_{j}&amp;=&amp;\displaystyle\frac{\langle\mathbf z_{j}, \mathbf y-\sum_{i=j+1}^p b_i\mathbf x_i\rangle}{\langle\mathbf z_{j}, \mathbf z_{j}\rangle},~j=p-1,p-2,\cdots,0 \end{array} </equation> </p><p>最后用本小节开始的 simple regression model 检验一下。我们用上述方法求解截距项的回归系数  <equation>a</equation>  看看。根据定义有 <equation>\mathbf z_0 = \mathbf 1</equation> 并假设已知  <equation>b</equation> 。则根据上面的表达式可得：</p><p><equation>\begin{array}{rll} a&amp;=&amp;\displaystyle\frac{\langle\mathbf 1,\mathbf y-b\mathbf x\rangle}{\langle\mathbf 1,\mathbf 1\rangle}\\ &amp;=&amp;\displaystyle\frac{\sum y_i-b\sum x_i}{n}\\ &amp;=&amp;\displaystyle\frac{1}{n}\sum y_i-b\left(\frac{1}{n}\sum x_i\right) \end{array} </equation> </p><p>这正是直接求解 simple regression model 得到的回归系数  <equation>a</equation> （请往前滚屏比较看看）。</p><h2><b>5 一个例子</b></h2><p>本节用一个例子来验证一下上一节的各种公式。假设有四个解释变量 <equation>\mathbf x_0</equation> 到 <equation>\mathbf x_3</equation> ，以及  <equation>\mathbf y</equation> ：</p><p><equation>\mathbf x_0=\left[\begin{array}{c} 1\\1\\1\\1\\1\\1\\1\\1 \end{array}\right], \mathbf x_1=\left[\begin{array}{c} 1\\2\\4\\3\\7\\6\\3\\5 \end{array}\right], \mathbf x_2=\left[\begin{array}{c} 0\\1\\2\\8\\9\\4\\6\\2 \end{array}\right], \mathbf x_3=\left[\begin{array}{c} 1\\3\\3\\2\\5\\8\\0\\4 \end{array}\right], \mathbf y=\left[\begin{array}{c} 3\\1\\4\\1\\5\\9\\2\\6 \end{array}\right] </equation> </p><p>直接使用回归系数  <equation>\mathbf b</equation>  的表达式求解，则它们的回归系数分别为：<equation>b_0 = 0.38548073</equation>, <equation>b_1 = 0.96332683</equation>, <equation>b_2 = -0.36300685</equation>, <equation>b_3 = 0.37189391</equation>。按照 <equation>\mathbf x_0, \mathbf x_1, \mathbf x_2, \mathbf x_3</equation> 的顺序进行连续正交化，得到的正交向量为：</p><p><equation>\begin{array}{rll} \mathbf z_0&amp;=&amp;\mathbf x_0\\ \mathbf z_1&amp;=&amp;\displaystyle\mathbf x_1-\frac{\langle\mathbf x_1,\mathbf z_0\rangle}{\langle\mathbf z_0,\mathbf z_0\rangle}\mathbf z_0\\ \mathbf z_2&amp;=&amp;\displaystyle\mathbf x_2-\frac{\langle\mathbf x_2,\mathbf z_0\rangle}{\langle\mathbf z_0,\mathbf z_0\rangle}\mathbf z_0-\frac{\langle\mathbf x_2,\mathbf z_1\rangle}{\langle\mathbf z_1,\mathbf z_1\rangle}\mathbf z_1\\ \mathbf z_3&amp;=&amp;\displaystyle\mathbf x_3-\frac{\langle\mathbf x_3,\mathbf z_0\rangle}{\langle\mathbf z_0,\mathbf z_0\rangle}\mathbf z_0-\frac{\langle\mathbf x_3,\mathbf z_1\rangle}{\langle\mathbf z_1,\mathbf z_1\rangle}\mathbf z_1-\frac{\langle\mathbf x_3,\mathbf z_2\rangle}{\langle\mathbf z_2,\mathbf z_2\rangle}\mathbf z_2 \end{array} </equation> </p><p><equation>\mathbf z_0=\left[\begin{array}{c} 1\\1\\1\\1\\1\\1\\1\\1 \end{array}\right], \mathbf z_1=\left[\begin{array}{r} -2.875\\-1.875\\ 0.125\\-0.875\\3.125\\ 2.125\\ -0.875\\ 1.125 \end{array}\right], \mathbf z_2=\left[\begin{array}{r} -1.51082251\\-1.37662338\\-2.10822511\\ 4.75757576\\2.29437229\\-1.83982684\\2.75757576\\-2.97402597 \end{array}\right], \mathbf z_3=\left[\begin{array}{r} -0.00844984\\1.08972192\\-1.02611768\\1.06099247\\-0.48286987\\2.17022584\\-1.56337379\\-1.24012905 \end{array}\right] </equation> </p><p>使用 Drygas (2011) 提出的解法按照 <equation>b_3, b_2, b_1, b_0</equation> 的顺序求解各个回归系数 <equation>b_j</equation> ：</p><p><equation>\begin{array}{rll} b_3&amp;=&amp;\displaystyle\frac{\langle\mathbf z_3,\mathbf y\rangle}{\langle\mathbf z_3,\mathbf z_3\rangle}\\ b_2&amp;=&amp;\displaystyle\frac{\langle\mathbf z_2,\mathbf y-b_3\mathbf x_3\rangle}{\langle\mathbf z_2,\mathbf z_2\rangle}\\ b_1&amp;=&amp;\displaystyle\frac{\langle\mathbf z_1,\mathbf y-b_3\mathbf x_3-b_2\mathbf x_2\rangle}{\langle\mathbf z_1,\mathbf z_1\rangle}\\ b_0&amp;=&amp;\displaystyle\frac{\langle\mathbf z_0,\mathbf y-b_3\mathbf x_3-b_2\mathbf x_2-b_1\mathbf x_1\rangle}{\langle\mathbf z_0,\mathbf z_0\rangle} \end{array} </equation> </p><p>上述公式求出 <equation>b_0 = 0.38548073</equation>, <equation>b_1 = 0.96332683</equation>, <equation>b_2 = -0.36300685</equation>, <equation>b_3 = 0.37189391</equation>，和使用回归系数  <equation>\mathbf b</equation>  的表达式求解的结果完全一致。另外，我们也可以分别选择 <equation>\mathbf x_0, \mathbf x_1, \mathbf x_2</equation> 替换 <equation>\mathbf x_3</equation> 作为最后一个被正交化的解释变量（前三个变量的顺序也不重要），并利用 <equation>b_p=\langle\mathbf z_p,\mathbf y\rangle/\langle\mathbf z_p,\mathbf z_p\rangle</equation> 求解，得出的 <equation>b_j</equation> 也和上面的完全相同。</p><h2><b>6 正交等于不相关？</b></h2><p>在我们平常说因子之间正交的时候，另一个常用的词汇是因子之间“不相关”（这里不相关指的是不同因子的 Pearson 相关系数为零）。那么“正交”和“不相关”是否等价呢？</p><p>从定义出发，两个因子向量 <equation>\mathbf x_1</equation> 和  <equation>\mathbf x_2</equation>  正交意味着它们的內积，即 <equation>\langle\mathbf x_1, \mathbf x_2\rangle</equation> 为零。而 <equation>\mathbf x_1</equation> 和 <equation>\mathbf x_2</equation> 的相关系数为零则意味着 <equation>\langle\mathbf x_1-\mbox{E}[x_1]\cdot \mathbf 1, \mathbf x_2-\mbox{E}[x_2]\cdot \mathbf 1\rangle</equation> 为零，因为在计算相关系数时，必须先分别减去其均值，这就是个 centering 的过程。由于 <equation>\langle\mathbf x_1, \mathbf x_2\rangle</equation> 为零不一定意味着 <equation>\langle\mathbf x_1-\mbox{E}[x_1]\cdot \mathbf 1, \mathbf x_2-\mbox{E}[x_2]\cdot \mathbf 1\rangle</equation> 也为零，因此正交不一定等于不相关。</p><p>举个例子， <equation>[4, 2]^T</equation> 和 <equation>[3, -6]^T</equation> 的內积为零，这两个向量正交。而各自减去均值后， <equation>[4, 2]^T</equation> 和 <equation>[3, -6]^T</equation> 分别变为 <equation>[1, -1]^T</equation> 和 <equation>[4.5, -4.5]^T</equation> 。这两个新向量在一条直线上、內积不为零，因此 <equation>[4, 2]^T</equation> 和 <equation>[3, -6]^T</equation> 的相关系数不为零（事实上，它们的相关系数等于 1）。从多元回归求解的角度来说，我们在乎的是他们是否正交，而非 centering 之后的內积是否为零（即是否不相关）。</p><p>不过对于因子暴露向量来说，因为个股在每个因子上的暴露都经过 demean 处理了，所以每个因子向量的均值已经是零了（这里考虑的就是简单等权均值的情况，而不是像 Barra 那种用市值作为权重进行去均值的情况）。从这个意义上说，因子向量之间正交和它们之间不相关等价。</p><h2><b>7 结语</b></h2><p>一不留神又写了这么长。从阅读体验来说，实在抱歉。</p><p>本文掰扯了一大堆公式其实就是想说明下面这句话：</p><p><b>在多元线性回归中，解释变量 </b><equation>\mathbf x_j</equation><b>的回归系数 </b><equation>b_j</equation><b>等于 </b><equation>\mathbf x_j</equation><b>在被其他 </b><equation>\mathbf x_0, \mathbf x_1,\cdots, \mathbf x_{j-1}, \mathbf x_{j+1},\cdots, \mathbf x_p</equation><b>调整之后（即正交化，从而排除其他 </b><equation>\mathbf x_i</equation><b>对 </b><equation>\mathbf x_j</equation><b>的影响）仍能够对 </b><equation>\mathbf y</equation><b> 产生的增量贡献。如果 </b><equation>\mathbf x_j</equation> <b>和其他解释变量高度相关，则它的回归系数</b> <equation>b_j</equation> <b>会有很大的估计误差。这对于多因子模型中评价因子收益非常不利。</b></p><p>如果看完之后你对这句话有一定的体会，那我的功夫就没白花。</p><p>在计算机算法进行多元回归求解的时候，并不是试图按照  <equation>\mathbf b</equation>  的公式计算  <equation>\mathbf X^T\mathbf X</equation>  的逆矩阵，而采用的正是正交化的思路。在正交化的过程中可以非常容易的得到  <equation>\mathbf X</equation>  的 QR 分解，其中 <equation>\mathbf Q</equation> 是正交阵、 <equation>\mathbf R</equation>  是上三角阵。这也极大的化简了回归系数  <equation>\mathbf b</equation>  以及 <equation>\mathbf y</equation> 预测值的求解。由于篇幅原因（我也好意思说篇幅……），本文就不给出 QR 分解的具体表达式了，感兴趣的读者请参考 Hastie et al. (2016)。</p><p><br></p><p><b>参考文献</b></p><ul><li>Drygas, H. (2011). On the Relationship between the Method of Least Squares and Gram-Schmidt Orthogonalization. <i>Acta et Commentationes Universitatis Tartuensis de Mathematica</i>, Vol. 15(1), 3 – 13.</li><li>Hastie, T., R. Tibshirani, and J. Friedman (2016). <i>The Elements of Statistical Learning: Data Mining, Inference, and Prediction</i>, 2nd Ed. Springer.</li></ul><p><br></p><p><br></p><p>原创不易，请保护版权。如需转载，请联系获得授权，并注明出处，谢谢。已委托“维权骑士”(<a href="http://rightknights.com/">维权骑士_免费版权监测/版权保护/版权分发</a>) 为进行维权行动。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
</body>
</html>
