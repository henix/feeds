<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>渗透测试向导—子域名枚举技术</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/31160156">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-bc7e2fcd9dde69b5b6baa53429c94821_r.jpg" alt=""></div><p>作为一名渗透测试者或专业的漏洞赏金猎人，大多数情况下，当开始测试时仅仅知道一个域名或一系列域名。但是我们必须要展开广泛的侦查才能发现更多有意义的东西，例如服务器、web 应用程序、属于目标组织的域等等，以便有更多的机会发现漏洞。</p><p>我写了篇介绍开源情报收集技术的<a href="https://blog.appsecco.com/open-source-intelligence-gathering-101-d2861d4429e3">博文</a>，这种方法被广泛的应用在侦查阶段。</p><p>子域名枚举是信息侦查阶段中关键的一部分。本文以简洁的方式介绍了几种子域名枚举技术。</p><p>在  Gitbook 上将发表这一主题的文章来深入探讨这些技术。我们在2017年 Bugcrowd LevelUp 会议的“ <a href="https://github.com/appsecco/bugcrowd-levelup-subdomain-enumeration">Esoteric sub-domain enumeration<br>techniques</a> ” 议题中也谈到了这些技巧。</p><h2><b>什么是子域名枚举？</b></h2><p>子域名枚举是查找一个或多个域的子域的过程。这是侦察阶段的重要组成部分。</p><h2><b>为什么要进行子域名枚举？</b></h2><ul><li>子域名枚举可以在测试范围内发现更多的域或子域，这将增大漏洞发现的几率。</li><li>有些隐藏的、被忽略的子域上运行的应用程序可能帮助我们发现重大漏洞。</li><li>在同一个组织的不同域或应用程序中往往存在相同的漏洞。</li></ul><img src="https://pic4.zhimg.com/v2-159a0ef7b363ea41dd428fcf2b190547_r.jpg" data-caption="Yahoo! 由于在 yahoo.com 子域上部署了易受攻击的程序导致了 Voice hack。" data-size="normal" data-rawwidth="751" data-rawheight="104"><h2><b>子域名枚举方法</b></h2><ol><li>Google 和 Bing 等搜索引擎支持各种高级搜索来优化搜索查询。这些搜索语法通常被称为“Google dorks”。</li></ol><ul><li>我们可以在 Google 搜索中使用“site：” 关键字来查找某个域的所有子域。谷歌还支持额外参数来排除我们不感兴趣的子域名，例如 “site：*.wikimedia.org -www -store -jobs -uk”，就排除了  <a href="http://www.wikimedia.xn--orgstore-hm3g.wikimedia.xn--orgjobs-0o3f.wikimedia.xn--orguk-3t3d.wikimedia.org/">www.wikimedia.org、store.wikimedia.org、jobs.wikimedia.org、uk.wikimedia.org</a> 等域。</li></ul><img src="https://pic4.zhimg.com/v2-aa7995bead8b1cff63a2938d5d4a6c24_r.jpg" data-caption="使用 site 关键字在google搜索中找到的域名。" data-size="normal" data-rawwidth="571" data-rawheight="636"><ul><li>Bing 搜索引擎也支持一些高级搜索。与 Google 一样，Bing 也支持 “site：” 运算符，或许您可能希望排除 Google 搜索的结果。</li></ul><img src="https://pic2.zhimg.com/v2-6213135440dc967510c57ade914a385f_r.jpg" data-caption="使用 “site” 关键字在bing搜索引擎中找到的子域名。" data-size="normal" data-rawwidth="500" data-rawheight="832"><p>2、 有许多拥有大量 DNS 数据集的第三方服务，可通过他们来检索给定域的子域。</p><ul><li>VirusTotal 运行自己的被动 DNS 复制服务，它是通过存储用户提交的 URL 解析结果来建立的。为了检索域的信息，你只需要在搜索栏中输入域名</li></ul><img src="https://pic2.zhimg.com/v2-11ea245cd7bd281ebac8eb99fb0f6354_r.jpg" data-caption="使用 virustotal 收集子域名" data-size="normal" data-rawwidth="758" data-rawheight="583"><img src="https://pic2.zhimg.com/v2-da125dd65fb58fa957f54e2f7b7f43e2_r.jpg" data-caption="在 VirusTotla 中发现的子域名" data-size="normal" data-rawwidth="452" data-rawheight="450"><ul><li>DNSdumpster 是另一个有趣的工具，可以挖掘出指定域潜藏的大量子域。</li></ul><img src="https://pic2.zhimg.com/v2-d4a5f59f9546712dfce8da5127c73090_r.jpg" data-caption="使用DNSdumpster搜索子域" data-size="normal" data-rawwidth="956" data-rawheight="601"><ul><li><a href="https://github.com/aboul3la/Sublist3r">Sublist3r</a> 是一个流行的工具，它使用各种资源来枚举子域。通过诸如 Google，Yahoo，Bing，百度和 Ask 等许多搜索引擎来枚举。Sublist3r 还使用 Netcraft，Virustotal，ThreatCrowd，DNSdumpster 和 ReverseDNS 等第三方服务来枚举子域。</li></ul><img src="https://pic3.zhimg.com/v2-73b870ebbc5b92628a1aa10d56ef99eb_r.jpg" data-caption="使用 sublist3r 枚举子域" data-size="normal" data-rawwidth="683" data-rawheight="501"><p>3、 <a href="https://zh.wikipedia.org/zh-cn/%E8%AF%81%E4%B9%A6%E9%80%8F%E6%98%8E%E5%BA%A6">证书透明</a>度（Certificate Transparency，CT）是一个实验性的 IETF 开源标准和开源框架，证书颁发机构（Certificate Authority，CA）必须将每个 SSL 或 TLS 证书发布到公共日志中。SSL 或 TLS 证书通常包含域名，子域名和电子邮件地址。这使得它们成为攻击者的信息宝库。我在“证书透明度”一书中撰写了一系列技术性博客文章，深入介绍了这一技术，您可以在<a href="https://blog.appsecco.com/certificate-transparency-the-bright-side-and-the-dark-side-8aa47d9a6616">这里</a>阅读本系列文章。</p><p>使用收集 CT（Certificate Transparency）日志的搜索引擎，是发现某个域证书最简单的方法。以下是一些流行的搜索引擎：</p><p>1. <a href="https://crt.sh/">https://crt.sh/</a></p><p>2. <a href="https://censys.io/">https://censys.io/</a></p><p>3. <a href="https://developers.facebook.com/tools/ct/">https://developers.facebook.com/tools/ct/</a></p><p>4. <a href="https://www.google.com/transparencyreport/https/ct/">https://google.com/transparencyreport/https/ct/</a></p><img src="https://pic2.zhimg.com/v2-3a38f11839de3da4b2ca61df9f8c1e30_r.jpg" data-caption="使用crt.sh查找某个组织主域下的子域名" data-size="normal" data-rawwidth="800" data-rawheight="273"><p>我们编写了几个脚本来简化使用 CT 日志搜索引擎查找子域的过程。脚本在我们的 <a href="https://github.com/appsecco/bugcrowd-levelup-subdomain-enumeration">github</a> <a href="https://github.com/appsecco/bugcrowd-levelup-subdomain-enumeration">仓库</a>中可用。</p><img src="https://pic2.zhimg.com/v2-8478731bf106eb1a472ebe311648693a_r.jpg" data-caption="来自uber.com CT日志的子域" data-size="normal" data-rawwidth="478" data-rawheight="197"><p>使用 CT 进行子域枚举的不利之处在于，在 CT 日志中找到的域名可能不再存在，因此无法解析为 IP 地址。您可以使用像 <b><a href="https://github.com/blechschmidt/massdns">massdns</a></b> 这样的工具，结合 CT 日志来快速识别可解析的域名。</p><code lang="text"># ct.py - extracts domain names from CT Logs(shipped
with massdns)

# massdns - will find resolvable domains &amp; adds them to a file 
./ct.py icann.org | ./bin/massdns -r resolvers.txt -t
A -q -a -o -w icann_resolvable_domains.txt -</code><img src="https://pic2.zhimg.com/v2-55a0c5dc10c1799c1325b9167990738c_r.jpg" data-caption="使用massdns来查找可解析的域名" data-size="normal" data-rawwidth="800" data-rawheight="303"><p>4、 基于字典的枚举是另一种查找具有通用名称的子域的技术。<a href="https://github.com/darkoperator/dnsrecon">DNSRecon</a> 是一个功能强大的 DNS 枚举工具，它的一个特点是使用预定义的单词表进行基于字典的子域枚举。</p><code lang="python">$ python dnsrecon.py -n ns1.insecuredns.com -d insecuredns.com -D subdomains-top1mil-5000.txt -t brt</code><img src="https://pic1.zhimg.com/v2-979fce8e4bf8e76850ada5662ea864af_r.jpg" data-caption="使用DNSRecon的基于字典的枚举" data-size="normal" data-rawwidth="1042" data-rawheight="269"><p>5、 置换扫描是识别子域的另一个有趣的技术。在这项技术中，我们使用已知域或子域的组合来确定新的子域。</p><ul><li><a href="https://github.com/infosec-au/altdns">Altdns</a> 是一个可以发现符合既定模式的子域的工具</li></ul><code lang="text">$ python altdns.py -i icann.domains -o data_output -w
icann.words -r -s results_output.txt </code><img src="https://pic2.zhimg.com/v2-eb01c3135fae85cd5f5e93d782c9bace_r.jpg" data-caption="使用AltDNS查找与某些排列或替换匹配的子域" data-size="normal" data-rawwidth="942" data-rawheight="139"><p>6、 找到<a href="https://www.iana.org/assignments/as-numbers">自治系统编号</a>（<a href="https://zh.wikipedia.org/wiki/%E8%87%AA%E6%B2%BB%E7%B3%BB%E7%BB%9F">ASN</a>）将有助于我们识别属于某个组织的网络块，该分块可能具有有效的域。</p><ul><li>使用 dig 或 host 来解析给定域的 IP 地址。</li><li>可以找到 IP 地址 ASN 的工具：</li></ul><p><a href="https://asn.cymru.com/cgi-bin/whois.cgi">https://asn.cymru.com/cgi-bin/whois.cgi</a></p><ul><li>可以找到域名 ASN 的工具：</li></ul><p><a href="http://bgp.he.net/">http://bgp.he.net/</a></p><img src="https://pic4.zhimg.com/v2-1d681670fc50eb265de8359ea2107dfd_r.jpg" data-caption="使用 IP 地址找到 AS 编号" data-size="normal" data-rawwidth="800" data-rawheight="247"><ul><li>找到的 ASN 号码可用于查找域的网络块。Nmap 脚本可以来实现 ：</li></ul><p><a href="https://nmap.org/nsedoc/scripts/targets-asn.html">https://nmap.org/nsedoc/scripts/targets-asn.html</a></p><code lang="text">$ nmap --script targets-asn --script-args targets-asn.asn=17012 &gt; netblocks.txt</code><img src="https://pic4.zhimg.com/v2-645bd67ed9c65cb3de4f2837e6654708_r.jpg" data-caption="使用AS编号查找网络块的NSE脚本" data-size="normal" data-rawwidth="599" data-rawheight="265"><p>7、 区域传输是 DNS 的一种事务，DNS 服务器将全部或部分区域文件的副本传递给另一台 DNS 服务器。如果区域传输没有被安全的配置，任何人都可以启动一个名称服务器的区域传输并获得区域文件的副本。在设计上，区域文件包含大量有关该区域和驻留在区域中主机的信息。</p><code lang="text">$ dig +multi AXFR @ns1.insecuredns.com insecuredns.com</code><img src="https://pic4.zhimg.com/v2-9b71cb71d202f9b1dad735eb6ac23dde_r.jpg" data-caption="使用DIG工具对域名服务器成功地进行区域传输" data-size="normal" data-rawwidth="800" data-rawheight="436"><p>8、 由于 DNSSEC 处理不存域的方式，可以“漫游” DNSSEC 区域并枚举该区域中的所有域。你可以从<a href="http://info.menandmice.com/blog/bid/73645/Take-your-DNSSEC-with-a-grain-of-salt">这里</a>了解更多关于这个技巧。</p><ul><li>对于使用 NSEC 记录的 DNSSEC 区域，可以使用 <a href="https://www.nlnetlabs.nl/projects/ldns/">ldns-walk</a>等工具执行区域漫游。</li></ul><code lang="text">$ ldns-walk @ ns1.insecuredns.com insecuredns.com</code><img src="https://pic4.zhimg.com/v2-814d64794eb086706c642be5243e9120_r.jpg" data-caption="带NSEC记录的DNSSEC区域" data-size="normal" data-rawwidth="736" data-rawheight="294"><ul><li>某些 DNSSEC 区域使用 NSEC3 记录，这些记录使用哈希域名来防止攻击者收集纯文本域名。攻击者可以收集所有的子域哈希值，并在线下破解哈希值。</li><li>像 <a href="https://dnscurve.org/nsec3walker.html">nsec3walker</a>这样的工具可以帮助我们自动化收集 NSEC3 哈希和破解哈希。安装 <a href="https://dnscurve.org/nsec3walker.html">nsec3walker</a> <i> href="https://dnscurve.org/nsec3walker.html"&gt;之后，可以使用以下命令来枚举 NSEC3 保护区的子域。</i></li></ul><code lang="text"># Collect NSEC3 hashes of a domain

$ ./collect icann.org &gt; icann.org.collect
# Undo the hashing, expose the sub-domain information.

$ ./unhash &lt; icann.org.collect &gt; icann.org.unhash
# Listing only the sub-domain part from the unhashed data

$ cat icann.org.unhash | grep "icann" | awk '{print $2;}'

del.icann.org.

access.icann.org.

charts.icann.org.

communications.icann.org.

fellowship.icann.org.

files.icann.org.

forms.icann.org.

mail.icann.org.

maintenance.icann.org.

new.icann.org.

public.icann.org.

research.icann.org.
</code><p>9、 有些项目收集互联网的扫描数据，并将其提供给研究人员和安全社区。这些数据集是子域信息的宝库。尽管在这个庞大的数据集中查找子域犹如大海捞针，但也是值得的。</p><ul><li><a href="https://scans.io/study/sonar.fdns_v2">正向</a> <a href="https://scans.io/study/sonar.fdns_v2">DNS</a> 数据集作为 Project Sonar 的一部分发布。这些数据是通过提取来自多个源的域名并且给每个域发送 ANY 请求来收集的。这些数据是 gzip 格式的 json 文件。我们可以解析数据集来查找给定域的子域。数据集是很大的（压缩后约 20 + GB，未压缩约有 300 + GB）。</li></ul><code lang="text"># Command to parse
&amp; extract sub-domains for a given domain
$ curl -silent https://scans.io/data/rapid7/sonar.fdns_v2/20170417-fdns.json.gz | pigz -dc | grep “.icann.org” | jq</code><img src="https://pic3.zhimg.com/v2-ec574de9a9862fbf746926751051583f_r.jpg" data-caption="使用 FDNS 数据集收集子域名" data-size="normal" data-rawwidth="800" data-rawheight="272"><h2><b>比较</b></h2><p>我们用上面谈到的方法来对 icann.org  进行检测并比较一下不同方法带来的结果。下面的条形图展示了使用不同的方法找到唯一且可解析的子域的数目。与我们联系可以了解收集这些信息的方法。</p><img src="https://pic3.zhimg.com/v2-c6c1bb2d0b32e7c90cae8e1c245f26ea_r.jpg" data-caption="不同方法找到的唯一且可解析子域的数目" data-size="normal" data-rawwidth="800" data-rawheight="533"><h2><b>整理和收集</b></h2><p>我们为子域名枚举技术、相关工具和一些资源做了个简单的整理，将所有方法呈现出来方便查找使用：</p><p><i><a href="https://gist.github.com/yamakira/2a36d3ae077558ac446e4a89143c69ab">https://gist.github.com/yamakira/2a36d3ae077558ac446e4a89143c69ab</a></i></p><img src="https://pic3.zhimg.com/v2-12cfa32db92c6c6f8e6981fccc50d2df_r.jpg" data-caption="简单的整理和搜集" data-size="normal" data-rawwidth="690" data-rawheight="642"><p><b>参考</b></p><ul><li><a href="https://github.com/appsecco/bugcrowd-levelup-subdomain-enumeration">https://github.com/appsecco/bugcrowd-levelup-subdomain-enumeration</a></li><li><a href="https://blog.appsecco.com/open-source-intelligence-gathering-101-d2861d4429e3">https://blog.appsecco.com/open-source-intelligence-gathering-101-d2861d4429e3</a></li><li><a href="https://www.databreaches.net/hackers-post-450k-credentials-apparently-pilfered-from-yahoo/">https://www.databreaches.net/hackers-post-450k-credentials-apparently-pilfered-from-yahoo/</a></li><li><a href="http://info.menandmice.com/blog/bid/73645/Take-your-DNSSEC-with-a-grain-of-salt">http://info.menandmice.com/blog/bid/73645/Take-your-DNSSEC-with-a-grain-of-salt</a></li><li><a href="https://www.peerlyst.com/posts/bsideslv-2017-breaking-ground-with-underflow-bsides-las-vegas">https://www.peerlyst.com/posts/bsideslv-2017-breaking-ground-with-underflow-bsides-las-vegas</a></li></ul><p><br></p><p>原文：<a href="https://blog.appsecco.com/a-penetration-testers-guide-to-sub-domain-enumeration-7d842d5570f6">https://blog.appsecco.com/a-penetration-testers-guide-to-sub-domain-enumeration-7d842d5570f6</a></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
