<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>为什么你不用AWS，还是需要了解一些AWS的技术？</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/20147945">原文</a></p>
<div class="title-image"><img src="https://pic3.zhimg.com/b7116bd19697054ab5e661edbf7eca06_r.jpg" alt=""></div><p>前一段，国内的某个云服务商出了故障（据说是交换机，我没有看详细的报告），导致网络瘫痪，一大堆构建在其上的应用遭遇了宕机，数小时无法访问，惨不忍睹。我朋友的项目正好在此之前发布，苦不堪言。国内的云服务商还很年轻，还有很多坑要踩 —— 要知道，即便是2006年就发布的AWS，在商用了6个年头之后的2012年，还发生过一次大的事故，导致quora等服务都无法访问。</p><br><p>我知道，AWS因为一些旁的原因，目前在国内还无法很好地使用，国内团队的首选也并非AWS。但，如果你有一颗做个好的app的心，AWS的技术（以及这些技术背后的思想和商业目的）最好还是了解一下。</p><br><h3>容灾</h3><br><p>既然我们讲到了云服务商的事故，那么，就先从容灾讲起。AWS在此踩了很多坑，也收获了很多宝贵的经验。</p><br><p>首先是availability zone。availibility zone是容灾的最重要一环。在aws分布全球的若干个region里，每个region都有若干个物理上相隔一定距离但又不太远（大概5-15miles）的数个独立的data center，也叫availibility zone（AZ）。物理上独立的意义是：独立的机房，独立的供电系统，独立的ISP接入系统等。这保证在一个AZ完全挂掉的情况下（比如电力故障，网络故障，甚至修路施工队的愚蠢的「实习生」挖断了光缆导致的ISP故障等），你的应用在另一个AZ还能正常使用。这一点很重要。若干AZ保持距离但又不太远保证了能够物理容灾的同时，你还可以将其几乎等同于同一个data center进行应用层面的容灾，比如说database的master/savle分别架在两个不同的AZ而不必过分担心网络层面的性能（round trip几乎可以忽略不计，也就几百us到至多几个ms，请自行用光速和距离计算）。</p><br><img src="https://pic1.zhimg.com/a57c03e0188f1455f1dae42f8ec18fd1_r.jpg" data-rawwidth="505" data-rawheight="277"><br><p>当然一个城市的电力系统可能整体出故障，一个国家的跨海光缆可能被海啸切断，所以AWS还有region的概念。这些region分跨数个大洲，保障物理上一个region整体挂掉的情况下，如果应用做了跨region的容灾，还能继续服务。但应用程序跨region的容灾不好做，距离上增加了两个量级，使得region之间的网络传输可能高达上百ms至几百ms，量变到质变，一些简单的应用层容灾手段（比如直接采用数据库的master/slave），便无法使用。</p><br><p>不过说句实话，大部分使用云服务商的应用程序还到不了需要跨region容灾的程度（到了这个程度，应该有一只强悍的devops team来处理这种happy sorrow了），所以，考虑跨AZ就好。</p><br><p>如果你选择一个云服务商，问问他们是否有类似AZ的概念，你的web server，database server能不能跨AZ部署。这是一个应用过了种子期（有了上千用户）首先该考虑的事情。当然，如果你直接上AWS，那么基本的容灾无忧了。</p><br><p>容灾的另一个层面是数据备份。你需要合适的backup/restore机制。AWS提供了S3/Glacier来存储文件类型的数据。数据备份是应对Murphy’s law的，当最坏的事情发生（数据丢失），对于服务恢复，你究竟有多大的容忍度，决定了你有多大的操作空间。如果你能容忍丢失至多一个小时的数据，那么，起码设置每隔10-30分钟的数据（增量）备份，这样，当DBMS上的数据被恶意删除（并且被同步到了slave），或者出现掉电文件系统corrupt的情况，备份就是你可耐的七舅老爷。</p><br><p>但是，备份一定不要仅仅放在本地，请务必存储在某个靠谱的，像S3这样的自带数据冗余的云存储服务上。这样的服务一般是把一份数据分成N个切片存在不同的物理位置，只要其中K个切片可用，就能还原出文件。基本上，存储在类似的系统上的文件可以认为是不会丢失的。当然，关键性的数据最好分级备份甚至线下备份，AWS就为此提供了glacier这样的慢速存储，存储空间几乎无限，价格便宜（S3的1/3），但如果想从中恢复数据，需要几个小时数据才能准备好（因此有wikipedia上有推断glacier是用tape，或者blue ray disk这样的离线方式存储数据）。</p><br><p>陈旧的备份的数据也可以定期清除，节省开销。</p><br><h3>安全</h3><br><p>一个好的云服务商不仅仅要为你提供合适的计算能力和存储能力来部署你的应用，还需要提供某些安全保障。我们看AWS提供了哪些安全手段。</p><br><p>首先是IAM（Identity and Access Management），也就是身份可权限管理系统。安全的首要原则是least previlige。就像你永远不该使用root来访问一台远程设备（最好disable root）一样，当你访问一个云提供商，你也不应该将初始账户（相当于root）分享给每个团队成员使用，你应该为每个不同的角色创建不同的账号（如果云提供商提供这样的功能，如果没有，你的云提供商需要重新学习security 101），提供最低的访问权限。比如说，devops可以控制production环境，但dev/qa不能。不但权限分离，任何操作都要有可以用于事后审计的log：谁在哪一天做了什么操作（比如说创建了一个instance，谁disable了某个服务），需要一清二楚。</p><br><p>其次是内外网分离。绝大多数情况下，你的大部分服务器，如database，是不需要暴露在公网上的。你最好部署一个（至多个）拥有公网IP的load balancer（LB），类似于AWS的ELB（Elastic Load balancer），将你N-tier的应用隐藏在LB之后。这样，除了对外的LB之外，其他服务器均在一个内网之内，没有公有IP，阻断黑客直接入侵的可能。</p><br><p>当然你的团队需要访问这些服务器。你可以在网络的边界部署跨内外网的服务器，可以以这台服务器为跳板，登入同一个子网内的内网的其他服务器。更安全的方式是设置openVPN，通过SSLVPN的方式接入到内网，从而访问这些设备（详细信息请参考我之前的文章：应用开发中的网络安全）。</p><br><p>之后你需要认真考虑网络的访问权限，设置物理的或者虚拟的防火墙。AWS的Security Group（SG）就是这样一个简单的基于ACL（Access List）的防火墙，你可以在这个级别设置允许流入流出的端口，以及源IP地址。当然，在服务器的iptables里，你也需要做相应的设置。安全是有层级的，不能打造了个无比强硬的门就高枕无忧了：城外的地壕，护城河，城墙，城内的翁城都是要配置的。</p><br><p>这一切还不够，按照你的开发部署流程，你很可能需要dev环境，staging环境（QA testing），还有production的环境，每套按照上面的定义，都各自有不同的安全标准和访问许可。在AWS里，VPC（Virtual Private Cloud）可以很方便地帮你定义出这些环境，你的云服务商最好也有相同的概念，或者你通过划分子网（和子网的访问权限），自行提供简单的隔离。</p><br><h3>服务可伸缩</h3><br><p>很多人言及AWS，谈到的首先是EC2的auto scaling。scaling不是简单的computation scale up/out的概念，而是一揽子解决方案。在考虑scaling之前，最好先把基本的容灾（起码备个份），和安全（行行好，最起码不要把你的数据库裸奔在公网上，不要直接用密码登陆你的ssh服务器等等）做好，有了这个基础，再谈scaling。没有容灾和安全的scaling，就像在地震活跃带，打个浅浅的地基，盖了一个没有门没有窗，四处透风的摩天大厦。</p><br><p>AWS提供几个层面的scaling：</p><br><ul><li><p>Computation：EC2 auto scaling。配合ELB，可以让服务的计算能力随业务需求自动增减。</p></li><li><p>Storage：S3可以认为是一个无穷大的，访问时间恒定的storage。</p></li><li><p>Database：无需做任何管理，只需关心业务逻辑和配额的dynamodb（NoSQL）；以及需要基本的管理（但不需要做打patch这样的事）的RDS（Relational）。</p></li><li><p>SQS：无需任何管理，可以认为容量无限大，访问速度恒定的Message Queue</p></li><li><p>Cache：需要一定管理的Elastic Cache（使用memcached或redis）</p></li></ul><p>这基本上是不需要大数据处理，不需要流媒体处理，不需要machine learning的应用的基本服务了（AWS都有对应的服务）。当然，在早期的产品里，面临的scaling的问题还主要集中在web/app server和database server上，你更多地考虑在LB后面根据需要在不同的AZ下放置更多的web/app server（如果你的云服务商能够做auto scaling再好不过，没有在早期也不是大事），然后数据库除了跨AZ的Master/Slave的配置外，加上若干个Read replica。一写多读能应付大部分scaling的需求，除非你的应用是特殊的，写多读少的应用（此时考虑那些专门设计的，优先写速度的数据库服务器，如cassandra）。</p><br><p>再往后的scaling，其实主要也是在数据层面腾挪：静态资源放CDN，session store使用ElastiCache或者DynamoDB，某些复杂的查询结果塞到ElastiCache里减少对数据库的请求；然后数据库进一步切分，根据读写的量级，把不同量级的表独立在不同的数据库，然后对读写频繁的设置更多的read replica。这个一个数据库切分多个数据库，运行在不同的replica set里。</p><br><p>走过了这一步，如果数据层面无法换或者不想换DynamoDB，依旧使用RDS，AWS能帮你的也不多了。接下来就是应用程序的切分。应用的不同部分也许可以通过queue decouple，然后每个独立发展，独立scale out，就像数据库所做的那样。这便是所谓的micro service，或者service oriented architecture（SOA）。AWS提供了SQS帮你完成这个变化，如果你的云服务商没有类似的能力，也可依服务的需求部署kafka（没用过），rabbitmq等消息队列和消息分发软件。</p><br><p>再往后，用户还在疯涨，如果你已经成功切换到DynamoDB，那么只需要提供更多的读写配额，让AWS替你scale out，但如果还对SQL DB不离不弃，就要走数据库表的sharding，不过这个时候，你可能已经接近于下一个instagram了。所以，即便切表切得肉疼，心情还是舒爽的，任何问题都不过相当于躺在马尔代夫的沙滩椅上吹着海风，看着比基尼，享受精油按摩的时候，被不开眼的蚊子叮了个包而已。</p><br><p>稍微多说两句DynamoDB。DynamoDB是AWS的私有技术，不过Amazon publish相关的paper，催生了riak这样带着同样理念的开源产品。按照我粗浅的理解，这类可以无限扩容的NoSQL数据库，其核心是consistent hashing：</p><br><img src="https://pic2.zhimg.com/7915102762ae744d87ad8f7261035fc3_r.jpg" data-rawwidth="715" data-rawheight="505"><br><p>consistent hashing的概念是我有一个足够大的keyspace（2的160次方，比较一下：IPv6是2的128次方），我们记作X，然后将X放在一个环形的空间里划分成大小相等的Y个partition，依次循环排列（如图），每个partition由一个vnode（riak的概念）管理，当你有M个database server（node），Y个vnode再平均映射到M个node上。当数据要插入时，将其主键（hash key）映射到K中的一个地址（addr），对应到某个vnode，再进一步对应到某个node，如果这个数据需要N个replica，则将数据写入addr（vnode a），addr + 1（vnode b）， …​，add + N（vnode n）。在这种设置下，M就是你的shards，N是replica。以后添加新的node时，映射发生变化，只需要把相应的变化了的vnode迁移到新的node上即可。在这种结构下，sharding/replica对程序员基本上是透明的。</p><br><p>所以看AWS的解决方案，想想它为何提供这样的工具，有助于我们思考自己的application的架构，以及在不得已的情况下，寻找替代产品。</p><br><h3>其他</h3><br><p>monitoring是application必不可少又被忽略的东西。AWS提供了cloudwatch，基本功能包括CPU/IO/network/memory等系统层面的tracking，以及服务可达性（从DNS到LB，LB到web server等的监控），你还可以加入应用相关的monitor，让cloudwatch统一处理。在这一块上，可替代的工具很多，可以去awesome-sysadmin里面寻找答案（monitoring和metric collection分类下面）。</p><br><p>logging和monitoring一样，也常常被忽略。分布式系统最令人头疼的就是log散布各处，所以你需要一个集中管理的工具。AWS没有提供类似的解决方案。比较成熟的是ELK（Elasticsearch + Logstash + Kibana），还有fluentd + elasticsearch + kibana的变种。也可以在awesome-sysadmin的log分类下找。</p><br><p>configuration management和deployment这块AWS从高到地分别提供了CodeDeploy，ElasticBeanstalk，OpsWorks，以及cloud formation，涵盖应用级的部署一直到用代码来一行行控制的部署脚本。你自己可以使用ansible，chef这样的配置管理工具。</p><br><p>AWS的CloudSearch可以用开源的ElasticSearch替代，SNS可以用pusher这样的第三方pub/sub + push notification的工具很方便地一对多发布数据。</p><br><p>哗啦啦说了不少，就先这样吧。总结一下对应关系：</p><br><ul><li><p>EC2：你的云服务商的VM</p></li><li><p>ECS：你的云服务商的docker容器，或者自己构建</p></li><li><p>RDS：MySQL/Postgres</p></li><li><p>DynamoDB：riak</p></li><li><p>ElastiCache：memcached/redis</p></li><li><p>S3：我觉得你还是可以用S3作为备份方案的，国内也有不错的某某云存储</p></li><li><p>SQS：RabbitMQ，Kafka</p></li><li><p>Route 53：DNSPod（好吧我相信大部分人用这个，所以不算广告了）</p></li><li><p>IAM/VPC/SG：不要含糊，如果云提供商没有，考虑在适当的时候构建你自己的</p></li><li><p>CloudWatch：Riemann或者其他</p></li><li><p>CloudSearch：ElasticSearch</p></li><li><p>CodeDeploy，ElasticBeanstalk，OpsWorks，以及cloud formation：ansible / puppet / chef等</p></li><li><p>SNS：pusher</p></li><li><p>SES：sendgrid/mailgun，或者国内类似的邮件服务商</p></li><li><p>Elastic Mapreduce：hadoop</p></li><li><p>Machine learning：PredictionIO（这货是个开源软件，我以后专门辟文介绍）</p></li></ul><p>如果您觉得这篇文章不错，请点赞。多谢！</p><br><p>欢迎订阅公众号『程序人生』（搜索微信号 programmer_life）。每篇文章都力求原汁原味，北京时间中午12点左右，美西时间下午8点左右与您相会。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
