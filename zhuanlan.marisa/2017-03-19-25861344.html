<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MPS教程一：环境搭建+试运行一个语言</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/25861344">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-17c4b2615b28cff750d492582aa43c98_r.png" alt=""></div><p>本文高能，弱者慎入</p><h2>MPS是什么</h2><p>我们来看看Infoq上对MPS的介绍：</p><p>MPS提供的软件开发环境可以创建新的定制语言，也可以扩展现有语言，然后用它们开发面向领域的应用。MPS还可以定义新语言的类型系统、约束和专门的编辑器。MPS用一棵抽象句法树（AST）来维护代码。 AST由节点组成，节点又包含属性、子节点和引用，程序代码就靠 AST和这些节点完整地表达出来。创建新语言的时候，开发者定义代码编排和表达的规则，还可以规定语言类型系统的组成元素。 MPS凭借这些规则即时检查程序代码，减少用新语言编程的出错机会。MPS还采用了代码生成的办法：用新语言在更高的层次上表达，然后MPS生成Java、XML、HTML、JavaScript等语言的可编译代码。 用MPS建立新语言的时候，必须从BaseLanguage扩展。MPS已经提供了一些常用的BaseLanguage扩展，协助开发者处理字符串、容器、日期、正则表达式等语言成分。</p><p>MPS采用的编辑器不是文本编辑器，而是<strong>破界神编辑器(Projectional Editor)</strong>。请原谅我使用这么中二的音译，但是之前的各种翻译（例如结构化编辑器）我觉得都太2了，于是我决定使用自己的翻译。</p><p>破界神编辑器是一个将序列化的AST根据语言创建者的意愿渲染为类似代码形式的编辑器，然后语言的用户编辑代码（编辑的过程和普通的文本代码编辑体验是不同的，这个虽然有点不同，但是习惯了之后会感觉爽的多），并实时地将编辑保存为AST。在文件系统里，AST是序列化的xml。</p><p>也就是说，MPS的开发过程比起普通的文本代码编辑要少了一个巨大巨复杂的步骤——Parsing。</p><p>破界神编辑是一把双刃剑。官方Tutorial说：</p><blockquote><p>Advantage:<br>in less than a week of programming in the MPS editor people typically get back to their full speed of coding they experienced before in text-based IDEs<br><br>Disadvantage:<br>projectional editing is highly addictive and you may ﬁnd text-based editors less compelling and less helpful than you thought they’d been before</p></blockquote><p>所以见仁见智了。而且MPS是开源的，如果你想要一个自己的MPS，完全可以去魔改。MPS是Apache v2.0协议的。</p><h2>本文使用的MPS版本</h2><p>截止本文最后一次编辑，本文及本文提到的项目都使用MPS EAP 2017.1。如果正式版出了那就使用正式版吧。</p><p>其实讲的内容都差不多，只是本文涉及一个项目，你需要使用和它使用的相同的MPS版本。我会在该项目README里面注明的。请以项目README为准。</p><h2>学习MPS需要的知识基础</h2><ul><li>对编译原理有少量的了解</li><li>对JetBrains IDE常用快捷键高度熟悉（因为破界神编辑器）</li></ul><p>以上两者都可以在学习MPS的时候顺便学习。</p><h2>依赖</h2><ul><li>Git（为了下载项目）</li><li>MPS EAP 2017.1</li><li>编译原理相关初级知识储备</li></ul><p>这里给出一份<a href="https://www.jianguoyun.com/p/DVPhGtYQl_iYBhjAoyg" data-editable="true" data-title="MPS EAP 2017.1的Windows binary的下载链接">MPS EAP 2017.1的Windows binary的下载链接</a>，方便那群网络不好的家伙。</p><p>下载好MPS之后先clone这个项目，等会要用：</p><br><code lang="text">git clone https://github.com/ProgramLeague/ShapeBuilderLanguage.git
</code><p>clone完之后，确认项目目录有如下结构：</p><br><code lang="text">root:
  - languages:
    - ShapeLang:
      - ShapeLang.mpl
  - solutions:
    - Sample:
      - Sample.msd
</code><p>其他文件暂时不管。然后安装MPS，并打开。</p><p>点击Create New Project，我们选择一个Empty Project。如下图所示：</p><img src="https://pic2.zhimg.com/v2-8f35eb9ccb71eb5fe62ce1ef64d8b973_r.png" data-rawwidth="793" data-rawheight="413"><p>然后打开最左边Project选项卡的Logical View，选择Test，右键，点击最下面那个选项：<img src="https://pic4.zhimg.com/v2-95ef48b7cb9d09488e07cbb41f198b2a_r.png" data-rawwidth="496" data-rawheight="414"></p><p>然后点击弹出的窗口最右边的绿色+符号，选择刚才你clone项目里面的ShapeLang.mpl文件。然后OK。</p><p>现在你就成功导入ShapeLang这门语言了，可以在下面的Modules Pool的Languages里面看到。</p><h2>准备工作</h2><p>你需要一个纯英语输入的输入法。目的是，等会你需要大量使用Ctrl+Space这个快捷键，一般情况下中文输入法会冲突。</p><h2>将这门语言导入MPS</h2><p>首先右键Test-&gt;New-&gt;Solution。我们在New界面可以看到三个选项：</p><p>Solution       <strong>使用语言</strong>的东西，我们可以称之为<strong>项目</strong></p><p>Language    语言</p><p>DevKit         暂时不管</p><p>我们新建一个Solution ，随便起个草率的名字就好。</p><p>然后右键这个Solution，点击最下面的Module Properties，打开Dependency选项卡，添加这些依赖：<img src="https://pic2.zhimg.com/v2-be136b5171ee18f94337081bfc919825_r.png" data-rawwidth="766" data-rawheight="613"></p><p>然后再给这个Solution新建一个Model。右键它，New-&gt;Model。<img src="https://pic3.zhimg.com/v2-842e40e1e8cdb745253a07f0d72238e3_r.png" data-rawwidth="1043" data-rawheight="168"></p><p>然后给它起个名字。注意，名字必须是合法的Java包名。<img src="https://pic2.zhimg.com/v2-618badd0c649c1221858d2ad9b1d4f5b_r.png" data-rawwidth="534" data-rawheight="296"></p><p>然后这时会弹出一个config的窗口，打开Used Language选项卡，加入这两个依赖。<img src="https://pic3.zhimg.com/v2-de9d32a302f08a83fddc6e6a08f63e68_r.png" data-rawwidth="682" data-rawheight="475"></p><p>ShapeLang是等会我们用来编程的东西，baseLanguage是Java的MPS版。</p><h2>开始编程</h2><p>我们需要创建一个Canvas，如下所示：<img src="https://pic4.zhimg.com/v2-eccd26fae731896543db5036d4384286_r.png" data-rawwidth="955" data-rawheight="281"></p><p>然后你可以看到编辑器里面出现了这样的东西：<img src="https://pic1.zhimg.com/v2-4f87408b5258c88fe9fd8a4faeeb6695_r.png" data-rawwidth="524" data-rawheight="181"></p><p>我们在空缺处填上必要的信息。注意，你此时可以感受到破界神编辑器和文本编辑器的不同之处。这时你需要记下这几个快捷键：</p><p>Ctrl+Space        补全（有些东西必须靠这个才能输入）</p><p>Alt+Enter           查看提示、建议</p><p>Ctrl+W               扩散选中</p><p>Ctrl+Shift+W      反扩散选中</p><p>Tab                     进入AST下一个节点</p><p>Shift+Tab            进入AST上一个节点</p><p>Ctrl+F9               构建项目。是增量的</p><p>Shift+F10            运行刚才运行过的文件</p><p>可以试试Ctrl+Space的功能：弹出补全。<img src="https://pic2.zhimg.com/v2-e1dd8fd8e2530936f1d6cbe908aa1464_r.png" data-rawwidth="547" data-rawheight="196"></p><p>我们在下面那个</p><br><code lang="text">&lt;&lt; ... &gt;&gt;
</code><p>处使用Ctrl+Space，可以看到弹出一些补全。当然，我们也可以直接使用类似Live Template的功能：在编辑区输入rect/circle/square/text，你可以看到弹出了一堆东西，根据你的直觉填写相应的信息。回车之后可以输入下一个东西，建议广泛使用Ctrl+Space，以及Tab。<img src="https://pic2.zhimg.com/v2-cffe7194d538e1c92bbea05546db8dd6_r.png" data-rawwidth="819" data-rawheight="395"></p><p>好了，现在构建这个项目。Ctrl+F9。<img src="https://pic4.zhimg.com/v2-93743a7624106e333473ec008986c873_r.png" data-rawwidth="776" data-rawheight="159"></p><p>然后运行它。在文件树右键这个NiceMPS，点击Run开头的那一项。然后就可以看到运行结果了：<img src="https://pic3.zhimg.com/v2-868b292b00a7d45621d2099a0c885634_r.png" data-rawwidth="1659" data-rawheight="555"></p><p>好了，你现在还可以再多折腾一下这个语言。你可以看到编辑区的颜色预览，不合法的数字报错（在width height那些地方输入负数）。这些都是MPS定制出来的。</p><h2>第一篇教程就结束了？</h2><h2>不讲讲定义语言什么的吗？</h2><p>没错，结束了。同学们再见。</p><p>为什么知乎的编辑器这么垃圾？我粘贴了图片，编辑的时候看得到，然后发布出来就没有了！</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
