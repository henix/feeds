<div class="title-image"><img src="https://pic3.zhimg.com/v2-1fcfe1faf796c560af7494590c777f2f_b.jpg" alt=""></div><blockquote>本文基于最近两天在推上和社区的朋友互动而引发的思考。</blockquote><h2><b>起因</b></h2><p>Rust Tg群的群主在2号发推，说他看到有人在Rust的过程宏中下载文件。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-d99b142cf1fb440f18389a8dd5b67068_b.jpg" data-caption="" data-size="normal" data-rawwidth="1284" data-rawheight="1108" class="origin_image zh-lightbox-thumb" width="1284" data-original="https://pic1.zhimg.com/v2-d99b142cf1fb440f18389a8dd5b67068_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-d99b142cf1fb440f18389a8dd5b67068_b.jpg" data-caption="" data-size="normal" data-rawwidth="1284" data-rawheight="1108" class="origin_image zh-lightbox-thumb lazy" width="1284" data-original="https://pic1.zhimg.com/v2-d99b142cf1fb440f18389a8dd5b67068_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-d99b142cf1fb440f18389a8dd5b67068_b.jpg"/></figure><p>我询问以后发现是这个crate：<a href="https://link.zhihu.com/?target=https%3A//github.com/addr-rs/addr" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/addr-rs/addr</span><span class="invisible"></span></a> </p><p>我仔细查看后发现，该库是用来做电子邮件域名有效性验证的。它使用了Mozilla的<a href="https://link.zhihu.com/?target=https%3A//publicsuffix.org/" class=" wrap external" target="_blank" rel="nofollow noreferrer">公共后缀列表（Public Suffix List）</a>可靠地解析Rust中的域名和电子邮件地址。</p><p>该库在Readme里写道：</p><blockquote>可以通过设置环境变量PSL_URL或PSL_PATH来提供自己的列表。如果您不提供自己的列表，将在构建期间从官方站点下载一个列表。</blockquote><h2><b>重点</b></h2><p>重点在于文档里说的「构建期间」是在一个过程宏中完成的下载，它会从Mozilla下载了一个207k的邮件域名后缀文件，也就是PSL。</p><p>查看其源码：</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-7321ff26022333acbc408e4a58fe08ce_b.jpg" data-caption="" data-size="normal" data-rawwidth="3182" data-rawheight="1528" class="origin_image zh-lightbox-thumb" width="3182" data-original="https://pic3.zhimg.com/v2-7321ff26022333acbc408e4a58fe08ce_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-7321ff26022333acbc408e4a58fe08ce_b.jpg" data-caption="" data-size="normal" data-rawwidth="3182" data-rawheight="1528" class="origin_image zh-lightbox-thumb lazy" width="3182" data-original="https://pic3.zhimg.com/v2-7321ff26022333acbc408e4a58fe08ce_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-7321ff26022333acbc408e4a58fe08ce_b.jpg"/></figure><p>这个codegen就是定义过程宏的crate，其中的process方法中就调用了在lexer包中封装好的fetch方法开始下载文件（如果没有本地列表的话）。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-a0d7ea8aab6e4ce5faad69121c07c214_b.jpg" data-caption="" data-size="normal" data-rawwidth="3266" data-rawheight="1430" class="origin_image zh-lightbox-thumb" width="3266" data-original="https://pic1.zhimg.com/v2-a0d7ea8aab6e4ce5faad69121c07c214_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-a0d7ea8aab6e4ce5faad69121c07c214_b.jpg" data-caption="" data-size="normal" data-rawwidth="3266" data-rawheight="1430" class="origin_image zh-lightbox-thumb lazy" width="3266" data-original="https://pic1.zhimg.com/v2-a0d7ea8aab6e4ce5faad69121c07c214_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-a0d7ea8aab6e4ce5faad69121c07c214_b.jpg"/></figure><p>然后在lexer包中查看fetch的定义，看到的是调用了另一个封装好的from_url方法发起具体的下载请求。</p><h2><b>反思</b></h2><p>这代码写的还不错，组件职责分离，逻辑清晰，封装到位，很符合Rust的最佳实践。</p><p>就这个库而言，作者是想让用户有更完善的体验。在本地没有现成的PSL列表，就从官方帮助你下载一个。并且下载获取的数据，在宏里面也是需要用到的。这个可能不方便使用build script。</p><p>但是话说回来，在宏里下载文件，这样的脑洞，恐怕是打开了「潘多拉魔盒」。</p><p>这个addr crate的作者并没有恶意，并且很明确地在Readme里告诉你这个库的行为是什么样的。</p><p>但是，万一换个其他人呢？</p><p>能下载一个简单的文件，就可以下载其他更复杂的文件，或者是恶意文件。能下载，意味着也可以上传，意味着你可以执行某些设计好的指令（假如某些服务器的安全权限没设置好）。只要想象力丰富，在Rust的过程宏里，也许可以做出更多坏事。</p><p>不是我们要恶意揣测别人，而是，这个世界就是这么危险。</p><h2><b>对策</b></h2><p>所以，我们在使用Rust第三方库的时候，需要一些安全建议：</p><ol><li>尽可能地使用知名的库。更多的人star，更多的人参与贡献。这样的库比较安全。</li><li>在使用像Addr这种star数很少的库时，需要仔细审查它的源码。（查看宏展开，推荐cargo expand插件，也有其他的插件）</li><li>然而，你可以查看一个crate的安全性，但是你很难查看它依赖的crate是否安全。这个时候就推荐使用<a href="https://link.zhihu.com/?target=https%3A//github.com/dpc/crev" class=" wrap external" target="_blank" rel="nofollow noreferrer">cargo crev</a>。</li></ol><p>重点介绍一下Crev工具。该工具可以判断你项目中依赖crate的安全性、质量和发现的问题。可以在公共的git仓库里发布可验证的review信息。通过这种方式期望在Rust生态系统中构建可信任的网络。将不会有人再受到未经审查和不受信任代码的困扰。<br/><br/>想想npm因为依赖包出了多少次安全事故。这个工具貌似不错，现在维护也非常积极。<br/><br/>使用方法：<br/></p><div class="highlight"><pre><code class="language-rust"><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">&lt;</span><span class="n">your</span><span class="o">-</span><span class="n">project</span><span class="o">&gt;</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="n">gen</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">id</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">verify</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">verify</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">depedencies</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">review</span><span class="w"> </span><span class="o">&lt;</span><span class="k">crate</span><span class="o">&gt;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">review</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">dependency</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">proof</span><span class="w"> </span><span class="n">database</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">ci</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">commit</span><span class="w"> </span><span class="n">everything</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">git</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">push</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">github</span><span class="w"> </span><span class="n">repository</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">trust</span><span class="w"> </span><span class="o">&lt;</span><span class="n">id</span><span class="o">&gt;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">trust</span><span class="w"> </span><span class="n">someone</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">given</span><span class="w"> </span><span class="n">CrevId</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">fetch</span><span class="w"> </span><span class="n">updates</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">people</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">trust</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">verify</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">verify</span><span class="w"> </span><span class="n">again</span><span class="w">
</span><span class="w"></span><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">crev</span><span class="w"> </span><span class="n">help</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">things</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="kr">do</span><span class="w">
</span></code></pre></div><p><br/>其中id是可以通过 <a href="https://link.zhihu.com/?target=https%3A//gitter.im/dpc/crev" class=" wrap external" target="_blank" rel="nofollow noreferrer">crev gitter channel</a> 来共享给大家的，形成信任网络。然后可以通过  <code>cargo crev trust &lt;id&gt; </code>命令从你信任的人那里获取依赖crate。<br/><br/>当然，这世界上没有绝对的安全，但也无法阻碍人们追求它的脚步。</p><p></p><p></p><p></p><p></p>