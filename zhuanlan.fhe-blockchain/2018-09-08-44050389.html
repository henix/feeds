<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>最清晰的比特币白皮书解析4－网络</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/44050389">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-d77484395746a6d77e841733fb50dcd3_r.jpg" alt=""></div><p><b>5. 网络</b></p><p>白皮书前面说了，为了构造一个分布式时间戳，需要对一个区块去求解满足要求的哈希值。求解哈希值时，唯一可以调整的参数是随机数（nounce）。交易就存放在这个区块里。那么问题就来了，各个节点是如何收到交易的呢？如何把交易放到区块里呢？所有这一切都是依赖于互联网的。这节就讲了交易如何在网络中的传播以及如何形成区块。</p><p>白皮书第一段如下：</p><p>The steps to run the network are as follows: </p><p>. 1)  New transactions are broadcast to all nodes.  </p><p>. 2)  Each node collects new transactions into a block.  </p><p>. 3)  Each node works on finding a difficult proof-of-work for its block.  </p><p>. 4)  When a node finds a proof-of-work, it broadcasts the block to all nodes.  </p><p>. 5)  Nodes accept the block only if all transactions in it are valid and not already spent.  </p><p>. 6)  Nodes express their acceptance of the block by working on creating the next block in the  chain, using the hash of the accepted block as the previous hash.  </p><p> 比特币网络运行的步骤如下： </p><p>1) 新的交易通过全网向所有节点广播； </p><p>2) 每一个节点将收到的新的交易信息放入一个区块中； </p><p>3) 每个节点都为自己的区块执行工作量证明，以发现一个满足难度要求的哈希值；</p><p>4) 当一个节点发现了一个满足难度要求的哈希值，它就向全网进行广播该区块； </p><p>5) 当且仅当包含在该区块中的所有交易都是有效的且之前没有双花过，其他节点才接受承认该区块； </p><p>. 6) 其他节点接受该区块后，就在该区块之后制造新的区块以延长该链条。并将被接受区块的哈希值写入新区块中前一区块哈希值（previous hash  </p><p>）的位置。 </p><p>上述过程把交易的传播和块的形成，描述的非常简洁和清楚。由于网络的传播是有时延的，如果两个节点同时广播自己的区块，那么有些节点可能收到的是这个区块，另外节点可能收到的是另一个区块，那么就会造成链的分叉，如何处理呢？</p><p>白皮书紧接着说</p><p>Nodes always consider the longest chain to be the correct one and will keep working on extending it. If two nodes broadcast different versions of the next block simultaneously, some nodes may receive one or the other first. In that case, they work on the first one they received, but save the other branch in case it becomes longer. The tie will be broken when the next proof- of-work is found and one branch becomes longer; the nodes that were working on the other branch will then switch to the longer one. </p><p>所有节点都将最长的链条视为正确的链条，并在最长的链条上继续工作从而延长它。如果有两个节点同时广播了不同的新区块，那么先收到哪个新区块，对于有些节点是有差异的。在此情况下，节点将在自己收到的第一个新区块上进行工作，但也会保留另外一个产生分叉的链，以防后者变成最长的链。当下一个新区块诞生后，其中一个链将会被延长，从而分叉的局面被打破。而在另一条链上的节点将转移到最长链上工作。</p><p>到这里有个问题，原本以为节点不知道除了自己工作的链以外还有其它的分支链。但是从上面的叙述可知，当出现分叉的时候，节点会知道有分叉出现的，而且还会保存另外的分叉链，以备将来转换。</p><p>交易在网络中的广播，是不是必须所有节点都收到后才可能被装入到新区块中（注意新区块诞生的方法）？同样，新区块的广播是不是所有节点都必须收到才可以，如果新区块在传播过程中丢失了，有的节点没收到怎么办？白皮书下面说了这个问题。</p><p>New transaction broadcasts do not necessarily need to reach all nodes. As long as they reach many nodes, they will get into a block before long. Block broadcasts are also tolerant of dropped messages. If a node does not receive a block, it will request it when it receives the next block and realizes it missed one. </p><p>新交易在广播过程中，未必需要到达全部的节点。只要它们能够到达大多数的节点，那么这些新交易很快会出现在链上的一个新区块中。为什么呢？因为大多数节点收到了新交易，那么节点挖出区块的概率也会以极大的可能落到大多数节点中的某个节点。所以很快该新交易就会出现在链上。如果挖出区块的节点碰巧不在这些大多数节点中，那么该新交易就不会出现在链上的新区块中。但是同样以极大的概率出现在下一个新区块中。</p><p>而区块的广播对于传播过程中丢失区块也具有容错能力。如果一个节点没有收到新区块，那么该节点在收到新区块之后的区块到来时，将会发现自己缺少前一个区块，从而会请求接收那个缺少的区块。</p><p>以上给出了交易和区块在网络中广播可能出现的一些情况及对策。但是细节并没有讲到，只是给出了大致的框架。如果学过计算机网络原理，对以上的过程就不会陌生。根据一些资料显示，比特币网络采用的是P2P网络架构，节点之间连接使用的是TCP协议。TCP协议是一种面向连接的可靠协议，它具有处理网络丢包，重传，校验等功能。</p><p>文章首发在微信公众号：btc201800</p><p><a href="https://link.zhihu.com/?target=http%3A//weixin.qq.com/r/GC8UDDjEjmXxrXxv93oK">http://weixin.qq.com/r/GC8UDDjEjmXxrXxv93oK</a> (二维码自动识别)</p><p>相应的音频，已发布到喜马拉雅“解读区块链白皮书”上，欢迎收听。</p><p><a href="https://link.zhihu.com/?target=http%3A//m.ximalaya.com/42927243/sound/119777482">http://m.ximalaya.com/42927243/sound/119777482</a>(二维码自动识别) </p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
