<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>通过GitHub官方白帽工具，我找出了10个0day==&gt;CodeQL</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/92769710">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-9daa63241cc1e8575a3bfca8da4a8f57_b.jpg" alt=""></div><p>随着共享开源社区的不断发展，越来越多的开源软件出现在我们的视野中，很多 IT 从业人员或多或少都有与开源软件接触或使用开源软件。</p><blockquote>开源社区 又称 开放源代码社区，一般由拥有共同兴趣爱好的人所组成，根据相应的开源软件许可证协议公布软件源代码的网络平台，同时也为网络成员提供一个自由学习交流的空间。由于开放源码软件主要被散布在全世界的编程者所开发，开源社区就成了他们沟通交流的必要途径，因此开源社区在推动开源软件发展的过程中起着巨大的作用。</blockquote><p>有人可能会问：<b>开源软件安全吗？</b></p><blockquote>没有绝对安全的系统。</blockquote><figure data-size="small"><noscript><img src="https://pic4.zhimg.com/v2-b9125e78418fc6507509a3a11254b06b_b.jpg" data-caption="" data-size="small" data-rawwidth="600" data-rawheight="337" class="origin_image zh-lightbox-thumb" width="600" data-original="https://pic4.zhimg.com/v2-b9125e78418fc6507509a3a11254b06b_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-b9125e78418fc6507509a3a11254b06b_b.jpg" data-caption="" data-size="small" data-rawwidth="600" data-rawheight="337" class="origin_image zh-lightbox-thumb lazy" width="600" data-original="https://pic4.zhimg.com/v2-b9125e78418fc6507509a3a11254b06b_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-b9125e78418fc6507509a3a11254b06b_b.jpg"/></figure><p>任何程序、系统都会存在漏洞，开源软件也不例外。如果你恰好使用某个软件，恰好它爆出了 CVE 高危，你该怎么办？</p><p>作为全球最大的代码开源社区，Github 在世界范围内拥有极高的影响力。</p><blockquote>GitHub 是一个面向开源及私有软件项目的托管平台，因为只支持 git 作为唯一的版本库格式进行托管，故名 GitHub。作为开源代码库以及版本控制系统，Github 拥有超过900万开发者用户。随着越来越多的应用程序转移到了云上，Github 已经成为了管理软件开发以及发现已有代码的首选方法。</blockquote><p>GitHub 当然不允许这样的事件发生，官方成立了专门的针对开源软件的安全实验室，共同寻找、抵御这些安全漏洞。</p><p>GitHub 安全实验室：<a href="https://link.zhihu.com/?target=https%3A//securitylab.github.com/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">securitylab.github.com/</span><span class="invisible"></span></a></p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-140da2a12fe18a40ec18d2d3243247ea_b.jpg" data-caption="" data-size="normal" data-rawwidth="1118" data-rawheight="566" class="origin_image zh-lightbox-thumb" width="1118" data-original="https://pic3.zhimg.com/v2-140da2a12fe18a40ec18d2d3243247ea_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-140da2a12fe18a40ec18d2d3243247ea_b.jpg" data-caption="" data-size="normal" data-rawwidth="1118" data-rawheight="566" class="origin_image zh-lightbox-thumb lazy" width="1118" data-original="https://pic3.zhimg.com/v2-140da2a12fe18a40ec18d2d3243247ea_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-140da2a12fe18a40ec18d2d3243247ea_b.jpg"/></figure><h2>CodeQL🪐</h2><p>当然，我们今天的主角就出自这里，来自 GitHub 的代码分析工具 CodeQL。</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-bb6c475a454be25f7fba9cbf7c9a2053_b.jpg" data-caption="" data-size="normal" data-rawwidth="1140" data-rawheight="435" class="origin_image zh-lightbox-thumb" width="1140" data-original="https://pic4.zhimg.com/v2-bb6c475a454be25f7fba9cbf7c9a2053_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-bb6c475a454be25f7fba9cbf7c9a2053_b.jpg" data-caption="" data-size="normal" data-rawwidth="1140" data-rawheight="435" class="origin_image zh-lightbox-thumb lazy" width="1140" data-original="https://pic4.zhimg.com/v2-bb6c475a454be25f7fba9cbf7c9a2053_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-bb6c475a454be25f7fba9cbf7c9a2053_b.jpg"/></figure><blockquote>使用行业领先的语义代码分析引擎 CodeQL 发现整个代码库中的漏洞。使用 CodeQL，你可以像对待数据一样查询代码。编写查询以查找该漏洞的所有变体，并永久消除它。然后分享你的查询，以帮助其他人也这样做。</blockquote><p>使用的是一种查询语言 —— QL，支持对 C++，C#，Java，Python，JavaScript 等多种语言进行分析，可用于分析代码，查找代码中控制流等信息。</p><h2>原理&amp;使用⭐（环境：Windows）</h2><p>最新版的下载地址：<a href="https://link.zhihu.com/?target=https%3A//github.com/github/codeql-cli-binaries/releases/download/v2.0.0/codeql.zip" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/github/codeq</span><span class="invisible">l-cli-binaries/releases/download/v2.0.0/codeql.zip</span><span class="ellipsis"></span></a></p><p>然后需要参考官方文档</p><p>CodeQL CLI文档：<a href="https://link.zhihu.com/?target=https%3A//help.semmle.com/codeql/codeql-cli.html" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">help.semmle.com/codeql/</span><span class="invisible">codeql-cli.html</span><span class="ellipsis"></span></a></p><p><b>CodeQL 是如何工作的？</b></p><p>可以通过生成 CodeQL 数据库（即包含表示一种语言的特定版本的源代码的数据的目录）来准备要分析的代码库。创建数据库后，可以通过对数据运行一个或多个查询来对其进行分析。在 CodeQL 存储库中有很多开源查询可供选择探索。总体分三步：</p><p><b>首先，创建一个数据库</b></p><p>为了创建数据库，CodeQL 首先提取代码库中每个源文件的单个关系表示。</p><p>对于编译语言，提取通过监视正常的构建过程来起作用。每次调用编译器来处理源文件时，都会创建该文件的副本，并且有关源代码的所有相关信息（例如，有关抽象语法树的语法数据，诸如名称绑定和类型信息之类的语义数据）都会被生成集。</p><p>对于解释型语言，提取器直接在源代码上运行，解析依赖项以给出代码库的准确表示。 CodeQL 支持每种语言有一个提取器，以确保提取过程尽可能准确。对于多语言代码库，一次生成一种语言的数据库。提取后，将分析所需的所有数据（关系数据，复制的源文件以及特定于语言的数据库模式，该模式指定数据中的相互关系）导入单个目录中，该目录称为 CodeQL 数据库。</p><p><b>然后，运行查询</b></p><p>CodeQL 分析包括两个步骤。首先，针对数据库执行一个或多个查询。查询以一种专门设计的面向对象的查询语言 QL 编写。</p><p>QL 相关的学习资料（必看）：<a href="https://link.zhihu.com/?target=https%3A//help.semmle.com/QL/learn-ql/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">help.semmle.com/QL/lear</span><span class="invisible">n-ql/</span><span class="ellipsis"></span></a></p><p>下载相关库文件：<a href="https://link.zhihu.com/?target=https%3A//github.com/Semmle/ql" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/Semmle/ql</span><span class="invisible"></span></a></p><p>库文件是开源的，我们要做的是根据这些库文件来编写 QL 脚本。</p><p>可通过 CodeQL for VS Code 扩展或 CodeQL CLI 运行从 CodeQL 存储库中标出的查询（或运行自己编写的自定义查询）。</p><p><b>最后，解释查询结果</b></p><p>将查询执行期间产生的结果转换为在源代码上下文中更有意义的形式。也就是说，以一种突出显示查询旨在查找的潜在问题的方式来解释结果 。</p><p>查询包含指示应如何解释结果的元数据属性。例如，某些查询在代码中的单个位置显示一条简单的消息。其他的则显示一系列位置，这些位置代表沿数据流或控制流路径的步骤，以及说明结果重要性的消息。不解释没有元数据的查询，其结果将作为表输出，并且不会显示在源代码中。</p><p>解释之后，输出结果以供代码检查和分类。在 Visual Studio Code 的 CodeQL 中，解释后的查询结果会自动显示在源代码中。CodeQL CLI 生成的结果可以输出为多种不同格式，以供不同工具使用。</p><p><b>开始使用</b></p><p>为了方便，先配置一个环境变量吧。</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-238da799d608020b5691a2d6a06af7c2_b.jpg" data-caption="" data-size="small" data-rawwidth="632" data-rawheight="666" class="origin_image zh-lightbox-thumb" width="632" data-original="https://pic3.zhimg.com/v2-238da799d608020b5691a2d6a06af7c2_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-238da799d608020b5691a2d6a06af7c2_b.jpg" data-caption="" data-size="small" data-rawwidth="632" data-rawheight="666" class="origin_image zh-lightbox-thumb lazy" width="632" data-original="https://pic3.zhimg.com/v2-238da799d608020b5691a2d6a06af7c2_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-238da799d608020b5691a2d6a06af7c2_b.jpg"/></figure><p>在 VS Code 上安装 CodeQL。</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-339e991f3de1cbb9783d13058d60724e_b.jpg" data-caption="" data-size="small" data-rawwidth="1510" data-rawheight="710" class="origin_image zh-lightbox-thumb" width="1510" data-original="https://pic3.zhimg.com/v2-339e991f3de1cbb9783d13058d60724e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-339e991f3de1cbb9783d13058d60724e_b.jpg" data-caption="" data-size="small" data-rawwidth="1510" data-rawheight="710" class="origin_image zh-lightbox-thumb lazy" width="1510" data-original="https://pic3.zhimg.com/v2-339e991f3de1cbb9783d13058d60724e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-339e991f3de1cbb9783d13058d60724e_b.jpg"/></figure><p>安装后，我们的 VS Code 会多一个侧边工具栏👇</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-21cacbc48f892e7180450f43a7776baf_b.jpg" data-caption="" data-size="normal" data-rawwidth="247" data-rawheight="345" class="content_image" width="247"/></noscript><img src="https://pic4.zhimg.com/v2-21cacbc48f892e7180450f43a7776baf_b.jpg" data-caption="" data-size="normal" data-rawwidth="247" data-rawheight="345" class="content_image lazy" width="247" data-actualsrc="https://pic4.zhimg.com/v2-21cacbc48f892e7180450f43a7776baf_b.jpg"/></figure><p>进行一些相关配置，在 cli 填写下载的 CodeQL 路径，windows 下可以填写 codeql.cmd 的路径；其他配置默认。</p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-7ed604c846dac776e6c9da873acf1e79_b.jpg" data-caption="" data-size="small" data-rawwidth="1577" data-rawheight="667" class="origin_image zh-lightbox-thumb" width="1577" data-original="https://pic2.zhimg.com/v2-7ed604c846dac776e6c9da873acf1e79_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-7ed604c846dac776e6c9da873acf1e79_b.jpg" data-caption="" data-size="small" data-rawwidth="1577" data-rawheight="667" class="origin_image zh-lightbox-thumb lazy" width="1577" data-original="https://pic2.zhimg.com/v2-7ed604c846dac776e6c9da873acf1e79_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-7ed604c846dac776e6c9da873acf1e79_b.jpg"/></figure><p><b>设置CodeQL工作区</b></p><p>我这里使用官方的“入门”工作区，直接下载即可。</p><p>“入门”工作区：<a href="https://link.zhihu.com/?target=https%3A//github.com/github/vscode-codeql-starter/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/github/vscod</span><span class="invisible">e-codeql-starter/</span><span class="ellipsis"></span></a></p><p>内容丰富，包含了：</p><ul><li>CodeQL 库和 C/C++、C＃、Java、JavaScript 和 Python 查询的存储库。</li><li>CodeQL 库和 Go 查询的存储库作为子模块包含在内，可以在不影响自定义查询的情况下进行更新。 </li><li>一系列名为的文件夹 codeql-custom-queries-&lt;language&gt;。你可以使用标准库开始针对每种语言开发自己的自定义查询，有一些示例查询可以帮助你入门。</li></ul><p>在 VS Code 中，使用 <b>File </b>&gt; <b>Open Workspace</b> 选项 vscode-codeql-starter.code-workspace 从你的工作区存储库标签中打开文件。</p><p><b>创建CodeQL数据库</b></p><div class="highlight"><pre><code class="language-text">codeql database create &lt;database&gt; --language=&lt;language-identifier&gt;</code></pre></div><ul><li>&lt;database&gt;：要创建的新数据库的路径。执行命令时将创建此目录，你无法指定现有目录。</li><li>--language：用于为其创建数据库的语言的标识符。</li></ul><p>CodeQL 支持为以下语言创建数据库：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-27172a42037b6d29c69bc24558ba4464_b.jpg" data-caption="" data-size="normal" data-rawwidth="370" data-rawheight="236" class="content_image" width="370"/></noscript><img src="https://pic1.zhimg.com/v2-27172a42037b6d29c69bc24558ba4464_b.jpg" data-caption="" data-size="normal" data-rawwidth="370" data-rawheight="236" class="content_image lazy" width="370" data-actualsrc="https://pic1.zhimg.com/v2-27172a42037b6d29c69bc24558ba4464_b.jpg"/></figure><p>可以指定其他选项，具体取决于源文件的位置和要分析的语言：</p><ul><li>--source-root：数据库创建中使用的主要源文件的根文件夹。默认情况下，该命令假定当前目录是源根目录，使用此选项可以指定其他位置。</li><li>--command：对于已编译的语言，调用编译器的构建命令，解释型语言不需要此选项。命令将从当前文件夹或--source-root指定的位置运行。如果不包含--command，CodeQL 将尝试使用内置的自动生成器自动检测生成系统。</li></ul><p>我这里建了个关于 python 的。</p><div class="highlight"><pre><code class="language-text">codeql database create --language=python &lt;output-folder&gt;/python-database</code></pre></div><figure data-size="small"><noscript><img src="https://pic1.zhimg.com/v2-14db006ad42db4375f71153f944237ec_b.jpg" data-caption="" data-size="small" data-rawwidth="1835" data-rawheight="236" class="origin_image zh-lightbox-thumb" width="1835" data-original="https://pic1.zhimg.com/v2-14db006ad42db4375f71153f944237ec_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-14db006ad42db4375f71153f944237ec_b.jpg" data-caption="" data-size="small" data-rawwidth="1835" data-rawheight="236" class="origin_image zh-lightbox-thumb lazy" width="1835" data-original="https://pic1.zhimg.com/v2-14db006ad42db4375f71153f944237ec_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-14db006ad42db4375f71153f944237ec_b.jpg"/></figure><p>VS Code 打开 ql 库文件，在 ql 选择夹中添加刚才创建的数据库文件，并设置为当前数据库。</p><p>然后我们使用官方提供的 example.ql</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-ccd924cc76428ad189559067af5d56bc_b.jpg" data-caption="" data-size="normal" data-rawwidth="562" data-rawheight="323" class="origin_image zh-lightbox-thumb" width="562" data-original="https://pic1.zhimg.com/v2-ccd924cc76428ad189559067af5d56bc_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-ccd924cc76428ad189559067af5d56bc_b.jpg" data-caption="" data-size="normal" data-rawwidth="562" data-rawheight="323" class="origin_image zh-lightbox-thumb lazy" width="562" data-original="https://pic1.zhimg.com/v2-ccd924cc76428ad189559067af5d56bc_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-ccd924cc76428ad189559067af5d56bc_b.jpg"/></figure><p>准备好这些之后，就可以开始代码分析工作了，最主要还是 QL 文件的编写，可通过官方文档进行这方面的进一步学习。</p><p>有关 <b>CodeQL</b> 的内容就简单介绍到这里，向作者致敬。更多资讯请关注 <a href="https://link.zhihu.com/?target=https%3A//twosecurity.cn/%3Fquery_ref%3DqGLdXm" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a> 进行了解，最近推出了一系列免费的网络安全技能包，有关渗透测试、网络攻防、黑客技巧尽在其中，学它涨姿势💯。</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-fe65256149738f54b5bfcbd1ae5c9f1b_b.jpg" data-caption="" data-size="normal" data-rawwidth="720" data-rawheight="403" class="origin_image zh-lightbox-thumb" width="720" data-original="https://pic4.zhimg.com/v2-fe65256149738f54b5bfcbd1ae5c9f1b_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-fe65256149738f54b5bfcbd1ae5c9f1b_b.jpg" data-caption="" data-size="normal" data-rawwidth="720" data-rawheight="403" class="origin_image zh-lightbox-thumb lazy" width="720" data-original="https://pic4.zhimg.com/v2-fe65256149738f54b5bfcbd1ae5c9f1b_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-fe65256149738f54b5bfcbd1ae5c9f1b_b.jpg"/></figure><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
