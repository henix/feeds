<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>python中urlsplit函数存在的漏洞</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/104885386">原文</a></p>
<div class="title-image"><img src="https://pic3.zhimg.com/v2-58c151df076757b23187575bfe409d90_b.jpg" alt=""></div><h2>urlsplit()</h2><p>是 urllib.parse 模块下的一个函数，跟 urlparse 效果一样用来对 url 进行分割，但是有一点不一样的是 urlsplit 分割出来的没有 params 这个属性。</p><p>例如：</p><div class="highlight"><pre><code class="language-python"><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span><span class="n">parse</span> 

<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://www.example.com/a?b&amp;c=666#1&#39;</span> 
<span class="n">result</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> 

<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;scheme:&#39;</span><span class="p">,</span><span class="n">result</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;netloc:&#39;</span><span class="p">,</span><span class="n">result</span><span class="o">.</span><span class="n">netloc</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;path:&#39;</span><span class="p">,</span><span class="n">result</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;query:&#39;</span><span class="p">,</span><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;fragment:&#39;</span><span class="p">,</span><span class="n">result</span><span class="o">.</span><span class="n">fragment</span><span class="p">)</span></code></pre></div><p>运行结果为：</p><div class="highlight"><pre><code class="language-text">SplitResult(scheme=&#39;http&#39;, netloc=&#39;www.example.com&#39;, path=&#39;/a&#39;, query=&#39;b&amp;c=666&#39;, fragment=&#39;1&#39;) 
scheme: http 
netloc: www.example.com
path: /a 
query: b&amp;c=666
fragment: 1</code></pre></div><p>看上去就是普通的分割函数，能有多大的问题呢？</p><p><b>CVE-2019-9636：urlsplit 不处理 NFKC 标准化</b></p><p><a href="https://link.zhihu.com/?target=https%3A//bugs.python.org/issue36216" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">bugs.python.org/issue36</span><span class="invisible">216</span><span class="ellipsis"></span></a> </p><p><b>CVE-2019-10160：urlsplit NFKD 标准化漏洞</b></p><p><a href="https://link.zhihu.com/?target=https%3A//bugs.python.org/issue36742" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">bugs.python.org/issue36</span><span class="invisible">742</span><span class="ellipsis"></span></a> </p><p><b>漏洞原理：</b></p><p>用 Punycode/IDNA 编码的 URL 使用 NFKC 规范化来分解字符。可能导致某些字符将新的段引入 URL。</p><p>例如，在直接比较中，\ uFF03不等于&#39;＃&#39;，而是统一化为&#39;＃&#39;，这会更改 URL 的片段部分。类似地，\ u2100 统一化为&#39;a/c&#39;，它引入了路径段。</p><p>例如：</p><div class="highlight"><pre><code class="language-text">&gt;&gt;&gt; urlsplit(&#39;http://\u30d5\u309a:80&#39;)
Traceback (most recent call last):
  File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt;
  File &#34;/Users/ito/.maltybrew/deen/lib/python3.7/urllib/parse.py&#34;, line 437, in urlsplit
    _checknetloc(netloc)
  File &#34;/Users/ito/.maltybrew/deen/lib/python3.7/urllib/parse.py&#34;, line 407, in _checknetloc
    &#34;characters under NFKC normalization&#34;)
ValueError: netloc &#39;プ:80&#39; contains invalid characters under NFKC normalization</code></pre></div><p>上面这种情况下直接报错，但是去掉端口或进行转码就不会，导致漏洞。</p><div class="highlight"><pre><code class="language-text">&gt;&gt;&gt; urlsplit(&#39;http://\u30d5\u309a&#39;)
SplitResult(scheme=&#39;http&#39;, netloc=&#39;プ&#39;, path=&#39;&#39;, query=&#39;&#39;, fragment=&#39;&#39;)
&gt;&gt;&gt; urlsplit(unicodedata.normalize(&#39;NFKC&#39;, &#39;http://\u30d5\u309a:80&#39;))
SplitResult(scheme=&#39;http&#39;, netloc=&#39;プ:80&#39;, path=&#39;&#39;, query=&#39;&#39;, fragment=&#39;&#39;)</code></pre></div><p>下面以一道 CTF 来深入理解。</p><h2>SUCTF 2019-Pythonginx</h2><p>在线靶场：<a href="https://link.zhihu.com/?target=https%3A//buuoj.cn/challenges%23%255BSUCTF%25202019%255DPythonginx" class=" wrap external" target="_blank" rel="nofollow noreferrer">https://buuoj.cn/challenges#[SUCTF%202019]Pythonginx</a></p><p>进入题目，它直接给出了源码：</p><div class="highlight"><pre><code class="language-python"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/getUrl&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">getUrl</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;url&#34;</span><span class="p">)</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">hostname</span>
    <span class="k">if</span> <span class="n">host</span> <span class="o">==</span> <span class="s1">&#39;suctf.cc&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&#34;我扌 your problem? 111&#34;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">host</span> <span class="o">==</span> <span class="s1">&#39;suctf.cc&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&#34;我扌 your problem? 222 &#34;</span> <span class="o">+</span> <span class="n">host</span>
    <span class="n">newhost</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">host</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="n">newhost</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;idna&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newhost</span><span class="p">)</span>
    <span class="c1">#去掉 url 中的空格</span>
    <span class="n">finalUrl</span> <span class="o">=</span> <span class="n">urlunsplit</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">finalUrl</span><span class="p">)</span><span class="o">.</span><span class="n">hostname</span>
    <span class="k">if</span> <span class="n">host</span> <span class="o">==</span> <span class="s1">&#39;suctf.cc&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">finalUrl</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&#34;我扌 your problem? 333&#34;</span></code></pre></div><p>这题的出题思路来自于BlackHat的一个议题，相关 PPT 如下：</p><p><a href="https://link.zhihu.com/?target=https%3A//i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">i.blackhat.com/USA-19/T</span><span class="invisible">hursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</span><span class="ellipsis"></span></a> </p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-d952031ea9547e10738a7d938919ebbd_b.jpg" data-caption="" data-size="small" data-rawwidth="976" data-rawheight="1694" class="origin_image zh-lightbox-thumb" width="976" data-original="https://pic2.zhimg.com/v2-d952031ea9547e10738a7d938919ebbd_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-d952031ea9547e10738a7d938919ebbd_b.jpg" data-caption="" data-size="small" data-rawwidth="976" data-rawheight="1694" class="origin_image zh-lightbox-thumb lazy" width="976" data-original="https://pic2.zhimg.com/v2-d952031ea9547e10738a7d938919ebbd_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-d952031ea9547e10738a7d938919ebbd_b.jpg"/></figure><p><b>Nginx 重要文件目录</b></p><ul><li>配置文件存放目录：/etc/nginx</li><li>主要配置文件：/etc/nginx/conf/nginx.conf</li><li>管理脚本：/usr/lib64/systemd/system/nginx.service</li><li>模块：/usr/lisb64/nginx/modules</li><li>应用程序：/usr/sbin/nginx</li><li>程序默认存放位置：/usr/share/nginx/html</li><li>日志默认存放位置：/var/log/nginx</li></ul><p><b>提示：</b></p><ul><li>前面的 url 部分应该是<code>suctf.cc</code></li><li>还提到了 Nginx，Nginx 的配置文件目录为：<code>/usr/local/nginx/conf/nginx.conf</code> </li></ul><p>利用 ℆ 来代替 c 进行绕过。</p><p>构造 payload：</p><div class="highlight"><pre><code class="language-text">file://suctf.c℆sr/fffffflag</code></pre></div><p>更多 python 相关的网络安全学习尽在 <a href="https://link.zhihu.com/?target=https%3A//www.baidu.com/link%3Furl%3DOcGTJIGtwpNYrGru7tSszpEf10ZQ0xIE7SvER9ejNcCar00KI-fG2lu214M4WKPc%26wd%3D%26eqid%3Da24dabb2002f492b000000065e13d46a" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a>，另外，网络安全技能包又更新了！学 Python 的也能当黑客了，多实战沉浸式体验，让你回味无穷。</p><p>抓住春节的尾巴，让你从 <b>程序猿→黑客x程序员 PLUS</b>！</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_b.jpg" data-caption="" data-size="normal" data-rawwidth="3058" data-rawheight="1720" class="origin_image zh-lightbox-thumb" width="3058" data-original="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_b.jpg" data-caption="" data-size="normal" data-rawwidth="3058" data-rawheight="1720" class="origin_image zh-lightbox-thumb lazy" width="3058" data-original="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_b.jpg"/></figure><p>更多有关渗透测试的内容请前往<a href="https://link.zhihu.com/?target=https%3A//www.baidu.com/link%3Furl%3DOcGTJIGtwpNYrGru7tSszpEf10ZQ0xIE7SvER9ejNcCar00KI-fG2lu214M4WKPc%26wd%3D%26eqid%3Da24dabb2002f492b000000065e13d46a" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a>进行学习，最近推出了“挖洞”班，想了解更多资讯的，可咨询客服微信 <b>twosecurity02</b></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg" data-caption="" data-size="normal" data-rawwidth="3041" data-rawheight="2000" class="origin_image zh-lightbox-thumb" width="3041" data-original="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg" data-caption="" data-size="normal" data-rawwidth="3041" data-rawheight="2000" class="origin_image zh-lightbox-thumb lazy" width="3041" data-original="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg"/></figure>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
