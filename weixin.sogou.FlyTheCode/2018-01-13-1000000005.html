<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>快捷的动态权限请求 - Permission Requester</title>
</head>
<body>
<p><a href="https://mp.weixin.qq.com/s?timestamp=1557316577&amp;src=3&amp;ver=1&amp;signature=PeoRXAkXYf6fFAL3RfcSDHX1FmPr1UolGBn8RDz91mp6Yl2uaTlUDEpbXMsO0k2EEq-Tz56ohLthJhrKkPVMHcdeoHLFQqaEsr-N5uLZDt3SP4vSsitBJDOhJz2lRRG0ur2P6PSJF7a-UsV-D2BpbACzaXxt4sN*3yNETZ3YnNU=">原文</a></p>
<div id="img-content">
                
                <h2 class="rich_media_title" id="activity-name">
                    快捷的动态权限请求 - Permission Requester                                    </h2>
                <div id="meta_content" class="rich_media_meta_list">
                                        <span id="copyright_logo" class="rich_media_meta meta_original_tag">原创</span>
                                                            <em id="post-date" class="rich_media_meta rich_media_meta_text">2018-01-13</em>

                                        <em class="rich_media_meta rich_media_meta_text">Tankery</em>
                                        <a class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="##" id="post-user">FlyTheCode</a>
                    <span class="rich_media_meta rich_media_meta_text rich_media_meta_nickname">FlyTheCode</span>

                    <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                        <div class="profile_inner">
                            <strong class="profile_nickname">FlyTheCode</strong>
                            <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                            <p class="profile_meta">
                            <label class="profile_meta_label">微信号</label>
                            <span class="profile_meta_value">FlyTheCode</span>
                            </p>

                            <p class="profile_meta">
                            <label class="profile_meta_label">功能介绍</label>
                            <span class="profile_meta_value">希望有一天，代码能如风一般飞奔在原野。</span>
                            </p>
                            
                        </div>
                        <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                            <i class="profile_arrow arrow_out"></i>
                            <i class="profile_arrow arrow_in"></i>
                        </span>
                    </div>
                </div>
                
                
                
                
                                                
                                                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">之前在问问的一个项目中，需要用到动态权限请求。趁着这个机会，我想把工程中所有项目的权限请求都统一到一起。通过和同事的讨论，发现将权限请求封装成一个 Activity 是最为合适的。通过 Activity，整套权限请求的流程都可以在此 Activity 中完成，各个 App 都只需要调起 Activity，然后获取最终的请求结果，大大简化各 App 请求权限的工作量，并统一了所有 App 的请求流程。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">如今稍有空挡，我将权限请求的逻辑从工程中抽出，去掉工程相关代码，整理成了一套 Android 系统上通用的权限请求库，Permission Reuquester，并且将它开源到了 GitHub 上 (https://github.com/tankery/permission-requester)。Permission Reuquester 可以让你用最少工作量，完成一整套权限请求逻辑。</p><h2 style="box-sizing: border-box;margin: 0.2rem auto 0.5rem;"><strong><span style="font-size: 18px;">背景</span></strong></h2><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">在运行时请求权限 是 Android 6.0 (API level 23) 开始引入的功能，用户可以在运行应用，而不是安装时来请求必要的权限。目标版本是 23 及以上的应用，都必须在运行时请求“危险”权限。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">有很多事情需要我们考虑。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">首先你需要检查权限来判断应用是否已经获取到所需权限。如果没有权限，那么你得请求您需要的权限，而且通常你需要解释应用为什么需要权限。而请求权限以后，你可能会需要处理权限请求响应，这样你可以在根据权限请求结果来做不同的事情。更麻烦的是，如果用户点选了“不再提醒”，那么你的应用可能就失去获取权限的机会了，你只能选择引导用户到设置中去开启所需权限。</p><h2 style="box-sizing: border-box;margin: 0.2rem auto 0.5rem;"><strong><span style="font-size: 18px;">代码库设计思路</span></strong></h2><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">我们来整理一下权限请求所需要做的事情：</p><ol style="margin-left: auto;margin-right: auto;" class=" list-paddingleft-2"><li><p>检查权限。判断是否已经有权限</p></li><li><p>从系统请求权限。</p></li><li><p>获取系统权限请求结果。如果请求成功，那很好，你的用户同意了权限；如果失败了，那说明你的用户拒绝了权限请求。</p></li><li><p>获取是否需要解释。如果系统告知是需要解释，那么你还有机会给用户一个解释，然后再请求权限。如果不需要解释。那要么是首次请求，要么就是已经请求过，被用户拒绝，且点选了“不再提醒”。如果是后者，那就很尴尬了，你在应用中已经没有机会再次请求权限了。</p></li><li><p>跳转到设置。如果你在应用中已经没有机会再次请求权限，那么你只能提示用户去设置里重新开启权限。</p></li></ol><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">整个库的设计目标，就是尽可能的通过各类提示来向用户请求权限，并让用户始终有办法授权。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">需要注意的是，这个库是比较激进的，一上来会直接请求权限，用户拒绝后才会进行提示，而用户点选了“不再提醒”以后，会弹窗提示用户去设置开启。所以，一定要在某个功能确实需要权限时，才去调用这个库开启权限，这样才不至于打扰用户。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">比如，如果是一个音乐播放器，只有在用户点击“本地音乐”入口时，才去请求磁盘访问权限，这样，将权限请求和用户目标关联起来时，才更有可能争取到用户的同意。而这个库将权限请求这一过程变得如此简单。使得你能非常方便的在各种功能入口都加上对应权限的请求入口，不再会因为觉得麻烦，而在应用一开始，就去请求一大堆将来才会用到的权限。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">下图展示了 Permission Reuquester 是如何完成一次权限请求的：</p><p style="text-align: center;"><img data-s="300,640" data-type="png" src="https://mmbiz.qpic.cn/mmbiz_png/zF3LiaNuTWoWg4WhOP5GpROU17nQ3bAcvjcOvrBzUmE9rMjOsTB5kjq5YDE4Y5ibHnibc20TFD3XViby06RUNTxv2Q/0?wx_fmt=png" data-copyright="0" style="" class="" data-ratio="0.8461538461538461" data-w="572"></p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">从图中我们看到。如果没有被授权，Permission Requester 会在一开始，就尝试通过系统接口去请求权限，如果你的请求是合理的，而且和用户目标关联，那绝大部分用户会很乐意直接同意这个请求。若用户拒绝，Requester 会弹出一个解释对话框（内容是你指定的），告诉用户我们为什么需要这个权限，并问他是不是要重新请求一下。如果“是”，则重新请求，如果”否“，Requester 会退出，并返回一个授权失败的结果。如果很不幸，用户在拒绝系统权限请求时，点选了”不再提醒“，那么 Requester 会弹出另一个解释对话框，并问他要不要去设置里开启权限。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">这一整套逻辑都被封装在 PermissionRequestActivity 中，对外来说，只需要 start，然后获取最终的请求结果。</p><h2 style="box-sizing: border-box;margin: 0.2rem auto 0.5rem;"><span style="font-size: 18px;"><strong>使用方式</strong></span></h2><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">首先，你需要在工程中引用 Permission Requester。我将这个库上传到了 jcenter，因为是 Gradle 的默认代码仓库，所以你需要做的只是在 module 的 <code class="highlighter-rouge" style="box-sizing: border-box;">build.gradle</code>中添加对这个库的依赖即可：</p><pre class="highlight" style="box-sizing: border-box;overflow-x: auto;overflow-y: hidden;font-family: monospace, monospace;font-size: 1em;margin: 0px auto 1.5625rem;padding: 1.25rem;background-color: rgba(240, 240, 240, 0.8);max-width: 56.25rem;"><code class="hljs nginx" style="box-sizing: border-box;"><span class="k" style="box-sizing: border-box;"><span class="hljs-section" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">dependencies</span></span> <span class="o" style="box-sizing: border-box;">{</span>
    <span class="n" style="box-sizing: border-box;"><span class="hljs-attribute" style="box-sizing: border-box;font-weight: bold;">compile</span></span> <span class="s1" style="box-sizing: border-box;"><span class="hljs-string" style="box-sizing: border-box;color: rgb(136, 0, 0);">'me.tankery.lib:permission-requester:1.0.0'<br></span></span><span class="o" style="box-sizing: border-box;">}</span></code></pre><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">Gradle 3.0 的话，可以用 implementation 方式依赖：</p><pre class="highlight" style="box-sizing: border-box;overflow-x: auto;overflow-y: hidden;font-family: monospace, monospace;font-size: 1em;margin: 0px auto 1.5625rem;padding: 1.25rem;background-color: rgba(240, 240, 240, 0.8);max-width: 56.25rem;"><code class="hljs nginx" style="box-sizing: border-box;"><span class="k" style="box-sizing: border-box;"><span class="hljs-section" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">dependencies</span></span> <span class="o" style="box-sizing: border-box;">{</span>
    <span class="n" style="box-sizing: border-box;"><span class="hljs-attribute" style="box-sizing: border-box;font-weight: bold;">implementation</span></span> <span class="s1" style="box-sizing: border-box;"><span class="hljs-string" style="box-sizing: border-box;color: rgb(136, 0, 0);">'me.tankery.lib:permission-requester:1.0.0'<br></span></span><span class="o" style="box-sizing: border-box;">}</span></code></pre><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">接下来，就可以在代码中使用了。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">要实现一个权限请求非常的容易。如果你不需要立刻获得权限请求结果，而仅仅是申请权限的话。用下面这一行代码就够了：</p><pre class="highlight" style="box-sizing: border-box;overflow-x: auto;overflow-y: hidden;font-family: monospace, monospace;font-size: 1em;margin: 0px auto 1.5625rem;padding: 1.25rem;background-color: rgba(240, 240, 240, 0.8);max-width: 56.25rem;"><code class="hljs css" style="box-sizing: border-box;"><span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">PermissionRequestActivity</span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-selector-class" style="box-sizing: border-box;color: rgb(136, 0, 0);">.</span></span><span class="na" style="box-sizing: border-box;"><span class="hljs-selector-class" style="box-sizing: border-box;color: rgb(136, 0, 0);">start</span></span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">context</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">PERMISSIONS</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">rationalMsg</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">goSettingsMsg</span></span><span class="o" style="box-sizing: border-box;">);</span></code></pre><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">你甚至可以在后台 Service 中开启权限请求。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">而如果你关心请求结果。那么你可以在你的 Activity 中调用另外一行代码：</p><pre class="highlight" style="box-sizing: border-box;overflow-x: auto;overflow-y: hidden;font-family: monospace, monospace;font-size: 1em;margin: 0px auto 1.5625rem;padding: 1.25rem;background-color: rgba(240, 240, 240, 0.8);max-width: 56.25rem;"><code class="hljs css" style="box-sizing: border-box;"><span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">PermissionRequestActivity</span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-selector-class" style="box-sizing: border-box;color: rgb(136, 0, 0);">.</span></span><span class="na" style="box-sizing: border-box;"><span class="hljs-selector-class" style="box-sizing: border-box;color: rgb(136, 0, 0);">start</span></span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">activity</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">REQUEST_CODE</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">PERMISSIONS</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">rationalMsg</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;"><span class="hljs-selector-tag" style="box-sizing: border-box;font-weight: bold;">goSettingsMsg</span></span><span class="o" style="box-sizing: border-box;">);</span></code></pre><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">然后，重载 Activity 的 <code class="highlighter-rouge" style="box-sizing: border-box;">onActivityResult</code> 来获取请求结果：</p><pre class="highlight" style="box-sizing: border-box;overflow-x: auto;overflow-y: hidden;font-family: monospace, monospace;font-size: 1em;margin: 0px auto 1.5625rem;padding: 1.25rem;background-color: rgba(240, 240, 240, 0.8);max-width: 56.25rem;"><code class="hljs java" style="box-sizing: border-box;"><span class="nd" style="box-sizing: border-box;"><span class="hljs-meta" style="box-sizing: border-box;color: rgb(31, 113, 153);">@Override<br></span></span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">protected</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="nf" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">onActivityResult</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">requestCode</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">resultCode</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">Intent</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">data</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
    <span class="kd" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">super</span></span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">onActivityResult</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">requestCode</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">resultCode</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">data</span><span class="o" style="box-sizing: border-box;">);</span>
    <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">if</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">requestCode</span> <span class="o" style="box-sizing: border-box;">==</span> <span class="n" style="box-sizing: border-box;">REQUEST_CODE</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">if</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">resultCode</span> <span class="o" style="box-sizing: border-box;">==</span> <span class="n" style="box-sizing: border-box;">RESULT_OK</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
            <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">// 授权成功</span></span>
        <span class="o" style="box-sizing: border-box;">}</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">else</span></span> <span class="o" style="box-sizing: border-box;">{</span>
            <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">// 授权失败</span></span>
        <span class="o" style="box-sizing: border-box;">}</span>
    <span class="o" style="box-sizing: border-box;">}<br></span><span class="o" style="box-sizing: border-box;">}</span></code></pre><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">你甚至可以通过重载 <code class="highlighter-rouge" style="box-sizing: border-box;">showRationaleDialog</code> 来自定义解释说明对话框的展现形式：</p><pre class="highlight" style="box-sizing: border-box;overflow-x: auto;overflow-y: hidden;font-family: monospace, monospace;font-size: 1em;margin: 0px auto 1.5625rem;padding: 1.25rem;background-color: rgba(240, 240, 240, 0.8);max-width: 56.25rem;"><code class="hljs java" style="box-sizing: border-box;"><span class="cm" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">/**
 * Override this method to show custom dialog.
 * <span class="hljs-doctag" style="box-sizing: border-box;font-weight: bold;">@param</span> canRequestAgain if true, show request again dialog, else, show go settings dialog
 * <span class="hljs-doctag" style="box-sizing: border-box;font-weight: bold;">@param</span> message dialog message
 * <span class="hljs-doctag" style="box-sizing: border-box;font-weight: bold;">@param</span> dialogResult always have a result for user action
 *                     (ok - &gt; positive/cancel -&gt; negative/dismiss -&gt; negative)
 */<br></span></span><span class="nd" style="box-sizing: border-box;"><span class="hljs-meta" style="box-sizing: border-box;color: rgb(31, 113, 153);">@Override<br></span></span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">protected</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="nf" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">showRationaleDialog</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">final</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">boolean</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">canRequestAgain</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">String</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">message</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">
                                   </span></span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">final</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="nd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">@NonNull</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">DialogResult</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">dialogResult</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
    <span class="n" style="box-sizing: border-box;">AlertDialog</span> <span class="n" style="box-sizing: border-box;">alertDialog</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">new</span></span> <span class="n" style="box-sizing: border-box;">AlertDialog</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">Builder</span><span class="o" style="box-sizing: border-box;">(</span><span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">this</span></span><span class="o" style="box-sizing: border-box;">)</span>
            <span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">setMessage</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">message</span><span class="o" style="box-sizing: border-box;">)</span>
            <span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">setCancelable</span><span class="o" style="box-sizing: border-box;">(</span><span class="kc" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">true</span></span><span class="o" style="box-sizing: border-box;">)</span>
            <span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">setPositiveButton</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">android</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">R</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">string</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">ok</span><span class="o" style="box-sizing: border-box;">,</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">new</span></span> <span class="n" style="box-sizing: border-box;">OnClickListener</span><span class="o" style="box-sizing: border-box;">()</span> <span class="o" style="box-sizing: border-box;">{</span>
                <span class="nd" style="box-sizing: border-box;"><span class="hljs-meta" style="box-sizing: border-box;color: rgb(31, 113, 153);">@Override</span></span>
                <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">public</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="nf" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">onClick</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">DialogInterface</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">dialogInterface</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">i</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
                    <span class="n" style="box-sizing: border-box;">dialogInterface</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">dismiss</span><span class="o" style="box-sizing: border-box;">();</span>
                    <span class="n" style="box-sizing: border-box;">dialogResult</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">onPositive</span><span class="o" style="box-sizing: border-box;">();</span>
                <span class="o" style="box-sizing: border-box;">}</span>
            <span class="o" style="box-sizing: border-box;">})</span>
            <span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">setNegativeButton</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">android</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">R</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">string</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">cancel</span><span class="o" style="box-sizing: border-box;">,</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">new</span></span> <span class="n" style="box-sizing: border-box;">OnClickListener</span><span class="o" style="box-sizing: border-box;">()</span> <span class="o" style="box-sizing: border-box;">{</span>
                <span class="nd" style="box-sizing: border-box;"><span class="hljs-meta" style="box-sizing: border-box;color: rgb(31, 113, 153);">@Override</span></span>
                <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">public</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="nf" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">onClick</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">DialogInterface</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">dialogInterface</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">i</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
                    <span class="n" style="box-sizing: border-box;">dialogInterface</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">cancel</span><span class="o" style="box-sizing: border-box;">();</span>
                <span class="o" style="box-sizing: border-box;">}</span>
            <span class="o" style="box-sizing: border-box;">})</span>
            <span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">setOnCancelListener</span><span class="o" style="box-sizing: border-box;">(</span><span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">new</span></span> <span class="n" style="box-sizing: border-box;">OnCancelListener</span><span class="o" style="box-sizing: border-box;">()</span> <span class="o" style="box-sizing: border-box;">{</span>
                <span class="nd" style="box-sizing: border-box;"><span class="hljs-meta" style="box-sizing: border-box;color: rgb(31, 113, 153);">@Override</span></span>
                <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">public</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="nf" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">onCancel</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">DialogInterface</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">dialogInterface</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
                    <span class="n" style="box-sizing: border-box;">dialogInterface</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">dismiss</span><span class="o" style="box-sizing: border-box;">();</span>
                    <span class="n" style="box-sizing: border-box;">dialogResult</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">onNegative</span><span class="o" style="box-sizing: border-box;">();</span>
                <span class="o" style="box-sizing: border-box;">}</span>
            <span class="o" style="box-sizing: border-box;">})</span>
            <span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">show</span><span class="o" style="box-sizing: border-box;">();</span>
    <span class="n" style="box-sizing: border-box;">alertDialog</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">setCanceledOnTouchOutside</span><span class="o" style="box-sizing: border-box;">(</span><span class="kc" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">true</span></span><span class="o" style="box-sizing: border-box;">);<br></span><span class="o" style="box-sizing: border-box;">}</span></code></pre><h2 style="box-sizing: border-box;margin: 0.2rem auto 0.5rem;"><strong><span style="font-size: 18px;">它是如何实现的？</span></strong></h2><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">如果对实现方案感兴趣（其实也没什么特别的，只是对于从 Settings 返回、被锁屏、退回 Home 等麻烦的情况都做了比较好的处理。代码质量自我感觉也还不错），或者发现了什么问题想查找原因。欢迎下载源码进一步了解。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">如果你遇到什么 bug，或是有什么建议，欢迎提 issues。 已经找到问题并且有修复方案？或是有任何改进的代码，向我提 Pull Request 也是极好的。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">如果你喜欢这个库，加个 Star 就是很好的帮助。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">希望这个库能减轻你的一些繁杂工作的压力，留出时间去创造更美好的东西。</p><p><br></p>
                </div>
                <script nonce="413112495" type="text/javascript">
                    var first_sceen__time = (+new Date());

                    if ("" == 1 && document.getElementById('js_content')) {
                        document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });
                    }

                    
                    (function(){
                        if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                            var link = document.createElement('link');
                            var head = document.getElementsByTagName('head')[0];
                            link.rel = 'stylesheet';
                            link.type = 'text/css';
                            link.href = "//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_winwx31619e.css";
                            head.appendChild(link);
                        }
                    })();
                </script>
                
                
                                
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display:none;"></div>

                
                                <div class="reward_area tc" id="js_preview_reward" style="display:none;">
                    <p id="js_preview_reward_wording" class="tips_global reward_tips" style="display:none;"></p>
                    <p>
                        <a class="reward_access" id="js_preview_reward_link" href="##"><span class="icon-reward"></span>赞赏</a>

                    </p>
                </div>
                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="//res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x3534dd.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div><div class="rich_media_tool" id="js_toobar3">
                                            <a class="media_tool_meta meta_primary" id="js_view_source" href="##">阅读原文</a>
                                <div id="js_read_area3" class="media_tool_meta tips_global meta_primary" style="display:none;">阅读 <span id="readNum3"></span></div>

                <span style="display:none;" class="media_tool_meta meta_primary tips_global meta_praise" id="like3">
                    <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum3"></span>
                </span>

                <a id="js_report_article3" style="display:none;" class="media_tool_meta tips_global meta_extra" href="##">投诉</a>

            </div><div class="rich_media_tool" id="js_sg_bar">
                                <a class="media_tool_meta meta_primary" href="http://blog.tankery.me/development/dynamic-permission-request" target="_blank">阅读原文</a>
                                
            </div>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
