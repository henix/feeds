<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>HotSpot  Java虚拟机性能概述</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/20145268">原文</a></p>
针对Oracle Java 7以后的HotSpot虚拟机，桌面和服务器应用：<br><ol><li>HotSpot虚拟机执行的所有字节码指令，在充分优化后，都不慢于充分优化后的C++原生机器码。</li><li>HotSpot虚拟机中的虚函数调用比C++快得多。这是因为HotSpot会在运行时分析程序运行情况，缩短常见的虚函数调用分支，甚至可以内联虚函数调用。C++是纯编译语言，没办法做这些优化。<br></li><li>Java不支持值类型的结构，没有C或C#中的struct关键字。所以在实现常见数据结构时，很难实现得像C++一样快。而且数组、链表不能直接保存结构，而必须保存引用。所以Java数据结构和STL容器没法比，和<a href="http://www.boost.org/doc/libs/1_55_0/libs/ptr_container/doc/ptr_container.html" class="" data-editable="true" data-title="Boost.Pointer Container">Boost.Pointer Container</a>倒是可以比比。在需要极端性能的场合，比如做题时，会导致相比C++性能慢好几倍。</li><li>HotSpot内存分配的CPU性能，完胜任何C++标准库的new/delete实现。并且通过逃逸分析和标量替换，可以完全避免大多数临时对象的内存分配，因而缓解了缺乏struct的痛楚。</li><li>HotSpot的各个垃圾收集器都不会马上释放不用的对象，而会延后一些时间才释放。所以Java的峰值内存和平时内存占用都会大大高于C++程序。</li><li>除了应用程序分配的内存和应用程序执行的指令，HotSpot还有额外的剖析和编译开销。按我个人的经验看，额外的CPU开销一般在总执行时间的30%以下，受垃圾收集影响很大；额外的内存开销（黑话叫PermGen）取决于加载的类数量，通常在M数量级。<br></li><li>如果Java频繁调用原生函数，需要跨越虚拟机和原生系统的边界，会产生额外包装和检查开销。这类开销的大小取决于调用的频繁程度。由于这个缘故，用Java字节码实现的gzip算法要比从Java端调用C语言的原生库更快。</li><li>由于Java字节码格式设计傻屄，所以加载极为缓慢。加载的主要开销是IO。（顺便说一下同样的代码在同一台电脑上，Linux会比Windows加载快，应该是因为NTFS太烂的缘故。）</li><li>Java虚拟机和C++运行时相比，有许多额外检查，比如内存越界检查、类型检查、会额外增加一点CPU开销。一般情况此类开销不大，除非你专门做评测，否则察觉不出来。</li><li>装箱拆箱的开销，绝大部分情况下可以靠Java虚拟机的运行时分析消除。不过当把Integer、Long等包装类型用在虚函数参数上时，如果无法虚拟机没办法内联这个虚函数，而且数字比较大，没办法找到预先分配的包装对象，那么装箱拆箱的开销就会稍高些，大概要花几十纳秒。</li></ol>但是Java的运行环境不光是虚拟机，还包括标准库。Java SE标准库比C++标准库高级，是面向对象封装，适合编写上层逻辑。但本文只讨论效率，那么就全是缺点了。<br><ol><li>省略了许多底层控制选项，无法充分手动优化性能。这类情况主要涉及IO相关API。这样设计的原因我猜是为了跨平台。<br></li><li>鼓励大量分配内存的编程风格。由于Java的编程风格会更经常分配内存，所以会抵消HotSpot的垃圾收集器的优势。<br></li></ol>总结：<br><ol><li>编写日常的面向对象风格的业务逻辑时，两门语言都不用力优化的话，Java比C++快，但是内存占用会高两倍以上。</li><li>追求极致的性能时，比如TopCoder上做题时，只要你用了Java标准库，就很难尽情优化，所以比C++慢，再加上虚拟机运行时分析和编译的开销，通常总计消耗CPU时间在C++的1.1倍到5倍之间。但这时你会根据内存复杂度来精确分配内存，所以内存占用倒是和C++差不多了。</li></ol>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
