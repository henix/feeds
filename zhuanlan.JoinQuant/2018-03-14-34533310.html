<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>【量化课堂】单特征因子的隐马尔可夫模型在商品期货中的应用</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/34533310">原文</a></p>
<div class="title-image"><img src="https://pic3.zhimg.com/v2-ea318ea4b90f34b4cde5b9218a0c9c2e_b.jpg" alt=""></div><p>隐马尔科夫模型作为一种机器学习方法曾广泛应用于语音识别领域，目前又被大量地研究应用于金融市场当中。为了能够尽可能地挖掘该模型的应用潜力，本篇报告就尝试使用它在商品期货上面构建出的日间级别的CTA策略。</p><p class="ztext-empty-paragraph"><br/></p><p><b>模型简介</b></p><p>隐马尔科夫模型（ Hidden Markov Model, HMM）是被广泛使用在自然语言处理领域的一种统计学习模型。为了了解隐马尔可夫模型，我们首先来了解一下马尔科夫模型（Markov Model）。马尔科夫过程是指具有马尔可夫性质的<b>离散时间随机过程</b>。马尔科夫性质是指，在给定当前知识或信息的情况下，<b>过去</b>（即当前以前的历史状态）<b>对于预测将来</b>（即当前以后的未来状态）<b>是无关的</b>。</p><p>用数学公式表达就是：</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-46caa367ac99d204dc070ddf7de95c3c_b.jpg" data-caption="" data-size="normal" data-rawwidth="456" data-rawheight="60" class="origin_image zh-lightbox-thumb" width="456" data-original="https://pic1.zhimg.com/v2-46caa367ac99d204dc070ddf7de95c3c_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-46caa367ac99d204dc070ddf7de95c3c_b.jpg" data-caption="" data-size="normal" data-rawwidth="456" data-rawheight="60" class="origin_image zh-lightbox-thumb lazy" width="456" data-original="https://pic1.zhimg.com/v2-46caa367ac99d204dc070ddf7de95c3c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-46caa367ac99d204dc070ddf7de95c3c_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>举一个简单的例子：</p><p>有一只青蛙，0时刻在数轴上的原点，他每一秒可以往左或者往右跳一个格子，并且往哪边跳是完全随机的。</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-d1e72375781001328932be02e501be4e_b.jpg" data-caption="" data-size="normal" data-rawwidth="1155" data-rawheight="195" class="origin_image zh-lightbox-thumb" width="1155" data-original="https://pic3.zhimg.com/v2-d1e72375781001328932be02e501be4e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-d1e72375781001328932be02e501be4e_b.jpg" data-caption="" data-size="normal" data-rawwidth="1155" data-rawheight="195" class="origin_image zh-lightbox-thumb lazy" width="1155" data-original="https://pic3.zhimg.com/v2-d1e72375781001328932be02e501be4e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-d1e72375781001328932be02e501be4e_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>那么在1时刻，它有可能在1，也有可能在-1。我们不妨设他1时刻跳到了1。</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-b7b9d7c0ad8dcda087dc554ce5ca5eca_b.jpg" data-caption="" data-size="normal" data-rawwidth="1155" data-rawheight="195" class="origin_image zh-lightbox-thumb" width="1155" data-original="https://pic3.zhimg.com/v2-b7b9d7c0ad8dcda087dc554ce5ca5eca_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-b7b9d7c0ad8dcda087dc554ce5ca5eca_b.jpg" data-caption="" data-size="normal" data-rawwidth="1155" data-rawheight="195" class="origin_image zh-lightbox-thumb lazy" width="1155" data-original="https://pic3.zhimg.com/v2-b7b9d7c0ad8dcda087dc554ce5ca5eca_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-b7b9d7c0ad8dcda087dc554ce5ca5eca_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>那么在2时刻，他有可能跳到了2，也有可能跳到了0。</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-d6f59c964d4abab6afb3d09dafcb3f39_b.jpg" data-caption="" data-size="normal" data-rawwidth="1155" data-rawheight="195" class="origin_image zh-lightbox-thumb" width="1155" data-original="https://pic2.zhimg.com/v2-d6f59c964d4abab6afb3d09dafcb3f39_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-d6f59c964d4abab6afb3d09dafcb3f39_b.jpg" data-caption="" data-size="normal" data-rawwidth="1155" data-rawheight="195" class="origin_image zh-lightbox-thumb lazy" width="1155" data-original="https://pic2.zhimg.com/v2-d6f59c964d4abab6afb3d09dafcb3f39_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-d6f59c964d4abab6afb3d09dafcb3f39_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>而由于每一步的跳跃都是随机的，所以1-&gt;2时刻的跳跃与0时刻的位置没有关系，只与1时刻的位置有关。</p><p>即：P(t2=2∣t1=1)=P(t2=2∣t1=1，t0=0)。这个性质就是马尔科夫性：下一时刻的状态只和上一时刻有关，和上上时刻，上上上时刻……等再往前的时刻都无关。</p><p>为了简化问题，并且方便用数学语言描述，我们让青蛙改成在三个格子里跳跃。</p><p>假设它某时刻在格子1里，下一时刻跳到格子1，2，3里的概率分别是0.2, 0.3, 0.5；某时刻在格子2里，下一时刻跳到格子1，2，3里的概率分别是0.4, 0.2, 0.4；某时刻在格子3里，下一时刻跳到格子1，2，3里的概率分别是0.5, 0.4, 0.1。</p><p>那么青蛙跳格子这件事就可以用以下这个矩阵来描述：</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-d0c7b9a78f365773c12d290ba2808647_b.jpg" data-caption="" data-size="normal" data-rawwidth="569" data-rawheight="126" class="origin_image zh-lightbox-thumb" width="569" data-original="https://pic4.zhimg.com/v2-d0c7b9a78f365773c12d290ba2808647_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-d0c7b9a78f365773c12d290ba2808647_b.jpg" data-caption="" data-size="normal" data-rawwidth="569" data-rawheight="126" class="origin_image zh-lightbox-thumb lazy" width="569" data-original="https://pic4.zhimg.com/v2-d0c7b9a78f365773c12d290ba2808647_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-d0c7b9a78f365773c12d290ba2808647_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>其中p1,p2,p3是上一时刻青蛙在各格子的可能性，p′1,p′2,p′3则是下一时刻青蛙在各格子的可能性。假设上一时刻青蛙在格子1，那么 p1=1,p2=p3=0，乘一下就会发现，p′1,p′2,p′3恰好等于前面说的0.2, 0.3, 0.5。这个矩阵被称作转移概率矩阵，也就通过是每一时刻各点概率可以决定下一时刻各点概率，并且下一时刻各点概率仅与上一时刻各点概率相关。</p><p>以上的青蛙跳跃模型就是马尔科夫模型。那什么是<b>隐马尔可夫模型</b>呢？</p><p>我们给上面的青蛙增加一个叫的能力，每一时刻他都会发出一次叫声。并且它的叫声分两种，分别是叫声1和叫声2。而青蛙身处每个格子里时，发出各种叫声的概率是不一样的。假设青蛙在格子1中发出两种叫声的概率分别是0.2, 0.8；在格子2中发出两种叫声的概率分别是0.3, 0.7；在格子3中发出两种叫声的概率分别是0.6, 0.4。那么我们同样也可以用一个矩阵来描述这个过程：</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-b72b06424b0af860695754db8055a098_b.jpg" data-caption="" data-size="normal" data-rawwidth="499" data-rawheight="109" class="origin_image zh-lightbox-thumb" width="499" data-original="https://pic1.zhimg.com/v2-b72b06424b0af860695754db8055a098_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-b72b06424b0af860695754db8055a098_b.jpg" data-caption="" data-size="normal" data-rawwidth="499" data-rawheight="109" class="origin_image zh-lightbox-thumb lazy" width="499" data-original="https://pic1.zhimg.com/v2-b72b06424b0af860695754db8055a098_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-b72b06424b0af860695754db8055a098_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>现在，我们做一个重要假设：如果盒子被一块黑布盖起来，我们只能听到青蛙的叫声，不能看到青蛙的确切位置。现在的流程图大致变成了这样：</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-8805c8f28fa3ecc822904d5f8bfb389f_b.jpg" data-caption="" data-size="normal" data-rawwidth="815" data-rawheight="411" class="origin_image zh-lightbox-thumb" width="815" data-original="https://pic4.zhimg.com/v2-8805c8f28fa3ecc822904d5f8bfb389f_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-8805c8f28fa3ecc822904d5f8bfb389f_b.jpg" data-caption="" data-size="normal" data-rawwidth="815" data-rawheight="411" class="origin_image zh-lightbox-thumb lazy" width="815" data-original="https://pic4.zhimg.com/v2-8805c8f28fa3ecc822904d5f8bfb389f_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-8805c8f28fa3ecc822904d5f8bfb389f_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>红圈代表每一时刻青蛙处在哪个格子，我们看不到（i,隐状态序列）；蓝圈代表每一刻青蛙会发出哪种叫声，我们听得到（o,观测序列）。但并不是每一时刻的叫声决定下一时刻的叫声，而是每一时刻的格子决定下一时刻的格子（A，转移概率矩阵），然后由格子来确定叫声（B，混淆矩阵）。当然，为了决定这个序列，我们需要知道青蛙最一开始处于哪个格子，或者处在各格子中的概率（π，初始状态）。记λ=（A，B，π），这三者就决定了一个隐马尔可夫（HMM）模型。</p><p>HMM模型有三个基本问题需要解决。</p><p><b>1、评估问题。</b>给定模型λ=（A，B，π）和观测序列O={o1，o2……ot}，计算在模型λ下出现这个观测序列的概率。这个问题的求解需要用到前向后向算法，是HMM模型三个问题中最简单的。</p><p><b>2、学习问题。</b>给定观测序列O={o1，o2……ot}，估计模型参数λ=（A，B，π），使得在这个模型下出现观测序列的概率P（O|λ）最大。这个问题的求解需要用到基于EM算法的鲍姆-韦尔奇算法，是HMM模型三个问题中最复杂的。</p><p><b>3、解码问题。</b>给定模型λ=（A，B，π）和观测序列O={o1，o2……ot}，求给定观测序列条件下，最可能出现的对应的状态序列，这个问题的求解需要用到基于动态规划的维特比算法，是HMM模型三个问题中复杂度居中的。</p><p>想了解更多与算法和原理相关的问题，可以参考CSDN上<a href="https://link.zhihu.com/?target=http%3A//www.cnblogs.com/pinard/p/6945257.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">刘建平Pinard的博客</a>。</p><p><b>隐马尔可夫模型在Python上的实现</b></p><p>Python 的第三方库 hmmlearn 可以高效地解决以上三个问题。具体使用方法同样可以参照<a href="https://link.zhihu.com/?target=https%3A//www.cnblogs.com/pinard/p/7001397.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">刘建平Pinard的博客</a>。</p><p>本研究仅用到了该库的一个函数。</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-48b9e1326a84d06af4e5a0d5b36d6187_b.jpg" data-caption="" data-size="normal" data-rawwidth="657" data-rawheight="32" class="origin_image zh-lightbox-thumb" width="657" data-original="https://pic4.zhimg.com/v2-48b9e1326a84d06af4e5a0d5b36d6187_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-48b9e1326a84d06af4e5a0d5b36d6187_b.jpg" data-caption="" data-size="normal" data-rawwidth="657" data-rawheight="32" class="origin_image zh-lightbox-thumb lazy" width="657" data-original="https://pic4.zhimg.com/v2-48b9e1326a84d06af4e5a0d5b36d6187_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-48b9e1326a84d06af4e5a0d5b36d6187_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>GaussianHMM 是用于解决连续型变量的。n_components 表示这个模型的隐状态个数，covariance_type代表隐状态的方差矩阵的形式，n_iter代表迭代次数。.fit(X) 中的X是观测序列，也就是fit这个操作是让模型根据观测序列X去拟合最优的λ=（A，B，π），并存储于model中。</p><p>具体关于该库的其他函数，可以参考<a href="https://link.zhihu.com/?target=http%3A//hmmlearn.readthedocs.io/en/latest/tutorial.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">官方文档</a>。</p><p class="ztext-empty-paragraph"><br/></p><p><b>单特征因子的隐马尔可夫模型在商品期货上的应用</b></p><p>我们以国内商品市场上日均交易量最大、交易最为活跃的螺纹钢主力合约作为研究对象。研究时间选取2009-06-11至2015-12-31。</p><p>我们可以选取不同的技术指标作为观测序列，来拟合隐状态序列，进而使用每天隐状态和次日收益率的关系来对未来收益率进行估计。我们尝试使用RSI作为输入的技术指标。关于RSI的使用方法可以参考聚宽的<a href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/data/dict/technicalanalysis%23rsi-%25E7%259B%25B8%25E5%25AF%25B9%25E5%25BC%25BA%25E5%25BC%25B1%25E6%258C%2587%25E6%25A0%2587" class=" wrap external" target="_blank" rel="nofollow noreferrer">技术指标讲解</a>。我们假定隐状态的个数为6个，并对模型进行拟合。</p><p>对输入的特征因子（RSI）绘制直方图，发现其大致符合0~100之间的正态分布。</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-64df2ebcb3f526ebcb0a7f2bc2dfbd37_b.jpg" data-caption="" data-size="normal" data-rawwidth="491" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="491" data-original="https://pic4.zhimg.com/v2-64df2ebcb3f526ebcb0a7f2bc2dfbd37_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-64df2ebcb3f526ebcb0a7f2bc2dfbd37_b.jpg" data-caption="" data-size="normal" data-rawwidth="491" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="491" data-original="https://pic4.zhimg.com/v2-64df2ebcb3f526ebcb0a7f2bc2dfbd37_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-64df2ebcb3f526ebcb0a7f2bc2dfbd37_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>在得到转移概率矩阵后，绘制转移矩阵热力图。图中格子含义为隐状态由纵坐标所在格子转移至横坐标所在格子的概率。可以看出，大部分隐状态都是比较“懒惰”的，转移至其他隐状态的概率并不太高。</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-cfebcb91c6261801827121dd547ffc90_b.jpg" data-caption="" data-size="normal" data-rawwidth="451" data-rawheight="338" class="origin_image zh-lightbox-thumb" width="451" data-original="https://pic1.zhimg.com/v2-cfebcb91c6261801827121dd547ffc90_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-cfebcb91c6261801827121dd547ffc90_b.jpg" data-caption="" data-size="normal" data-rawwidth="451" data-rawheight="338" class="origin_image zh-lightbox-thumb lazy" width="451" data-original="https://pic1.zhimg.com/v2-cfebcb91c6261801827121dd547ffc90_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-cfebcb91c6261801827121dd547ffc90_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>在得到隐状态序列后，我们需要了解每种隐状态对应该时刻RSI因子和对应下一时刻收益率的情况。以下6图为每一时刻的隐状态对应下一时刻收益率的分布情况。</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-60292d885cbee81f777839f11d229543_b.jpg" data-caption="" data-size="normal" data-rawwidth="325" data-rawheight="203" class="content_image" width="325"/></noscript><img src="https://pic4.zhimg.com/v2-60292d885cbee81f777839f11d229543_b.jpg" data-caption="" data-size="normal" data-rawwidth="325" data-rawheight="203" class="content_image lazy" width="325" data-actualsrc="https://pic4.zhimg.com/v2-60292d885cbee81f777839f11d229543_b.jpg"/></figure><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-dc4575aa0944036caf8b5d33ebc5a229_b.jpg" data-caption="" data-size="normal" data-rawwidth="310" data-rawheight="203" class="content_image" width="310"/></noscript><img src="https://pic2.zhimg.com/v2-dc4575aa0944036caf8b5d33ebc5a229_b.jpg" data-caption="" data-size="normal" data-rawwidth="310" data-rawheight="203" class="content_image lazy" width="310" data-actualsrc="https://pic2.zhimg.com/v2-dc4575aa0944036caf8b5d33ebc5a229_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-eff5082c22901cd5f3ecf165a49aac7a_b.jpg" data-caption="" data-size="normal" data-rawwidth="325" data-rawheight="203" class="content_image" width="325"/></noscript><img src="https://pic3.zhimg.com/v2-eff5082c22901cd5f3ecf165a49aac7a_b.jpg" data-caption="" data-size="normal" data-rawwidth="325" data-rawheight="203" class="content_image lazy" width="325" data-actualsrc="https://pic3.zhimg.com/v2-eff5082c22901cd5f3ecf165a49aac7a_b.jpg"/></figure><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-5569c04cf78d3861a3ad6bece67cf414_b.jpg" data-caption="" data-size="normal" data-rawwidth="320" data-rawheight="203" class="content_image" width="320"/></noscript><img src="https://pic1.zhimg.com/v2-5569c04cf78d3861a3ad6bece67cf414_b.jpg" data-caption="" data-size="normal" data-rawwidth="320" data-rawheight="203" class="content_image lazy" width="320" data-actualsrc="https://pic1.zhimg.com/v2-5569c04cf78d3861a3ad6bece67cf414_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-147146cc2cd1c41086d9ed9a873e5e38_b.jpg" data-caption="" data-size="normal" data-rawwidth="325" data-rawheight="203" class="content_image" width="325"/></noscript><img src="https://pic1.zhimg.com/v2-147146cc2cd1c41086d9ed9a873e5e38_b.jpg" data-caption="" data-size="normal" data-rawwidth="325" data-rawheight="203" class="content_image lazy" width="325" data-actualsrc="https://pic1.zhimg.com/v2-147146cc2cd1c41086d9ed9a873e5e38_b.jpg"/></figure><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-070bfdf5afd39ebeaa44bddc9fbf306e_b.jpg" data-caption="" data-size="normal" data-rawwidth="320" data-rawheight="203" class="content_image" width="320"/></noscript><img src="https://pic3.zhimg.com/v2-070bfdf5afd39ebeaa44bddc9fbf306e_b.jpg" data-caption="" data-size="normal" data-rawwidth="320" data-rawheight="203" class="content_image lazy" width="320" data-actualsrc="https://pic3.zhimg.com/v2-070bfdf5afd39ebeaa44bddc9fbf306e_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>将不同隐状态以不同颜色绘制在对应的收盘价上。</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-2eac7f5a2c1194ef242a7e563e805b6f_b.jpg" data-caption="" data-size="normal" data-rawwidth="500" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="500" data-original="https://pic4.zhimg.com/v2-2eac7f5a2c1194ef242a7e563e805b6f_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-2eac7f5a2c1194ef242a7e563e805b6f_b.jpg" data-caption="" data-size="normal" data-rawwidth="500" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="500" data-original="https://pic4.zhimg.com/v2-2eac7f5a2c1194ef242a7e563e805b6f_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-2eac7f5a2c1194ef242a7e563e805b6f_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>那在得到了每天的隐状态后，怎么根据隐状态来判断次日的交易方式呢？我们对每个隐状态都构建一个多头策略，即构建6个策略。每个策略都是仅在一个因子出现时做多，其他因子出现时空仓，因子的出现以模型拟合出的隐状态序列为准。例如，在1000天的观测中，第1天到第100天为状态1，其他交易日没有出现状态1，那策略1就是在第2天到第101天做多，其他日子空仓，其他策略类似。这6个策略如果跑完后的收益为正，就做多该因子；结果为负，就做空该因子。我们得到的各因子多头策略净值图为：</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-57aced571d4f3ad1a40e95f2d28ec681_b.jpg" data-caption="" data-size="normal" data-rawwidth="491" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="491" data-original="https://pic2.zhimg.com/v2-57aced571d4f3ad1a40e95f2d28ec681_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-57aced571d4f3ad1a40e95f2d28ec681_b.jpg" data-caption="" data-size="normal" data-rawwidth="491" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="491" data-original="https://pic2.zhimg.com/v2-57aced571d4f3ad1a40e95f2d28ec681_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-57aced571d4f3ad1a40e95f2d28ec681_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>值得一提的是，在绘制上面两张图时，我们采用的隐状态序列都是每一天出现概率最大的隐状态。比如，在经过计算后某一天六种隐状态出现的概率分别为 (0.1, 0.2, 0.2, 0.1, 0.3, 0.1)，那么模型就会认为这一天的隐状态是5号，但这样其实浪费了一些有关其他因子的信息。如果我们将每天的次日收益率与当日各隐状态出现的概率相乘，作为隐状态因子的“预期”收益率，再对每天的预期收益率构建多头/空仓策略并判断哪种因子做多、哪种因子做空，这样的方法可以反应更多模型的信息。这种方法操作相对而言较为困难，并且重要缺点是时间开销太大，感兴趣的同学可以自己加以尝试。提示：可以利用 hmmlearn 里的 predict_proba 函数。我们称这种方法为“平均预期”方法，而之前的以出现概率最大隐状态作为当日隐状态的方法称为“最大概率”方法。</p><p>本研究主要采取的还是最大概率的方法。在这种方法下，我们进行多头/空仓策略得到的结果是：在出现1号和6号因子的时候做多，出现2345号因子时做空。以此策略进行回测，可得到净值收益曲线和回撤曲线如下。蓝色曲线为净值收益曲线，对应y轴为左侧轴；红色为回撤曲线，y轴为右侧轴。</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-c734f05f20e3b77ff703391c0cbc6a02_b.jpg" data-caption="" data-size="normal" data-rawwidth="512" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="512" data-original="https://pic3.zhimg.com/v2-c734f05f20e3b77ff703391c0cbc6a02_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-c734f05f20e3b77ff703391c0cbc6a02_b.jpg" data-caption="" data-size="normal" data-rawwidth="512" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="512" data-original="https://pic3.zhimg.com/v2-c734f05f20e3b77ff703391c0cbc6a02_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-c734f05f20e3b77ff703391c0cbc6a02_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>至此，我们的样本内回测就完成了。但这个回测方法其实存在一个问题：在预测隐状态序列时，我们其实用到了全体样本的特征因子。但事实上，我们如果想要真实使用这个方法，在预测下一日收益率时只有当日及之前特征因子和隐状态的信息，而没有之后特征因子的信息。所以接下来，我们要使用样本外回测。即：使用过去若干天（例：20天）的特征信息，拟合过去20天的隐状态序列，建立19对“前一日隐状态-后一日收益率”的关系，并利用这些关系构建多头策略以确定每种隐状态应做多还是做空；然后考察最后一天的隐状态，并以此决定下一交易日的交易策略。</p><p>另外，我们还希望将宏观数据纳入考量范围。由于研究对象是螺纹钢，所以我们采用了全国工业分行业增长速度中的黑色金属矿采选业增加值_同比增长(%)，具体可以参考聚宽<u>宏观经济数据</u>。（详情请点击[阅读原文]到聚宽社区查看）该指标为月度数据，所以为了将其与日度数据对齐，我们将每月的该数据对应进该月的每一个交易日中。由于rsi指标在数值较大时是买入信号，而黑色金属矿采选业增加值较大时也是买入信号，所以我们对二者进行处理，方法是：rsi′=rsi∗(1+yoy/100)，其中 rsi’为新的特征因子，yoy 为黑色金属矿采选业增加值同比增长率。</p><p>同时，在进行样本内外回测时，我们希望能控制特征因子类型、样本外回测时向前回溯的天数和是否要采取归一化方法。归一化方法是指，我们在输入一个特征因子时可能对他的正态性或者偏态情况等不满意，就可以采取归一化的方式进行处理。在这个函数中，我们支持的归一化方法有 box_cox 方法，均值-方差标准化方法，以及映射至[0,1]区间的方法。</p><p>最终，我们构建的函数为：</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-5a4522edad6596236b966f7e892b0fe9_b.jpg" data-caption="" data-size="normal" data-rawwidth="393" data-rawheight="36" class="content_image" width="393"/></noscript><img src="https://pic2.zhimg.com/v2-5a4522edad6596236b966f7e892b0fe9_b.jpg" data-caption="" data-size="normal" data-rawwidth="393" data-rawheight="36" class="content_image lazy" width="393" data-actualsrc="https://pic2.zhimg.com/v2-5a4522edad6596236b966f7e892b0fe9_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>其中，func 为特征因子名，如 RSI、ROC 等；注意，如果取的指标有多个返回值，需要在函数体内部进行修改。delta_days 为进行样本外回测时向前追溯的天数，stdmtd 为标准化的方法，mac 为宏观数据。</p><p>由于样本内回测用到了未来数据，所以样本内回测的结果都是比较好的。在多次进行回测后，我们发现使用 CCI 技术指标，使用均值方差标准化的方法得到的回测收益比较接近市场收益，其他方法大多很难跑赢市场。我们认为，单因子的方法可能会遗漏较多信息，并且我们选取的大多数指标都是比较流行的指标，所以很难取得超额收益。</p><p>func=CCI,delta_days=20,stdmtd=&#39;mean_std&#39;</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-60a7bdf6009b1a4942a0a3c01341ccc7_b.jpg" data-caption="" data-size="normal" data-rawwidth="488" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="488" data-original="https://pic4.zhimg.com/v2-60a7bdf6009b1a4942a0a3c01341ccc7_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-60a7bdf6009b1a4942a0a3c01341ccc7_b.jpg" data-caption="" data-size="normal" data-rawwidth="488" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="488" data-original="https://pic4.zhimg.com/v2-60a7bdf6009b1a4942a0a3c01341ccc7_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-60a7bdf6009b1a4942a0a3c01341ccc7_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>func=KD,delta_days=20,stdmtd=&#39;map01&#39;</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-85879b8258290ad6bc49f4c4e1e98939_b.jpg" data-caption="" data-size="normal" data-rawwidth="488" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="488" data-original="https://pic2.zhimg.com/v2-85879b8258290ad6bc49f4c4e1e98939_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-85879b8258290ad6bc49f4c4e1e98939_b.jpg" data-caption="" data-size="normal" data-rawwidth="488" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="488" data-original="https://pic2.zhimg.com/v2-85879b8258290ad6bc49f4c4e1e98939_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-85879b8258290ad6bc49f4c4e1e98939_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>func=RSI,delta_days=20,stdmtd=&#39;mean_std&#39;,mac=&#39;black_metal_mining_yoy&#39;</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-2bb580491d5d403b17c3c70bd6ffd81e_b.jpg" data-caption="" data-size="normal" data-rawwidth="488" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="488" data-original="https://pic3.zhimg.com/v2-2bb580491d5d403b17c3c70bd6ffd81e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-2bb580491d5d403b17c3c70bd6ffd81e_b.jpg" data-caption="" data-size="normal" data-rawwidth="488" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="488" data-original="https://pic3.zhimg.com/v2-2bb580491d5d403b17c3c70bd6ffd81e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-2bb580491d5d403b17c3c70bd6ffd81e_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>func=RSI,delta_days=20,stdmtd=&#39;mean_std&#39;</p><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-af1742325c17af1a2cc973c34a181334_b.jpg" data-caption="" data-size="normal" data-rawwidth="488" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="488" data-original="https://pic1.zhimg.com/v2-af1742325c17af1a2cc973c34a181334_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-af1742325c17af1a2cc973c34a181334_b.jpg" data-caption="" data-size="normal" data-rawwidth="488" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="488" data-original="https://pic1.zhimg.com/v2-af1742325c17af1a2cc973c34a181334_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-af1742325c17af1a2cc973c34a181334_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p class="ztext-empty-paragraph"><br/></p><p><b>问题和可能改进的方法</b></p><p>本研究仅考虑了使用单因子的情况，但就像研究结果显示的那样，我们的样本外回测结果并不好。日后可以尝试更多的因子，或者同时输入多个因子作为特征因子。</p><p>本研究没有考虑日内止盈和止损，以及加杠杆的情况。另外，也没有设置滑点。这些细节在未来进一步研究时都应该有所考虑。</p><p class="ztext-empty-paragraph"><br/></p><p class="ztext-empty-paragraph"><br/></p><p><b>参考文献：</b></p><p>&gt;<b>《基于单特征因子的隐马尔科夫模型在商品期货上的应用》</b>，朱剑涛，东方证券</p><p>&gt;<b>《Tutorial—hmmlearn 0.2.1 documentation》</b></p><p>&gt;<b>《隐马尔可夫模型HMM》</b>，刘建平Pinard，CSDNBlog</p><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
