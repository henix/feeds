<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>TiKV 源码解析系列文章（一）序</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/55903728">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-45344636130df31b6603635f27d9b9c1_b.jpg" alt=""></div><p>作者：唐刘</p><p><a href="http://link.zhihu.com/?target=https%3A//github.com/tikv/tikv" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiKV</a> 是一个支持事务的分布式 Key-Value 数据库，有很多社区开发者基于 TiKV 来开发自己的应用，譬如 <a href="http://link.zhihu.com/?target=https%3A//github.com/meitu/titan" class=" wrap external" target="_blank" rel="nofollow noreferrer">titan</a>、<a href="http://link.zhihu.com/?target=https%3A//github.com/yongman/tidis" class=" wrap external" target="_blank" rel="nofollow noreferrer">tidis</a>。尤其是在 TiKV 成为 <a href="http://link.zhihu.com/?target=https%3A//www.cncf.io/" class=" wrap external" target="_blank" rel="nofollow noreferrer">CNCF</a> 的 <a href="http://link.zhihu.com/?target=https%3A//www.cncf.io/blog/2018/08/28/cncf-to-host-tikv-in-the-sandbox/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Sandbox</a> 项目之后，吸引了越来越多开发者的目光，很多同学都想参与到 TiKV 的研发中来。这时候，就会遇到两个比较大的拦路虎：</p><ol><li><a href="http://link.zhihu.com/?target=https%3A//www.rust-lang.org/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Rust</a> 语言：众所周知，TiKV 是使用 Rust 语言来进行开发的，而 Rust 语言的学习难度相对较高，有些人认为其学习曲线大于 C++，所以很多同学在这一步就直接放弃了。</li><li>文档：最开始 TiKV 是作为 HTAP 数据库 <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiDB</a> 的一个底层存储引擎设计并开发出来的，属于内部系统，缺乏详细的文档，以至于同学们不知道 TiKV 是怎么设计的，以及代码为什么要这么写。</li></ol><p>对于第一个问题，我们内部正在制作一系列的 Rust 培训课程，由 Rust 作者以及 Rust 社区知名的开发者亲自操刀，预计会在今年第一季度对外发布。希望通过该课程的学习，大家能快速入门 Rust，使用 Rust 开发自己的应用。</p><p>而对于第二个问题，我们会启动 《TiKV 源码解析系列文章》以及 《Deep Dive TiKV 系列文章》计划，在《Deep Dive TiKV 系列文章》中，我们会详细介绍与解释 TiKV 所使用技术的基本原理，譬如 Raft 协议的说明，以及我们是如何对 Raft 做扩展和优化的。而 《TiKV 源码解析系列文章》则是会从源码层面给大家抽丝剥茧，让大家知道我们内部到底是如何实现的。我们希望，通过这两个系列，能让大家对 TiKV 有更深刻的理解，再加上 Rust 培训，能让大家很好的参与到 TiKV 的开发中来。</p><h2><b>结构</b></h2><p>本篇文章是《TiKV 源码解析系列文章》的序篇，会简单的给大家讲一下 TiKV 的基本模块，让大家对这个系统有一个整体的了解。</p><p>要理解 TiKV，只是了解 <a href="http://link.zhihu.com/?target=https%3A//github.com/tikv/tikv" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/tikv/tikv</span><span class="invisible"></span></a> 这一个项目是远远不够的，通常，我们也需要了解很多其他的项目，包括但不限于：</p><ul><li><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/raft-rs" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/pingcap/raft</span><span class="invisible">-rs</span><span class="ellipsis"></span></a></li><li><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/rust-prometheus" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/pingcap/rust</span><span class="invisible">-prometheus</span><span class="ellipsis"></span></a></li><li><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/rust-rocksdb" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/pingcap/rust</span><span class="invisible">-rocksdb</span><span class="ellipsis"></span></a></li><li><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/fail-rs" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/pingcap/fail</span><span class="invisible">-rs</span><span class="ellipsis"></span></a></li><li><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/rocksdb" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/pingcap/rock</span><span class="invisible">sdb</span><span class="ellipsis"></span></a></li><li><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/grpc-rs" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/pingcap/grpc</span><span class="invisible">-rs</span><span class="ellipsis"></span></a></li><li><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/pd" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/pingcap/pd</span><span class="invisible"></span></a></li></ul><p>在这个系列里面，我们首先会从 TiKV 使用的周边库开始介绍，然后介绍 TiKV，最后会介绍 <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/pd" class=" wrap external" target="_blank" rel="nofollow noreferrer">PD</a>。下面简单来说下我们的一些介绍计划。</p><p><b>Storage Engine</b></p><p>TiKV 现在使用 <a href="http://link.zhihu.com/?target=https%3A//github.com/facebook/rocksdb" class=" wrap external" target="_blank" rel="nofollow noreferrer">RocksDB</a> 作为底层数据存储方案。在 pingcap/rust-rocksdb 这个库里面，我们会简单说明 Rust 是如何通过 Foreign Function Interface (FFI) 来跟 C library 进行交互，以及我们是如何将 RocksDB 的 C API 封装好给 Rust 使用的。</p><p>另外，在 pingcap/rocksdb 这个库里面，我们会详细的介绍我们自己研发的 Key-Value 分离引擎 - <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/rocksdb/tree/titan-5.15" class=" wrap external" target="_blank" rel="nofollow noreferrer">Titan</a>，同时也会让大家知道如何使用 RocksDB 对外提供的接口来构建自己的 engine。</p><p><b>Raft</b></p><p>TiKV 使用的是 <a href="http://link.zhihu.com/?target=https%3A//raft.github.io/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Raft</a> 一致性协议。为了保证算法的正确性，我们直接将 <a href="http://link.zhihu.com/?target=https%3A//github.com/etcd-io/etcd" class=" wrap external" target="_blank" rel="nofollow noreferrer">etcd</a> 的 Go 实现 port 成了 Rust。在 pingcap/raft-rs，我们会详细介绍 Raft 的选举，Log 复制，snapshot 这些基本的功能是如何实现的。</p><p>另外，我们还会介绍对 Raft 的一些优化，譬如 pre-vote，check quorum 机制，batch 以及 pipeline。</p><p>最后，我们会说明如何去使用这个 Raft 库，这样大家就能在自己的应用里面集成 Raft 了。</p><p><b>gRPC</b></p><p>TiKV 使用的是 <a href="http://link.zhihu.com/?target=https%3A//grpc.io/" class=" wrap external" target="_blank" rel="nofollow noreferrer">gRPC</a> 作为通讯框架，我们直接把 Google <a href="http://link.zhihu.com/?target=https%3A//github.com/grpc/grpc" class=" wrap external" target="_blank" rel="nofollow noreferrer">C gRPC</a> 库封装在 grpc-rs 这个库里面。我们会详细告诉大家如何去封装和操作 C gRPC 库，启动一个 gRPC 服务。</p><p>另外，我们还会介绍如何使用 Rust 的 <a href="http://link.zhihu.com/?target=https%3A//github.com/rust-lang-nursery/futures-rs" class=" wrap external" target="_blank" rel="nofollow noreferrer">futures-rs</a> 来将异步逻辑变成类似同步的方式来处理，以及如何通过解析 protobuf 文件来生成对应的 API 代码。</p><p>最后，我们会介绍如何基于该库构建一个简单的 gRPC 服务。</p><p><b>Prometheus</b></p><p>TiKV 使用 <a href="http://link.zhihu.com/?target=https%3A//prometheus.io/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Prometheus</a> 作为其监控系统， <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/rust-prometheus" class=" wrap external" target="_blank" rel="nofollow noreferrer">rust-prometheus</a> 这个库是 Prometheus 的 Rust client。在这个库里面，我们会介绍如果支持不同的 Prometheus 的数据类型（Coutner，Gauge，Historgram）。</p><p>另外，我们会重点介绍我们是如何通过使用 Rust 的 Macro 来支持 Prometheus 的 Vector metrics 的。</p><p>最后，我们会介绍如何在自己的项目里面集成 Prometheus client，将自己的 metrics 存到 Prometheus 里面，方便后续分析。</p><p><b>Fail</b></p><p><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/fail-rs" class=" wrap external" target="_blank" rel="nofollow noreferrer">Fail</a> 是一个错误注入的库。通过这个库，我们能很方便的在代码的某些地方加上 hook，注入错误，然后在系统运行的时候触发相关的错误，看系统是否稳定。</p><p>我们会详细的介绍 Fail 是如何通过 macro 来注入错误，会告诉大家如何添加自己的 hook，以及在外面进行触发</p><p><b>TiKV</b></p><p>TiKV 是一个非常复杂的系统，这块我们会重点介绍，主要包括：</p><ol><li>Raftstore，该模块里面我们会介绍 TiKV 如何使用 Raft，如何支持 Multi-Raft。</li><li>Storage，该模块里面我们会介绍 Multiversion concurrency control (MVCC)，基于 <a href="http://link.zhihu.com/?target=https%3A//storage.googleapis.com/pub-tools-public-publication-data/pdf/36726.pdf" class=" wrap external" target="_blank" rel="nofollow noreferrer">Percolator</a> 的分布式事务的实现，数据在 engine 里面的存储方式，engine 操作相关的 API 等。</li><li>Server，该模块我们会介绍 TiKV 的 gRPC API，以及不同函数执行流程。</li><li>Coprocessor，该模块我们会详细介绍 TiKV 是如何处理 TiDB 的下推请求的，如何通过不同的表达式进行数据读取以及计算的。</li><li>PD，该模块我们会介绍 TiKV 是如何跟 PD 进行交互的。</li><li>Import，该模块我们会介绍 TiKV 如何处理大量数据的导入，以及如何跟 TiDB 数据导入工具 <a href="http://link.zhihu.com/?target=https%3A//www.pingcap.com/docs/tools/lightning/overview-architecture/" class=" wrap external" target="_blank" rel="nofollow noreferrer">lightning</a> 交互的。</li><li>Util，该模块我们会介绍一些 TiKV 使用的基本功能库。</li></ol><p><b>PD</b></p><p><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/pd" class=" wrap external" target="_blank" rel="nofollow noreferrer">PD</a> 用来负责整个 TiKV 的调度，我们会详细的介绍 PD 内部是如何使用 etcd 来进行元数据存取和高可用支持，也会介绍 PD 如何跟 TiKV 交互，如何生成全局的 ID 以及 timestamp。</p><p>最后，我们会详细的介绍 PD 提供的 scheduler，以及不同的 scheudler 所负责的事情，让大家能通过配置 scheduler 来让系统更加的稳定。</p><h2><b>小结</b></h2><p>上面简单的介绍了源码解析涉及的模块，还有一些模块譬如 <a href="http://link.zhihu.com/?target=https%3A//github.com/tikv/client-rust" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/tikv/client-</span><span class="invisible">rust</span><span class="ellipsis"></span></a> 仍在开发中，等完成之后我们也会进行源码解析。</p><p>我们希望通过该源码解析系列，能让大家对 TiKV 有一个更深刻的理解。当然，TiKV 的源码也是一直在不停的演化，我们也会尽量保证文档的及时更新。</p><p>最后，欢迎大家参与 TiKV 的开发。</p><p><br></p><p><i><b>更多阅读：</b></i></p><a href="http://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg" data-image-width="1200" data-image-height="1200" class=" wrap external" target="_blank" rel="nofollow noreferrer">博客</a><p></p><p></p><p></p><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
