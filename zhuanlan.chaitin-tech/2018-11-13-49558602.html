<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Drupal Contextual Link RCE</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/49558602">原文</a></p>
<div class="title-image"><img src="https://pic3.zhimg.com/v2-085bfea8e95a519fcf22af1bf24c3c58_r.jpg" alt=""></div><h2><b>0x00 参考链接</b><br></h2><ul><li>官方预警：https://www.drupal.org/sa-core-2018-006</li><li>commit：<br>https://github.com/drupal/drupal/commit/c8f0c39ca488cc29ed575b61c0acf45845d8efed#diff-483e0dea92d8d5caf8024c4a621b9ef5R374</li></ul><h2><b>0x01 前言</b></h2><p>10 月 17 日，Drupal 官方发布安全更新 SA-CORE-2018-006 ，修复了 5 个安全漏洞，其中包括 2 个高危漏洞和 3 个中危漏洞。其中 2 个高危漏洞为远程代码执行漏洞。</p><p>这里对其中 Drupal 8 Contextual Links 验证问题导致远程代码执行的漏洞进行复现。</p><p>根据官方漏洞简要说明得知该漏洞首先需要拥有 <code class="inline">Contextual Links</code> 模块的权限，并且由于对请求的links缺乏很好的验证导致了rce。</p><img src="https://pic3.zhimg.com/v2-a0426c2fd871d4824827873c891fd8a5_r.jpg" data-caption="" data-size="normal" data-rawwidth="742" data-rawheight="140" data-watermark="watermark" data-original-src="v2-a0426c2fd871d4824827873c891fd8a5" data-watermark-src="v2-7f1a123e4c8c3942c9ef4542f1e859d4" data-private-watermark-src=""><p>查看commit内容，怀疑如下内容为漏洞入口</p><img src="https://pic3.zhimg.com/v2-cd7c622c24320d6cc8f33f3d1c7ed53c_r.jpg" data-caption="" data-size="normal" data-rawwidth="910" data-rawheight="411" data-watermark="watermark" data-original-src="v2-cd7c622c24320d6cc8f33f3d1c7ed53c" data-watermark-src="v2-51f5cfb9ca6a743ab2d19fb4b69f96d1" data-private-watermark-src=""><h2><b>0x02 环境搭建</b></h2><p>通过如下命令搭建好drupal 8.5.2版本。</p><img src="https://pic1.zhimg.com/v2-f0ff97c72bd86f6c9a175925788b3379_r.jpg" data-caption="" data-size="normal" data-rawwidth="740" data-rawheight="96" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>根据权限要求登录管理账号添加 <code class="inline">Contextual Links</code> 模块权限，之后退出账号。</p><img src="https://pic4.zhimg.com/v2-8a7bbbfb5dcbaef803695abbfcef0bf4_r.jpg" data-caption="" data-size="normal" data-rawwidth="900" data-rawheight="216" data-watermark="watermark" data-original-src="v2-8a7bbbfb5dcbaef803695abbfcef0bf4" data-watermark-src="v2-26bf5c19825ea1840541ef1de1da58f0" data-private-watermark-src=""><h2><b>0x03 过程调试</b></h2><p>配置好代理burpsuite后，访问主页可抓取到如下请求。</p><img src="https://pic3.zhimg.com/v2-51a0afe19e419624b13b068f7b0b32e3_r.jpg" data-caption="" data-size="normal" data-rawwidth="901" data-rawheight="261" data-watermark="watermark" data-original-src="v2-51a0afe19e419624b13b068f7b0b32e3" data-watermark-src="v2-770d354a77fd778810b3e8cf8a650203" data-private-watermark-src=""><p>在 <code class="inline">core/modules/contextual/src/ContextualController.php</code> 的 <code class="inline">render</code> 函数中挂上断点，并只保留如下 <code class="inline">ids</code> 内容: <code class="inline">ids[]=block:block=bartik_footer:langcode=en|menu:menu=footer:langcode=en</code></p><img src="https://pic1.zhimg.com/v2-7c09bf036b5b4f2c121446ab57988e37_r.jpg" data-caption="" data-size="normal" data-rawwidth="898" data-rawheight="221" data-watermark="watermark" data-original-src="v2-7c09bf036b5b4f2c121446ab57988e37" data-watermark-src="v2-de0afdabab8dc90164cce52754593f96" data-private-watermark-src=""><img src="https://pic4.zhimg.com/v2-61ee58b4efa50280708fcccbf8a1b207_r.jpg" data-caption="" data-size="normal" data-rawwidth="894" data-rawheight="413" data-watermark="watermark" data-original-src="v2-61ee58b4efa50280708fcccbf8a1b207" data-watermark-src="v2-557a9f57668a43830e2e923519afa306" data-private-watermark-src=""><p>其中 <code class="inline">#contextual_links</code> 将会通过 <code class="inline">_contextual_id_to_links($id)</code> 函数获取 ，函数内容如下：</p><img src="https://pic4.zhimg.com/v2-98b34a76135bfb7c962c84d25bb2efc0_r.jpg" data-caption="" data-size="normal" data-rawwidth="745" data-rawheight="364" data-watermark="watermark" data-original-src="v2-98b34a76135bfb7c962c84d25bb2efc0" data-watermark-src="v2-3ac6c313068bac49440b1b85fb23f7fa" data-private-watermark-src=""><p>该函数将会将 <code class="inline">$id</code> 的内容通过 <code class="inline">|</code> 拆分，并通过 <code class="inline">:</code> 分割至变量 <code class="inline">$group</code>, <code class="inline">$route_parameters_raw</code>, <code class="inline">$metadata_raw</code>，之后 <code class="inline">$route_parameters_raw</code>, <code class="inline">$metadata_raw</code> 将会经过 <code class="inline">parse_str</code> 解析成变量，并最终赋值给 <code class="inline">$contextual_links[$group]</code> </p><img src="https://pic3.zhimg.com/v2-48e63b62b5c9d827e9657ac45808cd60_r.jpg" data-caption="" data-size="normal" data-rawwidth="898" data-rawheight="330" data-watermark="watermark" data-original-src="v2-48e63b62b5c9d827e9657ac45808cd60" data-watermark-src="v2-2c413d66b763bef9d7da9aa7dea988ee" data-private-watermark-src=""><p>这里将 <code class="inline">ids</code> 内容再缩短至： <code class="inline">ids[]=block:block=bartik_footer:langcode=en</code> </p><img src="https://pic3.zhimg.com/v2-7f1866a5f9bde1ba83cccf673cb6493f_r.jpg" data-caption="" data-size="normal" data-rawwidth="901" data-rawheight="448" data-watermark="watermark" data-original-src="v2-7f1866a5f9bde1ba83cccf673cb6493f" data-watermark-src="v2-98b330ec5daabc2b6da1b5f750b4ea4e" data-private-watermark-src=""><p>之后进入 <code class="inline">renderRoot</code> </p><img src="https://pic3.zhimg.com/v2-9fc7cca3f5e686f79a884dbf60f42da6_r.jpg" data-caption="" data-size="normal" data-rawwidth="898" data-rawheight="299" data-watermark="watermark" data-original-src="v2-9fc7cca3f5e686f79a884dbf60f42da6" data-watermark-src="v2-0cdbe5e12f867917fee84473e3896677" data-private-watermark-src=""><p>继续跟进 <code class="inline">executeInRenderContext</code> 函数，其中将 <code class="inline">$this-&gt;render($elements, TRUE)</code> 作为回调函数</p><img src="https://pic4.zhimg.com/v2-2c4151fa493536aceec3edcd18d0f249_r.jpg" data-caption="" data-size="normal" data-rawwidth="898" data-rawheight="252" data-watermark="watermark" data-original-src="v2-2c4151fa493536aceec3edcd18d0f249" data-watermark-src="v2-f2aa2f87355d001ad2d10613ff1e7c11" data-private-watermark-src=""><img src="https://pic2.zhimg.com/v2-539e099be7d76f260b91fe2948adfa8d_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="317" data-watermark="watermark" data-original-src="v2-539e099be7d76f260b91fe2948adfa8d" data-watermark-src="v2-c91d0fc8e4902366f720d1f1ba5d89d7" data-private-watermark-src=""><img src="https://pic3.zhimg.com/v2-b76d16a117d891bd21dddfcad62b6b54_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="491" data-watermark="watermark" data-original-src="v2-b76d16a117d891bd21dddfcad62b6b54" data-watermark-src="v2-9db6383a01f2a5c4f345f6a75032bfd4" data-private-watermark-src=""><p><code class="inline">$this-&gt;render</code> 最终将会进入 <code class="inline">doRender</code> 函数。</p><img src="https://pic2.zhimg.com/v2-006fa5535b26ee565297f96c069d41e0_r.jpg" data-caption="" data-size="normal" data-rawwidth="900" data-rawheight="394" data-watermark="watermark" data-original-src="v2-006fa5535b26ee565297f96c069d41e0" data-watermark-src="v2-1a02be1d38d88f8d3faf24e2950e4dc4" data-private-watermark-src=""><p>之后经过 <code class="inline">$this-&gt;elementInfo-&gt;getInfo</code> 函数。</p><img src="https://pic3.zhimg.com/v2-b666a2a8af6952fc6f58f0aee3904cb9_r.jpg" data-caption="" data-size="normal" data-rawwidth="897" data-rawheight="506" data-watermark="watermark" data-original-src="v2-b666a2a8af6952fc6f58f0aee3904cb9" data-watermark-src="v2-71d99435a45a1f1e6460ce622e31b277" data-private-watermark-src=""><p>这里主要是增加一些新属性。</p><img src="https://pic3.zhimg.com/v2-7643e7e8436c89e49441817429525e2b_r.jpg" data-caption="" data-size="normal" data-rawwidth="904" data-rawheight="441" data-watermark="watermark" data-original-src="v2-7643e7e8436c89e49441817429525e2b" data-watermark-src="v2-87422627ee38c0cf71154b6b92fa6bb4" data-private-watermark-src=""><p>其中添加了 <code class="inline">#pre_render</code> 将会进入预处理 <code class="inline">preRenderLinks</code> </p><img src="https://pic4.zhimg.com/v2-b80c79f4f151cd2325aaaa12d583e248_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="325" data-watermark="watermark" data-original-src="v2-b80c79f4f151cd2325aaaa12d583e248" data-watermark-src="v2-4de3a521956c44fb1c27dd47babd8ba1" data-private-watermark-src=""><p>其中跟进 <code class="inline">$contextual_links_manager-&gt;getContextualLinksArrayByGroup</code> </p><img src="https://pic2.zhimg.com/v2-9d4b2098d14198913c07fad81d37f25d_r.jpg" data-caption="" data-size="normal" data-rawwidth="900" data-rawheight="352" data-watermark="watermark" data-original-src="v2-9d4b2098d14198913c07fad81d37f25d" data-watermark-src="v2-272a2310ffff608a5021d78609b23317" data-private-watermark-src=""><p>这里将会通过 <code class="inline">$group_name</code> 在 <code class="inline">$this-&gt;pluginsByGroup</code> 进行一个匹配搜索，这里匹配成功进入后续循环体。</p><img src="https://pic4.zhimg.com/v2-94bc51f97e106afb6891ca8380ae60ec_r.jpg" data-caption="" data-size="normal" data-rawwidth="901" data-rawheight="372" data-watermark="watermark" data-original-src="v2-94bc51f97e106afb6891ca8380ae60ec" data-watermark-src="v2-643c7396fc0a7b6f3cfbadd3c6627290" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-81205008b4b1c6258d736c80947a0751_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="587" data-watermark="watermark" data-original-src="v2-81205008b4b1c6258d736c80947a0751" data-watermark-src="v2-49a4fea1ba22333ca5a3e4c3ca07aedc" data-private-watermark-src=""><p>但是这里由于并没有登录，所有没有访问权限跳出循环体，导致 <code class="inline">links</code> 变量为空。</p><img src="https://pic3.zhimg.com/v2-0aaefc2cdeb051d558612aef6683590d_r.jpg" data-caption="" data-size="normal" data-rawwidth="898" data-rawheight="447" data-watermark="watermark" data-original-src="v2-0aaefc2cdeb051d558612aef6683590d" data-watermark-src="v2-310b25bdca0b92c4ea026961f54d6eba" data-private-watermark-src=""><p>从而 <code class="inline">$element['#links']</code> 也为空，之后进入 <code class="inline">alter</code>，这里函数内容过程，主要关注最后的 <code class="inline">$function($data, $context1, $context2);</code> </p><img src="https://pic1.zhimg.com/v2-c3fd7481781a8021849acbb80c581ec8_r.jpg" data-caption="" data-size="normal" data-rawwidth="902" data-rawheight="332" data-watermark="watermark" data-original-src="v2-c3fd7481781a8021849acbb80c581ec8" data-watermark-src="v2-c8811ecc8f05c423927d2756b7d9af93" data-private-watermark-src=""><img src="https://pic3.zhimg.com/v2-e33c302300ecd54aba332aa92d5c2602_r.jpg" data-caption="" data-size="normal" data-rawwidth="900" data-rawheight="250" data-watermark="watermark" data-original-src="v2-e33c302300ecd54aba332aa92d5c2602" data-watermark-src="v2-f1299a890a4e610d497ff40565a08337" data-private-watermark-src=""><p>将会依次调用 <code class="inline">contextual_contextual_links_view_alter</code> 和 <code class="inline">views_ui_contextual_links_view_alter</code></p><p>其中 <code class="inline">contextual_contextual_links_view_alter</code> 代码如下：</p><img src="https://pic3.zhimg.com/v2-30f09a6c7e861a545681f01d7398ec29_r.jpg" data-caption="" data-size="normal" data-rawwidth="900" data-rawheight="409" data-watermark="watermark" data-original-src="v2-30f09a6c7e861a545681f01d7398ec29" data-watermark-src="v2-e0ab7b28ced7ef06cf7ac9c6f8509f48" data-private-watermark-src=""><p>可以看到，当存在 <code class="inline">$element['#contextual_links']['contextual'])</code> 时，将会将 <code class="inline">$element['#contextual_links']['contextual']['metadata']['contextual-views-field-links']</code> 内容赋值给 <code class="inline">$element['#links']</code>，这由于我们的 <code class="inline">$element['#contextual_links']['contextual'])</code> 没有设置，所以 <code class="inline">$element['#links']</code> 依旧为空，但是这部分我们是可控的。</p><p>之后执行完函数回到之前时，由于 <code class="inline">$element['#links']</code> 为空，则设置 <code class="inline">$element['#printed'] = TRUE;</code> </p><img src="https://pic2.zhimg.com/v2-31e99a95c39157a718a7383b385c7ac8_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="576" data-watermark="watermark" data-original-src="v2-31e99a95c39157a718a7383b385c7ac8" data-watermark-src="v2-ffcd2886812efb2690958338c955b6fc" data-private-watermark-src=""><p>这将导致返回空字符串内容。</p><img src="https://pic3.zhimg.com/v2-63fc64a0f3c22237b012df8e2ace1fdf_r.jpg" data-caption="" data-size="normal" data-rawwidth="898" data-rawheight="599" data-watermark="watermark" data-original-src="v2-63fc64a0f3c22237b012df8e2ace1fdf" data-watermark-src="v2-551ebfa498b36e10a81fbca750fba619" data-private-watermark-src=""><img src="https://pic2.zhimg.com/v2-94dd1d915ccdeb1ca4c12bb7c8cc29c8_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="245" data-watermark="watermark" data-original-src="v2-94dd1d915ccdeb1ca4c12bb7c8cc29c8" data-watermark-src="v2-6fe071a378a0a026a83cd6b695133371" data-private-watermark-src=""><h2><b>0x04 控制 $element['#links'] 变量</b></h2><p>所以我们可通过设置 <code class="inline">$element['#contextual_links']['contextual'])</code> 以及 <code class="inline">$element['#contextual_links']['contextual']['metadata']['contextual-views-field-links']</code> 来确保 <code class="inline">$element['#links']</code> 不为空。</p><p>对照 <code class="inline">#contextual_links</code> 中的变量进行修改，并且 <code class="inline">$element['#contextual_links']['contextual']['metadata']['contextual-views-field-links']</code> 需要为 <code class="inline">json</code> 格式，并且由于会通过 <code class="inline">:</code> 进行拆分所以 <code class="inline">:</code> 需要进行二次编码。</p><p>得到 <code class="inline">ids[]=contextual:block=bartik_footer:contextual-views-field-links={"aaa" %253A "bbb"}</code> </p><img src="https://pic1.zhimg.com/v2-6dd56786b321bf1661dc917761fa39e3_r.jpg" data-caption="" data-size="normal" data-rawwidth="744" data-rawheight="100" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>成功设置 <code class="inline">$element['#links']</code></p><img src="https://pic4.zhimg.com/v2-ee2a0438c59f4f448cb4ff050df9f85c_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="387" data-watermark="watermark" data-original-src="v2-ee2a0438c59f4f448cb4ff050df9f85c" data-watermark-src="v2-288ec0865dc69bd96627867e8f5aaff4" data-private-watermark-src=""><h2><b>0x05 寻找漏洞触发点</b></h2><p><code class="inline">$element['#links']</code> 虽然可控但是距离触发漏洞还有一定的距离，继续在 <code class="inline">doRender</code> 函数中查找漏洞触发点。</p><p>调试过之前drupal drupalgeddon漏洞的同学应该会知道，如果对 <code class="inline">$elements</code> 数组变量可控，可通过设置 <code class="inline">$elements['#pre_render']</code> 来触发 <code class="inline">call_user_func</code> 来达到RCE的目的，这里严重怀疑该漏洞也是通过该种方法得以触发。</p><p>继续调试，跟进 <code class="inline">$this-&gt;theme-&gt;render</code> </p><img src="https://pic2.zhimg.com/v2-06a56ad7932c30744a56c618362e6f18_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="479" data-watermark="watermark" data-original-src="v2-06a56ad7932c30744a56c618362e6f18" data-watermark-src="v2-679e160b056abd16291678cc353bbaf3" data-private-watermark-src=""><p>经过一系列繁琐的操作后将会依次调用如下函数，其中 <code class="inline">$variables[links]</code> 为我们所控。</p><img src="https://pic1.zhimg.com/v2-35a4c6c1f69ebc637544fd12a847ea3d_r.jpg" data-caption="" data-size="normal" data-rawwidth="900" data-rawheight="395" data-watermark="watermark" data-original-src="v2-35a4c6c1f69ebc637544fd12a847ea3d" data-watermark-src="v2-f6cdba1ec2a8642bed65195701bca4dc" data-private-watermark-src=""><p>跟进其中的 <code class="inline">template_preprocess_links</code> 函数，部分内容如下：</p><img src="https://pic1.zhimg.com/v2-d66f2e40123f6fa5b245403f94ad5f77_r.jpg" data-caption="" data-size="normal" data-rawwidth="795" data-rawheight="935" data-watermark="watermark" data-original-src="v2-d66f2e40123f6fa5b245403f94ad5f77" data-watermark-src="v2-cbbb9a85ebb50ddc4f8a361566d1a7bd" data-private-watermark-src=""><p>其中 <code class="inline">$link_element</code> 将通过 <code class="inline">$link</code> 变量进行设置，可以看到我们可控制其中的 <code class="inline">#title</code>，<code class="inline">#options</code>，<code class="inline">#url</code> 以及 <code class="inline">#ajax</code> 变量，这里由于传递的为 <code class="inline">{"aaa":"bbb"}</code> ，所以 <code class="inline">"bbb"</code> 不为数组导致报错。</p><img src="https://pic2.zhimg.com/v2-0e1b7dd67bcb506273b25b1c7c0b639e_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="519" data-watermark="watermark" data-original-src="v2-0e1b7dd67bcb506273b25b1c7c0b639e" data-watermark-src="v2-167a79f31729198a7e347ba20867f092" data-private-watermark-src=""><p>修改一下传递参数 <code class="inline">contextual-views-field-links</code> 内容：</p><img src="https://pic3.zhimg.com/v2-f10d0d25f7f4f0db48c296362615f3b6_r.jpg" data-caption="" data-size="normal" data-rawwidth="853" data-rawheight="30" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>成功设置 <code class="inline">$link_element</code> 变量。</p><img src="https://pic3.zhimg.com/v2-4abafaeccfa0bc7f5def4747e406a543_r.jpg" data-caption="" data-size="normal" data-rawwidth="893" data-rawheight="485" data-watermark="watermark" data-original-src="v2-4abafaeccfa0bc7f5def4747e406a543" data-watermark-src="v2-7865eaca0977e37f94350166fc8fa54f" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-0d4bed8a9dd97e0cf050fb616bbcbffb_r.jpg" data-caption="" data-size="normal" data-rawwidth="900" data-rawheight="451" data-watermark="watermark" data-original-src="v2-0d4bed8a9dd97e0cf050fb616bbcbffb" data-watermark-src="v2-050ae32875c67b5206b3d8e856b5717b" data-private-watermark-src=""><p>最后设置给了 <code class="inline">$variables['links']</code> </p><img src="https://pic2.zhimg.com/v2-f04b6ad790b32f3dcc671db4d883b0e6_r.jpg" data-caption="" data-size="normal" data-rawwidth="898" data-rawheight="468" data-watermark="watermark" data-original-src="v2-f04b6ad790b32f3dcc671db4d883b0e6" data-watermark-src="v2-c3598c57e67f14747fbce9a55b3046a9" data-private-watermark-src=""><p>最终进入页面render过程。</p><img src="https://pic2.zhimg.com/v2-e953e65a6f6e32f72f237199ea53183f_r.jpg" data-caption="" data-size="normal" data-rawwidth="901" data-rawheight="522" data-watermark="watermark" data-original-src="v2-e953e65a6f6e32f72f237199ea53183f" data-watermark-src="v2-1519ed6fe36abb69caf3cbbd2cb437d2" data-private-watermark-src=""><p>调用栈如下：</p><img src="https://pic4.zhimg.com/v2-f192def370cf69a37ad21a38c21de1b0_r.jpg" data-caption="" data-size="normal" data-rawwidth="893" data-rawheight="391" data-watermark="watermark" data-original-src="v2-f192def370cf69a37ad21a38c21de1b0" data-watermark-src="v2-1071755c923af33f4b1a37defeb4dfb4" data-private-watermark-src=""><p><code class="inline">$context</code> 内容如下：</p><img src="https://pic3.zhimg.com/v2-11e6fba5c84330441280f2f079efb8dc_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="463" data-watermark="watermark" data-original-src="v2-11e6fba5c84330441280f2f079efb8dc" data-watermark-src="v2-11eecaa54fd0e66f8087544d520f028c" data-private-watermark-src=""><p>之后代码简化如下：</p><img src="https://pic3.zhimg.com/v2-8c88d1e6d921c09d9ac2e76c7ee7c8b0_r.jpg" data-caption="" data-size="normal" data-rawwidth="798" data-rawheight="474" data-watermark="watermark" data-original-src="v2-8c88d1e6d921c09d9ac2e76c7ee7c8b0" data-watermark-src="v2-9eea36452585440adc42341d111aad3d" data-private-watermark-src=""><p>首先将 <code class="inline">$context["links"]</code> 赋值给 <code class="inline">$context['_seq']</code>，接着遍历键值对并根据是否包含相应的属性(<code class="inline">links</code>, <code class="inline">text_attributes</code>)进入不同的条件语句中，传递不同的属性值给 <code class="inline">escapeFilter</code> 函数。</p><p>这里由于包含 <code class="inline">link</code> 属性，即传递 <code class="inline">$context["item"]["link"]</code> </p><img src="https://pic4.zhimg.com/v2-673387371a36bc269c3968e58795ba09_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="492" data-watermark="watermark" data-original-src="v2-673387371a36bc269c3968e58795ba09" data-watermark-src="v2-8a8477eafc875971b350b2594be65766" data-private-watermark-src=""><p>之后跟进 <code class="inline">escapeFilter</code>，该函数将通过 <code class="inline">$arg</code> 变量类型来返回不同的值。</p><img src="https://pic3.zhimg.com/v2-f8823d64ee40acf0d61759c228ceb422_r.jpg" data-caption="" data-size="normal" data-rawwidth="794" data-rawheight="826" data-watermark="watermark" data-original-src="v2-f8823d64ee40acf0d61759c228ceb422" data-watermark-src="v2-91fd439662d2ac6702402342e8654c82" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-b514e3819ac6a413e769fad64cabbedd_r.jpg" data-caption="" data-size="normal" data-rawwidth="793" data-rawheight="403" data-watermark="watermark" data-original-src="v2-b514e3819ac6a413e769fad64cabbedd" data-watermark-src="v2-375ff5ff6e3d4f22d3b9ff53c55f4b9c" data-private-watermark-src=""><p>该代码中可以看到，因为<code class="inline">$arg</code>为数组, 所以<code class="inline">is_scalar($arg)=false</code>，使得<code class="inline">$return=NULL</code>，从而进入最后的<code class="inline">$this-&gt;renderer-&gt;render($arg)</code></p><img src="https://pic1.zhimg.com/v2-fceba98c1c6a419c8a3bf740743f509f_r.jpg" data-caption="" data-size="normal" data-rawwidth="897" data-rawheight="359" data-watermark="watermark" data-original-src="v2-fceba98c1c6a419c8a3bf740743f509f" data-watermark-src="v2-6b46e74888dd9ad8fdd17063279b0fb4" data-private-watermark-src=""><p><code class="inline">$this-&gt;renderer-&gt;render</code> 即为熟悉的 <code class="inline">doRender</code> </p><img src="https://pic2.zhimg.com/v2-83964f1d87330b4db7fb412fa36406c8_r.jpg" data-caption="" data-size="normal" data-rawwidth="899" data-rawheight="462" data-watermark="watermark" data-original-src="v2-83964f1d87330b4db7fb412fa36406c8" data-watermark-src="v2-ca1546039912ac83b74d3f2be6c8e170" data-private-watermark-src=""><p>所以综上可知 <code class="inline">$context["item"]</code> 的属性将会传递给 <code class="inline">doRender</code> 函数，只要完全控制属性值内容即可控制 <code class="inline">doRender</code> 函数的 <code class="inline">$elements</code> 变量，从而达到RCE的目的，但是这里传递的是 <code class="inline">link</code> 属性，并不完全可控。</p><p>回到前面 <code class="inline">if</code> 条件判断，如果不包含 <code class="inline">links</code> 属性的时候将会传递 <code class="inline">text</code> 属性，而 <code class="inline">text</code> 属性值内容完全可控，所以可以利用 <code class="inline">text</code> 属性来达到rce的目的。</p><img src="https://pic2.zhimg.com/v2-d400b5d0d57494fd26569823b38ba51a_r.jpg" data-caption="" data-size="normal" data-rawwidth="787" data-rawheight="472" data-watermark="watermark" data-original-src="v2-d400b5d0d57494fd26569823b38ba51a" data-watermark-src="v2-62c80576c8bfa650f7504ddfd89eecf5" data-private-watermark-src=""><img src="https://pic3.zhimg.com/v2-7db9dd670d77ed6ebe76face77401e41_r.jpg" data-caption="" data-size="normal" data-rawwidth="903" data-rawheight="395" data-watermark="watermark" data-original-src="v2-7db9dd670d77ed6ebe76face77401e41" data-watermark-src="v2-728ac9aaca1624f9719451a6c83d75d5" data-private-watermark-src=""><p>要想使得没有 <code class="inline">link</code> 属性在 <code class="inline">template_preprocess_links</code> 函数中可以看到，当没有 <code class="inline">url</code> 时，将不会设置 <code class="inline">$item['link']</code> </p><img src="https://pic1.zhimg.com/v2-59cf6a8c057435fac4685ca9e0a7f75a_r.jpg" data-caption="" data-size="normal" data-rawwidth="901" data-rawheight="479" data-watermark="watermark" data-original-src="v2-59cf6a8c057435fac4685ca9e0a7f75a" data-watermark-src="v2-7579b00615c1b58d97f2509a48848295" data-private-watermark-src=""><p>所以只需删除请求参数 <code class="inline">ids[]</code> 中的 <code class="inline">url</code> 部分即可，并且将 <code class="inline">title</code> 值内容修改为数组：</p><img src="https://pic2.zhimg.com/v2-168b78d1f577c969273379f20b26f7b0_r.jpg" data-caption="" data-size="normal" data-rawwidth="794" data-rawheight="76" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>得到：</p><img src="https://pic2.zhimg.com/v2-f9bddf12e4751ee08cd1e566da579f79_r.jpg" data-caption="" data-size="normal" data-rawwidth="796" data-rawheight="78" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>可以看到 <code class="inline">item</code> 没有 <code class="inline">link</code> 属性了。</p><img src="https://pic2.zhimg.com/v2-a846241a3b0775619950813fe271f1bd_r.jpg" data-caption="" data-size="normal" data-rawwidth="897" data-rawheight="407" data-watermark="watermark" data-original-src="v2-a846241a3b0775619950813fe271f1bd" data-watermark-src="v2-f4967ade222794872bef54fe37894564" data-private-watermark-src=""><p>进入 <code class="inline">render</code> 函数</p><img src="https://pic4.zhimg.com/v2-82ad92b64b69eb040d5819221c00fd7d_r.jpg" data-caption="" data-size="normal" data-rawwidth="896" data-rawheight="288" data-watermark="watermark" data-original-src="v2-82ad92b64b69eb040d5819221c00fd7d" data-watermark-src="v2-f7aa9bcc9ab4e4d7780c90190758642e" data-private-watermark-src=""><p>从而控制了 <code class="inline">doRender</code> 函数的 <code class="inline">$elements</code> 参数内容，之后可通过设置 <code class="inline">#pre_render</code> 等属性达到rce的目的。</p><img src="https://pic4.zhimg.com/v2-3b850931cd0fed4fcb3d62e6951358ce_r.jpg" data-caption="" data-size="normal" data-rawwidth="898" data-rawheight="348" data-watermark="watermark" data-original-src="v2-3b850931cd0fed4fcb3d62e6951358ce" data-watermark-src="v2-d1c9489ac70db08c05090a8b61e559dd" data-private-watermark-src=""><h2><b>0x06 RCE</b></h2><p>这里不提供完整exp，顺带说明一下这里只是通过commit调试下来的结果，并不清楚触发点是否与原漏洞发现者相同。</p><img src="https://pic1.zhimg.com/v2-0f9b120624cdd6cfcad36fe482b4b9ef_r.jpg" data-caption="" data-size="normal" data-rawwidth="897" data-rawheight="456" data-watermark="watermark" data-original-src="v2-0f9b120624cdd6cfcad36fe482b4b9ef" data-watermark-src="v2-80665cc651315f7453e7b426092dcb3b" data-private-watermark-src=""><h2><b>0x07 漏洞修复状况</b></h2><p>官方通过验证签名 `token` 的方式，使得 `token` 错误导致无法利用。</p><img src="https://pic2.zhimg.com/v2-391f591d0482049426bd71cd42945ba9_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="483" data-watermark="watermark" data-original-src="v2-391f591d0482049426bd71cd42945ba9" data-watermark-src="v2-998fe0812c08be831fec7d54526bb44b" data-private-watermark-src=""><p></p><p></p><p></p><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
</body>
</html>
