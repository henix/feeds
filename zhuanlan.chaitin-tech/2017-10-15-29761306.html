<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>开源！iOS 应用安全分析工具 Passionfruit</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/29761306">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-e590742eb8fe8628767544ef478ee70d_r.jpg" alt=""></div><p>Github 项目地址 <a href="https://github.com/chaitin/passionfruit">chaitin/passionfruit</a></p><h2>前情提要</h2><p>虽然没有 Android 平台那么多的攻击面和利用姿势，iOS 应用依然有安全审计的需求。移动平台的安全目前采用的策略基本上都是扫描器加上一部分人工的逆向和动态分析。</p><p>针对 iOS 应用攻击面分析，目前笔者了解或使用过的相关工具如下（除去逆向工程使用的调试器和反汇编工具）：</p><ul><li>Snoop-It（已停止维护）</li><li><a href="https://github.com/dmayer/idb">dmayer/idb</a> idb is a tool to simplify some common tasks for iOS pentesting and research</li><li><a href="https://github.com/mwrlabs/needle">mwrlabs/needle</a> The iOS Security Testing Framework</li><li><a href="https://github.com/sensepost/objection">sensepost/objection</a> 📱 objection - runtime mobile exploration</li><li><a href="https://github.com/iSECPartners/Introspy-iOS">iSECPartners/Introspy-iOS</a> IntroSpy</li></ul><p>在使用中笔者多多少少遇到了一些问题，例如 needle 在设备上需要部署过多依赖包，idb 不兼容 iOS 10，Introspy 虽好但查询日志数据库有一些麻烦……忍不住开始造轮子。</p><p>审计工具所需功能大体有如下几个方面：</p><ul><li>分析应用是否开启了必要的编译器保护</li><li>分析应用沙盒内的文件内容和权限</li><li>分析应用使用到的 framework 和动态链接库</li><li>分析应用存储的数据，如 UserDefaults, BinaryCookie 和 KeyChain</li><li>分析剪贴板的使用</li><li>动态拦截和分析 Objective C 运行时方法</li><li>动态拦截和分析本地代码的参数调用和堆栈追踪</li><li>分析 UIView 的层级结构和属性</li><li>一些基于 hook 实现的修改功能，如设备特征伪造、绕过越狱检测、绕过 SSL Pinning 等</li></ul><img src="https://pic1.zhimg.com/v2-869fa78c8cd0772eaf1d44711a7e471a_r.jpg" data-caption="" data-rawwidth="2560" data-rawheight="1556"><p><i>应用目前仍然在开发中，可能会有 bug 或功能缺失。</i></p><h2>设计</h2><p>在实现方案上，笔者选择了功能极为强大的 hook 框架 <a href="https://www.frida.re/">frida.re</a>。关于这个框架不需要我再过多介绍，它在 iOS 平台上支持对 native 函数、Objective C 运行时的 hook 和调用，可以满足多种移动安全运行时分析的自动化需求。</p><img src="https://pic1.zhimg.com/v2-5b1570480dfb0ae145555cb3a44b73fe_r.jpg" data-caption="" data-rawwidth="817" data-rawheight="318"><p>Passionfruit 通过 frida 注入代码到目标应用实现功能，再通过 node.js 服务端消息代理与浏览器通信，用户通过访问网页即可对 App 实现常规的检测任务。</p><h2>安装和使用</h2><p>请访问 GitHub 上的项目主页 <a href="https://github.com/chaitin/passionfruit">chaitin/passionfruit</a> 来获取最新的版本和更新信息。</p><p>Passionfruit 的编译和安装依赖如下软件：</p><ul><li><a href="https://nodejs.org/">node.js</a> 用于运行服务端。可根据个人喜好使用 <a href="https://yarnpkg.com/">yarn</a> 或默认的 <a href="https://www.npmjs.com/">npm</a> 作为包管理</li><li><a href="https://github.com/libimobiledevice/libimobiledevice">libimobiledevice</a></li></ul><p>安装步骤</p><ol><li>安装 node.js 和 libimobiledevice</li><li>通过 git 将代码仓库同步到本地</li><li>在越狱 iOS 设备上安装 frida</li><li>在非越狱设备上使用 ipa 重打包注入 fridagadget.dylib</li><li>第一次使用前，在代码根目录运行 npm run build 构建前端代码</li><li>运行 npm start 运行服务端，在浏览器中访问 localhost:31337</li></ol><h2>功能和演示</h2><p><br></p><p><br></p><p><br></p><p><br></p><video id="None" data-swfurl="" poster="https://pic2.zhimg.com/80/v2-2f92b2ec64b187be4cbcaa134b697131_b.jpg" data-sourceurl="https://www.zhihu.com/video/902688743067090944" data-name="" data-video-id="" data-video-playable="true" data-lens-id="902688743067090944"></video><p><br></p><p><br></p><p><br></p><p><br></p><p>Passionfruit 最大特点就是基于 Web 的图形界面。因此你甚至可以在 iPad Pro 这样的移动设备上访问这个图形界面……（需要修改服务端监听的配置）</p><p>完全图形化的界面可以快速地找到需要 hook 的函数。由于 C 函数缺少运行时参数类型信息，因此对于这些库函数您需要手动设置一下函数原型。Objective C 可以直接根据反射打印出参数和返回值。</p><p>其他工具实现的 checksec 是基于 otool 检查应用的可执行文件，需要在设备上安装额外的依赖，或将文件从设备中同步到本地执行命令。Passionfruit 直接分析内存中映射的内容，因此要快上很多。在文件查看方面，Passionfruit 直接读取应用沙盒内的 Plist、SQLite 数据库，相比先 scp 下载然后查看可以节约一些时间。</p><p>Passionfruit 在不少界面都添加了搜索功能，如模块列表、导出符号、Objective C 类，甚至 Plist 这样的序列化数据。</p><p>在 iOS 10 中有一个非公开 API UIDebuggingInformationOverlay 可用来在设备上分析界面层级，您可以在 Passionfruit 的 UIDump 面板中点击按钮来激活这个界面。</p><img src="https://pic3.zhimg.com/v2-5dac5ae80092b44c7e266b9aa4937a67_r.jpg" data-caption="" data-rawwidth="640" data-rawheight="1136"><p>如果您有单步、界面分析等更高级的调试需求，建议还是使用 debugserver 等专门的调试工具。</p><h2>FAQ</h2><p><b>需要越狱吗？</b></p><p>更新：项目发布后收到了 frida 作者本尊贡献的代码，现在已经不需要越狱了！</p><p>Frida 可以通过对已砸壳的 ipa 添加 fridagadget.dylib，重打包、重签名后在非越狱设备上试用，具体步骤可参考： <a href="http://www.jianshu.com/p/ce2770c42ead">iOS App的Patching和Resigning</a></p><p><b>为什么不支持 NSLog 查看？</b></p><p>本工具使用的界面是基于浏览器的，对于 NSLog 日志这种快速刷新的内容，实时展示会造成显著的性能问题。在现有工具（Xcode，macOS 自带的 Console，libimoviledevice 的 idevicesyslog 命令）足够强大的情况下，没有必要再开发一个（更难用的）了。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
