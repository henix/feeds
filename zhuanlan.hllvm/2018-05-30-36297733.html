<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>又发现JDK的一个bug，这次是：ConcurrentHashMap</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/36297733">原文</a></p>
<p>更新：ConcurrentHashMap的作者Doug Lea确认这是一个逻辑缺陷：</p><figure><noscript><img src="https://pic2.zhimg.com/v2-c19ea84d64f48f2b9a9efb9590aeccf9_b.jpg" data-caption="" data-size="normal" data-rawwidth="1498" data-rawheight="320" class="origin_image zh-lightbox-thumb" width="1498" data-original="https://pic2.zhimg.com/v2-c19ea84d64f48f2b9a9efb9590aeccf9_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-c19ea84d64f48f2b9a9efb9590aeccf9_b.jpg" data-caption="" data-size="normal" data-rawwidth="1498" data-rawheight="320" class="origin_image zh-lightbox-thumb lazy" width="1498" data-original="https://pic2.zhimg.com/v2-c19ea84d64f48f2b9a9efb9590aeccf9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-c19ea84d64f48f2b9a9efb9590aeccf9_b.jpg"></figure><a href="http://link.zhihu.com/?target=https%3A//bugs.openjdk.java.net/browse/JDK-8202422%3FfocusedCommentId%3D14182353%26page%3Dcom.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel%23comment-14182353" data-draft-node="block" data-draft-type="link-card" class=" wrap external" target="_blank" rel="nofollow noreferrer">Bug链接</a><p>并在他维护的JSR166规范里提交了修改：</p><a href="http://link.zhihu.com/?target=http%3A//gee.cs.oswego.edu/cgi-bin/viewcvs.cgi/jsr166/src/main/java/util/concurrent/ConcurrentHashMap.java%3Fr1%3D1.310%26r2%3D1.311" data-draft-node="block" data-draft-type="link-card" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://</span><span class="visible">gee.cs.oswego.edu/cgi-b</span><span class="invisible">in/viewcvs.cgi/jsr166/src/main/java/util/concurrent/ConcurrentHashMap.java?r1=1.310&amp;r2=1.311</span><span class="ellipsis"></span></a><p>分割线以下是我当时给JDK提这个bug后写的：</p><p>------------------------------------------------------------------------------------------</p><p>JDK的源码都没人仔细看吗？我刚开始看JDK-1.8的ConcurrentHashMap的源码，就发现构造函数有问题，给Java提了bug，果然如此。</p><a href="http://link.zhihu.com/?target=https%3A//bugs.openjdk.java.net/browse/JDK-8202422" data-draft-node="block" data-draft-type="link-card" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">bugs.openjdk.java.net/b</span><span class="invisible">rowse/JDK-8202422</span><span class="ellipsis"></span></a><p>而且assign给了大神Doug Lea:</p><figure><noscript><img src="https://pic1.zhimg.com/v2-0a0bd99d31f7c543ef66788dab694bbc_b.jpg" data-caption="" data-size="normal" data-rawwidth="534" data-rawheight="64" class="origin_image zh-lightbox-thumb" width="534" data-original="https://pic1.zhimg.com/v2-0a0bd99d31f7c543ef66788dab694bbc_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-0a0bd99d31f7c543ef66788dab694bbc_b.jpg" data-caption="" data-size="normal" data-rawwidth="534" data-rawheight="64" class="origin_image zh-lightbox-thumb lazy" width="534" data-original="https://pic1.zhimg.com/v2-0a0bd99d31f7c543ef66788dab694bbc_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-0a0bd99d31f7c543ef66788dab694bbc_b.jpg"></figure><p>我在so上也问了这个问题，有人认为这是一个优化技巧，但在逻辑上有一点说不太通，如果增加一个文档说明，把3/2这个计算参数的说明加进去，也勉强可以说得过去。总之，目前来看，确实是有逻辑缺陷的。</p><p>SO链接：</p><a href="http://link.zhihu.com/?target=https%3A//stackoverflow.com/questions/50083966/bug-parameter-initialcapacity-of-concurrenthashmaps-construct-method" data-draft-node="block" data-draft-type="link-card" data-image="https://pic1.zhimg.com/v2-2d47e939feed796bcf7483d306661c88_ipico.jpg" data-image-width="316" data-image-height="316" class=" wrap external" target="_blank" rel="nofollow noreferrer">Bug: parameter 'initialCapacity' of ConcurrentHashMap's construct method?</a><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
