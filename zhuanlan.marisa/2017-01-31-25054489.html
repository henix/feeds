<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>共用的抽象模型（客户及服务器端）- 超时处理</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/25054489">原文</a></p>
<h2><b>Akka HTTP 的超时处理</b></h2><p>Akka HTTP 有好几个内建的超时处理机制可用于防御针对服务器端的恶意攻击或者开发中引出的错误。其中几个只是简单的配置项（可以用代码修改相关值），另外几个则是通过流式 API （在开发者代码中直接以相关模式实现）进行处理。</p><p><b><i>通用的超时处理</i></b><br></p><p><i>闲置超时</i></p><p><u>idle-timeout </u>是一个全局配置，可以设定任意一个连接的最长闲置时间。换成另一种说法，如果一个连接在开启状态下没有任何的 请求／响应 数据在超过<u> idle-timeout</u> 规定的时长内写入，这个连接就会被自动关闭。</p><p>无论是客户端，还是服务器端，相关配置对于连接的使用方式都是一样的，而且可以独立对应不同的环境通过以下的键值进行配置</p><code lang="text">akka.http.server.idle-timeout
akka.http.client.idle-timeout
akka.http.host-connection-pool.idle-timeout
akka.http.host-connection-pool.client.idle-timeout</code><blockquote><p>注意事项<br></p><p>对于客户端的连接池设置，闲置时段的判断起始点是当连接池中已经没有需要处理的请求在等待写入为准。</p></blockquote><p><b><i>服务器端相关超时处理<br></i></b></p><p><i>请求超时</i><br></p><p>请求超时处理：这是限制一个路由上生成一个 <u>HttpResponse</u> 的所需最大时长的一种机制。如果超过限期还没生成相关响应，服务器会自动往连接上写入一个 Service Unavailable 的 HTTP 响应并关闭连接以防止溢出或者防止连接无限期地存在。举个例子，如果有个开发上的错误导致一个 <u>Future</u> 永远不结束，这将使真正需要的响应永远不会往连接送出。</p><br><p>（译注：这句防止溢出也太泛泛了...具体而言，如果所有的连接都不关闭的话，无论网络连接，文件句柄，线程／进程，还是内存总量都有可能溢出。这些具体的配置要看具体的操作系统，应用程序，以及用户量做具体调整）<br></p><p>当请求处理超时，系统会往连接写入如下的默认 <u>HttpResponse</u></p><br><code lang="text">HttpResponse(StatusCodes.ServiceUnavailable, entity = "The server was not able " +
  "to produce a timely response to your request.\r\nPlease try again in a short while!")
</code><p>通过设定 akka.http.server.request-timeout 的相关参数（默认为 20 秒），可以配置一个作用用于所有路由的全局请求超时值。</p><br><blockquote><p>注意事项</p><p>请注意，如果客户端在同一个连接上送出多个请求（R1,R2,R3,...），而在第 n 个请求时激发了请求超时，服务器会返回默认响应并关闭连接，以致第 n+1 个（及后续）请求无任何处理。<br></p></blockquote><p>请求超时的值也可以在代码中通过 <a href="http://doc.akka.io/docs/akka-http/current/scala/http/routing-dsl/directives/timeout-directives/index.html#timeoutdirectives" data-editable="true" data-title="TimeoutDirectives">TimeoutDirectives</a> 在任意一个路由中动态修改。<br></p><p><i>绑定超时处理</i></p><p>绑定超时是指：（通过任何一个 <u>Http().bind*</u> 函数）完成绑定相关 TCP 端口所需过程的时间长短超过规限。该值可以通过 <u>akka.http.server.bind-timeout</u> 设置</p><p><b><i>客户端相关超时处理</i></b></p><p><i>连通超时</i></p><p>连通超时是指：完成建立相关 TCP 两端连接所需过程的时间长短超过规限。一般来说很少需要对相关参数进行调整。但可以对无法在有限时间内建立的连接以错误的形式突显，以便进行异常处理。<br></p><p>该值可以通过 <u>akka.http.client.connecting-timeout</u> 设置</p><p>（译注：翻译到这里，有点醉了，这完全就是要开发人员对 TCP 规范各步骤起码有个基本的认知啊，这算啥解释... 不想搞太深的可以先参考一下祖宗级的概念 <a href="https://en.wikipedia.org/wiki/Berkeley_sockets#connect">Berkeley Socket</a>）</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
