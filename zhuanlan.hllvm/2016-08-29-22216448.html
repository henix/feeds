<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>架构最快最好的To JS编译器</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/22216448">原文</a></p>
自己从事<a href="https://github.com/bloomberg/bucklescript" data-editable="true" data-title="BuckleScript" class="">BuckleScript</a> 的编译器的开发已有近一年， 下周即将发布1.0，这里面有太多故事可以写了，知乎第一篇文章献给它。<p>虽然BuckleScript 才马上到1.0， 但是它已经被一些公司所采用，比如它已经被Facebook的某些产品用到了。自己也在和著名的ReactJS/ReactNative的作者Jordan 合作希望能推出 Reason On React (Powered by BuckleScript) 希望这能够给BuckleScript 带来killer app. 而BuckleScript 本身的编译器是用OCaml 写得，可以被编译成汇编和JS本身（压缩后大小700KB), 用户们可以自己感受下它的编译速度, Try here: <a href="http://bloomberg.github.io/bucklescript/js-demo/" data-editable="true" data-title="OCaml to Javascript transpiler playground">OCaml to Javascript transpiler playground</a> 注意汇编的版本比JS的版本还要快一个数量级。</p><p>BuckleScript 早期是我的个人项目：因为注意到 现在软件行业--从互联网行业到传统软件领域--有一个很明显趋势: Javascript platform，<a href="https://www.youtube.com/watch?v=jFU-wc28lF4" data-title="这个唯一的跨平台语言正在吞噬着所有软件领域" class="" data-editable="true">这个唯一的跨平台语言正在吞噬着所有软件领域</a>（因为mobile的崛起Java 已经不再是一个跨平台语言了)：<br></p><ul><li>浏览器已经不再只是deliver 内容的一个平台，越来越多的应用程序开始通过浏览器直接deploy，像上面提到的BuckleScript playground 整个工业级别的编译器直接跑在浏览器上 这甚至在5年前都是不可想象的。</li><li>Google最近主推的<a href="https://developers.google.com/web/progressive-web-apps/" data-editable="true" data-title="Progressive Web APP" class="">Progressive Web APP</a> 将会给浏览器带来更强大的API. 而最新的<a href="https://webassembly.github.io/" data-editable="true" data-title="Web Assembly 标准">Web Assembly 标准</a> 将会使得JavaScript 平台可以覆盖更多的领域：比如传统的数值计算领域。WASM相当于给JavaScript 提供了一个接入native平台的FFI, JavaScript 作为这个平台的胶水语言毫无疑问有着最多的机会。</li><li>JavaScript 平台已经不再局限于浏览器， 相反它已经开始反噬， 开始入侵其它领域 最有名的是<a href="https://nodejs.org/en/" data-editable="true" data-title="NodeJS">NodeJS</a>, <a href="http://electron.atom.io/" data-editable="true" data-title="Electron">Electron</a>, <a href="http://johnny-five.io/" data-editable="true" data-title="IoT">IoT</a> 等</li></ul><br><p>为什么要自己写一个这样的编译器呢? 虽然JavaScript平台很诱人，但是“动态语言难于构建大型程序” 基本上已经是业界共识，一旦程序规模上来了，基本上就只能Write Only. 作者所在的公司有上千万行JS, 维护起来基本上就是噩梦，在原来的Hack上添加新的if else Hack。而工业界真正有工业强度而且和JavaScript 交互良好的的编译器是微软的typescript 编译器，接下来就展开说下为什么BuckleScript 比typescript 更快更好。</p><ol><li>更好的平台拓展性：BuckleScript 不是一个新的语言，它是把一个已经存在将近30年的语言OCaml编译成可读的JavaScript. 而OCaml本身对很多平台存在native 的后端支持。像go一样, OCaml可以编译出汇编代码到iOS,Android, Windows,Linux, MacOS。而typescript只有JavaScript 一个后端，拥抱JavaScript 并不代表我们就要抛弃native 平台，当我们需要更快更可靠的性能的时候，我们可以有更多的选择，比如做工具链的时候: typescript 的编译器同样也是用typescript写得可以跑在浏览器里也可以泡在node上，但是它跑在node上得时候就比BuckleScript编译成汇编跑慢不止一个数量级。<br></li><li>更好的类型安全: typescript是一个JS的超集，它存在很多历史包袱。而微软引入typescript更多的是作为一个工具来使用的比如IDE的代码补全，相对安全的代码重构。而这个类型的准确从第一天开始就不是它的设计初衷，以至于Facebook自己设计了一个相对更准确地类型系统<a href="https://github.com/facebook/flow" data-editable="true" data-title="Flow">Flow</a>. 而OCaml的类型系统是已经被形式化的证明过正确的。也就是说从理论上BuckleScript 能够保证一旦编译通过是不会有运行时候类型错误的，而typescript远远做不到这点。</li><li>更多的类型推断，更好的语言特性：用过typescript的人都知道，typescript的类型推断很弱，基本上所有参数都需要显示的标注类型。不光是这点，像对函数式编程的支持，高阶类型系统GADT的支持几乎是没有。而OCaml本身是一个比Elm,PureScript还要强大的多的语言，它自身有一个非常高阶的module system，是为数不多的对dependent type提供支持的语言，polymorphic variant。而且pattern match的编译器也是优化过的。</li><li>程序优化，代码删除。BuckleScript不只是一个编译器更是一个optimizing compiler: 它做过的优化有: Code motion, Purity analysis, Cross module inliner, Constant folding/propagation, partial evaluation Strength reduction, escape analysis。我们做的benchmark显示同样的immutable data structure 比如<a href="https://facebook.github.io/immutable-js/" data-editable="true" data-title="facebook immutablejs">facebook immutablejs</a>, BuckleScript的实现有时候要快两到三倍不止。而相比之下typescript编译器并不会做任何优化工作。</li></ol><br><p>因为自己接触到的专业术语都是英文的，作者试着尽可能用中文表述，可能翻译过来的中文不太准确，尽请谅解, 接下来我还会写几篇文章讲讲它的底层设计，如果读者能够读到这里, 还请在github上友情支援一下 : )。</p><p>小时候读韩愈的《马说》， 不太理解这句话 “世有伯乐， 然后有千里马，千里马常有，而伯乐不常有”。 长大以后慢慢的对这句话才真的理解，真的要好好感谢一路过来给我无限指导和关怀的老师/老板们，我也庆幸自己很幸运，自己的每一任老师或者老板 ，不管自己做什么，都能够得到你们的理解和支持。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
