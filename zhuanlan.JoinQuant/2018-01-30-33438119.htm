<div class="title-image"><img src="https://pic2.zhimg.com/v2-37fc3cc4e57451d49f0f844e2cc35a26_b.jpg" alt=""></div><p>&gt; 学习内容：<br/>&gt; -学会技术指标择时策略<br/>&gt; -了解使用talib<br/>&gt; -学会大盘择时概念<br/>&gt; -自主完成MACD<br/>&gt; -向导式初体验</p><p class="ztext-empty-paragraph"><br/></p><h2>1 确定策略内容</h2><p>在之前的教程中，我们学习了如何通过财务指标等对股票进行筛选等操作。今天我们将以MACD为例，探究如何利用<b>技术指标</b>进行策略的构建与实现。</p><p><b>&gt; MACD的组成</b><br/>MACD（Moving Average Convergence and Divergence)即<b>指数平滑移动平均线</b>，由Geral Appel 于1970年提出，属于<i>大势趋势类指标</i>，它由<b><i>长期慢速均线DEA，短期快线的DIF，红色能量柱（多头），绿色能量柱（空头）、0轴（多空分界线）</i></b>五部分组成，即“两线两柱一轴”组合起来形成。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_b.jpg" data-caption="" data-size="normal" data-rawwidth="569" data-rawheight="432" class="origin_image zh-lightbox-thumb" width="569" data-original="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_b.jpg" data-caption="" data-size="normal" data-rawwidth="569" data-rawheight="432" class="origin_image zh-lightbox-thumb lazy" width="569" data-original="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-fc84545104151ec29de95f2da1160a38_b.jpg"/></figure><p>在图中表示出来则为：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_b.jpg" data-caption="" data-size="normal" data-rawwidth="514" data-rawheight="302" class="origin_image zh-lightbox-thumb" width="514" data-original="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_b.jpg" data-caption="" data-size="normal" data-rawwidth="514" data-rawheight="302" class="origin_image zh-lightbox-thumb lazy" width="514" data-original="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-11969d4284f54907a0e29a32a4064f08_b.jpg"/></figure><p>图中水平线为零轴，又称多空分水岭，顾名思义上方为多头势力较强，下方则为空头势力较强。<br/>当短期快线DIF值和长期慢线DEA值上穿零轴，同时零轴之上出现红色柱状体，表示股价趋势当时属于多头市场，投资者可以考虑持股待涨。<br/>DIF值和DEA值下穿零轴，同时零轴之下出现绿色柱状体，则表示股价趋势当时属于空头市场，投资者应当空仓持币，规避风险。</p><p><b>&gt; MACD思想————均线位置与买卖时机判断</b><br/>MACD是从双指数移动平均线发展而来的，由快的指数移动平均线（EMA12）减去慢的指数移动平均线（EMA26）得到快线DIF，再用2×（快线DIF-DEA）得到MACD柱。MACD的意义和双移动平均线相似，即<b>由快、慢均线的离散、聚合来显示当前的多空状态和股价可能的发展变化趋势</b>并对<b>买进、卖出时机</b>作出研判，但MACD阅读起来更方便。<br/>总体而言：<br/><i>当MACD从负数转向正数，即买入信号<br/>当MACD从正数转向负数，即卖出信号<br/>当MACD以大角度变化，表示快的移动平均线和慢的移动平均线的差距非常迅速的拉开，代表了一个市场大趋势的转变</i></p><p><b>&gt; DIF与DEA金叉的使用</b><br/>当白线即短期快线DIF向上穿过黄色的长期慢线DEA时，即“<b>快线高于慢线</b>”，属于做多金叉信号。然而实际中需要进行<b>“金叉+零轴”</b>的综合考虑。<br/>&gt; 当零轴之下出现金叉时，股价属于弱势市场，金叉为弱势金叉，股价极有可能短期弱势反弹或暂时止跌后再度夭折，一般没有做多价值。<br/>&gt; 当零轴之上发生金叉时，股价属于强势市场，金叉为强势金叉，股价后市成功惯性上攻的概率较高。若零轴之上出现二次金叉信号时，又称<b>零上二次红金叉</b>，属于股价强势中的强势，此时跟进做多，股价往往容易出现加速上涨。属于短线极佳买点。</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_b.jpg" data-caption="" data-size="normal" data-rawwidth="522" data-rawheight="343" class="origin_image zh-lightbox-thumb" width="522" data-original="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_b.jpg" data-caption="" data-size="normal" data-rawwidth="522" data-rawheight="343" class="origin_image zh-lightbox-thumb lazy" width="522" data-original="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-2fdaae98e1694b63cd1d855169c5b05e_b.jpg"/></figure><p><b>&gt; DIF与DEA死叉的使用</b><br/>当白线即短期快线DIF向下穿过黄色的长期慢线DEA时，即“<b>快线低于慢线</b>”，属于做空死叉信号。死叉同样需要结合零轴。<br/>&gt; 当零轴之上出现死叉时，一般认为是股价上升趋势途中的短暂回调，后市股价仍有再次走强的可能。<br/>&gt; 当零轴之下发生死叉时，一般认为是股价下跌趋势途中的继续回调，后市股价惯性下跌的概率较高，尤其是MACD零轴之下出现二次死叉时，股价更容易出现加速下跌行情，所以零轴之下，无论出现的是一次死叉或二次死叉，投资者都应当空仓观望，静观其变。</p><p><b>策略内容</b><br/>了解了MACD的基本情况，我们就能够制定本次利用技术指标构建的策略内容。</p><p>基本思路：<br/>&gt; - 筛选出符合：<br/>10&lt;市盈率（pe_ratio）&lt;40, 市净率（pb_ratio)&lt;3, 净利润环比增长率(inc_net_profit_annual)&gt;0.3，净资产收益率(roe)&gt;15的股票，按照销售毛利率进行降序排列，选取前50只<br/>&gt; - 买入：DIF从下而上穿过DEA，即形成金叉<br/>&gt; - 卖出：DIF从上往下穿过DEA，即形成死叉<br/>&gt; - 十天一次调仓</p><p>翻译成计算机语言即：<br/>1.运用<code>get_fundalmentals</code>函数查询相关财务数据并筛选出符合条件的股票<br/>2.运用<code>talib</code>读取MACD相关指标数值<br/>3.利用<code>if</code>条件语句以及<code>and</code>、<code>or</code>逻辑语句进行买入卖出条件设置</p><h2>2 基本框架构建</h2><p>在之前的教程中，我们基本上已经整理出交易之前策略构成的基本框架。下面我们对这一内容再次进行细化：<br/>首先是<code>initialize()</code>函数的设置。这里我们沿用之前的做法，将其分为多个自定义函数的形式：</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-5745273a884cb2b014ea29a76d2d22e7_b.jpg" data-caption="" data-size="normal" data-rawwidth="430" data-rawheight="249" class="origin_image zh-lightbox-thumb" width="430" data-original="https://pic4.zhimg.com/v2-5745273a884cb2b014ea29a76d2d22e7_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-5745273a884cb2b014ea29a76d2d22e7_b.jpg" data-caption="" data-size="normal" data-rawwidth="430" data-rawheight="249" class="origin_image zh-lightbox-thumb lazy" width="430" data-original="https://pic4.zhimg.com/v2-5745273a884cb2b014ea29a76d2d22e7_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-5745273a884cb2b014ea29a76d2d22e7_b.jpg"/></figure><p>以及对滑点、手续费、过滤停牌、退市及ST股票的设置</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-dd12fcaece92f0e4e90cfbe5fb527344_b.jpg" data-caption="" data-size="normal" data-rawwidth="761" data-rawheight="548" class="origin_image zh-lightbox-thumb" width="761" data-original="https://pic1.zhimg.com/v2-dd12fcaece92f0e4e90cfbe5fb527344_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-dd12fcaece92f0e4e90cfbe5fb527344_b.jpg" data-caption="" data-size="normal" data-rawwidth="761" data-rawheight="548" class="origin_image zh-lightbox-thumb lazy" width="761" data-original="https://pic1.zhimg.com/v2-dd12fcaece92f0e4e90cfbe5fb527344_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-dd12fcaece92f0e4e90cfbe5fb527344_b.jpg"/></figure><h2>3 MACD数据读取</h2><p>根据我们策略的内容，我们采用的思路是：<b>筛选出股票池中质量较高的股票--&gt;查询MACD指数--&gt;买入卖出条件</b><br/>再次复习我们熟悉的选股方法：财务指标。这里我们挑选出符合：<br/>10&lt;市净率(pe_ratio)&lt;40，每股盈余(eps)&gt;0.3，净资产收益率(roe)&gt;15，净利润环比增长率&gt;0.3，并按照市净率进行升序排列，取前五十只。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-148f75ca7c62d57b3fbb36d64fbaeca1_b.jpg" data-caption="" data-size="normal" data-rawwidth="400" data-rawheight="256" class="content_image" width="400"/></noscript><img src="https://pic2.zhimg.com/v2-148f75ca7c62d57b3fbb36d64fbaeca1_b.jpg" data-caption="" data-size="normal" data-rawwidth="400" data-rawheight="256" class="content_image lazy" width="400" data-actualsrc="https://pic2.zhimg.com/v2-148f75ca7c62d57b3fbb36d64fbaeca1_b.jpg"/></figure><p>将筛选后得到股票代码放置在stockpool的list列表中，以便之后对列表进行循环。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-f2c77d8780d6fdd00a59642a3c6eb1d9_b.jpg" data-caption="" data-size="normal" data-rawwidth="510" data-rawheight="132" class="origin_image zh-lightbox-thumb" width="510" data-original="https://pic2.zhimg.com/v2-f2c77d8780d6fdd00a59642a3c6eb1d9_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-f2c77d8780d6fdd00a59642a3c6eb1d9_b.jpg" data-caption="" data-size="normal" data-rawwidth="510" data-rawheight="132" class="origin_image zh-lightbox-thumb lazy" width="510" data-original="https://pic2.zhimg.com/v2-f2c77d8780d6fdd00a59642a3c6eb1d9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-f2c77d8780d6fdd00a59642a3c6eb1d9_b.jpg"/></figure><p>对于筛选出来的股票依次读取MACD数据。这里就需要用到<code>talib</code>库中<code>MACD</code>函数。TA-Lib中文全称为技术分析库，是一个广泛用在程序化交易中进行金融市场数据的技术分析的函数库。它提供了多种技术分析的函数，包含多种指标如<b>ADX, MACD, RSI, 布林轨道</b>等等，可以极大地方便我们量化投资中编程工作。</p><p>Talib中的MACD函数使用时格式为：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-70425f4416d675f3ba6f57ceea1ea47c_b.jpg" data-caption="" data-size="normal" data-rawwidth="420" data-rawheight="27" class="content_image" width="420"/></noscript><img src="https://pic1.zhimg.com/v2-70425f4416d675f3ba6f57ceea1ea47c_b.jpg" data-caption="" data-size="normal" data-rawwidth="420" data-rawheight="27" class="content_image lazy" width="420" data-actualsrc="https://pic1.zhimg.com/v2-70425f4416d675f3ba6f57ceea1ea47c_b.jpg"/></figure><p>传入函数的三个参数分别为短线周期、长线周期以及MACD的移动平滑周期。这里我们使用最常用的（12，26，9）组合。<code>MACD()</code>函数返回值共有三个，分别为<b>DIF，DEA和MACD</b></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-2bd5125a66fe81eb41e5b2525c905cbd_b.jpg" data-caption="" data-size="normal" data-rawwidth="792" data-rawheight="149" class="origin_image zh-lightbox-thumb" width="792" data-original="https://pic2.zhimg.com/v2-2bd5125a66fe81eb41e5b2525c905cbd_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-2bd5125a66fe81eb41e5b2525c905cbd_b.jpg" data-caption="" data-size="normal" data-rawwidth="792" data-rawheight="149" class="origin_image zh-lightbox-thumb lazy" width="792" data-original="https://pic2.zhimg.com/v2-2bd5125a66fe81eb41e5b2525c905cbd_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-2bd5125a66fe81eb41e5b2525c905cbd_b.jpg"/></figure><p>&gt; 答疑与延伸：<br/>&gt; -<b><i>为什么要通过macd_tmp[0]来读取数据？</i></b> 因为MACD返回的是一个包括三个元素的序列array，和从list中取元素类似，我们通过在其后加上<a href="https://link.zhihu.com/?target=https%3A//image.joinquant.com/7585ddcc2aaca211a586069fd8d8ad9a" class=" wrap external" target="_blank" rel="nofollow noreferrer">0</a>的方式分别取第一个元素和第二个元素。<br/>&gt; -<b><i>为什么要选取300日的历史数据？</i></b> MACD存在一个问题，即若选取时间较短，则可能出现不收敛的状况，因此这里我们选取300日的数据。</p><h2>4 买入卖出条件设置</h2><p>策略中我们要判断长线和短线的位置问题。这里我们做一些简化，判断当日和三日前的MACD正负情况。<br/>当日MACD为正且三日前MACD为负--&gt;金叉形成 买入<br/>当日MACD为负且三日前MACD为正--&gt;死叉形成 卖出</p><p>将股票代码通过<code>append()</code>函数放在相应的买卖列表当中。</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-ca84e680633d477c88acd787bd2fc796_b.jpg" data-caption="" data-size="normal" data-rawwidth="510" data-rawheight="98" class="origin_image zh-lightbox-thumb" width="510" data-original="https://pic3.zhimg.com/v2-ca84e680633d477c88acd787bd2fc796_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-ca84e680633d477c88acd787bd2fc796_b.jpg" data-caption="" data-size="normal" data-rawwidth="510" data-rawheight="98" class="origin_image zh-lightbox-thumb lazy" width="510" data-original="https://pic3.zhimg.com/v2-ca84e680633d477c88acd787bd2fc796_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-ca84e680633d477c88acd787bd2fc796_b.jpg"/></figure><p>当对筛选后保留的股票进行循环之后，符合条件的股票已经被放入买入或卖出列表中。下面<b>查看当前所持有的股票</b>，如果在卖出列表当中则全部卖出，不是则保留，并将股票代码放入hold[]列表中</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-e0870622666822adc825490e9d81644c_b.jpg" data-caption="" data-size="normal" data-rawwidth="737" data-rawheight="97" class="origin_image zh-lightbox-thumb" width="737" data-original="https://pic1.zhimg.com/v2-e0870622666822adc825490e9d81644c_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-e0870622666822adc825490e9d81644c_b.jpg" data-caption="" data-size="normal" data-rawwidth="737" data-rawheight="97" class="origin_image zh-lightbox-thumb lazy" width="737" data-original="https://pic1.zhimg.com/v2-e0870622666822adc825490e9d81644c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-e0870622666822adc825490e9d81644c_b.jpg"/></figure><p>买入long_list中除去已持有的股票：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-4ede4290815a47f31d7e1f3f428a4c49_b.jpg" data-caption="" data-size="normal" data-rawwidth="702" data-rawheight="81" class="origin_image zh-lightbox-thumb" width="702" data-original="https://pic2.zhimg.com/v2-4ede4290815a47f31d7e1f3f428a4c49_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-4ede4290815a47f31d7e1f3f428a4c49_b.jpg" data-caption="" data-size="normal" data-rawwidth="702" data-rawheight="81" class="origin_image zh-lightbox-thumb lazy" width="702" data-original="https://pic2.zhimg.com/v2-4ede4290815a47f31d7e1f3f428a4c49_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-4ede4290815a47f31d7e1f3f428a4c49_b.jpg"/></figure><p>将可用资金根据股票数量进行均分。为避免出现除数为0的状况在这里进行一个判断。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-674a7a5ac4e2a83e40ed30955cb1a8e8_b.jpg" data-caption="" data-size="normal" data-rawwidth="456" data-rawheight="171" class="origin_image zh-lightbox-thumb" width="456" data-original="https://pic1.zhimg.com/v2-674a7a5ac4e2a83e40ed30955cb1a8e8_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-674a7a5ac4e2a83e40ed30955cb1a8e8_b.jpg" data-caption="" data-size="normal" data-rawwidth="456" data-rawheight="171" class="origin_image zh-lightbox-thumb lazy" width="456" data-original="https://pic1.zhimg.com/v2-674a7a5ac4e2a83e40ed30955cb1a8e8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-674a7a5ac4e2a83e40ed30955cb1a8e8_b.jpg"/></figure><h2>5 策略完成，进行回测</h2><p>把买入卖出的代码写好，策略就写完了，完整代码点击链接：<a href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/7095%3Ftag%3Dalgorithm" class=" wrap external" target="_blank" rel="nofollow noreferrer">【新手入门教程】MACD均线择时策略</a></p><p>在2015.1.1-2016.12.31这段时间内进行回测，回测结果如图：</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-a40daf97ecc7d11ac493d002e4a3777b_b.jpg" data-caption="" data-size="normal" data-rawwidth="1213" data-rawheight="598" class="origin_image zh-lightbox-thumb" width="1213" data-original="https://pic4.zhimg.com/v2-a40daf97ecc7d11ac493d002e4a3777b_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-a40daf97ecc7d11ac493d002e4a3777b_b.jpg" data-caption="" data-size="normal" data-rawwidth="1213" data-rawheight="598" class="origin_image zh-lightbox-thumb lazy" width="1213" data-original="https://pic4.zhimg.com/v2-a40daf97ecc7d11ac493d002e4a3777b_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-a40daf97ecc7d11ac493d002e4a3777b_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p><b>自测与自学</b></p><p>1、是否掌握技术指标MACD的含义</p><p>2、修改MACD函数，使得短线周期、长线周期以及MACD平滑周期分别为10、30、10，并尝试其他周期看是否能将结果进一步优化</p><p>3、修改买入卖出条件设置，例如买入条件改为“在零轴之上形成金叉”，将卖出条件改为“在零轴下方”形成死叉”</p><p>4、自主了解和MACD相关的一些走势概念，如佛手向上、小鸭出水、空中缆车等</p>