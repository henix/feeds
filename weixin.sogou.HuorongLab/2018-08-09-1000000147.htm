<div id="js_top_ad_area" class="top_banner"></div><div class="rich_media_inner">

        
        
        <div id="page-content" class="rich_media_area_primary">
          <div class="rich_media_area_primary_inner">

                                    
                        

            <div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">
                    蠕虫病毒利用“永恒之蓝”漏洞传播 单位局域网受威胁最大

                                                                                </h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                            <span id="copyright_logo" class="rich_media_meta rich_media_meta_text meta_tag_text">原创：</span>
                                                            <span class="rich_media_meta rich_media_meta_text">
                                                火绒安全实验室
                                            </span>
                                        
                                        <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" id="js_name">
                        火绒安全实验室                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">火绒安全实验室</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">HuorongLab</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">火绒是一家纯粹的信息安全公司。在这里为大家分享专业的技术报告和安全信息。</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text"></em>





                </div>
                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <section><section class="V5" powered-by="xiumi.us"><section><section><section><section><section style="box-sizing: border-box;"><section class="V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section style="box-sizing: border-box;"><section style="display: inline-block;vertical-align: bottom;box-sizing: border-box;"><section style="transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);background-color: rgb(249, 110, 87);width: 1.6em;height: 1.6em;text-align: center;font-size: 18px;line-height: 1.6em;color: rgb(255, 255, 255);box-sizing: border-box;"><section style="box-sizing: border-box;">01</section></section><section style="width: 0px;margin-left: auto;transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);border-width: 3px;border-style: solid;border-color: rgb(107, 178, 171) transparent transparent rgb(107, 178, 171);box-sizing: border-box;"></section></section><section style="display: inline-block;vertical-align: bottom;margin-left: -6px;box-sizing: border-box;"><section style="display: inline-block;vertical-align: middle;height: 1.6em;line-height: 1.7em;background-color: rgb(240, 240, 240);text-align: center;padding-left: 10px;padding-right: 4px;box-sizing: border-box;"><p style="box-sizing: border-box;"><strong style="box-sizing: border-box;">概述</strong></p></section><section style="display: inline-block;vertical-align: middle;width: 0px;border-left: 0.8em solid rgb(240, 240, 240);border-top: 0.8em solid transparent !important;border-bottom: 0.8em solid transparent !important;box-sizing: border-box;"></section><section style="clear: both;box-sizing: border-box;"></section></section></section></section></section></section><section style="text-align: justify;"><span style="font-size: 15px;">日前，火绒安全团队通过“火绒威胁情报系统”发现蠕虫病毒“Worm/Sharp”正在全网传播，<strong>其中在政府、企业、学校、医院等单位的局域网具有非常强的传播能力。</strong></span><span style="font-size: 15px;text-decoration: underline;">该病毒通过“永恒之蓝”漏洞、多个电脑常用端口传播，入侵电脑后，会横向攻击局域网内所有电脑，同时还会在用户电脑中留下后门病毒，用以执行更多恶意攻击，如勒索病毒、挖矿病毒。</span><br></section></section></section></section></section></section></section><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">火绒工程师通过技术分析发现，该蠕虫病毒会通过远程服务器和自身爬虫功能收集局域网内的IP列表，然后对其中的多个服务端口发起攻击，包括RPC服务(135端口)、SQLServer服务(1433端口)、FTP服务(21端口)，同时还会通过 “永恒之蓝”漏洞，入侵445端口，攻击电脑。</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">由于该病毒针对企业不便关闭的多个常用端口进行攻击，并且利用了局域网电脑中普遍未修复的“永恒之蓝”漏洞，一旦任何一台电脑被该病毒感染，将意味着局域网内所有电脑都面临被感染的风险，尤其给政企机构用户造成极大威胁。</span></strong></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">如果病毒成功入侵或攻击端口，就会从远程服务器下载病毒代码，进而横向传播给局域网内其他电脑。同时，该病毒还会在被感染电脑中留下后门病毒，以准备进行后续的恶意攻击，不排除未来会向用户电脑传播更具威胁性病毒的可能性，例如勒索病毒等。</span></p><p style="text-align: justify;"><br></p><p style="text-align: justify;"><span style="font-size: 15px;">火绒工程师通过技术溯源发现，从2017年06月23日(甚至更早) 至今，该黑客组织一直使用该系列蠕虫在全网进行大规模的信息收集。且一直保持对病毒的更新。</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="1.3682539682539683" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CUtOCxk8o8obU2b1fZKWIX3ZsysTrxvGnjuyLHaAicxErhNKcbHhkUQQ/640?wx_fmt=png" data-type="png" data-w="315" style=""></p><p style="text-align: justify;"><br><span style="font-size: 15px;"></span></p><p style="text-align: justify;"><span style="font-size: 15px;">火绒"企业版"和"个人版"最新版均可彻底查杀蠕虫病毒" Worm/Sharp "。同时，政府、企业、学校、医院等受此类病毒威胁较大的局域网用户，我们建议申请安装"火绒企业版"，可有效防御局域网内病毒屡杀不绝的难题。目前火绒免费提供三个月试用期，欢迎大家前来体验试用。</span><br></p><p style="text-align: justify;"><br></p><section style="box-sizing: border-box;"><section class="V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section style="box-sizing: border-box;"><section style="display: inline-block;vertical-align: bottom;box-sizing: border-box;"><section style="transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);background-color: rgb(249, 110, 87);width: 1.6em;height: 1.6em;text-align: center;font-size: 18px;line-height: 1.6em;color: rgb(255, 255, 255);box-sizing: border-box;"><p style="box-sizing: border-box;">02</p></section><section style="width: 0px;margin-left: auto;transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);border-width: 3px;border-style: solid;border-color: rgb(107, 178, 171) transparent transparent rgb(107, 178, 171);box-sizing: border-box;"></section></section><section style="display: inline-block;vertical-align: bottom;margin-left: -6px;box-sizing: border-box;"><section style="display: inline-block;vertical-align: middle;height: 1.6em;line-height: 1.7em;background-color: rgb(240, 240, 240);text-align: center;padding-left: 10px;padding-right: 4px;box-sizing: border-box;"><p style="box-sizing: border-box;"><strong style="box-sizing: border-box;">详细分析</strong></p></section><section style="display: inline-block;vertical-align: middle;width: 0px;border-left: 0.8em solid rgb(240, 240, 240);border-top: 0.8em solid transparent !important;border-bottom: 0.8em solid transparent !important;box-sizing: border-box;"></section><section style="clear: both;box-sizing: border-box;"></section></section></section></section></section></section><p style="text-align: justify;"><span style="font-size: 15px;">今年上半年，”火绒终端威胁情报系统”检测到Worm/Sharp变种在肆意传播，Worm/Sharp或将卷土重来。该变种通过与C&amp;C服务器进行通讯以及内置的爬虫功能获取目标的IP地址及端口，对RPC服务(135端口)、SQLServer服务(1433端口)、FTP服务(21端口)进行爆破，使用永恒之蓝漏洞对445端口进行入侵，如果入侵或爆破成功则执行脚本从C&amp;C服务器上下载初始样本，初始样本经过多重释放，最终运行Worm/Sharp蠕虫。除此之外还会判断目标IP是否为代理服务器，以及对从C&amp;C服务器获取的路由器IP地址列表发起TCP连接以判断7547端口的连通性，为下一步的攻击做准备。</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">初始样本执行流程，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.8688271604938271" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/0icdicRft8tz680pFdIZAzRLhmsTDqh75CickZyKiastHHDqAiah2NyZmkj3V3GxE5xewN5BU5iazEcSib0UVUia7EgnCg/640?wx_fmt=jpeg" data-type="jpeg" data-w="648" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">初始样本执行流程</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">原始样本(A22.exe)是经过PECompact加壳过的，在运行过程中会释放lib32Waxe.exe，lib32Waxe.exe带有混淆器在内存中会解压缩.Net恶意代码，并通过调用ComCallPreStub来执行这段.Net恶意代码，之后进入Worm/Sharp核心代码，Worm/Sharp有两大核心功能。核心功能，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.5575117370892019" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/0icdicRft8tz680pFdIZAzRLhmsTDqh75CDluZndryEpt6JCDAEMGKAI7xXOKr131azGHbIVDojB9S316a9fNl9Q/640?wx_fmt=jpeg" data-type="jpeg" data-w="852" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">病毒核心功能</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">初始样本(A22.exe)由VB编写并且加了PECompact壳，在执行过程中会释放lib32waxe.exe，并创建服务WaxeSvc，主流程执行完后会启动自删除进程。初始样本主流程，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.4796663190823775" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CCN5lUibleibYH0WhGKicm4ZpmBglU2iafGz8RdceYnWdMMQstBOHbFUbbQ/640?wx_fmt=png" data-type="png" data-w="1918" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">初始样本执行流程</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">lib32Waxe.exe带有混淆器在执行过程中解压缩 Worm/Sharp蠕虫代码。载入二进制资源代码，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.44397759103641454" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75Cf2Dau3y3GUXOxB32ZyViaCzkLXA2kvBra5x0ic2623sQ92p68ns0ZAiaw/640?wx_fmt=png" data-type="png" data-w="1428" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">载入资源</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">载入的二进制资源经过zlib压缩，zlib版本为1.2.3。解压后可以获得.Net恶意代码。解压缩代码，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.37123287671232874" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CmLmOdnRTGOVeKwaY80EslWdxN1WKQqlEuopvGOZzSTRgseReIsaibsA/640?wx_fmt=png" data-type="png" data-w="1460" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">解压缩代码</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">在最后使用CLR API 实现在C++中运行.Net恶意代码，调用Clr.dll中未公开的函数ComCallPreStub运行Worm/Sharp蠕虫。调用ComCallPreStub函数相关代码，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.4992063492063492" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CN66ZxPGkiaRr24sHtIiayYgh0f49IXSNQq4HcVUhvBvIvnCpXbFZVkVg/640?wx_fmt=png" data-type="png" data-w="1260" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">启动蠕虫代码</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">该蠕虫分为获取被攻击的IP列表和入侵攻击两部分功能，两部分功能相互协作，不分先后，且两部分功能中的每一个操作均为一个独立线程。</span></p><p><br></p><section style="box-sizing: border-box;"><section class="V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section style="margin: 34px 0% 8px;box-sizing: border-box;"><section style="background-color: rgb(62, 62, 62);height: 1px;box-sizing: border-box;"></section></section></section><section class="V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section style="margin: -24px 0% 10px;box-sizing: border-box;"><section style="display: inline-block;border-width: 2px;border-style: solid;border-color: rgba(255, 255, 255, 0);padding: 0.1em 0.3em;background-color: rgb(252, 180, 65);color: rgb(255, 255, 255);box-sizing: border-box;"><p style="box-sizing: border-box;"><span style="color: rgb(0, 0, 0);font-size: 15px;"><strong style="box-sizing: border-box;">(一) 获取被攻击的IP列表</strong></span></p></section></section></section></section><p style="text-align: justify;"><strong><span style="font-size: 15px;">1. 爬虫功能</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">该蠕虫内置了爬虫功能，可以根据随机字符串搜索、关键字搜索、与C&amp;C服务器通讯和Weblogs搜索来扩充自己的IP列表，为入侵攻击功能提供数量庞大的主机列表。</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">1.1 通过搜索引擎搜索随机字符串</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">该线程会维持一个list列表，当列表中的数量小于等于200时，调用Random_Sting_1函数随机生成字符串，并作为GetList_FromYahooAndBing方法的参数，在Yahoo和Bing 搜索引擎中进行搜索。筛选出符合要求的，进行正则过滤，正则代码如下[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\:[0-9]{1,5}。</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">在List_Filter方法中会根据端口号对list中的目标主机进行分类，为入侵攻击功能提供攻击目标。</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">函数逻辑，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="1.579163810829335" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CiaxSocnAmYHMt2PtL9hr32lhicfoChibfWMick8zt3XGYan2YAlEH9a5mw/640?wx_fmt=png" data-type="png" data-w="1459" style=""></p><p style="text-align: center;"><span style="font-size: 15px;text-align: justify;">搜索随机字符串</span><br></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">1.2 通过搜索引擎搜索关键字扩充FTP列表</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">函数逻辑，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.18430034129692832" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CvtibsB9EnUDI7nzU25cnyVLJM3y8uDQGVHcw75RdC5Dz1hcOfaDlcbQ/640?wx_fmt=png" data-type="png" data-w="1465" style=""></p><p style="text-align: center;"><span style="font-size: 15px;text-align: justify;">ExpandFTPList()函数逻辑</span><br></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">在GetIPList_keyWordString_FromBingAndYahoo方法中定义了一个数组array，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.14109347442680775" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CF6ZFfRr0CVDXxInFT2ThBYMhaXZlvH8PliaRYlr7todvgcXBtgKia1cg/640?wx_fmt=png" data-type="png" data-w="1134" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">用于拼接的字符串数据</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">拼接了两个字符串</span></p><p><br></p><p style="text-align: left;"><span style="font-size: 15px;">String a ="domain:"+array[Random(array.Length)]+Random(10000).ToString</span></p><p><br></p><p style="text-align: left;"><span style="font-size: 15px;">String b ="site::"+array[Random(array.Length)]+Random(10000).ToString</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">使用Bing搜索字符串a，添加符合要求的IP保存到list</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">使用雅虎搜索字符串b，添加符合要求的IP保存到list</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">UseIPList_FromBing回调使用Bing搜索”ip:”+list列表中的地址，筛选21端口的IP地址，调用AddFTPList回调将筛选后的IP加入FTP爆破的List中，用于入侵攻击功能进行攻击。</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">1.3 通过与C&amp;C通讯更新相应的列表</span></strong></p><p style="text-align: left;"><span style="font-size: 15px;">Route_TCP_Connect函数从C&amp;C服务器（hxxp://tz.gxout.com/ip/route_tcp.aspx）获取DES加密后的路由IP地址列表，DES解密的key=” 20110520”,IV={32,17,5,32,33,1,88,72}。解密之后发起TCP连接，判断7547端口是否存活，如果存活则添加到相应的List中。</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">TCP_Connect函数与上述类似，只是请求的地址有所不同，通讯地址为 (hxxp://tz.gxout.com/ip/tcp.aspx)，主要筛选135、445、1433端口的IP地址。整体逻辑，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="1.7136678200692042" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75Cy8bm5ppwAXgYNpWRCP6ibmqBfWmt8Uhib7VfnmHLPvjyfpR7ibdlaicFwg/640?wx_fmt=png" data-type="png" data-w="1156" style=""></p><p style="text-align: center;"><span style="font-size: 15px;text-align: justify;">与C&amp;C服务器通讯逻辑</span><br></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">1.4 通过weblogs.com搜集信息扩充1433端口IP列表</span></strong></p><p style="text-align: left;"><span style="font-size: 15px;">蠕虫会从http://rpc.weblogs.com/shortChanges.xml下载shortChanges.xml，对xml文件进行解析。调用GetWeblogList_AfterFilter函数过滤Xml的内容，调用GetUrl_FromList将WeblogList中的URL提取出来，调用UrlListFilter过滤以.xml、.rss、.pdf、.gz、和.doc结尾的URL。调用StringManipulationAndAddList函数筛选端口为1433的IP地址，添加到1433爆破的List中。整体逻辑，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="2.1163287086446103" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75C8moA4OzNLYUicwoWDibw9OHJt5dc9iceC3Nw2Vn1XoljR2IVgsXGDKjOw/640?wx_fmt=png" data-type="png" data-w="937" style=""></p><p style="text-align: center;"><span style="font-size: 15px;text-align: justify;">Weblogs搜集信息逻辑</span><br></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">2. 执行远程恶意代码</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">通过访问黑客的C&amp;C服务器（ftp:// in.siolio.com），下载FTP上的exe并执行。该功能可以作为一个后门功能，便于后续攻击的展开。相关代码，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.9560439560439561" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CkHrJJz0zc0OQ2cKLI31Q6ZzsW1ZZJr8fv0iamtW854JqNBHRSAVCuvA/640?wx_fmt=png" data-type="png" data-w="1456" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">下载可执行文件并执行</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">FTP账号及密码，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.36268526591107236" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CubFKcm3bV6ia7QiabkqjhMeOrORdm2kjkuMlqOEM8dxtVNbPEsmAXAKw/640?wx_fmt=png" data-type="png" data-w="1147" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">FTP账号密码</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">3. 修改注册表关闭TCP/IP的连接数限制</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">修改注册表，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.3680805176132279" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CKDhBCwHhVohWchKlP2eLPle9kWlveAuEW5UKKP3bETOtXyxXWPsrYg/640?wx_fmt=png" data-type="png" data-w="1391" style=""></p><p style="text-align: center;"><span style="font-size: 15px;text-align: justify;">修改连接数限制</span><br></p><p><br></p><section style="box-sizing: border-box;"><section class="V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section style="margin: 34px 0% 8px;box-sizing: border-box;"><section style="background-color: rgb(62, 62, 62);height: 1px;box-sizing: border-box;"></section></section></section><section class="V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section style="margin: -24px 0% 10px;box-sizing: border-box;"><section style="display: inline-block;border-width: 2px;border-style: solid;border-color: rgba(255, 255, 255, 0);padding: 0.1em 0.3em;background-color: rgb(252, 180, 65);color: rgb(255, 255, 255);box-sizing: border-box;"><p style="box-sizing: border-box;"><span style="color: rgb(0, 0, 0);font-size: 15px;"><strong style="box-sizing: border-box;">(二) 入侵攻击功能</strong></span></p></section></section></section></section><p style="text-align: justify;"><span style="font-size: 15px;">蠕虫会通过与C&amp;C服务器(hxxp://api.gxout.com/ip/google.aspx)进行通讯获取加密后的IP列表，解密过滤后，加入相应的List中。入侵攻击功能分为以下6个部分：FTP爆破、135端口爆破、445端口入侵、1433端口爆破、7547端口回连、代理服务器检测，并且当断网的情况下，会自动遍历内网IP对内网的其他服务器进行爆破和漏洞攻击。功能线程，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.6253424657534247" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CUdDopqAs5hgOt74a1mxAweKA8udDLoIBD2WFwOqHulX4j26CAGe02w/640?wx_fmt=png" data-type="png" data-w="1460" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">功能线程</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">1. FTP爆破</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">获取被攻击的IP列表功能中已经对FTP的列表进行了扩充，所以在入侵攻击功能中直接开始爆破，内置的字典(部分)，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.38493150684931504" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75Cxbr6bTgBbtFSAtHldavmmabu9bdCLfBAXUNO1mY7DKB1zmeX7Pyic6g/640?wx_fmt=png" data-type="png" data-w="1460" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">登录信息字典</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">如果爆破成功则向目标IP上传测试文件，对上传路径进行Http请求，删除上传的文件，比较内容，相同则返回全路径，之后将网站的域名(ip地址)+ftp用户名+ftp密码+上传文件的完整路径进行URL编码发送到C&amp;C服务器(hxxp://tz.gxout.com/ftp/set.aspx)上。程序流程，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.27369219105382864" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75Ct3LkSUSM608Ikp1psKKTBaNh5xVOjp4BFphCVIC95abTcaialgZOUBw/640?wx_fmt=png" data-type="png" data-w="1319" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">测试和发送流程</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">2. 135端口爆破</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">使用的账号为Administrator，密码字典，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.19146005509641872" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CgWrDoico6FWUXPnuIgS6UecbnQMrzYnn5CdO0DBHl3Eme8SyqD3Byww/640?wx_fmt=png" data-type="png" data-w="1452" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">密码字典</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">爆破成功之后，会在目标服务器生成批处理文件并执行最终执行的批处理，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.10993843447669305" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CZBYP5Uic9Nnkox04Sa9ibiczgzWR4c7jyUgNIg359P2QnVhvuMYtgyticw/640?wx_fmt=png" data-type="png" data-w="1137" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">批处理内容</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">3. 445端口入侵</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">该蠕虫除了爆破功能之外还会通过漏洞进行入侵，使用永恒之蓝对服务器进行攻击。部分Payload，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.6236338797814208" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75C1VrNTtPZnpOCrSZcxZP2G6IxUTo1wFWicV5aBMjR37lQKVxG7ibzCb4w/640?wx_fmt=png" data-type="png" data-w="1464" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">永恒之蓝Payload</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">4. 1433端口爆破</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">账号默认sa，密码字典(部分)，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.5061475409836066" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CX2w1oahd8Bh4xdyRvtGOFoaTibq8d452v4TTxdN7AV9F2ibmNL0jL7mA/640?wx_fmt=png" data-type="png" data-w="1464" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">密码字典</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">爆破成功的行为除了执行批处理命令之外还会执行脚本和数据库操作，部分脚本如下：</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.9226856561546287" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CB4BiaA8AglUj5DTDzNdJ8ZJXAHO22RAzAb6sThjXUtMX4ibaeY5n7Otw/640?wx_fmt=png" data-type="png" data-w="983" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">命令脚本</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">此外还会对目标主机的注册表进行操作，禁用CMD、映像劫持。注册表操作，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.5699588477366255" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75C4KHDyrI4nZMDRQUUJkDq0jhMKNmQko72xN406CtAiaQMP0UlAeiaHHeg/640?wx_fmt=png" data-type="png" data-w="1458" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">注册表操作</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">5. 7547端口IP列表发送</span></strong></p><p style="text-align: left;"><span style="font-size: 15px;">在获取被攻击的IP列表功能中已经对从C&amp;C服务器获取的路由器IP列表进行了过滤和检测，入侵攻击功能中对该列表进行DES加密URL编码后发送到C&amp;C服务器(hxxp://tz.gxout.com/ip/port_set.aspx)。通讯代码，如下图所示：</span></p><p style="text-align: left;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.17920656634746923" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CLEtI9vib2QhKk0v4FJMUQrwn8rlictHnRwHvHMeRLgqtvECc05jjmR9Q/640?wx_fmt=png" data-type="png" data-w="1462" style=""></p><p style="text-align: center;"><span style="font-size: 15px;text-align: justify;">HTTP连接</span><br></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 15px;">6.代理服务器检测</span></strong></p><p style="text-align: justify;"><span style="font-size: 15px;">当端口不是135、445、1433、7547时，会检测目标机器的IP地址和端口是否为代理服务器，将其作为代理服务器连接Yahoo，连接成功则进行DES加密发送给C&amp;C服务器(hxxp://api.gxout.com/proxy/google.aspx)。逻辑流程，如下图所示：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.4160383824537354" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75Cmeia3QgGoEflhPiay9GnL1YQcLlXWxm7TVG3DHG44YYJeYJsuvkudlibg/640?wx_fmt=png" data-type="png" data-w="1459" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">代理服务器检测</span></p><p><br></p><section style="box-sizing: border-box;"><section class="V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section style="box-sizing: border-box;"><section style="display: inline-block;vertical-align: bottom;box-sizing: border-box;"><section style="transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);background-color: rgb(249, 110, 87);width: 1.6em;height: 1.6em;text-align: center;font-size: 18px;line-height: 1.6em;color: rgb(255, 255, 255);box-sizing: border-box;"><p style="box-sizing: border-box;">03</p></section><section style="width: 0px;margin-left: auto;transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);border-width: 3px;border-style: solid;border-color: rgb(107, 178, 171) transparent transparent rgb(107, 178, 171);box-sizing: border-box;"></section></section><section style="display: inline-block;vertical-align: bottom;margin-left: -6px;box-sizing: border-box;"><section style="display: inline-block;vertical-align: middle;height: 1.6em;line-height: 1.7em;background-color: rgb(240, 240, 240);text-align: center;padding-left: 10px;padding-right: 4px;box-sizing: border-box;"><p style="box-sizing: border-box;"><strong style="box-sizing: border-box;">同源性分析</strong></p></section><section style="display: inline-block;vertical-align: middle;width: 0px;border-left: 0.8em solid rgb(240, 240, 240);border-top: 0.8em solid transparent !important;border-bottom: 0.8em solid transparent !important;box-sizing: border-box;"></section><section style="clear: both;box-sizing: border-box;"></section></section></section></section></section></section><p style="text-align: justify;"><span style="font-size: 15px;">对黑客的C&amp;C服务器进行溯源，可以发现该C&amp;C服务器地址最早可以追溯到2017年6月23日，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.5556569343065694" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CWmicgKd0IN1qlBPAd6nribn6FF2ZqvC7mVka3icouKhHaQxmI44q72Z0w/640?wx_fmt=png" data-type="png" data-w="1096" style=""></p><p style="text-align: center;"><span style="font-size: 15px;">VT上的分析结果</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">当时从该网站上面下载的蠕虫的名称为A11.exe，而我们分析的样本名为A22.exe，最近一次更新时间为2018年7月23日。如下图所示：</span></p><p><br></p><p style="text-align: center;"><img data-copyright="0" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CcKRbANyObkm8BRnvaiabibpgGIxcBJ4y25p1HTLgyDqX9ypOzGicaSYPA/640?wx_fmt=png" data-type="png" style="" class="" data-ratio="0.3055555555555556" data-w="1080"></p><p style="text-align: center;"><span style="font-size: 15px;">黑客FTP上的内容</span></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">由此可知，从2017年06月23日(甚至更早) 至今，该黑客组织一直使用该系列蠕虫在全网进行大规模的信息收集，且一直保持对病毒的更新。</span></p><p><br></p><section style="box-sizing: border-box;"><section class="V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section style="box-sizing: border-box;"><section style="display: inline-block;vertical-align: bottom;box-sizing: border-box;"><section style="transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);background-color: rgb(249, 110, 87);width: 1.6em;height: 1.6em;text-align: center;font-size: 18px;line-height: 1.6em;color: rgb(255, 255, 255);box-sizing: border-box;"><p style="box-sizing: border-box;">04</p></section><section style="width: 0px;margin-left: auto;transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);border-width: 3px;border-style: solid;border-color: rgb(107, 178, 171) transparent transparent rgb(107, 178, 171);box-sizing: border-box;"></section></section><section style="display: inline-block;vertical-align: bottom;margin-left: -6px;box-sizing: border-box;"><section style="display: inline-block;vertical-align: middle;height: 1.6em;line-height: 1.7em;background-color: rgb(240, 240, 240);text-align: center;padding-left: 10px;padding-right: 4px;box-sizing: border-box;"><p style="box-sizing: border-box;"><strong style="box-sizing: border-box;">预警</strong></p></section><section style="display: inline-block;vertical-align: middle;width: 0px;border-left: 0.8em solid rgb(240, 240, 240);border-top: 0.8em solid transparent !important;border-bottom: 0.8em solid transparent !important;box-sizing: border-box;"></section><section style="clear: both;box-sizing: border-box;"></section></section></section></section></section></section><p style="text-align: justify;"><span style="font-size: 15px;">该蠕虫的目的是全网传播并将搜集到的相关信息发送到C&amp;C服务器上，况且Worm/Sharp还有一个后门功能，黑客已经使用该系列的蠕虫收集了一年多的时间，在未来很有可能会发动大规模的攻击。</span></p><p><br></p><section style="box-sizing: border-box;"><section class="V5" style="box-sizing: border-box;" powered-by="xiumi.us"><section style="margin-top: 10px;margin-bottom: 10px;box-sizing: border-box;"><section style="box-sizing: border-box;"><section style="display: inline-block;vertical-align: bottom;box-sizing: border-box;"><section style="transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);background-color: rgb(249, 110, 87);width: 1.6em;height: 1.6em;text-align: center;font-size: 18px;line-height: 1.6em;color: rgb(255, 255, 255);box-sizing: border-box;"><p style="box-sizing: border-box;">05</p></section><section style="width: 0px;margin-left: auto;transform: rotate(0deg);-webkit-transform: rotate(0deg);-moz-transform: rotate(0deg);-o-transform: rotate(0deg);border-width: 3px;border-style: solid;border-color: rgb(107, 178, 171) transparent transparent rgb(107, 178, 171);box-sizing: border-box;"></section></section><section style="display: inline-block;vertical-align: bottom;margin-left: -6px;box-sizing: border-box;"><section style="display: inline-block;vertical-align: middle;height: 1.6em;line-height: 1.7em;background-color: rgb(240, 240, 240);text-align: center;padding-left: 10px;padding-right: 4px;box-sizing: border-box;"><p style="box-sizing: border-box;"><strong style="box-sizing: border-box;">附录</strong></p></section><section style="display: inline-block;vertical-align: middle;width: 0px;border-left: 0.8em solid rgb(240, 240, 240);border-top: 0.8em solid transparent !important;border-bottom: 0.8em solid transparent !important;box-sizing: border-box;"></section><section style="clear: both;box-sizing: border-box;"></section></section></section></section></section></section><p><span style="font-size: 15px;"></span><br></p><p style="text-align: justify;"><span style="font-size: 15px;">文中涉及样本SHA256：</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.21605667060212513" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz680pFdIZAzRLhmsTDqh75CDxuLb8eBUmlUIpooSTiaV5k18T7Q8AmQiaz9B40qvhN7ahMwYFlysFLw/640?wx_fmt=png" data-type="png" data-w="847" style=""></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;"> </span></p><p style="text-align: justify;"><span style="font-size: 15px;"><br></span></p><hr><p><br></p><p><span style="font-size: 14px;">点击“阅读原文”试用“火绒企业版”</span></p><p><br></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.5555555555555556" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/0icdicRft8tz680pFdIZAzRLhmsTDqh75CqxNqoBtCpYlcF8BnEheDUcPnbSiaicCn180Y9xPkYh0g8PremCM6NOqg/640?wx_fmt=jpeg" data-type="jpeg" data-w="900" style=""></p><p><br></p>
                </div>
                <script nonce="54522092" type="text/javascript">
                    var first_sceen__time = (+new Date());

                    if ("" == 1 && document.getElementById('js_content')) {
                        document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });
                    }

                    
                    (function(){
                        if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                            var link = document.createElement('link');
                            var head = document.getElementsByTagName('head')[0];
                            link.rel = 'stylesheet';
                            link.type = 'text/css';
                            link.href = "//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg_new/winwx3ec991.css";
                            head.appendChild(link);
                        }
                    })();
                </script>

                
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display:none;"></div>

                
                                <div class="reward_area tc reward_area_primary" id="js_preview_reward_author" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_preview_reward_author_avatar">
                        <img src="" alt="" id="js_preview_reward_author_head">
                    </div>
                    
                                        <div class="reward-author" id="js_preview_reward_author_name">火绒安全实验室</div>
                                        <p class="reward_tips" id="js_preview_reward_author_wording" style="display:none;"></p>
                    <p>
                        <a class="reward_button" id="js_preview_reward_author_link" href="##"><span id="js_preview_reward_link_text">赞赏</span></a>
                    </p>
                </div>

                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="//res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x3534dd.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                                
                
                            </div>
                                    
                        


                        
            <ul id="js_hotspot_area" class="article_extend_area"></ul>


            
                        <div class="rich_media_tool" id="js_toobar3">

                                            <a class="media_tool_meta meta_primary" id="js_view_source" href="##">阅读原文</a>
                                <div id="js_read_area3" class="media_tool_meta tips_global_primary meta_primary" style="display:none;">阅读 <span id="readNum3"></span></div>

                <span style="display:none;" class="media_tool_meta meta_extra meta_praise" id="like3">
                    <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum3"></span>
                </span>

                

            </div>


                        <div class="rich_media_tool" id="js_sg_bar">

                                <a class="media_tool_meta meta_primary" href="http://m.huorong.cn/businessProduct.html" target="_blank">阅读原文</a>
                                
            </div>
                      </div>
        </div>

        <div class="rich_media_area_primary sougou" id="sg_tj" style="display:none"></div>


        
        <div class="rich_media_area_extra">
          <div class="rich_media_area_extra_inner">
              
              <div id="js_share_appmsg">
              </div>

              
                            <div class="mpda_bottom_container" id="js_bottom_ad_area"></div>
                            
              <div id="js_iframetest" style="display:none;"></div>
                            
                            
              <div class="rich_media_extra rich_media_extra_discuss" id="js_cmt_container" style="display:none">
                

                
                <div class="discuss_mod" id="js_friend_cmt_area" style="display:none">
                  
                  
                  
                </div>

                                <div class="discuss_mod" id="js_cmt_area" style="display:none">
                </div>
                              </div>
          </div>
        </div>

        
        <div id="js_pc_qr_code" class="qr_code_pc_outer" style="display:none;">
            <div class="qr_code_pc_inner">
                <div class="qr_code_pc">
                    <img id="js_pc_qr_code_img" class="qr_code_pc_img">
                    <p>微信扫一扫<br>关注该公众号</p>
                </div>
            </div>
        </div>
    </div>