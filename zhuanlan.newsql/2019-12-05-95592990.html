<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>赛程刚过 1/3，什么操作让性能提升 150+ 倍？</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/95592990">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-b3b78e1059984e6e3386e276422eca5a_b.jpg" alt=""></div><p>作者：姚维</p><p>11 月初我们开启了一项社区新活动「TiDB 性能挑战赛」(Performance Challenge Program，简称 PCP)，这项积分赛将持续 3 个月，选手将完成一系列难度不同的任务，赢得相应的积分。目前赛程刚刚过去三分之一，已经取得了十分耀眼的阶段性成果：</p><ul><li>过去一个月共吸引了来自社区的 156 位贡献者，包括：</li><ul><li>14 支参赛队伍。</li><li>110 位个人参赛者。</li></ul><li>参赛选手们总共完成了 147 个挑战任务，这些成果已经逐步落地到 TiDB 产品中：</li><ul><li>TiDB 表达式框架中完成了 70+ 个函数的向量化。</li><li>TiKV 协处理器中完成了 40+ 个函数的向量化，其中 34 个已在 TiDB 侧新开启了下推，让下推的函数计算速度大幅上升。</li></ul></ul><p><b>截至发稿时积分排行榜前五名的参赛选手 / Team 分别是：.* team、ekalinin、mmyj、AerysNan、js00070。</b></p><p>其中 .* team 表现尤为优异，他们已经拿到了 4150 积分，在排行榜上遥遥领先。而来自俄罗斯的个人参赛者 ekalinin 获得了 1450 积分，是目前积分最高的个人参赛者，他共提交了 17 个任务，目前完成了 12 个，其中包含一个 Medium 难度的任务。​</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-ee470bebf82f06949107d218f053b5c1_b.jpg" data-size="normal" data-rawwidth="939" data-rawheight="554" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic2.zhimg.com/v2-ee470bebf82f06949107d218f053b5c1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-ee470bebf82f06949107d218f053b5c1_b.jpg" data-size="normal" data-rawwidth="939" data-rawheight="554" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic2.zhimg.com/v2-ee470bebf82f06949107d218f053b5c1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-ee470bebf82f06949107d218f053b5c1_b.jpg"/><figcaption>积分排行榜</figcaption></figure><blockquote>“因为对 Rust 感兴趣参加了这次 PCP，能够亲自改善一个自己会使用的工具的感受非常令人愉悦，项目的文档，代码结构和社区都非常友好,带来了很强的正反馈。”<br/>—— Renkai（PCP 个人参赛者）<br/>“参加 PCP 是很有趣的体验，既能深度参与开源项目，又能在这个过程中学到很多数据库和 Rust 的知识，还能通过获得积分兑换奖励，导师的指导非常耐心，希望能有更多的人参与进这个项目来。”<br/>—— TennyZhuang（PCP 团队参赛者 .* team 成员）<br/>“I like Go &amp; databases. TiDB has both of them. So I just decided to deep dive into internals of the TiDB and check if I can be useful for it. I’m a big fan of open source. I have a couple of open sourced projects and I understand the importance of the contribution into open source projects.<br/>I feel great after joining the PCP and TiDB community! Good docs, a lot of tests, well written code :)”<br/>—— ekalinin（PCP 个人参赛者，来自俄罗斯）</blockquote><p><b>下面让我们来看看过去的一个月里大家在「性能提升」方面有哪些突破性的战绩吧！</b></p><h3>1. IN() 函数性能提升 150+ 倍</h3><p>相关 PR <a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/pull/6000" class=" wrap external" target="_blank" rel="nofollow noreferrer">链接</a>，作者：<a href="https://link.zhihu.com/?target=https%3A//github.com/TennyZhuang" class=" wrap external" target="_blank" rel="nofollow noreferrer">TennyZhuang</a>（ .* team ）</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-5c2a2a4dc7a8f27a933d60b05895b914_b.jpg" data-caption="" data-size="normal" data-rawwidth="1180" data-rawheight="724" class="origin_image zh-lightbox-thumb" width="1180" data-original="https://pic1.zhimg.com/v2-5c2a2a4dc7a8f27a933d60b05895b914_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-5c2a2a4dc7a8f27a933d60b05895b914_b.jpg" data-caption="" data-size="normal" data-rawwidth="1180" data-rawheight="724" class="origin_image zh-lightbox-thumb lazy" width="1180" data-original="https://pic1.zhimg.com/v2-5c2a2a4dc7a8f27a933d60b05895b914_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-5c2a2a4dc7a8f27a933d60b05895b914_b.jpg"/></figure><p><code>IN()</code> 是一个大家用的很多的 SQL 内置函数。这个 PR 使得 <code>IN()</code> 内置函数的性能有了复杂度级别的提升，从 <code>O(N)</code> 提升到 <code>O(1)</code>，如上图所示。这对于 <code>IN()</code> 函数中有很多参数的情况能有很大的帮助，例如在以下 1000 个参数场景中性能提升可达 150+ 倍：</p><div class="highlight"><pre><code class="language-text">CREATE TABLE `foo` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `c` char(100),
  PRIMARY KEY (`id`)
);

select * from foo where c in (
&#34;271a76b46731d9&#34;, &#34;a7a69f89d4b32e&#34;, &#34;8d969b6b76f6f4&#34;, &#34;8ea63d5c33dabe&#34;, &#34;4c5dabf74df99f&#34;, &#34;897ab55a20218b&#34;, &#34;80d73f4331a342&#34;, &#34;a4747627a2e05d&#34;,
&#34;e20beca46373&#34;, &#34;4dbc295621b4c5&#34;, &#34;79ab1ea844c293&#34;, &#34;86d75b32f6b1b8&#34;, &#34;7fd827adcc7cd0&#34;, &#34;bf26b53dd73dd&#34;,
...
);</code></pre></div><p><i>大家不要觉得这么多参数是很少见的情况，实际上我们已经遇到多个 TiDB 用户给</i> <i><code>IN()</code></i> <i>内置函数传递多达几千个参数的场景。</i></p><p><a href="https://link.zhihu.com/?target=https%3A//github.com/TennyZhuang" class=" wrap external" target="_blank" rel="nofollow noreferrer">TennyZhuang</a>（ .* team 成员）成功通过这个 PR 获得了 2100 积分，这个是目前选手获得的单个贡献最高积分。不过这还只是 Medium 难度的任务，我们还有许多更高积分奖励的 Hard 级别任务等待大家来挑战。</p><h3>2. LIKE() 函数性能指数级提升</h3><p>相关 PR <a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/pull/5866" class=" wrap external" target="_blank" rel="nofollow noreferrer">链接</a>，作者：<a href="https://link.zhihu.com/?target=https%3A//github.com/TennyZhuang" class=" wrap external" target="_blank" rel="nofollow noreferrer">TennyZhuang</a>（ .* team 成员）</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-e669500262244591e235f1fccba0a00e_b.jpg" data-caption="" data-size="normal" data-rawwidth="1186" data-rawheight="730" class="origin_image zh-lightbox-thumb" width="1186" data-original="https://pic3.zhimg.com/v2-e669500262244591e235f1fccba0a00e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-e669500262244591e235f1fccba0a00e_b.jpg" data-caption="" data-size="normal" data-rawwidth="1186" data-rawheight="730" class="origin_image zh-lightbox-thumb lazy" width="1186" data-original="https://pic3.zhimg.com/v2-e669500262244591e235f1fccba0a00e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-e669500262244591e235f1fccba0a00e_b.jpg"/></figure><p>这个 PR 通过修改了算法，实现了对 <code>LIKE()</code> 内置函数性能的指数级别改进，从 <code>O(2^N)</code> 优化到 <code>O(N)</code>。在优化前，仅仅是 6 个通配符就能将单行计算性能降低到秒级，对性能可以造成非常严重的影响。上图直观展示了这个 PR 带来的性能提升（纵坐标是对数坐标）。<a href="https://link.zhihu.com/?target=https%3A//github.com/TennyZhuang" class=" wrap external" target="_blank" rel="nofollow noreferrer">TennyZhuang</a>（ .* team 成员）通过这个 PR 获得了 1500 积分。</p><h3>3. 全面提升 TPC-H 性能</h3><p>相关 PR <a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/pull/5979" class=" wrap external" target="_blank" rel="nofollow noreferrer">链接</a>，作者：<a href="https://link.zhihu.com/?target=https%3A//github.com/Renkai" class=" wrap external" target="_blank" rel="nofollow noreferrer">Renkai</a></p><p><a href="https://link.zhihu.com/?target=http%3A//www.tpc.org/tpch/" class=" wrap external" target="_blank" rel="nofollow noreferrer">TPC-H</a> 是目前业界通用的衡量数据库分析处理能力的基准测试。这个任务通过减少内存复制的方式，全面提升了 TPC-H 各查询 5%~14% 的耗时，可以说是非常令人惊艳的结果了，以下是对比结果：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-2c54cf3f86965ec8e9c177386f3c9028_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="579" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic1.zhimg.com/v2-2c54cf3f86965ec8e9c177386f3c9028_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-2c54cf3f86965ec8e9c177386f3c9028_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="579" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic1.zhimg.com/v2-2c54cf3f86965ec8e9c177386f3c9028_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-2c54cf3f86965ec8e9c177386f3c9028_b.jpg"/></figure><p>下表加红加粗部分每个语句提升的百分比。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-1a87039ab2ab4977139a091f31d8ada1_b.jpg" data-caption="" data-size="normal" data-rawwidth="1228" data-rawheight="848" class="origin_image zh-lightbox-thumb" width="1228" data-original="https://pic2.zhimg.com/v2-1a87039ab2ab4977139a091f31d8ada1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-1a87039ab2ab4977139a091f31d8ada1_b.jpg" data-caption="" data-size="normal" data-rawwidth="1228" data-rawheight="848" class="origin_image zh-lightbox-thumb lazy" width="1228" data-original="https://pic2.zhimg.com/v2-1a87039ab2ab4977139a091f31d8ada1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-1a87039ab2ab4977139a091f31d8ada1_b.jpg"/></figure><h2>更多有意思的任务</h2><p>目前还有更多更有挑战，更高积分的任务在等待着大家来挑战：</p><ul><li><a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/rust-rocksdb/issues/375" class=" wrap external" target="_blank" rel="nofollow noreferrer">PCP-27</a>：通过跳过 RocksDB Compaction 阶段的某些 SST，以减少 RocksDB 写放大（积分：3600）。</li><li><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/pd/issues/1847" class=" wrap external" target="_blank" rel="nofollow noreferrer">PCP-26</a>：优化 PD 获取 TSO 的性能 （积分：20000）。</li><li><a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb/issues/12979" class=" wrap external" target="_blank" rel="nofollow noreferrer">PCP-10</a> ：优化宽表情况下的查询效率（积分：3000）。</li><li>……</li></ul><p>当前开放的任务列表可分别在 <a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb/projects/26" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiDB Tasks</a>、<a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/projects/20" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiKV Tasks</a>、<a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/pd/projects/2" class=" wrap external" target="_blank" rel="nofollow noreferrer">PD Tasks</a> 中找到。</p><p>更多参赛详情，可以进入 <a href="https://link.zhihu.com/?target=https%3A//pingcap.com/community-cn/tidb-performance-challenge/" class=" wrap external" target="_blank" rel="nofollow noreferrer">官方网站</a> 查看。</p><h2>致谢</h2><p>这里也需要对各个 Special Interest Group（SIG）的 Tech Lead 以及 Mentor 表达感谢，他们为 PCP 完成了出题以及指导参赛者们完成了这些令人印象深刻的挑战：</p><ul><li><a href="https://link.zhihu.com/?target=https%3A//github.com/breeswish" class=" wrap external" target="_blank" rel="nofollow noreferrer">breeswish</a>（<a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/community/tree/master/sig/coprocessor" class=" wrap external" target="_blank" rel="nofollow noreferrer">@Coprocessor SIG</a>）</li><li><a href="https://link.zhihu.com/?target=https%3A//github.com/lonng" class=" wrap external" target="_blank" rel="nofollow noreferrer">lonng</a>（<a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/community/tree/master/sig/coprocessor" class=" wrap external" target="_blank" rel="nofollow noreferrer">@Coprocessor SIG</a>）</li><li><a href="https://link.zhihu.com/?target=https%3A//github.com/sticnarf" class=" wrap external" target="_blank" rel="nofollow noreferrer">sticnarf</a> （<a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/community/tree/master/sig/coprocessor" class=" wrap external" target="_blank" rel="nofollow noreferrer">@Coprocessor SIG</a>）</li><li><a href="https://link.zhihu.com/?target=https%3A//github.com/yiwu-arbug" class=" wrap external" target="_blank" rel="nofollow noreferrer">yiwu-arbug</a> （<a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/community/tree/master/sig/engine" class=" wrap external" target="_blank" rel="nofollow noreferrer">@Storage Engine SIG</a>）</li><li><a href="https://link.zhihu.com/?target=https%3A//github.com/zhangjinpeng1987" class=" wrap external" target="_blank" rel="nofollow noreferrer">zhangjinpeng1987</a>（<a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/community/tree/master/sig/engine" class=" wrap external" target="_blank" rel="nofollow noreferrer">@Storage Engine SIG</a>）</li><li><a href="https://link.zhihu.com/?target=https%3A//github.com/SunRunAway" class=" wrap external" target="_blank" rel="nofollow noreferrer">SunRunAway</a>（<a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/community/blob/master/special-interest-groups/sig-expr" class=" wrap external" target="_blank" rel="nofollow noreferrer">@Expression SIG</a>）</li><li><a href="https://link.zhihu.com/?target=https%3A//github.com/qw4990" class=" wrap external" target="_blank" rel="nofollow noreferrer">qw4990</a>（<a href="https://link.zhihu.com/?target=https%3A//github.com/pingcap/community/blob/master/special-interest-groups/sig-expr" class=" wrap external" target="_blank" rel="nofollow noreferrer">@Expression SIG</a>）</li></ul><blockquote><a href="https://link.zhihu.com/?target=https%3A//pingcap.com/community-cn/tidb-performance-challenge/" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiDB 性能挑战赛</a> 由 PingCAP 发起，旨在激发社区创造性，参赛选手可以通过完成一系列的任务提升 TiDB 产品的性能。赛事于 2019 年 11 月 4 日正式开启，将持续 3 个月，比赛任务分为三个难度：Easy、Medium、Hard，不同难度对应不同积分，参赛选手获得的积分可以兑换 TiDB 限量周边礼品等丰富的奖励。</blockquote><p><b>原文阅读：</b></p><a href="https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/pcp-report-201911/" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg" data-image-width="1200" data-image-height="1200" class=" wrap external" target="_blank" rel="nofollow noreferrer">赛程刚过 1/3，什么操作让性能提升 150+ 倍？ | PingCAP</a><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
