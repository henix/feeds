<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>下一代WAF场景化实践漫谈系列——威胁情报联动的价值</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/59570288">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-b57e04ac8313cdcee878f8e7967ccc78_b.jpg" alt=""></div><p>开篇之初，我们先来看一个真实的案例，发生在<b>雷池（SafeLine）下一代Web应用防火墙</b>客户的使用场景中。<br></p><h2><b> 客户需求 </b></h2><p>金融某客户，其敏感业务的统一认证接口长期遭受<b>爆破和撞库</b>的威胁，希望WAF能够同步处理威胁情报服务产生的业务情报信息，两者联动保障业务正常稳定运行。</p><h2><b> 挑战 </b></h2><p>1. 接口访问量巨大</p><p>2. 不能出现业务延迟</p><p>3. 尽量避免人工参与造成的错误</p><h2><b> 解决方案 </b></h2><p>第一步，雷池（SafeLine）通过独有的插件平台完成<b>插件配置</b>，对访问该统一认证接口的用户进行<b>指纹提取</b>——指定筛选条件的方式过滤出符合某种特征的用户指纹（如源 IP、域名、URL 等）的 HTTP 请求； </p><p>第二步，信息传递由威胁情报服务进行<b>风险评估</b>，若威胁情报平台认为当前用户具有恶意，将回传当前的威胁信息及建议；</p><p>第三步，雷池（SafeLine）<b>接收威胁信息</b>，对相关请求进行逐条处理，并将执行手段下发给请求检测处理模块，进行<b>立即阻断或限制</b>该用户的后续访问行为，<b>保障业务的正常运行。</b></p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-3c7f0eabccd3f81272b02a94b0b596be_b.jpg" data-caption="" data-size="normal" data-rawwidth="1045" data-rawheight="642" class="origin_image zh-lightbox-thumb" width="1045" data-original="https://pic3.zhimg.com/v2-3c7f0eabccd3f81272b02a94b0b596be_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-3c7f0eabccd3f81272b02a94b0b596be_b.jpg" data-caption="" data-size="normal" data-rawwidth="1045" data-rawheight="642" class="origin_image zh-lightbox-thumb lazy" width="1045" data-original="https://pic3.zhimg.com/v2-3c7f0eabccd3f81272b02a94b0b596be_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-3c7f0eabccd3f81272b02a94b0b596be_b.jpg"></figure><h2><b> 客户反馈 </b></h2><p>进行了多轮测试验证后，企业对雷池（SafeLine）和威胁情报服务联动的可用性和准确性很满意，在处理的时效方面完全超出预期，<b>大大降低了安全业务的人工维护成本和时间成本，并有效降低了敏感业务的安全风险。</b></p><p>云时代的WAF，早已不是你当年认识的那个WAF了。<b>平台属性增强，规则属性减弱，智能、灵活成为一款简单好用WAF的首要考虑因素。</b>雷池（SafeLine）下一代Web应用防火墙，作为新型WAF的代表作品，在越来越多的客户真实使用场景中被玩出了花样，解决了更多贴合业务场景和安全风险的问题。<br></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-799944c46700e3a6618841e80275accd_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="681" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic2.zhimg.com/v2-799944c46700e3a6618841e80275accd_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-799944c46700e3a6618841e80275accd_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="681" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic2.zhimg.com/v2-799944c46700e3a6618841e80275accd_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-799944c46700e3a6618841e80275accd_b.jpg"></figure><p><br></p><p>本文着笔的WAF和威胁情报联动的想象空间在于：WAF根据自身的防护能力以及网络边界位置的独特性，检测到更多的未知威胁，更贴近业务场景，更精准、实时的阻断威胁从而降低业务风险。<b>威胁情报犹如为WAF带来新的武器库，可以应对更多类型的网络威胁。</b></p><p>长亭科技的雷池（SafeLine）作为15后产品代表，从设计之初就对开放性与扩展性给予了非常高的重视，为用户提供了<b>全开放式的 API 接口和功能丰富可高度自定义的扩展插件接口，</b>使其能灵活的与各类平台和安全产品进行联动，例如风控平台、运维平台、蜜罐、扫描器以及威胁情报产品等。</p><blockquote><b>参考阅读</b></blockquote><a href="http://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzIwNDA2NDk5OQ%3D%3D%26mid%3D2651372367%26idx%3D1%26sn%3Dd3da91ffc9b459ae6cbb9db7e8dc98cd%26chksm%3D8d39cac7ba4e43d1b92148a11187b4cdb502da0c476ef205683d71e8a6dd9d379647d795b105%26scene%3D21%23wechat_redirect" data-draft-node="block" data-draft-type="link-card" data-image="https://pic3.zhimg.com/v2-2d9ceed78978badf52f685b50ced44c6_ipico.jpg" data-image-width="358" data-image-height="358" class=" wrap external" target="_blank" rel="nofollow noreferrer">2019年，你的 WAF 能应对场景化安全风险了吗？</a><p>除了<b>API集成方式</b>，雷池（SafeLine）内置的<b>插件平台</b>为高级玩家提供了”任意模式“，如与威胁情报的联动：在插件平台使用 Lua 作为脚本语言，用户自主编写插件来输出场景化的 Web 访问统计与 Web 攻击统计；或者编写插件，与其他安全产品及风控系统整和，对攻击者进行多维度深度检测与阻断。 </p><p>这种操作的<b>价值</b>在于：</p><p>1. 不影响企业的正常业务</p><p>2. <b>超大流量</b>下具备稳定的处理性能</p><p>3. <b>响应迅速，</b>延迟处理时长缩短至毫秒级</p><p>4. <b>自动化程度高，</b>只需要正确编写插件</p><p>5. 处理<b>准确率高</b></p><h2><b>附上阅读全文小彩蛋</b></h2><p>文中提到最佳实践的<b>插件编写思路：</b></p><p>使用 <b>match 变量</b>进行筛选，过滤所有访问统一认证接口的 HTTP 请求；</p><p>注册一个<b>回调函数</b>，当用户访问统一认证接口时，将 HTTP 请求传入回调函数进行处理；</p><p>与威胁情报平台联动，判断访问者是否有<b>攻击背景</b>；</p><p>发现恶意用户后下发规则，阻断该用户的<b>后续访问</b>。</p><h2><b> 样例插件代码结构 </b></h2><div class="highlight"><pre><code class="language-text"><span></span>local safeline = require "safeline"

header = {}
header["User-Agent"] = "safeline"

bantime = 60

-- 威胁情报服务平台地址
url = "http://xx.xx.xx.xx/query?apiKey=xxxxxxxxxxxxxxx&amp;src=%s"

match = {
    ip = "0.0.0.0/0",
    host    = "www.chaitin.cn",
    urlpath = "/safelinenb",
    type = safeline.MATCH_TYPE_ALL,
}
function action(ip, resp)
  local banip = {
      ip = ip,
  }
  if string.find(resp, "badboy") ~= nil then
    safeline.action_ban(banip, bantime)
  end
end

function process(ip, host, urlpath)
    urltmp = string.format(url, ip)
        resp, err = safeline.http_get(urltmp, header)
    action(ip, resp["body"])
end

safeline.register(safeline.TYPE_PROCESS, match, process)
</code></pre></div><p>下一代WAF和威胁情报，一个老树新花，一个近年热词，有意思的互动解决了<b>新场景下的网络安全问题</b>，才是当今安全产品不断创新的意义所在。</p><p><br></p><p>更多插件以及 API 信息欢迎前往</p><p><b>[长亭 SafeLine 开放平台] </b></p><a href="http://link.zhihu.com/?target=https%3A//github.com/chaitin/safeline-open-platform" data-draft-node="block" data-draft-type="link-card" data-image="https://pic4.zhimg.com/v2-b465088480504bd3c39bb2ae028690f7_ipico.jpg" data-image-width="400" data-image-height="400" class=" wrap external" target="_blank" rel="nofollow noreferrer">chaitin/safeline-open-platform</a><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
