<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>国产病毒国外作恶  界面LOGO“撞衫”国内上市公司产品</title>
</head>
<body>
<p><a href="https://mp.weixin.qq.com/s?timestamp=1527119783&amp;src=3&amp;ver=1&amp;signature=XzB467pTXWO0syvN4O5xx4*J42jF9tTHnetPIUiHGMGT5yVvcZ6h*g8biPFXlZfwSGLFHOBwsaIWpyL*LSOz*QjrTNZ3kF42CBwfocxQyAP2N-fVXAPHkmF-f2faLQ9aabB4-Ng2qUPhBSILMSGjJsaWqDyqah4XP*zRYbgFFuw=">原文</a></p>
<div id="img-content">
                
                <h2 class="rich_media_title" id="activity-name">
                    国产病毒国外作恶  界面LOGO“撞衫”国内上市公司产品                                    </h2>
                <div id="meta_content" class="rich_media_meta_list">
                                        <span id="copyright_logo" class="rich_media_meta meta_original_tag">原创</span>
                                                            <em id="post-date" class="rich_media_meta rich_media_meta_text">2018-04-16</em>

                                        <em class="rich_media_meta rich_media_meta_text">火绒安全实验室</em>
                                        <a class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="##" id="post-user">火绒安全实验室</a>
                    <span class="rich_media_meta rich_media_meta_text rich_media_meta_nickname">火绒安全实验室</span>


                    <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                        <div class="profile_inner">
                            <strong class="profile_nickname">火绒安全实验室</strong>
                            <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                            <p class="profile_meta">
                            <label class="profile_meta_label">微信号</label>
                            <span class="profile_meta_value">HuorongLab</span>
                            </p>

                            <p class="profile_meta">
                            <label class="profile_meta_label">功能介绍</label>
                            <span class="profile_meta_value">火绒是一家纯粹的信息安全公司。在这里为大家分享专业的技术报告和安全信息。</span>
                            </p>
                            
                        </div>
                        <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                            <i class="profile_arrow arrow_out"></i>
                            <i class="profile_arrow arrow_in"></i>
                        </span>
                    </div>
                </div>
                                
                
                
                
                                                
                                                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <p style="text-align: justify;"><strong><span style="font-size: 16px;">一、	概述</span></strong></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">火绒安全团队发现，近期有国内病毒团伙在国外传播后门病毒“Bandios”。该病毒侵入用户电脑后，将实施“挖矿”（生产“门罗币”）、偷偷劫持用户流量等行为，同时病毒作者还可随时通过远程操控进行其他破坏行为。巧合的是，该病毒安装界面Logo与国内A股上市公司“昆仑万维科技股份有限公司”旗下的下载站Brothersoft完全一样。</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">后门病毒“Bandios”通过国外某个人博客进行传播，博主以免费提供下载图片处理软件“AQUASOFT SLIDESHOW”为由，吸引用户点击带毒下载链接。并且该博主提供了两个名称相同的下载地址，用户点击第一个下载地址后，病毒将直接被下载到用户电脑中，执行恶意代码。</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">而且该病毒极不易被用户察觉，侵入用户电脑后，在被感染电脑上没有提示，也不会显示任何图标。但会在后台偷偷劫持用户浏览器首页、利用用户电脑疯狂“挖矿”（门罗币），同时病毒作者可以随时通过远程操控实施其他破坏行为。</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">而第二个下载地址则会跳转到网址为“www.brothersoft.com”的国外网站中，通过分析发现，该网站为国内上市A股公司“昆仑万维科技股份有限公司”旗下的下载站“Brothersoft”。巧合的是，在后门病毒“Bandios”早期版本的安装界面中，曾出现过一个Logo，与“Brothersoft”的Logo完全一样。</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">目前，“火绒安全软件”最新版可拦截并查杀后门病毒“Bandios”。对于已经感染该病毒的非火绒用户，可以下载使用“火绒专杀工具”彻底查杀该病毒。</span></p><p><br></p><blockquote><p style="text-align: justify;"><span style="font-size: 14px;">Tips：</span></p><p style="text-align: left;"><span style="font-size: 14px;">1、点击下载“火绒专杀工具”http://bbs.huorong.cn/thread-18575-1-1.html；</span></p><p style="text-align: justify;"><span style="font-size: 14px;">2、安装后点击“开始扫描”。</span></p></blockquote><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><strong><span style="font-size: 16px;">二、	详细分析</span></strong></p><p style="text-align: justify;"><strong><span style="font-size: 14px;"><br></span></strong></p><p style="text-align: justify;"><strong><span style="font-size: 14px;">OnlineInstaller.exe</span></strong></p><p style="text-align: justify;"><span style="font-size: 14px;">OnlineInstaller.exe运行后，首先会检测运行参数”-install”，如果不存在该参数则会创建出同名且与当前镜像相同的“.tmp”文件进行执行并加入“-install”参数，之后会统计当前系统和软件信息上传至C&amp;C服务器hxxp://iostream.system.band/dump/io/time.php。其收集的系统和软件信息包括：系统版本、MAC地址、用户所安装的浏览器信息、安全软件信息。相关代码如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="1.0469973890339426" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoIMXbrwWVNQ98GJyjKj5uiblZmhNCNbjuGqic5MJ7RiaOnhqJpVslzptgA/640?wx_fmt=png" data-type="png" data-w="766" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">OnlineInstaller.exe启动相关代码</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">被检测的浏览器，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.23374613003095976" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoicB4AVOnZO0PNUOBB1zF30qWmgAJWNUXGKr7gpU9s0TGNMgP55nR1Lg/640?wx_fmt=png" data-type="png" data-w="646" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">被检测的浏览器名称</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">通过查询注册表方式收集当前环境中的安全软件名，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.20320855614973263" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsofcX2FO159iaAcDXTib45P66Y5yfPHibU9oPDTkon2TR1SJ4BbjiaSvoDDA/640?wx_fmt=png" data-type="png" data-w="748" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">被检测的安全软件</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">如果运行中带有“-install”参数，则会释放出多个病毒模块。通过功能进行分类之后，整体分为两个部分：流量劫持与挖取门罗币。相关代码如下图所示：</span></p><p style="text-align: justify;"><br></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="1.717774762550882" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoKyJmtyN6MXrxEhZRhAp2WUuGe1ruhGsF4BoeuMuPicbnCTAbLW3VAeg/640?wx_fmt=png" data-type="png" data-w="737" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">病毒模块释放代码</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">OnlineInstaller.exe会释放出多个病毒模块，每个模块对应功能如下图所示：</span></p><p style="text-align: justify;"><br></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.42260061919504643" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoZUaq1QHl38NvNh2CJy0vnyB98uOb0oXmKck3ibbk3ElicLge7hcmV5Cw/640?wx_fmt=png" data-type="png" data-w="646" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">病毒模块对应功能</span><br><span style="font-size: 14px;"></span></p><p style="text-align: center;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">在前文所示函数中，OnlineInstaller.exe会释放出所有病毒模块。在资源KPE中存放着所有zlib算法压缩的驱动模块数据，其他病毒模块则是通过异或加密的方式存放在镜像数据中。由于除了驱动模块外，病毒释放其他病毒模块的执行流程大致相同，我们仅以释放spoolsr.exe为例。首先对原有镜像数据进行解密，之后将随机生成长度为0x40的随机数据拼接在原有镜像数据尾部再释放文件，然后将拼接随机数据后的镜像数据再重新进行异或加密。代码如下图所示：</span></p><p style="text-align: justify;"><br></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.8751219512195122" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoOYLV1XxCfUwsWp6XExJfEqX2gju4aENOQnC3G4VfVQajC1b9bz6KeQ/640?wx_fmt=png" data-type="png" data-w="1025" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">释放spoolsr.exe</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">zlib算法加密的驱动数据文件被存放在镜像资源中，KPE资源情况，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.2585987261146497" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoY11kJ3LzyZicAoFdzIRkF5nazPibhCNDbbVYaNib4jbdl7sFoAyYCIfLg/640?wx_fmt=png" data-type="png" data-w="785" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">KPE资源</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">最后，OnlineInstaller.exe会对其释放的文件进行备份，后缀名为“.dat”（如HK.dat为HookKey32.dll的备份），以便将来恢复病毒文件时使用。备份文件对应关系，如下图所示：</span></p><p style="text-align: justify;"><br></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.30282861896838603" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsonmdwXErKKTxsHRoRYx5I3gheibgOQIkjP6P0oYA73MWpHAUMVDeh7Kg/640?wx_fmt=png" data-type="png" data-w="601" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">备份文件关系</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><strong><span style="font-size: 14px;">驱动模块（iaStorE.sys）</span></strong></p><p style="text-align: justify;"><span style="font-size: 14px;">OnlineInstaller.exe使用zlib算法解压资源后，会释放出驱动iaStorE.sys或Dxapi.sys，驱动总共分为x86、x64等5个不同的版本，功能大致相同，我们仅以x86版本的iaStorE.sys为例进行分析。</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">该驱动首先会将原有的释放文件删除，之后使用备份文件进行恢复。相关代码如下图所示：</span></p><p style="text-align: justify;"><br></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.8044554455445545" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsotNOFtu7kicOOISlPlEhDbENnxIpKiafFrRrOhybic88W0rGibIhVVRI9Iw/640?wx_fmt=png" data-type="png" data-w="1616" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">恢复备份文件</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">在重新恢复原有功能模块后，驱动会通过注册服务和注册AppInit_DLLs（当进程加载user32.dll时，被注册的动态库会被进程加载）的方式启动挖矿和流量劫持模块。由于Win10系统在没有安装安全软件时会开启Windows Defender，当病毒检测到环境为Win10系统后会通过修改组策略注册表的方式关闭Windows Defender，代码如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p><img class="" data-copyright="0" data-ratio="1.715778474399164" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsocoawAuFyAoNgOqP2mrXxS5MFxAMQia0E9Cqas0v2NESRLMGaOZFNYQg/640?wx_fmt=png" data-type="png" data-w="957" style=""></p><p style="text-align: justify;"><span style="font-size: 14px;"></span><br></p><p style="text-align: justify;"><span style="font-size: 14px;">接下来，我们按照功能模块分类进行分析。</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><strong><span style="font-size: 14px;">门罗币矿工</span></strong></p><p style="text-align: justify;"><span style="font-size: 14px;">如上文所述，spoolsr.exe会被注册为系统服务，服务名为“mspoolv”，其主要是用来释放运行门罗币矿工程序svchst.exe。在服务启动后，首先会结束当前环境中正在运行的svchst.exe进程（矿工进程），之后根据当前系统环境（x64或x86）对加密的门罗币矿工病毒二进制数据进行解密、释放。代码如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="1.1381909547738693" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoLaw6ZoUJRpgNZcDrn5ticuZnVZB1viaMnLxCHiaqpmqrckHjOzgOMWPWQ/640?wx_fmt=png" data-type="png" data-w="796" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">解密门罗币矿工程序</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">释放矿工病毒后，spoolsr.exe会使用当前用户权限对矿工病毒进行启动。当该病毒检测到如下进程名后，如果矿工病毒也在运行则会结束矿工病毒进程。相关代码，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img data-copyright="0" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoL2CGMsDMrcJUera4f4a1fIG24byGaHA2OcMSzIwPjf3EIWoHhALfnA/640?wx_fmt=png" data-type="png" style="" class="" data-ratio="1.4406991260923845" data-w="801"></p><p style="text-align: center;"><span style="font-size: 14px;">检测进程</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">被检测的进程名及相关代码，如下图所示：</span><br></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p><img class="" data-copyright="0" data-ratio="0.4558333333333333" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6Nzmso3kd1xsHBLEN1XhFCoThxNJKBIMyTV7ITtTd9lsl140xjbJ4etaGBow/640?wx_fmt=png" data-type="png" data-w="1200" style=""></p><p style="text-align: justify;"><span style="font-size: 14px;">进程检测代码</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">被释放的svchst.exe是一个被修改后的门罗币矿工程序，该程序被修改后只会为病毒作者挖取门罗币，且不用加入启动参数。原有矿工程序相关信息，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.7573616018845701" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoP4hTYf7Mcr32JxrOH561p8ccFs53Dj02nVsjCNHYaOaHicxhcu40X1A/640?wx_fmt=png" data-type="png" data-w="849" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">原有门罗币矿工程序相关数据</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">挖矿相关信息，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.21794871794871795" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6Nzmsofq5nNwU9HgWQCtnmVC0ibKGgkPxYnM9ib8mqxPKGL0NusvoJib15o8NlQ/640?wx_fmt=png" data-type="png" data-w="624" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">矿工信息</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><strong><span style="font-size: 14px;">流量劫持</span></strong></p><p style="text-align: justify;"><span style="font-size: 14px;">流量劫持功能如前文所述，是通过注册AppInit_DLLs实现的。在iaStorE.sys将usp20.dll注册为AppInit_DLLs后，当系统user32.dll被加载时加载指定动态库。usp20.dll的唯一功能就是在被进程加载后加载keyhook32.dll (x86版本)。</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">keyhook32.dll动态库在进程中加载后，会通过访问C&amp;C服务器地址（hxxp:// ozkngbvcs.bkt.gdipper.com/ping）获取加密的远程配置数据。当前配置数据经过解密之后，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.3986784140969163" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoUDbG5Fp6CfHPibZGP03pIE4gwcVMq8UWdiakYliaIjIGs8qv5KicB1Htiaw/640?wx_fmt=png" data-type="png" data-w="454" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">解密后的远程配置</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">如上图所示，当前从C&amp;C服务器请求到的配置信息中，仅包含由一个驱动模块的下载地址。动态库代码逻辑中还会解析包括流量劫持链接、搜索链接等配置信息，首页和搜索链接会加密后存放在注册表HKEY_LOCAL_MACHINE\ SYSTEM\Setup\Digita1ProductId11”和“HKEY_LOCAL_MACHINE\ SYSTEM\Setup\Digita1ProductId13”键值中。配置解析代码，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.5615332885003362" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoXPHb9eaGEoyUexsJPwUsia5PbcD2DbGAmWzp3IHx9CeMxfUDoB7hdrw/640?wx_fmt=png" data-type="png" data-w="1487" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">配置解析代码</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">通过远程配置信息中获取到的劫持相关内容，该动态库会hook CreateProcessInternalW函数，通过注册表“HKEY_LOCAL_MACHINE\ SYSTEM\Setup\Digita1ProductId11”和“HKEY_LOCAL_MACHINE\ SYSTEM\Setup\Digita1ProductId13”中加密的劫持数据对浏览器进程附加命令行参数，达到流量劫持目的。劫持代码如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="1.20508866615266" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoiagLPcRkXhNcp7ghDQsnNtvfIujQjP63hUkliaR7mFOmqOhF0UibwLn2g/640?wx_fmt=png" data-type="png" data-w="1297" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">劫持浏览器参数</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">除了通过修改浏览器进程启动参数进行流量劫持外，该病毒还会通过修改流量器配置的方法对一些常见的第三方浏览器进行流量劫持，受影响的浏览器包括：Chrome、Edge和Firefox。</span></p><p><br></p><p style="text-align: justify;"><strong><span style="font-size: 16px;">三、	溯源分析</span></strong></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">根据病毒所使用的签名信息，我们发现该病毒所使用的众多数字签名均为被吊销或者已经过期的国内公司数字签名。使用的数字签名不但均为被吊销的签名，且都不带有签名时间戳。我们以个别样本为例，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.8459893048128342" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoiazabGDuvmZCZjmdQUvaIEJakPocIbgv8gYkfTtzPLNFC7vkpMtkHjg/640?wx_fmt=png" data-type="png" data-w="935" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">病毒所用数字签名</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">如前文所述，该病毒流量劫持恶意行为所影响到的浏览器中，有大部分为国内软件厂商所开发的浏览器，包括：QQ浏览器、360浏览器、搜狗浏览器、UC浏览器、猎豹浏览器、百度浏览器、2345浏览器等。而且在OnlineInstaller.exe样本的资源中，显示语言为“Simplified，China”（简体中文）。如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.8245614035087719" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoTg1Z7ZpXTsS6kzgZB4iby3ypMXw4HLAAoqojG3X46v6gNkqPnlfpTmw/640?wx_fmt=png" data-type="png" data-w="285" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">资源信息</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">通过上述所有信息，我们基本可以断定该病毒作者为中国人。通过对OnlineInstaller.exe样本的追根溯源，我们找到了一个存放OnlineInstaller.exe样本的github链接（hxxps://github.com/downloadhelp/install），该链接很有可能是由病毒作者进行维护的。通过提交记录我们可以找到多个不同版本的OnlineInstaller.exe样本，根据github中显示首次提交时间我们可以推断出病毒的出现时间为2017年11月28日前后，且至今依然在持续进行更新，最近的一次更新时间为2018年3月26日。首次提交记录，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.17822736030828518" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6Nzmso5CD8zVOYiapZF28Zz0IuoMZ0kMSSfdicRAdSib6QZEg0qiaaCLxyuuHbDg/640?wx_fmt=png" data-type="png" data-w="1038" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">首次提交记录</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">最近提交记录，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.1187624750499002" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoeqtJXma61s85R3Esqpd6VcibESsmqeh71z7K65oz90vWiaibaUvGiadofQ/640?wx_fmt=png" data-type="png" data-w="1002" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">最近一次提交记录</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">通过github链接，我们找到了一个较早的OnlineInstaller.exe样本进行测试，我们发现早期版本的OnlineInstaller.exe样本运行后会显示带有“Brothersoft”字样的安装界面。早期版本安装界面，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.5588235294117647" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoOZgnoKhWedPJJC8lFgk675QQr7g8NwCuT6JFWBce76UxTJ1iabHcF2A/640?wx_fmt=png" data-type="png" data-w="476" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">安装界面</span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">通过域名信息检索，我们发现“Brothersoft”软件下载站（http://www.brothersoft.com）的注册人信息为国内互联网厂商“Kunlun Wanwei Keji Gufen Youxian Gongsi”。网站注册信息，如下图所示：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><span style="font-size: 14px;"></span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.6232638888888888" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6NzmsoYf5pV325Be2cxdQI9BSzyTQzxeEPkBXXyjRxsZR9CSrRr3dHS4srJg/640?wx_fmt=png" data-type="png" data-w="576" style=""></p><p style="text-align: center;"><span style="font-size: 14px;">Brothersoft软件下载站注册信息</span><br><span style="font-size: 14px;"></span></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">虽然该病毒系国人制造，Brothersoft.com也同为国人注册并维护，但通过现有信息并不能确认该病毒与Brothersoft.com的直接关系，也许只是巧合。</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: justify;"><br></p><p style="text-align: justify;"><strong><span style="font-size: 16px;">四、	附录</span></strong></p><p style="text-align: justify;"><span style="font-size: 14px;"><br></span></p><p style="text-align: justify;"><span style="font-size: 14px;">文中涉及样本SHA256：</span></p><p style="text-align: justify;"><span style="font-size: 14px;"> </span></p><p style="text-align: center;"><img class="" data-copyright="0" data-ratio="0.38657407407407407" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_png/0icdicRft8tz5icfLToPMFF8ViaeIx6Nzmso2AKBybVOCLbU4aOalOZam9hq5wxfVe2leajP6pylQZjcDzDYVkb6Iw/640?wx_fmt=png" data-type="png" data-w="864" style=""></p><p style="text-align: justify;"><span style="font-size: 14px;"></span><br></p><p><br></p>
                </div>
                <script nonce="448592918" type="text/javascript">
                    var first_sceen__time = (+new Date());

                    if ("" == 1 && document.getElementById('js_content')) {
                        document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });
                    }

                    
                    (function(){
                        if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                            var link = document.createElement('link');
                            var head = document.getElementsByTagName('head')[0];
                            link.rel = 'stylesheet';
                            link.type = 'text/css';
                            link.href = "//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_winwx3d171e.css";
                            head.appendChild(link);
                        }
                    })();
                </script>
                
                
                                
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display:none;"></div>

                
                                <div class="reward_area tc" id="js_preview_reward" style="display:none;">
                    <p id="js_preview_reward_wording" class="tips_global reward_tips" style="display:none;"></p>
                    <p>
                        <a class="reward_access" id="js_preview_reward_link" href="##"><span class="icon-reward"></span>赞赏</a>

                    </p>
                </div>
                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="//res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x3534dd.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div><div class="rich_media_tool" id="js_toobar3">
                
                                <p class="media_tool_meta tips_global meta_primary article_modify_tag">修改于<span id="js_modify_time"></span></p>
                                
                                            <div id="js_read_area3" class="media_tool_meta tips_global meta_primary" style="display:none;">阅读 <span id="readNum3"></span></div>

                <span style="display:none;" class="media_tool_meta meta_primary tips_global meta_praise" id="like3">
                    <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum3"></span>
                </span>

                <a id="js_report_article3" style="display:none;" class="media_tool_meta tips_global meta_extra" href="##">投诉</a>

            </div><div class="rich_media_tool" id="js_sg_bar">
                
                                <p class="media_tool_meta tips_global meta_primary article_modify_tag">修改于<span id="js_modify_time"></span></p>
                                
                                
            </div>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
