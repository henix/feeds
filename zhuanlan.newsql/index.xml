<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:media="http://search.yahoo.com/mrss/">
<channel>
<title>TiDB çš„åèŠ±å›­</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/</link>
<description></description>
<language>zh-cn</language>
<lastBuildDate>Wed, 08 Aug 2018 13:44:01 +0800</lastBuildDate>
<item>
<title>TiDB æºç é˜…è¯»ï¼ˆåäº”ï¼‰ Sort Merge Join</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-08-08-41535500.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/41535500&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-e445e0a331d683cab8f11fda36478022_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;ä½œè€…ï¼š &lt;a class=&quot;member_mention&quot; href=&quot;http://www.zhihu.com/people/5202d0b6a9c623e0674ff36891c8ab52&quot; data-hash=&quot;5202d0b6a9c623e0674ff36891c8ab52&quot; data-hovercard=&quot;p$b$5202d0b6a9c623e0674ff36891c8ab52&quot;&gt;@å§šç»´&lt;/a&gt; &lt;/p&gt;&lt;h2&gt;&lt;b&gt;ä»€ä¹ˆæ˜¯ Sort Merge Join&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;åœ¨å¼€å§‹é˜…è¯»æºç ä¹‹å‰, æˆ‘ä»¬æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯ Sort Merge Join (SMJ)ï¼Œå®šä¹‰å¯ä»¥çœ‹ &lt;a href=&quot;https://en.wikipedia.org/wiki/Sort-merge_join&quot;&gt;wikipedia&lt;/a&gt;ã€‚ç®€å•è¯´æ¥å°±æ˜¯å°† Join çš„ä¸¤ä¸ªè¡¨ï¼Œé¦–å…ˆæ ¹æ®è¿æ¥å±æ€§è¿›è¡Œæ’åºï¼Œç„¶åè¿›è¡Œä¸€æ¬¡æ‰«æå½’å¹¶, è¿›è€Œå°±å¯ä»¥å¾—å‡ºæœ€åçš„ç»“æœã€‚è¿™ä¸ªç®—æ³•æœ€å¤§çš„æ¶ˆè€—åœ¨äºå¯¹å†…å¤–è¡¨æ•°æ®è¿›è¡Œæ’åºï¼Œè€Œå½“è¿æ¥åˆ—ä¸ºç´¢å¼•åˆ—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç´¢å¼•çš„æœ‰åºæ€§é¿å…æ’åºå¸¦æ¥çš„æ¶ˆè€—, æ‰€ä»¥é€šå¸¸åœ¨æŸ¥è¯¢ä¼˜åŒ–å™¨ä¸­ï¼Œè¿æ¥åˆ—ä¸ºç´¢å¼•åˆ—çš„æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘é€‰æ‹©ä½¿ç”¨ SMJã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;TiDB Sort Merge Join å®ç°&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;&lt;b&gt;æ‰§è¡Œè¿‡ç¨‹&lt;/b&gt;&lt;/p&gt;&lt;p&gt;TiDB çš„å®ç°ä»£ç åœ¨ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/merge_join.go&quot;&gt;tidb/executor/merge_join.go&lt;/a&gt; ä¸­ &lt;code class=&quot;inline&quot;&gt;MergeJoinExec.NextChunk&lt;/code&gt; æ˜¯è¿™ä¸ªç®—å­çš„å…¥å£ã€‚ä¸‹é¢ä»¥ &lt;code class=&quot;inline&quot;&gt;SELECT * FROM A JOIN B ON A.a = B.a&lt;/code&gt; ä¸ºä¾‹ï¼Œå¯¹ SMJ æ‰§è¡Œè¿‡ç¨‹è¿›è¡Œç®€è¿°ï¼Œå‡è®¾æ­¤æ—¶å¤–è¡¨ä¸º Aï¼Œå†…è¡¨ä¸º Bï¼Œjoin-keys ä¸º aï¼ŒAï¼ŒB è¡¨çš„ a åˆ—ä¸Šéƒ½æœ‰ç´¢å¼•ï¼š&lt;/p&gt;&lt;p&gt;1.é¡ºåºè¯»å–å¤–è¡¨ A ç›´åˆ° join-keys ä¸­å‡ºç°å¦å¤–çš„å€¼ï¼ŒæŠŠç›¸åŒ keys çš„è¡Œæ”¾å…¥æ•°ç»„ a1ï¼ŒåŒæ ·çš„è§„åˆ™è¯»å–å†…è¡¨ Bï¼ŒæŠŠç›¸åŒ keys çš„è¡Œæ”¾å…¥æ•°ç»„ a2ã€‚å¦‚æœå¤–è¡¨æ•°æ®æˆ–è€…å†…è¡¨æ•°æ®è¯»å–ç»“æŸï¼Œé€€å‡ºã€‚&lt;/p&gt;&lt;p&gt;2. ä» a1 ä¸­è¯»å–å½“å‰ç¬¬ä¸€è¡Œæ•°æ®ï¼Œè®¾ä¸º v1ã€‚ä» a2 ä¸­è¯»å–å½“å‰ç¬¬ä¸€è¡Œæ•°æ®ï¼Œè®¾ä¸º v2ã€‚&lt;/p&gt;&lt;p&gt;3. æ ¹æ® join-keys æ¯”è¾ƒ v1ï¼Œv2ï¼Œç»“æœåˆ†ä¸ºå‡ ç§æƒ…å†µï¼š&lt;/p&gt;&lt;ul&gt;&lt;ul&gt;&lt;li&gt;cmpResult &amp;gt; 0, è¡¨ç¤º v1 å¤§äº v2ï¼ŒæŠŠå½“å‰ a2 çš„æ•°æ®ä¸¢å¼ƒï¼Œä»å†…è¡¨è¯»å–ä¸‹ä¸€æ‰¹æ•°æ®ï¼Œè¯»å–æ–¹æ³•åŒ 1ã€‚é‡å¤ 2ã€‚&lt;/li&gt;&lt;li&gt;cmpResult &amp;lt; 0, è¡¨ç¤º v1 å°äº v2ï¼Œè¯´æ˜å¤–è¡¨çš„ v1 æ²¡æœ‰å†…è¡¨çš„å€¼ä¸ä¹‹ç›¸åŒï¼ŒæŠŠå¤–è¡¨æ•°æ®è¾“å‡ºç»™ resultGeneratorï¼ˆä¸åŒçš„è¿æ¥ç±»å‹ä¼šæœ‰ä¸åŒçš„ç»“æœè¾“å‡ºï¼Œä¾‹å¦‚å¤–è¿æ¥ä¼šæŠŠä¸åŒ¹é…çš„å¤–è¡¨æ•°æ®è¾“å‡ºï¼‰ã€‚&lt;/li&gt;&lt;li&gt;cmpResult == 0, è¡¨ç¤º v1 ç­‰äº v2ã€‚é‚£ä¹ˆéå† a1 é‡Œé¢çš„æ•°æ®ï¼Œè·Ÿ a2 çš„æ•°æ®ï¼Œè¾“å‡ºç»™ resultGenerator ä½œä¸€æ¬¡è¿æ¥ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;p&gt;4. å›åˆ°æ­¥éª¤ 1ã€‚&lt;/p&gt;&lt;p&gt;ä¸‹é¢çš„å›¾å±•ç¤ºäº† SMJ çš„è¿‡ç¨‹ï¼š&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-b72f20067fcc79e607e567fbc8711bad_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;941&quot; data-rawheight=&quot;942&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-b72f20067fcc79e607e567fbc8711bad&quot; data-watermark-src=&quot;v2-08f69ef7725298bf5d409e0fc691037f&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;è¯»å–å†…è¡¨ / å¤–è¡¨æ•°æ®&lt;/b&gt;&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬åˆ†åˆ«é€šè¿‡ &lt;code class=&quot;inline&quot;&gt;fetchNextInnerRows&lt;/code&gt; æˆ–è€… &lt;code class=&quot;inline&quot;&gt;fetchNextOuterRows&lt;/code&gt; è¯»å–å†…è¡¨å’Œå¤–è¡¨çš„æ•°æ®ã€‚è¿™ä¸¤ä¸ªå‡½æ•°å®ç°çš„åŠŸèƒ½ç±»ä¼¼ï¼Œè¿™é‡Œåªè¯¦è¿°å‡½æ•° &lt;code class=&quot;inline&quot;&gt;fetchNextInnerRows&lt;/code&gt; çš„å®ç°ã€‚&lt;/p&gt;&lt;p&gt;&lt;code class=&quot;inline&quot;&gt;MergeSortExec&lt;/code&gt; ç®—å­è¯»å–æ•°æ®ï¼Œæ˜¯é€šè¿‡è¿­ä»£å™¨ &lt;code class=&quot;inline&quot;&gt;readerIterator&lt;/code&gt; å®Œæˆï¼Œ&lt;code class=&quot;inline&quot;&gt;readerIterator&lt;/code&gt; å¯ä»¥é¡ºåºè¯»å–æ•°æ®ã€‚&lt;code class=&quot;inline&quot;&gt;MergeSortExec&lt;/code&gt; ç®—å­ç»´æŠ¤ä¸¤ä¸ª readerIteratorï¼š&lt;code class=&quot;inline&quot;&gt;outerIter&lt;/code&gt; å’Œ &lt;code class=&quot;inline&quot;&gt;innerIter&lt;/code&gt;ï¼Œå®ƒä»¬åœ¨ &lt;code class=&quot;inline&quot;&gt;buildMergeJoin&lt;/code&gt; å‡½æ•°ä¸­è¢«æ„é€ ã€‚&lt;/p&gt;&lt;p&gt;çœŸæ­£è¯»å–æ•°æ®çš„æ“ä½œæ˜¯åœ¨ &lt;code class=&quot;inline&quot;&gt;readerIterator.nextSelectedRow&lt;/code&gt; ä¸­å®Œæˆ, è¿™é‡Œä¼šé€šè¿‡ &lt;code class=&quot;inline&quot;&gt;ri.reader.NextChunk&lt;/code&gt; æ¯æ¬¡è¯»å–ä¸€ä¸ª Chunk çš„æ•°æ®ï¼Œå…³äº Chunk çš„ç›¸å…³å†…å®¹ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘ä»¬ä¹‹å‰çš„æ–‡ç«  &lt;a href=&quot;https://pingcap.com/blog-cn/tidb-source-code-reading-10/&quot;&gt;TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆåï¼‰Chunk å’Œæ‰§è¡Œæ¡†æ¶ç®€ä»‹&lt;/a&gt; ã€‚&lt;/p&gt;&lt;p&gt;è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡ &lt;code class=&quot;inline&quot;&gt;expression.VectorizedFilter&lt;/code&gt; å¯¹å¤–è¡¨æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œè¿”å›ä¸€ä¸ª curSelected å¸ƒå°”æ•°ç»„ï¼Œç”¨äºå¤–è¡¨çš„æ¯ä¸€è¡Œæ•°æ®æ˜¯å¦æ˜¯æ»¡è¶³ filter è¿‡æ»¤æ¡ä»¶ã€‚ä»¥ &lt;code class=&quot;inline&quot;&gt;select * from t1 left outer join t2 on t1.a=100;&lt;/code&gt; ä¸ºä¾‹, è¿™é‡Œçš„ filter æ˜¯ &lt;code class=&quot;inline&quot;&gt;t1.a=100&lt;/code&gt;, å¯¹äºæ²¡æœ‰é€šè¿‡è¿™ä¸ªè¿‡æ»¤æ¡ä»¶çš„è¡Œï¼Œæˆ‘ä»¬é€šè¿‡ &lt;code class=&quot;inline&quot;&gt;ri.joinResultGenerator.emitToChunk&lt;/code&gt; å‡½æ•°å‘é€ç»™ resultGenerator, è¿™ä¸ª resultGenerator æ˜¯ä¸€ä¸ª interfaceï¼Œå…·ä½“æ˜¯å¦è¾“å‡ºè¿™è¡Œæ•°æ®ï¼Œä¼šç”± join çš„ç±»å‹å†³å®šï¼Œæ¯”å¦‚å¤–è¿æ¥åˆ™ä¼šè¾“å‡ºï¼Œå†…è¿æ¥åˆ™ä¼šå¿½ç•¥ã€‚å…·ä½“å…³äº resultGenerator, å¯ä»¥å‚è€ƒä¹‹å‰çš„æ–‡ç« ï¼š&lt;a href=&quot;https://pingcap.com/blog-cn/tidb-source-code-reading-9/&quot;&gt;TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆä¹ï¼‰Hash Join&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;code class=&quot;inline&quot;&gt;rowsWithSameKey&lt;/code&gt; é€šè¿‡ &lt;code class=&quot;inline&quot;&gt;nextSelectedRow&lt;/code&gt; ä¸æ–­è¯»å–ä¸‹ä¸€è¡Œæ•°æ®ï¼Œå¹¶é€šè¿‡å¯¹æ¯è¡Œæ•°æ®çš„ join-keys è¿›è¡Œåˆ¤æ–­æ˜¯ä¸æ˜¯å±äºåŒä¸€ä¸ª join-keysï¼Œå¦‚æœæ˜¯ï¼Œä¼šæŠŠç›¸åŒ join-keys çš„è¡Œåˆ†åˆ«æ”¾å…¥åˆ° &lt;code class=&quot;inline&quot;&gt;innerChunkRows&lt;/code&gt; å’Œ &lt;code class=&quot;inline&quot;&gt;outerIter4Row&lt;/code&gt; æ•°ç»„ä¸­ã€‚ç„¶åå¯¹å…¶åˆ†åˆ«å»ºç«‹è¿­ä»£å™¨ innerIter4Row å’Œ outerIter4Rowã€‚åœ¨ SMJ ä¸­çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šåˆ©ç”¨è¿™ä¸¤ä¸ªè¿­ä»£å™¨æ¥è·å–æ•°æ®è¿›è¡ŒçœŸæ­£çš„æ¯”è¾ƒå¾—å‡º join resultã€‚&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Merge-Join&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å®ç° Merge-Join é€»è¾‘çš„ä»£ç åœ¨å‡½æ•° &lt;code class=&quot;inline&quot;&gt;MergeJoinExec.joinToChunk&lt;/code&gt;, å¯¹å†…å¤–è¡¨è¿­ä»£å™¨çš„å½“å‰æ•°æ®æ ¹æ®å„è‡ªçš„ join-keys ä½œå¯¹æ¯”ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªç»“æœï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;cmpResult &amp;gt; 0ï¼Œä»£è¡¨å¤–è¡¨å½“å‰æ•°æ®å¤§äºå†…è¡¨æ•°æ®ï¼Œé‚£ä¹ˆé€šè¿‡ &lt;code class=&quot;inline&quot;&gt;fetchNextInnerRows&lt;/code&gt; ç›´æ¥è¯»å–ä¸‹ä¸€ä¸ªå†…è¡¨æ•°æ®ï¼Œç„¶åé‡æ–°æ¯”è¾ƒå³å¯ã€‚&lt;/li&gt;&lt;li&gt;cmpResult &amp;lt; 0ï¼Œä»£è¡¨å¤–è¡¨å½“å‰æ•°æ®å°äºå†…è¡¨æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å°±åˆ†å‡ ç§æƒ…å†µäº†ï¼Œå¦‚æœæ˜¯å¤–è¿æ¥ï¼Œé‚£ä¹ˆéœ€è¦è¾“å‡ºå¤–è¡¨æ•°æ® + NULLï¼Œå¦‚æœæ˜¯å†…è¿æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªå¤–è¡¨æ•°æ®å°±è¢«å¿½ç•¥ï¼Œå¯¹äºè¿™ä¸ªä¸åŒé€»è¾‘çš„å¤„ç†ï¼Œç»Ÿä¸€ç”± &lt;code class=&quot;inline&quot;&gt;e.resultGenerator&lt;/code&gt; æ¥æ§åˆ¶ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå¤–è¡¨æ•°æ®é€šè¿‡ &lt;code class=&quot;inline&quot;&gt;e.resultGenerator.emitToChunk&lt;/code&gt; è°ƒç”¨å®ƒå³å¯ã€‚ç„¶åé€šè¿‡ &lt;code class=&quot;inline&quot;&gt;fetchNextOuterRows&lt;/code&gt; è¯»å–ä¸‹ä¸€ä¸ªå¤–è¡¨æ•°æ®ï¼Œé‡æ–°æ¯”è¾ƒã€‚&lt;/li&gt;&lt;li&gt;cmpResult == 0ï¼Œä»£è¡¨å¤–è¡¨å½“å‰æ•°æ®ç­‰äºå†…è¡¨å½“å‰æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å°±æŠŠå¤–è¡¨æ•°æ®è·Ÿå†…è¡¨å½“å‰æ•°æ®åšä¸€æ¬¡è¿æ¥ï¼Œé€šè¿‡ &lt;code class=&quot;inline&quot;&gt;e.resultGenerator.emitToChunk&lt;/code&gt; ç”Ÿæˆç»“æœã€‚ä¹‹åå¤–è¡¨è·Ÿå†…è¡¨åˆ†åˆ«è·å–ä¸‹ä¸€ä¸ªæ•°æ®ï¼Œé‡æ–°å¼€å§‹æ¯”è¾ƒã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;é‡å¤ä¸Šé¢çš„è¿‡ç¨‹ï¼Œç›´åˆ°å¤–è¡¨æˆ–è€…å†…è¡¨æ•°æ®è¢«éå†å®Œï¼Œé€€å‡º Merge-Join çš„è¿‡ç¨‹ã€‚&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;æ›´å¤š&lt;/b&gt;&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬ä¸Šé¢çš„åˆ†æä»£ç åŸºäº &lt;a href=&quot;https://github.com/pingcap/tidb/tree/source-code&quot;&gt;Source-code&lt;/a&gt; åˆ†æ”¯ï¼Œå¯èƒ½å¤§å®¶å·²ç»å‘ç°äº†ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¼šä¸€æ¬¡æ€§è¯»å–å†…å¤–è¡¨çš„ Join groupï¼ˆç›¸åŒçš„ keyï¼‰ã€‚è¿™é‡Œå¦‚æœç›¸åŒçš„ key æ¯”è¾ƒå¤šï¼Œæ˜¯æœ‰å†…å­˜ OOM çš„é£é™©çš„ã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨æœ€æ–°çš„ master åˆ†æ”¯åšäº†å‡ ä¸ªäº‹æƒ…æ¥ä¼˜åŒ–ï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;å¤–è¡¨å…¶å®ä¸éœ€è¦æŠŠç›¸åŒçš„ keys ä¸€æ¬¡æ€§éƒ½è¯»å–ä¸Šæ¥ï¼Œ å®ƒåªéœ€è¦æŒ‰æ¬¡è¿­ä»£å¤–è¡¨æ•°æ®ï¼Œå†è·Ÿå†…è¡¨é€ä¸€å¯¹æ¯”ä½œè¿æ¥å³å¯ã€‚è¿™é‡Œè‡³å°‘å¯ä»¥å‡å°‘å¤–è¡¨å‘ç”Ÿ OOM çš„é—®é¢˜ï¼Œå¯ä»¥å¤§å¤§å‡å°‘ OOM çš„æ¦‚ç‡ã€‚&lt;/li&gt;&lt;li&gt;å¯¹äºå†…è¡¨ï¼Œæˆ‘ä»¬å¯¹ OOM ä¹Ÿä¸æ˜¯æ²¡æœ‰åŠæ³•ï¼Œæˆ‘ä»¬ç”¨ &lt;code class=&quot;inline&quot;&gt;memory.Tracker&lt;/code&gt; è¿™ä¸ªå†…å­˜è¿½è¸ªå™¨æ¥è®°å½•å½“å‰å†…è¡¨å·²ç»ä½¿ç”¨çš„ä¸­é—´ç»“æœçš„å†…å­˜å¤§å°ï¼Œå¦‚æœå®ƒè¶…è¿‡æˆ‘ä»¬è®¾ç½®çš„é˜ˆå€¼ï¼Œæˆ‘ä»¬ä¼šé‡‡å–è¾“å‡ºæ—¥å¿—æˆ–è€…ç»ˆæ­¢ SQL ç»§ç»­è¿è¡Œçš„æ–¹æ³•æ¥è§„é¿ OOM çš„å‘ç”Ÿã€‚å…³äº &lt;code class=&quot;inline&quot;&gt;memory.Tracker&lt;/code&gt; æˆ‘ä»¬ä¸åœ¨æ­¤å±•å¼€ï¼Œå¯ä»¥ç•™æ„æˆ‘ä»¬åç»­çš„æºç åˆ†ææ–‡ç« ã€‚&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;åç»­æˆ‘ä»¬è¿˜ä¼šåœ¨ Merge-Join æ–¹é¢åšä¸€äº›ä¼˜åŒ–ï¼Œ æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åšå¤šè·¯å½’å¹¶ï¼Œä¸­é—´ç»“æœå­˜å¤–å­˜ç­‰ç­‰ï¼Œæ•¬è¯·æœŸå¾…ã€‚&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-08-08-41535500</guid>
<pubDate>Wed, 08 Aug 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>30 åˆ†é’Ÿæˆä¸º TiKV Contributor</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-08-02-41103417.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/41103417&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-3e6973721ffe23e838d18d1d6cebc858_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;blockquote&gt;ä½œè€…ï¼šå´é›ªè²&lt;/blockquote&gt;&lt;h2&gt;&lt;b&gt;èƒŒæ™¯çŸ¥è¯†&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;SQL è¯­å¥å‘é€åˆ° TiDB åç»è¿‡ parser ç”Ÿæˆ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼Œå†ç»è¿‡ Query Optimizer ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œæ‰§è¡Œè®¡åˆ’åˆ‡åˆ†æˆå¾ˆå¤šå­ä»»åŠ¡ï¼Œè¿™äº›å­ä»»åŠ¡ä»¥è¡¨è¾¾å¼çš„æ–¹å¼æœ€åä¸‹æ¨åˆ°åº•å±‚çš„å„ä¸ª TiKV æ¥æ‰§è¡Œã€‚&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-d54ea1017d24caf90ab9d7f987f40fae_r.jpg&quot; data-caption=&quot;å›¾ 1&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1228&quot; data-rawheight=&quot;860&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-d54ea1017d24caf90ab9d7f987f40fae&quot; data-watermark-src=&quot;v2-d826905412f823c66e227f7c2ec3f603&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;å¦‚å›¾ 1ï¼Œå½“ TiDB æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„æŸ¥è¯¢è¯·æ±‚&lt;/p&gt;&lt;p&gt;&lt;code class=&quot;inline&quot;&gt;select count(*) from t where a + b &amp;gt; 5&lt;/code&gt;&lt;/p&gt;&lt;p&gt;æ—¶ï¼Œæ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š&lt;/p&gt;&lt;p&gt;1.TiDB å¯¹ SQL è¿›è¡Œè§£æï¼Œç»„ç»‡æˆå¯¹åº”çš„è¡¨è¾¾å¼ï¼Œä¸‹æ¨ç»™ TiKV&lt;/p&gt;&lt;p&gt;2. TiKV æ”¶åˆ°è¯·æ±‚åï¼Œå¾ªç¯ä»¥ä¸‹è¿‡ç¨‹&lt;/p&gt;&lt;ul&gt;&lt;ul&gt;&lt;li&gt;è·å–ä¸‹ä¸€è¡Œå®Œæ•´æ•°æ®ï¼Œå¹¶æŒ‰åˆ—è§£æ&lt;/li&gt;&lt;li&gt;ä½¿ç”¨å‚æ•°ä¸­çš„ where è¡¨è¾¾å¼å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤&lt;/li&gt;&lt;li&gt;è‹¥ä¸Šä¸€æ¡ä»¶ç¬¦åˆï¼Œè¿›è¡Œèšåˆè®¡ç®—&lt;/li&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;p&gt;3. TiKV å‘ TiDB è¿”å›èšåˆè®¡ç®—ç»“æœ&lt;/p&gt;&lt;p&gt;4. TiDB å¯¹æ‰€æœ‰æ¶‰åŠçš„ç»“æœè¿›è¡ŒäºŒæ¬¡èšåˆï¼Œè¿”å›ç»™å®¢æˆ·ç«¯&lt;/p&gt;&lt;p&gt;è¿™é‡Œçš„ where æ¡ä»¶ä¾¿æ˜¯ä»¥è¡¨è¾¾å¼æ ‘çš„å½¢å¼ä¸‹æ¨ç»™ TiKVã€‚åœ¨æ­¤ä¹‹å‰ TiDB åªä¼šå‘ TiKV ä¸‹æ¨ä¸€å°éƒ¨åˆ†ç®€å•çš„è¡¨è¾¾å¼ï¼Œæ¯”å¦‚å–å‡ºæŸä¸€ä¸ªåˆ—çš„æŸä¸ªæ•°æ®ç±»å‹çš„å€¼ï¼Œç®€å•æ•°æ®ç±»å‹çš„æ¯”è¾ƒæ“ä½œï¼Œç®—æœ¯è¿ç®—ç­‰ã€‚ä¸ºäº†å……åˆ†åˆ©ç”¨åˆ†å¸ƒå¼é›†ç¾¤çš„èµ„æºï¼Œè¿›ä¸€æ­¥æå‡ SQL åœ¨æ•´ä¸ªé›†ç¾¤çš„æ‰§è¡Œé€Ÿåº¦ï¼Œæˆ‘ä»¬éœ€è¦å°†æ›´å¤šç§ç±»çš„è¡¨è¾¾å¼ä¸‹æ¨åˆ° TiKV æ¥è¿è¡Œï¼Œå…¶ä¸­çš„ä¸€å¤§ç±»å°±æ˜¯ MySQL built-in å‡½æ•°ã€‚&lt;br&gt;ç›®å‰ï¼Œç”±äº TiKV çš„ built-in å‡½æ•°å°šæœªå…¨éƒ¨å®ç°ï¼Œå¯¹äºæ— æ³•ä¸‹æ¨çš„è¡¨è¾¾å¼ï¼ŒTiDB åªèƒ½è‡ªè¡Œè§£å†³ã€‚è¿™æ— ç–‘å°†æˆä¸ºæå‡ TiDB é€Ÿåº¦çš„æœ€å¤§ç»Šè„šçŸ³ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼ŒTiKV åœ¨å®ç° built-in å‡½æ•°æ—¶ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒ TiDB çš„å¯¹åº”å‡½æ•°é€»è¾‘ï¼ˆé¡ºä¾¿å¯ä»¥å¸® TiDB æ‰¾æ‰¾ Bugï¼‰ï¼Œä¸ºæˆ‘ä»¬å‡å°‘äº†ä¸å°‘å·¥ä½œé‡ã€‚&lt;/p&gt;&lt;p&gt;Built-in å‡½æ•°æ— ç–‘æ˜¯ TiDB å’Œ TiKV æˆé•¿é“è·¯ä¸Šä¸å¯æ›¿ä»£çš„ä¸€æ­¥ï¼Œå¦‚æ­¤è‰°å·¨åˆåºå¤§çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦å¹¿å¤§ç¤¾åŒºæœ‹å‹ä»¬çš„æ”¯æŒä¸é¼“åŠ±ã€‚äº²çˆ±çš„æœ‹å‹ä»¬ï¼Œæƒ³ç© Rust å—ï¼Ÿæƒ³ç»™ TiKV æ PR å—ï¼Ÿæƒ³å¸®åŠ© TiDB è·‘å¾—æ›´å¿«å—ï¼ŸåŠ¨åŠ¨æ‚¨çš„å°æ‰‹æŒ‡ï¼Œæ‹¿ PR æ¥ç ¸æˆ‘ä»¬å§ã€‚æ‚¨çš„ PR ä¸€æ—¦è¢«é‡‡ç”¨ï¼Œå°†ä¼šæœ‰å°æƒŠå–œå“¦ã€‚&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h2&gt;&lt;b&gt;æ‰‹æŠŠæ‰‹æ•™ä½ å®ç° built-in å‡½æ•°&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;&lt;b&gt;Step 1ï¼šå‡†å¤‡ä¸‹æ¨å‡½æ•°&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨ TiKV çš„ &lt;a href=&quot;https://github.com/pingcap/tikv/issues/3275&quot;&gt;https://github.com/pingcap/tikv/issues/3275&lt;/a&gt; issue ä¸­ï¼Œæ‰¾åˆ°æœªå®ç°çš„å‡½æ•°ç­¾ååˆ—è¡¨ï¼Œé€‰ä¸€ä¸ªæ‚¨æƒ³è¦å®ç°çš„å‡½æ•°ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Step 2ï¼šè·å– TiDB ä¸­å¯å‚è€ƒçš„é€»è¾‘å®ç°&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨ TiDB çš„ &lt;a href=&quot;https://github.com/pingcap/tidb/tree/master/expression&quot;&gt;expression&lt;/a&gt; ç›®å½•ä¸‹æŸ¥æ‰¾ç›¸å…³ builtinXXXSig å¯¹è±¡ï¼Œè¿™é‡Œ XXX ä¸ºæ‚¨è¦å®ç°çš„å‡½æ•°ç­¾åï¼Œæœ¬ä¾‹ä¸­ä»¥ &lt;a href=&quot;https://github.com/pingcap/tikv/pull/3277&quot;&gt;MultiplyIntUnsigned&lt;/a&gt; ä¸ºä¾‹ï¼Œå¯ä»¥åœ¨ TiDB ä¸­æ‰¾åˆ°å…¶å¯¹åº”çš„å‡½æ•°ç­¾åï¼ˆ&lt;code class=&quot;inline&quot;&gt;builtinArithmeticMultiplyIntUnsignedSig&lt;/code&gt;ï¼‰åŠ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/master/expression/builtin_arithmetic.go#L532&quot;&gt;å®ç°&lt;/a&gt;ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Step 3ï¼šç¡®å®šå‡½æ•°å®šä¹‰&lt;/b&gt;&lt;/p&gt;&lt;p&gt;1.built-in å‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶åè¦æ±‚ä¸ TiDB çš„åç§°å¯¹åº”ï¼Œå¦‚ TiDB ä¸­ï¼Œ&lt;a href=&quot;https://github.com/pingcap/tidb/tree/master/expression&quot;&gt;expression&lt;/a&gt; ç›®å½•ä¸‹çš„ä¸‹æ¨æ–‡ä»¶ç»Ÿä¸€ä»¥ builtin_XXX å‘½åï¼Œå¯¹åº”åˆ° TiKV è¿™è¾¹ï¼Œå°±æ˜¯ &lt;code class=&quot;inline&quot;&gt;builtin_XXX.rs&lt;/code&gt;ã€‚è‹¥åŒåå¯¹åº”çš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™éœ€è¦è‡ªè¡Œåœ¨åŒçº§ç›®å½•ä¸‹æ–°å»ºã€‚å¯¹äºæœ¬ä¾‹ï¼Œå½“å‰å‡½æ•°å­˜æ”¾äº TiDB çš„ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/master/expression/builtin_arithmetic.go#L532&quot;&gt;builtin_arithmetic.go&lt;/a&gt; æ–‡ä»¶é‡Œï¼Œå¯¹åº”åˆ° TiKV ä¾¿æ˜¯å­˜æ”¾åœ¨ &lt;a href=&quot;https://github.com/pingcap/tikv/blob/master/src/coprocessor/dag/expr/builtin_arithmetic.rs&quot;&gt;builtin_arithmetic.rs&lt;/a&gt; ä¸­ã€‚&lt;/p&gt;&lt;p&gt;2. å‡½æ•°åç§°ï¼šå‡½æ•°ç­¾åè½¬ä¸º Rust çš„å‡½æ•°åç§°è§„èŒƒï¼Œè¿™é‡Œ &lt;code class=&quot;inline&quot;&gt;MultiplyIntUnsigned&lt;/code&gt; å°†ä¼šè¢«å®šä¹‰ä¸º &lt;code class=&quot;inline&quot;&gt;multiply_int_unsigned&lt;/code&gt;ã€‚&lt;/p&gt;&lt;p&gt;3. å‡½æ•°è¿”å›å€¼ï¼Œå¯ä»¥å‚è€ƒ TiDB ä¸­å®ç°çš„ &lt;code class=&quot;inline&quot;&gt;Eval&lt;/code&gt; å‡½æ•°ï¼Œå¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-4fb256c456c3220224e6055ca6ab6bf6_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1158&quot; data-rawheight=&quot;838&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-4fb256c456c3220224e6055ca6ab6bf6&quot; data-watermark-src=&quot;v2-6781bac667ad6b94c4a8b7ec58af83eb&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;å¯ä»¥çœ‹åˆ° TiDB çš„ &lt;code class=&quot;inline&quot;&gt;builtinArithmeticMultiplyIntUnsignedSig&lt;/code&gt;  å¯¹è±¡å®ç°äº† evalInt æ–¹æ³•ï¼Œæ•…å½“å‰å‡½æ•°ï¼ˆ&lt;code class=&quot;inline&quot;&gt;multiply_int_unsigned&lt;/code&gt;ï¼‰çš„è¿”å›ç±»å‹åº”è¯¥ä¸º &lt;code class=&quot;inline&quot;&gt;Result&amp;lt;Option&amp;lt;i64&amp;gt;&amp;gt;&lt;/code&gt;ã€‚&lt;/p&gt;&lt;p&gt;4. å‡½æ•°çš„å‚æ•°, æ‰€æœ‰ builtin-in çš„å‚æ•°éƒ½ä¸ Expression çš„ &lt;code class=&quot;inline&quot;&gt;eval&lt;/code&gt; å‡½æ•°ä¸€è‡´ï¼Œå³ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;ç¯å¢ƒé…ç½®é‡ (ctx:&amp;amp;StatementContext)&lt;/li&gt;&lt;li&gt;è¯¥è¡Œæ•°æ®æ¯åˆ—å…·ä½“å€¼ (row:&amp;amp;[Datum])&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ç»¼ä¸Šï¼Œ&lt;code class=&quot;inline&quot;&gt;multiply_int_unsigned&lt;/code&gt; çš„ä¸‹æ¨å‡½æ•°å®šä¹‰ä¸ºï¼š&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;pub fn multiply_int_unsigned(
       &amp;amp;self,
       ctx: &amp;amp;mut EvalContext,
       row: &amp;amp;[Datum],
   ) -&amp;gt; Result&amp;lt;Option&amp;lt;i64&amp;gt;&amp;gt;&lt;/code&gt;&lt;p&gt;&lt;b&gt;Step 4ï¼šå®ç°å‡½æ•°é€»è¾‘&lt;/b&gt;&lt;/p&gt;&lt;p&gt;è¿™ä¸€å—ç›¸å¯¹ç®€å•ï¼Œç›´æ¥å¯¹ç…§ TiDB çš„ç›¸å…³é€»è¾‘å®ç°å³å¯ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° TiDB çš„ &lt;code class=&quot;inline&quot;&gt;builtinArithmeticMultiplyIntUnsignedSig&lt;/code&gt; çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;func (s *builtinArithmeticMultiplyIntUnsignedSig) evalInt(row types.Row) (val int64, isNull bool, err error) {
  a, isNull, err := s.args[0].EvalInt(s.ctx, row)
  if isNull || err != nil {
     return 0, isNull, errors.Trace(err)
  }
  unsignedA := uint64(a)
  b, isNull, err := s.args[1].EvalInt(s.ctx, row)
  if isNull || err != nil {
     return 0, isNull, errors.Trace(err)
  }
  unsignedB := uint64(b)
  result := unsignedA * unsignedB
  if unsignedA != 0 &amp;amp;&amp;amp; result/unsignedA != unsignedB {
     return 0, true, types.ErrOverflow.GenByArgs(&quot;BIGINT UNSIGNED&quot;, fmt.Sprintf(&quot;(%s * %s)&quot;, s.args[0].String(), s.args[1].String()))
  }
  return int64(result), false, nil
}&lt;/code&gt;&lt;p&gt;å‚è€ƒä»¥ä¸Šä»£ç ï¼Œç¿»è¯‘åˆ° TiKV å³å¯ï¼Œå¦‚ä¸‹ï¼š&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;pub fn multiply_int_unsigned(
       &amp;amp;self,
       ctx: &amp;amp;mut EvalContext,
       row: &amp;amp;[Datum],
   ) -&amp;gt; Result&amp;lt;Option&amp;lt;i64&amp;gt;&amp;gt; {
       let lhs = try_opt!(self.children[0].eval_int(ctx, row));
       let rhs = try_opt!(self.children[1].eval_int(ctx, row));
       let res = (lhs as u64).checked_mul(rhs as u64).map(|t| t as i64);
       // TODO: output expression in error when column&#39;s name pushed down.
       res.ok_or_else(|| Error::overflow(&quot;BIGINT UNSIGNED&quot;, &amp;amp;format!(&quot;({} * {})&quot;, lhs, rhs)))
           .map(Some)
   }&lt;/code&gt;&lt;p&gt;&lt;b&gt;Step 5ï¼šæ·»åŠ å‚æ•°æ£€æŸ¥&lt;/b&gt;&lt;/p&gt;&lt;p&gt;TiKV åœ¨æ”¶åˆ°ä¸‹æ¨è¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šå¯¹æ‰€æœ‰çš„è¡¨è¾¾å¼è¿›è¡Œæ£€æŸ¥ï¼Œè¡¨è¾¾å¼çš„å‚æ•°ä¸ªæ•°æ£€æŸ¥å°±åœ¨è¿™ä¸€æ­¥è¿›è¡Œã€‚&lt;/p&gt;&lt;p&gt;TiDB ä¸­å¯¹æ¯ä¸ª built-in å‡½æ•°çš„å‚æ•°ä¸ªæ•°æœ‰ä¸¥æ ¼çš„é™åˆ¶ï¼Œè¿™ä¸€éƒ¨åˆ†æ£€æŸ¥å¯å‚è€ƒ TiDB åŒç›®å½•ä¸‹ builtin.go ç›¸å…³ä»£ç ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ TiKV åŒçº§ç›®å½•çš„ scalar_function.rs æ–‡ä»¶é‡Œï¼Œæ‰¾åˆ° ScalarFunc çš„ check_args å‡½æ•°ï¼ŒæŒ‰ç…§ç°æœ‰çš„æ¨¡å¼ï¼ŒåŠ å…¥å‚æ•°ä¸ªæ•°çš„æ£€æŸ¥å³å¯ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Step 6ï¼šæ·»åŠ ä¸‹æ¨æ”¯æŒ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;TiKV åœ¨å¯¹ä¸€è¡Œæ•°æ®æ‰§è¡Œå…·ä½“çš„ expression æ—¶ï¼Œä¼šè°ƒç”¨ eval å‡½æ•°ï¼Œeval å‡½æ•°åˆä¼šæ ¹æ®å…·ä½“çš„è¿”å›ç±»å‹ï¼Œæ‰§è¡Œå…·ä½“çš„å­å‡½æ•°ã€‚è¿™ä¸€éƒ¨åˆ†å·¥ä½œåœ¨ scalar_function.rs ä¸­ä»¥å®ï¼ˆdispatch_callï¼‰çš„å½¢å¼å®Œæˆã€‚&lt;/p&gt;&lt;p&gt;å¯¹äº MultiplyIntUnsigned, æˆ‘ä»¬æœ€ç»ˆè¿”å›çš„æ•°æ®ç±»å‹ä¸º Intï¼Œæ‰€ä»¥å¯ä»¥åœ¨ dispatch_call ä¸­æ‰¾åˆ° INT_CALLSï¼Œç„¶åç…§ç€åŠ å…¥ MultiplyIntUnsigned =&amp;gt; multiply_int_unsigned , è¡¨ç¤ºå½“è§£æåˆ°å‡½æ•°ç­¾å MultiplyIntUnsigned æ—¶ï¼Œè°ƒç”¨ä¸Šè¿°å·²å®ç°çš„å‡½æ•° multiply_int_unsignedã€‚&lt;/p&gt;&lt;p&gt;è‡³æ­¤ MultiplyIntUnsigned ä¸‹æ¨é€»è¾‘å·²å®Œå…¨å®ç°ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Step 7ï¼šæ·»åŠ æµ‹è¯•&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨å‡½æ•° multiply_int_unsigned æ‰€åœ¨æ–‡ä»¶ &lt;a href=&quot;https://github.com/pingcap/tikv/blob/master/src/coprocessor/dag/expr/builtin_arithmetic.rs&quot;&gt;builtin_arithmetic.rs&lt;/a&gt; åº•éƒ¨çš„ test æ¨¡å—ä¸­åŠ å…¥å¯¹è¯¥å‡½æ•°ç­¾åçš„å•å…ƒæµ‹è¯•ï¼Œè¦æ±‚è¦†ç›–åˆ°ä¸Šè¿°æ·»åŠ çš„æ‰€æœ‰ä»£ç ï¼Œè¿™ä¸€éƒ¨åˆ†ä¹Ÿå¯ä»¥å‚è€ƒ TiDB ä¸­ç›¸å…³çš„æµ‹è¯•ä»£ç ã€‚æœ¬ä¾‹åœ¨ TiKV ä¸­å®ç°çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;#[test]
   fn test_multiply_int_unsigned() {
       let cases = vec![
           (Datum::I64(1), Datum::I64(2), Datum::U64(2)),
           (
               Datum::I64(i64::MIN),
               Datum::I64(1),
               Datum::U64(i64::MIN as u64),
           ),
           (
               Datum::I64(i64::MAX),
               Datum::I64(1),
               Datum::U64(i64::MAX as u64),
           ),
           (Datum::U64(u64::MAX), Datum::I64(1), Datum::U64(u64::MAX)),
       ];

       let mut ctx = EvalContext::default();
       for (left, right, exp) in cases {
           let lhs = datum_expr(left);
           let rhs = datum_expr(right);

           let mut op = Expression::build(
               &amp;amp;mut ctx,
               scalar_func_expr(ScalarFuncSig::MultiplyIntUnsigned, &amp;amp;[lhs, rhs]),
           ).unwrap();
           op.mut_tp().set_flag(types::UNSIGNED_FLAG as u32);

           let got = op.eval(&amp;amp;mut ctx, &amp;amp;[]).unwrap();
           assert_eq!(got, exp);
       }

       // test overflow
       let cases = vec![
           (Datum::I64(-1), Datum::I64(2)),
           (Datum::I64(i64::MAX), Datum::I64(i64::MAX)),
           (Datum::I64(i64::MIN), Datum::I64(i64::MIN)),
       ];

       for (left, right) in cases {
           let lhs = datum_expr(left);
           let rhs = datum_expr(right);

           let mut op = Expression::build(
               &amp;amp;mut ctx,
               scalar_func_expr(ScalarFuncSig::MultiplyIntUnsigned, &amp;amp;[lhs, rhs]),
           ).unwrap();
           op.mut_tp().set_flag(types::UNSIGNED_FLAG as u32);

           let got = op.eval(&amp;amp;mut ctx, &amp;amp;[]).unwrap_err();
           assert!(check_overflow(got).is_ok());
       }
   }&lt;/code&gt;&lt;p&gt;&lt;b&gt;Step 8ï¼šè¿è¡Œæµ‹è¯•&lt;/b&gt;&lt;/p&gt;&lt;p&gt;è¿è¡Œ make expressionï¼Œç¡®ä¿æ‰€æœ‰çš„ test case éƒ½èƒ½è·‘è¿‡ã€‚&lt;/p&gt;&lt;p&gt;å®Œæˆä»¥ä¸Šå‡ ä¸ªæ­¥éª¤ä¹‹åï¼Œå°±å¯ä»¥ç»™ TiKV é¡¹ç›®æ PR å•¦ã€‚æƒ³è¦äº†è§£æ PR çš„åŸºç¡€çŸ¥è¯†ï¼Œå°è¯•ç§»æ­¥ &lt;a href=&quot;https://pingcap.com/blog-how-to-contribute-zh&quot;&gt;æ­¤æ–‡&lt;/a&gt;ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰å¸®åŠ©ã€‚&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;i&gt;æ¬¢è¿å¤§å®¶è¸Šè·ƒè´¡çŒ®ä»£ç ï¼ŒåŠ å…¥ TiDB community ï¼&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;http://github.com/pingcap.com&quot;&gt;http://github.com/pingcap.com&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-08-02-41103417</guid>
<pubDate>Thu, 02 Aug 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>ç¤¾åŒº | å¦‚ä½•ä¼˜é›…é™è½åˆ° TiDB æ˜Ÿçƒï¼Ÿ</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-07-25-40529913.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40529913&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-74fe289237a86bdb2092bfb84524db33_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;i&gt;æåˆ°ã€Œå¼€æºé¡¹ç›® TiDBã€äººä»¬æ€»æ˜¯ä¹ æƒ¯æ€§ååº”ï¼šå®ƒåœ¨ GitHub ä¸Š Star æ•°å·²ç»è¶…è¿‡ 17000ï¼Œå¹¶æ‹¥æœ‰ 260+ ä½å…¨çƒå„åœ°çš„ Contributors ã€‚ä½†æ•°æ®æ€»å½’æ˜¯å†·å†°å†°çš„ï¼Œä¸èƒ½ç”ŸåŠ¨çš„å±•ç° TiDB ç¤¾åŒºçš„é­…åŠ›ã€‚æ‰€ä»¥ä»Šå¤©æ¨é€ä¸€ç¯‡ &lt;b&gt;TiDB contributor&lt;/b&gt;&lt;/i&gt; &lt;i&gt;&lt;b&gt;æœå·&lt;/b&gt;åŒå­¦åŠ å…¥ TiDB ç¤¾åŒºå‰åçš„ã€Œå¿ƒè·¯å†ç¨‹ã€ï¼Œä»–ä»äº²å†è€…çš„è§’åº¦å‘Šè¯‰ä½ â€”â€”&lt;/i&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;i&gt;PingCAPer å¤Ÿ nice ä¹ˆï¼Ÿ&lt;/i&gt;&lt;/li&gt;&lt;li&gt;&lt;i&gt;ç§¯æå‚ä¸ TiDB ç¤¾åŒºå¯¹è‡ªå·±çš„èƒ½åŠ›æå‡æœ‰ä½•å¸®åŠ©ï¼Ÿ&lt;/i&gt;&lt;/li&gt;&lt;li&gt;&lt;i&gt;å¦‚ä½•åœ¨ TiDB æ˜Ÿçƒä¸Šæ‰¾åˆ°æœ€é€‚åˆè‡ªå·±çš„è½ç‚¹ï¼Ÿï¼ˆ æˆ–è€…åœ¨å¤§æ ‘ä¸Šæ‰¾åˆ°è‡ªå·±æœ€æ“…é•¿çš„â€œå°æ ‘æˆâ€hhhhhhï¼‰&lt;/i&gt;&lt;/li&gt;&lt;li&gt;&lt;i&gt;&lt;b&gt;ä»¥åŠâ€¦åˆ©ç”¨å¥½ç¢ç‰‡æ—¶é—´ï¼Œä½ ä¹Ÿå¯ä»¥ä¸€å¹´ç»™ TiDB æ&lt;/b&gt;&lt;/i&gt; &lt;i&gt;&lt;b&gt;70&lt;/b&gt;&lt;/i&gt; &lt;i&gt;&lt;b&gt;ä¸ª PRï¼&lt;/b&gt;&lt;/i&gt; &lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;ğŸš€&lt;/b&gt; ä½œè€…ï¼šæœå·ï¼ŒTiDB contributor&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;æœ€è¿‘è¿™ä¸€å¹´å¤šæ–­æ–­ç»­ç»­ä¸€ç›´åœ¨å¾€ TiDB ä¸­æäº¤ä¸€äº›ä¿®æ”¹ï¼Œå‰ä¸¤å¤©çœ‹äº†ä¸€äº› GitHub  æäº¤è®°å½•ï¼Œå‘ç°ç«Ÿç„¶å·²ç»ç´¯è®¡äº† 70 æ¥ä¸ª PR äº†ã€‚è€ƒè™‘åˆ°æœ€è¿‘è¿™ä¸€å¹´åŸºæœ¬å¤„äºç–¯ç‹‚åŠ ç­çš„èŠ‚å¥ï¼Œå¦å¤–å¿™é‡Œå·é—²è¿˜åŸºæœ¬ä¸Šåˆ·å®Œäº†ä¹‹å‰åˆ—çš„åå‡ æœ¬ä¹¦çš„è¯»ä¹¦æ¸…å•ï¼Œæˆ‘è§‰å¾—è¿™ä¹Ÿç®—ä¸€ä¸ªä¸å¤§ä¸å°çš„æˆå°±å§ï¼Œå€¼å¾— mark ä¸€ä¸‹ã€‚&lt;/p&gt;&lt;p&gt;è¯è¯´å›æ¥ï¼Œè™½ç„¶æˆ‘ 17 å¹´å¹´ä¸­æ‰å¼€å§‹ç»™ TiDB æäº¤ PRï¼Œå…¶å®åœ¨ä¹‹å‰ä¸€å¹´å¤šä»¥å‰ï¼Œå¤§æ¦‚åœ¨ 2016 å¹´ 4 æœˆä»½å·¦å³, å°±å¬è¯´è¿‡ TiDB è¿™ä¸ªé¡¹ç›®äº†ã€‚å½“æ—¶æˆ‘çš„ä¸»è¦å·¥ä½œä¹Ÿæ˜¯è½¦ä¸€ä¸ª SQL æ‰§è¡Œå¼•æ“ï¼Œæ‰€ä»¥å¯¹åˆ†å¸ƒå¼æ•°æ®åº“ä¸šç•Œçš„ç›¸å…³æ–°é—»è¿˜æ˜¯æ¯”è¾ƒå…³æ³¨çš„ã€‚&lt;/p&gt;&lt;p&gt;è™½ç„¶æ•°æ®åº“æ˜¯ä¸€ä¸ªè½®å­é«˜å‘é¢†åŸŸï¼Œå„ç§è½®å­äº”èŠ±å…«é—¨ï¼Œä½†æ˜¯åœ¨å›½å†…ï¼Œæ•°æ®åº“ï¼Œç‰¹åˆ«æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“è¿™å—çš„è½®å­ï¼ŒåŸºæœ¬è¿˜æ˜¯å‡ ä¸ªå¤§å‚åœ¨è½¦ï¼Œè¦ä¹ˆä¸å¼€æºï¼Œè¦ä¹ˆå¼€æºäº†ç¤¾åŒºä¹Ÿä¸ç”šæ´»è·ƒã€‚åƒ TiDB è¿™æ ·è¦ä»å¤´è½¦ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¹¶ä¸”è¿˜æ˜¯å®Œå…¨å¼€æºçš„æ–¹å¼æ¥æï¼Œç¡®å®è®©æˆ‘å°è±¡æ·±åˆ»ã€‚åæ¥ç»„é‡Œä¸€ä¸ªå°å“¥ç¦»èŒæŠ•å¥” PingCAPï¼Œæˆ‘å€Ÿç€é¢åŸºçš„åä¹‰é™†é™†ç»­ç»­å‚åŠ äº† TiDB å‡ æ¬¡çº¿ä¸‹ Meetupï¼Œä¹Ÿç”±æ­¤è®¤è¯†äº†å¾ˆå¤š TiDB ç¤¾åŒºçš„å°ä¼™ä¼´ã€‚&lt;/p&gt;&lt;p&gt;16 å¹´åº•ä»åŒ—äº¬å›åˆ°æˆéƒ½ä»¥åï¼Œå·¥ä½œé‡å¿ƒå‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼Œä»ä¹‹å‰çš„çº¯åš infraï¼Œè½¬å˜ä¸ºæ›´å¤šåœ°è¦é¢å¯¹ä¸šåŠ¡å±‚é¢çš„éœ€æ±‚ã€‚ä¸è¿‡åšäº†å‡ å¹´ infraï¼Œè‡ªå·±æœ¬èº«å¯¹æ•°æ®åº“å†…æ ¸è¿˜æ˜¯å¾ˆæ„Ÿå…´è¶£çš„ï¼Œæ‰€ä»¥å·¥ä½œä¹‹ä½™ï¼Œå¼€å§‹ç ”ç©¶ TiDB çš„å®ç°ï¼Œå¹¶ä¸”æ­äº†ä¸€å¥— TiDBï¼Œåœ¨å¼€å‘ç¯å¢ƒé‡Œä»£æ›¿ MySQLã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒMySQL ç»è¿‡å¤šå¹´çš„å‘å±•ï¼Œå…¶ SQL è¯­æ³•æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚TiDB è™½ç„¶å…¨é¢å…¼å®¹ MySQL çš„è¯­æ³•å’Œåè®®ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰å¤ç”¨ MySQL ä»£ç ï¼Œè‚¯å®šä¸å¯èƒ½åšåˆ° 100% å…¼å®¹ï¼Œè½å®åˆ°ä¸€äº›å…·ä½“çš„è¯­å¥ä¸Šï¼Œè‚¯å®šä¼šå’Œ MySQL æœ‰ä¸€äº›åŒºåˆ«ã€‚å› ä¸ºä¹‹å‰æˆ‘ä¹Ÿä¸€ç›´åœ¨åš OLAP ç³»ç»Ÿçš„ SQL å¼•æ“çš„å¼€å‘å·¥ä½œï¼Œå¯¹è¿™ä¸€å—æ¯”è¾ƒç†Ÿæ‚‰ï¼Œåœ¨é‡åˆ°è¿™æ–¹é¢é—®é¢˜åï¼Œæ„Ÿè§‰è§£å†³èµ·æ¥ä¹Ÿå¹¶ä¸å¾ˆéº»çƒ¦ï¼Œå› æ­¤æ…¢æ…¢å¼€å§‹åœ¨è¿™ä¸ªæ–¹é¢ç»™ TiDB æä¸€äº› PRã€‚åˆ°åé¢ç†Ÿæ‚‰äº†ä»¥åï¼Œæœ‰æ—¶é—´çš„è¯ä¹Ÿä¼šåˆ° TiDB çš„ issue list ä¸Šæç›¸å…³çš„ issue è§£å†³ï¼Œä¸»è¦é›†ä¸­äº SQL Parser, è¡¨è¾¾å¼è®¡ç®—å’Œ MySQL å…¼å®¹æ€§ç­‰æ–¹é¢ã€‚æœ€è¿‘æŠ½ç©ºåœ¨åšçš„æ˜¯å’Œèšåˆå‡½æ•°ç›¸å…³çš„ä¸€äº› Featureã€‚&lt;/p&gt;&lt;p&gt;å› ä¸ºå¹³æ—¶å·¥ä½œè¿˜æ˜¯æ¯”è¾ƒå¿™ï¼ŒåŠ ç­ä¹Ÿæ˜¯å®¶å¸¸ä¾¿é¥­ï¼Œå› æ­¤ç»™ TiDB æäº¤ PRï¼Œå›å¤ Review æ„è§çš„æ—¶é—´æ®µåŸºæœ¬éƒ½é›†ä¸­åœ¨å‘¨æœ«ï¼Œæ™šä¸Šè€å©†ç¡è§‰ä»¥åï¼Œæˆ–è€…åˆä¼‘é—´éš™ã€‚è¿™æ ·æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æ—¶é—´æ®µæ¯”è¾ƒç¦»æ•£ï¼Œå¾ˆéš¾æœ‰é•¿æ—¶é—´çš„è¿è´¯æ€è€ƒçš„æ—¶é—´ã€‚å› æ­¤ç°é˜¶æ®µä¸€æ–¹é¢æˆ‘åœ¨æ PR çš„æ—¶å€™ä¼šé€‰æ‹©ä¸€äº›ç›¸å¯¹è¾ƒå°ï¼Œç‹¬ç«‹ä¸€äº›çš„ Featureã€‚&lt;b&gt;å¦ä¸€æ–¹é¢ï¼Œæˆ‘å°½é‡æŠŠå¼€å‘æ”¾åœ¨æ—¶é—´ç›¸å¯¹å……è£•çš„å‘¨æœ«ï¼ŒæŠŠæ™šä¸Šå’Œå…¶ä»–é›¶ç¢æ—¶é—´ç”¨æ¥æŸ¥çœ‹å’Œå›å¤ Review æ„è§ï¼ŒUpdate ä»£ç å’Œè·‘å›å½’æµ‹è¯•ã€‚è¿™æ ·ç®—ä¸‹æ¥ï¼Œå¹³å‡æäº¤ä¸€ä¸ª PRï¼Œç®—ä¸Šå¼€å‘ï¼Œæµ‹è¯•ï¼Œå’Œç¤¾åŒºå°ä¼™ä¼´æ²Ÿé€šï¼Œå¤§æ¦‚è¦æ¶ˆè€— 3 åˆ° 5 ä¸ªå·¥æ—¶ã€‚&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ä¸è¿‡è¿™ä¸ªæ—¶é—´æŠ•å…¥æˆ‘è§‰å¾—å€’æ˜¯éå¸¸åˆ’ç®—ï¼Œä¸€æ˜¯å› ä¸ºæˆ‘æœ¬èº«å¯¹æ•°æ®åº“å°±éå¸¸æ„Ÿå…´è¶£ï¼ŒæŠŠå‚ä¸ TiDB ç¤¾åŒºå¼€å‘å½“æˆäº†ä¸€ç§å…´è¶£ï¼Œå¯ä»¥çœ‹åšæ˜¯å·¥ä½œä¹‹ä½™çš„ä¸€ç§æ”¾æ¾ï¼ŒäºŒæ˜¯æˆ‘ä¸€ç›´åœ¨ä»äº‹æ•°æ®åº“ç›¸å…³çš„å·¥ä½œï¼ŒåŒ…æ‹¬ä¹‹å‰ OLAP SQL å¼•æ“çš„è¿è¡Œæ—¶ä¼˜åŒ–ç›¸å…³å·¥ä½œï¼Œå’Œç°åœ¨äº‘æ•°æ®åº“ç›¸å…³çš„å·¥ä½œï¼Œå…¶å®å’Œåœ¨ç¤¾åŒºæ‰€åšçš„äº‹æƒ…éƒ½æ˜¯å¯†åˆ‡ç›¸å…³çš„ã€‚æ¯”å¦‚ä¸€ä¸ª MySQL Builtin å‡½æ•°, åœ¨å„ç§æç«¯è¾“å…¥ä¸‹çš„è¡¨ç°æ˜¯æ€æ ·çš„ï¼Œæˆ–æ˜¯ SQL_MODE çš„å„ç§ç»„åˆå¯¹è¿™ä¸ª Builtin å‡½æ•°çš„è¡Œä¸ºæœ‰ä»€ä¹ˆæ ·çš„å½±å“ï¼Œè¿™äº›é—®é¢˜åœ¨å¹³æ—¶å·¥ä½œä¸­ï¼Œæˆ‘å¯èƒ½å¾ˆéš¾è€ƒè™‘å¾—éå¸¸å‘¨å…¨ï¼›ä½†æ˜¯è¦åœ¨ç¤¾åŒºä¸­æä¸€ä¸ª PR å®ç°è¿™ä¸ª Builtin å‡½æ•°ï¼Œæˆ‘å°±éå¾—æŠŠè¿™äº›é—®é¢˜è€ƒè™‘æ¸…æ¥šï¼Œå¹¶ç»å—ç¤¾åŒºå°ä¼™ä¼´å„ç§ Case çš„è½°ç‚¸è€ƒéªŒã€‚ç­‰è¿™ä¸ª PR é¡ºåˆ©è¢« Commitï¼Œè¿™äº›ç»†èŠ‚æˆ‘ä¹Ÿçƒ‚ç†Ÿäºå¿ƒäº†ã€‚&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-13d78a931d43996617464c58e89c8b85_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;2006&quot; data-rawheight=&quot;1034&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-13d78a931d43996617464c58e89c8b85&quot; data-watermark-src=&quot;v2-2370357a5b7bf01a8e24495f78b5f21b&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;è¯´åˆ°ç¤¾åŒºï¼Œæˆ‘è§‰å¾— TiDB åšå¾—ç›¸å½“ä¸é”™ã€‚ä¸€æ–¹é¢ PingCAPers éƒ½å¾ˆæ´»è·ƒï¼Œåœ¨ GitHub ä¸Šæçš„ Issue ä¸€èˆ¬å¾ˆå¿«å°±èƒ½å¾—åˆ°å›å¤, æœ‰ä»€ä¹ˆç–‘é—®é€šè¿‡ GitHub, å¾®ä¿¡ç¾¤ç”šè‡³çŸ¥ä¹æé—®ç­‰å¾ˆå¿«éƒ½èƒ½å¾—åˆ°åé¦ˆï¼›å¦ä¸€æ–¹é¢æ›´é‡è¦çš„æ˜¯åœ¨ Review PR çš„æ—¶å€™ç¤¾åŒºå°ä¼™ä¼´èƒ½ä¿æŒæ¯”è¾ƒä¸¥è°¨çš„æ€åº¦ã€‚&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å°±æˆ‘çš„ç»å†è€Œè¨€ï¼Œæˆ‘åœ¨å¼€å‘è¿‡ç¨‹ä¸­æ²¡æœ‰æ³¨æ„åˆ°çš„ä¸€äº› Corner Case å’Œç»†èŠ‚é”™è¯¯ï¼ŒåŸºæœ¬éƒ½èƒ½åœ¨ Review PR è¿‡ç¨‹è¢«ç¿»å‡ºæ¥ï¼Œè¿™ä¸ä»…éœ€è¦ Reviewer ç†æ¸…æ¥š PR å¯¹åº” Feature çš„ç›¸å…³ç»†èŠ‚ï¼Œæ„é€ å‡ºå¯èƒ½æœ‰é—®é¢˜çš„åœºæ™¯ï¼Œè¿˜éœ€è¦ Reviewer ç†è§£ PR ä½œè€…çš„å¼€å‘æ€è·¯ã€‚å…¶ä¸­éœ€è¦èŠ±è´¹çš„ç²¾åŠ›ï¼Œå¸¸å¸¸ä¸ä½äºå¼€å‘è¿™ä¸ª Feature æœ¬èº«ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªæˆ‘è§‰å¾—å¾ˆèµçš„æ–¹é¢æ˜¯ TiDB èŠ±äº†å¾ˆå¤šå¿ƒæ€æ¥æ„å»ºä» UTï¼ŒFT åˆ°é›†æˆæµ‹è¯•çš„ä¸€ç³»åˆ—æµ‹è¯•æ¡†æ¶ï¼Œè®©æˆ‘åœ¨å‚ä¸å¼€å‘å·¥ç¨‹ä¸­æ¯”è¾ƒå®¹æ˜“å¯¹è‡ªå·±å¼€å‘çš„ Feature è¿›è¡Œå„ä¸ªæ–¹ä½çš„æµ‹è¯•ï¼ŒèŠ‚çœäº†å¾ˆå¤šæ¥å›æ£è…¾çš„éº»çƒ¦ã€‚&lt;/p&gt;&lt;p&gt;æ€»çš„æ¥è¯´ï¼Œå‚ä¸ TiDB ç¤¾åŒºæ˜¯ä¸€ä»¶éå¸¸æœ‰æ„æ€çš„äº‹æƒ…ï¼Œç»™æˆ‘å¸¦æ¥å¾ˆå¤šæ”¶è·ï¼Œæˆ‘ä¹Ÿä¼šç»§ç»­å…³æ³¨ TiDB é¡¹ç›®çš„è¿›å±•ã€‚çŸ­æ—¶é—´æ¥çœ‹ï¼Œæˆ‘çš„è®¡åˆ’ä¸»è¦è¿˜æ˜¯æŠ½ç©ºå®Œæˆæ‰‹å¤´èšåˆå‡½æ•°ç›¸å…³çš„ä¸€äº› Featureï¼ŒåŒ…æ‹¬å¯¹ MySQL èšåˆå‡½æ•° STDDEVï¼ŒVARIANCE ç­‰çš„æ”¯æŒï¼Œä»¥åŠåœ¨ TiKV Coprocessor ä¾§çš„å¯¹åº”æ”¹åŠ¨ã€‚ä¹‹åï¼Œæˆ‘æ‰“ç®—çœ‹çœ‹èƒ½ä¸èƒ½å¤Ÿç»“åˆæˆ‘ä¹‹å‰åœ¨ OLAP SQL å¼•æ“çš„è¿è¡Œæ—¶ä¼˜åŒ–æ–¹é¢çš„ç»éªŒï¼Œæå‡ TiDB åœ¨ OLAP é¢†åŸŸçš„èƒ½åŠ›ã€‚ä¸è¿‡è¿™ä¸ªæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ç›®æ ‡äº†ï¼Œåˆ°æ—¶å€™è¿˜è¦å’Œç¤¾åŒºçš„å°ä¼™ä¼´å¤šå¤šè®¨è®ºã€‚&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;i&gt;&lt;b&gt;TiDB ç¤¾åŒºå¤§äº‹ä»¶&lt;/b&gt;&lt;/i&gt; &lt;/p&gt;&lt;p&gt;&lt;i&gt;TiDB TechDay2018 å³å°†äº 7 æœˆ 28 æ—¥åœ¨æ·±åœ³ä¸¾åŠï¼Œç›®å‰æŠ¥åå·²æ»¡ï¼Œæˆ‘ä»¬å‘¨å…­è§å“¦ï¼ç‚¹å‡»&lt;u&gt;&lt;a href=&quot;http://mp.weixin.qq.com/s?__biz=MzI3NDIxNTQyOQ==&amp;amp;mid=2247486395&amp;amp;idx=1&amp;amp;sn=bfa0227d14a27e02dcd0e26939125c24&amp;amp;chksm=eb162cd1dc61a5c7d6da2bc2e3dc8e6413e28c1085a69cb0518adb1dc27cd38c8bdc64ec1fbb&amp;amp;scene=21#wechat_redirect&quot;&gt;ã€è¿™é‡Œã€‘&lt;/a&gt;&lt;/u&gt;æŸ¥çœ‹æ´»åŠ¨è¯¦æƒ…ã€‚&lt;/i&gt;&lt;/p&gt;&lt;p&gt;&lt;i&gt;P.S æ¬¢è¿è¸Šè·ƒå‹¾æ­ &lt;b&gt;TiDB Robot ï¼ˆå¾®ä¿¡å·ï¼štidbaiï¼‰&lt;/b&gt;åŠ å…¥ TiDB æ˜Ÿçƒï½&lt;/i&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-84bfe17ec8227fa695e364a4815dfe35_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;3515&quot; data-rawheight=&quot;1758&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-84bfe17ec8227fa695e364a4815dfe35&quot; data-watermark-src=&quot;v2-15585058505faf294ec8f410cce97ab5&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-07-25-40529913</guid>
<pubDate>Wed, 25 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆåå››ï¼‰ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸‹ï¼‰</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-07-19-40079139.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/40079139&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-c34786efbf579d9eef6f636c5afda076_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;blockquote&gt;ä½œè€…ï¼šè°¢æµ·æ»¨&lt;/blockquote&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;åœ¨ &lt;a href=&quot;https://zhuanlan.zhihu.com/p/39139693&quot;&gt;ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰&lt;/a&gt; ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†ç»Ÿè®¡ä¿¡æ¯åŸºæœ¬æ¦‚å¿µã€TiDB çš„ç»Ÿè®¡ä¿¡æ¯æ”¶é›†/æ›´æ–°æœºåˆ¶ä»¥åŠå¦‚ä½•ç”¨ç»Ÿè®¡ä¿¡æ¯æ¥ä¼°è®¡ç®—å­ä»£ä»·ï¼Œæœ¬ç¯‡å°†ä¼šç»“åˆåŸç†ä»‹ç» TiDB çš„æºç å®ç°ã€‚&lt;/p&gt;&lt;p&gt;æ–‡å†…ä¼šå…ˆä»‹ç»ç›´æ–¹å›¾å’Œ Count-Min(CM) Sketch çš„æ•°æ®ç»“æ„ï¼Œç„¶åä»‹ç» TiDB æ˜¯å¦‚ä½•å®ç°ç»Ÿè®¡ä¿¡æ¯çš„æŸ¥è¯¢ã€æ”¶é›†ä»¥åŠæ›´æ–°çš„ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;æ•°æ®ç»“æ„å®šä¹‰&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;ç›´æ–¹å›¾çš„å®šä¹‰å¯ä»¥åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/histogram.go#L40&quot;&gt;histograms.go&lt;/a&gt; ä¸­æ‰¾åˆ°ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºæ¡¶çš„ä¸Šä¸‹ç•Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†åœ¨ &lt;a href=&quot;https://pingcap.com/blog-cn/tidb-source-code-reading-10/&quot;&gt;ã€ŠTiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆåï¼‰Chunk å’Œæ‰§è¡Œæ¡†æ¶ç®€ä»‹ã€‹&lt;/a&gt; ä¸­ä»‹ç»åˆ° Chunk æ¥å­˜å‚¨ï¼Œç›¸æ¯”äºç”¨ Datum çš„æ–¹å¼ï¼Œå¯ä»¥å‡å°‘å†…å­˜åˆ†é…å¼€é”€ã€‚&lt;/p&gt;&lt;p&gt;CM Sketch çš„å®šä¹‰å¯ä»¥åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/cmsketch.go#L31&quot;&gt;cmsketch.go&lt;/a&gt; ä¸­æ‰¾åˆ°ï¼Œæ¯”è¾ƒç®€å•ï¼ŒåŒ…å«äº† CM Sketch çš„æ ¸å¿ƒâ€”â€”äºŒç»´æ•°ç»„ &lt;code class=&quot;inline&quot;&gt;table&lt;/code&gt;ï¼Œå¹¶å­˜å‚¨äº†å…¶æ·±åº¦ä¸å®½åº¦ï¼Œä»¥åŠæ€»å…±æ’å…¥çš„å€¼çš„æ•°é‡ï¼Œå½“ç„¶è¿™äº›éƒ½å¯ä»¥ç›´æ¥ä» &lt;code class=&quot;inline&quot;&gt;table&lt;/code&gt; ä¸­å¾—åˆ°ã€‚&lt;/p&gt;&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œå¯¹åˆ—å’Œç´¢å¼•çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œåˆ†åˆ«ä½¿ç”¨äº† &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/histogram.go#L699&quot;&gt;Column&lt;/a&gt; å’Œ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/histogram.go#L773&quot;&gt;Index&lt;/a&gt; æ¥è®°å½•ï¼Œä¸»è¦åŒ…å«äº†ç›´æ–¹å›¾ï¼ŒCM Sketch ç­‰ã€‚ &lt;/p&gt;&lt;h2&gt;&lt;b&gt;ç»Ÿè®¡ä¿¡æ¯åˆ›å»º&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;åœ¨æ‰§è¡Œ analyze è¯­å¥æ—¶ï¼ŒTiDB ä¼šæ”¶é›†ç›´æ–¹å›¾å’Œ CM Sketch çš„ä¿¡æ¯ã€‚åœ¨æ‰§è¡Œ analyze å‘½ä»¤æ—¶ï¼Œä¼šå…ˆå°†éœ€è¦ analyze çš„åˆ—å’Œç´¢å¼•åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/master/plan/planbuilder.go#L609&quot;&gt;builder.go&lt;/a&gt; ä¸­åˆ‡åˆ†æˆä¸åŒçš„ä»»åŠ¡ï¼Œç„¶ååœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/executor/analyze.go#L114&quot;&gt;analyze.go&lt;/a&gt; ä¸­å°†ä»»åŠ¡ä¸‹æ¨è‡³ TiKV ä¸Šæ‰§è¡Œã€‚ç”±äºåœ¨ TiDB ä¸­ä¹ŸåŒ…å«äº† TiKV éƒ¨åˆ†çš„å®ç°ï¼Œå› æ­¤åœ¨è¿™é‡Œè¿˜æ˜¯ä¼šä»¥ TiDB çš„ä»£ç æ¥ä»‹ç»ã€‚åœ¨è¿™ä¸ªéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä¼šç€é‡ä»‹ç»ç›´æ–¹å›¾çš„åˆ›å»ºã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;åˆ—ç›´æ–¹å›¾çš„åˆ›å»º&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰ä¸­æåˆ°ï¼Œåœ¨å»ºç«‹åˆ—ç›´æ–¹å›¾çš„æ—¶å€™ï¼Œä¼šå…ˆè¿›è¡ŒæŠ½æ ·ï¼Œç„¶åå†å»ºç«‹ç›´æ–¹å›¾ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/sample.go#L113&quot;&gt;collect&lt;/a&gt; å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†è“„æ°´æ± æŠ½æ ·ç®—æ³•ï¼Œç”¨æ¥ç”Ÿæˆå‡åŒ€æŠ½æ ·é›†åˆã€‚ç”±äºå…¶åŸç†å’Œä»£ç éƒ½æ¯”è¾ƒç®€å•ï¼Œåœ¨è¿™é‡Œä¸å†ä»‹ç»ã€‚&lt;/p&gt;&lt;p&gt;é‡‡æ ·å®Œæˆåï¼Œåœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/builder.go#L97&quot;&gt;BuildColumn&lt;/a&gt; ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†åˆ—ç›´æ–¹å›¾çš„åˆ›å»ºã€‚é¦–å…ˆå°†æ ·æœ¬æ’åºï¼Œç¡®å®šæ¯ä¸ªæ¡¶çš„é«˜åº¦ï¼Œç„¶åé¡ºåºéå†æ¯ä¸ªå€¼ Vï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;å¦‚æœ V ç­‰äºä¸Šä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆæŠŠ V æ”¾åœ¨ä¸ä¸Šä¸€ä¸ªå€¼åŒä¸€ä¸ªæ¡¶é‡Œï¼Œæ— è®ºæ¡¶æ˜¯ä¸æ˜¯å·²ç»æ»¡ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯ä¸ªå€¼åªå­˜åœ¨äºä¸€ä¸ªæ¡¶ä¸­ã€‚&lt;/li&gt;&lt;li&gt;å¦‚æœä¸ç­‰äºä¸Šä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆåˆ¤æ–­å½“å‰æ¡¶æ˜¯å¦å·²ç»æ»¡ï¼Œå°±ç›´æ¥æ”¾å…¥å½“å‰æ¡¶ï¼Œå¹¶ç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/builder.go#L146&quot;&gt;updateLastBucket&lt;/a&gt; æ›´æ”¹æ¡¶çš„ä¸Šç•Œå’Œæ·±åº¦ã€‚&lt;/li&gt;&lt;li&gt;å¦åˆ™çš„è¯ï¼Œç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/builder.go#L151&quot;&gt;AppendBucket&lt;/a&gt; æ”¾å…¥ä¸€ä¸ªæ–°çš„æ¡¶ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;b&gt;ç´¢å¼•ç›´æ–¹å›¾çš„åˆ›å»º&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨å»ºç«‹ç´¢å¼•åˆ—ç›´æ–¹å›¾çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/builder.go#L24&quot;&gt;SortedBuilder&lt;/a&gt; æ¥ç»´æŠ¤å»ºç«‹ç›´æ–¹å›¾çš„ä¸­é—´çŠ¶æ€ã€‚ç”±äºä¸èƒ½äº‹å…ˆçŸ¥é“æœ‰å¤šå°‘è¡Œçš„æ•°æ®ï¼Œä¹Ÿå°±ä¸èƒ½ç¡®å®šæ¯ä¸€ä¸ªæ¡¶çš„æ·±åº¦ï¼Œä¸è¿‡ç”±äºç´¢å¼•åˆ—çš„æ•°æ®æ˜¯å·²ç»æœ‰åºçš„ï¼Œå› æ¬¡æˆ‘ä»¬åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/builder.go#L38&quot;&gt;NewSortedBuilder&lt;/a&gt; ä¸­å°†æ¯ä¸ªæ¡¶çš„åˆå§‹æ·±åº¦è®¾ä¸º 1ã€‚å¯¹äºæ¯ä¸€ä¸ªæ•°æ®ï¼Œ&lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/builder.go#L50&quot;&gt;Iterate&lt;/a&gt; ä¼šä½¿ç”¨å»ºç«‹åˆ—ç›´æ–¹å›¾æ—¶ç±»ä¼¼çš„æ–¹æ³•æ’å…¥æ•°æ®ã€‚å¦‚æœåœ¨æŸä¸€æ—¶åˆ»ï¼Œæ‰€éœ€æ¡¶çš„ä¸ªæ•°è¶…è¿‡äº†å½“å‰æ¡¶æ·±åº¦ï¼Œé‚£ä¹ˆç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/builder.go#L74&quot;&gt;mergeBucket&lt;/a&gt; å°†ä¹‹å‰çš„æ¯ä¸¤ä¸ªæ¡¶åˆå¹¶ä¸º 1 ä¸ªï¼Œå¹¶å°†æ¡¶æ·±æ‰©å¤§ä¸€å€ï¼Œç„¶åç»§ç»­æ’å…¥ã€‚&lt;/p&gt;&lt;p&gt;åœ¨æ”¶é›†äº†æ¯ä¸€ä¸ª Region ä¸Šåˆ†åˆ«å»ºç«‹çš„ç›´æ–¹å›¾åï¼Œè¿˜éœ€è¦ç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/histogram.go#L609&quot;&gt;MergeHistogram&lt;/a&gt; æŠŠæ¯ä¸ª Region ä¸Šçš„ç›´æ–¹å›¾è¿›è¡Œåˆå¹¶ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;ä¸ºäº†ä¿è¯æ¯ä¸ªå€¼åªåœ¨ä¸€ä¸ªæ¡¶ä¸­ï¼Œæˆ‘ä»¬å¤„ç†äº†å¤„ç†ä¸€ä¸‹äº¤ç•Œå¤„æ¡¶çš„é—®é¢˜ï¼Œå³å¦‚æœäº¤ç•Œå¤„ä¸¤ä¸ªæ¡¶çš„ä¸Šç•Œå’Œä¸‹ç•Œ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/histogram.go#L623&quot;&gt;ç›¸ç­‰&lt;/a&gt;ï¼Œé‚£ä¹ˆéœ€è¦å…ˆåˆå¹¶è¿™ä¸¤ä¸ªæ¡¶ï¼›&lt;/li&gt;&lt;li&gt;åœ¨çœŸæ­£åˆå¹¶å‰ï¼Œæˆ‘ä»¬åˆ†åˆ«å°†ä¸¤ä¸ªç›´æ–¹å›¾çš„å¹³å‡æ¡¶æ·± &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/histogram.go#L642&quot;&gt;è°ƒæ•´&lt;/a&gt; è‡³å¤§è‡´ç›¸ç­‰ï¼›&lt;/li&gt;&lt;li&gt;å¦‚æœç›´æ–¹å›¾åˆå¹¶ä¹‹åæ¡¶çš„ä¸ªæ•°è¶…è¿‡äº†é™åˆ¶ï¼Œé‚£ä¹ˆæŠŠä¸¤ä¸¤ç›¸é‚»çš„æ¡¶ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/histogram.go#L653&quot;&gt;åˆäºŒä¸ºä¸€&lt;/a&gt;ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;&lt;b&gt;ç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;åœ¨ &lt;a href=&quot;https://pingcap.com/blog-cn/tidb-source-code-reading-12/&quot;&gt;ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰&lt;/a&gt; ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº† TiDB æ˜¯å¦‚ä½•æ›´æ–°ç›´æ–¹å›¾å’Œ CM Sketch çš„ã€‚å¯¹äº CM Sketch å…¶æ›´æ–°æ¯”è¾ƒç®€å•ï¼Œåœ¨è¿™é‡Œä¸å†ä»‹ç»ã€‚è¿™ä¸ªéƒ¨åˆ†ä¸»è¦ä»‹ç»ä¸€ä¸‹ TiDB æ˜¯å¦‚ä½•æ”¶é›†åé¦ˆä¿¡æ¯å’Œç»´æŠ¤ç›´æ–¹å›¾çš„ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;åé¦ˆä¿¡æ¯çš„æ”¶é›†&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰ä¸­æåˆ°ï¼Œä¸ºäº†ä¸å»å‡è®¾æ‰€æœ‰æ¡¶è´¡çŒ®çš„è¯¯å·®éƒ½æ˜¯å‡åŒ€çš„ï¼Œéœ€è¦æ”¶é›†æ¯ä¸€ä¸ªæ¡¶çš„åé¦ˆä¿¡æ¯ï¼Œå› æ­¤éœ€è¦å…ˆæŠŠæŸ¥è¯¢çš„èŒƒå›´æŒ‰ç…§ç›´æ–¹å›¾æ¡¶çš„è¾¹ç•Œåˆ‡åˆ†æˆä¸ç›¸äº¤çš„éƒ¨åˆ†ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/histogram.go#L511&quot;&gt;SplitRange&lt;/a&gt; ä¸­ï¼Œæˆ‘ä»¬æŒ‰ç…§ç›´æ–¹å›¾å»åˆ‡åˆ†æŸ¥è¯¢çš„èŒƒå›´ã€‚ç”±äºç›®å‰ç›´æ–¹å›¾ä¸­çš„ä¸€ä¸ªæ¡¶ä¼šåŒ…å«ä¸Šä¸‹ç•Œï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡ŒåªæŒ‰ç…§ä¸Šç•Œå»åˆ’åˆ†ï¼Œå³è¿™é‡Œå°†ç¬¬ i ä¸ªæ¡¶çš„èŒƒå›´çœ‹åš &lt;code class=&quot;inline&quot;&gt;(i-1 æ¡¶çš„ä¸Šç•Œï¼Œi æ¡¶çš„ä¸Šç•Œ]&lt;/code&gt;ã€‚ç‰¹åˆ«çš„ï¼Œå¯¹äºæœ€åä¸€ä¸ªæ¡¶ï¼Œå°†å…¶çš„ä¸Šç•Œè§†ä¸ºæ— ç©·å¤§ã€‚æ¯”æ–¹è¯´ä¸€ä¸ªç›´æ–¹å›¾åŒ…å« ï¼“ ä¸ªæ¡¶ï¼ŒèŒƒå›´åˆ†åˆ«æ˜¯: [2ï¼Œ5]ï¼Œ[8ï¼Œ8]ï¼Œ[10ï¼Œ13]ï¼ŒæŸ¥è¯¢çš„èŒƒå›´æ˜¯ (3ï¼Œ20]ï¼Œé‚£ä¹ˆæœ€ç»ˆåˆ‡åˆ†å¾—åˆ°çš„æŸ¥è¯¢èŒƒå›´å°±æ˜¯ (3ï¼Œ5]ï¼Œ(5ï¼Œ8]ï¼Œ(8ï¼Œ20]ã€‚&lt;/p&gt;&lt;p&gt;å°†æŸ¥è¯¢èŒƒå›´åˆ‡åˆ†å¥½åï¼Œä¼šè¢«å­˜æ”¾åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L49&quot;&gt;QueryFeedback&lt;/a&gt; ä¸­ï¼Œä»¥ä¾¿åœ¨æ¯ä¸ª Region çš„ç»“æœè¿”å›æ—¶ï¼Œè°ƒç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L165&quot;&gt;Update&lt;/a&gt; å‡½æ•°æ¥æ›´æ–°æ¯ä¸ªèŒƒå›´æ‰€åŒ…å«çš„ key æ•°ç›®ã€‚æ³¨æ„åˆ°è¿™ä¸ªå‡½æ•°éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼šæ¯ä¸ª Region ä¸Šæ‰«æçš„ start key ä»¥åŠ Region ä¸Šæ¯ä¸€ä¸ªæ‰«æèŒƒå›´è¾“å‡ºçš„ key æ•°ç›® output countsï¼Œé‚£ä¹ˆè¦å¦‚ä½•æ›´æ–° &lt;code class=&quot;inline&quot;&gt;QueryFeedback&lt;/code&gt; ä¸­æ¯ä¸ªèŒƒå›´åŒ…å«çš„ key çš„æ•°ç›®å‘¢ï¼Ÿ&lt;/p&gt;&lt;p&gt;ç»§ç»­ä»¥åˆ’åˆ†å¥½çš„ (3ï¼Œ5]ï¼Œ(5ï¼Œ8]ï¼Œ(8ï¼Œ20] ä¸ºä¾‹ï¼Œå‡è®¾è¿™ä¸ªè¯·æ±‚éœ€è¦å‘é€åˆ°ä¸¤ä¸ª region ä¸Šï¼Œregion1 çš„èŒƒå›´æ˜¯ [0ï¼Œ6)ï¼Œregion2 çš„èŒƒå›´æ˜¯ [6ï¼Œ30)ï¼Œç”±äº coprocessor åœ¨å‘è¯·æ±‚çš„æ—¶å€™è¿˜ä¼šæ ¹æ® Region çš„èŒƒå›´åˆ‡åˆ† rangeï¼Œå› æ­¤ region1 çš„è¯·æ±‚èŒƒå›´æ˜¯ (3ï¼Œ5]ï¼Œ(5ï¼Œ6)ï¼Œregion2 çš„è¯·æ±‚èŒƒå›´æ˜¯ [6ï¼Œ8]ï¼Œ(8ï¼Œ20]ã€‚ä¸ºäº†å°†å¯¹åº”çš„ key æ•°ç›®æ›´æ–°åˆ° &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L49&quot;&gt;QueryFeedback&lt;/a&gt; ä¸­ï¼Œéœ€è¦çŸ¥é“æ¯ä¸€ä¸ª output count å¯¹åº”çš„æŸ¥è¯¢èŒƒå›´ã€‚æ³¨æ„åˆ° coprocessor è¿”å›çš„ output counts å…¶å¯¹åº”çš„ Range éƒ½æ˜¯è¿ç»­çš„ï¼Œå¹¶ä¸”åŒä¸€ä¸ªå€¼åªä¼šå¯¹åº”ä¸€ä¸ª rangeï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦çŸ¥é“ç¬¬ä¸€ä¸ª output count æ‰€å¯¹åº”çš„ rangeï¼Œå³åªéœ€è¦çŸ¥é“è¿™æ¬¡æ‰«æçš„ start key å°±å¯ä»¥äº†ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äº region1 æ¥è¯´ï¼Œstart key æ˜¯ 3ï¼Œé‚£ä¹ˆ output counts å¯¹åº”çš„ range å°±æ˜¯ (3ï¼Œ5]ï¼Œ(5ï¼Œ8]ï¼Œå¯¹ region2 æ¥è¯´ï¼Œstart key æ˜¯ 6ï¼Œoutput countshangyipians å¯¹åº”çš„ range å°±æ˜¯ (5ï¼Œ8]ï¼Œ(8ï¼Œ20]ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;ç›´æ–¹å›¾çš„æ›´æ–°&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨æ”¶é›†äº† &lt;code class=&quot;inline&quot;&gt;QueryFeedback&lt;/code&gt; åï¼Œæˆ‘ä»¬å°±å¯ä»¥å»ä½¿ç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L536&quot;&gt;UpdateHistogram&lt;/a&gt; æ¥æ›´æ–°ç›´æ–¹å›¾äº†ã€‚å…¶å¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸ºåˆ†è£‚ä¸åˆå¹¶ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L503&quot;&gt;splitBuckets&lt;/a&gt; ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ç›´æ–¹å›¾çš„åˆ†è£‚ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;é¦–å…ˆï¼Œç”±äºæ¡¶ä¸æ¡¶ä¹‹é—´çš„åé¦ˆä¿¡æ¯ä¸ç›¸å…³ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œå…ˆå°† &lt;code class=&quot;inline&quot;&gt;QueryFeedback&lt;/code&gt; ç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L504&quot;&gt;buildBucketFeedback&lt;/a&gt; æ‹†åˆ†äº†æ¯ä¸€ä¸ªæ¡¶çš„åé¦ˆä¿¡æ¯ï¼Œå¹¶å­˜æ”¾åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L213&quot;&gt;BucketFeedback&lt;/a&gt; ä¸­ã€‚&lt;/li&gt;&lt;li&gt;æ¥ç€ï¼Œä½¿ç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L507&quot;&gt;getSplitCount&lt;/a&gt; æ¥æ ¹æ®å¯ç”¨çš„æ¡¶çš„ä¸ªæ•°å’Œåé¦ˆä¿¡æ¯çš„æ€»æ•°æ¥å†³å®šåˆ†è£‚çš„æ•°ç›®ã€‚&lt;/li&gt;&lt;li&gt;å¯¹äºæ¯ä¸€ä¸ªæ¡¶ï¼Œå°†å¯ä»¥åˆ†è£‚çš„æ¡¶æŒ‰ç…§åé¦ˆä¿¡æ¯æ•°ç›®çš„æ¯”ä¾‹å‡åˆ†ï¼Œç„¶åç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L312&quot;&gt;splitBucket&lt;/a&gt; æ¥åˆ†è£‚å‡ºéœ€è¦çš„æ¡¶çš„æ•°ç›®ï¼š&lt;/li&gt;&lt;li&gt;é¦–å…ˆï¼Œ&lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L312&quot;&gt;getBoundaries&lt;/a&gt; ä¼šæ¯éš”å‡ ä¸ªç‚¹å–ä¸€ä¸ªä½œä¸ºè¾¹ç•Œï¼Œå¾—åˆ°æ–°çš„æ¡¶ã€‚&lt;/li&gt;&lt;li&gt;ç„¶åï¼Œå¯¹äºæ¯ä¸€ä¸ªæ¡¶ï¼Œ&lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L32%201&quot;&gt;refineBucketCount&lt;/a&gt; ç”¨ä¸æ–°ç”Ÿæˆçš„æ¡¶é‡åˆéƒ¨åˆ†æœ€å¤šçš„åé¦ˆä¿¡æ¯æ›´æ–°æ¡¶çš„æ·±åº¦ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨åˆ†è£‚çš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªæ¡¶è¿‡å°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡¶ä¸ä¼šè¢«åˆ†è£‚ï¼›å¦‚æœä¸€ä¸ªåˆ†è£‚åç”Ÿæˆçš„æ¡¶è¿‡å°ï¼Œé‚£ä¹ˆå®ƒä¹Ÿä¸ä¼šè¢«ç”Ÿæˆã€‚&lt;/p&gt;&lt;p&gt;åœ¨æ¡¶çš„åˆ†è£‚å®Œæˆåï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L467&quot;&gt;mergeBuckets&lt;/a&gt; æ¥åˆå¹¶æ¡¶ï¼Œå¯¹äºé‚£äº›è¶…è¿‡ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;åœ¨åˆ†è£‚çš„æ—¶å€™ï¼Œä¼šè®°å½•æ¯ä¸€ä¸ªæ¡¶æ˜¯ä¸æ˜¯æ–°ç”Ÿæˆçš„ï¼Œè¿™æ ·ï¼Œå¯¹äºåŸå…ˆå°±å­˜åœ¨çš„æ¡¶ï¼Œç”¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/feedback.go#L476&quot;&gt;getBucketScore&lt;/a&gt; è®¡ç®—åˆå¹¶çš„ä¹‹åäº§ç”Ÿçš„è¯¯å·®ï¼Œä»¤ç¬¬ä¸€ä¸ªæ¡¶å åˆå¹¶åæ¡¶çš„æ¯”ä¾‹ä¸º rï¼Œé‚£ä¹ˆä»¤åˆå¹¶åäº§ç”Ÿçš„è¯¯å·®ä¸º absï¼ˆåˆå¹¶å‰ç¬¬ä¸€ä¸ªæ¡¶çš„é«˜åº¦ - r * ä¸¤ä¸ªæ¡¶çš„é«˜åº¦å’Œï¼‰/ åˆå¹¶å‰ç¬¬ä¸€ä¸ªæ¡¶çš„é«˜åº¦ã€‚&lt;/li&gt;&lt;li&gt;æ¥ç€ï¼Œå¯¹æ¯ä¸€æ¡¶çš„åˆå¹¶çš„è¯¯å·®è¿›è¡Œæ’åºã€‚&lt;/li&gt;&lt;li&gt;æœ€åï¼ŒæŒ‰ç…§åˆå¹¶çš„è¯¯å·®ä»ä¸‹åˆ°å¤§çš„é¡ºåºï¼Œåˆå¹¶éœ€è¦çš„æ¡¶ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;&lt;b&gt;ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;åœ¨æŸ¥è¯¢è¯­å¥ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šä½¿ç”¨ä¸€äº›è¿‡æ»¤æ¡ä»¶ï¼Œè€Œç»Ÿè®¡ä¿¡æ¯ä¼°ç®—çš„ä¸»è¦ä½œç”¨å°±æ˜¯ä¼°è®¡ç»è¿‡è¿™äº›è¿‡æ»¤æ¡ä»¶åçš„æ•°æ®æ¡æ•°ï¼Œä»¥ä¾¿ä¼˜åŒ–å™¨é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚&lt;/p&gt;&lt;p&gt;ç”±äºåœ¨å•åˆ—ä¸Šçš„æŸ¥è¯¢æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œä»£ç åŸºæœ¬æ˜¯æŒ‰ç…§ &lt;a href=&quot;https://pingcap.com/blog-cn/tidb-source-code-reading-12/&quot;&gt;ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰&lt;/a&gt; ä¸­çš„åŸç†å®ç°ï¼Œæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/histogram.go#L408&quot;&gt;histogram.go/lessRowCount&lt;/a&gt;  ä»¥åŠ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/cmsketch.go#L69&quot;&gt;cmsketch.go/queryValue&lt;/a&gt;ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;å¤šåˆ—æŸ¥è¯¢&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰ä¸­æåˆ°ï¼Œ&lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/selectivity.go#L148&quot;&gt;Selectivity&lt;/a&gt; æ˜¯ç»Ÿè®¡ä¿¡æ¯æ¨¡å—å¯¹ä¼˜åŒ–å™¨æä¾›çš„æœ€é‡è¦çš„æ¥å£ï¼Œå¤„ç†äº†å¤šåˆ—æŸ¥è¯¢çš„æƒ…å†µã€‚Selectivity çš„ä¸€ä¸ªæœ€é‡è¦çš„ä»»åŠ¡å°±æ˜¯å°†æ‰€æœ‰çš„æŸ¥è¯¢æ¡ä»¶åˆ†æˆå°½é‡å°‘çš„ç»„ï¼Œä½¿å¾—æ¯ä¸€ç»„ä¸­çš„æ¡ä»¶éƒ½å¯ä»¥ç”¨æŸä¸€åˆ—æˆ–è€…æŸä¸€ç´¢å¼•ä¸Šçš„ç»Ÿè®¡ä¿¡æ¯è¿›è¡Œä¼°è®¡ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åšå°½é‡å°‘çš„ç‹¬ç«‹æ€§å‡è®¾ã€‚&lt;/p&gt;&lt;p&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å°†å•åˆ—çš„ç»Ÿè®¡ä¿¡æ¯åˆ†ä¸º 3 ç±»ï¼š&lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/selectivity.go#L42&quot;&gt;indexType&lt;/a&gt; å³ç´¢å¼•åˆ—ï¼Œ&lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/selectivity.go#L43&quot;&gt;pkType&lt;/a&gt; å³ Int ç±»å‹çš„ä¸»é”®ï¼Œ&lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/selectivity.go#L44&quot;&gt;colType&lt;/a&gt; å³æ™®é€šçš„åˆ—ç±»å‹ï¼Œå¦‚æœä¸€ä¸ªæ¡ä»¶å¯ä»¥åŒæ—¶è¢«å¤šç§ç±»å‹çš„ç»Ÿè®¡ä¿¡æ¯è¦†ç›–ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼˜å…ˆä¼šé€‰æ‹© pkType æˆ–è€… indexTypeã€‚&lt;/p&gt;&lt;p&gt;åœ¨ Selectivity ä¸­ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/selectivity.go#L230&quot;&gt;getMaskAndRange&lt;/a&gt; ä¸ºæ¯ä¸€åˆ—å’Œæ¯ä¸€ä¸ªç´¢å¼•è®¡ç®—äº†å¯ä»¥è¦†ç›–çš„è¿‡æ»¤æ¡ä»¶ï¼Œç”¨ä¸€ä¸ª int64 æ¥å½“åšä¸€ä¸ª bitsetï¼Œå¹¶æŠŠå°†è¯¥åˆ—å¯ä»¥è¦†ç›–çš„è¿‡æ»¤æ¡ä»¶çš„ä½ç½®ç½®ä¸º 1ã€‚&lt;/li&gt;&lt;li&gt;æ¥ä¸‹æ¥åœ¨ &lt;a href=&quot;https://github.com/lamxTyler/tidb/blob/source-code/statistics/selectivity.go#L258&quot;&gt;getUsableSetsByGreedy&lt;/a&gt; ä¸­ï¼Œé€‰æ‹©å°½é‡å°‘çš„ bitsetï¼Œæ¥è¦†ç›–å°½é‡å¤šçš„è¿‡æ»¤æ¡ä»¶ã€‚æ¯ä¸€æ¬¡åœ¨è¿˜æ²¡æœ‰ä½¿ç”¨çš„ bitset ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªå¯ä»¥è¦†ç›–æœ€å¤šå°šæœªè¦†ç›–çš„è¿‡æ»¤æ¡ä»¶ã€‚å¹¶ä¸”å¦‚æœå¯ä»¥è¦†ç›–åŒæ ·å¤šçš„è¿‡æ»¤æ¡ä»¶ï¼Œæˆ‘ä»¬ä¼šä¼˜å…ˆé€‰æ‹© pkType æˆ–è€… indexTypeã€‚&lt;/li&gt;&lt;li&gt;ç”¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰æåˆ°çš„æ–¹æ³•å¯¹æ¯ä¸€ä¸ªåˆ—å’Œæ¯ä¸€ä¸ªç´¢å¼•ä¸Šçš„ç»Ÿè®¡ä¿¡æ¯è¿›è¡Œä¼°è®¡ï¼Œå¹¶ç”¨ç‹¬ç«‹æ€§å‡è®¾å°†å®ƒä»¬ç»„åˆèµ·æ¥å½“åšæœ€ç»ˆçš„ç»“æœã€‚&lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;&lt;b&gt;æ€»ç»“&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;ç»Ÿè®¡ä¿¡æ¯çš„æ”¶é›†å’Œç»´æŠ¤æ˜¯æ•°æ®åº“çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå¯¹äºåŸºäºä»£ä»·çš„æŸ¥è¯¢ä¼˜åŒ–å™¨ï¼Œç»Ÿè®¡ä¿¡æ¯çš„å‡†ç¡®æ€§ç›´æ¥å½±å“äº†æŸ¥è¯¢æ•ˆç‡ã€‚åœ¨åˆ†å¸ƒå¼æ•°æ®åº“ä¸­ï¼Œæ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’Œå•æœºå·®åˆ«ä¸å¤§ï¼Œä½†æ˜¯ç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯æœ‰æ¯”è¾ƒå¤§çš„æŒ‘æˆ˜ï¼Œæ¯”å¦‚æ€æ ·åœ¨å¤šèŠ‚ç‚¹æ›´æ–°çš„æƒ…å†µä¸‹ï¼Œå‡†ç¡®åŠæ—¶çš„ç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯ã€‚&lt;/p&gt;&lt;p&gt;å¯¹äºç›´æ–¹å›¾çš„åŠ¨æ€æ›´æ–°ï¼Œä¸šç•Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;å¯¹äºæ¯ä¸€æ¬¡å¢åˆ ï¼Œéƒ½å»æ›´æ–°å¯¹åº”çš„æ¡¶æ·±ã€‚åœ¨ä¸€ä¸ªæ¡¶çš„æ¡¶æ·±è¿‡é«˜çš„æ—¶å€™åˆ†è£‚æ¡¶ï¼Œä¸€èˆ¬æ˜¯æŠŠæ¡¶çš„å®½åº¦ç­‰åˆ†ï¼Œä¸è¿‡è¿™æ ·å¾ˆéš¾å‡†ç¡®çš„ç¡®å®šåˆ†ç•Œç‚¹ï¼Œå¼•èµ·è¯¯å·®ã€‚&lt;/li&gt;&lt;li&gt;ä½¿ç”¨æŸ¥è¯¢å¾—åˆ°çš„çœŸå®æ•°å»åé¦ˆè°ƒæ•´ç›´æ–¹å›¾ï¼Œå‡å®šæ‰€æœ‰æ¡¶è´¡çŒ®çš„è¯¯å·®éƒ½æ˜¯å‡åŒ€çš„ï¼Œç”¨è¿ç»­å€¼å‡è®¾å»è°ƒæ•´æ‰€æœ‰æ¶‰åŠåˆ°çš„æ¡¶ã€‚ç„¶è€Œè¯¯å·®å‡åŒ€çš„å‡è®¾å¸¸å¸¸ä¼šå¼•èµ·é—®é¢˜ï¼Œæ¯”å¦‚å½“å½“æ–°æ’å…¥çš„å€¼å¤§äºç›´æ–¹å›¾çš„æœ€å¤§å€¼æ—¶ï¼Œå°±ä¼šæŠŠæ–°æ’å…¥çš„å€¼å¼•èµ·çš„è¯¯å·®åˆ†æ‘Šåˆ°ç›´æ–¹å›¾ä¸­ï¼Œä»è€Œå¼•èµ·è¯¯å·®ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ç›®å‰ TiDB çš„ç»Ÿè®¡ä¿¡æ¯è¿˜æ˜¯ä»¥å•åˆ—çš„ç»Ÿè®¡ä¿¡æ¯ä¸ºä¸»ï¼Œä¸ºäº†å‡å°‘ç‹¬ç«‹æ€§å‡è®¾çš„ä½¿ç”¨ï¼Œåœ¨å°†æ¥ TiDB ä¼šæ¢ç´¢å¤šåˆ—ç»Ÿè®¡ä¿¡æ¯çš„æ”¶é›†å’Œç»´æŠ¤ï¼Œä¸ºä¼˜åŒ–å™¨æä¾›æ›´å‡†ç¡®çš„ç»Ÿè®¡ä¿¡æ¯ã€‚&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼š&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/39649659&quot;&gt;ï¼ˆåä¸‰ï¼‰ç´¢å¼•èŒƒå›´è®¡ç®—ç®€ä»‹&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/39139693&quot;&gt;ï¼ˆåäºŒï¼‰ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38572730&quot;&gt;ï¼ˆåä¸€ï¼‰Index Lookup Join&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38095421&quot;&gt;ï¼ˆåï¼‰Chunk å’Œæ‰§è¡Œæ¡†æ¶ç®€ä»‹&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/37773956&quot;&gt;ï¼ˆä¹ï¼‰Hash Join&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/36420449&quot;&gt;ï¼ˆå…«ï¼‰åŸºäºä»£ä»·çš„ä¼˜åŒ–&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/35511864&quot;&gt;ï¼ˆä¸ƒï¼‰åŸºäºè§„åˆ™çš„ä¼˜åŒ–&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/35134962&quot;&gt;ï¼ˆå…­ï¼‰Select è¯­å¥æ¦‚è§ˆ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34770765&quot;&gt;ï¼ˆäº”ï¼‰TiDB SQL Parser çš„å®ç°&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34512827&quot;&gt;ï¼ˆå››ï¼‰Insert è¯­å¥æ¦‚è§ˆ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34369624&quot;&gt;ï¼ˆä¸‰ï¼‰SQL çš„ä¸€ç”Ÿ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34176614&quot;&gt;ï¼ˆäºŒï¼‰åˆè¯† TiDB æºç &lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34109413&quot;&gt;ï¼ˆä¸€ï¼‰åº&lt;/a&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-07-19-40079139</guid>
<pubDate>Thu, 19 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>é‚€è¯·å‡½ | TiDB TechDay2018 æˆ‘ä»¬åœ¨æ·±åœ³ç­‰ä½ </title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-07-17-39909349.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/39909349&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-9c5c16735754d909c3d8e9f011d55d3c_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;i&gt;&lt;b&gt;7 æœˆ 28 æ—¥ï¼Œç¬¬äºŒå±Š TiDB TechDay å³å°†è½åœ°æ·±åœ³ã€‚&lt;/b&gt;æˆ‘ä»¬å‡†å¤‡äº†å¹²è´§ Talkã€ç¾é£Ÿå’Œä½ ä»¬å¿ƒå¿ƒå¿µå¿µçš„ T æ¤ã€è´´çº¸â€¦â€¦æƒ³å’Œä½ ä¸€èµ·èŠèŠæŠ€æœ¯ï¼Œåƒåƒå–å–ï¼Œè°ˆè°ˆæƒ…é¢é¢åŸº&lt;/i&gt;ã€‚&lt;/p&gt;&lt;p&gt;è‡ªç”±è½¯ä»¶ä¹‹çˆ¶ Richard Matthew Stallman æ›¾è¯´è¿‡ï¼šâ€œå¦‚æœä½ æƒ³ä¸ºè¿™ä¸–ç•Œåšäº›ä»€ä¹ˆï¼Œä»…æœ‰ç†æƒ³æ˜¯ä¸å¤Ÿçš„ï¼Œä½ éœ€è¦æ‰¾æ¡é€šå¾€ç›®æ ‡çš„é“è·¯å¹¶èµ°å®Œã€‚â€&lt;/p&gt;&lt;p&gt;&lt;b&gt;TiDB é€‰æ‹©çš„å¼€æºä¹‹è·¯ï¼Œè®©æˆ‘ä»¬åœ¨æ­£ç¡®çš„é“è·¯ä¸Šå¯ä»¥å¿«é€Ÿå¥”è·‘ï¼ŒåŒæ—¶æ”¶è·äº†ä¸€ä¸ªå……æ»¡èƒ½é‡åˆæœ‰è¶£çš„ç¤¾åŒºã€‚&lt;/b&gt;ç›®å‰ TiDB/TiKV å·²ç»æ±‡èšäº† &lt;b&gt;260&lt;/b&gt; ä½æ¥è‡ªå…¨çƒå„åœ°çš„ Contributorsï¼Œå¹¶åœ¨ GitHub ä¸Šè·å¾—äº† &lt;b&gt;17000+&lt;/b&gt; Starsï¼Œè¿™æ˜¯æˆ‘ä»¬é¥è¿œå¾é€”ä¸Šçš„ä¸€ä¸ªå°å°çš„æˆå°±ï¼Œæ„Ÿè°¢ç¤¾åŒºå¸®åŠ©æˆ‘ä»¬ä¸€èµ·èµ°å¾—æ›´è¿œã€‚&lt;/p&gt;&lt;p&gt;å»å¹´ä¸ƒæœˆï¼Œæˆ‘ä»¬åœ¨ä¸Šæµ·ä¸¾åŠäº†é¦–åœº TiDB TechDayï¼Œç”¨ä¸€æ•´å¤©çš„æ—¶é—´ä¸ºç¤¾åŒºå°ä¼™ä¼´æŠ½ä¸å‰¥èŒ§çš„è®²è§£ TiDB æŠ€æœ¯ç»†èŠ‚ã€‚ä»Šå¹´æˆ‘ä»¬é™¤äº† TiDB æŠ€æœ¯åˆ†äº«ä¹‹å¤–ï¼Œè¿˜å¸¦æ¥äº†ç²¾å½©çš„ç”¨æˆ·å®è·µå’Œç¤¾åŒºå°ä¼™ä¼´çš„è´¡çŒ®å¿ƒå¾—ã€‚å¸Œæœ›è¿™ä¸€å¤©ï¼Œèƒ½æ»¡è¶³ä½ å¯¹ TiDB æ›´æ·±å±‚ç»†èŠ‚çš„æ‰€æœ‰å¥½å¥‡ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;æ¬¢è¿å¤§å®¶åŠ å…¥è¿™ä¸€åœºç¤¾åŒºç‹‚æ¬¢ï¼Œå’Œæˆ‘ä»¬ä¸€èµ·æ„Ÿå—å¼€æºçš„é­…åŠ›ï¼&lt;/b&gt;&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-053f8cff20688c7ffd8efe58269f1851_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1028&quot; data-rawheight=&quot;1626&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-053f8cff20688c7ffd8efe58269f1851&quot; data-watermark-src=&quot;v2-ddcc1d914a44963e876074df60a70a79&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;b&gt;æ—¶é—´ï¼š2018-07-28 å‘¨å…­&lt;/b&gt;&lt;/li&gt;&lt;li&gt;&lt;b&gt;åœ°ç‚¹ï¼šæ·±åœ³å¸‚ Â· å—å±±åŒº Â· å—æµ·å¤§é“ 1079 å·èŠ±å›­åŸæ•°ç å¤§å¦ A åº§ 2 æ¥¼ 201 ä¼˜å®¢å·¥åœº&lt;/b&gt;&lt;/li&gt;&lt;li&gt;&lt;b&gt;æŠ¥ååœ°å€ï¼š&lt;/b&gt;&lt;/li&gt;&lt;/ul&gt;&lt;a href=&quot;http://www.huodongxing.com/event/6449101295200&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;v2-f59f2b532f746892c5b17729eed83b3b&quot; data-image-width=&quot;540&quot; data-image-height=&quot;320&quot; data-image-size=&quot;180x120&quot;&gt;TiDB TechDay2018 Â· æ·±åœ³&lt;/a&gt;&lt;h2&gt;&lt;br&gt;&lt;b&gt;TiDB TechDay2018 æ—¥ ç¨‹ &lt;/b&gt;&lt;br&gt;&lt;/h2&gt;&lt;p&gt;&lt;b&gt;9:00 - 9:45  &lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç°åœºç­¾åˆ°&lt;/p&gt;&lt;p&gt;&lt;b&gt;9:45 - 10:00  &lt;/b&gt;&lt;/p&gt;&lt;p&gt;å¼€åœº&lt;/p&gt;&lt;p&gt;&lt;b&gt;10:00 - 11:00 &lt;/b&gt;&lt;/p&gt;&lt;p&gt;TiDB 2.1: What&#39;s new and What&#39;s next&lt;br&gt;ç”³ç ¾ | PingCAP Engineering VP&lt;/p&gt;&lt;p&gt;&lt;b&gt;11:00 - 11:30 &lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç¤¾åŒºåˆ†äº« 1ï¼šTiDB åœ¨è½¬è½¬çš„åƒäº¿çº§å¤§è§„æ¨¡å®è·µ&lt;br&gt;å­™ç„ | è½¬è½¬ é¦–å¸­æ¶æ„å¸ˆ&lt;/p&gt;&lt;p&gt;&lt;b&gt;11:30 - 12:30 &lt;/b&gt;&lt;/p&gt;&lt;p&gt;TiDB ç¤¾åŒºåŠå¼€æºå¤§ç”Ÿæ€&lt;br&gt;é»„ä¸œæ—­ | PingCAP è”åˆåˆ›å§‹äººå…¼ CTO &lt;/p&gt;&lt;p&gt;&lt;b&gt;12:30 - 13:30 &lt;/b&gt;&lt;/p&gt;&lt;p&gt;åˆé¤&lt;/p&gt;&lt;p&gt;&lt;b&gt;13:30 - 14:00 &lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç¤¾åŒºåˆ†äº« 2ï¼šå¹³å®‰äº§é™© TiDB åº”ç”¨å®è·µ&lt;br&gt;ä¸æ°¸ | å¹³å®‰äº§é™© å¤§æ•°æ®å¹³å°äº§å“å›¢é˜Ÿè´Ÿè´£äºº&lt;/p&gt;&lt;p&gt;&lt;b&gt;14:00 - 14:30 &lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç¤¾åŒºåˆ†äº« 3ï¼šTiDB contributor ä¹‹è·¯&lt;br&gt;æ¨æ–‡ | TiDB contributor&lt;/p&gt;&lt;p&gt;&lt;b&gt;14:30 - 14:40 &lt;/b&gt;&lt;/p&gt;&lt;p&gt;Break&lt;/p&gt;&lt;p&gt;&lt;b&gt;14:40 - 15:40&lt;/b&gt;&lt;/p&gt;&lt;p&gt;Chaos Practice in TiDB&lt;br&gt;å”åˆ˜ | PingCAP é¦–å¸­æ¶æ„å¸ˆ&lt;/p&gt;&lt;p&gt;&lt;b&gt;15:40 - 16:00 &lt;/b&gt;&lt;/p&gt;&lt;p&gt;é¢†å– T æ¤ã€è´´çº¸ç­‰å‘¨è¾¹&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;æŠ¥ååœ°å€ï¼š&lt;/b&gt;&lt;/p&gt;&lt;a href=&quot;http://www.huodongxing.com/event/6449101295200&quot; data-draft-node=&quot;block&quot; data-draft-type=&quot;link-card&quot; data-image=&quot;v2-f59f2b532f746892c5b17729eed83b3b&quot; data-image-width=&quot;540&quot; data-image-height=&quot;320&quot; data-image-size=&quot;180x120&quot;&gt;TiDB TechDay2018 Â· æ·±åœ³&lt;/a&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-07-17-39909349</guid>
<pubDate>Tue, 17 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆåä¸‰ï¼‰ç´¢å¼•èŒƒå›´è®¡ç®—ç®€ä»‹</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-07-13-39649659.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/39649659&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-b7f88291dd3855ebcc79e627554a10c3_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;blockquote&gt;ä½œè€…ï¼šå´”ä¸€ä¸&lt;/blockquote&gt;&lt;h2&gt;ç®€è¿°&lt;/h2&gt;&lt;p&gt;åœ¨æ•°æ®åº“ä¸­å¤„ç†æŸ¥è¯¢è¯·æ±‚æ—¶ï¼Œå¦‚æœå¯ä»¥å°½æ—©çš„å°†æ— å…³æ•°æ®è¿‡æ»¤æ‰ï¼Œé‚£ä¹ˆåç»­çš„ç®—å­å°±å¯ä»¥å°‘åšæ— ç”¨åŠŸï¼Œæå‡æ•´ä¸ª SQL çš„æ‰§è¡Œæ•ˆç‡ã€‚è¿‡æ»¤æ•°æ®æœ€å¸¸ç”¨çš„æ‰‹æ®µæ˜¯ä½¿ç”¨ç´¢å¼•ï¼ŒTiDB çš„ä¼˜åŒ–å™¨ä¹Ÿä¼šå°½é‡é‡‡ç”¨ç´¢å¼•è¿‡æ»¤çš„æ–¹å¼å¤„ç†è¯·æ±‚ï¼Œåˆ©ç”¨ç´¢å¼•æœ‰åºçš„ç‰¹ç‚¹æ¥æå‡æŸ¥è¯¢æ•ˆç‡ã€‚æ¯”å¦‚å½“æŸ¥è¯¢æ¡ä»¶ä¸º &lt;code class=&quot;inline&quot;&gt;a = 1&lt;/code&gt; æ—¶ï¼Œå¦‚æœ a è¿™ä¸€åˆ—ä¸Šæœ‰ç´¢å¼•ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ç´¢å¼•å¾ˆå¿«çš„æŠŠæ»¡è¶³ &lt;code class=&quot;inline&quot;&gt;a = 1&lt;/code&gt; çš„æ•°æ®æ‹¿å‡ºæ¥ï¼Œè€Œä¸éœ€è¦é€è¡Œæ£€æŸ¥ a çš„å€¼æ˜¯å¦ä¸º 1ã€‚å½“ç„¶æ˜¯å¦ä¼šé€‰æ‹©ç´¢å¼•è¿‡æ»¤ä¹Ÿå–å†³äºä»£ä»·ä¼°ç®—ã€‚&lt;/p&gt;&lt;p&gt;ç´¢å¼•åˆ†ä¸ºå•åˆ—ç´¢å¼•å’Œå¤šåˆ—ç´¢å¼•ï¼ˆç»„åˆç´¢å¼•ï¼‰ï¼Œç­›é€‰æ¡ä»¶ä¹Ÿå¾€å¾€ä¸ä¼šæ˜¯ç®€å•çš„ä¸€ä¸ªç­‰å€¼æ¡ä»¶ï¼Œå¯èƒ½æ˜¯éå¸¸å¤æ‚çš„æ¡ä»¶ç»„åˆã€‚TiDB æ˜¯å¦‚ä½•åˆ†æè¿™äº›å¤æ‚æ¡ä»¶ï¼Œæ¥å¾—åˆ°è¿™äº›æ¡ä»¶åœ¨å¯¹åº”çš„ç´¢å¼•ä¸Šçš„é€»è¾‘åŒºé—´èŒƒå›´ï¼ˆrangeï¼‰ï¼Œå°±æ˜¯æœ¬æ–‡è¦ä»‹ç»çš„å†…å®¹ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;å…³äº TiDB å¦‚ä½•æ„å»ºç´¢å¼•ï¼Œå¦‚ä½•å­˜å‚¨ç´¢å¼•æ•°æ®ï¼Œå¸Œæœ›è¯»è€…èƒ½å¤Ÿæœ‰åŸºæœ¬çš„äº†è§£ï¼ˆå‚è€ƒé˜…è¯»ï¼š&lt;a href=&quot;https://pingcap.com/blog-cn/tidb-internal-2/&quot;&gt;ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´è®¡ç®—&lt;/a&gt; ï¼‰ã€‚&lt;/b&gt;&lt;/p&gt;&lt;p&gt;è¿™é‡Œæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå±•ç¤ºè¿™é‡Œæ‰€è¯´çš„ç´¢å¼•èŒƒå›´è®¡ç®—æ˜¯åšä»€ä¹ˆçš„ï¼Œå»ºè¡¨è¯­å¥å’ŒæŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š&lt;br&gt;CREATE TABLE t (a int primary key, b int, c int);&lt;br&gt;select * from t where ((a &amp;gt; 1 and a &amp;lt; 5 and b &amp;gt; 2) or (a &amp;gt; 8 and a &amp;lt; 10 and c &amp;gt; 3)) and d = 5;&lt;br&gt;è®¡ç®—ç´¢å¼•é€»è¾‘åŒºé—´èŒƒå›´çš„æµç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-6721b3933dec315f3de020d2a6df28d7_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1240&quot; data-rawheight=&quot;677&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-6721b3933dec315f3de020d2a6df28d7&quot; data-watermark-src=&quot;v2-fe49c70702f4c93c2fc2fd8104f7cc19&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæ•´ä¸ªæµç¨‹åˆ†ä¸ºä» Filter ä¸­æŠ½å–å¯ç”¨ç´¢å¼•çš„è¡¨è¾¾å¼ä»¥åŠåˆ©ç”¨é€‰å‡ºçš„è¡¨è¾¾å¼æ„é€ æ•°æ®èŒƒå›´ä¸¤ä¸ªæ­¥éª¤ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«æè¿°ã€‚&lt;/p&gt;&lt;h2&gt;æŠ½å–è¡¨è¾¾å¼&lt;/h2&gt;&lt;p&gt;è¿™ä¸ªæ­¥éª¤æ˜¯ä» Filter ä¸­å°†èƒ½å¤Ÿç”¨ä¸Šç´¢å¼•çš„è¡¨è¾¾å¼é€‰å‡ºæ¥ã€‚ç”±äºå•åˆ—ç´¢å¼•å’Œå¤šåˆ—ç´¢å¼•åœ¨å¤„ç†é€»è¾‘ä¸Šæœ‰å¾ˆå¤§çš„ä¸åŒï¼Œæ‰€ä»¥ä¼šåˆ†å•åˆ—ç´¢å¼•å’Œå¤šåˆ—ç´¢å¼•ä¸¤ä¸­æƒ…å†µè¿›è¡Œè®²è§£ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;å•åˆ—ç´¢å¼•&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å•åˆ—ç´¢å¼•çš„æƒ…å†µç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ã€‚å¾ˆå¤šæ»¡è¶³ Column op Constant å½¢å¼çš„ç®€å•è¡¨è¾¾å¼éƒ½å¯ä»¥ç”¨æ¥è®¡ç®— rangeï¼Œå•ä¸ªè¡¨è¾¾å¼çš„åˆ¤æ–­é€»è¾‘åœ¨ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/checker.go&quot;&gt;checker.go&lt;/a&gt; çš„ conditionChecker ä¸­ã€‚è€Œå¯¹äºåŒ…å«äº† AND æˆ–è€… OR çš„å¤æ‚æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸‹è¿°è§„åˆ™è¿›è¡Œå¤„ç†ï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;AND è¡¨è¾¾å¼æ— å…³çš„ filter å¹¶ä¸ä¼šå½±å“å…¶å¯ä»¥è®¡ç®— range çš„å­é¡¹ã€‚æ‰€ä»¥ç›´æ¥èˆå»æ— å…³çš„è¡¨ç¤ºå³å¯ã€‚ä»¥æµç¨‹å›¾ä¸­çš„ä¸€ä¸ªå­è¡¨è¾¾å¼ &lt;code class=&quot;inline&quot;&gt;a &amp;gt; 1 and a &amp;lt; 5 and b &amp;gt; 2&lt;/code&gt; ä¸ºä¾‹ï¼Œæˆ‘ä»¬åªè¦å°† &lt;code class=&quot;inline&quot;&gt;b &amp;gt; 2&lt;/code&gt; æ‰”æ‰ï¼Œä¿ç•™ &lt;code class=&quot;inline&quot;&gt;a &amp;gt; 1 and a &amp;lt; 5&lt;/code&gt; å³å¯ã€‚&lt;/li&gt;&lt;li&gt;OR è¡¨è¾¾å¼ä¸­ï¼Œæ¯ä¸ªå­é¡¹éƒ½è¦å¯ä»¥ç”¨æ¥è®¡ç®— rangeï¼Œå¦‚æœæœ‰ä¸å¯ä»¥è®¡ç®— range çš„å­é¡¹ï¼Œé‚£ä¹ˆè¿™æ•´ä¸ªè¡¨è¾¾å¼éƒ½ä¸å¯ç”¨æ¥è®¡ç®— rangeã€‚ä»¥ &lt;code class=&quot;inline&quot;&gt;a = 1 or b = 2&lt;/code&gt;ä¸ºä¾‹ï¼Œ&lt;code class=&quot;inline&quot;&gt;b = 2&lt;/code&gt; è¿™ä¸€å­é¡¹ä¸å¯ä»¥ç”¨æ¥è®¡ç®— a çš„ rangeï¼Œæ‰€ä»¥è¿™ä¸ªè¡¨è¾¾å¼æ•´ä½“ä¸Šæ— æ³•è®¡ç®— a çš„ rangeã€‚è€Œå¦‚æœæ˜¯ &lt;code class=&quot;inline&quot;&gt;a &amp;gt; 1 or ( a &amp;lt; 2 and b = 1)&lt;/code&gt;ï¼Œæ ¹æ® 1 ä¸­çš„è§„åˆ™ï¼Œç¬¬äºŒä¸ªå­é¡¹ä¼šç•™ä¸‹ &lt;code class=&quot;inline&quot;&gt;a &amp;lt; 2&lt;/code&gt; çš„éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨æ¥è®¡ç®— a çš„ rangeï¼Œå› æ­¤æ•´ä¸ªè¡¨è¾¾å¼ä¼šè¿”å› &lt;code class=&quot;inline&quot;&gt;a &amp;gt; 1 and a &amp;lt; 2&lt;/code&gt; æ¥ä¾›æ¥ä¸‹æ¥è®¡ç®— range çš„éƒ¨åˆ†å¤„ç†ã€‚&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;è¿™é‡Œè¡¥å……è¯´æ˜ä¸€ç‚¹ï¼ŒTiDB çš„ä¸»é”®åœ¨å®ç°æ–¹å¼ä¸Šé™å®šäº†åªæœ‰æ•´æ•°ç±»å‹çš„å•åˆ—ä¸»é”®ä¼šæŠŠä¸»é”®å€¼å½“åš RowIDï¼Œç„¶åç¼–ç æˆ RowKeyï¼Œå’Œè¿™è¡Œæ•°æ®å­˜å‚¨åœ¨ä¸€èµ·ã€‚å…¶ä»–ç±»å‹çš„å•åˆ—ä¸»é”®ä¼šä½œä¸ºæ™®é€šçš„ unique key çœ‹å¾…ï¼Œå½“æŸ¥è¯¢çš„åˆ—åŒ…å«ç´¢å¼•ä¸Šæ²¡æœ‰çš„åˆ—æ—¶ï¼Œéœ€è¦ä¸€æ¬¡æŸ¥ç´¢å¼• + ä¸€æ¬¡æ‰«è¡¨ã€‚æ‰€ä»¥æˆ‘ä»¬å°†è¿™ç§æ•´æ•°ç±»å‹ä½œä¸ºä¸»é”®çš„ç´¢å¼•å¤„ç†é€»è¾‘å•ç‹¬æŠ½å–å‡ºæ¥ï¼Œå…¶å…¥å£å‡½æ•°ä¸º &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/detacher.go#L329&quot;&gt;DetachCondsForTableRange&lt;/a&gt; ã€‚å…¶ä¸­å¯¹ AND è¡¨è¾¾å¼å’Œ OR è¡¨è¾¾å¼çš„å¤„ç†å…¥å£åˆ†åˆ«ä¸º &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/detacher.go#L28&quot;&gt;detachColumnCNFConditions&lt;/a&gt; å’Œ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/detacher.go#L61&quot;&gt;detachColumnDNFConditions&lt;/a&gt;ã€‚è¿™ä¸¤ä¸ªå‡½æ•°ä¹Ÿç”¨æ¥å¤„ç†å…¶ä»–ç±»å‹çš„ä¸»é”®æˆ–è€…ç´¢å¼•çš„çš„ range è®¡ç®—ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;å¤šåˆ—ç´¢å¼•&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å¤šåˆ—ç´¢å¼•çš„æƒ…å†µè¾ƒå•åˆ—ç´¢å¼•è€Œè¨€ä¼šå¤æ‚ä¸€äº›ï¼Œå› ä¸ºåœ¨å¤„ç† OR è¡¨è¾¾å¼ä¸­åˆ—ä¸åˆ—ä¹‹é—´çš„å…³ç³»éœ€è¦è€ƒè™‘æ›´å¤šæƒ…å†µã€‚TiDB ä¸­ä¸ºäº†ç®€åŒ– ranger çš„é€»è¾‘ï¼Œç›®å‰åªè€ƒè™‘ä¸‹åˆ—æƒ…å†µï¼š&lt;/p&gt;&lt;ol&gt;&lt;li&gt;AND è¡¨è¾¾å¼ä¸­ï¼Œåªæœ‰å½“ä¹‹å‰çš„åˆ—å‡ä¸ºç‚¹æŸ¥çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šè€ƒè™‘ä¸‹ä¸€ä¸ªåˆ—ã€‚&lt;br&gt;e.g. å¯¹äºç´¢å¼• (a, b, c)ï¼Œæœ‰æ¡ä»¶ &lt;code class=&quot;inline&quot;&gt;a &amp;gt; 1 and b = 1&lt;/code&gt;ï¼Œé‚£ä¹ˆä¼šè¢«é€‰ä¸­çš„åªæœ‰ &lt;code class=&quot;inline&quot;&gt;a &amp;gt; 1&lt;/code&gt;ã€‚å¯¹äºæ¡ä»¶ &lt;code class=&quot;inline&quot;&gt;a in (1, 2, 3) and b &amp;gt; 1&lt;/code&gt;ï¼Œä¸¤ä¸ªæ¡ä»¶å‡ä¼šè¢«é€‰åˆ°ç”¨æ¥è®¡ç®— rangeã€‚&lt;br&gt;ç”±äºéç‚¹æŸ¥çš„éƒ¨åˆ†åªä¼šæ¶‰åŠåˆ°ä¸€ä¸ªåˆ—ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å¤ç”¨ &lt;code class=&quot;inline&quot;&gt;detachColumnCNFConditions&lt;/code&gt;ã€‚&lt;/li&gt;&lt;li&gt;OR è¡¨è¾¾å¼ä¸­ï¼Œæ¯ä¸ªå­é¡¹ä¼šè§†ä¸º AND è¡¨è¾¾å¼åˆ†å¼€è€ƒè™‘ã€‚ä¸å•åˆ—ç´¢å¼•çš„æƒ…å†µä¸€æ ·ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªå­é¡¹æ— æ³•ç”¨æ¥è®¡ç®—ç´¢å¼•ï¼Œé‚£ä¹ˆè¯¥ OR è¡¨è¾¾å¼ä¾¿å®Œå…¨æ— æ³•è®¡ç®—ç´¢å¼•ã€‚&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;å¤šåˆ—ç´¢å¼•å¤„ç†çš„å…¥å£å‡½æ•°ä¸º &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/detacher.go#L270&quot;&gt;DetachCondAndBuildRangeForIndex&lt;/a&gt;ï¼ŒAND è¡¨è¾¾å¼å’Œ OR è¡¨è¾¾å¼çš„å¤„ç†å…¥å£åˆ†åˆ«ä¸º &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/detacher.go#L142&quot;&gt;detachCNFCondAndBuildRangeForIndex&lt;/a&gt; å’Œ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/detacher.go#L214&quot;&gt;detachDNFCondAndBuildRangeForIndex&lt;/a&gt;ã€‚ï¼ˆç”±äºå¤šåˆ—ç´¢å¼•å¯¹ range çš„å¤„ç†ç›¸å¯¹å•åˆ—ç´¢å¼•è€Œè¨€ä¼šå¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥æ²¡æœ‰æ‹†åˆ†ä¸º DetachCondition å’Œ BuildRange ä¸¤éƒ¨åˆ†ï¼Œè€Œæ˜¯ç”± DetachCondAndBuildRangeForIndex å¤„ç†ã€‚ï¼‰&lt;/p&gt;&lt;p&gt;ç”±äºé€»è¾‘è¿›è¡Œåˆ°äº†ç®€åŒ–ï¼Œå› æ­¤ç›®å‰ TiDB çš„ ranger å­˜åœ¨æ— æ³•æ­£ç¡®å¤„ç†çš„æƒ…å†µã€‚æ¯”å¦‚ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;code class=&quot;inline&quot;&gt;a = 1 and (b = 1 or b = 2) and c &amp;gt; 1&lt;/code&gt;ã€‚å¯¹äºè¿™ä¸ªå¼å­ï¼Œå½“ (a, b ,c) ä¸ºç´¢å¼•æ—¶ï¼Œå¦‚ä¸Šè¿°æ‰€è¨€ï¼Œç”±äº &lt;code class=&quot;inline&quot;&gt;(b = 1 or b = 2)&lt;/code&gt; å½¢å¼ä¸Šæ˜¯ OR è¡¨è¾¾å¼çš„æƒ…å†µï¼Œè€Œéç‚¹æŸ¥ã€‚æ‰€ä»¥ä¼šåœ¨ b åˆ—åœæ­¢ï¼Œä¸ä¼šè€ƒè™‘ &lt;code class=&quot;inline&quot;&gt;c &amp;gt; 1&lt;/code&gt; çš„æƒ…å†µã€‚æ‰€ä»¥ç›®å‰ä¸ºäº†å…¼å®¹ TiDB çš„é€»è¾‘ï¼Œé‡åˆ°è¿™ç§æƒ…å†µå°½é‡æ”¹å†™ä¸º &lt;code class=&quot;inline&quot;&gt;a = 1 and b in (1, 2) and c &amp;gt; 1&lt;/code&gt; çš„å½¢å¼ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-d2c052d9158e790bde962cd16d0e8c07_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1155&quot; data-rawheight=&quot;286&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-d2c052d9158e790bde962cd16d0e8c07&quot; data-watermark-src=&quot;v2-fe43cc0ef0d02aefe44bd3d95026677b&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;ul&gt;&lt;li&gt;ç±»ä¼¼çš„å¦‚ &lt;code class=&quot;inline&quot;&gt;((a = 1 and b = 1) or (a = 2 and b = 2)) and c = 1&lt;/code&gt; å½¢å¼çš„å¼å­ï¼Œå‰æ®µ OR è¡¨è¾¾å¼å®é™…ä¸Šä¸ºç‚¹æŸ¥çš„è¡Œä¸ºï¼Œä½†æ˜¯ç”±äºæ˜¯ OR è¿æ¥èµ·æ¥çš„å¼å­ï¼Œæ‰€ä»¥åœ¨ TiDB çš„é€»è¾‘ä¸­ä½œä¸ºèŒƒå›´æŸ¥è¯¢å¤„ç†ï¼Œå› æ­¤ &lt;code class=&quot;inline&quot;&gt;c = 1&lt;/code&gt; ä¸ä¼šä½œä¸ºç´¢å¼•çš„è®¡ç®—æ¡ä»¶å¤„ç†ã€‚è€Œè¿™æ—¶æ”¹å†™ä¸º &lt;code class=&quot;inline&quot;&gt;(a, b) in ((1, 1)&lt;/code&gt;,  &lt;code class=&quot;inline&quot;&gt;(2, 2)) and c = 1&lt;/code&gt; çš„å½¢å¼ä¹Ÿä¸ä¼šä½¿ &lt;code class=&quot;inline&quot;&gt;c = 1&lt;/code&gt; é€‰å…¥ç´¢å¼•è®¡ç®—çš„æ¡ä»¶ï¼ŒåŸå› æ˜¯å¤šåˆ— in çš„å‡½æ•°ä¼šè¢« TiDB æ”¹å†™ä¸º OR è¿æ¥çš„å½¢å¼ï¼Œæ‰€ä»¥ &lt;code class=&quot;inline&quot;&gt;((a = 1 and b = 1) or (a = 2 and b = 2))&lt;/code&gt; å’Œ &lt;code class=&quot;inline&quot;&gt;(a, b) in ((1, 1),  (2, 2))&lt;/code&gt; åœ¨ TiDB ä¸­æ˜¯å®Œå…¨ä¸€è‡´çš„è¡Œä¸ºã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œç›®å‰çš„åŠæ³•åªæœ‰å°†è¿™äº›æ¡ä»¶éƒ½æ”¾å…¥ OR çš„å­é¡¹ä¸­ï¼Œé’ˆå¯¹è¿™é‡Œç”¨åˆ°çš„ä¾‹å­ï¼Œé‚£å°±æ˜¯è¦æ”¹å†™ä¸º &lt;code class=&quot;inline&quot;&gt;((a = 1 and b = 1 and c = 1) or (a = 2 and b = 2 and c = 1))&lt;/code&gt;ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-50e759f5b37e8f6e5b2a1fbf430bfc3a_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1155&quot; data-rawheight=&quot;294&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-50e759f5b37e8f6e5b2a1fbf430bfc3a&quot; data-watermark-src=&quot;v2-54cef9f6e4aac480b9e3a8b5f5021aa1&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;h2&gt;è®¡ç®—é€»è¾‘åŒºé—´&lt;/h2&gt;&lt;p&gt;è¿™ä¸€æ­¥éª¤ä¸­ï¼Œåˆ©ç”¨ä¸Šä¸€æ­¥æŠ½å–å‡ºæ¥çš„è¡¨è¾¾å¼ä¼°ç®—å‡ºæ•°æ®çš„é€»è¾‘åŒºé—´èŒƒå›´ï¼Œåç»­ä¼šæ ¹æ®è¿™ä¸ªé€»è¾‘åŒºé—´ä»¥åŠæ•°æ®ç¼–ç æ–¹å¼æ„é€ ç‰©ç†åŒºé—´è¿›è¡Œæ•°æ®è®¿é—®ã€‚æˆ‘ä»¬ä»ç„¶åˆ†ä¸ºå•åˆ—ç´¢å¼•å’Œå¤šåˆ—ç´¢å¼•ä¸¤ä¸ªæƒ…å†µæ¥ä»‹ç»ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;å•åˆ—ç´¢å¼•&lt;/b&gt;&lt;/p&gt;&lt;p&gt;è¿™ç§æƒ…å†µä¸‹ï¼Œè¾“å…¥çš„è¡¨è¾¾å¼ä¸º Column op Constant å½¢å¼çš„ç®€å•è¡¨è¾¾å¼ç”± OR ä»¥åŠ AND è¿æ¥è€Œæˆã€‚æˆ‘ä»¬å¯¹æ¯ä¸€ä¸ªå…·ä½“çš„æ“ä½œç¬¦ï¼Œéƒ½è®¾è®¡äº†ä¸€æ®µå¯¹åº”çš„è®¡ç®— range çš„é€»è¾‘ï¼Œå½“é‡åˆ° AND æˆ–è€… OR æ—¶ï¼Œä¼šå¯¹ä¸¤ä¸ªåŒºé—´æ±‚äº¤æˆ–è€…æ±‚å¹¶ã€‚åœ¨ point.go ä¸­æœ‰ä¸€ä¸ª &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/points.go#L146&quot;&gt;builder&lt;/a&gt; çš„ç»“æ„ä½“ç”¨æ¥å¤„ç†ä¸Šè¿°é€»è¾‘ã€‚&lt;/p&gt;&lt;p&gt;åœ¨è¿™ä¸ªé˜¶æ®µæˆ‘ä»¬è®°å½• range æ—¶ç”¨ rangePoint çš„ç»“æ„æ¥å­˜å‚¨ rangeã€‚&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;// Point is the end point of range interval.
type point struct {
	value types.Datum
	excl  bool // exclude
	start bool
}&lt;/code&gt;&lt;p&gt;æ¯ä¸ª point ä»£è¡¨åŒºé—´çš„ä¸€ä¸ªç«¯ç‚¹ï¼Œå…¶ä¸­çš„ excl è¡¨ç¤ºç«¯ç‚¹ä¸ºå¼€åŒºé—´çš„ç«¯ç‚¹è¿˜æ˜¯é—­åŒºé—´çš„ç«¯ç‚¹ã€‚start è¡¨ç¤ºè¿™ä¸ªç«¯ç‚¹æ˜¯å·¦ç«¯ç‚¹è¿˜æ˜¯å³ç«¯ç‚¹ã€‚&lt;/p&gt;&lt;p&gt;builder ä¸­æ¯ä¸ª buildFromXXX çš„æ–¹æ³•éƒ½æ˜¯è®¡ç®—ä¸€ä¸ªå…·ä½“å‡½æ•°çš„ range çš„æ–¹æ³•ã€‚æ¯”å¦‚ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/points.go#L299&quot;&gt;buildFromIn&lt;/a&gt; ä¾¿æ˜¯å¤„ç† &lt;a href=&quot;https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#function_in&quot;&gt;in å‡½æ•°&lt;/a&gt; çš„æ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°å®ƒé¦–å…ˆå¯¹ in å‡½æ•°çš„å€¼åˆ—è¡¨çš„æ¯ä¸ªå€¼éƒ½æ„é€ äº†ä¸€ä¸ª rangPoint çš„å•ç‚¹åŒºé—´ï¼Œç„¶åå¯¹è¿™äº›åŒºé—´æ”¾åœ¨ä¸€ä¸ª slice ä¸­åšæ’åºä»¥åŠå»é‡ã€‚æœ€ç»ˆå°†å»é‡åçš„ç»“æœè¾“å‡ºã€‚&lt;/p&gt;&lt;p&gt;åœ¨ pointer.go ä¸­è¿˜åŒ…å«å…¶ä»–å„ç±»çš„å‡½æ•°çš„å¤„ç†ï¼Œå…·ä½“å¯ä»¥ç¿»é˜…æºä»£ç ã€‚&lt;/p&gt;&lt;p&gt;é™¤äº†å¯¹å…·ä½“å‡½æ•°çš„å¤„ç†å¤–ï¼Œpointer.go ä¸­è¿˜æœ‰åŒºé—´äº¤å’ŒåŒºé—´å¹¶çš„æ“ä½œã€‚&lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/points.go#L484&quot;&gt;intersection&lt;/a&gt; å’Œ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/points.go#L488&quot;&gt;union&lt;/a&gt; åˆ†åˆ«ä»£è¡¨åŒºé—´äº¤å’ŒåŒºé—´å¹¶ã€‚ä¸¤ä¸ªå‡½æ•°çš„é€»è¾‘å‡é€šè¿‡ merge æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡ä¼ å…¥ä¸€ä¸ª flag æ¥åŒºåˆ†ã€‚merge å‡½æ•°åšäº†å¦‚ä¸‹ä¸¤ä¸ªå‡è®¾ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;a, b ä¸¤ä¸ªåŒºé—´å‡å·²ç»åšè¿‡å»é‡&lt;/li&gt;&lt;li&gt;å•ä¸ªåŒºé—´åºåˆ—å†…éƒ¨ä¸ä¼šæœ‰é‡å çš„éƒ¨åˆ†&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;merge å‡½æ•°ä½¿ç”¨ inRangeCount æ¥è®°å½•å½“å‰ä½ç½®è¢« a, b ä¸¤ä¸ªåŒºé—´åºåˆ—è¦†ç›–çš„æƒ…å†µã€‚åŒºé—´æ±‚å¹¶çš„æƒ…å†µæ—¶ï¼Œåªè¦ a, b ä¸¤ä¸ªåŒºé—´åºåˆ—ä¸­æœ‰ä¸€ä¸ªåŒºé—´åºåˆ—è¦†ç›–ä¾¿å¯ä»¥ä½œä¸ºè§£è¾“å‡ºï¼Œè¢«ä¸¤ä¸ªåŒºé—´åŒæ—¶è¦†ç›–çš„ç«¯ç‚¹å¿…ç„¶æ˜¯å±äºä¸€ä¸ªæ›´å¤§çš„åŒºé—´çš„å†…éƒ¨ä¸éœ€è¦è¾“å‡ºã€‚æ‰€ä»¥å½“ inRangeCount ä¸º 1 æ—¶ï¼Œå³ä¸ºéœ€è¦è¾“å‡ºçš„åŒºé—´ç«¯ç‚¹ã€‚&lt;/p&gt;&lt;p&gt;å½“åŒºé—´æ±‚äº¤æ—¶ï¼Œéœ€è¦ä¸¤ä¸ªåºåˆ—éƒ½è¦†ç›–åˆ°æ‰æ˜¯å¯ä»¥è¾“å‡ºçš„ç«¯ç‚¹ï¼Œæ‰€ä»¥å½“ inRangeCount ä¸º 2 æ—¶ï¼Œå³ä¸ºéœ€è¦è¾“å‡ºçš„åŒºé—´ç«¯ç‚¹ã€‚&lt;/p&gt;&lt;p&gt;åœ¨å¾—åˆ°æœ€åçš„åŒºé—´ç«¯ç‚¹åºåˆ—åï¼Œç”± &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/ranger.go#L174&quot;&gt;points2TableRanges&lt;/a&gt; è½¬åŒ–ä¸ºå¯¹å¤–æš´éœ²çš„ range ç»“æ„ï¼Œç”± &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/util/ranger/ranger.go#L224&quot;&gt;BuildTableRange&lt;/a&gt; è¾“å‡ºåˆ° plan packageã€‚&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;// NewRange represents a range generated in physical plan building phase.
type NewRange struct {
	LowVal  []types.Datum
	HighVal []types.Datum

	LowExclude  bool // Low value is exclusive.
	HighExclude bool // High value is exclusive.
}&lt;/code&gt;&lt;p&gt;åœ¨ç°åœ¨çš„ TiDB ä¸­ï¼Œå•åˆ—ç´¢å¼•å’Œå¤šåˆ—ç´¢å¼•ä½¿ç”¨äº†ç›¸åŒçš„ range ç»“æ„ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç«¯ç‚¹å€¼ä¸º slice çš„å½¢å¼ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;å¤šåˆ—ç´¢å¼•&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å¯¹äºå¤šåˆ—ç´¢å¼•ï¼Œå½“å…¶ä¸º AND è¡¨è¾¾å¼æ—¶ï¼Œæ ¹æ®å‰è¿°æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå…¶å½¢å¼å¿…ä¸ºç´¢å¼•å‰ç¼€åˆ—ä¸Šçš„ç­‰å€¼æ¡ä»¶å†åŠ ä¸Šå…³äºå‰ç¼€ä¹‹åä¸€ä¸ªåˆ—çš„å¤æ‚æ¡ä»¶ç»„æˆã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æŒ‰é¡ºåºå¤„ç†ç‚¹æŸ¥çš„ç­‰å€¼æ¡ä»¶éƒ¨åˆ†ï¼Œå°†ç‚¹æŸ¥çš„åŒºé—´ä¾æ¬¡ append åˆ° NewRange ä¸­çš„ LowVal å’Œ HighVal ä¸¤ä¸ª Slice ä¸­å³å¯ï¼ˆ&lt;a href=&quot;https://github.com/pingcap/tidb/blob/master/util/ranger/ranger.go#L133&quot;&gt;appendPoints2Ranges&lt;/a&gt;ï¼‰ã€‚å¤„ç†åˆ°æœ€åä¸€åˆ—æ—¶ï¼Œå°†ä¹‹å‰çš„ NewRange æŒ‰æœ€åéç‚¹æŸ¥åˆ—æ‰€è®¡ç®—å¾—åˆ°çš„åŒºé—´ä¸ªæ•°æ‹·è´ä¸€ä¸‹ï¼Œå†ä¾æ¬¡ append å³å¯ã€‚å…·ä½“ä»£ç å¯è§ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/master/util/ranger/ranger.go#L282&quot;&gt;buildCNFIndexRange&lt;/a&gt;ã€‚&lt;br&gt;å¯¹äº OR è¡¨è¾¾å¼çš„æƒ…å†µï¼Œç”±äºæ­¤æ—¶ range å·²ç»æ— æ³•è½¬å› point çš„ç»“æ„ã€‚æ‰€ä»¥è¿™é‡Œé‡æ–°å®ç°äº†ä¸€ä¸‹åŒºé—´å¹¶çš„æ“ä½œã€‚å®ç°çš„å½¢å¼ä¾¿æ˜¯æ¯”è¾ƒå¸¸è§çš„å°†åŒºé—´æŒ‰å·¦ç«¯ç‚¹æ’åºï¼Œåœ¨ä¾æ¬¡æ‰«è¿‡åŒºé—´çš„åŒæ—¶ï¼Œè®°å½•å½“å‰æ‰€æœ‰é‡å è¿‡çš„åŒºé—´çš„æœ€å³å³ç«¯ç‚¹æ¥è¿›è¡ŒåšåŒºé—´å¹¶çš„ç®—æ³•ã€‚åŒºé—´å¹¶çš„å…·ä½“çš„å®ç°å¯è§ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/master/util/ranger/ranger.go#L357&quot;&gt;unionRanges&lt;/a&gt; æ–¹æ³•ã€‚&lt;/p&gt;&lt;h2&gt;Future Plan&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;ç›®å‰ TiDB å¯¹å•åˆ—ç´¢å¼•çš„å¤„ç†åœ¨é€»è¾‘ä¸Šå·²ç»éå¸¸å®Œå¤‡ï¼Œåœ¨å®é™…è¡¨ç°ä¸Šå¯èƒ½ç”±äºæ²¡æœ‰å¯¹éƒ¨åˆ†å‡½æ•°å®ç°è®¡ç®— range çš„é€»è¾‘è€Œæœ‰é—æ¼ã€‚è¿™éƒ¨åˆ†ä¼šæ ¹æ®æƒ…å†µè¿›è¡Œä¼˜åŒ–ã€‚&lt;/li&gt;&lt;li&gt;å¦‚ä¸Šæ–‡æåˆ°çš„ï¼Œç›®å‰ TiDB ä¸ºäº†ç®€åŒ– ranger çš„é€»è¾‘ï¼Œå¯¹å¤šåˆ—ç´¢å¼•åšäº†ä¸€äº›å‡è®¾ã€‚æœªæ¥ä¼šå°è¯•å»æ‰æˆ–è€…å¼±åŒ–è¿™äº›å‡è®¾ï¼Œæˆ–è€…åœ¨å‰æœŸå¯¹ SQL è¿›è¡Œæ›´å……åˆ†çš„æ”¹å†™ä½¿å¾— SQL ä¸ä¼šè§¦å‘è¿™äº›å‡è®¾ï¼Œæ¥æä¾›æ›´åŠ å¼ºå¤§çš„åŠŸèƒ½ï¼Œå…äºæ‰‹åŠ¨ rewrite çš„éº»çƒ¦ã€‚&lt;/li&gt;&lt;li&gt;ç›®å‰ TiDB å¯¹ç®€å•å¼å­çš„å½¢å¼çš„æ£€æŸ¥é™å®šåœ¨äº† Column op Constant çš„å½¢å¼ã€‚æ‰€ä»¥è¯¸å¦‚ &lt;code class=&quot;inline&quot;&gt;from_unixtime(timestamp_col) op datetime_constant&lt;/code&gt; å½¢å¼çš„æ¡ä»¶æ˜¯æ— æ³•è®¡ç®—ç´¢å¼•çš„ï¼Œä¹Ÿéœ€è¦æ‰‹åŠ¨ rewrite ä¸º &lt;code class=&quot;inline&quot;&gt;timestamp_col op timestamp_constant&lt;/code&gt; æ‰å¯ä»¥ä½¿ç”¨åˆ°ç´¢å¼•ã€‚è¿™éƒ¨åˆ†ä¹Ÿä¼šè€ƒè™‘è¿›è¡Œæ”¹è¿›ä»¥æå‡ç”¨æˆ·ä½“éªŒã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼š&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/39139693&quot;&gt;ï¼ˆåäºŒï¼‰ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38572730&quot;&gt;ï¼ˆåä¸€ï¼‰Index Lookup Join&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38095421&quot;&gt;ï¼ˆåï¼‰Chunk å’Œæ‰§è¡Œæ¡†æ¶ç®€ä»‹&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/37773956&quot;&gt;ï¼ˆä¹ï¼‰Hash Join&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/36420449&quot;&gt;ï¼ˆå…«ï¼‰åŸºäºä»£ä»·çš„ä¼˜åŒ–&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/35511864&quot;&gt;ï¼ˆä¸ƒï¼‰åŸºäºè§„åˆ™çš„ä¼˜åŒ–&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/35134962&quot;&gt;ï¼ˆå…­ï¼‰Select è¯­å¥æ¦‚è§ˆ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34770765&quot;&gt;ï¼ˆäº”ï¼‰TiDB SQL Parser çš„å®ç°&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34512827&quot;&gt;ï¼ˆå››ï¼‰Insert è¯­å¥æ¦‚è§ˆ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34369624&quot;&gt;ï¼ˆä¸‰ï¼‰SQL çš„ä¸€ç”Ÿ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34176614&quot;&gt;ï¼ˆäºŒï¼‰åˆè¯† TiDB æºç &lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34109413&quot;&gt;ï¼ˆä¸€ï¼‰åº&lt;/a&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-07-13-39649659</guid>
<pubDate>Fri, 13 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆåäºŒï¼‰ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸Šï¼‰</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-07-06-39139693.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/39139693&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-b2c9a7be595f1991e8381638b7c7ebfc_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;blockquote&gt;ä½œè€…ï¼š è°¢æµ·æ»¨&lt;/blockquote&gt;&lt;p&gt;åœ¨ TiDB é‡Œï¼ŒSQL ä¼˜åŒ–çš„è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºé€»è¾‘ä¼˜åŒ–å’Œç‰©ç†ä¼˜åŒ–ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåœ¨ç‰©ç†ä¼˜åŒ–é˜¶æ®µéœ€è¦ä¸ºé€»è¾‘æŸ¥è¯¢è®¡åˆ’ä¸­çš„ç®—å­ä¼°ç®—è¿è¡Œä»£ä»·ï¼Œå¹¶é€‰æ‹©å…¶ä¸­ä»£ä»·æœ€ä½çš„ä¸€æ¡æŸ¥è¯¢è·¯å¾„ä½œä¸ºæœ€ç»ˆçš„æŸ¥è¯¢è®¡åˆ’ã€‚è¿™é‡Œéå¸¸å…³é”®çš„ä¸€ç‚¹æ˜¯å¦‚ä½•ä¼°ç®—æŸ¥è¯¢ä»£ä»·ï¼Œæœ¬æ–‡æ‰€ä»‹ç»çš„ç»Ÿè®¡ä¿¡æ¯æ˜¯è¿™ä¸ªä¼°ç®—è¿‡ç¨‹çš„æ ¸å¿ƒæ¨¡å—ã€‚&lt;/p&gt;&lt;p&gt;è¿™éƒ¨åˆ†å†…å®¹éå¸¸å¤æ‚ï¼Œæ‰€ä»¥ä¼šåˆ†æˆä¸¤ç¯‡æ–‡ç« æ¥ä»‹ç»ã€‚æœ¬ç¯‡æ–‡ç« ä»‹ç»ç»Ÿè®¡ä¿¡æ¯åŸºæœ¬æ¦‚å¿µã€TiDB çš„ç»Ÿè®¡ä¿¡æ¯æ”¶é›†/æ›´æ–°æœºåˆ¶ä»¥åŠå¦‚ä½•ç”¨ç»Ÿè®¡ä¿¡æ¯æ¥ä¼°è®¡ç®—å­ä»£ä»·ã€‚ä¸Šç¯‡ä¾§é‡äºä»‹ç»åŸç†ï¼Œä¸‹ç¯‡ä¼šç»“åˆåŸç†ä»‹ç» TiDB çš„æºç å®ç°ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ç»Ÿè®¡ä¿¡æ¯æ˜¯ä»€ä¹ˆ&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;ä¸ºäº†å¾—åˆ°æŸ¥è¯¢è·¯å¾„çš„æ‰§è¡Œä»£ä»·ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯å®é™…æ‰§è¡Œè¿™ä¸ªæŸ¥è¯¢è®¡åˆ’ï¼Œä¸è¿‡è¿™æ ·å­åšå°±å¤±å»äº†ä¼˜åŒ–å™¨çš„æ„ä¹‰ã€‚ä¸è¿‡ï¼Œä¼˜åŒ–å™¨å¹¶ä¸éœ€è¦çŸ¥é“å‡†ç¡®çš„ä»£ä»·ï¼Œåªéœ€è¦ä¸€ä¸ªä¼°ç®—å€¼ï¼Œä»¥ä¾¿èƒ½å¤ŸåŒºåˆ†å¼€ä»£ä»·å·®åˆ«è¾ƒå¤§çš„æ‰§è¡Œè®¡åˆ’ã€‚å› æ­¤ï¼Œæ•°æ®åº“å¸¸å¸¸ä¼šç»´æŠ¤ä¸€äº›å®é™…æ•°æ®çš„æ¦‚æ‹¬ä¿¡æ¯ï¼Œç”¨ä»¥å¿«é€Ÿçš„ä¼°è®¡ä»£ä»·ï¼Œè¿™ä¾¿æ˜¯ç»Ÿè®¡ä¿¡æ¯ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ TiDB ä¸­ï¼Œæˆ‘ä»¬ç»´æŠ¤çš„ç»Ÿè®¡ä¿¡æ¯åŒ…æ‹¬è¡¨çš„æ€»è¡Œæ•°ï¼Œåˆ—çš„ç­‰æ·±ç›´æ–¹å›¾ï¼ŒCount-Min Sketchï¼ŒNull å€¼çš„ä¸ªæ•°ï¼Œå¹³å‡é•¿åº¦ï¼Œä¸åŒå€¼çš„æ•°ç›®ç­‰ç­‰ã€‚ä¸‹é¢ä¼šç®€å•ä»‹ç»ä¸€ä¸‹ç›´æ–¹å›¾å’Œ Count-Min Sketchã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;1. ç›´æ–¹å›¾ç®€ä»‹&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç›´æ–¹å›¾æ˜¯ä¸€ç§å¯¹æ•°æ®åˆ†å¸ƒæƒ…å†µè¿›è¡Œæè¿°çš„å·¥å…·ï¼Œå®ƒä¼šæŒ‰ç…§æ•°æ®çš„å€¼å¤§å°è¿›è¡Œåˆ†æ¡¶ï¼Œå¹¶ç”¨ä¸€äº›ç®€å•çš„æ•°æ®æ¥æè¿°æ¯ä¸ªæ¡¶ï¼Œæ¯”å¦‚è½åœ¨æ¡¶é‡Œçš„å€¼çš„ä¸ªæ•°ã€‚å¤§å¤šæ•°æ•°æ®åº“éƒ½ä¼šé€‰æ‹©ç”¨ç›´æ–¹å›¾æ¥è¿›è¡ŒåŒºé—´æŸ¥è¯¢çš„ä¼°ç®—ã€‚æ ¹æ®åˆ†æ¡¶ç­–ç•¥çš„ä¸åŒï¼Œå¸¸è§çš„ç›´æ–¹å›¾å¯ä»¥åˆ†ä¸ºç­‰æ·±ç›´æ–¹å›¾å’Œç­‰å®½ç›´æ–¹å›¾ã€‚&lt;br&gt;åœ¨ TiDB ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ç­‰æ·±ç›´æ–¹å›¾ï¼Œäº 1984 å¹´åœ¨ &lt;a href=&quot;https://dl.acm.org/citation.cfm?id=602294&quot;&gt;Accurate estimation of the number of tuples satisfying a condition&lt;/a&gt; æ–‡çŒ®ä¸­æå‡ºã€‚ç›¸æ¯”äºç­‰å®½ç›´æ–¹å›¾ï¼Œç­‰æ·±ç›´æ–¹å›¾åœ¨æœ€åæƒ…å†µä¸‹ä¹Ÿå¯ä»¥å¾ˆå¥½çš„ä¿è¯è¯¯å·®ã€‚æ‰€è°“çš„ç­‰æ·±ç›´æ–¹å›¾ï¼Œå°±æ˜¯è½å…¥æ¯ä¸ªæ¡¶é‡Œçš„å€¼æ•°é‡å°½é‡ç›¸ç­‰ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”æ–¹è¯´å¯¹äºç»™å®šçš„é›†åˆ {1.6, 1.9, 1.9, 2.0, 2.4, 2.6, 2.7, 2.7, 2.8, 2.9, 3.4, 3.5}ï¼Œå¹¶ä¸”ç”Ÿæˆ 4 ä¸ªæ¡¶ï¼Œé‚£ä¹ˆæœ€ç»ˆçš„ç­‰æ·±ç›´æ–¹å›¾å°±ä¼šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒåŒ…å«å››ä¸ªæ¡¶ [1.6, 1.9]ï¼Œ[2.0, 2.6]ï¼Œ[2.7, 2.8]ï¼Œ[2.9, 3.5]ï¼Œå…¶æ¡¶æ·±å‡ä¸º 3ã€‚&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-bf267d665f4b4b453b7a83f1828122ae_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;590&quot; data-rawheight=&quot;442&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-bf267d665f4b4b453b7a83f1828122ae&quot; data-watermark-src=&quot;v2-63eda8d9641b1da20ccfb5755e3089b0&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;b&gt;2. Count-Min Sketch ç®€ä»‹&lt;/b&gt;&lt;/p&gt;&lt;p&gt;Count-Min Sketch æ˜¯ä¸€ç§å¯ä»¥å¤„ç†ç­‰å€¼æŸ¥è¯¢ï¼ŒJoin å¤§å°ä¼°è®¡ç­‰çš„æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”å¯ä»¥æä¾›å¾ˆå¼ºçš„å‡†ç¡®æ€§ä¿è¯ã€‚è‡ª 2003 å¹´åœ¨æ–‡çŒ® &lt;a href=&quot;http://dimacs.rutgers.edu/~graham/pubs/papers/cm-full.pdf&quot;&gt;An improved data stream summary: The count-min sketch and its applications&lt;/a&gt; ä¸­æå‡ºä»¥æ¥ï¼Œç”±äºå…¶åˆ›å»ºå’Œä½¿ç”¨çš„ç®€å•æ€§è·å¾—äº†å¹¿æ³›çš„ä½¿ç”¨ã€‚&lt;br&gt;Count-Min Sketch ç»´æŠ¤äº†ä¸€ä¸ª d*w çš„è®¡æ•°æ•°ç»„ï¼Œå¯¹äºæ¯ä¸€ä¸ªå€¼ï¼Œç”¨ d ä¸ªç‹¬ç«‹çš„ hash å‡½æ•°æ˜ å°„åˆ°æ¯ä¸€è¡Œçš„ä¸€åˆ—ä¸­ï¼Œå¹¶å¯¹åº”ä¿®æ”¹è¿™ d ä¸ªä½ç½®çš„è®¡æ•°å€¼ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-a5604bbc47256be098b8aef1079a4a89_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;941&quot; data-rawheight=&quot;379&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a5604bbc47256be098b8aef1079a4a89&quot; data-watermark-src=&quot;v2-e8f042d7cf6b686ef605e28bfb63279e&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;è¿™æ ·åœ¨æŸ¥è¯¢ä¸€ä¸ªå€¼å‡ºç°äº†å¤šå°‘æ¬¡çš„æ—¶å€™ï¼Œä¾æ—§ç”¨ d ä¸ª hash å‡½æ•°æ‰¾åˆ°æ¯ä¸€è¡Œä¸­è¢«æ˜ å°„åˆ°çš„ä½ç½®ï¼Œå–è¿™ d ä¸ªå€¼çš„æœ€å°å€¼ä½œä¸ºä¼°è®¡å€¼ã€‚&lt;/p&gt;&lt;p&gt;ç›´æ–¹å›¾å’Œ CM-Sketch æ˜¯å¸¸ç”¨çš„ä¸¤ç§æ•°æ®æ¦‚è¦æ‰‹æ®µï¼Œæƒ³äº†è§£æ›´å¤šç›¸å…³æŠ€æœ¯ï¼Œå¯ä»¥å‚è€ƒ ã€ŠSynopses for Massive Data: Samples,Histograms, Wavelets, Sketchesã€‹ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ç»Ÿè®¡ä¿¡æ¯åˆ›å»º&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;é€šè¿‡ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬çŸ¥é“ç»Ÿè®¡ä¿¡æ¯ä¸»è¦éœ€è¦åˆ›å»ºå’Œç»´æŠ¤çš„æ˜¯ç›´æ–¹å›¾å’Œ Count-Min Sketchã€‚&lt;br&gt;é€šè¿‡æ‰§è¡Œ analyze è¯­å¥ï¼ŒTiDB ä¼šæ”¶é›†ä¸Šè¿°æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚åœ¨æ‰§è¡Œ analyze è¯­å¥çš„æ—¶å€™ï¼ŒTiDB ä¼šå°† analyze è¯·æ±‚ä¸‹æ¨åˆ°æ¯ä¸€ä¸ª Region ä¸Šï¼Œç„¶åå°†æ¯ä¸€ä¸ª Region çš„ç»“æœåˆå¹¶èµ·æ¥ã€‚å¯¹äº Count-Min Sketchï¼Œå…¶åˆ›å»ºå’Œåˆå¹¶éƒ½æ¯”è¾ƒç®€å•ï¼Œåœ¨è¿™é‡Œç•¥å»ä¸è®²ã€‚ä»¥ä¸‹ä¸»è¦ä»‹ç»åˆ—å’Œç´¢å¼•çš„ç›´æ–¹å›¾çš„åˆ›å»ºã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;1. åˆ—ç›´æ–¹å›¾çš„åˆ›å»º&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨åˆ›å»ºç›´æ–¹å›¾çš„æ—¶å€™ï¼Œéœ€è¦æ•°æ®æ˜¯æœ‰åºçš„ï¼Œè€Œæ’åºçš„ä»£ä»·å¾€å¾€å¾ˆé«˜ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ TiDB ä¸­å®ç°äº†æŠ½æ ·ç®—æ³•ï¼Œå¯¹æŠ½æ ·ä¹‹åçš„æ•°æ®è¿›è¡Œæ’åºï¼Œå»ºç«‹ç›´æ–¹å›¾ï¼Œå³ä¼šåœ¨æ¯ä¸€ä¸ª Region ä¸Šè¿›è¡ŒæŠ½æ ·ï¼Œéšååœ¨åˆå¹¶ç»“æœçš„æ—¶å€™å†è¿›è¡ŒæŠ½æ ·ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ sample.go ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†è“„æ°´æ± æŠ½æ ·ç®—æ³•ï¼Œç”¨æ¥ç”Ÿæˆå‡åŒ€æŠ½æ ·é›†åˆã€‚ä»¤æ ·æœ¬é›†åˆçš„å®¹é‡ä¸º Sï¼Œåœ¨ä»»ä¸€æ—¶åˆ» nï¼Œæ•°æ®æµä¸­çš„å…ƒç´ éƒ½ä»¥ S/n çš„æ¦‚ç‡è¢«é€‰å–åˆ°æ ·æœ¬é›†åˆä¸­å»ã€‚å¦‚æœæ ·æœ¬é›†åˆå¤§å°è¶…å‡º Sï¼Œåˆ™ä»ä¸­éšæœºå»é™¤ä¸€ä¸ªæ ·æœ¬ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æ ·æœ¬æ± å¤§å°ä¸º S = 100 ï¼Œä»å¤´å¼€å§‹æ‰«æå…¨è¡¨ï¼Œå½“è¯»åˆ°çš„è®°å½•ä¸ªæ•° n &amp;lt; 100 æ—¶ï¼Œä¼šæŠŠæ¯ä¸€æ¡è®°å½•éƒ½åŠ å…¥é‡‡æ ·æ± ï¼Œè¿™æ ·ä¿è¯äº†åœ¨è®°å½•æ€»æ•°å°äºé‡‡æ ·æ± å¤§å°æ—¶ï¼Œæ‰€æœ‰è®°å½•éƒ½ä¼šè¢«é€‰ä¸­ã€‚è€Œå½“æ‰«æåˆ°çš„ç¬¬ n = 101 æ¡æ—¶ï¼Œç”¨æ¦‚ç‡ P = S/n = 100â„101 å†³å®šæ˜¯å¦æŠŠè¿™ä¸ªæ–°çš„è®°å½•åŠ å…¥é‡‡æ ·æ± ï¼Œå¦‚æœåŠ å…¥äº†é‡‡æ ·æ± ï¼Œé‡‡æ ·æ± çš„æ€»æ•°ä¼šè¶…è¿‡ S çš„é™åˆ¶ï¼Œè¿™æ—¶éœ€è¦éšæœºé€‰æ‹©ä¸€ä¸ªæ—§çš„é‡‡æ ·ä¸¢æ‰ï¼Œä¿è¯é‡‡æ ·æ± å¤§å°ä¸ä¼šè¶…è¿‡é™åˆ¶ã€‚&lt;/p&gt;&lt;p&gt;é‡‡æ ·å®Œæˆåï¼Œå°†æ‰€æœ‰çš„æ•°æ®æ’åºï¼Œç”±äºçŸ¥é“é‡‡æ ·è¿‡åæ€»çš„è¡Œæ•°å’Œç›´æ–¹å›¾çš„æ¡¶æ•°ï¼Œå› æ­¤å°±å¯ä»¥çŸ¥é“æ¯ä¸ªæ¡¶çš„æ·±åº¦ã€‚è¿™æ ·å°±å¯ä»¥é¡ºåºéå†æ¯ä¸ªå€¼ Vï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;å¦‚æœ V ç­‰äºä¸Šä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆæŠŠ V æ”¾åœ¨ä¸ä¸Šä¸€ä¸ªå€¼åŒä¸€ä¸ªæ¡¶é‡Œï¼Œæ— è®ºæ¡¶æ˜¯ä¸æ˜¯å·²ç»æ»¡ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯ä¸ªå€¼åªå­˜åœ¨äºä¸€ä¸ªæ¡¶ä¸­ã€‚&lt;/li&gt;&lt;li&gt;å¦‚æœä¸ç­‰äºï¼Œé‚£ä¹ˆåˆ¤æ–­å½“å‰æ¡¶æ˜¯å¦å·²ç»æ»¡ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œå°±ç›´æ¥æ”¾å…¥å½“å‰æ¡¶ï¼Œå¦åˆ™çš„è¯ï¼Œå°±æ”¾å…¥ä¸‹ä¸€ä¸ªæ¡¶ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;b&gt;2. ç´¢å¼•ç›´æ–¹å›¾çš„åˆ›å»º&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨å»ºç«‹ç´¢å¼•åˆ—ç›´æ–¹å›¾çš„æ—¶å€™ï¼Œç”±äºä¸èƒ½äº‹å…ˆçŸ¥é“æœ‰å¤šå°‘è¡Œçš„æ•°æ®ï¼Œä¹Ÿå°±ä¸èƒ½ç¡®å®šæ¯ä¸€ä¸ªæ¡¶çš„æ·±åº¦ï¼Œä¸è¿‡ç”±äºç´¢å¼•åˆ—çš„æ•°æ®æ˜¯å·²ç»æœ‰åºçš„ï¼Œå› æ¬¡å¯ä»¥é‡‡ç”¨å¦‚ä¸‹ç®—æ³•ï¼šåœ¨ç¡®å®šäº†æ¡¶çš„ä¸ªæ•°ä¹‹åï¼Œå°†æ¯ä¸ªæ¡¶çš„åˆå§‹æ·±åº¦è®¾ä¸º 1ï¼Œç”¨å‰é¢åˆ—ç›´æ–¹å›¾çš„åˆ›å»ºæ–¹æ³•æ’å…¥æ•°æ®ï¼Œè¿™æ ·å¦‚æœåˆ°æŸä¸€æ—¶åˆ»æ‰€éœ€æ¡¶çš„ä¸ªæ•°è¶…è¿‡äº†å½“å‰æ¡¶æ·±åº¦ï¼Œé‚£ä¹ˆå°†æ¡¶æ·±æ‰©å¤§ä¸€å€ï¼Œå°†ä¹‹å‰çš„æ¯ä¸¤ä¸ªæ¡¶åˆå¹¶ä¸º 1 ä¸ªï¼Œç„¶åç»§ç»­æ’å…¥ã€‚&lt;/p&gt;&lt;p&gt;åœ¨æ”¶é›†äº†æ¯ä¸€ä¸ª Region ä¸Šåˆ†åˆ«å»ºç«‹çš„ç›´æ–¹å›¾åï¼Œè¿˜éœ€è¦æŠŠæ¯ä¸ª Region ä¸Šçš„ç›´æ–¹å›¾è¿›è¡Œåˆå¹¶ã€‚å¯¹äºä¸¤ä¸ªç›¸é‚» Region ä¸Šçš„ç›´æ–¹å›¾ï¼Œç”±äºç´¢å¼•æ˜¯æœ‰åºçš„ï¼Œå› æ­¤å‰ä¸€ä¸ªçš„ä¸Šç•Œä¸ä¼šå¤§äºåä¸€ä¸ªçš„ä¸‹ç•Œã€‚ä¸è¿‡ä¸ºäº†ä¿è¯æ¯ä¸ªå€¼åªåœ¨ä¸€ä¸ªæ¡¶é‡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦å…ˆå¤„ç†ä¸€ä¸‹äº¤ç•Œå¤„æ¡¶çš„é—®é¢˜ï¼Œå³å¦‚æœäº¤ç•Œå¤„ä¸¤ä¸ªæ¡¶çš„ä¸Šç•Œå’Œä¸‹ç•Œç›¸ç­‰ï¼Œé‚£ä¹ˆéœ€è¦å…ˆåˆå¹¶è¿™ä¸¤ä¸ªæ¡¶ã€‚å¦‚æœç›´æ–¹å›¾åˆå¹¶ä¹‹åæ¡¶çš„ä¸ªæ•°è¶…è¿‡äº†é™åˆ¶ï¼Œé‚£ä¹ˆåªéœ€è¦æŠŠä¸¤ä¸¤ç›¸é‚»çš„æ¡¶åˆäºŒä¸ºä¸€ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ç»Ÿè®¡ä¿¡æ¯ç»´æŠ¤&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;åœ¨ 2.0 ç‰ˆæœ¬ä¸­ï¼ŒTiDB å¼•å…¥äº†åŠ¨æ€æ›´æ–°æœºåˆ¶ï¼ˆ2.0 ç‰ˆæœ¬é»˜è®¤æ²¡æœ‰æ‰“å¼€ï¼Œ 2.1-beta ç‰ˆæœ¬ä¸­å·²ç»é»˜è®¤æ‰“å¼€ï¼‰ï¼Œå¯ä»¥æ ¹æ®æŸ¥è¯¢çš„ç»“æœå»åŠ¨æ€è°ƒæ•´ç»Ÿè®¡ä¿¡æ¯ã€‚å¯¹äºç›´æ–¹å›¾ï¼Œéœ€è¦è°ƒæ•´æ¡¶é«˜å’Œæ¡¶çš„è¾¹ç•Œï¼›å¯¹äº CM Sketchï¼Œéœ€è¦è°ƒæ•´è®¡æ•°æ•°ç»„ï¼Œä½¿å¾—ä¼°è®¡å€¼å’ŒæŸ¥è¯¢çš„ç»“æœç›¸ç­‰ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;1. æ¡¶é«˜çš„æ›´æ–°&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨èŒƒå›´æŸ¥è¯¢çš„æ—¶å€™ï¼Œæ¶‰åŠçš„æ¡¶éƒ½æœ‰å¯èƒ½å¯¹æœ€ç»ˆçš„ç»“æœè´¡çŒ®ä¸€äº›è¯¯å·®ã€‚å› æ­¤ï¼Œä¸€ç§æ›´æ–°çš„æ–¹æ³•ä¾¿æ˜¯å‡å®šæ‰€æœ‰æ¡¶è´¡çŒ®çš„è¯¯å·®éƒ½æ˜¯å‡åŒ€çš„ï¼Œå³å¦‚æœæœ€ç»ˆä¼°è®¡çš„ç»“æœä¸º Eï¼Œå®é™…çš„ç»“æœä¸º Rï¼ŒæŸä¸€ä¸ªæ¡¶çš„ä¼°è®¡ç»“æœä¸º b = æ¡¶é«˜ h * è¦†ç›–æ¯”ä¾‹ rï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†è¿™ä¸ªæ¡¶çš„æ¡¶é«˜è°ƒæ•´ä¸º (b / r) * (R / E) = h * (R / E)ã€‚ä¸è¿‡å¦‚æœå¯ä»¥çŸ¥é“è½åœ¨æ¯ä¸€ä¸ªæ¡¶èŒƒå›´ä¸­çš„å®é™…ç»“æœï¼Œä¾¿å¯ä»¥ä¸å»å‡å®šæ‰€æœ‰æ¡¶è´¡çŒ®çš„è¯¯å·®éƒ½æ˜¯å‡åŒ€çš„ã€‚&lt;/p&gt;&lt;p&gt;ä¸ºäº†çŸ¥é“è½åœ¨æ¯ä¸€ä¸ªæ¡¶èŒƒå›´ä¸­çš„å®é™…ç»“æœï¼Œéœ€è¦å…ˆæŠŠæŸ¥è¯¢çš„èŒƒå›´æŒ‰ç…§ç›´æ–¹å›¾æ¡¶çš„è¾¹ç•Œåˆ‡åˆ†æˆä¸ç›¸äº¤çš„éƒ¨åˆ†ï¼Œè¿™æ ·åœ¨ TiKV åœ¨æ‰§è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œå¯ä»¥ç»Ÿè®¡å‡ºæ¯ä¸€ä¸ªèŒƒå›´ä¸­å®é™…å«æœ‰çš„è¡Œæ•°ç›®ã€‚è¿™æ ·æˆ‘ä»¬ä¾¿å¯ä»¥æŒ‰ç…§ç±»ä¼¼äºå‰è¿°çš„æ–¹æ³•è°ƒæ•´æ¯ä¸€ä¸ªæ¡¶ï¼Œä¸è¿‡è¿™ä¸ªæ—¶å€™ä¸éœ€è¦å‡å®šæ¯ä¸ªæ¡¶è´¡çŒ®çš„è¯¯å·®éƒ½æ˜¯å‡åŒ€çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å‡†ç¡®çŸ¥é“æ¯ä¸€ä¸ªæ¡¶è´¡çŒ®çš„è¯¯å·®ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;2. æ¡¶è¾¹ç•Œçš„æ›´æ–°&lt;/b&gt;&lt;/p&gt;&lt;p&gt;åœ¨ç”¨ç›´æ–¹å›¾ä¼°è®¡çš„æ—¶å€™ï¼Œå¯¹äºé‚£äº›åªè¢«æŸ¥è¯¢èŒƒå›´è¦†ç›–äº†ä¸€éƒ¨åˆ†çš„æ¡¶ï¼Œä¸»è¦çš„è¯¯å·®æ¥è‡ªè¿ç»­å¹³å‡åˆ†å¸ƒå‡è®¾ã€‚è¿™æ ·æ¡¶è¾¹ç•Œæ›´æ–°çš„ä¸»è¦ç›®ä¾¿æ˜¯ä½¿å¾—æŸ¥è¯¢çš„è¾¹ç•Œèƒ½å°½é‡çš„è½åœ¨ä¸æ¡¶çš„è¾¹ç•Œä¸è¿œçš„åœ°æ–¹ã€‚æ¡¶è¾¹ç•Œçš„æ›´æ–°ä¸»è¦æ–¹æ³•åŒ…æ‹¬åˆ†è£‚å’Œåˆå¹¶ã€‚&lt;br&gt;å¯¹äºåˆ†è£‚ï¼Œéœ€è¦è§£å†³çš„é—®é¢˜æ˜¯å“ªäº›æ¡¶éœ€è¦åˆ†è£‚ï¼Œåˆ†è£‚æˆå‡ ä¸ªï¼Œåˆ†è£‚çš„è¾¹ç•Œåœ¨å“ªé‡Œï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;å“ªäº›æ¡¶éœ€è¦åˆ†è£‚ï¼Œåˆ†è£‚æˆå‡ ä¸ªï¼šå¦‚æœå†³å®šäº†æ¯ä¸€æ¬¡æ›´æ–°æœ€å¤šåˆ†è£‚ 10 ä¸ªæ¡¶ï¼Œé‚£ä¹ˆå¦‚æœä¸€ä¸ªæ¡¶ä¸Šè½å…¥äº† 10% çš„æŸ¥è¯¢ç‚¹ï¼Œé‚£ä¸ªè¿™ä¸ªæ¡¶å°±å¯ä»¥åˆ†è£‚ä¸€æ¬¡ï¼Œå¦‚æœè½å…¥äº† 20% çš„æŸ¥è¯¢ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡¶å°±å¯ä»¥åˆ†è£‚ä¸¤æ¬¡ï¼Œä»¥æ­¤ç±»æ¨ã€‚&lt;/li&gt;&lt;li&gt;åˆ†è£‚çš„è¾¹ç•Œï¼šç”±äºç›®æ ‡æ˜¯ä½¿å¾—æŸ¥è¯¢çš„è¾¹ç•Œèƒ½å°½é‡çš„è½åœ¨ä¸æ¡¶çš„è¾¹ç•Œä¸è¿œçš„åœ°æ–¹ï¼Œé‚£ä¹ˆå¦‚æœè¿™ä¸ªæ¡¶è¦åˆ†è£‚ N æ¬¡ï¼Œå°±éœ€è¦é€‰æ‹©ä¸è¶…è¿‡ N ä¸ªæŸ¥è¯¢ç‚¹ï¼Œä½¿å¾—å‰©ä¸‹çš„æŸ¥è¯¢ç‚¹ä¸è¿™ N ä¸ªæŸ¥è¯¢ç‚¹çš„æœ€è¿‘è·ç¦»ä¹‹å’Œæœ€å°ã€‚ä¸è¿‡è¿™ç§æ–¹æ³•æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨æ¯”è¾ƒç®€å•çš„æ–¹æ³•ï¼Œå³å‡å®šæ¯ä¸ªä¸åŒçš„æŸ¥è¯¢ç‚¹ä¹‹é—´çš„è·ç¦»éƒ½æ˜¯ç›¸ç­‰çš„ï¼Œè¿™æ ·åªéœ€è¦æ¯éš”å‡ ä¸ªç‚¹å–ä¸€ä¸ªä½œä¸ºè¾¹ç•Œå°±å¯ä»¥ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;åˆ†è£‚å®Œæˆåï¼Œæˆ‘ä»¬è¿˜è¦å»åˆå¹¶æ¡¶ã€‚é¦–å…ˆåˆ†è£‚å¾—æ¥çš„æ¡¶æ˜¯ä¸èƒ½åˆå¹¶çš„ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œè€ƒè™‘è¿ç»­çš„ä¸¤ä¸ªæ¡¶ï¼Œå¦‚æœç¬¬ä¸€ä¸ªæ¡¶å åˆå¹¶åæ¡¶çš„æ¯”ä¾‹ä¸º rï¼Œé‚£ä¹ˆä»¤åˆå¹¶åäº§ç”Ÿçš„è¯¯å·®ä¸º abs(åˆå¹¶å‰ç¬¬ä¸€ä¸ªæ¡¶çš„é«˜åº¦ - r * ä¸¤ä¸ªæ¡¶çš„é«˜åº¦å’Œ) / åˆå¹¶å‰ç¬¬ä¸€ä¸ªæ¡¶çš„é«˜åº¦ï¼Œå°±åªéœ€è¦å»åˆå¹¶è¯¯å·®æœ€å°çš„é‚£äº›è¿ç»­çš„æ¡¶ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;3. Count-Min Sketch çš„æ›´æ–°&lt;/b&gt;&lt;/p&gt;&lt;p&gt;CM Sketch çš„æ›´æ–°æ¯”è¾ƒç®€å•ï¼Œå¯¹äºæŸä¸€ä¸ªç­‰å€¼æŸ¥è¯¢çš„åé¦ˆç»“æœ xï¼Œå…¶ä¼°è®¡å€¼æ˜¯ yï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°†è¿™ä¸ªå€¼æ¶‰åŠåˆ°çš„æ‰€æœ‰ç‚¹åŠ ä¸Š c = x-yã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ç»Ÿè®¡ä¿¡æ¯ä½¿ç”¨&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;åœ¨æŸ¥è¯¢è¯­å¥ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šä½¿ç”¨ä¸€äº›è¿‡æ»¤æ¡ä»¶ï¼Œè€Œç»Ÿè®¡ä¿¡æ¯ä¼°ç®—çš„ä¸»è¦ä½œç”¨å°±æ˜¯ä¼°è®¡ç»è¿‡è¿™äº›è¿‡æ»¤æ¡ä»¶åçš„æ•°æ®æ¡æ•°ï¼Œä»¥ä¾¿ä¼˜åŒ–å™¨é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚åœ¨è¿™ç¯‡ &lt;a href=&quot;https://github.com/pingcap/docs-cn/blob/master/sql/understanding-the-query-execution-plan.md#explain-%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F&quot;&gt;æ–‡æ¡£&lt;/a&gt; ä¸­ï¼Œä»‹ç»åˆ° explain è¾“å‡ºç»“æœä¸­ä¼šåŒ…å«çš„ä¸€åˆ— countï¼Œå³é¢„è®¡å½“å‰ operator ä¼šè¾“å‡ºçš„æ•°æ®æ¡æ•°ï¼Œä¾¿æ˜¯åŸºäºç»Ÿè®¡ä¿¡æ¯ä»¥åŠ operator çš„æ‰§è¡Œé€»è¾‘ä¼°ç®—è€Œæ¥ã€‚&lt;br&gt;åœ¨è¿™ä¸ªéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä¼šå…ˆä»æœ€ç®€å•çš„å•ä¸€åˆ—ä¸Šçš„è¿‡æ»¤æ¡ä»¶å¼€å§‹ï¼Œç„¶åè€ƒè™‘å¦‚ä½•å¤„ç†å¤šåˆ—çš„æƒ…å†µã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;1. èŒƒå›´æŸ¥è¯¢&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å¯¹äºæŸä¸€åˆ—ä¸Šçš„èŒƒå›´æŸ¥è¯¢ï¼ŒTiDB é€‰æ‹©äº†å¸¸ç”¨çš„ç­‰æ·±ç›´æ–¹å›¾æ¥è¿›è¡Œä¼°ç®—ã€‚&lt;/p&gt;&lt;p&gt;åœ¨å‰é¢ä»‹ç»ç­‰æ·±ç›´æ–¹å›¾æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªåŒ…å«å››ä¸ªæ¡¶ [1.6, 1.9]ï¼Œ[2.0, 2.6]ï¼Œ[2.7, 2.8]ï¼Œ[2.9, 3.5]ï¼Œå…¶æ¡¶æ·±å‡ä¸º 3 çš„ç›´æ–¹å›¾ã€‚å‡è®¾æˆ‘ä»¬å¾—åˆ°äº†è¿™æ ·ä¸€ä¸ªç›´æ–¹å›¾ï¼Œå¹¶ä¸”æƒ³çŸ¥é“è½åœ¨åŒºé—´ [1.7, 2.8] èŒƒå›´å†…çš„æœ‰å¤šå°‘å€¼ã€‚æŠŠè¿™ä¸ªåŒºé—´å¯¹åº”åˆ°ç›´æ–¹å›¾ä¸Šï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ªæ¡¶æ˜¯è¢«å®Œå…¨è¦†ç›–çš„ï¼Œå³æ¡¶ [2.0, 2.6] å’Œæ¡¶ [2.7ï¼Œ2.8]ï¼Œå› æ­¤åŒºé—´ [2.0, 2.8] å†…ä¸€å…±æœ‰ 6 ä¸ªå€¼ï¼›ä½†æ˜¯ç¬¬ä¸€ä¸ªæ¡¶åªè¢«è¦†ç›–äº†ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆé—®é¢˜å°±å˜æˆäº†å·²ç»çŸ¥é“åŒºé—´ [1.6, 1.9] èŒƒå›´å†…æœ‰ 3 ä¸ªå€¼ï¼Œæ€æ ·ä¼°ç®— [1.7, 1.9] å†…æœ‰å¤šå°‘ä¸ªå€¼å‘¢ï¼Ÿä¸€ä¸ªå¸¸ç”¨çš„æ–¹æ³•æ˜¯å‡è®¾è¿™ä¸ªèŒƒå›´çš„å€¼æ˜¯è¿ç»­ä¸”å‡åŒ€çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§æŸ¥èŒƒå›´å æ¡¶çš„æ¯”ä¾‹å»ä¼°ç®—ï¼Œä¹Ÿå°±æ˜¯ (1.9 - 1.7) / (1.9 - 1.6) * 3 = 2ã€‚&lt;/p&gt;&lt;p&gt;ä¸è¿‡è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ä¼°ç®—çš„æ—¶å€™è¦å»ç®—æ¯”ä¾‹ï¼Œè¿™å¯¹äºæ•°å€¼ç±»å‹å¾ˆç®€å•ï¼Œå¯¹äºå…¶ä»–ç±»å‹ï¼Œæ¯”æ–¹è¯´å­—ç¬¦ä¸²ç±»å‹æ€ä¹ˆåŠå‘¢ï¼Ÿä¸€ä¸ªæ–¹æ³•æ˜¯æŠŠå­—ç¬¦ä¸²æ˜ å°„æˆæ•°å­—ï¼Œç„¶åè®¡ç®—æ¯”ä¾‹ï¼Œå…·ä½“å¯ä»¥å‚è§ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/statistics/scalar.go&quot;&gt;statistics/scalar.go&lt;/a&gt;ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;2. ç­‰å€¼æŸ¥è¯¢&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å¯¹äºç±»ä¼¼æŸ¥è¯¢ç­‰äºæŸä¸ªå€¼çš„è¿™æ ·çš„ç­‰å€¼æŸ¥è¯¢ï¼Œç›´æ–¹å›¾å°±æ‰è¥Ÿè§è‚˜äº†ã€‚ä¸€èˆ¬å¸¸ç”¨çš„ä¼°è®¡æ–¹æ³•æ˜¯å‡è®¾æ¯ä¸ªå€¼å‡ºç°çš„æ¬¡æ•°éƒ½ç›¸ç­‰ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ï¼ˆæ€»è¡Œæ•°/ä¸åŒå€¼çš„æ•°é‡ï¼‰æ¥ä¼°è®¡ã€‚ä¸è¿‡åœ¨ TiDB ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©äº† Count-Min Sketch çš„æ¥è¿›è¡Œç­‰å€¼æŸ¥è¯¢çš„ä¼°ç®—ã€‚&lt;/p&gt;&lt;p&gt;ç”±äº Count-Min Sketch ä¼°è®¡çš„ç»“æœæ€»æ˜¯ä¸å°äºå®é™…å€¼ï¼Œå› æ­¤åœ¨ TiDB ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©äº†æ–‡çŒ® &lt;a href=&quot;http://webdocs.cs.ualberta.ca/~drafiei/papers/cmm.pdf&quot;&gt;New estimation algorithms for streaming data: Count-min can do more&lt;/a&gt; ä¸­æå‡ºäº†ä¸€ç§ Count-Mean-Min Sketchï¼Œå…¶ä¸ Count-Min Sketch åœ¨æ›´æ–°çš„æ—¶å€™æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«åœ¨ä¸æŸ¥è¯¢çš„æ—¶å€™ï¼šå¯¹äºæ¯ä¸€è¡Œ iï¼Œè‹¥ hash å‡½æ•°æ˜ å°„åˆ°äº†å€¼ jï¼Œé‚£ä¹ˆç”¨ &lt;code class=&quot;inline&quot;&gt;(N - CM[i, j]) / (w-1)&lt;/code&gt;ï¼ˆN æ˜¯æ€»å…±çš„æ’å…¥çš„å€¼æ•°é‡ï¼‰ä½œä¸ºå…¶ä»–å€¼äº§ç”Ÿçš„å™ªéŸ³ï¼Œå› æ­¤ç”¨ &lt;code class=&quot;inline&quot;&gt;CM[i,j] - (N - CM[i, j]) / (w-1)&lt;/code&gt; è¿™ä¸€è¡Œçš„ä¼°è®¡å€¼ï¼Œç„¶åç”¨æ‰€æœ‰è¡Œçš„ä¼°è®¡å€¼çš„ä¸­ä½æ•°ä½œä¸ºæœ€åçš„ä¼°è®¡å€¼ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;3. å¤šåˆ—æŸ¥è¯¢&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ä¸Šé¢ä¸¤ä¸ªå°èŠ‚ä»‹ç»äº† TiDB æ˜¯å¦‚ä½•å¯¹å•åˆ—ä¸Šçš„æŸ¥è¯¢æ¡ä»¶è¿›è¡Œä¼°è®¡çš„ï¼Œä¸è¿‡å®é™…çš„æŸ¥è¯¢è¯­å¥ä¸­å¾€å¾€åŒ…å«å¤šä¸ªåˆ—ä¸Šçš„å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä½•å¤„ç†å¤šåˆ—çš„æƒ…å†µã€‚åœ¨ TiDB ä¸­ï¼Œselectivity.go ä¸­çš„ &lt;code class=&quot;inline&quot;&gt;Selectivity&lt;/code&gt; å‡½æ•°å®ç°äº†è¿™ä¸ªåŠŸèƒ½ï¼Œå®ƒæ˜¯ç»Ÿè®¡ä¿¡æ¯æ¨¡å—å¯¹ä¼˜åŒ–å™¨æä¾›çš„æœ€é‡è¦çš„æ¥å£ã€‚&lt;/p&gt;&lt;p&gt;åœ¨å¤„ç†å¤šåˆ—ä¹‹é—´çš„æŸ¥è¯¢æ¡ä»¶çš„æ—¶å€™ï¼Œä¸€ä¸ªå¸¸è§çš„åšæ³•æ˜¯è®¤ä¸ºä¸åŒåˆ—ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æŠŠä¸åŒåˆ—ä¹‹é—´çš„è¿‡æ»¤ç‡ä¹˜èµ·æ¥ã€‚ä¸è¿‡ï¼Œå¯¹äºç´¢å¼•ä¸Šçš„å¯ä»¥ç”¨æ¥æ„é€ ç´¢å¼•æ‰«æçš„èŒƒå›´çš„è¿‡æ»¤æ¡ä»¶ï¼Œå³å¯¹äºä¸€ä¸ª &lt;code class=&quot;inline&quot;&gt;(a, b, c)&lt;/code&gt; è¿™æ ·çš„ç´¢å¼•ï¼Œç±»ä¼¼ &lt;code class=&quot;inline&quot;&gt;(a = 1 and b = 1 and c &amp;lt; 5)&lt;/code&gt; æˆ–è€… &lt;code class=&quot;inline&quot;&gt;(a = 1 and b = 1)&lt;/code&gt; è¿™æ ·çš„æ¡ä»¶ï¼Œå°†ç´¢å¼•ä¸­çš„å€¼ç¼–ç åï¼Œå°±å¯ä»¥ç”¨å‰é¢æåˆ°çš„æ–¹æ³•è¿›è¡Œä¼°ç®—ï¼Œè¿™æ ·å°±ä¸éœ€è¦å‡å®šåˆ—ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚&lt;/p&gt;&lt;p&gt;å› æ­¤ï¼Œ&lt;code class=&quot;inline&quot;&gt;Selectivity&lt;/code&gt; çš„ä¸€ä¸ªæœ€é‡è¦çš„ä»»åŠ¡å°±æ˜¯å°†æ‰€æœ‰çš„æŸ¥è¯¢æ¡ä»¶åˆ†æˆå°½é‡å°‘çš„ç»„ï¼Œä½¿å¾—æ¯ä¸€ç»„ä¸­çš„æ¡ä»¶éƒ½å¯ä»¥ç”¨æŸä¸€åˆ—æˆ–è€…æŸä¸€ç´¢å¼•ä¸Šçš„ç»Ÿè®¡ä¿¡æ¯è¿›è¡Œä¼°è®¡ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åšå°½é‡å°‘çš„ç‹¬ç«‹æ€§å‡è®¾ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ &lt;code class=&quot;inline&quot;&gt;Selectivity&lt;/code&gt; ä¸­ï¼Œé¦–å…ˆè®¡ç®—äº†æ¯ä¸€åˆ—å’Œæ¯ä¸€ä¸ªç´¢å¼•å¯ä»¥è¦†ç›–çš„è¿‡æ»¤æ¡ä»¶ï¼Œå¹¶ç”¨ä¸€ä¸ª &lt;code class=&quot;inline&quot;&gt;int64&lt;/code&gt; æ¥å½“åšä¸€ä¸ª bitsetï¼Œå°†è¯¥åˆ—å¯ä»¥è¦†ç›–çš„è¿‡æ»¤æ¡ä»¶çš„ä½ç½®ç½®ä¸º 1ã€‚æ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯é€‰æ‹©å°½é‡å°‘çš„ bitsetï¼Œæ¥è¦†ç›–å°½é‡å¤šçš„è¿‡æ»¤æ¡ä»¶ï¼Œåœ¨è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†è´ªå¿ƒç®—æ³•ï¼Œå³æ¯ä¸€æ¬¡åœ¨è¿˜æ²¡æœ‰ä½¿ç”¨çš„ bitset ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªå¯ä»¥è¦†ç›–æœ€å¤šå°šæœªè¦†ç›–çš„è¿‡æ»¤æ¡ä»¶ã€‚æœ€åä¸€æ­¥ä¾¿æ˜¯ç”¨å‰é¢æåˆ°çš„æ–¹æ³•å¯¹æ¯ä¸€ä¸ªåˆ—å’Œæ¯ä¸€ä¸ªç´¢å¼•ä¸Šçš„ç»Ÿè®¡ä¿¡æ¯è¿›è¡Œä¼°è®¡ï¼Œå¹¶ç”¨ç‹¬ç«‹æ€§å‡è®¾å°†å®ƒä»¬ç»„åˆèµ·æ¥å½“åšæœ€ç»ˆçš„ç»“æœã€‚&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼š&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38572730&quot;&gt;ï¼ˆåä¸€ï¼‰Index Lookup Join&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38095421&quot;&gt;ï¼ˆåï¼‰Chunk å’Œæ‰§è¡Œæ¡†æ¶ç®€ä»‹&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/37773956&quot;&gt;ï¼ˆä¹ï¼‰Hash Join&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/36420449&quot;&gt;ï¼ˆå…«ï¼‰åŸºäºä»£ä»·çš„ä¼˜åŒ–&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/35511864&quot;&gt;ï¼ˆä¸ƒï¼‰åŸºäºè§„åˆ™çš„ä¼˜åŒ–&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/35134962&quot;&gt;ï¼ˆå…­ï¼‰Select è¯­å¥æ¦‚è§ˆ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34770765&quot;&gt;ï¼ˆäº”ï¼‰TiDB SQL Parser çš„å®ç°&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34512827&quot;&gt;ï¼ˆå››ï¼‰Insert è¯­å¥æ¦‚è§ˆ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34369624&quot;&gt;ï¼ˆä¸‰ï¼‰SQL çš„ä¸€ç”Ÿ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34176614&quot;&gt;ï¼ˆäºŒï¼‰åˆè¯† TiDB æºç &lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34109413&quot;&gt;ï¼ˆä¸€ï¼‰åº&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-07-06-39139693</guid>
<pubDate>Fri, 06 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>TiDB åœ¨ç‰¹æ¥ç”µçš„å®è·µ</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-07-01-38760049.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38760049&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-a456a06b62972dd2a47920e3097ca383_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;h2&gt;&lt;b&gt;èƒŒæ™¯ä»‹ç»&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;ç‰¹æ¥ç”µæ–°èƒ½æºæœ‰é™å…¬å¸æ˜¯åˆ›ä¸šæ¿ç¬¬ä¸€è‚¡ç‰¹é”å¾·ï¼ˆ300001ï¼‰çš„å…¨èµ„å­å…¬å¸ï¼Œä¸»è¦ä»äº‹æ–°èƒ½æºæ±½è½¦å……ç”µç½‘çš„å»ºè®¾ã€è¿è¥åŠäº’è”ç½‘çš„å¢å€¼æœåŠ¡ã€‚ç‰¹æ¥ç”µé¢ è¦†äº†ä¼ ç»Ÿå……ç”µæ¡©çš„æ¨¡å¼ï¼Œä¸–ç•Œé¦–åˆ›äº†ç”µåŠ¨æ±½è½¦ç¾¤æ™ºèƒ½å……ç”µç³»ç»Ÿï¼Œè·å¾— 336 é¡¹æŠ€æœ¯ä¸“åˆ©ï¼Œä»¥â€œæ— æ¡©å……ç”µã€æ— ç”µæ’å¤´ã€ç¾¤ç®¡ç¾¤æ§ã€æ¨¡å—ç»“æ„ã€ä¸»åŠ¨é˜²æŠ¤ã€æŸ”æ€§å……ç”µâ€çš„ç‰¹ç‚¹å¼•é¢†ä¸–ç•Œæ–°èƒ½æºæ±½è½¦å……ç”µçš„å‘å±•ï¼Œç³»ç»Ÿçš„é‰´å®šç»“è®ºä¸ºï¼šâ€œäº§å“ä¸–ç•Œé¦–åˆ›ã€æŠ€æœ¯æ°´å¹³å›½é™…é¢†å…ˆã€‚ä¸»åŠ¨æŸ”æ€§å……ç”µå¯¹ç”µæ± å¯¿å‘½å¯ä»¥å»¶é•¿ 30% å·¦å³ï¼Œç”µæ± å……ç”µçš„å®‰å…¨æ€§å¯ä»¥æå‡ 100 å€ä»¥ä¸Šã€‚â€&lt;/p&gt;&lt;p&gt;ç‰¹æ¥ç”µé‡‡ç”¨äº’è”ç½‘æ€ç»´ï¼Œä¾é å›½é™…é¢†å…ˆçš„æ±½è½¦ç¾¤æ™ºèƒ½å……ç”µæŠ€æœ¯å’Œç³»ç»Ÿï¼Œåˆ›æ–°ç”µåŠ¨æ±½è½¦å……ç”µå•†ä¸šæ¨¡å¼ï¼Œå»ºè®¾å…¨å›½æœ€å¤§çš„æ±½è½¦å……ç”µç½‘ï¼Œé€šè¿‡å¤§ç³»ç»Ÿå–ç”µã€å¤§å¹³å°å–è½¦ã€å¤§å…±äº«ç§Ÿè½¦ã€å¤§æ•°æ®ä¿®è½¦ã€å¤§æ”¯ä»˜é‡‘èã€å¤§å®¢æˆ·ç”µå•†ï¼Œæ‰“é€ è®©å®¢æˆ·æ»¡æ„ã€æ”¿åºœæ”¾å¿ƒçš„ä¸­å›½æœ€å¤§æ±½è½¦å……ç”µç½‘ç”Ÿæ€å…¬å¸ï¼Œå¼•é¢†å……ç”µç½‘ã€è½¦è”ç½‘ã€äº’è”ç½‘â€œä¸‰ç½‘èåˆâ€çš„æ–°èƒ½æºäº’è”ç½‘ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ä¸ºä»€ä¹ˆç ”ç©¶ TiDB&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;ç‰¹æ¥ç”µå¤§æ•°æ®å¹³å°é€šè¿‡å¼€æºä¸è‡ªç ”ç›¸ç»“åˆçš„æ–¹å¼ï¼Œç›®å‰å·²ç»ä¸Šçº¿å¤šå¥—é›†ç¾¤æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ã€‚ç›®å‰åœ¨å¤§æ•°æ®å­˜å‚¨å’Œè®¡ç®—æ–¹é¢ä¸»è¦ä½¿ç”¨äº† HBaseã€Elasticsearchã€Druidã€Sparkã€Flinkã€‚å¤§æ•°æ®æŠ€æœ¯å¯è°“æ˜¯ç™¾èŠ±é½æ”¾ã€ç™¾å®¶äº‰é¸£ï¼Œä¸åŒçš„æŠ€æœ¯éƒ½æœ‰é’ˆå¯¹æ€§çš„åœºæ™¯ã€‚ç»“åˆå®é™…æƒ…å†µï¼Œé€‰æ‹©åˆé€‚çš„æŠ€æœ¯ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚&lt;/p&gt;&lt;p&gt;éšç€æ¥å…¥å¤§æ•°æ®å¹³å°çš„æ ¸å¿ƒä¸šåŠ¡çš„å¢åŠ ï¼Œæˆ‘ä»¬åœ¨ OLAP ä¸Šä¸»è¦é‡åˆ°ä»¥ä¸‹ç—›ç‚¹é—®é¢˜ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;éšç€åŸºäºå¤§æ•°æ®åˆ†æè®¡ç®—çš„æ·±å…¥åº”ç”¨ï¼Œä½¿ç”¨ SQL è¿›è¡Œåˆ†æçš„éœ€æ±‚è¶Šæ¥è¶Šæ—ºç››ï¼Œä½†ç›®å‰å·²ç»ä¸Šçº¿çš„å¤§æ•°æ®é›†ç¾¤ï¼ˆ HBaseã€Elasticsearchã€Druidã€Sparkã€Flinkï¼‰å¯¹ SQL çš„æ”¯æŒåº¦éƒ½æ¯”è¾ƒå¼±ã€‚&lt;/li&gt;&lt;li&gt;ç›®å‰è¿›å…¥å¤§æ•°æ®é›†ç¾¤çš„æ•°æ®ä¸»è¦ä»¥å®½è¡¨æ–¹å¼è¿›è¡Œï¼Œå¯¼è‡´åœ¨æ•°æ®å½’é›†å’ŒåæœŸåŸºç¡€æ•°æ®æ”¾ç”Ÿå˜åŒ–æ—¶åº”ç”¨æˆæœ¬è¾ƒé«˜ã€‚&lt;/li&gt;&lt;li&gt;æ•°æ®ä»“åº“ä¸šåŠ¡æœ‰äº›è¿˜æ˜¯åŸºäºå¤æ‚çš„ T+1 æ¨¡å¼çš„ ETL è¿‡ç¨‹ï¼Œå»¶æ—¶è¾ƒé«˜ï¼Œä¸èƒ½å®æ—¶çš„åæ˜ ä¸šåŠ¡å˜åŒ–ã€‚&lt;/li&gt;&lt;li&gt;ç”±äºæ¯ä¸ªå¤§æ•°æ®é›†ç¾¤ä¸»è¦é’ˆå¯¹ç‰¹å®šçš„åœºæ™¯ï¼Œæ•°æ®é‡å¤å­˜å‚¨çš„æƒ…å†µè¾ƒå¤šï¼Œè¿™å°±é€ æˆäº†å­˜å‚¨æˆæœ¬çš„å¢åŠ ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚&lt;/li&gt;&lt;li&gt;ç›®å‰è¿›å…¥ HDFS / Druid / ES çš„æ•°æ®ï¼Œåœ¨å†å²æ•°æ®æ›´æ–°æ—¶ï¼Œæˆæœ¬è¾ƒé«˜ï¼Œçµæ´»æ€§é™ä½ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;å¤§æ•°æ®æŠ€æœ¯å‘å±•è¿…é€Ÿï¼Œæˆ‘ä»¬ä¹Ÿä¸€ç›´å¸Œæœ›é‡‡ç”¨æ–°çš„æŠ€æœ¯å¯ä»¥è§£å†³æˆ‘ä»¬ä»¥ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬å…³æ³¨åˆ°ç›®å‰ NewSQL æŠ€æœ¯å·²ç»æœ‰è½åœ°äº§å“ï¼Œå¹¶ä¸”ä¸å°‘ä¼ä¸šåœ¨ä½¿ç”¨ï¼Œæ‰€ä»¥å†³å®šåœ¨æˆ‘ä»¬å¹³å°å†…å°è¯•å¼•å…¥ NewSQL æŠ€æœ¯è§£å†³æˆ‘ä»¬çš„ç—›ç‚¹é—®é¢˜ã€‚&lt;/p&gt;&lt;p&gt;æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ NewSQLã€‚&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-e825ad65efc06df04addcfca0bf8b9c2_r.jpg&quot; data-caption=&quot;å›¾ 1 æ•°æ®åº“å‘å±•å²&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;514&quot; data-rawheight=&quot;301&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-e825ad65efc06df04addcfca0bf8b9c2&quot; data-watermark-src=&quot;v2-e75d9e8c5df1bce001a63c594d263f0d&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;å¦‚å›¾ 1 æ‰€ç¤ºï¼Œæ•°æ®åº“çš„å‘å±•ç»å†äº† RDBMSã€NoSQL ä»¥åŠç°åœ¨çš„ NewSQLï¼Œæ¯ç§ä¸åŒçš„æŠ€æœ¯éƒ½æœ‰å¯¹åº”çš„äº§å“ï¼Œæ¯ç§æ•°æ®åº“çš„æŠ€æœ¯èƒŒåï¼Œéƒ½æœ‰å…¸å‹çš„ç†è®ºæ”¯æ’‘ã€‚2003 å¹´ Google GFS å¼€åˆ›äº†åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€2006 å¹´çš„ BigTable è®ºæ–‡å‚¬ç”Ÿäº† Hadoop ç”Ÿæ€ï¼Œåœ¨ 2012 å¹´çš„ Spanner å’Œ 2013 å¹´çš„ F1 è®ºæ–‡å‘è¡¨åï¼Œè¢«ä¸šç•Œè®¤ä¸ºæŒ‡æ˜äº†æœªæ¥å…³ç³»å‹æ•°æ®åº“çš„å‘å±•ã€‚&lt;/p&gt;&lt;p&gt;éšç€å¤§æ•°æ®æŠ€æœ¯çš„å‘å±•ï¼Œå®é™…ä¸Š SQL å’Œ NoSQL çš„ç•Œé™é€æ¸æ¨¡ç³Šï¼Œæ¯”å¦‚ç°åœ¨ HBase  ä¹‹ä¸Šæœ‰ Phoenixï¼ŒHiveSQLï¼ŒSparkSQL ç­‰ï¼Œä¹Ÿæœ‰ä¸€äº›è§‚ç‚¹è®¤ä¸º NewSQL = SQL + NoSQLã€‚ä¸åŒçš„æŠ€æœ¯éƒ½æœ‰å„è‡ªçš„æœ€ä½³é€‚åº”åœºæ™¯ï¼ŒSpanner å’Œ F1 è¢«è®¤ä¸ºæ˜¯ç¬¬ä¸€ä¸ª NewSQL åœ¨ç”Ÿäº§ç¯å¢ƒæä¾›æœåŠ¡çš„åˆ†å¸ƒå¼ç³»ç»ŸæŠ€æœ¯ï¼ŒåŸºäºè¯¥ç†å¿µçš„å¼€æºäº§å“ä¸»è¦ä¸º CockroachDBã€TiDBã€‚ç»“åˆç¤¾åŒºæ´»è·ƒåº¦ä»¥åŠç›¸å…³æ¡ˆä¾‹ã€æŠ€æœ¯æ”¯æŒï¼Œæˆ‘ä»¬å†³å®š NewSQL  æŠ€æœ¯ä¸Šå¼•å…¥ TiDBã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;TiDB ä»‹ç»&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;TiDB æ˜¯ PingCAP å…¬å¸å— Google Spanner / F1 è®ºæ–‡å¯å‘è€Œè®¾è®¡çš„å¼€æºåˆ†å¸ƒå¼ HTAP æ•°æ®åº“ï¼Œç»“åˆäº†ä¼ ç»Ÿçš„ RDBMS å’Œ NoSQL çš„æœ€ä½³ç‰¹æ€§ã€‚TiDB å…¼å®¹ MySQLï¼Œæ”¯æŒæ— é™çš„æ°´å¹³æ‰©å±•ï¼Œå…·å¤‡å¼ºä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§ã€‚&lt;/p&gt;&lt;img src=&quot;https://pic4.zhimg.com/v2-7ccc03f62389ab498786b59f7fba5bab_r.jpg&quot; data-caption=&quot;å›¾ 2 TiDB æ¶æ„å›¾&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;827&quot; data-rawheight=&quot;393&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-7ccc03f62389ab498786b59f7fba5bab&quot; data-watermark-src=&quot;v2-87924f905d12c2cfb2bd7050e1dd7fbd&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;b&gt;TiDB å…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š&lt;/b&gt;&lt;/p&gt;&lt;ul&gt;&lt;li&gt;é«˜åº¦å…¼å®¹ MySQL â€”â€” æ— éœ€ä¿®æ”¹ä»£ç å³å¯ä» MySQL è½»æ¾è¿ç§»è‡³ TiDB&lt;/li&gt;&lt;li&gt;æ°´å¹³å¼¹æ€§æ‰©å±• â€”â€” è½»æ¾åº”å¯¹é«˜å¹¶å‘ã€æµ·é‡æ•°æ®åœºæ™¯&lt;/li&gt;&lt;li&gt;åˆ†å¸ƒå¼äº‹åŠ¡ â€”â€” TiDB 100% æ”¯æŒæ ‡å‡†çš„ ACID äº‹åŠ¡&lt;/li&gt;&lt;li&gt;é«˜å¯ç”¨ â€”â€” åŸºäº Raft çš„å¤šæ•°æ´¾é€‰ä¸¾åè®®å¯ä»¥æä¾›é‡‘èçº§çš„ 100% æ•°æ®å¼ºä¸€è‡´æ€§ä¿è¯&lt;/li&gt;&lt;li&gt;ä¸€ç«™å¼ HTAP è§£å†³æ–¹æ¡ˆ â€”â€” ä¸€ä»½å­˜å‚¨åŒæ—¶å¤„ç† OLTP &amp;amp; OLAPï¼Œæ— éœ€ä¼ ç»Ÿç¹ççš„ ETL è¿‡ç¨‹&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;å…¶ä¸­æ¶‰åŠåˆ°çš„åˆ†å¸ƒå¼å­˜å‚¨å’Œåˆ†å¸ƒå¼è®¡ç®—ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒ TiDB çš„å®˜æ–¹ç½‘ç«™ï¼Œåœ¨è¿™é‡Œå°±ä¸å†è¿›è¡Œè®ºè¿°ã€‚&lt;/p&gt;&lt;p&gt;åœ¨å¤„ç†å¤§å‹å¤æ‚çš„è®¡ç®—æ—¶ï¼ŒPingCAP ç»“åˆä¸Šå›¾è¯´çš„ TiKV ä»¥åŠç›®å‰å¤§æ•°æ®ç”Ÿæ€çš„ Sparkï¼Œæä¾›äº†å¦å¤–ä¸€ä¸ªå¼€æºäº§å“ TiSparkã€‚ä¸å¾—ä¸è¯´è¿™æ˜¯ä¸€ä¸ªå·§å¦™çš„è®¾è®¡ï¼Œå……åˆ†åˆ©ç”¨äº†ç°åœ¨ä¼ä¸šå·²æœ‰çš„ Spark é›†ç¾¤çš„èµ„æºï¼Œä¸éœ€è¦å¦å¤–å†æ–°å»ºé›†ç¾¤ã€‚TiSpark æ¶æ„ä»¥åŠæ ¸å¿ƒåŸç†ç®€å•æè¿°å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-92c0f11228150c5cf56dfdaf5b21ea1f_r.jpg&quot; data-caption=&quot;å›¾ 3 TiSpark æ¶æ„å›¾&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;1080&quot; data-rawheight=&quot;617&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-92c0f11228150c5cf56dfdaf5b21ea1f&quot; data-watermark-src=&quot;v2-a7609fdaf0319081318d88b6e9eb21e5&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;TiSpark æ·±åº¦æ•´åˆäº† Spark Catalyst å¼•æ“ï¼Œ å¯ä»¥å¯¹è®¡ç®—æä¾›ç²¾ç¡®çš„æ§åˆ¶ï¼Œä½¿ Spark èƒ½å¤Ÿé«˜æ•ˆçš„è¯»å– TiKV ä¸­çš„æ•°æ®ï¼Œæä¾›ç´¢å¼•æ”¯æŒä»¥å®ç°é«˜é€Ÿçš„ç‚¹æŸ¥ã€‚&lt;/p&gt;&lt;p&gt;é€šè¿‡å¤šç§è®¡ç®—ä¸‹æ¨å‡å°‘ Spark SQL éœ€è¦å¤„ç†çš„æ•°æ®å¤§å°ï¼Œä»¥åŠ é€ŸæŸ¥è¯¢ï¼›åˆ©ç”¨ TiDB çš„å†…å»ºçš„ç»Ÿè®¡ä¿¡æ¯é€‰æ‹©æ›´ä¼˜çš„æŸ¥è¯¢è®¡åˆ’ã€‚&lt;/p&gt;&lt;p&gt;ä»æ•°æ®é›†ç¾¤çš„è§’åº¦çœ‹ï¼ŒTiSpark + TiDB å¯ä»¥è®©ç”¨æˆ·æ— éœ€è¿›è¡Œè„†å¼±å’Œéš¾ä»¥ç»´æŠ¤çš„ ETLï¼Œç›´æ¥åœ¨åŒä¸€ä¸ªå¹³å°è¿›è¡Œäº‹åŠ¡å’Œåˆ†æä¸¤ç§å·¥ä½œï¼Œç®€åŒ–äº†ç³»ç»Ÿæ¶æ„å’Œè¿ç»´ã€‚&lt;/p&gt;&lt;p&gt;é™¤æ­¤ä¹‹å¤–ï¼Œç”¨æˆ·å€ŸåŠ© TiSpark é¡¹ç›®å¯ä»¥åœ¨ TiDB ä¸Šä½¿ç”¨ Spark ç”Ÿæ€åœˆæä¾›çš„å¤šç§å·¥å…·è¿›è¡Œæ•°æ®å¤„ç†ã€‚ä¾‹å¦‚ä½¿ç”¨ TiSpark è¿›è¡Œæ•°æ®åˆ†æå’Œ ETLï¼›ä½¿ç”¨ TiKV ä½œä¸ºæœºå™¨å­¦ä¹ çš„æ•°æ®æºï¼›å€ŸåŠ©è°ƒåº¦ç³»ç»Ÿäº§ç”Ÿå®šæ—¶æŠ¥è¡¨ç­‰ç­‰ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ç›®å‰çš„åº”ç”¨æƒ…å†µ&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;ç”±äºå¾ˆå¤šç”¨æˆ·å·²ç»éƒ¨ç½²äº†ç”Ÿäº§ç³»ç»Ÿï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨æµ‹è¯•ä¸Šå†æ¬¡æŠ•å…¥æ¯”è¾ƒå¤§çš„ç²¾åŠ›ï¼Œç»è¿‡äº†ç®€å•çš„æ€§èƒ½æµ‹è¯•ä»¥åï¼Œæ­å»ºäº†æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ª TiDB é›†ç¾¤ï¼Œå°è¯•åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ä¸Šè¿›è¡Œä½¿ç”¨ã€‚ç›®å‰ä¸»è¦ç”¨äºæˆ‘ä»¬çš„ç¦»çº¿è®¡ç®—ï¼Œä»¥åŠéƒ¨åˆ†å³ç³»æŸ¥è¯¢åœºæ™¯ï¼Œåç»­æ ¹æ®ä½¿ç”¨æƒ…å†µï¼Œé€æ¸è°ƒæ•´æˆ‘ä»¬çš„é›†ç¾¤è§„æ¨¡ä»¥åŠå¢åŠ æˆ‘ä»¬çš„çº¿ä¸Šåº”ç”¨ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;1. ç›®å‰çš„é›†ç¾¤é…ç½®&lt;/b&gt;&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-f8f32b0c3aaa1ae9b0fd7d66d1c3af88_r.jpg&quot; data-caption=&quot;å›¾ 4 é›†ç¾¤é…ç½®æ¸…å•&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;580&quot; data-rawheight=&quot;287&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-f8f32b0c3aaa1ae9b0fd7d66d1c3af88&quot; data-watermark-src=&quot;v2-b54aeaeb7444ec84d3049a7031a7cb99&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;b&gt;2. è§„åˆ’çš„åº”ç”¨æ¶æ„&lt;/b&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-48cc92e111dd0a45da7c85a7a5094f68_r.jpg&quot; data-caption=&quot;å›¾ 5 å¼•å…¥ TiDB ä»¥åçš„åº”ç”¨æ¶æ„å›¾&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;865&quot; data-rawheight=&quot;438&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-48cc92e111dd0a45da7c85a7a5094f68&quot; data-watermark-src=&quot;v2-a0e2c64fa8a49061b569454d00c54751&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;åŸºäº TiDB æˆ‘ä»¬è§„åˆ’äº†å®Œæ•´çš„æ•°æ®æµå¤„ç†é€»è¾‘ï¼Œä»æ•°æ®æ¥å…¥åˆ°æ•°æ®å±•ç°ï¼Œç”±äº TiDB é«˜åº¦å…¼å®¹ MySQLï¼Œå› æ­¤åœ¨æ•°æ®æºæ¥å…¥å’Œ UI å±•ç°å°±æœ‰å¾ˆå¤šæˆç†Ÿçš„å·¥å…·å¯ä»¥ä½¿ç”¨ï¼Œæ¯”å¦‚ Flumeã€Grafanaã€Saiku ç­‰ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;3. åº”ç”¨ç®€ä»‹&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;a. å……ç”µåŠŸç‡çš„åˆ†æ—¶ç»Ÿè®¡&lt;/b&gt;&lt;/p&gt;&lt;p&gt;æ¯ä¸ªç”¨æˆ·ä½¿ç”¨ç‰¹æ¥ç”µçš„å……ç”µæ¡©è¿›è¡Œå……ç”µæ—¶ï¼Œè½¦è¾†çš„ BMS æ•°æ®ã€å……ç”µæ¡©æ•°æ®ã€ç¯å¢ƒæ¸©åº¦ç­‰æ•°æ®æ˜¯å®æ—¶çš„ä¿å­˜åˆ°å¤§æ•°æ®åº“ä¸­ã€‚æˆ‘ä»¬åŸºäºé‡‡é›†çš„ç”¨æˆ·å……ç”µæ•°æ®ï¼Œéœ€è¦æŒ‰ç…§ä¸€å®šçš„æ—¶é—´å±•ç¤ºå…¨å›½çš„å……ç”µåŠŸç‡ æ¯”å¦‚å±•ç¤ºè¿‡å»ä¸€å¤©ï¼Œå…¨å›½çš„å……ç”µåŠŸç‡å˜åŒ–æ›²çº¿ï¼Œæ¯éš” 15 åˆ†é’Ÿæˆ–è€… 30 åˆ†é’Ÿè¿›è¡Œä¸€æ¬¡æ±‡æ€»ã€‚éšç€æˆ‘ä»¬ä¸šåŠ¡è§„æ¨¡çš„å¢åŠ ï¼Œæ­¤åœºæ™¯çš„è®¡ç®—ä¹Ÿé€æ­¥è¿›è¡Œäº†æ›´æ–°æ¢ä»£ã€‚&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-341fe1d2cb79d61df04446a1d898fdf8_r.jpg&quot; data-caption=&quot;å›¾ 6 å……ç”µåŠŸç‡çš„åˆ†æ—¶ç»Ÿè®¡&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;653&quot; data-rawheight=&quot;236&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-341fe1d2cb79d61df04446a1d898fdf8&quot; data-watermark-src=&quot;v2-b311c213bc9f7d70206bece78b84f843&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;ç›®å‰æˆ‘ä»¬å•è¡¨æ•°æ®é‡æ¥è¿‘ 20 äº¿ï¼Œæ¯å¤©çš„å¢é‡æ¥è¿‘ 800 ä¸‡å·¦å³ã€‚ä½¿ç”¨ TiDB åï¼Œåœ¨è¿›è¡Œç¦»çº¿è®¡ç®—åˆ†ææ—¶ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘è½¬æˆäº†ç›´æ¥åœ¨æˆ‘ä»¬çš„ç¦»çº¿è®¡ç®—å¹³å°é€šè¿‡ SQL çš„æ–¹å¼è¿›è¡Œå®šä¹‰å’Œç»´æŠ¤ï¼Œæå¤§çš„æé«˜äº†ç»´æŠ¤æ•ˆç‡ï¼ŒåŒæ—¶è®¡ç®—é€Ÿåº¦ä¹Ÿå¾—åˆ°äº†å¤§å¹…æå‡ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;b. å……ç”µè¿‡ç¨‹åˆ†æ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ä¸Šé¢æˆ‘ä»¬è®²äº†ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†å……ç”µè¿‡ç¨‹ä¸­çš„å®è´µçš„æµ·é‡æ•°æ®ï¼Œå¦‚ä½•è®©æ•°æ®å‘æŒ¥ä»·å€¼ï¼Œæˆ‘ä»¬åŸºäºå……ç”µæ•°æ®è¿›è¡Œå……ç”µè¿‡ç¨‹çš„åˆ†æå°±æ˜¯å…¶ä¸­çš„ä¸€ä¸ªæ–¹å¼ï¼Œæ¯”å¦‚åˆ†æä¸åŒçš„è½¦å‹åœ¨ä¸åŒçš„ç¯å¢ƒï¼ˆç¯å¢ƒæ¸©åº¦ã€ç”µæ± ç‰¹æ€§ï¼‰ä¸‹ï¼Œå……ç”µçš„æœ€å¤§ç”µå‹å’Œç”µæµçš„å˜åŒ–æƒ…å†µï¼Œä»¥åŠæˆ‘ä»¬å……ç”µæ¡©çš„éœ€æ±‚åŠŸç‡æ»¡è¶³åº¦ç­‰ã€‚&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-fbce582daa6f5a7cf0083489eeef5ad8_r.jpg&quot; data-caption=&quot;å›¾ 7 å……ç”µè¿‡ç¨‹åˆ†æ&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;865&quot; data-rawheight=&quot;287&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-fbce582daa6f5a7cf0083489eeef5ad8&quot; data-watermark-src=&quot;v2-ce51b393bb4f074ab6d845fbfb635310&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;é’ˆå¯¹æµ·é‡çš„å†å²æ•°æ®è®¡ç®—æˆ‘ä»¬ä½¿ç”¨äº† TiSpark è¿›è¡Œè®¡ç®—ï¼Œç›´æ¥ä½¿ç”¨äº†æˆ‘ä»¬ç°æœ‰çš„ Spark é›†ç¾¤ï¼Œåœ¨ä½¿ç”¨ Spark è¿›è¡Œè®¡ç®—æ—¶ï¼Œä¸€å¼€å§‹ç”±äºä¸ç†Ÿæ‚‰ TiSparkï¼Œåˆ†é…çš„èµ„æºæ¯”è¾ƒå°‘ï¼Œè€—æ—¶å¤šä¸€äº›ã€‚åæ¥å’Œ TiDB æŠ€æœ¯äººå‘˜äº¤æµäº†è§£åˆ°æœ€ä½³å®è·µï¼Œæå‡é…ç½®å’Œè°ƒæ•´éƒ¨åˆ†å‚æ•°åï¼Œæ€§èƒ½æå‡ä¸å°‘ã€‚è¿™ä¸ªåœºæ™¯ä¸­æˆ‘ä»¬å……åˆ†åˆ©ç”¨äº† TiDB å’Œ TiSpark è¿›è¡ŒååŒå·¥ä½œï¼Œæ»¡è¶³äº†æˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;æ€»ç»“åŠé—®é¢˜&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;&lt;b&gt;1. æœ€ä½³åº”ç”¨åœºæ™¯&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç»“åˆæˆ‘ä»¬çš„çº¿ä¸ŠéªŒè¯ï¼Œæˆ‘ä»¬è®¤ä¸ºä½¿ç”¨ TiDBï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜åŠ¿ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;SQL æ”¯æŒåº¦ç›¸å¯¹äºç°æœ‰çš„é›†ç¾¤æ”¯æŒåº¦è¾ƒå¥½ï¼Œçµæ´»æ€§å’ŒåŠŸèƒ½æ€§å¤§å¤§å¢å¼ºã€‚&lt;/li&gt;&lt;li&gt;å¯ä»¥è¿›è¡Œè¡¨ä¹‹é—´çš„ join è¿ç®—ï¼Œé™ä½äº†æ„é€ å®½è¾¹çš„å¤æ‚åº¦ä»¥åŠå› æ­¤å¸¦æ¥çš„ç»´æŠ¤æˆæœ¬ã€‚&lt;/li&gt;&lt;li&gt;å†å²æ•°æ®æ–¹ä¾¿ä¿®æ”¹ã€‚&lt;/li&gt;&lt;li&gt;é«˜åº¦å…¼å®¹ MySQL ç”Ÿæ€ä¸‹å¯¹åº”çš„æˆç†Ÿè½¯ä»¶è¾ƒå¤šï¼ˆå¼€å‘å·¥å…·ã€å±•ç°ã€æ•°æ®æ¥å…¥ï¼‰ã€‚&lt;/li&gt;&lt;li&gt;åŸºäºç´¢å¼•çš„ SQL æ€§èƒ½åœ¨ç¦»çº¿è®¡ç®—ä¸ŠåŸºæœ¬å¯ä»¥æ»¡è¶³æˆ‘ä»¬éœ€æ±‚ï¼Œåœ¨å³å¸­æŸ¥è¯¢ä¸Šæœ€é€‚åˆæµ·é‡æ•°æ®ä¸‹è¿›è¡Œå¤šç»´åº¦çš„ç²¾ç¡®æŸ¥è¯¢ï¼Œç±»ä¼¼ä¸ â€œä¸‡é‡ŒæŒ‘ä¸€â€ çš„åœºæ™¯ã€‚&lt;/li&gt;&lt;li&gt;ä½¿ç”¨ TiSpark è¿›è¡Œå¤æ‚çš„ç¦»çº¿è®¡ç®—ï¼Œå……åˆ†åˆ©ç”¨äº†ç°æœ‰çš„é›†ç¾¤ï¼Œæ•°æ®å­˜å‚¨åšåˆ°äº†ä¸€ä»½ï¼ŒåŒæ—¶ä¹Ÿé™ä½äº†è¿ç»´æˆæœ¬ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;b&gt;2. ç›®å‰çš„å®šä½&lt;/b&gt;&lt;/p&gt;&lt;p&gt;ç»“åˆæˆ‘ä»¬çš„å®é™…ç°çŠ¶ï¼Œç°é˜¶æ®µæˆ‘ä»¬ä¸»è¦ç”¨äºè¿›è¡Œç¦»çº¿è®¡ç®—å’Œéƒ¨åˆ†å³å¸­æŸ¥è¯¢çš„åœºæ™¯ï¼ŒåæœŸéšç€åº”ç”¨çš„æ·±å…¥ï¼Œæˆ‘ä»¬é€æ­¥è€ƒè™‘å¢åŠ æ›´å¤šçš„åº”ç”¨ä»¥åŠéƒ¨åˆ† OLTP åœºæ™¯ã€‚&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;blockquote&gt;ä½œè€…ä»‹ç»ï¼šæ½˜åšå­˜ï¼Œç‰¹æ¥ç”µå¤§æ•°æ®æŠ€æœ¯ç ”å‘éƒ¨æ¶æ„å¸ˆï¼Œå…·æœ‰ 10 å¤šå¹´å¹³å°è½¯ä»¶è®¾è®¡å¼€å‘ç»éªŒï¼Œç°ä¸“æ³¨äºå¤§æ•°æ®é¢†åŸŸå¿«é€Ÿè¯»å†™æ–¹å‘ã€‚&lt;/blockquote&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-07-01-38760049</guid>
<pubDate>Sun, 01 Jul 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆåä¸€ï¼‰Index Lookup Join</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-06-27-38572730.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38572730&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-1bc90f4fea487a82ecb0a73acbf3b306_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;p&gt;&lt;/p&gt;&lt;blockquote&gt; ä½œè€…ï¼šå¾æ€€å®‡&lt;/blockquote&gt;&lt;h2&gt;&lt;b&gt;ä»€ä¹ˆæ˜¯ Index Lookup Join&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;&lt;b&gt;Nested Loop Join&lt;/b&gt;&lt;br&gt;åœ¨ä»‹ç» Index Lookup Join ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯ &lt;b&gt;Nested Loop Joinï¼ˆNLJï¼‰&lt;/b&gt;ã€‚ NLJ çš„å…·ä½“å®šä¹‰å¯ä»¥å‚è€ƒ &lt;a href=&quot;https://en.wikipedia.org/wiki/Nested_loop_join&quot;&gt;Wikipedia&lt;/a&gt;ã€‚NLJ æ˜¯æœ€ä¸ºç®€å•æš´åŠ›çš„ Join ç®—æ³•ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹ç®€è¿°å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;éå† Outer è¡¨ï¼Œå–ä¸€æ¡æ•°æ® rï¼›&lt;/li&gt;&lt;li&gt;éå† Inner è¡¨ï¼Œå¯¹äº Inner è¡¨ä¸­çš„æ¯æ¡æ•°æ®ï¼Œä¸ r è¿›è¡Œ join æ“ä½œå¹¶è¾“å‡º join ç»“æœï¼›&lt;/li&gt;&lt;li&gt;é‡å¤æ­¥éª¤ 1ï¼Œ2 ç›´è‡³éå†å®Œ Outer è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;NLJ ç®—æ³•å®ç°éå¸¸ç®€å•å¹¶ä¸” join ç»“æœçš„é¡ºåºä¸ Outer è¡¨çš„æ•°æ®é¡ºåºä¸€è‡´ã€‚&lt;br&gt;ä½†æ˜¯å­˜åœ¨æ€§èƒ½ä¸Šçš„é—®é¢˜ï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹äºæ¯ä¸€æ¡ OuterRowï¼Œæˆ‘ä»¬éƒ½éœ€è¦å¯¹ Inner è¡¨è¿›è¡Œä¸€æ¬¡&lt;b&gt;å…¨è¡¨æ‰«&lt;/b&gt;æ“ä½œï¼Œè¿™å°†æ¶ˆè€—å¤§é‡æ—¶é—´ã€‚&lt;br&gt;ä¸ºäº†å‡å°‘å¯¹äº Inner è¡¨çš„å…¨è¡¨æ‰«æ¬¡æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸Šè¿°æ­¥éª¤ 1 ä¼˜åŒ–ä¸ºæ¯æ¬¡ä» Outer è¡¨ä¸­è¯»å–ä¸€ä¸ª batch çš„æ•°æ®ï¼Œä¼˜åŒ–åçš„ç®—æ³•å³ &lt;b&gt;Block Nested-Loop Joinï¼ˆBNJï¼‰&lt;/b&gt;ï¼ŒBNJ çš„å…·ä½“å®šä¹‰å¯ä»¥å‚è€ƒ &lt;a href=&quot;https://en.wikipedia.org/wiki/Block_nested_loop&quot;&gt;Wikipedia&lt;/a&gt;ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;Index Lookup Join&lt;/b&gt;&lt;/p&gt;&lt;p&gt;å¯¹äº BNJ ç®—æ³•ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œå¯¹äº Outer è¡¨ä¸­æ¯ä¸ª batchï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å¿…è¦å¯¹ Inner è¡¨éƒ½è¿›è¡Œä¸€æ¬¡å…¨è¡¨æ‰«æ“ä½œï¼Œå¾ˆå¤šæ—¶å€™å¯ä»¥é€šè¿‡ç´¢å¼•å‡å°‘æ•°æ®è¯»å–çš„ä»£ä»·ã€‚&lt;b&gt;Index Lookup Joinï¼ˆILJï¼‰&lt;/b&gt; åœ¨ BNJ åŸºç¡€ä¸Šè¿›è¡Œäº†æ”¹è¿›ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹ç®€è¿°å¦‚ä¸‹ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;ä» Outer è¡¨ä¸­å–ä¸€æ‰¹æ•°æ®ï¼Œè®¾ä¸º Bï¼›&lt;/li&gt;&lt;li&gt;é€šè¿‡ Join Key ä»¥åŠ B ä¸­çš„æ•°æ®æ„é€  Inner è¡¨å–å€¼èŒƒå›´ï¼Œåªè¯»å–å¯¹åº”å–å€¼èŒƒå›´çš„æ•°æ®ï¼Œè®¾ä¸º Sï¼›&lt;/li&gt;&lt;li&gt;å¯¹ B ä¸­çš„æ¯ä¸€è¡Œæ•°æ®ï¼Œä¸ S ä¸­çš„æ¯ä¸€æ¡æ•°æ®æ‰§è¡Œ Join æ“ä½œå¹¶è¾“å‡ºç»“æœï¼›&lt;/li&gt;&lt;li&gt;é‡å¤æ­¥éª¤ 1ï¼Œ2ï¼Œ3ï¼Œç›´è‡³éå†å®Œ Outer è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;h2&gt;&lt;b&gt;TiDB Index Lookup Join çš„å®ç°&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;TiDB çš„ ILJ ç®—å­æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹çš„å®ç°ï¼Œä¸»è¦çš„çº¿ç¨‹æœ‰ï¼š Main Theadï¼ŒOuter Workerï¼Œå’Œ Inner Workerï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;b&gt;Outer Worker ä¸€ä¸ªï¼š&lt;/b&gt;&lt;/li&gt;&lt;ul&gt;&lt;li&gt;æŒ‰ batch éå† Outer è¡¨ï¼Œå¹¶å°è£…å¯¹åº”çš„ task&lt;/li&gt;&lt;li&gt;å°† task å‘é€ç»™ Inner Worker å’Œ Main Thread&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&lt;b&gt;Inner Worker N ä¸ªï¼š&lt;/b&gt;&lt;/li&gt;&lt;ul&gt;&lt;li&gt;è¯»å– Outer Worker æ„å»ºçš„ task&lt;/li&gt;&lt;li&gt;æ ¹æ® task ä¸­çš„ Outer è¡¨æ•°æ®ï¼Œæ„å»º Inner è¡¨çš„æ‰«æèŒƒå›´ï¼Œå¹¶æ„é€ ç›¸åº”çš„ç‰©ç†æ‰§è¡Œç®—å­è¯»å–è¯¥èŒƒå›´å†…çš„ Inner è¡¨æ•°æ®&lt;/li&gt;&lt;li&gt;å¯¹è¯»å–çš„ Inner è¡¨æ•°æ®åˆ›å»ºå¯¹åº”çš„å“ˆå¸Œè¡¨å¹¶å­˜å…¥ task&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&lt;b&gt;Main Thread ä¸€ä¸ªï¼š&lt;/b&gt;&lt;/li&gt;&lt;ul&gt;&lt;li&gt;å¯åŠ¨ Outer Worker åŠ Inner Workers&lt;/li&gt;&lt;li&gt;è¯»å– Outer Worker æ„å»ºçš„ taskï¼Œå¹¶å¯¹æ¯è¡Œ Outer æ•°æ®åœ¨å¯¹åº”çš„å“ˆå¸Œè¡¨ä¸­ probe&lt;/li&gt;&lt;li&gt;å¯¹ probe åˆ°çš„æ•°æ®è¿›è¡Œ join å¹¶è¿”å›æ‰§è¡Œç»“æœ&lt;/li&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;p&gt;è¿™ä¸ªç®—å­æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Join ç»“æœçš„é¡ºåºä¸ Outer è¡¨çš„æ•°æ®é¡ºåºä¸€è‡´ï¼Œè¿™æ ·å¯¹ä¸Šä¸€å±‚ç®—å­å¯ä»¥æä¾›é¡ºåºä¿è¯ï¼›&lt;/li&gt;&lt;li&gt;å¯¹äº Outer è¡¨ä¸­çš„æ¯ä¸ª batchï¼Œåªåœ¨ Inner è¡¨ä¸­æ‰«æéƒ¨åˆ†æ•°æ®ï¼Œæå‡å•ä¸ª batch çš„å¤„ç†æ•ˆç‡ï¼›&lt;/li&gt;&lt;li&gt;Outer è¡¨çš„è¯»æ•°æ®æ“ä½œï¼ŒInner è¡¨çš„è¯»æ•°æ®æ“ä½œï¼ŒåŠ Join æ“ä½œå¹¶è¡Œæ‰§è¡Œï¼Œæ•´ä½“ä¸Šæ˜¯ä¸€ä¸ªå¹¶è¡Œ+Pipeline çš„æ–¹å¼ï¼Œå°½å¯èƒ½æå‡æ‰§è¡Œæ•ˆç‡ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;b&gt;æ‰§è¡Œé˜¶æ®µè¯¦è¿°&lt;/b&gt;&lt;/p&gt;&lt;p&gt;TiDB ä¸­ ILJ çš„æ‰§è¡Œé˜¶æ®µå¯åˆ’åˆ†ä¸ºå¦‚ä¸‹å›¾æ‰€ç¤ºçš„ 5 æ­¥ï¼š&lt;/p&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-bce13c946db6b2f593524843dca98df0_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;941&quot; data-rawheight=&quot;635&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-bce13c946db6b2f593524843dca98df0&quot; data-watermark-src=&quot;v2-4fa27fd9a02423446cc8231976e9f80f&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;b&gt;1. å¯åŠ¨ Outer Worker åŠ Inner Workers&lt;/b&gt;&lt;/p&gt;&lt;p&gt;è¿™éƒ¨åˆ†å·¥ä½œç”± &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L130&quot;&gt;startWorkers&lt;/a&gt; å‡½æ•°å®Œæˆã€‚è¯¥å‡½æ•°ä¼š &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L138&quot;&gt;å¯åŠ¨ä¸€ä¸ª Outer Worker&lt;/a&gt; å’Œ&lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L141&quot;&gt;å¤šä¸ª Inner Worker&lt;/a&gt; å’Œ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L141&quot;&gt;å¤šä¸ª Inner Worker&lt;/a&gt;ã€‚Inner Woker çš„æ•°é‡å¯ä»¥é€šè¿‡ &lt;code class=&quot;inline&quot;&gt;tidb_index_lookup_concurrency&lt;/code&gt; è¿™ä¸ªç³»ç»Ÿå˜é‡è¿›è¡Œè®¾ç½®ï¼Œé»˜è®¤ä¸º 4ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;2. è¯»å– Outer è¡¨æ•°æ®&lt;/b&gt;&lt;/p&gt;&lt;p&gt;è¿™éƒ¨åˆ†å·¥ä½œç”± &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L314&quot;&gt;buildTask&lt;/a&gt; å‡½æ•°å®Œæˆã€‚æ­¤å¤„ä¸»è¦æ³¨æ„ä¸¤ç‚¹ï¼š&lt;/p&gt;&lt;p&gt;ç¬¬ä¸€ç‚¹ï¼Œå¯¹äºæ¯æ¬¡è¯»å–çš„ batch å¤§å°ï¼Œå¦‚æœå°†å…¶è®¾ç½®ä¸ºå›ºå®šå€¼ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹é—®é¢˜ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;è‹¥è®¾ç½®çš„ batch å€¼&lt;b&gt;è¾ƒå¤§&lt;/b&gt;ï¼Œä½† Outer è¡¨æ•°æ®é‡&lt;b&gt;è¾ƒå°&lt;/b&gt;æ—¶ã€‚å„ä¸ª Inner Worker æ‰€éœ€å¤„ç†çš„ä»»åŠ¡é‡å¯èƒ½ä¼šä¸å‡åŒ€ï¼Œå‡ºç°æ•°æ®å€¾æ–œçš„æƒ…å†µï¼Œå¯¼è‡´å¹¶å‘æ•´ä½“æ€§èƒ½ç›¸å¯¹å•çº¿ç¨‹æå‡æœ‰é™ã€‚&lt;/li&gt;&lt;li&gt;è‹¥è®¾ç½®çš„ batch å€¼&lt;b&gt;è¾ƒå°&lt;/b&gt;ï¼Œä½† Outer è¡¨æ•°æ®é‡&lt;b&gt;è¾ƒå¤§&lt;/b&gt;æ—¶ã€‚Inner Worker å¤„ç†ä»»åŠ¡æ—¶é—´çŸ­ï¼Œéœ€è¦é¢‘ç¹ä»ç®¡é“ä¸­å–ä»»åŠ¡ï¼ŒCPU ä¸èƒ½è¢«æŒç»­é«˜æ•ˆåˆ©ç”¨ï¼Œç”±æ­¤å¸¦æ¥å¤§é‡çš„çº¿ç¨‹åˆ‡æ¢å¼€é”€ã€‚æ­¤å¤–, å½“ batch å€¼è¾ƒå°æ—¶ï¼ŒåŒä¸€æ‰¹ inner è¡¨æ•°æ®èƒ½ä¼šè¢«åå¤è¯»å–å¤šæ¬¡ï¼Œå¸¦æ¥æ›´å¤§çš„ç½‘ç»œå¼€é”€ï¼Œå¯¹æ•´ä½“æ€§èƒ½äº§ç”Ÿæå¤§å½±å“ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡æŒ‡æ•°é€’å¢çš„æ–¹å¼åŠ¨æ€æ§åˆ¶ batch çš„å¤§å°ï¼ˆç”±å‡½æ•° &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L348&quot;&gt;increaseBatchSize&lt;/a&gt; å®Œæˆï¼‰ï¼Œä»¥é¿å…ä¸Šè¿°é—®é¢˜ï¼Œbatch size çš„æœ€å¤§å€¼ç”± session å˜é‡ &lt;code class=&quot;inline&quot;&gt;tidb_index_join_batch_size&lt;/code&gt; æ§åˆ¶ï¼Œé»˜è®¤æ˜¯ 25000ã€‚è¯»å–åˆ°çš„ batch å­˜å‚¨åœ¨ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/expression/chunk_executor.go#L225&quot;&gt;lookUpJoinTask.outerResult&lt;/a&gt; ä¸­ã€‚&lt;/p&gt;&lt;p&gt;ç¬¬äºŒç‚¹ï¼Œå¦‚æœ Outer è¡¨çš„è¿‡æ»¤æ¡ä»¶ä¸ä¸ºç©ºï¼Œæˆ‘ä»¬éœ€è¦å¯¹ outerResult ä¸­çš„æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼ˆç”±å‡½æ•° &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/expression/chunk_executor.go#L225&quot;&gt;VectorizedFilter&lt;/a&gt; å®Œæˆï¼‰ã€‚outerResult æ˜¯ Chunk ç±»å‹ï¼ˆ&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38095421&quot;&gt;Chunk çš„ä»‹ç»è¯·å‚è€ƒ TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆåï¼‰&lt;/a&gt;ï¼‰ï¼Œå¦‚æœå¯¹æ»¡è¶³è¿‡æ»¤æ¡ä»¶çš„è¡Œè¿›è¡Œæå–å¹¶é‡æ–°æ„å»ºå¯¹è±¡è¿›è¡Œå­˜å‚¨ï¼Œä¼šå¸¦æ¥ä¸å¿…è¦çš„æ—¶é—´å’Œå†…å­˜å¼€é”€ã€‚&lt;code class=&quot;inline&quot;&gt;VectorizedFilter&lt;/code&gt; å‡½æ•°é€šè¿‡ä¸€ä¸ªé•¿åº¦ä¸ outerResult å®é™…æ•°æ®è¡Œæ•°ç›¸ç­‰çš„ bool slice è®°å½• outerResult ä¸­çš„æ¯ä¸€è¡Œæ˜¯å¦æ»¡è¶³è¿‡æ»¤æ¡ä»¶ä»¥é¿å…ä¸Šè¿°å¼€é”€ã€‚ è¯¥ bool slice å­˜å‚¨åœ¨ &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L81&quot;&gt;lookUpJoinTask.outerMatch&lt;/a&gt; ä¸­ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;3. Outer Worker å°† task å‘é€ç»™ Inner Worker å’Œ Main Thread&lt;/b&gt;&lt;/p&gt;&lt;p&gt;Inner Worker éœ€è¦æ ¹æ® Outer è¡¨æ¯ä¸ª batch çš„æ•°æ®ï¼Œæ„å»º Inner è¡¨çš„æ•°æ®æ‰«æèŒƒå›´å¹¶è¯»å–æ•°æ®ï¼Œå› æ­¤ Outer Worker éœ€è¦å°† task &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L304&quot;&gt;å‘é€ç»™ Inner Worker&lt;/a&gt;ã€‚&lt;br&gt;å¦‚å‰æ–‡æ‰€è¿°ï¼ŒILJ å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œä¸” Join ç»“æœçš„é¡ºåºä¸ Outer è¡¨çš„æ•°æ®é¡ºåºä¸€è‡´ã€‚ ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼ŒOuter Worker é€šè¿‡ç®¡é“å°† task &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L299&quot;&gt;å‘é€ç»™ Main Thread&lt;/a&gt;ï¼ŒMain Thread ä»ç®¡é“ä¸­æŒ‰åºè¯»å– task å¹¶æ‰§è¡Œ Join æ“ä½œï¼Œè¿™æ ·ä¾¿å¯ä»¥å®ç°åœ¨å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„æƒ…å†µä¸‹çš„ä¿åºéœ€æ±‚ã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;4. Inner Worker è¯»å– inner è¡¨æ•°æ®&lt;/b&gt;&lt;/p&gt;&lt;p&gt;è¿™éƒ¨åˆ†å·¥ä½œç”± &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L376&quot;&gt;handleTask&lt;/a&gt; è¿™ä¸ªå‡½æ•°å®Œæˆã€‚handleTask æœ‰å¦‚ä¸‹å‡ ä¸ªæ­¥éª¤:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L393&quot;&gt;constructDatumLookupKeys&lt;/a&gt; å‡½æ•°è®¡ç®— Outer è¡¨å¯¹åº”çš„ Join Keys çš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® Join Keys çš„å€¼ä» Inner è¡¨ä¸­ä»…æŸ¥è¯¢æ‰€éœ€è¦çš„æ•°æ®å³å¯ï¼Œè€Œä¸ç”¨å¯¹ Inner è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®è¿›è¡Œéå†ã€‚ä¸ºäº†é¿å…å¯¹åŒä¸€ä¸ª batch ä¸­ç›¸åŒçš„ Join Keys é‡å¤æŸ¥è¯¢ Inner è¡¨ä¸­çš„æ•°æ®ï¼Œ&lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L447&quot;&gt;sortAndDedupDatumLookUpKeys&lt;/a&gt; ä¼šåœ¨æŸ¥è¯¢å‰å¯¹å‰é¢è®¡ç®—å‡ºçš„ Join Keys çš„å€¼è¿›è¡Œå»é‡ã€‚&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L480&quot;&gt;fetchInnerResult&lt;/a&gt; å‡½æ•°åˆ©ç”¨å»é‡åçš„ Join Keys æ„é€ å¯¹ Inner è¡¨è¿›è¡ŒæŸ¥è¯¢çš„æ‰§è¡Œå™¨ï¼Œå¹¶è¯»å–æ•°æ®å­˜å‚¨äº &lt;code class=&quot;inline&quot;&gt;task.innerResult&lt;/code&gt; ä¸­ã€‚&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L502&quot;&gt;buildLookUpMap&lt;/a&gt; å‡½æ•°å¯¹è¯»å–çš„ Inner æ•°æ®æŒ‰ç…§å¯¹åº”çš„ Join Keys æ„å»ºå“ˆå¸Œè¡¨ï¼Œå­˜å‚¨äº &lt;code class=&quot;inline&quot;&gt;task.lookupMap&lt;/code&gt; ä¸­ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;ä¸Šè¿°æ­¥éª¤å®Œæˆåï¼ŒInner Worker å‘ &lt;code class=&quot;inline&quot;&gt;task.doneCh&lt;/code&gt; ä¸­å‘é€æ•°æ®ï¼Œä»¥å”¤é†’ Main Thread è¿›è¡Œæ¥ä¸‹æ¥çš„å·¥ä½œã€‚&lt;/p&gt;&lt;p&gt;&lt;b&gt;5. Main Thread æ‰§è¡Œ Join æ“ä½œ&lt;/b&gt;&lt;/p&gt;&lt;p&gt;è¿™éƒ¨åˆ†å·¥ä½œç”± &lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L209&quot;&gt;prepareJoinResult&lt;/a&gt; å‡½æ•°å®Œæˆã€‚prepareJoinResult æœ‰å¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L216&quot;&gt;getFinishedTask&lt;/a&gt; ä» resultCh ä¸­è¯»å– taskï¼Œå¹¶ç­‰å¾… task.doneCh å‘é€æ¥çš„æ•°æ®ï¼Œè‹¥è¯¥ task æ²¡æœ‰å®Œæˆï¼Œåˆ™é˜»å¡ä½ï¼›&lt;/li&gt;&lt;li&gt;æ¥ä¸‹æ¥çš„æ­¥éª¤ä¸ Hash Joinç±»ä¼¼ï¼ˆå‚è€ƒ &lt;a href=&quot;https://zhuanlan.zhihu.com/p/37773956&quot;&gt;TiDB æºç é˜…è¯»ç³»åˆ—æ–‡ç« ï¼ˆä¹ï¼‰&lt;/a&gt;ï¼‰ï¼Œ&lt;a href=&quot;https://github.com/pingcap/tidb/blob/source-code/executor/index_lookup_join.go#L273&quot;&gt;lookUpMatchedInners&lt;/a&gt; å–ä¸€è¡Œ OuterRow å¯¹åº”çš„ Join Keyï¼Œä» task.lookupMap ä¸­ probe å¯¹åº”çš„ Inner è¡¨çš„æ•°æ®ï¼›&lt;/li&gt;&lt;li&gt;ä¸»çº¿ç¨‹å¯¹è¯¥ OuterRowï¼Œä¸å–å‡ºçš„å¯¹åº”çš„ InnerRows æ‰§è¡Œ Join æ“ä½œï¼Œå†™æ»¡å­˜å‚¨ç»“æœçš„ chk åè¿”å›ã€‚&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;h2&gt;&lt;b&gt;ç¤ºä¾‹&lt;/b&gt;&lt;/h2&gt;&lt;code lang=&quot;text&quot;&gt;CREATE TABLE `t` (
`a` int(11) DEFAULT NULL,
`pk` int(11) NOT NULL AUTO_INCREMENT,
PRIMARY KEY (`pk`)
);

CREATE TABLE `s` (
`a` int(11) DEFAULT NULL,
KEY `idx_s_a` (`a`)
);
â€‹
insert into t(`a`) value(1),(1),(1),(4),(4),(5);
insert into s value(1),(2),(3),(4);
â€‹
select /*+ TIDB_INLJ(t) */ * from t left join s on t.a = s.a;&lt;/code&gt;&lt;p&gt;&lt;br&gt;åœ¨ä¸Šä¾‹ä¸­ï¼Œ &lt;code class=&quot;inline&quot;&gt;t&lt;/code&gt; ä¸º Outer è¡¨ï¼Œ&lt;code class=&quot;inline&quot;&gt;s&lt;/code&gt; ä¸º Inner è¡¨ã€‚ &lt;a href=&quot;https://github.com/pingcap/docs-cn/blob/master/sql/tidb-specific.md#tidb_inljt1-t2&quot;&gt;/** TIDN_INLJ */&lt;/a&gt; å¯ä»¥è®©ä¼˜åŒ–å™¨å°½å¯èƒ½é€‰æ‹© Index Lookup Join ç®—æ³•ã€‚&lt;/p&gt;&lt;p&gt;è®¾ Outer è¡¨è¯»æ•°æ® batch çš„åˆå§‹å¤§å°ä¸º 2 è¡Œï¼ŒInner Worker æ•°é‡ä¸º 2ã€‚&lt;/p&gt;&lt;p&gt;æŸ¥è¯¢è¯­å¥çš„ä¸€ç§å¯èƒ½çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­ç”±ä¸Šå¾€ä¸‹ç®­å¤´è¡¨ç¤ºæ—¶é—´çº¿ï¼š&lt;br&gt;&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-351d7c688bdf43506185bd617b99ffae_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;941&quot; data-rawheight=&quot;521&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-351d7c688bdf43506185bd617b99ffae&quot; data-watermark-src=&quot;v2-2cea494c8abd250e517b7fddae0a0446&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;å»¶å±•é˜…è¯»&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38095421&quot;&gt;ï¼ˆåï¼‰Chunk å’Œæ‰§è¡Œæ¡†æ¶ç®€ä»‹&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/37773956&quot;&gt;ï¼ˆä¹ï¼‰Hash Join&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/36420449&quot;&gt;ï¼ˆå…«ï¼‰åŸºäºä»£ä»·çš„ä¼˜åŒ–&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/35511864&quot;&gt;ï¼ˆä¸ƒï¼‰åŸºäºè§„åˆ™çš„ä¼˜åŒ–&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/35134962&quot;&gt;ï¼ˆå…­ï¼‰Select è¯­å¥æ¦‚è§ˆ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34770765&quot;&gt;ï¼ˆäº”ï¼‰TiDB SQL Parser çš„å®ç°&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34512827&quot;&gt;ï¼ˆå››ï¼‰Insert è¯­å¥æ¦‚è§ˆ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34369624&quot;&gt;ï¼ˆä¸‰ï¼‰SQL çš„ä¸€ç”Ÿ&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34176614&quot;&gt;ï¼ˆäºŒï¼‰åˆè¯† TiDB æºç &lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/34109413&quot;&gt;ï¼ˆä¸€ï¼‰åº&lt;/a&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-06-27-38572730</guid>
<pubDate>Wed, 27 Jun 2018 00:00:00 +0800</pubDate>
</item>
<item>
<title>SuRF: ä¸€ä¸ªä¼˜åŒ–çš„ Fast Succinct Tries</title>
<link>https://henix.github.io/feeds/zhuanlan.newsql/2018-06-22-38385054.html</link>
<description>&lt;p&gt;&lt;a href=&quot;https://zhuanlan.zhihu.com/p/38385054&quot;&gt;åŸæ–‡&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;title-image&quot;&gt;&lt;img src=&quot;https://pic2.zhimg.com/v2-e1b5f6d9e6e925d3093d622e3ccdeb17_r.jpg&quot; alt=&quot;&quot;&gt;&lt;/div&gt;&lt;blockquote&gt;ä½œè€…ï¼šå”åˆ˜&lt;/blockquote&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ç®€å•ä»‹ç»äº† &lt;a href=&quot;https://zhuanlan.zhihu.com/p/38194127&quot;&gt;Succinct Data Structure&lt;/a&gt;ï¼Œè¿™é‡Œæˆ‘ä»¬ç»§ç»­ä»‹ç» SuRFã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;Fast Succinct Tries&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;SuRF çš„æ ¸å¿ƒæ•°æ®ç»“æ„å°±æ˜¯ Fast Succinct Triesï¼ˆFSTï¼‰ï¼Œä¸€ç§ç©ºé—´èŠ‚çœï¼Œæ”¯æŒ point å’Œ range query çš„é™æ€ trieã€‚åœ¨å¾ˆå¤šæ—¶å€™ï¼Œå¯¹äºä¸€æ£µæ ‘æ¥è¯´ï¼Œä¸Šå±‚çš„ trie èŠ‚ç‚¹è¾ƒå°‘ï¼Œä½†è®¿é—®é¢‘ç¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¿—ç§°çš„ hotï¼Œè€Œä¸‹å±‚çš„èŠ‚ç‚¹åˆ™ç›¸å¯¹çš„ cold ä¸€ç‚¹ã€‚å› æ­¤ï¼ŒSuRF ä½¿ç”¨äº†ä¸¤ç§æ•°æ®ç»“æ„æ¥åˆ†åˆ«å¤„ç† hot å’Œ cold èŠ‚ç‚¹ã€‚åœ¨ upper å±‚ä¸Šé¢ä½¿ç”¨äº† LOUDS-Dedenseï¼Œè€Œåœ¨ lower å±‚ä¸Šé¢ä½¿ç”¨ LOUDS-Sparseã€‚&lt;/p&gt;&lt;p&gt;å¯¹äºä¸€ä¸ª trie æ¥è¯´ï¼ŒSuRF ä¼šå°†å…¶ç¼–ç æˆï¼š&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-8e6a70a350de2199f8292dbbd699d34f_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;700&quot; data-rawheight=&quot;336&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-8e6a70a350de2199f8292dbbd699d34f&quot; data-watermark-src=&quot;v2-ddcacf7aecd4f2ccbbc1218bcab37b86&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;å¯¹äºä¸€æ¬¡æŸ¥è¯¢æ¥è¯´ï¼Œé¦–å…ˆä¼šåœ¨ LOUDS-Dense ä¸Šé¢æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç›´æ¥è¿”å›ï¼Œæ‰¾ä¸åˆ°ï¼Œå°±ä¼šè¿›å…¥åˆ° LOUDS-Sparse è¿›è¡ŒæŸ¥æ‰¾ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;LOUDS-Dense&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;LOUDS-Dense å¯¹äºæ¯ä¸ª Node éƒ½ä½¿ç”¨äº†ä¸‰ä¸ª 256 bit å¤§å°çš„ bitmapã€‚ç¬¬ä¸€ä¸ª bitmap å«åš D-labelsï¼Œå¦‚æœè¡¨ç¤ºè¿™ä¸ª node æ˜¯å¦æœ‰ label iï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆç¬¬ i bit ä½å°±æ˜¯ 1ã€‚è­¬å¦‚ä¸Šé¢çš„ä¾‹å­ï¼ŒDense çš„ label åœ¨ level 1 æœ‰ fï¼Œs å’Œ tï¼Œé‚£ä¹ˆåœ¨ç¬¬ 102ï¼ˆfï¼‰ï¼Œ115ï¼ˆsï¼‰ å’Œ 116 ï¼ˆtï¼‰bit ä½å°±ä¼šè®¾ç½®ä¸º 1ã€‚å¤§å®¶å…¶å®å¯ä»¥çœ‹åˆ°ï¼Œå…·ä½“å“ªä¸€ä¸ª bit ä½ï¼Œå°±æ˜¯ ASCII ç çš„å€¼ã€‚&lt;br&gt;ç¬¬äºŒä¸ª bitmap æ˜¯ D-HasChildï¼Œå¦‚æœä¸€ä¸ª node ä¸‹é¢è¿˜æœ‰å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±å°†è¯¥ label å¯¹åº”çš„ bit åœ¨ D-HasChild é‡Œé¢è®¾ç½®ä¸º 1ã€‚ç»§ç»­ä¸Šé¢çš„ä¾‹å­ï¼Œf å’Œ t éƒ½æœ‰å­èŠ‚ç‚¹ï¼Œè€Œ s æ²¡æœ‰ï¼Œæ‰€ä»¥ 102 å’Œ 116 bit éƒ½ä¼šè®¾ç½®ä¸º 1ã€‚&lt;/p&gt;&lt;p&gt;ç¬¬ä¸‰ä¸ª bitmap æ˜¯ D-IsPrefixKeyï¼Œè¿™ä¸ªè§£é‡Šå…¶å®æœ‰ç‚¹ç»•ï¼Œä¸»è¦æ˜¯ç”¨æ¥è¡¨ç¤ºä¸€ä¸ª prefix æ˜¯å¦ä¹Ÿæ˜¯ä¸€ä¸ªåˆæ³•çš„ keyã€‚è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œf è¿™ä¸ª node æ˜¯æœ‰å­èŠ‚ç‚¹çš„ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª prefixï¼Œä½†åŒæ—¶ï¼Œf ä¹Ÿæ˜¯ä¸€ä¸ª keyã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œ SuRF ä½¿ç”¨äº† â€˜$â€™ è¿™ä¸ªç¬¦å·ï¼ˆå®é™…å¯¹åº”çš„å€¼æ˜¯ 0xFFï¼‰æ¥è¡¨ç¤ºè¿™æ ·çš„æƒ…å†µã€‚&lt;/p&gt;&lt;p&gt;æœ€åä¸€ä¸ªå­—èŠ‚åºåˆ—å°±æ˜¯ D-Valuesï¼Œå­˜å‚¨çš„æ˜¯å›ºå®šå¤§å°çš„ valueã€‚Value å°±æ˜¯æŒ‰ç…§ æ¯å±‚ level çš„é¡ºåºå­˜æ”¾çš„ã€‚&lt;/p&gt;&lt;p&gt;å¦‚æœè¦è¿›è¡Œéå† LOUDS-Denseï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¹‹å‰æåˆ°çš„ rank å’Œ select æ“ä½œã€‚å¯¹äº bit åºåˆ— &lt;code class=&quot;inline&quot;&gt;bs&lt;/code&gt; æ¥è¯´ï¼Œæˆ‘ä»¬ç”¨ &lt;code class=&quot;inline&quot;&gt;rank1/select1(bs, pos)&lt;/code&gt; æ¥è¡¨ç¤ºåœ¨ &lt;code class=&quot;inline&quot;&gt;bs&lt;/code&gt; ä¸Šé¢ pos çš„ rank å’Œ select æ“ä½œã€‚è­¬å¦‚ï¼Œå‡è®¾ pos æ˜¯ D-Labels ä¸Šé¢çš„å½“å‰ bit posï¼Œå¦‚æœ &lt;code class=&quot;inline&quot;&gt;D-HasChild[pos] = 1&lt;/code&gt;ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹çš„ pos åˆ™æ˜¯ &lt;code class=&quot;inline&quot;&gt;D-ChildNodePos(pos) = 256 x rank1(D-HasChild, pos)&lt;/code&gt;ï¼Œè€Œçˆ¶èŠ‚ç‚¹åˆ™æ˜¯ &lt;code class=&quot;inline&quot;&gt;ParentNodePos(pos) = 256 x select1(D-HasChild, pos / 256)&lt;/code&gt;ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;LOUDS-Sparse&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;ä¸åŒäº LOUDS-Denseï¼ŒLOUDS-Sparse ä½¿ç”¨äº† bytes æˆ–è€… bits åºåˆ—æ¥ç¼–ç ã€‚ç¬¬ä¸€ä¸ª bytes åºåˆ—ï¼ŒS-Labelsï¼ŒæŒ‰ç…§ level order çš„æ–¹å¼è®°å½•äº†æ‰€æœ‰ node çš„ labelã€‚è­¬å¦‚ä¸Šå›¾çš„ &lt;code class=&quot;inline&quot;&gt;rst&lt;/code&gt; è¿™æ ·çš„ bytes é¡ºåºï¼ŒSparse ä»ç„¶ä½¿ç”¨äº† 0xFFï¼ˆä¹Ÿå°±æ˜¯ä¸Šå›¾çš„ &lt;code class=&quot;inline&quot;&gt;$&lt;/code&gt; ç¬¦å·ï¼‰æ¥è¡¨ç¤ºä¸€ä¸ª prefix keyã€‚å› ä¸ºè¿™æ ·çš„ 0xFF åªä¼šå‡ºç°åœ¨ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ä¸Šé¢ï¼Œæ‰€ä»¥æ˜¯èƒ½è·Ÿå®é™…çš„ 0xFF label è¿›è¡ŒåŒºåˆ†çš„ã€‚&lt;br&gt;ç¬¬äºŒä¸ª bit åºåˆ—å°±æ˜¯ S-HasChild, è¿™ä¸ªè·Ÿ D-HasChild å·®ä¸å¤šï¼Œå°±ä¸è§£é‡Šäº†ã€‚&lt;/p&gt;&lt;p&gt;ç¬¬ä¸‰ä¸ª bit åºåˆ— S-LOUDS ç”¨æ¥è¡¨ç¤ºï¼Œå¦‚æœä¸€ä¸ª label æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¯¹åº”çš„ S-LOUDS å°±è®¾ç½®ä¸º 1ï¼Œå¦åˆ™ä¸º 0ã€‚è­¬å¦‚ä¸Šå›¾ç¬¬ä¸‰å±‚ï¼Œrï¼Œp å’Œ i éƒ½æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¯¹åº”çš„ S-LOUDS å°±è®¾ç½®ä¸º 1 äº†ã€‚&lt;/p&gt;&lt;p&gt;æœ€åä¸€ä¸ª bytes åºåˆ—æ˜¯ S-Valuesï¼Œè·Ÿ D-Values ç±»ä¼¼ï¼Œä¸å†è§£é‡Šäº†ã€‚&lt;/p&gt;&lt;p&gt;å¦‚æœè¦ä¾¿åˆ© Sparseï¼Œä¹Ÿæ˜¯é€šè¿‡ rank å’Œ select è¿›è¡Œï¼Œè­¬å¦‚æ‰¾åˆ°ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ &lt;code class=&quot;inline&quot;&gt;S-ChildNodePos(pos) = select1(S-LOUDS, ranks(S-HasChild, pos) + 1)&lt;/code&gt;ï¼Œè€Œæ‰¾åˆ°çˆ¶èŠ‚ç‚¹åˆ™æ˜¯ &lt;code class=&quot;inline&quot;&gt;S-ParentNodePos(pos) = select1(S-HasChild, rank1(S-LOUDS, pos) - 1)&lt;/code&gt;ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;Optimization&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;å¯¹äº SuRF æ¥è¯´ï¼Œä¸ºäº†æé«˜æŸ¥è¯¢çš„é€Ÿåº¦ï¼Œä¸€ä¸ªé‡è¦çš„ä¼˜åŒ–æ‰‹æ®µå°±æ˜¯æé«˜ rank å’Œ select æ‰§è¡Œçš„æ•ˆç‡ï¼Œåœ¨ SuRF é‡Œé¢ï¼Œå¼•å…¥äº† LookUp Tableï¼ˆLUTï¼‰ã€‚&lt;/p&gt;&lt;img src=&quot;https://pic3.zhimg.com/v2-a07fb76d8e444f2c7d17b37492b5f7c6_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;700&quot; data-rawheight=&quot;242&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-a07fb76d8e444f2c7d17b37492b5f7c6&quot; data-watermark-src=&quot;v2-8036fccdff18afcfca8931b23c3129f6&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;å¯¹äº rank æ¥è¯´ï¼Œä¼šå°† bit vector åˆ‡åˆ†æˆ B bits å¤§å°çš„å—ï¼Œæ¯å—éƒ½ä½¿ç”¨ 32 bits çš„å­—æ®µæ¥é¢„å…ˆä¿å­˜äº†è®¡ç®—å¥½çš„åˆ°è¿™ä¸ª block çš„ rank å€¼ã€‚è­¬å¦‚ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ï¼Œç¬¬ä¸‰ä¸ªå°±æ˜¯ 7ï¼Œä¿å­˜çš„å°±æ˜¯å‰ä¸¤ä¸ª block æ€»çš„ rank æ•°é‡ã€‚&lt;/p&gt;&lt;p&gt;è€Œå¯¹äºä¸€ä¸ª pos æ¥è¯´ï¼Œå®ƒçš„ &lt;code class=&quot;inline&quot;&gt;rank1(pos) = LUT[i / B] + popcount[i / B * B, i]&lt;/code&gt;ï¼Œ&lt;code class=&quot;inline&quot;&gt;popcount&lt;/code&gt; æ˜¯ä¸€ä¸ª CPU æŒ‡ä»¤ï¼Œç”¨æ¥å¿«é€Ÿçš„è®¡ç®—æŸä¸€æ®µåŒºé—´çš„ 1 çš„ä¸ªæ•°ã€‚å‡è®¾æˆ‘ä»¬ç°åœ¨è¦å¾—åˆ° pos 12 çš„ rank å€¼ï¼Œå…ˆé€šè¿‡ &lt;code class=&quot;inline&quot;&gt;LUT[12 / 5] = LUT[2] = 7&lt;/code&gt;ï¼Œç„¶åå¾—åˆ° range &lt;code class=&quot;inline&quot;&gt;[12 / 5 * 5, 12] = [10, 12]&lt;/code&gt;ï¼Œä½¿ç”¨ &lt;code class=&quot;inline&quot;&gt;popcount&lt;/code&gt; å¾—åˆ° 2ï¼Œé‚£ä¹ˆ 12 çš„ rank å°±æ˜¯ 9ã€‚&lt;br&gt;å¯¹äº select æ¥è¯´ï¼Œä¹Ÿæ˜¯ä½¿ç”¨çš„ LUT æ–¹æ³•ï¼Œé¢„å…ˆè®°å½•ç®—å¥½çš„å€¼ã€‚å…·ä½“åˆ°ä¸Šé¢ï¼Œå‡è®¾å°†é‡‡æ ·çš„å‘¨æœŸè®¾ç½®ä¸º 3ï¼Œé‚£ä¹ˆç¬¬ä¸‰ä¸ª LUT å°±ä¿å­˜çš„æ˜¯ 3 x 2ï¼Œä¹Ÿå°±æ˜¯ç¬¬ 6 çš„ 1 çš„ pos å€¼ï¼Œä¹Ÿå°±æ˜¯ 8ã€‚å¯¹äºä¸€ä¸ª pos æ¥è¯´ï¼Œ&lt;code class=&quot;inline&quot;&gt;select1(i) = LUT[i / S] + (selecting (i - i / S * S)th set bit starting from LUT[i / S] + 1) + 1&lt;/code&gt;ã€‚è­¬å¦‚ï¼Œå¦‚æœæˆ‘ä»¬è¦å¾—åˆ° &lt;code class=&quot;inline&quot;&gt;select1(8)&lt;/code&gt;ï¼Œé¦–å…ˆå¾—åˆ° &lt;code class=&quot;inline&quot;&gt;LUT[8 / 3] = LUT[2] = 8&lt;/code&gt;ï¼Œç„¶åéœ€è¦ä» position &lt;code class=&quot;inline&quot;&gt;LUT[8 / 3] + 1 = 9&lt;/code&gt; è¿™ä¸ªä½ç½®ï¼Œå¾—åˆ°ç¬¬ &lt;code class=&quot;inline&quot;&gt;(8 - 8 / 3 * 3) = 2&lt;/code&gt; ä¸ªä½ç½®çš„ bitï¼Œä¹Ÿå°±æ˜¯ 1ï¼Œæ‰€ä»¥ &lt;code class=&quot;inline&quot;&gt;select1(8)&lt;/code&gt; å°±æ˜¯ 10ã€‚&lt;/p&gt;&lt;p&gt;å½“ç„¶ï¼ŒSuRF è¿˜æœ‰å…¶å®ƒå¾ˆå¤šä¼˜åŒ–æ‰‹æ®µï¼Œè­¬å¦‚ä½¿ç”¨ SIMD æ¥æé€Ÿ label çš„æŸ¥æ‰¾ï¼Œä½¿ç”¨ prefetchj æŠ€æœ¯ç­‰ï¼Œè¿™é‡Œå°±ä¸è¯´æ˜äº†ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;Succinct Range Filter&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;å¯¹äºé€šå¸¸çš„ SuRF æ¥è¯´ï¼Œå®ƒå› ä¸ºå¯¹è¿™ä¸ª trie éƒ½è¿›è¡Œäº†ç¼–ç ï¼Œæ‰€ä»¥å®ƒæ˜¯å®Œå…¨ç²¾ç¡®çš„ï¼Œè™½ç„¶å®ƒæ˜¯ä¸€ç§çœç©ºé—´çš„æ•°æ®ç»“æ„ï¼Œä½†å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦èƒ½ä¿è¯åœ¨å†…å­˜é‡Œé¢å­˜å‚¨æ‰€æœ‰çš„ SuRF æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦å¯¹ SuRF è¿›è¡Œè£å‰ªï¼Œä¸å­˜å‚¨æ‰€æœ‰çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æŸ¥è¯¢çš„ False Positive Rateï¼ˆFPRï¼‰å’Œç©ºé—´ä¸Šé¢åšä¸€ä¸ªæƒè¡¡ã€‚&lt;/p&gt;&lt;p&gt;åœ¨ SuRF é‡Œé¢ï¼Œæœ‰å‡ ç§æ–¹å¼ï¼ŒBasicï¼ŒHashï¼ŒReal ä»¥åŠ Mixedã€‚&lt;/p&gt;&lt;img src=&quot;https://pic1.zhimg.com/v2-d99c188249d1164000c0c7b3dadf4f0e_r.jpg&quot; data-caption=&quot;&quot; data-size=&quot;normal&quot; data-rawwidth=&quot;700&quot; data-rawheight=&quot;379&quot; data-watermark=&quot;watermark&quot; data-original-src=&quot;v2-d99c188249d1164000c0c7b3dadf4f0e&quot; data-watermark-src=&quot;v2-d309450eabe0749b86f8173b32218c2b&quot; data-private-watermark-src=&quot;&quot;&gt;&lt;p&gt;&lt;br&gt;Basic æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ç›´æ¥å°†æœ€åé¢çš„å¶å­å±‚å…¨éƒ¨ç æ‰ï¼Œè¿™æ ·å…¶å®æ˜¯æœ€çœç©ºé—´çš„ï¼Œä½† FPR ä¼šæ¯”è¾ƒé«˜ã€‚Hash çš„æ–¹å¼ï¼Œåˆ™æ˜¯åœ¨æœ€åº•å±‚ï¼Œä¿å­˜äº†è¿™ä¸ª key n bits ä½çš„ hash å€¼ï¼Œè¿™æ ·èƒ½æ˜¾è‘—å‡å°‘ point get çš„ FPRï¼Œä½†å¯¹äº range æ“ä½œåˆ™æ²¡æœ‰ä»»ä½•å¸®åŠ©ã€‚&lt;/p&gt;&lt;p&gt;ä¸ºäº†è§£å†³ Hash range æŸ¥è¯¢çš„é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Real æ–¹å¼ï¼Œåœ¨æœ€åé¢ç»§ç»­ä¿å­˜ n bits ä½çš„ key æ•°æ®ã€‚Real è™½ç„¶èƒ½å¤„ç† point get å’Œ rangeï¼Œä½†å®ƒçš„ FPR å…¶å®æ˜¯æ¯” Hash è¦é«˜çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Mixed æ–¹å¼ï¼Œå°† Hash å’Œ Real æ··åˆåœ¨ä¸€èµ·ä½¿ç”¨ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;Example&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;SuRF çš„ä»£ç å·²ç»å¼€æºï¼Œå¤§å®¶å¯ä»¥è‡ªå·±ä» &lt;a href=&quot;https://github.com/efficient/SuRF&quot;&gt;Github&lt;/a&gt; è·å–åˆ°ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿéå¸¸çš„ç®€å•ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­ï¼š&lt;/p&gt;&lt;code lang=&quot;text&quot;&gt;vector&amp;lt;string&amp;gt; words = {
 &quot;f&quot;,
 &quot;farther&quot;,
 &quot;fas&quot;
 &quot;trying&quot;
};

SuRF s(words, true, 16, kNone, 0, 0);

cout &amp;lt;&amp;lt; &quot;Find abc &quot; &amp;lt;&amp;lt; s.lookupKey(&quot;abc&quot;) &amp;lt;&amp;lt; endl;
cout &amp;lt;&amp;lt; &quot;Find trying &quot; &amp;lt;&amp;lt; s.lookupKey(&quot;trying&quot;) &amp;lt;&amp;lt; endl; &lt;/code&gt;&lt;p&gt;ä¸Šé¢æˆ‘åˆ›å»ºäº†ä¸€ä¸ª SuRFï¼Œä¼ å…¥äº†ä¸€æ‰¹ wordsï¼Œä½¿ç”¨äº† Full Trie çš„æ¨¡å¼ï¼Œç„¶ååšäº†ä¸¤æ¬¡ç‚¹æŸ¥ã€‚&lt;br&gt;å…·ä½“ä»£ç ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å»ç ”ç©¶ä¸‹ï¼Œä»£ç è´¨é‡è¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚&lt;/p&gt;&lt;h2&gt;&lt;b&gt;Epilogue&lt;/b&gt;&lt;/h2&gt;&lt;p&gt;SuRF çš„ç ”ç©¶å°±æš‚æ—¶åˆ°è¿™é‡Œç»“æŸäº†ï¼Œå¯¹äº Succinct Data Structureï¼Œæˆ‘ä¸ªäººè¿˜æ˜¯è§‰å¾—å¾ˆæœ‰æ„æ€ï¼Œå¯ä»¥æ¢ç©¶çš„ä¸œè¥¿æŒºå¤šçš„ï¼Œæ¯•ç«Ÿå¦‚æœèƒ½æŠŠæŸ¥è¯¢ç´¢å¼•å…¨æ”¾åœ¨å†…å­˜ï¼Œä¸èµ°ç£ç›˜ï¼Œæ€§èƒ½è¿˜æ˜¯éå¸¸ä¸é”™çš„ã€‚ä½†æˆ‘ä¸ªäººæ¯•ç«Ÿæ°´å¹³æœ‰é™ï¼Œä»…ä»…é™äºäº†è§£ï¼Œæ‰€ä»¥ç‰¹åˆ«å¸Œæœ›èƒ½è·Ÿä¸šç•Œçš„å¤§ç‰›å¤šå¤šäº¤æµã€‚å¦‚æœä½ ä¹Ÿå¯¹è¿™å—å¾ˆæ„Ÿå…´è¶£ï¼Œæ¬¢è¿è”ç³»æˆ‘ &lt;a href=&quot;mailto:tl@pingcap.com&quot;&gt;tl@pingcap.com&lt;/a&gt;ã€‚&lt;/p&gt;</description>
<author>ZoeyZhai</author>
<guid isPermaLink="false">2018-06-22-38385054</guid>
<pubDate>Fri, 22 Jun 2018 00:00:00 +0800</pubDate>
</item>
</channel>
</rss>
