<div class="title-image"><img src="https://pic4.zhimg.com/v2-6d3fbfcd00ac16612dbb8cae27304da6_b.jpg" alt=""></div><p>在计算反向传播或最优化问题时，经常遇到向量、矩阵、张量对向量、矩阵、张量的求导问题，而类比普通函数求导经常无法处理矩阵转置的问题，因此需要使用一套更简单的符号系统进行运算，即<a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Ricci_calculus" class=" wrap external" target="_blank" rel="nofollow noreferrer">里奇微积分</a>。</p><h2><a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Einstein_notation" class=" wrap external" target="_blank" rel="nofollow noreferrer">爱因斯坦求和约定</a></h2><p>相乘时符号相同且共轭的指标，如一个<a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Covariance_and_contravariance_of_vectors" class=" wrap external" target="_blank" rel="nofollow noreferrer">共变自由指标</a>(下标）遇到一个符号相同的<a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Covariance_and_contravariance_of_vectors" class=" wrap external" target="_blank" rel="nofollow noreferrer">反变自由指标</a>（上标），会发生缩并运算成为哑指标，整个表达式自由指标的个数表示最终结果的自由指标个数；当自由指标只有一个 <img src="https://www.zhihu.com/equation?tex=i" alt="i" eeimg="1"/> （如 <img src="https://www.zhihu.com/equation?tex=x%5Ei%2CA_i%5Ejx%5Ei%3Dy%5Ej" alt="x^i,A_i^jx^i=y^j" eeimg="1"/> ）时，表达式是一个向量（一维张量），有两个 <img src="https://www.zhihu.com/equation?tex=i%2Cj" alt="i,j" eeimg="1"/> （如 <img src="https://www.zhihu.com/equation?tex=A_i%5Ej%2CA%5E%7Bij%7D%2CA_i%5Ejx%5Ej" alt="A_i^j,A^{ij},A_i^jx^j" eeimg="1"/> ）时，表达式是一个二维张量，以此类推。</p><h2><b>符号约定</b></h2><p><img src="https://www.zhihu.com/equation?tex=R%5En" alt="R^n" eeimg="1"/> 表示n维列向量空间， <img src="https://www.zhihu.com/equation?tex=R%5E%7Bn%2A%7D" alt="R^{n*}" eeimg="1"/> 表示n维行向量空间，<img src="https://www.zhihu.com/equation?tex=A_%7Bij%7D" alt="A_{ij}" eeimg="1"/> 表示<a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Bilinear_map" class=" wrap external" target="_blank" rel="nofollow noreferrer">双线性映射</a> <img src="https://www.zhihu.com/equation?tex=R%5En%5Ctimes+R%5En%5Crightarrow+R" alt="R^n\times R^n\rightarrow R" eeimg="1"/>  ， <img src="https://www.zhihu.com/equation?tex=A%5E%7Bij%7D" alt="A^{ij}" eeimg="1"/> 表示双线性映射 <img src="https://www.zhihu.com/equation?tex=R%5E%7Bn%2A%7D%5Ctimes+R%5E%7Bn%2A%7D%5Crightarrow+R" alt="R^{n*}\times R^{n*}\rightarrow R" eeimg="1"/>，<img src="https://www.zhihu.com/equation?tex=x%5Ei" alt="x^i" eeimg="1"/> 表示列向量 <img src="https://www.zhihu.com/equation?tex=x" alt="x" eeimg="1"/>， <img src="https://www.zhihu.com/equation?tex=x_i" alt="x_i" eeimg="1"/> 表示行向量<img src="https://www.zhihu.com/equation?tex=x%5ET" alt="x^T" eeimg="1"/>（也叫<a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Linear_form" class=" wrap external" target="_blank" rel="nofollow noreferrer">线性泛函</a>或余向量）。</p><p><img src="https://www.zhihu.com/equation?tex=%5Cdelta_i%5Ej" alt="\delta_i^j" eeimg="1"/> 是一个单位矩阵， <img src="https://www.zhihu.com/equation?tex=%5Cdelta_%7Bij%7D" alt="\delta_{ij}" eeimg="1"/> 是度量张量（一个双线性映射）， <img src="https://www.zhihu.com/equation?tex=%5Cdelta%5E%7Bij%7D" alt="\delta^{ij}" eeimg="1"/> 是共轭度量张量，它们有这些性质：<img src="https://www.zhihu.com/equation?tex=x%5Ej%28%3Dx%29" alt="x^j(=x)" eeimg="1"/> 表示原向量则<img src="https://www.zhihu.com/equation?tex=%5Cdelta_%7Bij%7Dx%5Ej%3Dx_i%28%3Dx%5E%7B%5Ctop%7D%29" alt="\delta_{ij}x^j=x_i(=x^{\top})" eeimg="1"/> 表示转置向量， <img src="https://www.zhihu.com/equation?tex=%5Cdelta%5Ei_jx%5Ei%3D%5Coperatorname%7Bdiag%7D%28x%29" alt="\delta^i_jx^i=\operatorname{diag}(x)" eeimg="1"/> ， <img src="https://www.zhihu.com/equation?tex=A_j%5Ei%28%3DA%29" alt="A_j^i(=A)" eeimg="1"/> 表示原矩阵则<img src="https://www.zhihu.com/equation?tex=%5Cdelta_%7Bii%7D%5Cdelta%5E%7Bjj%7DA_j%5Ei%28%3DA%5E%5Ctop%29" alt="\delta_{ii}\delta^{jj}A_j^i(=A^\top)" eeimg="1"/> 表示转置矩阵， <img src="https://www.zhihu.com/equation?tex=%5Cdelta_%7Bii%7D%5Cdelta%5E%7Bii%7D%3D1" alt="\delta_{ii}\delta^{ii}=1" eeimg="1"/> ， <img src="https://www.zhihu.com/equation?tex=%5Cdelta_%7Bij%7D%5Cdelta%5E%7Bii%7D%3D%5Cdelta_j%5Ei" alt="\delta_{ij}\delta^{ii}=\delta_j^i" eeimg="1"/> ，<img src="https://www.zhihu.com/equation?tex=%5Cfrac%7Bdx_i%7D%7Bdx%5Ej%7D%3D%5Cdelta_i%5Ej" alt="\frac{dx_i}{dx^j}=\delta_i^j" eeimg="1"/> ， <img src="https://www.zhihu.com/equation?tex=%5Cfrac%7Bdx%5Ei%7D%7Bdx%5Ej%7D%3D%5Cdelta%5E%7Bij%7D" alt="\frac{dx^i}{dx^j}=\delta^{ij}" eeimg="1"/> ， <img src="https://www.zhihu.com/equation?tex=%5Cfrac%7Bdx_i%7D%7Bdx_j%7D%3D%5Cdelta_%7Bij%7D" alt="\frac{dx_i}{dx_j}=\delta_{ij}" eeimg="1"/> ， <img src="https://www.zhihu.com/equation?tex=%5Cfrac%7Bd+X_i%5Ej%7D%7Bd+X_k%5El%7D+%3D+%5Cdelta%5E%7Bjl%7D%5Cdelta_%7Bik%7D" alt="\frac{d X_i^j}{d X_k^l} = \delta^{jl}\delta_{ik}" eeimg="1"/> </p><h2>矩阵表示与Ricci Calculus表示法的对比</h2><p><img src="https://www.zhihu.com/equation?tex=c+%3D+x+%5E+%7B+%5Ctop+%7D+y+%5Cquad+c+%3D+x+_+%7B+i+%7D+y+%5E+%7B+i+%7D" alt="c = x ^ { \top } y \quad c = x _ { i } y ^ { i }" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=x+%3D+A+y+%5Cquad+x+%5E+%7B+i+%7D+%3D+A+_+%7B+j+%7D+%5E+%7B+i+%7D+y+%5E+%7B+j+%7D" alt="x = A y \quad x ^ { i } = A _ { j } ^ { i } y ^ { j }" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=x+%5E+%7B+%5Ctop+%7D+%3D+y+%5E+%7B+%5Ctop+%7D+A+%5Cquad+x+_+%7B+j+%7D+%3D+y+_+%7B+i+%7D+A+_+%7B+j+%7D+%5E+%7B+i+%7D" alt="x ^ { \top } = y ^ { \top } A \quad x _ { j } = y _ { i } A _ { j } ^ { i }" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=C+%3D+A+%5Ccdot+B+%5Cquad+C+_+%7B+k+%7D+%5E+%7B+i+%7D+%3D+A+_+%7B+j+%7D+%5E+%7B+i+%7D+B+_+%7B+k+%7D+%5E+%7B+j+%7D" alt="C = A \cdot B \quad C _ { k } ^ { i } = A _ { j } ^ { i } B _ { k } ^ { j }" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=A+%3D+x+y+%5E+%7B+%5Ctop+%7D+%5Cquad+A+_+%7B+j+%7D+%5E+%7B+i+%7D+%3D+x+%5E+%7B+i+%7D+y+_+%7B+j+%7D" alt="A = x y ^ { \top } \quad A _ { j } ^ { i } = x ^ { i } y _ { j }" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=z+%3D+x+%5Codot+y+%5Cquad+z+%5E+%7B+i+%7D+%3D+x+%5E+%7B+i+%7D+y+%5E+%7B+i+%7D" alt="z = x \odot y \quad z ^ { i } = x ^ { i } y ^ { i }" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=A%3Dx%5Cotimes+y+%5Cquad++A%5E%7Bij%7D%3Dx%5Ei+y%5Ej" alt="A=x\otimes y \quad  A^{ij}=x^i y^j" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=C%3DA%5Cotimes+B%5Cquad+C%5E%7Bij%7D_%7Bkl%7D%3DA_k%5Ei+B_l%5Ej" alt="C=A\otimes B\quad C^{ij}_{kl}=A_k^i B_l^j" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=B%3DA%5Cotimes+x%5Cquad+B_%7Bij%7D%5Ek%3DA_%7Bij%7Dx%5Ek" alt="B=A\otimes x\quad B_{ij}^k=A_{ij}x^k" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=B+%3D+A+%5Coperatorname+%7B+diag+%7D+%28+x+%29+%5Cquad+B+_+%7B+j+%7D+%5E+%7B+i+%7D+%3D+A+_+%7B+j+%7D+%5E+%7B+i+%7D+x+_+%7B+j+%7D" alt="B = A \operatorname { diag } ( x ) \quad B _ { j } ^ { i } = A _ { j } ^ { i } x _ { j }" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=B+%3D+%5Coperatorname+%7B+diag+%7D+%28+x+%29+A+%5Cquad+B+_+%7B+j+%7D+%5E+%7B+i+%7D+%3D+x+%5E+%7B+i+%7D+A+_+%7B+j+%7D+%5E+%7B+i+%7D" alt="B = \operatorname { diag } ( x ) A \quad B _ { j } ^ { i } = x ^ { i } A _ { j } ^ { i }" eeimg="1"/> </p><h2><b>示例</b></h2><p>根据上述原理计算 <img src="https://www.zhihu.com/equation?tex=x%5ETAx" alt="x^TAx" eeimg="1"/> 对 <img src="https://www.zhihu.com/equation?tex=x" alt="x" eeimg="1"/> 的导数：</p><p><img src="https://www.zhihu.com/equation?tex=%5Cfrac%7Bd+%28x%5E%7B%5Ctop%7DAx%29%7D%7Bdx%7D" alt="\frac{d (x^{\top}Ax)}{dx}" eeimg="1"/></p><p><img src="https://www.zhihu.com/equation?tex=%3D%5Cfrac%7Bd+%28x_i+A_j%5Ei+x%5Ej%29%7D%7Bd+x%5Ek%7D" alt="=\frac{d (x_i A_j^i x^j)}{d x^k}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3D%5Cfrac%7Bd+x_i%7D%7Bd+x%5Ek%7DA_j%5Ei+x%5Ej%2Bx_i+A_j%5Ei+%5Cfrac%7Bd+x%5Ej%7D%7Bd+x%5Ek%7D" alt="=\frac{d x_i}{d x^k}A_j^i x^j+x_i A_j^i \frac{d x^j}{d x^k}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3D%5Cdelta_i%5Ek+A_j%5Ei+x%5Ej%2B+x_i+A_j%5Ei+%5Cdelta%5E%7Bjk%7D" alt="=\delta_i^k A_j^i x^j+ x_i A_j^i \delta^{jk}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3DA_j%5Ek+x%5Ej%2Bx_i+A_j%5Ei+%5Cdelta%5E%7Bjk%7D+%5Cdelta_%7Bkk%7D+%5Cdelta%5E%7Bkk%7D" alt="=A_j^k x^j+x_i A_j^i \delta^{jk} \delta_{kk} \delta^{kk}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3DA_j%5Ek+x%5Ej%2Bx_i+A_j%5Ei+%5Cdelta%5E%7Bj%7D_k+%5Cdelta%5E%7Bkk%7D" alt="=A_j^k x^j+x_i A_j^i \delta^{j}_k \delta^{kk}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3DA_j%5Ek+x%5Ej%2Bx_i+A_k%5Ei++%5Cdelta%5E%7Bkk%7D" alt="=A_j^k x^j+x_i A_k^i  \delta^{kk}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3DA_j%5Ek+x%5Ej%2B%5Cdelta_%7Bii%7Dx%5Ei+A_k%5Ei++%5Cdelta%5E%7Bkk%7D" alt="=A_j^k x^j+\delta_{ii}x^i A_k^i  \delta^{kk}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3DAx%2BA%5E%7B%5Ctop%7Dx" alt="=Ax+A^{\top}x" eeimg="1"/> </p><p>计算 <img src="https://www.zhihu.com/equation?tex=y%5Codot+%28Xw%29" alt="y\odot (Xw)" eeimg="1"/> 对 <img src="https://www.zhihu.com/equation?tex=X" alt="X" eeimg="1"/> 的导数：</p><p><img src="https://www.zhihu.com/equation?tex=%5Cfrac%7B%5Cpartial+%28y%5Codot+%28Xw%29%29%7D%7B%5Cpartial+X%7D" alt="\frac{\partial (y\odot (Xw))}{\partial X}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3D%5Cfrac%7B%5Cpartial+%28y%5Ei+X_j%5Eiw%5Ej%29%7D%7B%5Cpartial+X_k%5El%7D" alt="=\frac{\partial (y^i X_j^iw^j)}{\partial X_k^l}" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3Dy%5Ei%5Cdelta%5E%7Bil%7D%5Cdelta_%7Bjk%7Dw%5Ej" alt="=y^i\delta^{il}\delta_{jk}w^j" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3Dy%5Ei%5Cdelta%5E%7Bil%7Dw_k" alt="=y^i\delta^{il}w_k" eeimg="1"/> </p><p><img src="https://www.zhihu.com/equation?tex=%3D%5Coperatorname%7Bdiag%7D%28y%29%5Cotimes+w%5E%5Ctop" alt="=\operatorname{diag}(y)\otimes w^\top" eeimg="1"/> </p><p>需要注意的是， <img src="https://www.zhihu.com/equation?tex=%5Cdelta_%7Bii%7D" alt="\delta_{ii}" eeimg="1"/> 和 <img src="https://www.zhihu.com/equation?tex=%5Cdelta%5E%7Bii%7D" alt="\delta^{ii}" eeimg="1"/> 并不像常规的Kronecker符号一样等于n（n是下标对应的维数），而是满足<img src="https://www.zhihu.com/equation?tex=%5Cdelta_%7Bii%7D%5Cdelta%5E%7Bii%7D%3D1" alt="\delta_{ii}\delta^{ii}=1" eeimg="1"/> ，它有特殊的用途。在本文中，它主要用于表示矩阵转置。在爱因斯坦约定中，表示矩阵转置是一个容易引起记号混乱的事，如果使用 <img src="https://www.zhihu.com/equation?tex=A_i%5Ej" alt="A_i^j" eeimg="1"/> 表示原矩阵（方阵）， <img src="https://www.zhihu.com/equation?tex=A_j%5Ei" alt="A_j^i" eeimg="1"/> 表示转置矩阵，那么原本 <img src="https://www.zhihu.com/equation?tex=A_i%5Ej+x%5Ei%3Dy%5Ej" alt="A_i^j x^i=y^j" eeimg="1"/> ，转置后却因为指标无法缩并而无法相乘得到列向量了： <img src="https://www.zhihu.com/equation?tex=A_j%5Ei+%3F+x%5Ei" alt="A_j^i ? x^i" eeimg="1"/> ，这是匪夷所思的。但是根据上面的定义，可以使用 <img src="https://www.zhihu.com/equation?tex=A_j%5Ei+%5Cdelta_%7Bii%7D%5Cdelta%5E%7Bjj%7Dx%5Ei" alt="A_j^i \delta_{ii}\delta^{jj}x^i" eeimg="1"/> 表示 <img src="https://www.zhihu.com/equation?tex=A%5E%5Ctop+x" alt="A^\top x" eeimg="1"/> ，而不会产生歧义。事实上，在爱因斯坦约定中，指标只能用于表示张量的各个维，如果张量是对称的，那么不管怎么排列指标，表达式看起来都是一样的，因此本文的参考文献[4]使用了上述 <img src="https://www.zhihu.com/equation?tex=%5Cdelta_%7Bii%7D" alt="\delta_{ii}" eeimg="1"/> 和 <img src="https://www.zhihu.com/equation?tex=%5Cdelta%5E%7Bii%7D" alt="\delta^{ii}" eeimg="1"/> 符号规避了此问题。</p><p>如果你没有看懂本文，没有关系，使用参考文献[4]对应的网站<a href="https://link.zhihu.com/?target=http%3A//matrixcalculus.org/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://</span><span class="visible">matrixcalculus.org/</span><span class="invisible"></span></a>即可在线计算矩阵、张量求导。即使你不懂如何计算爱因斯坦约定，你也可以通过numpy的<a href="https://link.zhihu.com/?target=https%3A//docs.scipy.org/doc/numpy/reference/generated/numpy.einsum.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">np.einsum()</a>来帮助你计算爱因斯坦约定，更多有关爱因斯坦约定的内容请参考[10]。</p><p>在tensorflow中使用<a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Einstein_notation" class=" wrap external" target="_blank" rel="nofollow noreferrer">爱因斯坦求和约定</a>可以极大的简化代码，使用以下代码实现矩阵乘法：</p><p><img src="https://www.zhihu.com/equation?tex=R%3DA+B%5Cquad+R_i%5Ek%3DA_i%5Ej+B_j%5Ek" alt="R=A B\quad R_i^k=A_i^j B_j^k" eeimg="1"/> </p><div class="highlight"><pre><code class="language-python3"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,jk-&gt;ik&#39;</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">)</span></code></pre></div><p><b>参考文献</b></p><p>[1] <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Matrix_calculus" class=" wrap external" target="_blank" rel="nofollow noreferrer">Matrix calculus - Wikipedia</a> </p><p>[2] <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Tensor_index_notation" class=" wrap external" target="_blank" rel="nofollow noreferrer">Ricci calculus - Wikipedia</a></p><p>[3] <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Kronecker_delta" class=" wrap external" target="_blank" rel="nofollow noreferrer">Kronecker delta - Wikipedia</a></p><p>[4] S. Laue, M. Mitterreiter, and J. Giesen. Computing Higher Order Derivatives of Matrix and Tensor Expressions, NIPS 2018.</p><p>[5] <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Einstein_notation" class=" wrap external" target="_blank" rel="nofollow noreferrer">Einstein notation</a></p><p>[6] <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Bilinear_map" class=" wrap external" target="_blank" rel="nofollow noreferrer">Bilinear map - Wikipedia</a></p><p>[7] <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Linear_form" class=" wrap external" target="_blank" rel="nofollow noreferrer">Linear form - Wikipedia</a></p><p>[8] <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Covariance_and_contravariance_of_vectors" class=" wrap external" target="_blank" rel="nofollow noreferrer">Covariance and contravariance of vectors</a></p><p>[9] <a href="https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Abstract_index_notation" class=" wrap external" target="_blank" rel="nofollow noreferrer">Abstract index notation</a></p><p>[10] <a href="https://link.zhihu.com/?target=https%3A//zhangwfjh.wordpress.com/2014/07/19/einstein-notation-and-generalized-kronecker-symbol/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Einstein notation and generalized Kronecker symbol</a> </p>