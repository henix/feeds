<div class="title-image"><img src="https://pic2.zhimg.com/v2-d63fcd68ed6b6261b19e8522acc140a0_b.jpg" alt=""></div><p>又到了 CTF 知识拓展时刻，今天讲的是 Hash 长度扩展攻击，顾名思义，跟 Hash 有关，那什么是 Hash 呢？</p><h2>Hash 算法</h2><p>Hash 算法也被称为 散列算法，就是把任意长度的输入通过散列算法变换成固定长度的输出，该输出就是散列值。</p><p>简单来说，就是一种通过单向函数加密明文生成消息摘要的算法。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-66b0996b01b2a3b61f65e771f9935ae9_b.jpg" data-caption="" data-size="normal" data-rawwidth="604" data-rawheight="197" class="origin_image zh-lightbox-thumb" width="604" data-original="https://pic2.zhimg.com/v2-66b0996b01b2a3b61f65e771f9935ae9_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-66b0996b01b2a3b61f65e771f9935ae9_b.jpg" data-caption="" data-size="normal" data-rawwidth="604" data-rawheight="197" class="origin_image zh-lightbox-thumb lazy" width="604" data-original="https://pic2.zhimg.com/v2-66b0996b01b2a3b61f65e771f9935ae9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-66b0996b01b2a3b61f65e771f9935ae9_b.jpg"/></figure><p>常见的 Hash 函数有 md5 和 sha-1 两种。以 MD5 为例：</p><h2>md5算法</h2><p><b>MD5信息摘要算法</b>，一种被广泛使用的密码散列函数，可以产生出一个128位（16字节）的散列值（hash value），用于确保信息传输完整一致。</p><blockquote>MD5算法的原理可简要的叙述为：MD5 码以 512 位分组来处理输入的信息，且每一分组又被划分为 16 个 32 位子分组，经过了一系列的处理后，算法的输出由四个 32 位分组组成，将这四个 32 位分组级联后将生成一个 128 位散列值。</blockquote><p>MD5 算法中，最重要的就是一点就是 <b>补位。</b></p><p><b>补位</b></p><p>在 MD5 算法中，首先需要对信息进行填充，这个数据按位(bit)补充，要求最终的位数对 512 求模的结果为 448。</p><p><b>补位方式</b></p><p>在消息的后面加上一个 1，然后无限补 0，满足 <b>M mod 512 == 448 </b>为止。</p><p><b>为什么只补到 448 位？</b></p><p>因为剩下的 8字节（64位）要用来储存原消息的长度。</p><p>例如：12 34 56 78 在这里会存储为 78 56 34 12</p><blockquote><b>计算消息摘要这里就不详细讲解了。</b></blockquote><h2>Hash长度拓展攻击</h2><p>从一道题目入手：</p><div class="highlight"><pre><code class="language-text">&lt;?php
include &#34;secret.php&#34;;
@$username=(string)$_POST[&#39;username&#39;]; 
function enc($text){
    global $key;
    return md5($key.$text);
}
if(enc($username) === $_COOKIE[&#39;verify&#39;]){
    if(is_numeric(strpos($username, &#34;admin&#34;))){
    }
    else{
        die(&#34;you are not admin&#34;);
    }
}
else{
    setcookie(&#34;verify&#34;, enc(&#34;guest&#34;), time()+60*60*24*7);
    setcookie(&#34;len&#34;, strlen($key), time()+60*60*24*7);
}
show_source(__FILE__);
?&gt;</code></pre></div><p>抓包可得到：</p><ul><li>md5($key.&#34;guest&#34;)=f8d7a112644f7e71e1e8ad068f144f61</li><li>len($key)=21</li></ul><p>先进行 hash 长度扩展：</p><p>$key 的长度为 21 个字节，后面是字符串 guest，补位到 448 位。</p><p>计算数据长度：hex( (21+5)*8 ) =0xD0，再填充剩余位数。</p><p>代码要求 POST 的值要有 admin 这一字符串，所以添加一个 admin 在末尾作为拓展。</p><p>得到 $username ：</p><div class="highlight"><pre><code class="language-text">guest\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xD0\x00\x00\x00\x00\x00\x00\x00admin</code></pre></div><p>这里需要把 \x 转换为 %（url 编码）</p><div class="highlight"><pre><code class="language-text">guest%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%d0%00%00%00%00%00%00%00admin</code></pre></div><p>为了让判断成立，还需要计算出拓展之后的 cookie。</p><div class="highlight"><pre><code class="language-text">if(enc($username) === $_COOKIE[&#39;verify&#39;])</code></pre></div><p>得到 flag：</p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-75cbf2723bd0e20fb94a97a13e19fe6d_b.jpg" data-caption="" data-size="small" data-rawwidth="1496" data-rawheight="292" class="origin_image zh-lightbox-thumb" width="1496" data-original="https://pic2.zhimg.com/v2-75cbf2723bd0e20fb94a97a13e19fe6d_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-75cbf2723bd0e20fb94a97a13e19fe6d_b.jpg" data-caption="" data-size="small" data-rawwidth="1496" data-rawheight="292" class="origin_image zh-lightbox-thumb lazy" width="1496" data-original="https://pic2.zhimg.com/v2-75cbf2723bd0e20fb94a97a13e19fe6d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-75cbf2723bd0e20fb94a97a13e19fe6d_b.jpg"/></figure><h2>相关利用工具x3</h2><p><b>hashpump</b></p><p>在各种哈希算法中哈希长度扩展攻击的利用工具。</p><p>下载地址：<a href="https://link.zhihu.com/?target=https%3A//github.com/bwall/HashPump" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/bwall/HashPu</span><span class="invisible">mp</span><span class="ellipsis"></span></a></p><p><b>hash_extender</b></p><p>哈希扩展器。</p><p>下载地址：<a href="https://link.zhihu.com/?target=https%3A//github.com/iagox86/hash_extender" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/iagox86/hash</span><span class="invisible">_extender</span><span class="ellipsis"></span></a></p><p><b>md5-extension-attack</b></p><p>MD5 长度扩展攻击工具。</p><p>下载地址：<a href="https://link.zhihu.com/?target=https%3A//github.com/JoyChou93/md5-extension-attack" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/JoyChou93/md</span><span class="invisible">5-extension-attack</span><span class="ellipsis"></span></a></p><p>更多网络安全学习尽在 <a href="https://link.zhihu.com/?target=https%3A//www.baidu.com/link%3Furl%3DOcGTJIGtwpNYrGru7tSszpEf10ZQ0xIE7SvER9ejNcCar00KI-fG2lu214M4WKPc%26wd%3D%26eqid%3Da24dabb2002f492b000000065e13d46a" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a>，另外，网络安全技能包又更新了！学 Python 的也能当黑客了，多实战沉浸式体验，让你回味无穷。</p><p>让你从 <b>程序猿→黑客x程序员 PLUS</b>！</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_b.jpg" data-caption="" data-size="normal" data-rawwidth="3058" data-rawheight="1720" class="origin_image zh-lightbox-thumb" width="3058" data-original="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_b.jpg" data-caption="" data-size="normal" data-rawwidth="3058" data-rawheight="1720" class="origin_image zh-lightbox-thumb lazy" width="3058" data-original="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-718b79371d6ca42244a942f02f2b537c_b.jpg"/></figure><p>更多有关渗透测试的内容请前往<a href="https://link.zhihu.com/?target=https%3A//www.baidu.com/link%3Furl%3DOcGTJIGtwpNYrGru7tSszpEf10ZQ0xIE7SvER9ejNcCar00KI-fG2lu214M4WKPc%26wd%3D%26eqid%3Da24dabb2002f492b000000065e13d46a" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a>进行学习，最近推出了“挖洞”班，想了解更多资讯的，可咨询客服微信 <b>twosecurity02</b></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg" data-caption="" data-size="normal" data-rawwidth="3041" data-rawheight="2000" class="origin_image zh-lightbox-thumb" width="3041" data-original="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg" data-caption="" data-size="normal" data-rawwidth="3041" data-rawheight="2000" class="origin_image zh-lightbox-thumb lazy" width="3041" data-original="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg"/></figure><p></p>