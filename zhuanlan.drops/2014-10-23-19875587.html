<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Android证书信任问题与大表哥</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/19875587">原文</a></p>
<h2>0x00 起因</h2><p>1、近期icloud.com、yahoo.com、apple.com遭遇到大规模劫持</p><p><a href="http://www.wooyun.org/bugs/wooyun-2014-080117" data-editable="true" data-title="WooYun: Yahoo雅虎在国内访问遭遇SSL中间人攻击（被替换为自签名证书）" class="">WooYun: Yahoo雅虎在国内访问遭遇SSL中间人攻击（被替换为自签名证书）</a></p><p>2、乌云平台、CVE都收到大量有关Android APP信任所有证书的漏洞</p><p><a href="http://www.wooyun.org/bugs/wooyun-2014-079358" data-editable="true" data-title="WooYun: 国内绝大部分Android APP存在信任所有证书漏洞">WooYun: 国内绝大部分Android APP存在信任所有证书漏洞</a></p><p>3、老外写有关大表哥的文章中提到MITM时360浏览器不提示证书错误</p><p><a href="http://www.computerworld.com/article/2836084/chinese-big-brother-launches-nationwide-attack-on-icloud.html" data-editable="true" data-title="Chinese Big Brother launches nationwide attack on iCloud" class="">Chinese Big Brother launches nationwide attack on iCloud</a></p><p>之前信任证书问题一直都有被提到，但是普遍不受大家重视，因为这个漏洞是利用是需要场景的：MITM（中间人攻击 Man-in-the-middle attack）。一般情况下MITM相对其他攻击是比较少见的，如果有良好的上网习惯如不接入不受信任的网络，那就更少可能受此类攻击了。但是近期发生的MITM据传是在核心骨干网BGP上做了改动所以劫持范围非常之广，真是防不胜防呀，你被劫持了么？</p><h2>0x01 科普</h2><p><strong>https&amp;&amp;ssl</strong></p><p>为了提高网站的安全性，一般会在比较敏感的部分页面采用https传输，比如注册、登录、控制台等。像Gmail、网银、icloud等则全部采用https传输。https/ssl主要起到两个作用：网站认证、内容加密传输和数据一致性。经CA签发的证书才起到认证可信的作用，所有有效证书均可以起到加密传输的作用。</p><p><strong>数字证书</strong></p><p>主要在互联网上的用于身份验证的用途。 安全站点在获得CA（Certificate Authority数字证书认证机构）认证后，获得一个数字证书，以此来标识其合法身份的真实性。数字证书主要分为服务器证书和客户端证书。服务器证书（SSL证书）用来进行身份验证和通信的加密，客户端证书主要用于身份验证和电子签名。找CA申请证书是要收费的。</p><p><strong>自签名证书</strong></p><p>非CA颁发的证书，通过自签名的方式得到的证书。通常Web浏览器会显示一个对话框，询问您是否希望信任一个自签名证书。这个是不用花钱的。</p><p><strong>中间人攻击</strong></p><p>是指攻击者与通讯的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对话，但事实上整个会话都被攻击者完全控制。在中间人攻击中，攻击者可以拦截通讯双方的通话并插入新的内容。在许多情况下这是很简单的。</p><h2>0x02 分析</h2><p>如果自己简单的实现android webview加载网页，如果直接访问可信证书的站点是可以正常显示，但是如果访问自签名的证书的站点就会显示notfound的页面。(写本文时apple.com以及apple.com.cn处于劫持状态)</p><p>logcat会输出网页显示不安全的内容</p><code lang="text">Web Console:The page displayed insecure content!
</code><p>功能健全的手机浏览器访问自签名证书的站点会如下提醒</p><p>在PC端如果访问自签名证书的站点则会出现如下图左侧的提醒</p><p>为解决javax.net.ssl.SSLPeerUnverifiedException: No peer certificate的异常，开发者往往会采用以下的错误解决方案。如此是浏览器应用采用此类解决方案，那么风险就更大了。</p><p>覆盖google默认的证书检查机制</p><br><br>class bv<br>  implements X509TrustManager<br>{<br>  bv(bu parambu) {}<br><br>  public void checkClientTrusted(X509Certificate[] paramArrayOfX509Certificate, String paramString) {}<br><br>  public void checkServerTrusted(X509Certificate[] paramArrayOfX509Certificate, String paramString) {}<br><br>  public X509Certificate[] getAcceptedIssuers()<br>  {<br>    return null;<br>  }<br>}<br><p>信任所有主机名</p><br><br>public static HttpClient getNewHttpClient() {  <br>    try {  <br>        //获得密匙库<br>        KeyStore trustStore = KeyStore.getInstance(KeyStore.getDefaultType());  <br>        trustStore.load(null, null);  <br><br>        SSLSocketFactory sf = new SSLSocketFactoryEx(trustStore); <br>        //信任所有主机名 <br>        sf.setHostnameVerifier(SSLSocketFactory.ALLOW_ALL_HOSTNAME_VERIFIER);  <br><br>        HttpParams params = new BasicHttpParams();  <br>        HttpProtocolParams.setVersion(params, HttpVersion.HTTP_1_1);  <br>        HttpProtocolParams.setContentCharset(params, HTTP.UTF_8);  <br><br>        SchemeRegistry registry = new SchemeRegistry();  <br>        registry.register(new Scheme("http", PlainSocketFactory.getSocketFactory(), 80));  <br>        registry.register(new Scheme("https", sf, 443));  <br><br>        ClientConnectionManager ccm = new ThreadSafeClientConnManager(params, registry);  <br><br>        return new DefaultHttpClient(ccm, params);  <br>    } catch (Exception e) {  <br>        return new DefaultHttpClient();  <br>    }  <br>}  <br><p>其实早在14年2月<a href="http://drops.wooyun.org/papers/959" data-editable="true" data-title="窃听风暴： Android平台https嗅探劫持漏洞">窃听风暴： Android平台https嗅探劫持漏洞</a>文中就有提到android平台的app因为覆盖google默认的证书检查机制（X509TrustManager）之后没有对证书进行应有的安全性检查，直接接受了所有异常的https证书，不提醒用户存在安全风险，也不终止这次危险的连接。文中对证书域名检查（HostnameVerifier）部分没有细说。</p><p>上文有提到PC版的360浏览器访问被劫持网站居然没有证书错误提示，让人很不敢相信。加上最近android app 证书问题频发，猜想是否有可能一些手机浏览器也会有此类漏洞了。测试过程中发现360手机浏览器、和搜狗浏览器存在此风险。</p><p>百度和遨游轻松检测出证书异常</p><p>而360和搜狗直接加载进入了被劫持的网站。</p><p>反编译查看遨游浏览器的代码，针对证书异常做了处理</p><p>而搜狗浏览器则是做了证书信任所有主机名不当处理</p><p>关键字：checkServerTrusted、setHostnameVerifier、ALLOW_ALL_HOSTNAME_VERIFIER、X509TrustManager、onReceivedSslError</p><h2>0x03 对比</h2><p>对主流手机浏览器进行了横向对比，测试对象包括：firefox、chrome、UC浏览器、搜狗浏览器、百度浏览器、360安全浏览器、欧鹏浏览器、遨游云浏览器、猎豹浏览器。</p><p>测试方法：手机访问<a href="https://example.com/" data-editable="true" data-title="example.com 的页面">https://example.com/</a>,观察是否有安全提醒。</p><p>未做提醒直接加载网页：360安全浏览器、猎豹浏览器、搜狗浏览器</p><p>正常做出安全提醒：firefox、chrome、UC浏览器、百度浏览器、欧鹏浏览器、遨游云浏览器</p><h2>0x04 建议</h2><p>开发者：</p><p>1、非浏览器app，有钱申请ca证书没钱在客户端中添加证书,切勿信任所有证书。</p><p>2、浏览器app，严格按照客户端校验服务器证书流程处理:</p><ul><li>查看证书是否过期</li><li>CA是否可靠</li><li>CA的公钥能否正确解开服务器证书的CA数字签名，即证书的签名值</li><li>服务器证书上的域名是否和服务器的实际域名相匹配</li></ul><p>3、建议使用setHostnameVerifier(SSLSocketFactory.STRICT_HOSTNAME_VERIFIER)</p><p>用户：使用安全性较好的app</p><h2>0x05 参考</h2><p><a href="http://drops.wooyun.org/tips/2775" data-editable="true" data-title="数字证书及其在安全测试中的应用">数字证书及其在安全测试中的应用</a></p><p><a href="http://drops.wooyun.org/papers/959">http://drops.wooyun.org/papers/959</a></p><p><a href="http://developer.android.com/reference/javax/net/ssl/HttpsURLConnection.html" class="">http://developer.android.com/reference/javax/net/ssl/HttpsURLConnection.html</a></p><p><a href="http://developer.android.com/reference/javax/net/ssl/X509TrustManager.html">http://developer.android.com/reference/javax/net/ssl/X509TrustManager.html</a></p><p><a href="http://developer.android.com/training/articles/security-ssl.html" class="">http://developer.android.com/training/articles/security-ssl.html</a></p><p><a href="http://developer.android.com/reference/org/apache/http/conn/ssl/SSLSocketFactory.html">http://developer.android.com/reference/org/apache/http/conn/ssl/SSLSocketFactory.html</a></p><br><p>乌云知识库投稿：<a href="http://drops.wooyun.org/newsend" class="" data-editable="true" data-title="投稿 | WooYun知识库">http://drops.wooyun.org/newsend</a></p><p>1. 如果未有乌云账号的话，你将会在邮箱当中获取到邀请码一枚，可以来注册成为乌云白帽子。</p><p>2. 文章如审核通过即可获普通文章奖励（20WB）。</p><p>3. 文章内容符合知识库征稿意向，内容充实有新意可获优秀文章奖励（20WB + 500RMB）。</p><p>4. 最新的事件分析和安全预警，分享业内前沿最新技术、0day分析与利用、个人安全开发研究新成果等方面的奇技淫巧、心经等可获加精文章奖励（40WB + 1000RMB）。</p><p>5. 以后根据文章内容还可能获得相关众测免费门票等优惠！</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
