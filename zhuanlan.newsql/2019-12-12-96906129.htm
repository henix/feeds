<div class="title-image"><img src="https://pic4.zhimg.com/v2-88d254931476b5e8cedbb60207b79334_b.jpg" alt=""></div><p>ä½œè€…ï¼šé‚“åŠ›é“­</p><p>åœ¨å‰ä¸¤ç¯‡æ–‡ç«  <a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/cdC7f9N9C88MJ_syNUg21g" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆåå››ï¼‰Coprocessor æ¦‚è§ˆ</a>ã€<a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/UYcny9G5snh-MoMFm2qxsw" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆåäº”ï¼‰è¡¨è¾¾å¼è®¡ç®—æ¡†æ¶ä¸­</a>ï¼Œè®²åˆ°äº† TiDB ä¸ºäº†æœ€å¤§åŒ–åˆ©ç”¨åˆ†å¸ƒå¼è®¡ç®—èƒ½åŠ›ï¼Œä¼šå°½é‡å°† Selection ç®—å­ã€Aggregation ç®—å­ç­‰ç®—å­ä¸‹æ¨åˆ° TiKV èŠ‚ç‚¹ä¸Šï¼Œä»¥åŠä¸‹æ¨çš„è¡¨è¾¾å¼æ˜¯å¦‚ä½•åœ¨ TiKV ä¸Šåšè®¡ç®—çš„ã€‚æœ¬æ–‡å°†åœ¨å‰ä¸¤ç¯‡æ–‡ç« çš„åŸºç¡€ä¸Šï¼Œä»‹ç»ä¸‹æ¨ç®—å­çš„æ‰§è¡Œæµç¨‹å¹¶åˆ†æä¸‹æ¨ç®—å­çš„éƒ¨åˆ†å®ç°ç»†èŠ‚ï¼ŒåŠ æ·±å¤§å®¶å¯¹ TiKV Coprocessor çš„ç†è§£ã€‚</p><h2>ä»€ä¹ˆæ˜¯ä¸‹æ¨ç®—å­</h2><p>ä»¥ä¸‹è¾¹çš„ <code>SQL</code> ä¸ºä¾‹å­ï¼š</p><div class="highlight"><pre><code class="language-text">select  *  from students where age &gt;  21  limit  2</code></pre></div><p>TiDB åœ¨è§£æå®Œè¿™æ¡ <code>SQL</code> è¯­å¥ä¹‹åï¼Œä¼šå¼€å§‹åˆ¶å®šæ‰§è¡Œè®¡åˆ’ã€‚åœ¨è¿™ä¸ªè¯­å¥ä¸­ï¼Œ TiDB ä¼šå‘ TiKV ä¸‹æ¨ä¸€ä¸ªå¯ä»¥ç”¨æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰æ¥æè¿°çš„æŸ¥è¯¢è¯·æ±‚ï¼š</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-2aab23543ed86a6d8b6c487ae71fbe15_b.jpg" data-caption="" data-size="normal" data-rawwidth="818" data-rawheight="279" class="origin_image zh-lightbox-thumb" width="818" data-original="https://pic2.zhimg.com/v2-2aab23543ed86a6d8b6c487ae71fbe15_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-2aab23543ed86a6d8b6c487ae71fbe15_b.jpg" data-caption="" data-size="normal" data-rawwidth="818" data-rawheight="279" class="origin_image zh-lightbox-thumb lazy" width="818" data-original="https://pic2.zhimg.com/v2-2aab23543ed86a6d8b6c487ae71fbe15_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-2aab23543ed86a6d8b6c487ae71fbe15_b.jpg"/></figure><p>ä»¥ä¸Šçš„ <code>DAG</code> æ˜¯ä¸€ä¸ªç”±ä¸€ç³»åˆ—ç®—å­ç»„æˆçš„æœ‰å‘æ— ç¯å›¾ï¼Œç®—å­åœ¨ TiKV ä¸­ç§°ä¸º <code>Executor</code> ã€‚æ•´ä¸ª <code>DAG</code> æè¿°äº†æŸ¥è¯¢è®¡åˆ’åœ¨ TiKV çš„æ‰§è¡Œè¿‡ç¨‹ã€‚åœ¨ä¸Šè¾¹çš„ä¾‹å­ä¸­ï¼Œä¸€æ¡æŸ¥è¯¢ <code>SQL</code> è¢«ç¿»è¯‘æˆäº†ä¸‰ä¸ªæ‰§è¡Œæ­¥éª¤ï¼š</p><ol><li>æ‰«è¡¨</li><li>é€‰æ‹©è¿‡æ»¤</li><li>å–è‹¥å¹²è¡Œ</li></ol><p>æœ‰äº†åŸºæœ¬æ¦‚å¿µåï¼Œä¸‹é¢æˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹è¿™æ ·çš„æŸ¥è¯¢è®¡åˆ’åœ¨ TiKV å†…éƒ¨çš„ä¸€ä¸ªæ‰§è¡Œæµç¨‹ã€‚</p><h2>ä¸‹æ¨ç®—å­å¦‚ä½•æ‰§è¡Œ</h2><h3>ç»•ä¸å¼€çš„ç«å±±</h3><p>TiKV æ‰§è¡Œå™¨æ˜¯åŸºäº Volcano Model ï¼ˆç«å±±æ¨¡å‹ï¼‰ï¼Œä¸€ç§ç»å…¸çš„åŸºäºè¡Œçš„æµå¼è¿­ä»£æ¨¡å‹ã€‚ç°åœ¨ä¸»æµçš„å…³ç³»å‹æ•°æ®åº“éƒ½é‡‡ç”¨äº†è¿™ç§æ¨¡å‹ï¼Œä¾‹å¦‚ Oracleï¼ŒMySQL ç­‰ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æŠŠæ¯ä¸ªç®—å­çœ‹æˆä¸€ä¸ªè¿­ä»£å™¨ã€‚æ¯æ¬¡è°ƒç”¨å®ƒçš„ <code>next()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å¾—ä¸€è¡Œï¼Œç„¶åå‘ä¸Šè¿”å›ã€‚è€Œæ¯ä¸ªç®—å­éƒ½æŠŠä¸‹å±‚ç®—å­çœ‹æˆä¸€å¼ è¡¨ï¼Œè¿”å›å“ªäº›è¡Œï¼Œè¿”å›æ€ä¹ˆæ ·çš„è¡Œç”±ç®—å­æœ¬èº«å†³å®šã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><p>å‡è®¾æˆ‘ä»¬ç°åœ¨å¯¹ä¸€å¼ æ²¡æœ‰ä¸»é”®ï¼Œæ²¡æœ‰ç´¢å¼•çš„è¡¨ <code>[1]</code> ï¼Œæ‰§è¡Œä¸€æ¬¡å…¨è¡¨æ‰«ææ“ä½œï¼š</p><div class="highlight"><pre><code class="language-text">select * from t where a &gt; 2 limit 2</code></pre></div><p>è¡¨ <code>[1]</code>ï¼š</p><p>a<code>(int)</code>b<code>(int)</code>3112522314</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°è¿™æ ·çš„ä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ï¼š</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-648d673829c8078ea48bd8eee0e5331c_b.gif" data-caption="" data-size="normal" data-rawwidth="487" data-rawheight="559" data-thumbnail="https://pic1.zhimg.com/v2-648d673829c8078ea48bd8eee0e5331c_b.jpg" class="origin_image zh-lightbox-thumb" width="487" data-original="https://pic1.zhimg.com/v2-648d673829c8078ea48bd8eee0e5331c_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-648d673829c8078ea48bd8eee0e5331c_b.gif" data-caption="" data-size="normal" data-rawwidth="487" data-rawheight="559" data-thumbnail="https://pic1.zhimg.com/v2-648d673829c8078ea48bd8eee0e5331c_b.jpg" class="origin_image zh-lightbox-thumb lazy" width="487" data-original="https://pic1.zhimg.com/v2-648d673829c8078ea48bd8eee0e5331c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-648d673829c8078ea48bd8eee0e5331c_b.gif"/></figure><p>æ¯ä¸ªç®—å­éƒ½å®ç°äº†ä¸€ä¸ª <code>Executor</code> çš„ <code>trait</code>ï¼Œ æ‰€ä»¥æ¯ä¸ªç®—å­éƒ½å¯ä»¥è°ƒç”¨ <code>next()</code> æ¥å‘ä¸Šè¿”å›ä¸€è¡Œã€‚</p><div class="highlight"><pre><code class="language-text">pub trait Executor: Send {
    fn next(&amp;mut self) -&gt; Result&lt;Option&lt;Row&gt;&gt;;
    // ...
}
å½“ä»¥ä¸Šçš„è¯·æ±‚è¢«è§£æä¹‹åï¼Œæˆ‘ä»¬ä¼šåœ¨ ExecutorRunner é‡Œè¾¹ä¸æ–­çš„è°ƒç”¨æœ€ä¸Šå±‚ç®—å­çš„ next() æ–¹æ³•ï¼Œ ç›´åˆ°å…¶æ— æ³•å†è¿”å›è¡Œã€‚
pub fn handle_request(&amp;mut self) -&gt; Result&lt;SelectResponse&gt; {
    loop {
        match self.executor.next()? {
            Some(row) =&gt; {
                // Do some aggregation.
            },
            None =&gt; {
                // ...
                return result;
            }
        }
    }
}</code></pre></div><p>å¤§æ¦‚çš„é€»è¾‘å°±æ˜¯ï¼š<code>Runner</code> è°ƒç”¨ <code>Limit</code> ç®—å­çš„ <code>next()</code> æ–¹æ³•ï¼Œç„¶åè¿™ä¸ªæ—¶å€™ <code>Limit</code> å®ç°çš„ <code>next()</code> æ–¹æ³•ä¼šå»è°ƒç”¨ä¸‹ä¸€å±‚ç®—å­ <code>Selection</code> çš„ <code>next()</code> æ–¹æ³•è¦ä¸€è¡Œä¸Šæ¥åšèšåˆï¼Œç›´åˆ°è¾¾åˆ°é¢„è®¾çš„é˜€å€¼ï¼Œåœ¨ä¾‹å­ä¸­ä¹Ÿå°±æ˜¯ä¸¤è¡Œï¼Œæ¥ç€ <code>Selection</code> å®ç°çš„ <code>next()</code> åˆä¼šå»è°ƒç”¨ä¸‹ä¸€å±‚ç®—å­çš„ <code>next()</code> æ–¹æ³•ï¼Œ ä¹Ÿå°±æ˜¯ <code>TableScan</code>ï¼Œ <code>TableScan</code> çš„ <code>next()</code> å®ç°æ˜¯æ ¹æ®è¯·æ±‚ä¸­çš„ <code>KeyRange</code>ï¼Œ å‘ä¸‹è¾¹çš„ <code>MVCC</code> è¦ä¸Šä¸€è¡Œï¼Œç„¶åè¿”å›ç»™ä¸Šå±‚ç®—å­, ä¹Ÿå°±æ˜¯ç¬¬ä¸€è¡Œ <code>(3, 1)</code>ï¼Œ<code>Selection</code> æ”¶åˆ°è¡Œåæ ¹æ® <code>where</code> å­—å¥ä¸­çš„è¡¨è¾¾å¼çš„å€¼åšåˆ¤æ–­ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å‘ä¸Šè¿”å›ä¸€è¡Œï¼Œ å¦åˆ™ç»§ç»­é—®ä¸‹å±‚ç®—å­è¦ä¸€è¡Œï¼Œæ­¤æ—¶ <code>a == 3 &gt; 2</code>, æ»¡è¶³æ¡ä»¶å‘ä¸Šè¿”å›ï¼Œ <code>Limit</code> æ¥æ”¶åˆ°ä¸€è¡Œåˆ™åˆ¤æ–­å½“å‰æ”¶åˆ°çš„è¡Œæ•°æ—¶å€™æ»¡ä¸¤è¡Œï¼Œä½†æ˜¯ç°åœ¨åªæ”¶åˆ°ä¸€è¡Œï¼Œæ‰€ä»¥ç»§ç»­é—®ä¸‹å±‚ç®—å­è¦ä¸€è¡Œã€‚æ¥ä¸‹æ¥ <code>TableScan</code> è¿”å› <code>(1,2), Selection</code> å‘ç°ä¸æ»¡è¶³æ¡ä»¶ï¼Œç»§ç»­é—® <code>TableScan</code> è¦ä¸€è¡Œä¹Ÿå°±æ˜¯ <code>(5,2), Selection</code> å‘ç°è¿™è¡Œæ»¡è¶³æ¡ä»¶ï¼Œç„¶åè¿”å›è¿™ä¸€è¡Œï¼Œ<code>Limit</code> æ¥æ”¶åˆ°ä¸€è¡Œï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨å…¶ <code>next()</code> æ–¹æ³•æ—¶ï¼Œå‘ç°æ¥æ”¶åˆ°çš„è¡Œæ•°å·²ç»æ»¡ä¸¤è¡Œï¼Œæ­¤æ—¶è¿”å› <code>None</code>ï¼Œ <code>Runner</code> ä¼šå¼€å§‹å¯¹ç»“æœå¼€å§‹èšåˆï¼Œç„¶ä¼šè¿”å›ä¸€ä¸ªå“åº”ç»“æœã€‚</p><h3>å¼•å…¥å‘é‡åŒ–çš„æŸ¥è¯¢å¼•æ“</h3><p>å½“å‰ TiKV å¼•å…¥äº†å‘é‡åŒ–çš„æ‰§è¡Œå¼•æ“ï¼Œæ‰€è°“çš„å‘é‡åŒ–ï¼Œå°±æ˜¯åœ¨ <code>Executor</code> é—´ä¼ é€’çš„ä¸å†æ˜¯å•å•çš„ä¸€è¡Œï¼Œè€Œæ˜¯å¤šè¡Œï¼Œæ¯”å¦‚ <code>TableScan</code> åœ¨åº•å±‚ <code>MVCC Snapshot</code> ä¸­æ‰«ä¸Šæ¥çš„ä¸å†æ˜¯ä¸€è¡Œï¼Œè€Œæ˜¯è¯´å¤šè¡Œã€‚è‡ªç„¶çš„ï¼Œåœ¨ç®—å­æ‰§è¡Œè®¡ç®—ä»»åŠ¡çš„æ—¶å€™ï¼Œè®¡ç®—çš„å•å…ƒä¹Ÿä¸å†æ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªå‘é‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“é‡åˆ°ä¸€ä¸ªè¡¨è¾¾å¼ï¼š<code>a + b</code> çš„æ—¶å€™ï¼Œ æˆ‘ä»¬ä¸æ˜¯è®¡ç®—ä¸€è¡Œé‡Œè¾¹ <code>a</code> åˆ—å’Œ <code>b</code> åˆ—ä¸¤ä¸ªæ ‡é‡ç›¸åŠ çš„ç»“æœï¼Œè€Œæ˜¯è®¡ç®— <code>a</code> åˆ—å’Œ <code>b</code> åˆ—ä¸¤åˆ—ç›¸åŠ çš„ç»“æœã€‚</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-f80e2243e24af3bb84f7bd46ff202204_b.jpg" data-caption="" data-size="normal" data-rawwidth="916" data-rawheight="583" class="origin_image zh-lightbox-thumb" width="916" data-original="https://pic1.zhimg.com/v2-f80e2243e24af3bb84f7bd46ff202204_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-f80e2243e24af3bb84f7bd46ff202204_b.jpg" data-caption="" data-size="normal" data-rawwidth="916" data-rawheight="583" class="origin_image zh-lightbox-thumb lazy" width="916" data-original="https://pic1.zhimg.com/v2-f80e2243e24af3bb84f7bd46ff202204_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-f80e2243e24af3bb84f7bd46ff202204_b.jpg"/></figure><p>ä¸ºä»€ä¹ˆè¦å¼•å…¥å‘é‡åŒ–æ¨¡å‹å‘¢ï¼ŒåŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ol><li>å¯¹äºæ¯è¡Œæˆ‘ä»¬è‡³å°‘å¾—è°ƒç”¨ 1 æ¬¡ <code>next()</code> æ–¹æ³•ï¼Œå¦‚æœ <code>DAG</code> çš„æœ€å¤§æ·±åº¦å¾ˆæ·±ï¼Œä¸ºäº†è·å–ä¸€è¡Œæˆ‘ä»¬éœ€è¦è°ƒç”¨æ›´å¤šæ¬¡çš„ <code>next()</code> æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ä¼ ç»Ÿçš„è¿­ä»£æ¨¡å‹ä¸­ï¼Œè™šå‡½æ•°è°ƒç”¨çš„å¼€é”€éå¸¸å¤§ã€‚å¦‚æœä¸€æ¬¡ <code>next()</code> æ–¹æ³•å°±è¿”å›å¤šè¡Œï¼Œè¿™æ ·å¹³å‡ä¸‹æ¥æ¯æ¬¡ <code>next()</code> æ–¹æ³•å°±å¯ä»¥è¿”å›å¤šè¡Œï¼Œè€Œä¸æ˜¯è‡³å¤šä¸€è¡Œã€‚</li><li>ç”±äºè¿­ä»£çš„å¼€é”€éå¸¸å¤§ï¼Œæ•´ä¸ªæ‰§è¡Œçš„å¾ªç¯æ— æ³•è¢« <code>loop-pipelining</code> ä¼˜åŒ–ï¼Œä½¿å¾—æ•´ä¸ªå¾ªç¯æµæ°´çº¿è¢«å¡æ­»ï¼ŒIPC å¤§å¤§ä¸‹é™ã€‚è¿”å›å¤šè¡Œä¹‹åï¼Œæ¯ä¸ªç®—å­å†…éƒ¨å¯ä»¥é‡‡ç”¨å¼€é”€è¾ƒå°çš„å¾ªç¯ï¼Œæ›´å¥½åˆ©ç”¨ <code>loop-pipelining</code> ä¼˜åŒ–ã€‚</li></ol><p>å½“ç„¶å‘é‡åŒ–æ¨¡å‹ä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼š</p><ol><li>åŸå…ˆæœ€ä¸Šå±‚ç®—å­æŒ‰éœ€å‘ä¸‹å±‚ç®—å­æ‹¿ä¸Šä¸€è¡Œï¼Œè€Œç°åœ¨æ‹¿ä¸Šå¤šè¡Œï¼Œå†…å­˜å¼€é”€è‡ªç„¶ä¼šå¢åŠ ã€‚</li><li>è®¡ç®—æ¨¡å‹å‘ç”Ÿå˜åŒ–ï¼ŒåŸæ¥åŸºäºæ ‡é‡è®¡ç®—çš„è¡¨è¾¾å¼æ¡†æ¶éœ€è¦é‡æ„ ï¼ˆè¯¦è§ä¸Šç¯‡æ–‡ç« ï¼‰ã€‚</li></ol><p>ä½†æ˜¯è¿™æ ·å¹¶ä¸å½±å“å‘é‡åŒ–æŸ¥è¯¢å¸¦æ¥çš„æ˜¾è‘—çš„æ€§èƒ½æå‡ï¼Œä¸‹è¾¹æ˜¯å¼•å…¥å‘é‡åŒ–æ¨¡å‹åä¸€ä¸ªåŸºå‡†æµ‹è¯•ç»“æœï¼šï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCoprocessor è®¡ç®—è¿˜åªæ˜¯ TPC-H ä¸­çš„å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥è®¡ç®—ä»»åŠ¡æ¯”é‡å¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šäº†å¼€ä¸å¼€å‘é‡åŒ–å¸¦æ¥çš„æå‡æ¯”ä¾‹ï¼‰ã€‚</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-3877d6e8bb3b713b5ad3789769faf7e2_b.jpg" data-caption="" data-size="normal" data-rawwidth="974" data-rawheight="497" class="origin_image zh-lightbox-thumb" width="974" data-original="https://pic3.zhimg.com/v2-3877d6e8bb3b713b5ad3789769faf7e2_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-3877d6e8bb3b713b5ad3789769faf7e2_b.jpg" data-caption="" data-size="normal" data-rawwidth="974" data-rawheight="497" class="origin_image zh-lightbox-thumb lazy" width="974" data-original="https://pic3.zhimg.com/v2-3877d6e8bb3b713b5ad3789769faf7e2_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-3877d6e8bb3b713b5ad3789769faf7e2_b.jpg"/></figure><p>å¼•å…¥å‘é‡åŒ–æ¨¡å‹åï¼ŒåŸå…ˆçš„ <code>Execturor</code> trait å°±å˜æˆäº† <code>BatchExecutor</code>ï¼Œ å¯¹åº”çš„ <code>next()</code> æ–¹æ³•å°±æˆäº† <code>next_batch()</code>ã€‚ è‡ªç„¶çš„ <code>next_batch</code> ä¸å†è¿”å›ä¸€ä¸ªè¡Œï¼Œè€Œæ˜¯ä¸€ä¸ª <code>BatchExecuteResult</code>ï¼Œä¸Šè¾¹è®°å½•äº†æ‰«ä¸Šæ¥çš„ä¸€å¼ è¡¨ <code>physical_columns</code>ï¼Œä»¥åŠå­è¡¨ä¸­å“ªäº›è¡Œåº”å½“è¢«ä¿ç•™çš„ <code>logical_rows</code> å’Œä¸€ä¸ª <code>is_drain</code> ç”¨æ¥è¡¨ç¤ºä¸‹å±‚ç®—å­æ˜¯å¦å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¿”å›ã€‚</p><div class="highlight"><pre><code class="language-text">pub trait BatchExecutor: Send {

    /// è·å–è¡¨çš„ `schema`
    fn schema(&amp;self) -&gt; &amp;[FieldType];

    // å‘ä¸‹å±‚ç®—å­è¦å›ä¸€å¼ è¡¨
    fn next_batch(&amp;mut self, scan_rows: usize) -&gt; BatchExecuteResult;

    // ...
}

pub struct BatchExecuteResult {
    // æœ¬è½®å¾ªç¯ `TableScan` æ‰«ä¸Šæ¥çš„æ•°æ®
    pub physical_columns: LazyBatchColumnVec,

    /// è®°å½• `physical_columns` ä¸­æœ‰æ•ˆçš„è¡Œçš„ä¸‹æ ‡
    pub logical_rows: Vec&lt;usize&gt;,

    // ...

    // è¡¨ç¤ºä¸‹å±‚ç®—å­æ˜¯å¦å·²ç»æ²¡æœ‰æ•°æ®å¯ä»¥è¿”å›
    pub is_drained: Result&lt;bool&gt;,
}</code></pre></div><p>åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†ç®€å•ä»‹ç»ä¸€ä¸‹å‡ ç§å…¸å‹ç®—å­çš„å®ç°ç»†èŠ‚ï¼Œæ—¨åœ¨è®©å¤§å®¶æ›´åŠ ç†Ÿæ‚‰å„ä¸ªç®—å­çš„å·¥ä½œåŸç†ã€‚</p><h2>å…¸å‹ç®—å­çš„å®ç°</h2><h3><code>BatchTableScanExecutor</code> çš„å®ç°</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆæ˜ç¡®ä¸€ä¸‹ <code>BatchTableScanExecutor</code> çš„åŠŸèƒ½ï¼Œ<code>TableScan</code> å®ç°çš„ <code>next_batch()</code> æ¯è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œå®ƒå°±ä¼šä»åº•å±‚çš„å®ç°äº† <code>Storage trait</code> çš„å­˜å‚¨å±‚ä¸­æ‰«ä¸ŠæŒ‡å®šçš„è¡Œæ•°ï¼Œä¹Ÿå°±æ˜¯ <code>scan_rows</code> è¡Œã€‚ä½†æ˜¯ç”±äºæˆ‘ä»¬åœ¨è®¡ç®—çš„æ—¶å€™æ˜¯é‡‡ç”¨å‘é‡åŒ–çš„è®¡ç®—æ¨¡å‹ï¼Œè®¡ç®—éƒ½æ˜¯åŸºäºåˆ—è¿›è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¯¹æ‰«ä¸Šæ¥çš„è¡Œè¿›è¡Œä¸€æ¬¡è¡Œåˆ—è½¬æ¢ï¼Œå°†è¡¨ä»è¡Œå­˜æ ¼å¼è½¬æ¢æˆåˆ—å­˜æ ¼å¼ã€‚</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-bb0e84cbb640b86a5adbc4e82eecd821_b.jpg" data-caption="" data-size="normal" data-rawwidth="743" data-rawheight="504" class="origin_image zh-lightbox-thumb" width="743" data-original="https://pic2.zhimg.com/v2-bb0e84cbb640b86a5adbc4e82eecd821_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-bb0e84cbb640b86a5adbc4e82eecd821_b.jpg" data-caption="" data-size="normal" data-rawwidth="743" data-rawheight="504" class="origin_image zh-lightbox-thumb lazy" width="743" data-original="https://pic2.zhimg.com/v2-bb0e84cbb640b86a5adbc4e82eecd821_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-bb0e84cbb640b86a5adbc4e82eecd821_b.jpg"/></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ <code><a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/batch/interface.rs%23L19" class=" wrap external" target="_blank" rel="nofollow noreferrer">BatchTableScanExecutor</a></code> ç°åœ¨çš„å®šä¹‰ï¼š</p><div class="highlight"><pre><code class="language-text">pub struct BatchTableScanExecutor&lt;S: Storage&gt;(ScanExecutor&lt;S, TableScanExecutorImpl&gt;);</code></pre></div><p>ä»ç»“æ„ä½“çš„å®šä¹‰ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ<code>BatchTableScanExecutor</code> ä¾èµ–äº <code>ScanExecutor</code>ï¼Œè€Œè¿™ä¸ª <code>ScanExecutor</code> ä¾èµ–äºä¸€ä¸ªå®ç° <code>Storage</code> çš„ç±»å‹å’Œå…·ä½“ <code>TableScanExecutorImpl</code>ã€‚</p><p>å…¶ä¸­ <code><a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/batch/executors/util/scan_executor.rs%23L38" class=" wrap external" target="_blank" rel="nofollow noreferrer">ScanExecutor</a></code> æ˜¯ä¸€ä¸ªé€šç”¨çš„ç»“æ„ä½“ï¼Œå…¶ä½œç”¨æ˜¯ä¸ºäº†æŠ½è±¡å‡ºæ‰«è¡¨å’Œæ‰«ç´¢å¼•ä¸¤ç§æ“ä½œï¼Œè¿™ä¸¤ç§æ“ä½œéƒ½éœ€è¦ä¾èµ–ä¸€ä¸ª <code>Storage</code> è€ŒåŒºåˆ«ä»–ä»¬å…·ä½“è¡Œä¸ºçš„æ˜¯ä¸€ä¸ªå®ç°äº† <code>ScanExecutorImpl</code> çš„ç»“æ„ä½“ï¼Œåœ¨ä¸Šè¾¹çš„å®šä¹‰ä¸­å°±æ˜¯ï¼š<code>TableScanExecutorImpl</code>ã€‚</p><div class="highlight"><pre><code class="language-text">pub struct ScanExecutor&lt;S: Storage, I: ScanExecutorImpl&gt; {
    /// å…·ä½“çš„æ‰«è¡¨/æ‰«ç´¢å¼•å®ç°ã€‚
    imp: I,

    /// ç»™å®šä¸€ä¸ª `KeyRange`ï¼Œæ‰«ä¸Šä¸€è¡Œæˆ–è€…å¤šè¡Œã€‚
    scanner: RangesScanner&lt;S&gt;,

    // æ ‡è®°æ˜¯å¦å·²ç»æ‰«å®Œäº†æ‰€æœ‰çš„è¡Œã€‚
    is_ended: bool,
}</code></pre></div><p><code>BatchTableScanExecutor</code> ä¸­æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯å…¶å®ç°çš„ <code>BatchExecutor</code>, å…¶ä¸­æœ€ä¸ºå…³é”®çš„å°±æ˜¯ <code>next_batch()</code>ï¼Œç„¶è€Œå…¶ä¾èµ–äºå†…éƒ¨ <code>ScanExecutor</code> çš„ <code>BatchExecutor</code> å®ç°ï¼Œä¹Ÿå°±æ˜¯ï¼š</p><div class="highlight"><pre><code class="language-text">fn next_batch(&amp;mut self, scan_rows: usize) -&gt; BatchExecuteResult {

        // åˆ›å»ºä¸€ä¸ªåˆ—æ•°ç»„
        let mut logical_columns = self.imp.build_column_vec(scan_rows);
        
        // æ‰«ä¸Š `scan_rows` è¡Œï¼Œ ç„¶åæŒ‰åˆ—å¡«å……åˆ°åˆ›å»ºå¥½çš„åˆ—æ•°ç»„ä¸­ã€‚
        let is_drained = self.fill_column_vec(scan_rows, &amp;mut logical_columns);

        // åˆ›å»ºä¸€ä¸ª `logical_rows`, è¡¨ç¤ºå½“å‰è¡¨ä¸­æ‰€æœ‰è¡Œæœ‰æ•ˆã€‚åè¾¹å¯èƒ½æ ¹æ® `Selection` çš„ç»“æœä¿®æ”¹è¿™ä¸ª `logical_rows`ã€‚
        let logical_rows = (0..logical_columns.rows_len()).collect();

        // åˆ¤æ–­æ˜¯å¦æ‰«å®Œä¼ å…¥çš„ `KeyRange`
        match &amp;is_drained {
            // Note: `self.is_ended` is only used for assertion purpose.
            Err(_) | Ok(true) =&gt; self.is_ended = true,
            Ok(false) =&gt; {}
        };

        // è¿”å› `BatchExecuteResult`
        BatchExecuteResult {
            // ...
        }
    }</code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ä¸Šè¾¹ <code>fill_column_vec</code> çš„å®ç°, å®ƒå¤§æ¦‚çš„é€»è¾‘å°±æ˜¯æ¯æ¬¡é—® <code>self.scanner</code> è¦ä¸Šä¸€ä¸ª <code>Key-Value</code> å¯¹, ç„¶åæ‰”ç»™ <code>self.imp.process_kv_pair</code> å¤„ç†ï¼Œåœ¨æ‰«è¡¨çš„å®ç°ä¸­å°±æ˜¯å°† <code>value</code> çœ‹æˆæ˜¯ä¸€ä¸ªè¡Œçš„ <code>datum</code> ç¼–ç ï¼Œç„¶åå°†æ¯åˆ—çš„æ•°æ®è§£å‡ºæ¥ç„¶åæ”¾åˆ°å»ºå¥½çš„åˆ—æ•°ç»„é‡Œè¾¹å»ã€‚</p><div class="highlight"><pre><code class="language-text">fn fill_column_vec(
        &amp;mut self,
        scan_rows: usize,
        columns: &amp;mut LazyBatchColumnVec,
    ) -&gt; Result&lt;bool&gt; {
        assert!(scan_rows &gt; 0);

        for _ in 0..scan_rows {
            let some_row = self.scanner.next()?;
            if let Some((key, value)) = some_row {
                // å°†æ‰«ä¸Šæ¥çš„ä¸€è¡Œæ”¾å…¥ `columns` ä¸­
                self.imp.process_kv_pair(&amp;key, &amp;value, columns)?;
            } else {
                // æ²¡æœ‰ `KeyRange` å¯ä¾›æ‰«æï¼Œå·²ç»å®Œæˆæ‰«è¡¨ã€‚
                return Ok(true);
            }
        }

        // è¡¨ç¤ºä¸‹å±‚æ•°æ®è¿˜æ²¡æœ‰æ‰«å®Œã€‚
        Ok(false)
    }</code></pre></div><p><b>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç°åœ¨è¡¨ä¸­çš„æ•°æ®éƒ½æ˜¯æœªç»è§£ç çš„ç”Ÿæ•°æ®ï¼Œæ‰€è°“çš„ç”Ÿæ•°æ®å°±æ˜¯è¿˜ä¸èƒ½ç›´æ¥å‚ä¸åˆ°è¡¨è¾¾å¼è®¡ç®—çš„æ•°æ®ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯ä¸€ç§ lazy decoding çš„ç­–ç•¥ï¼Œåªæœ‰è¦å‚ä¸è®¡ç®—çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰ä¼šè§£ç ç‰¹å®šçš„åˆ—ï¼Œè€Œä¸æ˜¯å°†æ•°æ®æ‰«ä¸Šæ¥å°±å¼€å§‹è§£ç æ•°æ®ï¼Œå°†å…¶å˜æˆèƒ½å¤Ÿç›´æ¥å‚ä¸è®¡ç®—çš„ç»“æ„ã€‚</b></p><h3><code>BatchSelectionExecutor</code> çš„å®ç°</h3><p>æ¥ä¸‹æ¥è¦ä»‹ç»çš„æ˜¯ <code><a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/batch/executors/selection_executor.rs%23L17" class=" wrap external" target="_blank" rel="nofollow noreferrer">BatchSelectionExecutor</a></code> çš„å®ç°ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹å®šä¹‰ï¼š</p><div class="highlight"><pre><code class="language-text">pub struct BatchSelectionExecutor&lt;Src: BatchExecutor&gt; {
    // ...
    
    // æ•°æ®æº
    src: Src,

    // æ¡ä»¶è¡¨è¾¾å¼
    conditions: Vec&lt;RpnExpression&gt;,
}</code></pre></div><p>é¦–å…ˆï¼Œ <code>BatchSelectionExecutor</code> éœ€è¦ä¾èµ–ä¸€ä¸ª <code>Src</code>ï¼Œä¸€ä¸ª <code>BatchExecutor</code> æ¥æä¾›æ•°æ®çš„æ¥æºï¼Œç„¶åæ˜¯ä¸€ç»„æ¡ä»¶è¡¨è¾¾å¼ï¼Œå½“ <code>BatchSelectionExecutor</code> åœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šå¯¹è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼ï¼Œç„¶åæ ¹æ®æ±‚å‡ºçš„å€¼å¯¹ä¸‹å±‚æ•°æ®æ‹‰ä¸Šæ¥çš„è¡Œåšè¿‡æ»¤èšåˆï¼Œç„¶åè¿”å›è¿‡æ»¤å‡ºçš„è¡Œã€‚</p><p>è§‚å¯Ÿ <code>BatchSelectionExecutor</code> å®ç°çš„ <code>BatchExecutor</code> å¯ä»¥å‘ç°ï¼Œå…¶ä¸­çš„ <code>next_batch()</code> æ–¹æ³•ä¾èµ–äº <code>handle_src_result()</code>ï¼š</p><div class="highlight"><pre><code class="language-text">#[inline]
    fn next_batch(&amp;mut self, scan_rows: usize) -&gt; BatchExecuteResult {
        // ä»ä¸‹å±‚ç®—å­é‚£ä¼šä¸€å—æ•°æ®å¼€å§‹è¿‡æ»¤
        let mut src_result = self.src.next_batch(scan_rows);

        // æ ¹æ®è¡¨è¾¾å¼çš„å€¼ï¼Œè¿‡æ»¤å‡ºå¯¹åº”çš„è¡Œã€‚
        if let Err(e) = self.handle_src_result(&amp;mut src_result) {
            src_result.is_drained = src_result.is_drained.and(Err(e));
            src_result.logical_rows.clear();
        } else {
            // ... 
        }

        src_result</code></pre></div><p>é€šè¿‡è§‚å¯Ÿ <code>handle_src_result</code> çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå®ƒä¼šéå†æ‰€æœ‰è¡¨è¾¾å¼ï¼Œå¯¹å…¶æ±‚å€¼ï¼Œè¡¨è¾¾å¼çš„å€¼å¯èƒ½æ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå‘é‡ï¼Œä½†æ˜¯æˆ‘ä»¬å®Œå…¨æ˜¯å¯ä»¥æŠŠæ ‡é‡çœ‹æˆæ˜¯æ¯è¡Œéƒ½ä¸€æ ·çš„å‘é‡ï¼Œç„¶åæ ¹æ®æ¯è¡Œçš„å€¼ï¼Œå°†å…¶è½¬æ¢æˆ <code>bool</code>ï¼Œå¦‚æœè¯¥è¡Œçš„å€¼ä¸º <code>true</code>ï¼Œåˆ™åœ¨ <code>logical_rows</code> ä¸­ä¿ç•™ä»–çš„ä¸‹æ ‡ã€‚</p><div class="highlight"><pre><code class="language-text">fn handle_src_result(&amp;mut self, src_result: &amp;mut BatchExecuteResult) -&gt; Result&lt;()&gt; {
        let mut src_logical_rows_copy = Vec::with_capacity(src_result.logical_rows.len());
        let mut condition_index = 0;
        while condition_index &lt; self.conditions.len() &amp;&amp; !src_result.logical_rows.is_empty() {
            // æ‹·è´ä¸€ä»½ä¸‹å±‚ç®—å­çš„ `logical_rows`ï¼Œç”¨åšè®¡ç®—è¡¨è¾¾å¼ã€‚
            src_logical_rows_copy.clear();
            src_logical_rows_copy.extend_from_slice(&amp;src_result.logical_rows);

            // è®¡ç®—è¡¨è¾¾å¼çš„å€¼ï¼Œç„¶åæ ¹æ®è¡¨è¾¾å¼çš„å€¼å»æ›´æ–°ä¸‹å±‚ç®—å­çš„ `logical_rows`ã€‚
            match self.conditions[condition_index].eval(
                &amp;mut self.context,
                self.src.schema(),
                &amp;mut src_result.physical_columns,
                &amp;src_logical_rows_copy,
                // è¡¨è¾¾å¼äº§ç”Ÿçš„ç»“æœå¦‚æœæ˜¯ä¸€åˆ—çš„è¯, è¿™é‡Œè¡¨ç¤ºè¡¨è¾¾å¼åº”è¯¥è¾“å‡ºçš„è¡Œæ•°
                src_logical_rows_copy.len(),
            )? {
                RpnStackNode::Scalar { value, .. } =&gt; {
                    // å¦‚æœè¡¨è¾¾å¼æ˜¯ä¸€ä¸ªæ ‡é‡ï¼Œæ ¹æ®è½¬æ¢æˆ `bool` çš„å€¼ç¡®å®šæ˜¯å¦ä¿ç•™è¯¥åˆ—ã€‚
                    update_logical_rows_by_scalar_value(
                        &amp;mut src_result.logical_rows,
                        &amp;mut self.context,
                        value,
                    )?;
                }
                RpnStackNode::Vector { value, .. } =&gt; {
                    // æ ¹æ®æ¯è¡Œçš„ç»“æœï¼Œç¡®å®šæ˜¯å¦ä¿ç•™é‚£è¡Œã€‚
                    update_logical_rows_by_vector_value(
                    &amp;mut src_result.logical_rows,
                    &amp;mut self.context,
                    eval_result,
                    eval_result_logical_rows,
                    )?;
                }
            }

            condition_index += 1;
        }

        Ok(())
    }
}</code></pre></div><h3><code>BatchFastHashAggregationExecutor</code> çš„å®ç°</h3><p>èšåˆç®—å­çš„ç§ç±»æœ‰å¾ˆå¤šç§ï¼ŒåŒ…æ‹¬ï¼š</p><p><code>SimpleAggregation</code> (æ²¡æœ‰ <code>group by</code> å­—å¥ï¼Œåªæœ‰èšåˆå‡½æ•°)</p><ul><ul><li>=&gt; <code>select count(*) from t where a &gt; 1</code></li></ul></ul><p><code>FastHashAggregation</code> (åªæœ‰ä¸€ä¸ª <code>group by</code> column)</p><ul><ul><li>=&gt; <code>select count(*) from t group by a</code></li></ul></ul><p><code>SlowHashAggregation</code> (å¤šä¸ª <code>groub by</code> columns, æˆ–è€…è¡¨è¾¾å¼å€¼ä¸æ˜¯ <code>Hashable</code> çš„)</p><ul><ul><li>=&gt; <code>select sum(*) from t group by a, b</code></li></ul></ul><p><code>StreamAggregation</code> è¿™ç§èšåˆç®—å­å‡è®¾è¾“å…¥å·²ç»æŒ‰ç…§ <code>group by</code> columns æ’å¥½åºã€‚</p><p>æˆ‘ä»¬è¿™é‡ŒæŒ‘å‡ºä¸€ä¸ªæ¯”è¾ƒå…·æœ‰ä»£è¡¨æ€§çš„ç®—å­ï¼š<code>BatchFastHashAggregationExecutor</code> æ¥è¿›è¡Œåˆ†æã€‚</p><p>é¦–å…ˆè¦æ˜ç¡®ä¸€ä¸‹ <code>BatchFastHashAggregationExecutor</code> å¤§è‡´çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œé¦–å…ˆæˆ‘ä»¬ä¼šæ ¹æ® <code>group by</code> column é‡Œè¾¹çš„å€¼ç»™ä¸‹å±‚ç®—å­è¿”å›çš„è¡¨è¿›è¡Œåˆ†ç»„ï¼Œæ¯”å¦‚ï¼š</p><div class="highlight"><pre><code class="language-text">select count(*) from t group by a</code></pre></div><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-39c46a99e107639c311e6e2cce953021_b.jpg" data-caption="" data-size="normal" data-rawwidth="725" data-rawheight="479" class="origin_image zh-lightbox-thumb" width="725" data-original="https://pic2.zhimg.com/v2-39c46a99e107639c311e6e2cce953021_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-39c46a99e107639c311e6e2cce953021_b.jpg" data-caption="" data-size="normal" data-rawwidth="725" data-rawheight="479" class="origin_image zh-lightbox-thumb lazy" width="725" data-original="https://pic2.zhimg.com/v2-39c46a99e107639c311e6e2cce953021_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-39c46a99e107639c311e6e2cce953021_b.jpg"/></figure><p>ç„¶åï¼Œæˆ‘ä»¬ä¼šéå†æ¯ä¸ªç»„ï¼Œç„¶åé’ˆå¯¹æ¯ä¸ªç»„æ±‚å‡ºæ¯ä¸ªèšåˆå‡½æ•°çš„å€¼ï¼Œåœ¨è¿™é‡Œå°±æ˜¯ï¼š</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-20e346377b4bd8fe66031f7423510512_b.jpg" data-caption="" data-size="normal" data-rawwidth="602" data-rawheight="493" class="origin_image zh-lightbox-thumb" width="602" data-original="https://pic3.zhimg.com/v2-20e346377b4bd8fe66031f7423510512_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-20e346377b4bd8fe66031f7423510512_b.jpg" data-caption="" data-size="normal" data-rawwidth="602" data-rawheight="493" class="origin_image zh-lightbox-thumb lazy" width="602" data-original="https://pic3.zhimg.com/v2-20e346377b4bd8fe66031f7423510512_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-20e346377b4bd8fe66031f7423510512_b.jpg"/></figure><p>æ¥ä¸‹æ¥å°±æ¶‰åŠåˆ°ä¸¤ä¸ªé‡è¦çš„ç»†èŠ‚ï¼š</p><ol><li>èšåˆå‡½æ•°å¦‚ä½•æ±‚å€¼ã€‚</li><li>å¦‚ä½•æ ¹æ® <code>group_by column</code> å¯¹è¡Œè¿›è¡Œåˆ†ç»„å¹¶èšåˆã€‚</li></ol><p>åç»­å‡ èŠ‚æˆ‘ä»¬ç€é‡ä»‹ç»ä¸€ä¸‹è¿™ä¸¤ä¸ªç»†èŠ‚æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><h3>èšåˆå‡½æ•°</h3><p>æ¯ä¸ªèšåˆå‡½æ•°éƒ½ä¼šå®ç°ä¸€ä¸ª <code><a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/aggr_fn/mod.rs%23L35" class=" wrap external" target="_blank" rel="nofollow noreferrer">AggrFunction</a></code> è¿™ä¸ª traitï¼š</p><div class="highlight"><pre><code class="language-text">pub trait AggrFunction: std::fmt::Debug + Send + &#39;static {
    /// The display name of the function.
    fn name(&amp;self) -&gt; &amp;&#39;static str;

    /// Creates a new state instance. Different states aggregate independently.
    fn create_state(&amp;self) -&gt; Box&lt;dyn AggrFunctionState&gt;;
}

// NOTE: AggrFunctionState æ˜¯ AggrFunctionStateUpdatePartial çš„ super trait
pub trait AggrFunctionState:
    std::fmt::Debug
    + Send
    + &#39;static
    + AggrFunctionStateUpdatePartial&lt;Int&gt;
    + AggrFunctionStateUpdatePartial&lt;Real&gt;
    + AggrFunctionStateUpdatePartial&lt;Decimal&gt;
    + AggrFunctionStateUpdatePartial&lt;Bytes&gt;
    + AggrFunctionStateUpdatePartial&lt;DateTime&gt;
    + AggrFunctionStateUpdatePartial&lt;Duration&gt;
    + AggrFunctionStateUpdatePartial&lt;Json&gt;
{
    fn push_result(&amp;self, ctx: &amp;mut EvalContext, target: &amp;mut [VectorValue]) -&gt; Result&lt;()&gt;;
}
pub trait AggrFunctionStateUpdatePartial&lt;T: Evaluable&gt; {
    fn update(&amp;mut self, ctx: &amp;mut EvalContext, value: &amp;Option&lt;T&gt;) -&gt; Result&lt;()&gt;;

    fn update_repeat(
        &amp;mut self,
        ctx: &amp;mut EvalContext,
        value: &amp;Option&lt;T&gt;,
        repeat_times: usize,
    ) -&gt; Result&lt;()&gt;;

    fn update_vector(
        &amp;mut self,
        ctx: &amp;mut EvalContext,
        physical_values: &amp;[Option&lt;T&gt;],
        logical_rows: &amp;[usize],
    ) -&gt; Result&lt;()&gt;;
}</code></pre></div><p>èšåˆå‡½æ•°çš„æ±‚å€¼è¿‡ç¨‹åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>åˆ›å»ºå¹¶åˆå§‹åŒ–çŠ¶æ€ï¼Œè¿™ä¸€è¿‡ç¨‹ä¸€èˆ¬æ˜¯ç”±è°ƒç”¨è€…è°ƒç”¨ï¼š<code>create_state</code> å®ç°çš„ã€‚</li><li>ç„¶ååœ¨ä¸æ–­éå†è¡Œ/å‘é‡çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†è¡Œçš„å†…å®¹ä¼ å…¥ <code>update/update_repeat/update_vector</code> å‡½æ•°(å…·ä½“è°ƒç”¨é‚£ç§å–å†³äºä¸åŒçš„èšåˆå‡½æ•°å®ç°)ï¼Œæ›´æ–°å†…éƒ¨çš„çŠ¶æ€ï¼Œæ¯”å¦‚é‡åˆ°ä¸€ä¸ªéç©ºè¡Œï¼Œ<code>COUNT()</code> å°±ä¼šç»™è‡ªå·±å†…éƒ¨è®¡æ•°å™¨+1ã€‚</li><li>å½“éå†ç»“æŸä¹‹åï¼Œèšåˆå‡½æ•°å°±ä¼šå°†è‡ªå·±çš„çŠ¶æ€é€šè¿‡ push_result(), å†™å…¥åˆ°ä¸€ä¸ªåˆ—æ•°ç»„é‡Œè¾¹ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥æ˜¯åˆ—æ•°ç»„æ˜¯å› ä¸ºèšåˆå‡½æ•°å¯èƒ½æœ‰å¤šä¸ªè¾“å‡ºåˆ—ï¼Œæ¯”å¦‚ AVG()ï¼Œåœ¨åˆ†å¸ƒå¼çš„åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦è¿”å›ä¸¤åˆ—ï¼š<code>SUM</code> å’Œ <code>COUNT</code>ã€‚</li></ol><p>è¿™ä¸ª <code>trait</code> å¯ä»¥é€šè¿‡ <code>#[derive(AggrFuntion)]</code> è‡ªåŠ¨æ¨å¯¼å‡ºå®ç°ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡è¿‡ç¨‹å® <code>#[aggr_funtion(state = FooState::new())]</code> æ¥æŒ‡å®š <code>create_state</code> åˆ›å»ºå‡ºæ¥çš„ <code>State</code> ç±»å‹ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ<code>COUNT</code> çš„å®ç°ï¼š</p><div class="highlight"><pre><code class="language-text">/// The COUNT aggregate function.
#[derive(Debug, AggrFunction)]
#[aggr_function(state = AggrFnStateCount::new())]
pub struct AggrFnCount;

/// The state of the COUNT aggregate function.
#[derive(Debug)]
pub struct AggrFnStateCount {
    count: usize,
}

impl AggrFnStateCount {
    pub fn new() -&gt; Self {
        Self { count: 0 }
    }
}

impl AggrFunctionStateUpdatePartial for AggrFnStateCount { /* .. */ }
impl AggrFunctionState for AggrFnStateCount { /* .. */ }</code></pre></div><p>è¿™ä¸ªæ—¶å€™ï¼Œè°ƒç”¨ <code>create_state()</code> çš„æ—¶å€™å°±ä¼šå°†å†…éƒ¨çŠ¶æ€ Box èµ·æ¥ç„¶åè¿”å›ã€‚</p><h3>å¦‚ä½•æ ¹æ® <code>group by</code> column åˆ†ç»„å¹¶èšåˆ</h3><p><code>BatchFastHashAggregationExecutor</code> å†…éƒ¨ä¼šæœ‰ä¸€ä¸ª <code>Groups</code> çš„ç»“æ„ï¼Œå…¶æ ¸å¿ƒæ˜¯ä¸€ä¸ª <code>HashTable</code>ï¼Œæ ¹æ® <code>group by</code> è¡¨è¾¾å¼å…·ä½“çš„ç±»å‹ä½œä¸º <code>key</code> çš„ç±»å‹ï¼Œè€Œ <code>value</code> çš„å€¼åˆ™æ˜¯ä¸€ä¸ª <code>AggrFunctionState</code> æ•°ç»„ä¸­è¯¥ç»„å¯¹åº”çš„èšåˆå‡½æ•°çŠ¶æ€é›†åˆçš„å¼€å§‹ä¸‹æ ‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-58cb3d5d6e4ce20f68169eafd34332eb_b.jpg" data-caption="" data-size="normal" data-rawwidth="691" data-rawheight="449" class="origin_image zh-lightbox-thumb" width="691" data-original="https://pic4.zhimg.com/v2-58cb3d5d6e4ce20f68169eafd34332eb_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-58cb3d5d6e4ce20f68169eafd34332eb_b.jpg" data-caption="" data-size="normal" data-rawwidth="691" data-rawheight="449" class="origin_image zh-lightbox-thumb lazy" width="691" data-original="https://pic4.zhimg.com/v2-58cb3d5d6e4ce20f68169eafd34332eb_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-58cb3d5d6e4ce20f68169eafd34332eb_b.jpg"/></figure><p><code>Hash</code> å€¼ä¸€æ ·çš„è¡Œä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªç»„ä¸­ï¼Œæ¯ç»„ä¼šæœ‰è‹¥å¹²ä¸ªçŠ¶æ€ï¼Œèšåˆçš„è¿‡ç¨‹å…¶å®å°±æ˜¯æ ¹æ®æ¯è¡Œçš„ <code>group by</code> column æ‰¾åˆ°å…¶å¯¹åº”çš„åˆ†ç»„ (HashTable::get)ï¼Œç„¶åå¯¹ç»„å†…çš„æ¯ä¸€ä¸ªçŠ¶æ€ï¼Œæ ¹æ®è¯¥è¡Œçš„å†…å®¹è¿›è¡Œæ›´æ–°ã€‚æœ€åéå†æ¯ä¸ªç»„ï¼Œå°†ä»–ä»¬çš„çŠ¶æ€å†™å…¥åˆ°åˆ—æ•°ç»„å³å¯ã€‚</p><h3>å°†ä¸¤ä¸ªè¿‡ç¨‹ç»“åˆèµ·æ¥</h3><p>ä¸Šè¾¹ä¸¤èŠ‚è®¨è®ºäº†èšåˆå‡½æ•°å¦‚ä½•è®¡ç®—ï¼Œå¦‚ä½•åˆ†ç»„ä»¥åŠå¦‚ä½•å¯¹æ¯ä¸ªç»„åšèšåˆçš„åŸºæœ¬è¿‡ç¨‹ã€‚ç°åœ¨æˆ‘ä»¬é€šè¿‡ä»£ç ï¼Œæ¥æ¢è®¨ä¸€ä¸‹å…¶ä¸­çš„å…·ä½“ç»†èŠ‚ã€‚</p><p>å…ˆæ¥çœ‹çœ‹ <code><a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/batch/executors/fast_hash_aggr_executor.rs%23L34" class=" wrap external" target="_blank" rel="nofollow noreferrer">BatchFastHashAggregationExecutor</a></code> çš„å®šä¹‰:</p><div class="highlight"><pre><code class="language-text">pub struct BatchFastHashAggregationExecutor&lt;Src: BatchExecutor&gt;(
    AggregationExecutor&lt;Src, FastHashAggregationImpl&gt;,
);</code></pre></div><p>æˆ‘ä»¬å‘ç°ï¼Œè¿™ä¸ªå’Œ <code>BatchTableScanExecutor</code> çš„å®šä¹‰ååˆ†ç›¸ä¼¼ï¼ŒåŒºåˆ«æ¯ä¸ªèšåˆç®—å­è¡Œä¸ºçš„æ˜¯ <code>AggregationExecutor</code> é‡Œè¾¹å®ç°äº† <code>AggregationExecutorImpl</code> trait çš„ä¸€ä¸ªç»“æ„ä½“ã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹çœ‹è¿™ä¸ª trait æä¾›äº†å“ªäº›æ–¹æ³•ã€‚</p><div class="highlight"><pre><code class="language-text">pub struct AggregationExecutor&lt;Src: BatchExecutor, I: AggregationExecutorImpl&lt;Src&gt;&gt; {
    imp: I,
    is_ended: bool,
    entities: Entities&lt;Src&gt;,
}

pub trait AggregationExecutorImpl&lt;Src: BatchExecutor&gt;: Send {
    // æ ¹æ® `group by` columns å’Œ èšåˆå‡½æ•°åˆå§‹åŒ– `entities` ä¸­çš„ `schema`
    fn prepare_entities(&amp;mut self, entities: &amp;mut Entities&lt;Src&gt;);

    // æ ¹æ®ä¸‹å±‚ç®—å­æ‰«ä¸Šæ¥çš„æ•°æ®åšèšåˆå’Œåˆ†ç»„
    fn process_batch_input(
        &amp;mut self,
        entities: &amp;mut Entities&lt;Src&gt;,
        input_physical_columns: LazyBatchColumnVec,
        input_logical_rows: &amp;[usize],
    ) -&gt; Result&lt;()&gt;;

    // å°†æ¯ä¸ªèšåˆå‡½æ•°çš„çŠ¶æ€æ›´æ–°åˆ°åˆ—æ•°ç»„ä¸­ï¼Œå³å†™å…¥èšåˆç»“æœ
    // è¿™é‡Œè¿”å›çš„æ˜¯ `group by` columnï¼Œåœ¨åˆ†å¸ƒå¼åœºæ™¯å¦‚æœä¸æŠŠ `group by` column è¿”å›ï¼Œ`TiDB` æ²¡æœ‰åŠæ³•æ ¹æ®åˆ†ç»„åšäºŒæ¬¡èšåˆã€‚
    fn iterate_available_groups(
        &amp;mut self,
        entities: &amp;mut Entities&lt;Src&gt;,
        src_is_drained: bool,
        iteratee: impl FnMut(&amp;mut Entities&lt;Src&gt;, &amp;[Box&lt;dyn AggrFunctionState&gt;]) -&gt; Result&lt;()&gt;,
    ) -&gt; Result&lt;Vec&lt;LazyBatchColumn&gt;&gt;;
}</code></pre></div><p>ä¸Šè¾¹ä»£ç ä¸­çš„ <code>Entities</code> æ˜¯è®°å½•æºç®—å­å·²ç»èšåˆå‡½æ•°å…ƒä¿¡æ¯çš„ä¸€ä¸ªç»“æ„ä½“ï¼š</p><div class="highlight"><pre><code class="language-text">pub struct Entities&lt;Src: BatchExecutor&gt; {
    pub src: Src,
    
    // ...

    // èšåˆåäº§ç”Ÿçš„ `schmea`ï¼Œ åŒ…å« `group_by` columns
    pub schema: Vec&lt;FieldType&gt;,

    /// èšåˆå‡½æ•°çš„é›†åˆ
    pub each_aggr_fn: Vec&lt;Box&lt;dyn AggrFunction&gt;&gt;,

    /// æ¯ä¸ªèšåˆå‡½æ•°è¾“å‡ºçš„åˆ—å¤§å°ï¼Œ`COUNT` æ˜¯ 1ï¼Œ`AVG` æ˜¯ 2
    pub each_aggr_cardinality: Vec&lt;usize&gt;,

    /// èšåˆå‡½æ•°é‡Œè¾¹çš„è¡¨è¾¾å¼
    pub each_aggr_exprs: Vec&lt;RpnExpression&gt;,

    // æ¯ä¸ªèšåˆè¡¨è¾¾å¼è¾“å‡ºçš„ç±»å‹çš„é›†åˆ
    pub all_result_column_types: Vec&lt;EvalType&gt;,
}</code></pre></div><p>é¦–å…ˆï¼Œä¸ºäº†è§‚å¯Ÿåˆ° <code>BatchFastHashAggregationExecutor</code> æˆ‘ä»¬éœ€è¦è¿½è¸ªä»–çš„ <code>next_batch()</code> çš„å®ç°ï¼Œåœ¨è¿™é‡Œä¹Ÿå°±æ˜¯ï¼š <code>AggregationExecutor::handle_next_batch</code>ï¼š</p><div class="highlight"><pre><code class="language-text">fn handle_next_batch(&amp;mut self) -&gt; Result&lt;(Option&lt;LazyBatchColumnVec&gt;, bool)&gt; {
        // ä»ä¸‹å±‚ç®—å­å–å›ä¸€ä¸ª `batch`
        let src_result = self
            .entities
            .src
            .next_batch(crate::batch:ğŸƒ:BATCH_MAX_SIZE);

        self.entities.context.warnings = src_result.warnings;

        let src_is_drained = src_result.is_drained?;

        // å¦‚æœä¸‹å±‚è¿”å›çš„æ•°æ®ä¸ä¸ºç©ºï¼Œå°†æ ¹æ®æ¯è¡Œçš„ç»“æœåˆ†ç»„å¹¶èšåˆ
        if !src_result.logical_rows.is_empty() {
            self.imp.process_batch_input(
                &amp;mut self.entities,
                src_result.physical_columns,
                &amp;src_result.logical_rows,
            )?;
        }

        // åœ¨ `FastHashAggr` ä¸­ï¼Œåªæœ‰ä¸‹å±‚ç®—å­æ²¡æœ‰åŠæ³•å†è¿”å›æ•°æ®çš„æ—¶å€™ï¼Œæ‰èƒ½è®¤ä¸ºèšåˆå·²ç»å®Œæˆï¼Œ
        // å¦åˆ™æˆ‘ä»¬è¿”å›ä¸€ä¸ªç©ºæ•°æ®ç»™ä¸Šå±‚ç®—å­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡ `next_batch` è¢«è°ƒç”¨ã€‚
        let result = if src_is_drained {
            Some(self.aggregate_partial_results(src_is_drained)?)
        } else {
            None
        };
        Ok((result, src_is_drained))
    }</code></pre></div><p>å…·ä½“åˆ° <code>FastHashAggr</code> ä¸­ï¼Œ<code>process_batch_input</code> å°±æ˜¯åˆ†ç»„å¹¶æ›´æ–°æ¯ç»„çš„çŠ¶æ€ã€‚<code>aggregate_partial_results</code> å°±æ˜¯å†™å…¥æœ€ç»ˆçš„çŠ¶æ€åˆ°åˆ—æ•°ç»„ä¸­ã€‚</p><h2>æ€»ç»“</h2><p>æœ¬æ–‡ç®€ç•¥çš„ä»‹ç»äº† TiKV æŸ¥è¯¢å¼•æ“çš„å®ç°åŸç†å’Œå‡ ä¸ªç®€å•ç®—å­çš„å®ç°ï¼Œå¦‚æœå¤§å®¶å¯¹å…¶ä»–ç®—å­ä¹Ÿæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥åˆ° <a href="https://link.zhihu.com/?target=https%3A//github.com/tikv/tikv/tree/983c626b069f2a2314d0a47009ca74033b346069/components/tidb_query/src/batch/executors" class=" wrap external" target="_blank" rel="nofollow noreferrer">tikv/components/tidb_query/src/batch/executors</a> ä¸‹è¾¹æ‰¾åˆ°å¯¹åº”çš„å®ç°ï¼Œæœ¬æ–‡ä¸­å‡ºç°çš„ä»£ç éƒ½ç»è¿‡ä¸€å®šåˆ å‡ï¼Œæ¬¢è¿å¤§å®¶é˜…è¯» TiKV çš„æºç è·å–æ›´å¤šçš„ç»†èŠ‚ã€‚</p><p><b>åŸæ–‡é˜…è¯»ï¼š</b></p><a href="https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/tikv-source-code-reading-16/" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg" data-image-width="1200" data-image-height="1200" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiKV æºç è§£æç³»åˆ—æ–‡ç« ï¼ˆåå…­ï¼‰TiKV Coprocessor Executor æºç è§£æ | PingCAP</a><p><b>æ›´å¤š TiKV æºç é˜…è¯»ï¼š</b></p><a href="https://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/%23TiKV-%25E6%25BA%2590%25E7%25A0%2581%25E8%25A7%25A3%25E6%259E%2590" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg" data-image-width="1200" data-image-height="1200" class=" wrap external" target="_blank" rel="nofollow noreferrer">Blog-cns | PingCAP</a><p></p>