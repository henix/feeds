<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>引用外部脚本的隐患及防御</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/29016122">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-bf7b5a58535ca4b4221670bd0e59b7cb_r.jpg" alt=""></div><p>在这篇文章里，我们将换一个姿势利用 XSS。通常来讲，XSS 是由程序对输入缺乏合理的过滤而产生的。但在这篇文章里，我会展示如何在正确过滤 XSS 的网站中利用 XSS。它和常规攻击手段类似，我们也可以用它来偷 cookie 或者钓鱼。不过在之前，我们先来讲解一下跨域资源共享技术。</p><h2><b>跨域资源共享</b></h2><p>跨域资源能够提供浏览器更好的用户体验。通过它，我们可以在一个网站上访问到不属于它域下的资源（比如图像，javascript，以及其它数据）。打个比方：</p><p>http://example.com 有如下跨域资源：</p><ul><li>通过 XMLHttpRequest 请求securelayer7.net已登陆用户的数据</li><li>用&lt;iframe src&gt;标签包含http://youtube.com</li><li>用&lt;img src&gt;请求http://imgur.com的图片</li><li>用&lt;script src&gt;请求https://code.jquery.com/jquery-1.8.1.min.js取得的javascript库</li></ul><img src="https://pic2.zhimg.com/v2-bf7b5a58535ca4b4221670bd0e59b7cb_r.png" data-rawwidth="656" data-rawheight="504"><p><br></p><h2><b>为什么要引用脚本，而不是直接内联？</b></h2><p>当许多网站同时引用&lt;script src=”https://code.jquery.com/jquery-1.8.1.min.js”&gt;&lt;/script&gt;时，浏览器只需加载一次，便可以将其载入缓存方便不同网站对其的调用。</p><p>为什么我们又需要加载外部的javascript库呢？答案很简单，方便开发。在 jQuery 中，我们只需短短的一句，就可以改变背景颜色：$(‘body’).css('background', '#ccc');</p><p>如果直接用原生 JavaScript 操作 DOM 的话，我们就得：</p><code lang="js">Function changeBachground(color) {
  Document.body.style.background = color;
}
 
Onload="changeBackground('red');" //某个事件
</code><h2><b>由 javascript 引用而导致的漏洞</b></h2><p>由于控制权的缺失，加载第三方控制的脚本有十分严重的安全隐患。第三方网站的站长有可能在脚本中插入恶意代码。或者网站自身有漏洞而被攻击者所控制，最终导致攻击者篡改其提供的脚本。</p><h2><b>攻击从本地加载的脚本</b></h2><p>假设在一个开发环境中，工程师用&lt;script src="http://127.0.0.1:4545/import.js"&gt;&lt;/script&gt;加载本地Web服务器上的资源。如果在发布该应用时没有移除这个语句，那么攻击者可以使用如下手段来攻击目标：</p><ul><li>登陆运行该应用的电脑（物理渗透，SSRF）</li><li>用一个 Web 服务器监听本地4545端口，并返回恶意js。</li><li>目标在该电脑上开启浏览器，进入这个程序</li><li>浏览器加载恶意 JavaScript，导致XSS</li></ul><h2><b>攻击从局域网加载的脚本</b></h2><p>继续假设一个开发环境，开发者用脚本来加载内部服务器的资源：&lt;script src="http://192.168.0.111/import.js"&gt;&lt;/script&gt;。这时候，攻击者也可以按照类似攻击本地资源的手法插入恶意脚本，只不过需要锁定一个ip罢了（SSRF，内网渗透，物理渗透）。</p><h2><b>源于未注册域名的脚本</b></h2><p>很多时候，工程师会在host文件中加入自定义的域名。这样一来省钱，二来不用部署。或者有些已经注册的域名忘记续费而过期了，如果发布时碰巧忘记移除它（比如&lt;script src="https://securelayer7.net/import.js"&gt;&lt;/script&gt;）。那么攻击者便有机可乘了：</p><ul><li>注册securelayer7.net并返回import.js</li><li>用户浏览时会加载我们的恶意脚本</li></ul><h2><b>加载动态 ip 的脚本</b></h2><p>开发者很有可能会犯将 ip 设为动态这种低级错误。我们只需想办法获取该 ip 地址的控制权（思路也和内网类似），便可以攻击目标了。</p><h2><b>因为输入加载错误的域名</b></h2><p>很多时候，开发者会漏打或者错打域名（比方说：&lt;script src="https://code.jqueri.com/import.js"&gt;&lt;/script&gt;）我们可以趁机注册该域名并返回恶意代码</p><h2><b>从一个运行 HTTP 的服务器加载脚本</b></h2><p>如果一个脚本是用HTTP（不是HTTPS）传输的，那么我们可以用中间人攻击（arp攻击，icmp攻击）来篡改脚本并在其中注入内容。</p><h2><b>防护措施</b></h2><ul><li>从本地或者内网 ip 加载的脚本都要被替换成其它安全位置的脚本</li><li>严格管控现有的域名，确保知道哪些过期了，哪些没有</li><li>脚本不应该从动态 ip 中引入</li><li>再三检查输入域名是否配对真实域名</li><li>尽可能地使用 https</li><li>脚本应该尽量存放在安全性高的第三方网站</li><li>如果你不能保证上述几点，不要因为追求性能而无视安全性（引用脚本改成内联）</li></ul><p><br></p><p><i>作者：<b>Saurabh Banawar —— <a href="http://blog.securelayer7.net/owasp-top-10-cross-site-scripting-3-bad-javascript-imports/">http://blog.securelayer7.net/owasp-top-10-cross-site-scripting-3-bad-javascript-imports/</a></b></i></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
