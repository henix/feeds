<div class="title-image"><img src="https://pic4.zhimg.com/v2-3dfc36e0e68d4715ec042b5f3f8562a9_b.jpg" alt=""></div><p>ç¨ä½œé…ç½®ï¼ŒåŒä¸€ä»½ä»£ç æ¨ªè·¨ Android &amp; IOSï¼Œç›¸æ¯”äº React Native æ–¹æ¡ˆæ›´åŠ é«˜æ€§èƒ½ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¾—ç›Šäº Rust è·¨å¹³å°åŠ æŒï¼ŒRust éƒ¨åˆ†çš„ä»£ç å¯åœ¨ç§ç§åœºåˆå¤ç”¨ã€‚</p><p>è¿™ç¯‡æ–‡ç« æ—¨åœ¨è®°å½•ä½œè€…å°è¯•ç»“åˆ Rust å’Œ Flutter çš„è¿‡ç¨‹ï¼Œä¸”ä»…ä¸ºåˆæ­¥å°è¯•ã€‚ä¸ä¼šæ¶‰åŠè¯¸å¦‚ï¼š</p><p> å¦‚ä½•æ­å»ºä¸€ä¸ª Flutter å¼€å‘ç¯å¢ƒï¼Œä»¥åŠ Dart è¯­è¨€æ€ä¹ˆç”¨ </p><p> å¦‚ä½•æ­å»ºä¸€ä¸ª Rust å¼€å‘ç¯å¢ƒï¼Œä»¥åŠ Rust è¯­è¨€æ€ä¹ˆå­¦</p><p class="ztext-empty-paragraph"><br/></p><p>å¼€å¤´ç»™è‡ªå·±åšå®¢æ‰“æ³¢å¹¿å‘ŠğŸ‘‡</p><a href="https://link.zhihu.com/?target=https%3A//blog.idx0.dev/2020/02/15/flutter-rust-1/" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-3dfc36e0e68d4715ec042b5f3f8562a9_180x120.jpg" data-image-width="1356" data-image-height="1070" class=" wrap external" target="_blank" rel="nofollow noreferrer">Rust + Flutter é«˜æ€§èƒ½çš„è·¨ç«¯å°è¯•</a><h2>Environment</h2><ul><li>Flutter: Android, IOS å·¥å…·é…ç½®å¦¥å½“   </li></ul><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-c58477665a91f3af41629d66930fb2e2_b.jpg" data-caption="" data-size="normal" data-rawwidth="1344" data-rawheight="420" class="origin_image zh-lightbox-thumb" width="1344" data-original="https://pic3.zhimg.com/v2-c58477665a91f3af41629d66930fb2e2_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-c58477665a91f3af41629d66930fb2e2_b.jpg" data-caption="" data-size="normal" data-rawwidth="1344" data-rawheight="420" class="origin_image zh-lightbox-thumb lazy" width="1344" data-original="https://pic3.zhimg.com/v2-c58477665a91f3af41629d66930fb2e2_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-c58477665a91f3af41629d66930fb2e2_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><ul><li>Rust: Stable å°±å¥½   </li></ul><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-0370ff9fd40521e643ed14fa41c7186e_b.jpg" data-caption="" data-size="normal" data-rawwidth="1026" data-rawheight="204" class="origin_image zh-lightbox-thumb" width="1026" data-original="https://pic3.zhimg.com/v2-0370ff9fd40521e643ed14fa41c7186e_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-0370ff9fd40521e643ed14fa41c7186e_b.jpg" data-caption="" data-size="normal" data-rawwidth="1026" data-rawheight="204" class="origin_image zh-lightbox-thumb lazy" width="1026" data-original="https://pic3.zhimg.com/v2-0370ff9fd40521e643ed14fa41c7186e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-0370ff9fd40521e643ed14fa41c7186e_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><h2>Rust Part</h2><h3>Prepare cross-platform toolchains &amp; deps</h3><h3>IOS</h3><div class="highlight"><pre><code class="language-text"># Download targets for IOS ( 64 bit targets (real device &amp; simulator) )
rustup target add aarch64-apple-ios x86_64-apple-ios 

# Install cargo-lipo to generate the iOS universal library
cargo install cargo-lipo</code></pre></div><h3>Android</h3><p><a href="https://link.zhihu.com/?target=https%3A//github.com/kennytm/rust-ios-android" class=" wrap external" target="_blank" rel="nofollow noreferrer">è¿™é‡Œ</a>æœ‰ä¸€äº›è¡Œä¹‹æœ‰æ•ˆçš„è¾…åŠ©è„šæœ¬ç”¨äºæ›´åŠ å¿«æ·é…ç½®äº¤å‰ç¼–è¯‘å·¥å…·ã€‚</p><ol><li> è·å– Android NDK<br/> <code>sh sdkmanager --verbose ndk-bundle</code> å¦‚æœå·²ç»å‡†å¤‡å¥½äº† Android NDK ï¼Œåˆ™è®¾ç½®ç¯å¢ƒå˜é‡ <code>$ANDROID_NDK_HOME</code> ```sh<br/> example:<br/> export ANDROID_NDK_HOME=/Users/yinsiwei/Downloads/android-ndk-r20b <code>2. Create the standalone NDK</code>sh<br/> $(pwd) == ~/Downloads<br/> git clone <a href="https://link.zhihu.com/?target=https%3A//github.com/kennytm/rust-ios-android.git" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/kennytm/rust</span><span class="invisible">-ios-android.git</span><span class="ellipsis"></span></a> cd rust-ios-android ./create-ndk-standalone.sh <code>3. åœ¨ Cargo default config VS é…ç½® Android äº¤å‰ç¼–è¯‘å·¥å…·</code>sh cat cargo-config.toml &gt;&gt; ~/.cargo/config <code>æ‰§è¡Œä¸Šè¿°å‘½ä»¤åä¼šåœ¨ Cargo é»˜è®¤é…ç½®ä¸­ï¼Œå¢åŠ æœ‰å…³ Android è·¨å¹³å°ç›®æ ‡ (targets, `aarch64-linux-android`, `armv7-linux-androideabi`, `i686-linux-android`) çš„å·¥å…·ä¿¡æ¯ï¼ŒæŒ‡å‘åˆšåˆšåˆ›å»ºçš„ `standalone NDK`ã€‚</code>ini [target.aarch64-linux-android] ar = ... linker = ..<br/> [target.armv7-linux-androideabi] ...<br/> [target.i686-linux-android] .. <code>4. ä¸‹è½½ Rust æ”¯æŒ Android äº¤å‰ç¼–è¯‘çš„ä¾èµ–</code>sh rustup target add aarch64-linux-android armv7-linux-androideabi i686-linux-android ```<br/> </li></ol><h3>Start a simple rust library</h3><ol><li> åˆ›å»ºä¸€ä¸ª Rust é¡¹ç›®<br/> <code>sh  cargo init my-app-base --lib</code><br/> </li><li> ç¼–è¾‘ <code>Cargo.toml</code> ä¿®æ”¹ <code>crate-type</code><br/> <code>ini [lib] name = &#34;my_app_base&#34; crate-type = [&#34;staticlib&#34;, &#34;cdylib&#34;]</code> Rust æ„å»ºå‡ºæ¥çš„äºŒè¿›åˆ¶åº“ï¼Œåœ¨ IOS ä¸­æ˜¯é™æ€é“¾æ¥è¿›æœ€ç»ˆçš„ç¨‹åºä¹‹ä¸­ï¼Œéœ€è¦å¯¹æ„å»º <code>staticlib</code> çš„æ”¯æŒï¼›åœ¨ Android æ˜¯é€šè¿‡åŠ¨æ€é“¾æ¥åœ¨è¿è¡Œæ—¶è£…åœ¨è¿›ç¨‹åºè¿è¡Œç©ºé—´çš„ï¼Œéœ€è¦å¯¹æ„å»º <code>cdylib</code> çš„æ”¯æŒã€‚<br/> </li><li> å†™ä¸€äº›ç¬¦åˆ C ABI çš„å‡½æ•° <code>src/lib.rs</code><br/> ```rust use std::os::raw::c_char; use std::ffi::CString;<br/> [no_mangle]<br/> pub unsafe extern fn hello() -&gt; *const c_char {     let s = CString::new(&#34;world&#34;).unwrap();     s.into_raw() } ```<br/> åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæ¯æ¬¡å½“å¤–éƒ¨è°ƒç”¨ <code>hello</code> å‡½æ•°æ—¶ï¼Œä¼šåœ¨æ™‹åŸå †ç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸² ( <code>CString</code> )ï¼Œå¹¶å°†æ‰€æœ‰æƒ ( é‡Šæ”¾è¯¥å­—ç¬¦ä¸²æ‰€å å †ç©ºé—´çš„æƒåˆ© ) ç§»äº¤ç»™<b>è°ƒç”¨è€…</b>ã€‚<br/> </li></ol><h3>Build libraries</h3><div class="highlight"><pre><code class="language-text"># IOS
cargo lipo --release

# Android
cargo build --target aarch64-linux-android --release
cargo build --target armv7-linux-androideabi --release
cargo build --target i686-linux-android --release</code></pre></div><p>ç„¶ååœ¨ <code>target</code> ç›®å½•ä¸‹ä¼šå¾—åˆ°ä»¥ä¸‹æœ‰ç”¨çš„ç‰©æ–™ã€‚</p><div class="highlight"><pre><code class="language-text">target
    â”œâ”€â”€ aarch64-linux-android
    â”‚   â””â”€â”€ release
    â”‚       â”œâ”€â”€ libmy_app_base.a
    â”‚       â””â”€â”€ libmy_app_base.so
    â”œâ”€â”€ armv7-linux-androideabi
    â”‚   â””â”€â”€ release
    â”‚       â”œâ”€â”€ libmy_app_base.a
    â”‚       â””â”€â”€ libmy_app_base.so
    â”œâ”€â”€ i686-linux-android
    â”‚   â””â”€â”€ release
    â”‚       â”œâ”€â”€ libmy_app_base.a
    â”‚       â””â”€â”€ libmy_app_base.so
    â”œâ”€â”€ universal
    â”‚   â””â”€â”€ release
    â”‚       â””â”€â”€ libmy_app_base.a</code></pre></div><p>è‡³æ­¤ï¼Œ <code>Rust</code> éƒ¨åˆ†å°±å‘Šäºæ®µè½äº†ã€‚</p><h2>Flutter Part</h2><h3>Copy build artifacts to flutter project</h3><div class="highlight"><pre><code class="language-text">from: target/universal/release/libmy_app_base.a 
to: ios/

from: target/aarch64-linux-android/release/libmy_app_base.so 
to: android/app/src/main/jniLibs/arm64-v8a/

from: target/armv7-linux-androideabi/release/libmy_app_base.so 
to: android/app/src/main/jniLibs/armeabi-v7a/

from: target/i686-linux-android/release/libmy_app_base.so 
to: android/app/src/main/jniLibs/x86/</code></pre></div><h3>Call FFI function in Dart</h3><ol><li> æ·»åŠ ä¾èµ–<br/> <code>pubspec.yaml</code> -&gt; <code>dev_dependencies:</code> += <code>ffi: ^0.1.3</code><br/> </li><li> æ·»åŠ ä»£ç <br/> (ç›´æ¥åœ¨ç”Ÿæˆçš„é¡¹ç›®ä¸Šä¿®æ”¹ï¼Œæš‚ä¸è€ƒè™‘ä»£ç è®¾è®¡é—®é¢˜ï¼Œå°±ç®€ç®€å•å•çš„å…ˆæŠŠé¡¹ç›®è·‘èµ·æ¥ ) ```dart import &#39;dart:ffi&#39;; import &#39;package:ffi/ffi.dart&#39;;<br/> // ... final dylib = Platform.isAndroid ? DynamicLibrary.open(&#39;libmy_app_base.so&#39;) :DynamicLibrary.process(); var hello = dylib.lookupFunction Function(),Pointer Function()&gt;(&#39;hello&#39;);<br/> // ... hello();  // -&gt; world ```<br/> </li></ol><h3>Build Android Project</h3><div class="highlight"><pre><code class="language-text">flutter run # å¦‚æœè¿æ¥ç€ Android è®¾å¤‡å°±ç›´æ¥è¿è¡Œäº†èµ·æ¥</code></pre></div><h3>Build IOS Project</h3><p>( å¤æ‚äº†è®¸å¤š )</p><ol><li>è·Ÿéš <code>Flutter</code> <a href="https://link.zhihu.com/?target=https%3A//flutter.dev/docs/get-started/install/macos%23ios-setup" class=" wrap external" target="_blank" rel="nofollow noreferrer">å®˜æ–¹æ–‡æ¡£</a>ï¼Œé…ç½® <code>XCode</code> é¡¹ç›®ã€‚</li><li>åœ¨ <code>Build Phases</code> ä¸­ <code>Link Binary With Libraries</code> æ·»åŠ  <code>libmy_app_base.a</code> æ–‡ä»¶     (æŒ‰ç…§å›¾ä¸Šç®­å¤´ç‚¹...)     </li></ol><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-62c13d1d4d69a0722b905ee192e71d27_b.jpg" data-caption="" data-size="normal" data-rawwidth="2280" data-rawheight="854" class="origin_image zh-lightbox-thumb" width="2280" data-original="https://pic4.zhimg.com/v2-62c13d1d4d69a0722b905ee192e71d27_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-62c13d1d4d69a0722b905ee192e71d27_b.jpg" data-caption="" data-size="normal" data-rawwidth="2280" data-rawheight="854" class="origin_image zh-lightbox-thumb lazy" width="2280" data-original="https://pic4.zhimg.com/v2-62c13d1d4d69a0722b905ee192e71d27_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-62c13d1d4d69a0722b905ee192e71d27_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><ol><li>åœ¨ <code>Build Settings</code> ä¸­ <code>Other Linker Flags</code> ä¸­æ·»åŠ  <code>force_load</code> çš„å‚æ•°ã€‚     </li></ol><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-042670ee855d25046ec7f98b8d0ed5cc_b.jpg" data-caption="" data-size="normal" data-rawwidth="1710" data-rawheight="680" class="origin_image zh-lightbox-thumb" width="1710" data-original="https://pic1.zhimg.com/v2-042670ee855d25046ec7f98b8d0ed5cc_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-042670ee855d25046ec7f98b8d0ed5cc_b.jpg" data-caption="" data-size="normal" data-rawwidth="1710" data-rawheight="680" class="origin_image zh-lightbox-thumb lazy" width="1710" data-original="https://pic1.zhimg.com/v2-042670ee855d25046ec7f98b8d0ed5cc_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-042670ee855d25046ec7f98b8d0ed5cc_b.jpg"/></figure><p class="ztext-empty-paragraph"><br/></p><p>è¿™æ˜¯ç”±äºåœ¨ Dart ä¸­é€šè¿‡åŠ¨æ€çš„æ–¹å¼è°ƒç”¨äº†è¯¥åº“çš„ç›¸å…³å‡½æ•°ï¼Œä½†åœ¨ç¼–è¯‘æœŸé—´é™æ€åˆ†æçš„æ—¶å€™ï¼Œè¿™äº›éƒ½æ˜¯æœªæ›¾è¢«è°ƒç”¨è¿‡çš„æ— ç”¨å‡½æ•°ï¼Œå°±è¢«å‰ªè£æ‰äº†ã€‚è¦é€šè¿‡ <code>force_load</code> æ–¹å¼è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2>Result</h2><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-5dbdfd2f43bf2186abe37c802bee0815_b.gif" data-caption="" data-size="normal" data-rawwidth="904" data-rawheight="1710" data-thumbnail="https://pic2.zhimg.com/v2-5dbdfd2f43bf2186abe37c802bee0815_b.jpg" class="origin_image zh-lightbox-thumb" width="904" data-original="https://pic2.zhimg.com/v2-5dbdfd2f43bf2186abe37c802bee0815_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-5dbdfd2f43bf2186abe37c802bee0815_b.gif" data-caption="" data-size="normal" data-rawwidth="904" data-rawheight="1710" data-thumbnail="https://pic2.zhimg.com/v2-5dbdfd2f43bf2186abe37c802bee0815_b.jpg" class="origin_image zh-lightbox-thumb lazy" width="904" data-original="https://pic2.zhimg.com/v2-5dbdfd2f43bf2186abe37c802bee0815_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-5dbdfd2f43bf2186abe37c802bee0815_b.gif"/></figure><p class="ztext-empty-paragraph"><br/></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-cac9f12ced5e34e3c14a8d5406fcea89_b.jpg" data-caption="" data-size="normal" data-rawwidth="1032" data-rawheight="1342" class="origin_image zh-lightbox-thumb" width="1032" data-original="https://pic2.zhimg.com/v2-cac9f12ced5e34e3c14a8d5406fcea89_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-cac9f12ced5e34e3c14a8d5406fcea89_b.jpg" data-caption="" data-size="normal" data-rawwidth="1032" data-rawheight="1342" class="origin_image zh-lightbox-thumb lazy" width="1032" data-original="https://pic2.zhimg.com/v2-cac9f12ced5e34e3c14a8d5406fcea89_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-cac9f12ced5e34e3c14a8d5406fcea89_b.jpg"/></figure><h2>Troubleshooting</h2><h3>XCode &amp; IOS</h3><h3>Error getting attached iOS device: ideviceinfo could not find device</h3><div class="highlight"><pre><code class="language-text">sudo xattr -d com.apple.quarantine ~/flutter/bin/cache/artifacts/libimobiledevice/ideviceinfo</code></pre></div><p>å°†åé¢çš„è·¯å¾„æ›¿æ¢æˆä½ çš„</p><h3>dyld: Library not loaded</h3><div class="highlight"><pre><code class="language-text">dyld: Library not loaded: /b/s/w/ir/k/homebrew/Cellar/libimobiledevice-flutter/HEAD-398c120_3/lib/libimobiledevice.6.dylib
  Referenced from: /Users/hey/flutter/bin/cache/artifacts/libimobiledevice/idevice_id
  Reason: image not found</code></pre></div><p>åˆ é™¤&amp;é‡æ–°ä¸‹è½½</p><div class="highlight"><pre><code class="language-text">rm -rf /Users/hey/flutter/bin/cache &amp;&amp; flutter doctor -v</code></pre></div><h3>çœŸæœºæ— æ³•å¯åŠ¨ Flutter ç¨‹åº</h3><p>å‚è§ <a href="https://link.zhihu.com/?target=https%3A//github.com/flutter/flutter/issues/49504%23issuecomment-581554697" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/flutter/flut</span><span class="invisible">ter/issues/49504#issuecomment-581554697</span><span class="ellipsis"></span></a> ä¸è¦å‡çº§åˆ° IOS 13.3.1 ç³»ç»Ÿ</p><h2>What&#39;s next</h2><ul><li> å¦‚ä½•é«˜æ•ˆçš„å®ç° Rust &amp; Dart éƒ¨åˆ†çš„é€šä¿¡<br/> æˆ‘ä»¬çŸ¥é“ Flutter å’Œå¹¿å¤§ GUI åº“ç±»ä¼¼ï¼Œå±äºå•çº¿ç¨‹æ¨¡å‹ç»“åˆäº‹ä»¶ç³»ç»Ÿï¼Œå› æ­¤åœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨ FFI è°ƒç”¨ Rust éƒ¨åˆ†çš„ä»£ç ä¸èƒ½é˜»å¡çº¿ç¨‹ã€‚Dart è¯­è¨€æä¾› async/await è¯­æ³•ç‰¹æ€§ç”¨äºåœ¨ Flutter ä¸­å¤„ç†ç½‘ç»œè¯·æ±‚ç­‰é˜»å¡ä»»åŠ¡ã€‚è€Œ Rust ä¹Ÿåœ¨æœ€è¿‘ç‰ˆæœ¬ä¸­æä¾›äº† async/await è¯­æ³•æ”¯æŒï¼Œå¦‚ä½•ä¼˜é›…çš„æŠŠä¸¤éƒ¨åˆ†ç»“åˆèµ·æ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚<br/> </li><li> å¯¹ MacOS Windows Linux æ¡Œé¢ç«¯çš„æ”¯æŒ<br/> Flutter å·²ç»æœ‰äº†å¯¹æ¡Œé¢ç«¯çš„å®éªŒæ€§æ”¯æŒï¼Œå¯ä»¥ç ”ç©¶ä¸‹å¦‚ä½•ç»“åˆåœ¨ä¸€èµ·ï¼Œå®ç°è·¨ 6 ä¸ªç«¯å…±äº«ä»£ç ã€‚<br/> </li></ul><h2>References</h2><ul><li><a href="https://link.zhihu.com/?target=https%3A//github.com/kennytm/rust-ios-android" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/kennytm/rust</span><span class="invisible">-ios-android</span><span class="ellipsis"></span></a></li></ul><p>ä»‹ç»äº†å¦‚ä½•æ„å»ºå‡º Android, IOS åº“ï¼Œå¹¶æä¾›äº†ä¾‹å­ - <a href="https://link.zhihu.com/?target=https%3A//github.com/TimNN/cargo-lipo" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/TimNN/cargo-</span><span class="invisible">lipo</span><span class="ellipsis"></span></a></p><p>ç”¨äºæ„å»º universal library - <a href="https://link.zhihu.com/?target=https%3A//github.com/hanabi1224/flutter_native_extensions" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/hanabi1224/f</span><span class="invisible">lutter_native_extensions</span><span class="ellipsis"></span></a></p>