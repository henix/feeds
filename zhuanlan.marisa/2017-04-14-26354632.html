<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MPS教程四：制作一个简易语言（下）</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/26354632">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-d028bc21878c4875cef15a1a71320d2c_r.png" alt=""></div><p>在上一篇教程中，我们已经体验了MPS创建语言的所必须拥有的完整流程。 我们也注意到了生成的语言语法很丑。</p><p>接下来，我们将编写自己的Editor，把语法变得好看起来。</p><p>这篇文章结束之后，我这个MPS系列就暂时告一段落了，下一波教程可能很快出来，也有可能要过很久。不过我是不会跳票的！</p><p>最早我在写这个系列的时候，就是抱着“反正肯定没人看，不过我就是要写”的任性态度写的，结果万万没想到，有好几个人都过来跟我说“在读你的MPS系列”，让我内心小鹿乱撞，真是太惊喜了！所以说我按理说还是会坚持下去的！</p><p>为了获得更好的观看体验以及去除马赛克，可以转移到我的博客<a href="http://ice1000.org/2017/04/12/MakeSimpleLangWithMPS/" data-editable="true" data-title="MPS教程四：制作一个简易语言（下）">MPS教程四：制作一个简易语言（下）</a>去看。</p><h2>准备工作</h2><ul><li>阅读<a href="http://ice1000.org/2017/04/06/MakeSimpleLangWithMPS/" data-editable="true" data-title="上上篇博客">上上篇博客</a>并完成对应的工作</li><li>阅读<a href="http://ice1000.org/2017/04/07/MakeSimpleLangWithMPS/" data-editable="true" data-title="上一篇博客">上一篇博客</a>并完成对应的任务</li><li>英文输入法（就是<strong>Ctrl+Space</strong>没有被占用的输入法）</li></ul><h2>本文主要内容</h2><ul><li>MPS的Editor</li><li>加深对MPS原理的理解</li></ul><h3>有哪些新概念</h3><ul><li>没有新引入的概念</li></ul><h2>回顾一些概念</h2><h3>MPS</h3><p>MPS是一个DSL开发环境，采用LOP的理念，将模块化的组件作为一个个的DSL。MPS的“语言”对应OOP的“对象”、PP的“过程”。</p><p>MPS将程序保存为AST，在文件系统中序列化为xml保存，在编辑器中渲染为“代码”。</p><p>你看到的，是MPS根据AST渲染出来的类似代码的东西，但是它实际上不是代码。</p><h3>Concept</h3><p>Concept可以当成是Java里面的class，它可以有interface concept（对应Java的interface）， 可以有abstract concept（对应Java的abstract class）。</p><p>Concept的实例就是AST的节点，对应class的实例是对象。读者可以把AST节点理解为“Concept这种类似class的东西的实例”。</p><h3>Generator</h3><p>Generator遍历AST节点，导出另一份代码。</p><h3>我们写过的东西</h3><p>Concept:</p><ul><li>Println，有一个叫content的property，类型是string</li><li>PrintlnSet，有很多Println的children</li></ul><p>Generator:</p><ul><li>给PrintlnSet提供的简单Generator</li></ul><h2>开始吧</h2><p>打开你的MPS，进入上次创建的工程。</p><h3>关于Editor</h3><p>Editor是<strong>你的DSL的语法</strong>。</p><p>一般情况下，每个Concept都有一个对应的Editor。每个Editor有它适用的Concept。</p><p>Editor有两种创建方式，一种是直接创建，一种是针对一个Concept创建。</p><p>在你的DSL中，每个AST节点（每个Println是一个AST节点，每个PrintlnSet也是AST节点）都需要一个对应的Editor， 然后MPS根据这个Editor来渲染出你看到的“代码”。</p><p>Concept有接口Concept来实现组件化，所以Editor也可以组件化——你可以做一个子Editor，让它“可被应用于”一个Abstract/Interface Concept，</p><p>然后你就可以在这个Concept的实现中“引用”这个Editor。</p><h3>默认Editor</h3><p>如果不为一个Concept指定Editor，那么MPS会创建一个默认的Editor，这个Editor长啥样读者在上期已经看到了。</p><p>我们在本期会为我们的Concept定制Editor。</p><h3>创建Editor</h3><p>我们就直接针对Concept创建了。</p><p>然后进入我们在第一篇教程中创建的“Concept”，选择Println这个Concept，打开并创建它对应的Editor。<img src="https://pic4.zhimg.com/v2-8d0655386985c1ef2c305e9ee762a56b_r.png" data-rawwidth="1110" data-rawheight="915"></p><p>（注意，在空白处右键就可以看到截图里的pop-up了）</p><p>然后你就可以看到你的第一个Editor啦！</p><h3>最简Editor<img src="https://pic1.zhimg.com/v2-282bba822a464a17456fd85b728981cf_r.png" data-rawwidth="480" data-rawheight="231"></h3><p>我们可以直接创建一个最最简单的Editor，先在那一片姨妈红中<strong>Ctrl+Space</strong>，选择</p><br><code lang="text">{content}
</code><p>那个：<img src="https://pic3.zhimg.com/v2-928eaca20bee750613340a9215ddcfbe_r.png" data-rawwidth="925" data-rawheight="113"></p><p>这表示，在这个位置渲染Println这个Concept的content属性。还记得吗？Println这个Concept的定义。</p><p>然后我们编译一下，回到我们之前在Sandbox里面写的PrintlnSet：<img src="https://pic1.zhimg.com/v2-9169be80bb533b9c98bc5f5ff85659be_r.png" data-rawwidth="641" data-rawheight="219"></p><p>看到了木有！我们自己定义的Editor替换掉了原来的默认Editor。</p><p>我们没有动自己的代码，而是改变了Editor，然后代码的样子就改变了。</p><p><strong>也就是说，代码写成啥样不重要，只要逻辑（AST）不变，你可以随便改变语法，显示出来的代码就会随之改变。</strong></p><p>注意体会一下我之前很早就说过的“MPS显示的其实是渲染的AST”。再次提醒自己，你在屏幕上看到的不是文本。</p><h3>是不是有点懵</h3><p>没错我似乎没怎么解释Editor工作的机制。</p><p>MPS会遍历这个AST的每个节点，针对每个节点，寻找它的Editor，然后根据Editor绘制这个节点。</p><p>在这个例子中，我们的Editor就只有一个 {content} <strong>元素</strong>，因此MPS也就直接把这些节点的content属性渲染出来了。</p><p>我们需要一个更加人性化的Editor，起码得有个提示语吧？比如：</p><br><code lang="text">text: {content}
</code><p>类似这样的如何？</p><h3>MPS的Editor</h3><p>MPS的Editor默认只有一个用来放元素的位置，叫做Editor的根元素。一般情况下，这个根元素会放一个<strong>集合</strong>， 在<strong>集合</strong>里面再挨个添加我们需要的元素，而不是像我们刚才那样直接把一个 {content} 放进去。</p><h3>稍微好看点的Editor</h3><p>我们需要一个Editor元素的<strong>集合</strong>。</p><p>于是我们在那一片姨妈红中<strong>Ctrl+Space</strong>，然后输入一个减号，选择<strong>collection (indent)</strong>：<img src="https://pic4.zhimg.com/v2-ce86e5758d21409f127fa85b015b3188_r.png" data-rawwidth="491" data-rawheight="212"></p><p>然后我们就有了一个用来放元素的集合了。</p><p>我们可以在集合中间输入一个提示语。<img src="https://pic3.zhimg.com/v2-1a26e3e83a9011fd99172d41ee4ad105_r.png" data-rawwidth="466" data-rawheight="178"></p><p>输入完然后回车，这样MPS会创建一个新元素，并进入之：<img src="https://pic4.zhimg.com/v2-8515c836307f5d8eba6ee4c7f830c3d1_r.png" data-rawwidth="496" data-rawheight="178"></p><p>然后我们在这个元素中再放入 {content} （注意不能直接输入 {content} ，必须使用<strong>Ctrl+Space</strong>后代码补全里面给出的 {content}）。 最终的样子应该是这样：<img src="https://pic3.zhimg.com/v2-82dd5325d391d16a446187745a745372_r.png" data-rawwidth="474" data-rawheight="209"></p><p>然后编译一下，回去看我们的Sandbox里的PrintlnSet。</p><p>可以看到，效果已经出来了：</p><img src="https://pic4.zhimg.com/v2-00582df7797e75f028a8a848ce6fe70d_r.png" data-rawwidth="521" data-rawheight="237"><h3>稍微复杂点的Editor</h3><p>我们还需要为PrintlnSet创建一个Editor。考虑如下因素：</p><ul><li>PrintlnSet有很多个Println，这个数目是不定的</li><li>我们需要一个提示语</li><li>元素竖着排列</li></ul><p>（想了半天发现好像就这几个因素）</p><p>然后我们可以考虑直接使用MPS提供的默认方法来创建这个Editor，就是这个：<img src="https://pic3.zhimg.com/v2-bbd2646f6b0bf2df2f70451f6943c942_r.png" data-rawwidth="995" data-rawheight="190"></p><p>然后它会自己出来一堆东西，我们不管它，先编译看效果：<img src="https://pic2.zhimg.com/v2-17d8651d9f4beefd91e214a5cd8e0902_r.png" data-rawwidth="976" data-rawheight="144"></p><p>它直接把所有的Println全部塞一行了！这样是不行的！我们需要一个竖着的！</p><h4>关于 ChildNodeList</h4><p><strong>child node list</strong>是MPS提供来放置“数量不定的AST子节点”的Editor元素，它有横着的，也有竖着的。</p><p>所以我们来，先弄个提示语，然后选择<strong>child node list(vertical)</strong>，这个就是竖着的ChildNodeList。<img src="https://pic1.zhimg.com/v2-095979c4fb133465e63ecbc40f92f119_r.png" data-rawwidth="928" data-rawheight="221"></p><p>然后我们看到它出现了一堆元素。不要慌，我们挨个填。</p><p>首先，在 &lt;no link&gt; 这个地方填入你要link到的AST子节点——在这里，就是我们的 clauses 。<img src="https://pic1.zhimg.com/v2-21e9238defdef0bf13df6cded54d077a_r.png" data-rawwidth="821" data-rawheight="211"></p><p>然后编译一下。</p><h3>最后的样子</h3><p>回到Sandbox里面，我们可以看到这个东西的语法又变了，变成了我们想要的样子：</p><br><code lang="text">set: text: ***马赛克***马赛克***马赛克***!!!!
     text: My name is Van, I'm an artist.
     text: I'm a performance artist.
</code><h3>其他Editor功能</h3><p>比如我们想把那些text换到下一行去，可以在 (\ 上使用<strong>Alt+Enter</strong>，然后选择“Add On New Line”：<img src="https://pic4.zhimg.com/v2-2730e5f05afe61c5454a883b40db2c81_r.png" data-rawwidth="567" data-rawheight="254"></p><p>贴图真的很累，我就不截操作之后的效果图了，反正这样处理之后代码是这样的：</p><br><code lang="text">set: 
text: ***马赛克***马赛克***马赛克***!!!!
text: My name is Van, I'm an artist.
text: I'm a performance artist.
</code><p>其实Editor还有更多功能，远不止这点。</p><h2>本文没有讲到的点</h2><p>真的是篇幅所限！我其实很想把这些都说完的。</p><ul><li>类似括号配对的效果，可以对你指定的两种（任意！不一定是括号！可以是begin end这种）Editor元素进行高亮配对</li><li>改变前景/背景颜色（可以参考我<a href="http://ice1000.org/2017/03/18/TryShapeWithMPS/" data-editable="true" data-title="之前的那个ShapeLang">之前的那个ShapeLang</a>里面的效果）</li><li>根据AST节点属性的情况，按需显示Editor元素</li><li>显示表格</li><li>奇怪的对齐方式</li><li>显示图片</li><li>显示Swing控件</li></ul><p>还有很多别的，我现在脑子有点乱，就不一一列举了。</p><h2>还能这么玩</h2><p>我稍微改了下这个Editor的样子，最终渲染出来的代码是这样的，可以作为作业，读者可以试着自己弄一个出来：<img src="https://pic4.zhimg.com/v2-0a310e3e1cf3bd990811eb8138c4e2ca_r.png" data-rawwidth="738" data-rawheight="214"></p><p>看到了吗？模仿Java。我们还可以再改改：<img src="https://pic4.zhimg.com/v2-f38d737cab37a2fef3054aa7ff6253ef_r.png" data-rawwidth="646" data-rawheight="200"></p><p>看到了吗？模仿C#。</p><p><strong>而进行这样的语法改动，只需要动Editor，完全不需要动代码。</strong></p><h2>结束</h2><p>那么MPS的最最简单的入门教程就这么结束啦~</p><p>我也得睡觉了，休息可是很重要的呢DAZE~</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
