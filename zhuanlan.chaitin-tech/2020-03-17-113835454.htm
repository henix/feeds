<div class="title-image"><img src="https://pic2.zhimg.com/v2-b244bcaa368cdb44630b75444ac4bb04_b.jpg" alt=""></div><p>互联网服务的全球性决定了其每天 24 小时都会有用户访问，因此任何服务的停止都会对用户造成影响。以云服务提供商为例，全球最大的保险公司之一Lloyd’s of London 2017年发布的报告称，云服务一旦遭到黑客攻击导致不可用，发生影响互联网用户正常使用的大型经济损失事件，可能会造成46亿美元的损失，若是极端事件，损失将高达531亿美元。对于高度依赖网络运营的应用，暂时中止服务意味着部分客户的永久失去及大量的经济损失，更不用提其中包含的品牌及口碑的破坏性影响。</p><p> 这一点已引起多个行业重视，金融行业在2020年2月5日，由中国人民银行正式发布新修订的金融行业标准《网上银行系统信息安全通用规范》（JR/T 0068-2020），对备份和恢复管理提出了更明确的规定，要求金融机构应根据网上银行系统的业务影响性分析结果，制定不同数据的备份策略，并实施应用级备份，同时要求对于同城数据备份中心，应保证可以接管所有核心业务的运行。</p><p>而在互联网行业，业务规模不断扩大，用户群日益增长，以及高并发，高流量，数据量大，逻辑复杂等新特点的产生，对网站业务架构建设和容灾建设也提出了新的要求。简单来说，流量越大越需要提前做好灾备，越需要网络架构能够更好地支撑业务连续性。</p><p><i><b>同城多活</b>是一个帮助大流量网站实现高可用的理想灾备方案。简单来说，“同城多活” 就是一个城市内的多个机房，同时承载业务流量，可以根据用户ID、地域或者其他业务属性决定怎么分担流量，当一个机房故障时，可以快速（分钟级）切换到其他机房，理想情况下，对业务基本是无损或者非常小的。</i></p><p>互联网大流量企业在容灾建设中对业务连续性的极高需求，对网络安全边界产品的性能提出了挑战：下一代网络安全产品需要具有更高的配置维护效率，进而实现高可用。</p><p>本文将以案例说明，雷池（SafeLine）下一代Web应用防火墙在“同城多活”实践中是如何更好地优化配置维护和提高可用性的，以及如何在大流量场景下消除企业客户的顾虑，协助做好容灾建设。</p><p><b>案例背景：</b>某超大流量视频网站“同城多活”容灾建设</p><p><b>安全需求：</b>该大流量视频网站出于灾备需求，需要建设同城双机房，进行业务负载，满足高可用。平时各自承担一定比例的流量，当一个机房出现问题，在一分钟之内，将流量自动负载到另外一个机房上。 作为 Web 网关，网站所有的 Web 访问请求都会先经过 WAF ， 因此，客户对 WAF 的分钟级切换也提出了同样的要求，需要单套WAF 通过集群化的方式跨机房部署，满足灾害发生时的“分钟级”切换和统一管理，保证网站安全的高可用。 </p><p><b>防护难点：</b></p><ol><li> 如果WAF架构不合理或水平扩展能力不足，无法快速切换，易造成站点延迟甚至业务中断；</li><li> 若分多套WAF防护，配置维护效率往往较低，无法快速统计用户在多机房中的访问总次数，不能有效拦截高频访问；</li><li>单套 WAF 虽然可以实现有效的访问控制，但是如使用单套WAF来管理防护多个机房，对架构挑战比较大，通常需要调优很长时间。</li></ol><p><b>雷池（SafeLine）部署方式：</b></p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-429959a789f73db736738174c4c4f0c1_b.jpg" data-caption="" data-size="normal" data-rawwidth="1175" data-rawheight="419" class="origin_image zh-lightbox-thumb" width="1175" data-original="https://pic2.zhimg.com/v2-429959a789f73db736738174c4c4f0c1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-429959a789f73db736738174c4c4f0c1_b.jpg" data-caption="" data-size="normal" data-rawwidth="1175" data-rawheight="419" class="origin_image zh-lightbox-thumb lazy" width="1175" data-original="https://pic2.zhimg.com/v2-429959a789f73db736738174c4c4f0c1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-429959a789f73db736738174c4c4f0c1_b.jpg"/></figure><p>雷池（SafeLine）通过跨机房的嵌入式集群反向代理部署方式，使得两个机房的检测节点共同组成一个大集群，而管理节点则以一主一从的方式分别部署在两个机房。当灾害发生时，若主机房出现故障，则从机房升级为主；若从机房出现故障，主机房仍然可以正常工作；若两个机房间连接出现故障，则两边各为主，分别处理各自的流量，保证业务连续性。</p><p><b>防护效果：</b></p><ol><li> 采用嵌入式集群的方式能够灵活水平扩展，单机处理性能更高，满足大流量下的网站防护。</li><li> 雷池（SafeLine）因更智能的架构，单套WAF通过少量调优即可快速上线管理双机房，节约大量的人力成本和时间成本；</li><li> 部署在不同机房的WAF检测节点可统一管理配置，维护效率高；</li><li> 访问频率、雷池特色的插件均可跨机房全局统计次数，时延可控，从而更加准确的进行高频访问的拦截；</li><li> 一旦发生故障，可随业务系统一同快速切换流量，无需人工操作，实现跨机房的高可用。</li></ol><p>雷池（SafeLine）的集群化部署模式，具有稳定性强、易扩展的特点，理论上能支持无上限的并发处理量，能够在高度适配大流量网站和复杂网络环境下防护需求的同时，提高WAF 在“同城多活”容灾建设中的配置维护效率，大幅提高可用性。 </p><p>雷池（SafeLine）的嵌入式集群模式将拦截集群部署至现有的应用负载集群，完美耦合客户系统，可以在不改变现有网络拓扑的情况下完成流量检测工作，从而有效防范因水平扩展能力不足而导致的业务中断，保障业务有序进行。</p><p>更值得一提的是，雷池（SafeLine）的嵌入式集群部署模式可以完美支持各种复杂网络架构下的 cross region 部署，能够根据客户系统复杂的业务需求和架构变化，灵活配置跨机房、跨区域甚至跨地区的检测节点，并通过统一的管理节点进行配置维护和全局统计，实现极低成本的快速上线，从而更加准确地进行高频访问拦截。</p><p>近年来，面临越来越多新的安全威胁和场景化的业务安全诉求，各行业愈发重视 WAF 应对场景化安全风险的“智能安全“能力。业务场景千千万，真正的高性能智能 WAF ，必须具备在不对业务系统进行频繁改动的前提下，以极低的成本和极高的调优效率，解决实际场景化的业务安全问题，方能更好的适配数据量大、逻辑复杂的网络环境趋势，真正实现 WAF 防护的高可用。</p>