<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>银行交易系统 TiDB 在线缩容迁移</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/65878590">原文</a></p>
<div class="title-image"><img src="https://pic3.zhimg.com/v2-e5610024df07e75583d513f6a7d6d59d_b.jpg" alt=""></div><p>作者：Dan</p><p>本文转载自公众号「白噪声OG」。</p><p>经历了上礼拜漫长的上线周期，终于有时间总结一下期间发生的故事。TiDB 是一款非常优秀的国产分布式 NewSQL 数据库，因其支持水平扩展性、强一致性、高可用性，从 18 年 3 月起已在国内银行的账务、支付类核心系统得到应用。</p><p>临近年中，银行重要系统的建设进入投产冲刺阶段，本次上线又有多个系统对接 TiDB，为了优化集群资源分配，引发了这次分享的主题——<b>线上系统 TiKV 的缩容、region 的迁移</b>，本文主要针对本次 TiKV 的缩容、迁移过程进行梳理总结。</p><p><b>TiDB 数据库的扩容已在官方文档进行了详细的说明</b>（<a href="https://link.zhihu.com/?target=https%3A//pingcap.com/docs-cn/op-guide/horizontal-scale/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">pingcap.com/docs-cn/op-</span><span class="invisible">guide/horizontal-scale/</span><span class="ellipsis"></span></a>）<b>并被各路大咖广泛提及，但缩容迁移并在银行交易系统上的实践却少有分享，这也是本文的目的之一。</b></p><p>进入主题，先交代下环境，服务器集群采用 NVMe+SSD 的存储方案构建了 16 个 TiKV 实例，作为重要的核心支付类系统，两地三中心五副本不可少，每个 TiKV 上 8K+ 个 region。<b>整个迁移过程历时 5 个小时，过程中没有停止系统对外服务，很是顺滑平稳。</b></p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-076f34fdabe840a09b7ac9765cae57e6_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="529" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-076f34fdabe840a09b7ac9765cae57e6_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-076f34fdabe840a09b7ac9765cae57e6_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="529" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-076f34fdabe840a09b7ac9765cae57e6_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-076f34fdabe840a09b7ac9765cae57e6_b.jpg"/></figure><p><b>接下来还是看一下迁移的过程：</b></p><p><b>（一）</b>TiKV 采用 Raft 一致性算法保证副本强一致性，迁移过程本质上是扩容的逆过程，确定下线的 TiKV 打上 label 后，将 region 搬移到最终保留下来的 TiKV 上。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-463994044be8e73c8161a5eb9e6d57a8_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="676" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-463994044be8e73c8161a5eb9e6d57a8_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-463994044be8e73c8161a5eb9e6d57a8_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="676" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-463994044be8e73c8161a5eb9e6d57a8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-463994044be8e73c8161a5eb9e6d57a8_b.jpg"/></figure><p><b>（二）</b>接下来聚焦 region 1 的 Raft Group，对其副本进行搬移，实际上所有 region 的数据是一样的，只是在保留的 TiKV 内进行 region 数据的复制，新产生的副本由于数据不完整，作为 Raft Group 中的 learner。</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-a85bc5542754c7f96751820cc9a59018_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="373" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-a85bc5542754c7f96751820cc9a59018_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-a85bc5542754c7f96751820cc9a59018_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="373" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-a85bc5542754c7f96751820cc9a59018_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-a85bc5542754c7f96751820cc9a59018_b.jpg"/></figure><p><b>（三）</b>Learner 创建后，PD 会在这样的一个 Raft Group（5 个全副本 region + 2 个 learner）中发起选举：</p><ul><li>选举会增加 label 限制，确保 leader 最终在保留的 TiKV 中产生；</li><li>由于 learner 没有投票权，选举实际还是个 5 副本选主，多数派 (N+1)/2 仍为 3。</li></ul><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-8434cd530afeadd794ff536310abad65_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="474" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic2.zhimg.com/v2-8434cd530afeadd794ff536310abad65_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-8434cd530afeadd794ff536310abad65_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="474" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic2.zhimg.com/v2-8434cd530afeadd794ff536310abad65_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-8434cd530afeadd794ff536310abad65_b.jpg"/></figure><p><b>（四）</b>这样新的 leader 选出来了，当两个新副本数据追平后，将删除下线 TiKV 中的 region。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-e551cc40b3c2dec6e6be3002913b8a29_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="747" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic2.zhimg.com/v2-e551cc40b3c2dec6e6be3002913b8a29_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-e551cc40b3c2dec6e6be3002913b8a29_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="747" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic2.zhimg.com/v2-e551cc40b3c2dec6e6be3002913b8a29_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-e551cc40b3c2dec6e6be3002913b8a29_b.jpg"/></figure><p><b>（五）</b>这样一个新的 5 副本 Raft Group 我们就获得了。</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-c0194bd790246f323b7a3062f450a8da_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="406" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-c0194bd790246f323b7a3062f450a8da_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-c0194bd790246f323b7a3062f450a8da_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="406" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-c0194bd790246f323b7a3062f450a8da_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-c0194bd790246f323b7a3062f450a8da_b.jpg"/></figure><p>这里再说几点：</p><p>1. 磁盘 IO 对迁移的效率影响还是很大的，测试环境使用普通的 SAS 盘，在更高并发的条件下，耗时长了很多。</p><p>2.（二）、（三）、（四）的过程并非原子化操作，当然 learner 的数据本身也不具备一致性，但对 raft 的改造最终要保证一致性，与 PingCAP 的开发同学确认后，这些会在之后加入。</p><p><b>3. 我认为最有意思，也最有意义的一点，learner 的引入是本次迁移过程中非常巧妙的设计，解决了数据不一致副本在选举过程中的尴尬地位，而 learner 也是 Multi-Raft 协议中的重要角色，HTAP 引擎 TiFlash&amp;TiSpark 也以此引入列存副本，非常期待</b> <b>TiDB 3.0。</b></p><p>PS：本次上线的重头戏 Cloud TiDB 在平稳运行后，希望有机会进行总结分享。TiDB 自上线后实现了多次重要变更操作，均未暂停系统对外服务，从一只开发狗的角度看 TiDB 在金融级 NewSQL 数据库的方向上的确投入了很多。</p><p>最后，感谢 PingCAP Gin 同学和研发大神们的支持，感谢运维爸爸们直到凌晨 4 点的奋斗。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
