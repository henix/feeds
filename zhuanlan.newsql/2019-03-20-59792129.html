<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>DM 源码阅读系列文章（一）序</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/59792129">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-19b0ac961a95a5d2fd5b13c09b731ef9_b.jpg" alt=""></div><blockquote><u><b><a href="http://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/tidb-ecosystem-tools-3/" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiDB-DM</a></b></u> (<a href="http://link.zhihu.com/?target=http%3A//github.com/pingcap/dm" class=" wrap external" target="_blank" rel="nofollow noreferrer">github.com/pingcap/dm</a>) 是由 PingCAP 开发的一体化数据同步任务管理平台，支持从 MySQL 或 MariaDB 到 TiDB 的全量数据迁移和增量数据同步，<u><a href="http://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzI3NDIxNTQyOQ%3D%3D%26mid%3D2247487797%26idx%3D1%26sn%3Dd6de39f3d0172418c682eeb7779ea5e8%26chksm%3Deb16365fdc61bf497ee794f8b99780c2ec946bd7e1ed13bd47871bfae1355d7c76b190ee7c5a%26scene%3D21%23wechat_redirect" class=" wrap external" target="_blank" rel="nofollow noreferrer">在 TiDB DevCon 2019 上正式开源</a></u>。作为一款连接 MySQL/MariaDB 生态和 TiDB 生态的中台类型产品，DM 获得了广泛的关注，很多公司、开发者和社区的伙伴已经在使用 DM 来进行数据迁移和管理。随着大家使用的广泛和深入，遇到了不少由于对 DM 原理不理解而错误使用的情况，也发现了一些 DM 支持并不完善的场景和很多可以改进的地方。<br><br>在这样的背景下，我们希望开展 DM 源码阅读分享活动，通过对 DM 代码的分析和设计原理的解读，帮助大家理解 DM 的实现原理，和大家进行更深入的交流，也有助于我们和社区共同进行 DM 的设计、开发和测试。</blockquote><h2><b>背景知识</b></h2><p>本系列文章会聚焦 DM 自身，读者需要有一些基本的知识，包括但不限于：</p><ul><li>Go 语言，DM 由 Go 语言实现，有一定的 Go 语言基础有助于快速理解代码。</li><li>数据库基础知识，包括 MySQL、TiDB 的功能、配置和使用等；知道基本的 DDL、DML 语句和事务的基本常识；MySQL 数据备份、主从同步的原理等。</li><li>基本的后端服务知识，比如后台服务进程管理、RPC 工作原理等。</li></ul><p>总体而言，读者需要有一定 MySQL/TiDB 的使用经验，了解 MySQL 数据备份和主从同步的原理，以及可以读懂 Go 语言程序。在阅读 DM 源码之前，可以先从阅读《<u><a href="http://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/tidb-ecosystem-tools-3/" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiDB-DM 架构设计与实现原理</a></u>》入手，并且参考 <a href="http://link.zhihu.com/?target=https%3A//pingcap.com/docs-cn/tools/dm/overview/" class=" wrap external" target="_blank" rel="nofollow noreferrer">使用文档</a> 在本地搭建一个 DM 的测试环境，从基础原理和使用对 DM 有一个初步的认识，然后再进一步分析源码，深入理解代码的设计和实现。</p><h2><b>内容概要</b></h2><p>源码阅读系列将会从两条线进行展开，一条是围绕 DM 的系统架构和重要模块进行分析，另一条线围绕 DM 内部的同步机制展开分析。源码阅读不仅是对代码实现的分析，更重要的是深入的分析背后的设计思想，源码阅读和原理分析的覆盖范围包括但不限于以下列出的内容（因为目前 DM 仍处于快速迭代的阶段，会有新的功能和模块产生，部分模块在未来也会进行优化和重构，后续源码阅读的内容会随着 DM 的功能演进做适当的调整）：</p><ul><li>整体架构介绍，包括 DM 有哪些模块，分别实现什么功能，模块之间交互的数据模型和 RPC 实现。</li><li>DM-worker 内部组件设计原理（relay-unit, dump-unit, load-unit, sync-unit）和数据同步的并发模型设计与实现。</li><li>基于 binlog 的数据同步模型设计和实现。</li><li>relay log 的原理和实现。</li><li>定制化数据同步功能的实现原理（包括库表路由，库表黑白名单，binlog event 过滤，列值转换）。</li><li>DM 如何支持上游 online DDL 工具（<a href="http://link.zhihu.com/?target=https%3A//www.percona.com/doc/percona-toolkit/LATEST/pt-online-schema-change.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">pt-osc</a>, <a href="http://link.zhihu.com/?target=https%3A//github.com/github/gh-ost" class=" wrap external" target="_blank" rel="nofollow noreferrer">gh-ost</a>）的 DDL 同步场景。</li><li>sharding DDL 处理的具体实现。</li><li>checkpoint 的设计原理和实现，深入介绍 DM 如何在各类异常情况下保证上下游数据同步的一致性。</li><li>DM 测试的架构和实现。</li></ul><h2>代码简介</h2><p>DM 源代码完全托管在 GitHub 上，从 <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm" class=" wrap external" target="_blank" rel="nofollow noreferrer">项目主页</a> 可以看到所有信息，整个项目使用 Go 语言开发，按照功能划分了很多 package，下表列出了 DM 每个 package 的基本功能：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-e921467b1a4f09cf3c27288315b2d549_b.jpg" data-caption="" data-size="normal" data-rawwidth="1424" data-rawheight="1150" class="origin_image zh-lightbox-thumb" width="1424" data-original="https://pic2.zhimg.com/v2-e921467b1a4f09cf3c27288315b2d549_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-e921467b1a4f09cf3c27288315b2d549_b.jpg" data-caption="" data-size="normal" data-rawwidth="1424" data-rawheight="1150" class="origin_image zh-lightbox-thumb lazy" width="1424" data-original="https://pic2.zhimg.com/v2-e921467b1a4f09cf3c27288315b2d549_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-e921467b1a4f09cf3c27288315b2d549_b.jpg"></figure><p>对于理解代码最直接的手段就是从 DM-server, DM-worker 和 dmctl 三个 binary 对应的 main 文件入手，看 DM-worker, DM-master 是如何启动，DM-worker 如何管理一个上游实例和同步任务；如何从 dmctl 开始同步子任务；然后看一个同步子任务从全量状态，到增量同步状态，binlog 如何处理、sql 任务如何分发等。通过这样一个流程对 DM 的整体架构就会有全面的理解。进一步就可以针对每个使用细节去了解 DM 背后的设计逻辑和代码实现，可以从具体每个 package 入手，也可以从感兴趣的功能入手。</p><p>实际上 DM 代码中使用了很多优秀的第三方开源代码，包括但不仅限于：</p><ul><li>借助 <a href="http://link.zhihu.com/?target=https%3A//github.com/grpc/grpc-go" class=" wrap external" target="_blank" rel="nofollow noreferrer">grpc</a> 实现各组件之间的 RPC 通信</li><li>借助 <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/parser" class=" wrap external" target="_blank" rel="nofollow noreferrer">pingcap/parser</a> 进行 DDL 的语法解析和语句还原</li><li>借助 <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/tidb-tools" class=" wrap external" target="_blank" rel="nofollow noreferrer">pingcap/tidb-tools</a> 提供的工具实现复杂的数据同步定制</li><li>借助 <a href="http://link.zhihu.com/?target=https%3A//github.com/siddontang/go-mysql" class=" wrap external" target="_blank" rel="nofollow noreferrer">go-mysql</a> 解析 MySQL/MariaDB binlog 等</li></ul><p>在源码阅读过程中对于比较重要的、与实现原理有很高相关度的第三方模块，我们会进行相应的扩展阅读。</p><h2><b>工具链</b></h2><p>工欲善其事，必先利其器，在阅读 DM 源码之前，我们先来介绍 DM 项目使用到的一些外部工具，这些工具通常用于 DM 的构建、部署、运行和测试，在逐步使用 DM，阅读代码、理解原理的过程中都会使用到这些工具。</p><ul><li>golang 工具链：构建 DM 需要 go &gt;= 1.11.4，目前支持 Linux 和 MacOS 环境。</li><li><a href="http://link.zhihu.com/?target=https%3A//github.com/gogo/protobuf/" class=" wrap external" target="_blank" rel="nofollow noreferrer">gogoprotobuf</a>：用于从 proto 描述文件生成 protobuf 代码，DM 代码仓库的 <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/master/generate-dm.sh" class=" wrap external" target="_blank" rel="nofollow noreferrer">generate-dm.sh</a> 文件封装了自动生成 DM 内部 protobuf 代码的脚本。</li><li><a href="http://link.zhihu.com/?target=https%3A//docs.ansible.com/" class=" wrap external" target="_blank" rel="nofollow noreferrer">Ansible</a>：DM 封装了 <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/tree/master/dm/dm-ansible" class=" wrap external" target="_blank" rel="nofollow noreferrer">DM-Ansible</a> 脚本用于 DM 集群的自动化部署，部署流程可以参考 <a href="http://link.zhihu.com/?target=https%3A//pingcap.com/docs/tools/dm/deployment/" class=" wrap external" target="_blank" rel="nofollow noreferrer">使用 ansible 部署 DM</a>。</li><li><a href="http://link.zhihu.com/?target=https%3A//www.percona.com/doc/percona-toolkit/LATEST/pt-online-schema-change.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">pt-osc</a>, <a href="http://link.zhihu.com/?target=https%3A//github.com/github/gh-ost" class=" wrap external" target="_blank" rel="nofollow noreferrer">gh-ost</a>：用于上游 MySQL 进行 online-ddl 的同步场景。</li><li><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/mydumper" class=" wrap external" target="_blank" rel="nofollow noreferrer">mydumper</a>：DM 的全量数据 dump 阶段直接使用 mydumper 的 binary。</li><li>MySQL, TiDB, sync_diff_inspector：这些主要用于单元测试和集成测试，可以参考 <a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/tree/master/tests%23preparations" class=" wrap external" target="_blank" rel="nofollow noreferrer">tests#preparations</a> 这部分描述。</li></ul><h2><b>小结</b></h2><p>本篇文章主要介绍了 DM 源码阅读的目的和源码阅读的规划，简单介绍了 DM 的源码结构和工具链。下一篇文章我们会从 DM 的整体架构入手，详细分析 DM-master、DM-worker 和 dmctl 三个组件服务逻辑的实现和功能抽象，RPC 数据模型和交互接口。更多的代码阅读内容会在后面的章节中逐步展开，敬请期待。</p><p><b>更多技术文章：</b></p><a href="http://link.zhihu.com/?target=https%3A//pingcap.com/blog-cn/" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg" data-image-width="1200" data-image-height="1200" class=" wrap external" target="_blank" rel="nofollow noreferrer">博客</a><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
</body>
</html>
