<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>刨根问底 - 如何将 PCM 音频编码成 MP4？</title>
</head>
<body>
<p><a href="https://mp.weixin.qq.com/s?timestamp=1564192829&amp;src=3&amp;ver=1&amp;signature=QMzVg6CBC9VFvJ94h5p3X-oKotWPuYgD3Ymht*7SMsRmr4GQNq1-EFDMuJpiy-D24aO0GxOX2etyE1LtqYaPOqRxwqL0nqYGQHpzgBhmat-gmvOPLYo1R*pB2ffzH-wnCK-cOOmsDh2e86sOZoniZppwxD-bawMITV0PEkbFIWI=">原文</a></p>
<div id="img-content">
                
                <h2 class="rich_media_title" id="activity-name">
                    刨根问底 - 如何将 PCM 音频编码成 MP4？                                    </h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                            <em id="post-date" class="rich_media_meta rich_media_meta_text">2017-11-18</em>

                                        <em class="rich_media_meta rich_media_meta_text">Tankery</em>
                                        <a class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="##" id="post-user">FlyTheCode</a>
                    <span class="rich_media_meta rich_media_meta_text rich_media_meta_nickname">FlyTheCode</span>

                    <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                        <div class="profile_inner">
                            <strong class="profile_nickname">FlyTheCode</strong>
                            <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                            <p class="profile_meta">
                            <label class="profile_meta_label">微信号</label>
                            <span class="profile_meta_value">FlyTheCode</span>
                            </p>

                            <p class="profile_meta">
                            <label class="profile_meta_label">功能介绍</label>
                            <span class="profile_meta_value">希望有一天，代码能如风一般飞奔在原野。</span>
                            </p>
                            
                        </div>
                        <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                            <i class="profile_arrow arrow_out"></i>
                            <i class="profile_arrow arrow_in"></i>
                        </span>
                    </div>
                </div>
                
                
                
                
                                                
                                                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">很多时候，我们会碰到一些棘手的问题。我们会从 Google 去寻找答案，然后一个个尝试，发现都不 work，怎么办？又有些时候，幸运的找到了答案，自己依葫芦画瓢的解决了问题，但问题变了个说法，做了一些修改，原来的办法不生效了怎么办？</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">作为一个有(bu)追(yao)求(lian)的码农，我的想法是，刨根问底，找到 root cause，这样才能恍然大悟，融汇贯通。自己的问题解决了，网上那些可怜的提问者的问题，你也知道答案了。所以从这篇文章文章开始，我决定开始一个系列——刨根问底，记录下那些棘手问题的解决过程，希望也能给大家一些启发。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">今日份的问题是这样的：<strong style="box-sizing: border-box;line-height: inherit;">“怎么将一个 PCM 音频流（或是WAV 文件流），编码成 MP4 格式（或是其他压缩格式）？”</strong></p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">带着这个问题，我们第一件要做的事情，当然是去 Google 一下看看是否有现成的方案。搜索 “android pcm to mp4 file“，或者其他类似的一些方案，你会发现这篇博客和这个回答，一个用实际代码告诉你可以用 MediaCodec + MediaMuxer 来实现，很好，这很原生，然鹅 MediaMuxer 只支持 API18+，覆盖的用户变少了；另一个说用 Android AAC Encoder 这个库；还有一些回答是针对具体问题的，并没有详细说明怎么做。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">如果原始接口可以实现的话，我们并不想引入一个音频编码库（特别是包含 native code 的库），这会使得包体积变大，所以我们先试着去找找无需编码库的原生实现方案。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">我们先来看看 MediaMuxer 的方案。假如我们的工程是基于 API16+ 的（Android4.1，几乎就是覆盖了所有用户了），而 MediaMuxer 是 API18 才引入的。那么，MediaMuxer 的方案就很让人纠结，是放弃一部分用户选用这个方案，还是再找找其他办法？没有实践就没有结论，我们先尝试一下这个方案吧。</p><h2 style="box-sizing: border-box;margin: 0.2rem auto 0.5rem;">Encode with MediaCodec + MediaMuxer</h2><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">尝试这个方案时，发现 GitHub 上有个项目叫 PCMEncoder 对前文提到的博客做了个封装，比较易于使用。详细的实现我就不说了，逻辑都在 PCMEncoder.java 这个类里面。大致的逻辑，就是先配置好 MediaCodec 和 MediaMuxer，之后用 MediaCodec 对输入的原始音频流做编码以后，利用 MediaMuxer 写入到 MP4 文件。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">放入工程中运行以后，发现确实能方便的编码成 mp4。要不我们就放弃那一小部分用户，把 API 支持上调到 18 吧？但是等等，好像有个小问题，为什么原生文件中的最后一个部分的音频不见了？去它的项目上看，发现有一个 issue，和我遇到同样的问题，而两年过去了，作者并没有回复。。（后面的一个 pull request 是我提交的，后文我会详细讲到这个提交的事情）</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">这么看，就只能靠自己了。第一步是搞清楚为什么有一小段音频被丢失了，解决这个问题，我们至少在 API18 以上是可以工作的。于是仔细研究了作者的逻辑，发现主要是两个部分，一部分是使用 MediaCodec 做编码，另一部分是将 MediaCodec 的输出作为 MediaMuxer 的输入，使用 “writeSampleData” 将编码后的数据写入 MediaMuxer，再由 MediaMuxer 生成 MP4。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">那么就一步步检查问提把，首先看看 MediaCodec，根据官方的文档，了解到作者使用的是一个过时的方式，手动获取到 MediaCodec 的 input buffers，将原始音频一段一段的输入到指定的 buffer 上，然后 enqueue，这几段音频会被传送到编码器上进行编码，完事以后会放到 output buffers 上，需要手动的 query，看看是否有编码完成的 buffer 产生，有的话，就取出这几段 output buffer，并释放它。这个工作流程可以用下面的图来表示：</p><p><img data-s="300,640" data-type="png" src="http://mmbiz.qpic.cn/mmbiz_png/zF3LiaNuTWoXM5bicAicNVdeGoZkibsAFHP7yQUOsnJhRUkAP3UXH1EBoeon5E1X1hln1VDbAibIbSTvoZQIMicKoobQ/0?wx_fmt=png" style="" class="" data-ratio="0.39335664335664333" data-w="1144"></p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">另外，想要 MediaCodec 能够工作，我们需要处理好它的状态。它的状态，分为两个大的部分，一部分是 Stopped 状态，一部分是 Executing 状态。初始化时，处于 Stopped 的 Uninitialized 状态，需要经过配置（设置编码格式、编码率等信息）以后，进入 Configured 状态。start 之后就进入 Executing 的 Flushed 状态了。此后，如果通过 enqueue 输入了第一个音频数据，MediaCodec 会进入 Running 状态进行编码，以后不断的接收 enqueue 的 input buffer，并把编码输入放到 output buffer。直到收到 EOS (End of Stream) 信息后，进入 End of Stream 状态。 stop 后，回到 Uninitialized 的状态。状态变化如下图：</p><p><img data-s="300,640" data-type="png" src="http://mmbiz.qpic.cn/mmbiz_png/zF3LiaNuTWoXM5bicAicNVdeGoZkibsAFHP7zW28IltDQJOoDYYsg7qJy7xe3BkKcjx3lxgbwteYoPJA0ibByicXhAzw/0?wx_fmt=png" style="" class="" data-ratio="0.7035647279549718" data-w="1066"></p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">前文说了。这是一种过时的方式，新的使用姿势，应该是用 async 方式，接收更新回调后做动作，而不是不断的 query。详情可以查看MediaCodec 的官方文档。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">从这个状态图我们看到，有一个 <strong style="box-sizing: border-box;line-height: inherit;">End of Stream</strong> 状态，需要接收到 EOS 信息，这里有些懵逼，PCMEncoder 作者的代码中也没有体现。但是继续查看文档以后，发现这么一句话：”When you reach the end of the input data, you must signal it to the codec by specifying the BUFFER_FLAG_END_OF_STREAM flag in the call to queueInputBuffer.“ 是啊，这应该就是问题的关键了。作者并没有发送 BUFFER_FLAG_END_OF_STREAM 的 flag，我设置了以后，发现工作正常了，最后那么丢失的音节回来了，棒！</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">回过头想想，作者应该是因为希望可以多次 encode，所以忘记发送这个 flag 了。我们可以在 stop 前，先发送这个flag，就可以解决这个问题了，于是 fork 了作者的项目，修改代码，给他提交了一个 pull request。作者在沉寂了两年以后，终于出现，合并了我的 PR，并对我表达了感谢。</p><h2 style="box-sizing: border-box;margin: 0.2rem auto 0.5rem;">Encode with MediaCodec</h2><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">这事儿并没完。从字面上理解，MediaCodec 是编码，MediaMuxer 应该是混音。看文档的话，大致也是这样的意思。那么，我们要做的不就是编码么？为啥还需要一个混音呢？而且关键的是 MediaMuxer 才是那个需要 API18 的类。MediaCodec 是只需要 API16 的，这和我们的项目很契合。于是，自然的，我就想是不是去掉 MediaMuxer 试试。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">第一个朴素的想法，是将 MediaCodec 输出直接写入文件。它不是做编码的么？编码完了，写入文件不就行了？于是我就这么做了。然而发现输出的文件并不能播放。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">回想起以前做相关事情的经验，我猜是否因为有些文件头之类的东西没设置导致无法播放？经过以关键词一番搜索，发现原因是 MediaCodec 编码出来的格式 audio/mp4a-latm 实际上是 AAC 的格式，无法直接播放，需要一个容器来承载才可以播放，通常的方法是使用 ADTS 作为容器，为每一帧都增加一些说明字段就可以将 AAC 格式转换成可播放的 mp4 了。相关的 Stack Overflow 的回答，比较好的是这篇，它通过下面的代码来为每一帧 ACC 添加帧信息，使其转换为 ADTS 的一帧：</p><pre class="highlight" style="box-sizing: border-box;overflow-x: auto;overflow-y: hidden;font-family: monospace, monospace;font-size: 1em;margin: 0px auto 1.5625rem;padding: 1.25rem;background-color: rgba(240, 240, 240, 0.8);max-width: 56.25rem;"><code class="hljs cs" style="box-sizing: border-box;"><span class="cm" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">/**
 *  Add ADTS header at the beginning of each and every AAC packet.
 *  This is needed as MediaCodec encoder generates a packet of raw
 *  AAC data.
 *
 *  Note the packetLen must count in the ADTS header itself.
 **/</span></span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">private</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="nf" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">addADTStoPacket</span></span></span><span class="p" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;">(</span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">[]</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">packet</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">packetLen</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;">)</span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
    <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">profile</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span><span class="o" style="box-sizing: border-box;">;</span>  <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">//AAC LC</span></span>
                      <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">//39=MediaCodecInfo.CodecProfileLevel.AACObjectELD;</span></span>
    <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">freqIdx</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">4</span></span><span class="o" style="box-sizing: border-box;">;</span>  <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">//44.1KHz</span></span>
    <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">chanCfg</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span><span class="o" style="box-sizing: border-box;">;</span>  <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">//CPE</span></span>

    <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">// fill in ADTS data</span></span>
    <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">xFF</span></span><span class="o" style="box-sizing: border-box;">;</span>
    <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">1</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">xF9</span></span><span class="o" style="box-sizing: border-box;">;</span>
    <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)(((</span><span class="n" style="box-sizing: border-box;">profile</span><span class="o" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">-</span></span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">1</span></span><span class="o" style="box-sizing: border-box;">)&lt;&lt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">6</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">+</span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">freqIdx</span><span class="o" style="box-sizing: border-box;">&lt;&lt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">+(</span><span class="n" style="box-sizing: border-box;">chanCfg</span><span class="o" style="box-sizing: border-box;">&gt;&gt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span><span class="o" style="box-sizing: border-box;">));</span>
    <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">3</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)(((</span><span class="n" style="box-sizing: border-box;">chanCfg</span><span class="o" style="box-sizing: border-box;">&amp;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">3</span></span><span class="o" style="box-sizing: border-box;">)&lt;&lt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">6</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">+</span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">packetLen</span><span class="o" style="box-sizing: border-box;">&gt;&gt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">11</span></span><span class="o" style="box-sizing: border-box;">));</span>
    <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">4</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)((</span><span class="n" style="box-sizing: border-box;">packetLen</span><span class="o" style="box-sizing: border-box;">&amp;</span><span class="mh" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0x7</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">FF</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">&gt;&gt;</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">3</span></span><span class="o" style="box-sizing: border-box;">);</span>
    <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">5</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)(((</span><span class="n" style="box-sizing: border-box;">packetLen</span><span class="o" style="box-sizing: border-box;">&amp;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">7</span></span><span class="o" style="box-sizing: border-box;">)&lt;&lt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">5</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">+</span> <span class="mh" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0x1</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">F</span></span><span class="o" style="box-sizing: border-box;">);</span>
    <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">6</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">xFC</span></span><span class="o" style="box-sizing: border-box;">;</span><span class="o" style="box-sizing: border-box;">}</span></code></pre><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">再将编码后的 ACC 数据填入该帧的剩余部分，之后写入文件，就能以 mp4 格式播放了。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">其中，比较关键的是选择好配置信息。函数头部的三个变量 <code class="highlighter-rouge" style="box-sizing: border-box;">profile</code>, <code class="highlighter-rouge" style="box-sizing: border-box;">freqIdx</code>, <code class="highlighter-rouge" style="box-sizing: border-box;">chanCfg</code> 就是分别用来配置 AAC Profile, 频率索引 和 声道的。</p><ul style="margin-left: auto;margin-right: auto;" class=" list-paddingleft-2"><li><p>profile 必须与 MediaCodec 的 <code class="highlighter-rouge" style="box-sizing: border-box;">KEY_AAC_PROFILE</code> 配置相匹配，其值可以在 <code class="highlighter-rouge" style="box-sizing: border-box;">MediaCodecInfo.CodecProfileLevel</code> 找到。</p></li><li><p>freqIdx 采样频率索引，不是具体的频率值，而是有一个频率值的列表，这个 index 代表了指定频率在该列表的索引，该频率需要和输入源的频率匹配。</p></li><li><p>chanCfg 声道数目，这个需要和输入源匹配。</p></li></ul><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">这三个值的取值范围都可以在 MPEG-4 Audio 的文档中找到。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">最终，我将这些配置封装起来，与 MediaCodec 配合，实现了比较方便的，支持到 API16 的 MP4 编码方案。其代码只有一个类，关键代码如下（完整代码可以在我的 Gist 上找到）：</p><pre class="highlight" style="box-sizing: border-box;overflow-x: auto;overflow-y: hidden;font-family: monospace, monospace;font-size: 1em;margin: 0px auto 1.5625rem;padding: 1.25rem;background-color: rgba(240, 240, 240, 0.8);max-width: 56.25rem;"><code class="hljs java" style="box-sizing: border-box;"><span class="cm" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">/**
 * PCMEncoder
 *
 * Encode PCM stream into MP4 file stream.
 *
 * Created by tankery on 11/11/2017.
 */</span></span><span class="kd" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">public</span></span> <span class="kd" style="box-sizing: border-box;"><span class="hljs-class" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">class</span></span></span><span class="hljs-class" style="box-sizing: border-box;"> </span><span class="nc" style="box-sizing: border-box;"><span class="hljs-class" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">PCMEncoder</span></span></span><span class="hljs-class" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>

    <span class="cm" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">/**
     * Creates encoder with given params for output file
     * <span class="hljs-doctag" style="box-sizing: border-box;font-weight: bold;">@param</span> bitrate Bitrate of the output file, higher bitrate brings better voice, but
     *                lager file. eg. 64k is enough for speech, its about 28MB/hour after encode.
     * <span class="hljs-doctag" style="box-sizing: border-box;font-weight: bold;">@param</span> sampleRate sampling rate of pcm.
     * <span class="hljs-doctag" style="box-sizing: border-box;font-weight: bold;">@param</span> channelCount channel count of pcm.
     */</span></span>
    <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">public</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">PCMEncoder</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">final</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">bitrate</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">final</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">sampleRate</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">channelCount</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">this</span></span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">bitrate</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">bitrate</span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">this</span></span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">sampleRate</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">sampleRate</span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">this</span></span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">channelCount</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">channelCount</span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">for</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">i</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">;</span> <span class="n" style="box-sizing: border-box;">i</span> <span class="o" style="box-sizing: border-box;">&lt;</span> <span class="n" style="box-sizing: border-box;">SUPPORTED_SAMPLE_RATES</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">length</span><span class="o" style="box-sizing: border-box;">;</span> <span class="n" style="box-sizing: border-box;">i</span><span class="o" style="box-sizing: border-box;">++)</span> <span class="o" style="box-sizing: border-box;">{</span>
            <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">if</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">sampleRate</span> <span class="o" style="box-sizing: border-box;">==</span> <span class="n" style="box-sizing: border-box;">SUPPORTED_SAMPLE_RATES</span><span class="o" style="box-sizing: border-box;">[</span><span class="n" style="box-sizing: border-box;">i</span><span class="o" style="box-sizing: border-box;">])</span> <span class="o" style="box-sizing: border-box;">{</span>
                <span class="n" style="box-sizing: border-box;">freqIdx</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">i</span><span class="o" style="box-sizing: border-box;">;</span>
                <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">break</span></span><span class="o" style="box-sizing: border-box;">;</span>
            <span class="o" style="box-sizing: border-box;">}</span>
        <span class="o" style="box-sizing: border-box;">}</span>
    <span class="o" style="box-sizing: border-box;">}</span>

    <span class="cm" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">/**
     * Encodes input stream
     *
     * <span class="hljs-doctag" style="box-sizing: border-box;font-weight: bold;">@throws</span> IOException
     */</span></span>
    <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">public</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">encode</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">InputStream</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">inputStream</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">OutputStream</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">outputStream</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">throws</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;">IOException</span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
        <span class="n" style="box-sizing: border-box;">prepare</span><span class="o" style="box-sizing: border-box;">();</span>

        <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">boolean</span></span> <span class="n" style="box-sizing: border-box;">hasMoreData</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="kc" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">true</span></span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">while</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">hasMoreData</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
            <span class="n" style="box-sizing: border-box;">hasMoreData</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">readInputs</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">inputStream</span><span class="o" style="box-sizing: border-box;">);</span>
            <span class="n" style="box-sizing: border-box;">writeOutputs</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">outputStream</span><span class="o" style="box-sizing: border-box;">);</span>
        <span class="o" style="box-sizing: border-box;">}</span>

        <span class="n" style="box-sizing: border-box;">inputStream</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">close</span><span class="o" style="box-sizing: border-box;">();</span>
        <span class="n" style="box-sizing: border-box;">outputStream</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">close</span><span class="o" style="box-sizing: border-box;">();</span>

        <span class="n" style="box-sizing: border-box;">stop</span><span class="o" style="box-sizing: border-box;">();</span>
    <span class="o" style="box-sizing: border-box;">}</span>

    <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">private</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">prepare</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">()</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">try</span></span> <span class="o" style="box-sizing: border-box;">{</span>
            <span class="n" style="box-sizing: border-box;">Timber</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">d</span><span class="o" style="box-sizing: border-box;">(</span><span class="s" style="box-sizing: border-box;"><span class="hljs-string" style="box-sizing: border-box;color: rgb(136, 0, 0);">"Preparing PCMEncoder"</span></span><span class="o" style="box-sizing: border-box;">);</span>

            <span class="n" style="box-sizing: border-box;">mediaFormat</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">MediaFormat</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">createAudioFormat</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">COMPRESSED_AUDIO_FILE_MIME_TYPE</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">sampleRate</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">channelCount</span><span class="o" style="box-sizing: border-box;">);</span>
            <span class="n" style="box-sizing: border-box;">mediaFormat</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">setInteger</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">MediaFormat</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">KEY_AAC_PROFILE</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">COMPRESSED_AUDIO_PROFILE</span><span class="o" style="box-sizing: border-box;">);</span>
            <span class="n" style="box-sizing: border-box;">mediaFormat</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">setInteger</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">MediaFormat</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">KEY_BIT_RATE</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">bitrate</span><span class="o" style="box-sizing: border-box;">);</span>

            <span class="n" style="box-sizing: border-box;">mediaCodec</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">MediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">createEncoderByType</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">COMPRESSED_AUDIO_FILE_MIME_TYPE</span><span class="o" style="box-sizing: border-box;">);</span>
            <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">configure</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">mediaFormat</span><span class="o" style="box-sizing: border-box;">,</span> <span class="kc" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">null</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="kc" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">null</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">MediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">CONFIGURE_FLAG_ENCODE</span><span class="o" style="box-sizing: border-box;">);</span>
            <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">start</span><span class="o" style="box-sizing: border-box;">();</span>

            <span class="n" style="box-sizing: border-box;">codecInputBuffers</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">getInputBuffers</span><span class="o" style="box-sizing: border-box;">();</span>
            <span class="n" style="box-sizing: border-box;">codecOutputBuffers</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">getOutputBuffers</span><span class="o" style="box-sizing: border-box;">();</span>

            <span class="n" style="box-sizing: border-box;">bufferInfo</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">new</span></span> <span class="n" style="box-sizing: border-box;">MediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">BufferInfo</span><span class="o" style="box-sizing: border-box;">();</span>

            <span class="n" style="box-sizing: border-box;">totalBytesRead</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">;</span>
            <span class="n" style="box-sizing: border-box;">presentationTimeUs</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">;</span>
            <span class="n" style="box-sizing: border-box;">tempBuffer</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">new</span></span> <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span> <span class="o" style="box-sizing: border-box;">*</span> <span class="n" style="box-sizing: border-box;">sampleRate</span><span class="o" style="box-sizing: border-box;">];</span>
        <span class="o" style="box-sizing: border-box;">}</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">catch</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">IOException</span> <span class="n" style="box-sizing: border-box;">e</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
            <span class="n" style="box-sizing: border-box;">Timber</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">e</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">e</span><span class="o" style="box-sizing: border-box;">,</span> <span class="s" style="box-sizing: border-box;"><span class="hljs-string" style="box-sizing: border-box;color: rgb(136, 0, 0);">"Exception while initializing PCMEncoder"</span></span><span class="o" style="box-sizing: border-box;">);</span>
        <span class="o" style="box-sizing: border-box;">}</span>
    <span class="o" style="box-sizing: border-box;">}</span>

    <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">private</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">stop</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">()</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
        <span class="n" style="box-sizing: border-box;">Timber</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">d</span><span class="o" style="box-sizing: border-box;">(</span><span class="s" style="box-sizing: border-box;"><span class="hljs-string" style="box-sizing: border-box;color: rgb(136, 0, 0);">"Stopping PCMEncoder"</span></span><span class="o" style="box-sizing: border-box;">);</span>
        <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">stop</span><span class="o" style="box-sizing: border-box;">();</span>
        <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">release</span><span class="o" style="box-sizing: border-box;">();</span>
    <span class="o" style="box-sizing: border-box;">}</span>

    <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">private</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">boolean</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">readInputs</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">InputStream</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">inputStream</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">throws</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;">IOException</span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
        <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">boolean</span></span> <span class="n" style="box-sizing: border-box;">hasMoreData</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="kc" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">true</span></span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">inputBufferIndex</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">currentBatchRead</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">while</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">inputBufferIndex</span> <span class="o" style="box-sizing: border-box;">!=</span> <span class="o" style="box-sizing: border-box;">-</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">1</span></span> <span class="o" style="box-sizing: border-box;">&amp;&amp;</span> <span class="n" style="box-sizing: border-box;">hasMoreData</span> <span class="o" style="box-sizing: border-box;">&amp;&amp;</span> <span class="n" style="box-sizing: border-box;">currentBatchRead</span> <span class="o" style="box-sizing: border-box;">&lt;=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">50</span></span> <span class="o" style="box-sizing: border-box;">*</span> <span class="n" style="box-sizing: border-box;">sampleRate</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
            <span class="n" style="box-sizing: border-box;">inputBufferIndex</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">dequeueInputBuffer</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">CODEC_TIMEOUT</span><span class="o" style="box-sizing: border-box;">);</span>

            <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">if</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">inputBufferIndex</span> <span class="o" style="box-sizing: border-box;">&gt;=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
                <span class="n" style="box-sizing: border-box;">ByteBuffer</span> <span class="n" style="box-sizing: border-box;">buffer</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">codecInputBuffers</span><span class="o" style="box-sizing: border-box;">[</span><span class="n" style="box-sizing: border-box;">inputBufferIndex</span><span class="o" style="box-sizing: border-box;">];</span>
                <span class="n" style="box-sizing: border-box;">buffer</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">clear</span><span class="o" style="box-sizing: border-box;">();</span>

                <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">bytesRead</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">inputStream</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">read</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">tempBuffer</span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">buffer</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">limit</span><span class="o" style="box-sizing: border-box;">());</span>
                <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">if</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">bytesRead</span> <span class="o" style="box-sizing: border-box;">==</span> <span class="o" style="box-sizing: border-box;">-</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">1</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
                    <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">queueInputBuffer</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">inputBufferIndex</span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">presentationTimeUs</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">MediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">BUFFER_FLAG_END_OF_STREAM</span><span class="o" style="box-sizing: border-box;">);</span>
                    <span class="n" style="box-sizing: border-box;">hasMoreData</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="kc" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">false</span></span><span class="o" style="box-sizing: border-box;">;</span>
                <span class="o" style="box-sizing: border-box;">}</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">else</span></span> <span class="o" style="box-sizing: border-box;">{</span>
                    <span class="n" style="box-sizing: border-box;">totalBytesRead</span> <span class="o" style="box-sizing: border-box;">+=</span> <span class="n" style="box-sizing: border-box;">bytesRead</span><span class="o" style="box-sizing: border-box;">;</span>
                    <span class="n" style="box-sizing: border-box;">currentBatchRead</span> <span class="o" style="box-sizing: border-box;">+=</span> <span class="n" style="box-sizing: border-box;">bytesRead</span><span class="o" style="box-sizing: border-box;">;</span>
                    <span class="n" style="box-sizing: border-box;">buffer</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">put</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">tempBuffer</span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">bytesRead</span><span class="o" style="box-sizing: border-box;">);</span>
                    <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">queueInputBuffer</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">inputBufferIndex</span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">bytesRead</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">presentationTimeUs</span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">);</span>
                    <span class="n" style="box-sizing: border-box;">presentationTimeUs</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">1000000L</span></span> <span class="o" style="box-sizing: border-box;">*</span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">totalBytesRead</span> <span class="o" style="box-sizing: border-box;">/</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">/</span> <span class="n" style="box-sizing: border-box;">sampleRate</span><span class="o" style="box-sizing: border-box;">;</span>
                <span class="o" style="box-sizing: border-box;">}</span>
            <span class="o" style="box-sizing: border-box;">}</span>
        <span class="o" style="box-sizing: border-box;">}</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">return</span></span> <span class="n" style="box-sizing: border-box;">hasMoreData</span><span class="o" style="box-sizing: border-box;">;</span>
    <span class="o" style="box-sizing: border-box;">}</span>

    <span class="nd" style="box-sizing: border-box;"><span class="hljs-meta" style="box-sizing: border-box;color: rgb(31, 113, 153);">@SuppressLint</span></span><span class="o" style="box-sizing: border-box;">(</span><span class="s" style="box-sizing: border-box;"><span class="hljs-string" style="box-sizing: border-box;color: rgb(136, 0, 0);">"WrongConstant"</span></span><span class="o" style="box-sizing: border-box;">)</span>
    <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">private</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">writeOutputs</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">OutputStream</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">outputStream</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">throws</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;">IOException</span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
        <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">outputBufferIndex</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">while</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">outputBufferIndex</span> <span class="o" style="box-sizing: border-box;">!=</span> <span class="n" style="box-sizing: border-box;">MediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">INFO_TRY_AGAIN_LATER</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
            <span class="n" style="box-sizing: border-box;">outputBufferIndex</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">dequeueOutputBuffer</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">bufferInfo</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">CODEC_TIMEOUT</span><span class="o" style="box-sizing: border-box;">);</span>
            <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">if</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">outputBufferIndex</span> <span class="o" style="box-sizing: border-box;">&gt;=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
                <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">if</span></span> <span class="o" style="box-sizing: border-box;">((</span><span class="n" style="box-sizing: border-box;">bufferInfo</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">flags</span> <span class="o" style="box-sizing: border-box;">&amp;</span> <span class="n" style="box-sizing: border-box;">MediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">BUFFER_FLAG_CODEC_CONFIG</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">!=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span> <span class="o" style="box-sizing: border-box;">&amp;&amp;</span> <span class="n" style="box-sizing: border-box;">bufferInfo</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">size</span> <span class="o" style="box-sizing: border-box;">!=</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
                    <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">releaseOutputBuffer</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">outputBufferIndex</span><span class="o" style="box-sizing: border-box;">,</span> <span class="kc" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">false</span></span><span class="o" style="box-sizing: border-box;">);</span>
                <span class="o" style="box-sizing: border-box;">}</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">else</span></span> <span class="o" style="box-sizing: border-box;">{</span>
                    <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">// Write ADTS header and AAC data to frame.</span></span>
                    <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">outPacketSize</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">bufferInfo</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">size</span> <span class="o" style="box-sizing: border-box;">+</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">7</span></span><span class="o" style="box-sizing: border-box;">;</span>    <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">// 7 is ADTS size</span></span>
                    <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">[]</span> <span class="n" style="box-sizing: border-box;">data</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">new</span></span> <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">[</span><span class="n" style="box-sizing: border-box;">outPacketSize</span><span class="o" style="box-sizing: border-box;">];</span>  <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">//space for ADTS header included</span></span>
                    <span class="n" style="box-sizing: border-box;">addADTStoPacket</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">data</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">outPacketSize</span><span class="o" style="box-sizing: border-box;">);</span>

                    <span class="n" style="box-sizing: border-box;">ByteBuffer</span> <span class="n" style="box-sizing: border-box;">encodedData</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">codecOutputBuffers</span><span class="o" style="box-sizing: border-box;">[</span><span class="n" style="box-sizing: border-box;">outputBufferIndex</span><span class="o" style="box-sizing: border-box;">];</span>
                    <span class="n" style="box-sizing: border-box;">encodedData</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">position</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">bufferInfo</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">offset</span><span class="o" style="box-sizing: border-box;">);</span>
                    <span class="n" style="box-sizing: border-box;">encodedData</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">limit</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">bufferInfo</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">offset</span> <span class="o" style="box-sizing: border-box;">+</span> <span class="n" style="box-sizing: border-box;">bufferInfo</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">size</span><span class="o" style="box-sizing: border-box;">);</span>
                    <span class="n" style="box-sizing: border-box;">encodedData</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">get</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">data</span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">7</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">bufferInfo</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">size</span><span class="o" style="box-sizing: border-box;">);</span>
                    <span class="n" style="box-sizing: border-box;">encodedData</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">clear</span><span class="o" style="box-sizing: border-box;">();</span>
                    <span class="n" style="box-sizing: border-box;">outputStream</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">write</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">data</span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">outPacketSize</span><span class="o" style="box-sizing: border-box;">);</span>  <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">//open FileOutputStream beforehand</span></span>

                    <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">releaseOutputBuffer</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">outputBufferIndex</span><span class="o" style="box-sizing: border-box;">,</span> <span class="kc" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">false</span></span><span class="o" style="box-sizing: border-box;">);</span>
                <span class="o" style="box-sizing: border-box;">}</span>
            <span class="o" style="box-sizing: border-box;">}</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">else</span></span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">if</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">outputBufferIndex</span> <span class="o" style="box-sizing: border-box;">==</span> <span class="n" style="box-sizing: border-box;">MediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">INFO_OUTPUT_BUFFERS_CHANGED</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
                <span class="n" style="box-sizing: border-box;">codecOutputBuffers</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">getOutputBuffers</span><span class="o" style="box-sizing: border-box;">();</span>
            <span class="o" style="box-sizing: border-box;">}</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">else</span></span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">if</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">outputBufferIndex</span> <span class="o" style="box-sizing: border-box;">==</span> <span class="n" style="box-sizing: border-box;">MediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">INFO_OUTPUT_FORMAT_CHANGED</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
                <span class="n" style="box-sizing: border-box;">mediaFormat</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">mediaCodec</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">getOutputFormat</span><span class="o" style="box-sizing: border-box;">();</span>
            <span class="o" style="box-sizing: border-box;">}</span>
        <span class="o" style="box-sizing: border-box;">}</span>
    <span class="o" style="box-sizing: border-box;">}</span>

    <span class="cm" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">/**
     *  Add ADTS header at the beginning of each and every AAC packet.
     *  This is needed as MediaCodec encoder generates a packet of raw
     *  AAC data.
     *
     *  Note the packetLen must count in the ADTS header itself.
     **/</span></span>
    <span class="kd" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">private</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">void</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-title" style="box-sizing: border-box;color: rgb(136, 0, 0);font-weight: bold;">addADTStoPacket</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">(</span></span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">[]</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">packet</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">,</span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="kt" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span></span></span><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;"> </span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">packetLen</span></span></span><span class="o" style="box-sizing: border-box;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-params" style="box-sizing: border-box;">)</span></span></span><span class="hljs-function" style="box-sizing: border-box;"> </span><span class="o" style="box-sizing: border-box;">{</span>
        <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">profile</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">COMPRESSED_AUDIO_PROFILE</span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">freqIdx</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">this</span></span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">freqIdx</span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">int</span></span> <span class="n" style="box-sizing: border-box;">chanCfg</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="n" style="box-sizing: border-box;">channelCount</span><span class="o" style="box-sizing: border-box;">;</span>

        <span class="c1" style="box-sizing: border-box;"><span class="hljs-comment" style="box-sizing: border-box;color: rgb(136, 136, 136);">// fill in ADTS data</span></span>
        <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">xFF</span></span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">1</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">xF9</span></span><span class="o" style="box-sizing: border-box;">;</span>
        <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)(((</span><span class="n" style="box-sizing: border-box;">profile</span><span class="o" style="box-sizing: border-box;">-</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">1</span></span><span class="o" style="box-sizing: border-box;">)&lt;&lt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">6</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">+</span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">freqIdx</span><span class="o" style="box-sizing: border-box;">&lt;&lt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">+(</span><span class="n" style="box-sizing: border-box;">chanCfg</span><span class="o" style="box-sizing: border-box;">&gt;&gt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">2</span></span><span class="o" style="box-sizing: border-box;">));</span>
        <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">3</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)(((</span><span class="n" style="box-sizing: border-box;">chanCfg</span><span class="o" style="box-sizing: border-box;">&amp;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">3</span></span><span class="o" style="box-sizing: border-box;">)&lt;&lt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">6</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">+</span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">packetLen</span><span class="o" style="box-sizing: border-box;">&gt;&gt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">11</span></span><span class="o" style="box-sizing: border-box;">));</span>
        <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">4</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)((</span><span class="n" style="box-sizing: border-box;">packetLen</span><span class="o" style="box-sizing: border-box;">&amp;</span><span class="mh" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0x7</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">FF</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">&gt;&gt;</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">3</span></span><span class="o" style="box-sizing: border-box;">);</span>
        <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">5</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)(((</span><span class="n" style="box-sizing: border-box;">packetLen</span><span class="o" style="box-sizing: border-box;">&amp;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">7</span></span><span class="o" style="box-sizing: border-box;">)&lt;&lt;</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">5</span></span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">+</span> <span class="mh" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0x1</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">F</span></span><span class="o" style="box-sizing: border-box;">);</span>
        <span class="n" style="box-sizing: border-box;">packet</span><span class="o" style="box-sizing: border-box;">[</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">6</span></span><span class="o" style="box-sizing: border-box;">]</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="o" style="box-sizing: border-box;">(</span><span class="kt" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">byte</span></span><span class="o" style="box-sizing: border-box;">)</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">0</span></span><span class="n" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">xFC</span></span><span class="o" style="box-sizing: border-box;">;</span>
    <span class="o" style="box-sizing: border-box;">}</span><span class="o" style="box-sizing: border-box;">}</span></code></pre><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">调用非常简单，初始化以后，直接 encode 就搞定了：</p><pre class="highlight" style="box-sizing: border-box;overflow-x: auto;overflow-y: hidden;font-family: monospace, monospace;font-size: 1em;margin: 0px auto 1.5625rem;padding: 1.25rem;background-color: rgba(240, 240, 240, 0.8);max-width: 56.25rem;"><code class="hljs coffeescript" style="box-sizing: border-box;"><span class="n" style="box-sizing: border-box;">PCMEncoder</span> <span class="n" style="box-sizing: border-box;">encoder</span> <span class="o" style="box-sizing: border-box;">=</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">new</span></span> <span class="n" style="box-sizing: border-box;">PCMEncoder</span><span class="o" style="box-sizing: border-box;">(</span><span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">64000</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">8000</span></span><span class="o" style="box-sizing: border-box;">,</span> <span class="mi" style="box-sizing: border-box;"><span class="hljs-number" style="box-sizing: border-box;color: rgb(136, 0, 0);">1</span></span><span class="o" style="box-sizing: border-box;">);</span><span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">try</span></span> <span class="o" style="box-sizing: border-box;">{</span>
    <span class="n" style="box-sizing: border-box;">encoder</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">encode</span><span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">inputStream</span><span class="o" style="box-sizing: border-box;">,</span> <span class="n" style="box-sizing: border-box;">outputStream</span><span class="o" style="box-sizing: border-box;">);</span><span class="o" style="box-sizing: border-box;">}</span> <span class="k" style="box-sizing: border-box;"><span class="hljs-keyword" style="box-sizing: border-box;font-weight: bold;">catch</span></span> <span class="o" style="box-sizing: border-box;">(</span><span class="n" style="box-sizing: border-box;">IOException</span> <span class="n" style="box-sizing: border-box;">e</span><span class="o" style="box-sizing: border-box;">)</span> <span class="o" style="box-sizing: border-box;">{</span>
    <span class="n" style="box-sizing: border-box;">e</span><span class="o" style="box-sizing: border-box;">.</span><span class="na" style="box-sizing: border-box;">printStackTrace</span><span class="o" style="box-sizing: border-box;">();</span><span class="o" style="box-sizing: border-box;">}</span></code></pre><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">大功告成。</p><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">通过一番刨根问底，我们得到了下面这些收获：</p><ol style="margin-left: auto;margin-right: auto;" class=" list-paddingleft-2"><li><p>熟悉了 AAC, MP4 等格式；</p></li><li><p>了解了如何使用 MediaCodec, MediaMuxer；</p></li><li><p>使我们的应用支持在 API16 上进行编码，且不依赖第三方库；</p></li><li><p>为一个开源项目贡献了代码（Pull Request）；</p></li><li><p>输出了一份 Gist 以帮助他人快速使用；</p></li><li><p>输出了这篇文章，将来也许能帮助更多人走出谜团。</p></li></ol><p style="box-sizing: border-box;margin-right: auto;margin-bottom: 2em;margin-left: auto;">有了这些收获，我觉得我又降低了地球上的熵，让这个世界更美好了一些。✌️</p><p><br></p>
                </div>
                <script nonce="1199846452" type="text/javascript">
                    var first_sceen__time = (+new Date());

                    if ("" == 1 && document.getElementById('js_content')) {
                        document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });
                    }

                    
                    (function(){
                        if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                            var link = document.createElement('link');
                            var head = document.getElementsByTagName('head')[0];
                            link.rel = 'stylesheet';
                            link.type = 'text/css';
                            link.href = "//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_winwx31619e.css";
                            head.appendChild(link);
                        }
                    })();
                </script>
                
                
                                
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display:none;"></div>

                
                                <div class="reward_area tc" id="js_preview_reward" style="display:none;">
                    <p id="js_preview_reward_wording" class="tips_global reward_tips" style="display:none;"></p>
                    <p>
                        <a class="reward_access" id="js_preview_reward_link" href="##"><span class="icon-reward"></span>赞赏</a>

                    </p>
                </div>
                <div class="reward_qrcode_area reward_area tc" id="js_preview_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                    <p id="js_preview_reward_ios_wording" class="reward_tips" style="display:none;"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" src="//res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_reward_qrcode.2x3534dd.png"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                            </div><div class="rich_media_tool" id="js_toobar3">
                                            <a class="media_tool_meta meta_primary" id="js_view_source" href="##">阅读原文</a>
                                <div id="js_read_area3" class="media_tool_meta tips_global meta_primary" style="display:none;">阅读 <span id="readNum3"></span></div>

                <span style="display:none;" class="media_tool_meta meta_primary tips_global meta_praise" id="like3">
                    <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum3"></span>
                </span>

                <a id="js_report_article3" style="display:none;" class="media_tool_meta tips_global meta_extra" href="##">投诉</a>

            </div><div class="rich_media_tool" id="js_sg_bar">
                                <a class="media_tool_meta meta_primary" href="http://blog.tankery.me/development/encode-pcm-to-mp4" target="_blank">阅读原文</a>
                                
            </div>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
