<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>2019年，你的 WAF 能应对场景化安全风险了吗？</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/53566289">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-f480892a5e5eab4b7bd702e1d671ec06_b.jpg" alt=""></div><p>作者： <a class="member_mention" href="http://www.zhihu.com/people/ef1451b56363510f1213945e82c5e076" data-hash="ef1451b56363510f1213945e82c5e076" data-hovercard="p$b$ef1451b56363510f1213945e82c5e076">@Monster</a> </p><p>羊毛党、恶意用户、爬虫、数据泄露、暴力破解、撞库……2019年了，你的 WAF 能应对场景化安全风险了吗？</p><h2><b>甲方，不量身定制能否“完美解决”</b></h2><p><br></p><p><b>2018 年马上要过去了，回顾今年网络安全环境，最惹人注目的依然是 Web 安全。</b>今年的 Web 安全事件仍旧大量充斥着诸如 SQL 注入、XSS、XXE、反序列化等传统的 Web 漏洞，除此之外还有横行的CC攻击、频发的0day漏洞以及企业自身业务导致的逻辑漏洞等等。</p><p>业务形态不同形成的多样技术架构，对于企业的安全建设者来说，几乎没有任何一个 Web 安全产品能够“完美解决”以上风险。事实上“完美解决”是个伪命题，安全本来就是一个道高一尺魔高一丈的博弈对抗问题，<b>每个企业的业务场景和内部网络拓扑都有着巨大的差异，很难找到和自家公司业务场景相似，又有着同样的安全需求的其他企业，即使找到，别人家的解决方案照搬过来不一定对自家环境适用。</b></p><p><br></p><h2><b>我等乙方，必须要叠加功能才能解决问题吗？</b></h2><p><br></p><p>多年来，行业内把WAF作为解决 Web 安全问题的必选方案，一个企业但凡有较为重要的业务网站就必然有 WAF 为其保驾护航。WAF市场依然呈现增速，而如今面临新的安全威胁、场景化的业务安全需求，传统 WAF 产品已经越来越不能满足现代化网络环境的安全防护需求。</p><p>对我等乙方而言，ToB 产品的难点在于不同的客户有不同的应用场景，很难有一款产品能解决所有客户的需求。<b>想让甲方爸爸满意，必然需要做深度定制化，但是如果漫无止境地根据客户的需求增加功能，会给产品设计与使用体验带来巨大的灾难，</b>最终可能产生一个具有上千功能的产品，只有完全熟悉这上千项功能的使用者才能快速找到在某个场景下能有效工作的选项组合。</p><p><br></p><figure><noscript><img src="https://pic3.zhimg.com/v2-2dbe524ba5b9a72d20b62c259204385a_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="716" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-2dbe524ba5b9a72d20b62c259204385a_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-2dbe524ba5b9a72d20b62c259204385a_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="716" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-2dbe524ba5b9a72d20b62c259204385a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-2dbe524ba5b9a72d20b62c259204385a_b.jpg"></figure><p><br></p><p><br></p><h2><b>场景化安全风险重难点</b></h2><p><br></p><p>目前为止，许多传统安全问题已经有了不少合适解决方案，但是非典型漏洞带来的风险变成了让甲方安全部头疼的新问题。有经验的安全工作者可以快速发现一个系统中是否存在一些非典型漏洞带来的风险，但是这种风险在不同的场景中的表现形式都不一样（比如怎么发现一个支付业务的 0 元购买风险，怎么防止一个管理系统的水平或垂直越权问题），因此无法形成合理的方法论，使该方法可以被自动化进行大面积统一排查。</p><p><b>综上所述，许多问题看起来类似，但是无法找到一个通用的解决方案可以在不同的业务场景下都能解决问题。</b></p><h2><b>流量分析的需求</b></h2><p><br></p><p>当今大数据时代，在中大型网络环境中，每天产生原始事件上亿次，告警的次数也在百万级别，这些数据加以分析和处理能够解开许多传统安全产品无法解决的难题。但是这样的原始数据不可能靠人工梳理，因此自动化日志或流量分析变成了一个强需求，亟需更新。</p><p>大多数研发实力较强的企业，纷纷开始尝试使用 Storm、ELK、Splunk 等开源系统建立自己的大数据平台，并且得到了不错的落地。如上文所言，如今的 Web 安全环境下除了传统的 Web 漏洞还有大量的业务安全、0Day 漏洞、CC 攻击等风险，<b>为了解决这些新型的安全威胁，一些企业建立了自己的 SOC、SIEM、风控系统、势态感知，从多个平台中收集告警、日志或流量，进行综合整理、深度分析，从而可以对业务建模，量化风险，并发现恶意行为与恶意用户。</b></p><p><br></p><figure><noscript><img src="https://pic1.zhimg.com/v2-99b3b4064687db38a3325b1e767f10b8_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="665" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic1.zhimg.com/v2-99b3b4064687db38a3325b1e767f10b8_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-99b3b4064687db38a3325b1e767f10b8_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="665" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic1.zhimg.com/v2-99b3b4064687db38a3325b1e767f10b8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-99b3b4064687db38a3325b1e767f10b8_b.jpg"></figure><p><br></p><h2><b>用WAF做流量分析</b></h2><p>研发实力较强的企业通过使用一些开源系统来建立自己的大数据平台进行流量分析，但这也存在不小的技术挑战，同时需要投入大量的人力物力才能看到一些实际的效果。</p><p><b>而 WAF 作为各企业居家常备产品，作为 Web 流量处理网关有着天然的数据优势，用 WAF 辅助完成流量分析的做法由来已久。</b>一些传统 WAF 会通过 SYSLOG 主动向其他平台推送告警，能够达到其他平台联动的效果，但其实效果微乎其微。日志是静态的，WAF 是动态的，推送出去的日志只是一个单一的结果，并没有记录 WAF 对于 HTTP 请求处理的所有细节，而这些丢失的细节中蕴藏着巨大的能量。因此，单纯对外推送告警反而大大限制了WAF的发挥。</p><p><b>如果站在WAF 自身就是一个流量分析平台的角度，WAF其实可以自己做流量分析，实现业务建模、风险建模。</b></p><p><b>使用 WAF 做流量分析的常见问题如下：</b></p><p><b>1. 流量处理平台需要大量的日志和流量，怎么办？</b></p><p>WAF 作为 Web 网关，有全量的 HTTP 数据</p><p><b>2. 流量分析平台怎么部署？</b></p><p>WAF 本身就是攻击检测平台，同样也可以作为流量分析平台</p><p><b>3. 流量分析是不是需要复杂的算法？</b></p><p>WAF 可以提供常见的业务场景适配算法，结合 Web 安全，更加适用</p><p><b>4. 流量分析可能会消耗非常多的计算资源，怎么办？</b></p><p> WAF 进行集群化部署。单机性能不够就上集群，集群性能不够就上更大的集群</p><p><br></p><h2><b>WAF的流量分析可以解决什么问题</b></h2><p><b>长亭科技的下一代WAF产品雷池（SafeLine）从设计之初就对开放性与扩展性给予了非常高的重视。</b>最新发布的雷池版本，开放了所有的管理控制接口，提供了可集群化部署的离线流量分析引擎，支持以更多自定义的方式处理经过的 HTTP 流量。使用者可以通过 Restful API 的方式调用雷池的所有管理控制功能，也可以使用 Lua 语言自主编写雷池（SafeLine）插件完成场景化的流量分析逻辑。</p><p>过去的一年，作为 WAF 供应商，长亭科技与客户合作解决了许多场景化的安全问题，从以下几个例子可以看出，<b>除了传统 Web 攻击防护以外，下一代WAF还可以做的事情还有：</b></p><p>与风控系统深度集成联合打击羊毛党</p><p>结合威胁情报平台对恶意用户进行实时封堵</p><p>监控敏感接口的爬取行为，多维度防御数据泄露</p><p>跟踪攻击者的行为，定位网站实际存在的漏洞</p><p>定制复杂的 CC 防护策略，保障服务的 SLA</p><p>防暴力破解、防撞库</p><p>定制 Web 请求与防护统计，生成势态感知报告</p><p>……以及各种基于企业自身业务场景需求而可能产生的应用</p><p><br></p><p><br></p><h2><b>介绍插件处理机制</b></h2><p><br></p><p><b>目前雷池支持三种插件类型：请求处理插件、定时任务插件、统计分析插件。</b></p><h2><b>请求处理插件</b></h2><p><b>请求处理插件可以通过指定筛选条件的方式过滤出符合某种特征（如源 IP、域名、URL 等）的 HTTP 请求，并对这些请求逐条进行处理。</b></p><p>以一个简单的业务场景为例，<a href="http://link.zhihu.com/?target=http%3A//www.chaitin.cn/sso" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://www.</span><span class="visible">chaitin.cn/sso</span><span class="invisible"></span></a> 是一个敏感的统一认证接口，长期遭到爆破与撞库的威胁，某客户希望将雷池与威胁情报服务进行集成，对访问该统一认证接口的用户进行风险分析，若威胁情报平台认为当前用户具有恶意就立即阻断该用户的后续访问。</p><p><b>了解如上的业务场景需求后可以按这样的方式编写插件：</b></p><p>1. 使用 match 变量进行筛选，过滤所有访问统一认证接口的 HTTP 请求</p><p>2. 注册一个回调函数，当用户访问统一认证接口时将 HTTP 请求传入回调函数进行处理</p><p>3. 与威胁情报平台联动，判断访问者是否有攻击背景</p><p>4. 发现恶意用户后下发规则，阻断该用户的后续访问</p><p>样例插件代码如下：</p><p>local safeline = require "safeline"</p><p><br></p><p>header = {}</p><p>header["User-Agent"] = "safeline"</p><p><br></p><p>bantime = 60</p><p><br></p><p>-- 威胁情报平台地址</p><p>url = "<a href="http://link.zhihu.com/?target=http%3A//xx.xx.xx.xx/query%3FapiKey%3Dxxxxxxxxxxxxxxx%26src%3D%25s" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://</span><span class="visible">xx.xx.xx.xx/query?</span><span class="invisible">apiKey=xxxxxxxxxxxxxxx&amp;src=%s</span><span class="ellipsis"></span></a>"</p><p><br></p><p>match = {</p><p>    ip = "0.0.0.0/0",</p><p>    host    = "<a href="http://link.zhihu.com/?target=http%3A//www.chaitin.cn" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://www.</span><span class="visible">chaitin.cn</span><span class="invisible"></span></a>",</p><p>    urlpath = "/sso",</p><p>    type = skynet.MATCH_TYPE_ALL,</p><p>}</p><p><br></p><p>function action(ip, resp)</p><p>  local banip = {</p><p>      ip = ip,</p><p>  }</p><p>  if string.find(resp, "badboy") ~= nil then</p><p>    safeline.action_ban(banip, bantime)</p><p>  end</p><p>end</p><p><br></p><p>function process(ip, host, urlpath)</p><p>    urltmp = string.format(url, ip)</p><p>        resp, err = safeline.http_get(urltmp, header)</p><p>    action(ip, resp["body"])</p><p>end</p><p><br></p><p>safeline.register(safeline.TYPE_PROCESS, match, process)</p><p>插件运行结果如下图：</p><figure><noscript><img src="https://pic4.zhimg.com/v2-62a170c9a4539505607620c4e4301877_b.jpg" data-caption="" data-size="normal" data-rawwidth="864" data-rawheight="547" class="origin_image zh-lightbox-thumb" width="864" data-original="https://pic4.zhimg.com/v2-62a170c9a4539505607620c4e4301877_r.jpg"></noscript><img src="https://pic4.zhimg.com/v2-62a170c9a4539505607620c4e4301877_b.jpg" data-caption="" data-size="normal" data-rawwidth="864" data-rawheight="547" class="origin_image zh-lightbox-thumb lazy" width="864" data-original="https://pic4.zhimg.com/v2-62a170c9a4539505607620c4e4301877_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-62a170c9a4539505607620c4e4301877_b.jpg"></figure><p><br></p><p>封禁列表如下：</p><figure><noscript><img src="https://pic3.zhimg.com/v2-38d757a6d3dcc8655bde0339e27131be_b.jpg" data-caption="" data-size="normal" data-rawwidth="864" data-rawheight="535" class="origin_image zh-lightbox-thumb" width="864" data-original="https://pic3.zhimg.com/v2-38d757a6d3dcc8655bde0339e27131be_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-38d757a6d3dcc8655bde0339e27131be_b.jpg" data-caption="" data-size="normal" data-rawwidth="864" data-rawheight="535" class="origin_image zh-lightbox-thumb lazy" width="864" data-original="https://pic3.zhimg.com/v2-38d757a6d3dcc8655bde0339e27131be_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-38d757a6d3dcc8655bde0339e27131be_b.jpg"></figure><p><br></p><h2><b>定时任务插件</b></h2><p><b>定时任务插件会周期性的触发，持续输出用户定制的场景化统计分析需求。</b>如某用户了解当前商城的订单情况，并绘制出订单趋势图，可以根据如下思路编写插件：</p><p>1. 注册一个每 10 秒触发一次的回调函数</p><p>2. 在回调函数内统计 10 秒内对订单支付接口的访问情况</p><p>3. 将统计结果推送到监控大屏</p><p>样例插件代码如下：</p><p>local safeline = require "safeline"</p><p><br></p><p>local duration = 10</p><p>-- 每 10 秒调用一次</p><p><br></p><p>local pay = {</p><p>  host = "<a href="http://link.zhihu.com/?target=http%3A//order.chaitin.cn" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://</span><span class="visible">order.chaitin.cn</span><span class="invisible"></span></a>",</p><p>  urlpath = "/pay"</p><p>}</p><p><br></p><p><br></p><p>function tick(dur)</p><p>cnt = safeline.stat_visit(pay, 10)</p><p>safeline.http_post("<a href="http://link.zhihu.com/?target=http%3A//xx.xx.xx.xx/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">http://</span><span class="visible">xx.xx.xx.xx/</span><span class="invisible"></span></a>", {pay = cnt})</p><p>end</p><p><br></p><p>safeline.register(safeline.TYPE_TICKER, duration, tick)</p><h2><b>统计分析插件</b></h2><p><b>雷池 2.0 在原有流量处理引擎的基础上增加了流式流量处理算法，</b>离线统计分析引擎支持以定制化 SQL 语句的方式进行查询和统计，当 SQL 语句产生结果时回调函数会被触发，查询结果会做为参数传入回调函数。这样通过 SQL 将流量运算逻辑语义化，<b>大大改善了统计分析算法的处理效率与实现难度。</b></p><p>雷池内置了常见 CC 攻击防护算法，但是对于敏感业务总会有高级别攻击者为其量身定制 CC 攻击策略。某用户在遭遇 CC 攻击后进行了全面复盘，定位到了业务的脆弱部分，同时也发现了攻击者的攻击思路，总结复盘结果后为了防止此类公司再次发生，该用户需要写雷池插件来长期解决问题。</p><p><b>插件思路如下：</b></p><p>1. 攻击者会发起频率较高的 HTTP Flood</p><p>2. 攻击者会批量使用代理服务器来伪造攻击源 IP</p><p>3. 攻击者会大量访问站点的搜索接口，由于业务特性，该接口会持续消耗服务器计算资源</p><p>4. 被攻击时搜索接口的处理延迟明显增高</p><p><br></p><p>如此复杂的 CC 攻击场景只需要一条 SQL 就可以精准定位攻击者并实施阻断，样例插件代码如下：</p><p>local safeline = require "safeline"</p><p><br></p><p>local query = [[</p><p>        SELECT</p><p>                TUMBLE_WINDOW(timestamp, 1) AS timestamp,</p><p>                ip,</p><p>                COUNT(ip) AS count_ip,</p><p>        FROM access_log</p><p>        WHERE url_path="/search" and time &gt; 0.2</p><p>        GROUP BY timestamp, ip</p><p>        HAVING count_ip &gt; 2000</p><p>        ORDER BY count_ip desc</p><p>]]</p><p><br></p><p>function process(key, rows)</p><p>    for _, r in iparis(rows) do</p><p>        safeline.ban(r["ip"])</p><p>    end</p><p>end</p><p><br></p><p>skynet.register(safeline.TYPE_QUERY, query, process)</p><p><br></p><p><b>此类的业务场景千千万，通过雷池插件进行统计分析可以避免对业务系统频繁改动，实现以极低的成本解决实际场景化的业务安全问题。</b></p><p><br></p><figure><noscript><img src="https://pic4.zhimg.com/v2-88d9ae4cc2e48752c5812d92a7dfe9db_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="608" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic4.zhimg.com/v2-88d9ae4cc2e48752c5812d92a7dfe9db_r.jpg"></noscript><img src="https://pic4.zhimg.com/v2-88d9ae4cc2e48752c5812d92a7dfe9db_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="608" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic4.zhimg.com/v2-88d9ae4cc2e48752c5812d92a7dfe9db_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-88d9ae4cc2e48752c5812d92a7dfe9db_b.jpg"></figure><p><br></p><h2><b>总结</b></h2><p><br></p><p><b>目前，长亭科技已与多家互联网公司、金融机构、大型传统企业达成了战略合作，</b>不断为企业输出安全能力，在辅助企业解决安全问题的同时也累积了大量的场景化业务安全处理经验，并通过流量分析插件为诸多企业解决了实际环境中遇到的场景化安全问题。未来，长亭科技将持续探索前沿技术思路，及时追踪用户反馈，切实为不同类型的企业解决实际遇到的安全难题，以优质的产品和服务为企业安全保驾护航。</p><p><b>更多关于雷池开放平台的细节可以关注： </b></p><p><b><a href="http://link.zhihu.com/?target=https%3A//github.com/chaitin/safeline-open-platform" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/chaitin/safe</span><span class="invisible">line-open-platform</span><span class="ellipsis"></span></a></b></p><p><br></p><h2><b>长亭雷池（SafeLine)</b></h2><p>雷池（SafeLine) 是由长亭科技推出的一款以智能语义分析算法著称的 Web 攻击防护产品，在大幅降低了漏报率和误报率的同时还能保持极高的检测效率，可以为用户提供高质量的 Web 攻击防护、CC 攻击防护、访问控制、防护统计等功能。</p><p>今年 7 月长亭科技发布的雷池（SafeLine） 2.0版本 以 <b>“语义分析”、“轻量级集群”、“高度自定义”</b>为特色，进一步升级核心检测算法，并对传统部署架构发起挑战，支持多种架构及部署方式，以高度自定义的可扩展性为企业防范场景化风险带来价值。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
