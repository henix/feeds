<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>牧云（CloudWalker）开源|如约而至: Webshell核心检测引擎</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/45796590">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-df5924b7082348a33d72d09a043bb848_r.jpg" alt=""></div><p>相关背景阅读：</p><p>7月13日 <a href="https://mp.weixin.qq.com/s/bGeE7WY-2P-SP9QiYeLTVw">《牧云开源的背后》</a>（点击进入）</p><p>9月14日 <a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&amp;mid=2651372030&amp;idx=1&amp;sn=682c49b3decda87ddf0ed641d5d347c6&amp;chksm=8d39c876ba4e4160e88bacf0ffc3cadc39b60a269a6facec9f62134823af829624e42df52376&amp;token=496332164&amp;lang=zh_CN#rd">牧云（CloudWalker）开源手记|Webshell监控检测策略初探</a>（点击进入）</p><img src="https://pic4.zhimg.com/v2-0e4dd5f6883c711d9661a23b9fc6bfab_r.jpg" data-caption="" data-size="normal" data-rawwidth="1725" data-rawheight="416" data-watermark="watermark" data-original-src="v2-0e4dd5f6883c711d9661a23b9fc6bfab" data-watermark-src="v2-6556a6faf0ffdf7daa26510ae5ca1fa6" data-private-watermark-src=""><h2><b>牧云（CloudWalker）服务器安全平台</b></h2><h2><b>核心检测引擎之Webshell检测</b></h2><h2>前言</h2><p>作为主机安全监控扫描的核心功能之一，Webshell 检测一直是令安全运维人员头疼的命题。传统的 Webshell 检测以规则扫描为主，动辄几百上千的服务器，如果要挨个手动排查 Webshell，几乎是不可能完成的任务。</p><p>颠覆以规则扫描为主的传统，牧云瞄准的是全自动、高度智能化的服务器安全平台。因此我们首先从 Webshell 检测引擎开始，以全新的理念重塑之。这正契合长亭一贯的“化繁为简、智能安全”的精益产品理念。</p><blockquote><b>开源计划的第一步：开放命令行版本的 Webshell 检测引擎</b></blockquote><p>本次开源作为开源计划的第一步，仅包含 Webshell 检测引擎部分，重点调优 Webshell 检测效果。目前放出的是一个可执行的命令行版本 Webshell 检测工具。</p><p><br></p><blockquote><b>我们会根据用户反馈，不断优化检测效果。</b><br><br><b>后续三个月，将陆续开放整体产品框架与插件体系。</b></blockquote><h2><b>正文</b></h2><h2><b>Webshell 检测引擎之命令行版本</b></h2><h2><b>检测思路与代码结构</b></h2><p>整个代码入口为一个依赖于 PHP-Ast 插件的 Detector，全部检测工作会在 Detector 内部进行。</p><img src="https://pic4.zhimg.com/v2-44e2f974c8955fe0246129ae469b6e3a_r.jpg" data-caption="" data-size="normal" data-rawwidth="1729" data-rawheight="295" data-watermark="watermark" data-original-src="v2-44e2f974c8955fe0246129ae469b6e3a" data-watermark-src="v2-9afd6bbb264de8c80e3da42b9930c024" data-private-watermark-src=""><p>Detector 结构内部会根据多个不同维度的指标进行评分。这些评分包括认定为恶意样本的正向评分，也包括认定为非恶意样本的负向评分，在保证召回率的同时，使得检测精确率得到稳定控制。</p><img src="https://pic1.zhimg.com/v2-e642830a2230e256d86f26fc90471730_r.jpg" data-caption="" data-size="normal" data-rawwidth="1729" data-rawheight="729" data-watermark="watermark" data-original-src="v2-e642830a2230e256d86f26fc90471730" data-watermark-src="v2-ee81f6984768f4f079af38ffb8c4dead" data-private-watermark-src=""><p>为了减少降维对源数据特征向量的影响，使用多层次进行学习，并在 processor 的最顶层部分合并。</p><img src="https://pic3.zhimg.com/v2-268c12a297c03812bdbd1458f240099b_r.jpg" data-caption="" data-size="normal" data-rawwidth="1729" data-rawheight="355" data-watermark="watermark" data-original-src="v2-268c12a297c03812bdbd1458f240099b" data-watermark-src="v2-550419e06e6785b0e18c2cb37f61d6e6" data-private-watermark-src=""><p>在每个测试用例中，对数据进行多次清洗，并尽可能少地对 Ast 进行遍历，兼顾处理速度和处理精度。</p><img src="https://pic1.zhimg.com/v2-f35426cc7639eee84ac39b926e4468f1_r.jpg" data-caption="" data-size="normal" data-rawwidth="1729" data-rawheight="427" data-watermark="watermark" data-original-src="v2-f35426cc7639eee84ac39b926e4468f1" data-watermark-src="v2-cdfa88e1a0b404f92b29adce7e673b11" data-private-watermark-src=""><img src="https://pic3.zhimg.com/v2-f8ad16ac0435ac4e981a679a038ca69c_r.jpg" data-caption="" data-size="normal" data-rawwidth="1729" data-rawheight="338" data-watermark="watermark" data-original-src="v2-f8ad16ac0435ac4e981a679a038ca69c" data-watermark-src="v2-f1b1ec729ad58a48336bf7fac0e7eeb3" data-private-watermark-src=""><p>整体代码的层次结构如下图所示：</p><img src="https://pic3.zhimg.com/v2-ded94ee12fb2a6dd6ff59ea5154579d0_r.jpg" data-caption="" data-size="normal" data-rawwidth="902" data-rawheight="813" data-watermark="watermark" data-original-src="v2-ded94ee12fb2a6dd6ff59ea5154579d0" data-watermark-src="v2-6bde47f5cbb5a3a8036f281809c7c796" data-private-watermark-src=""><h2><b> GitHub获取地址</b></h2><p><a href="http://github.com/chaitin/cloudwalker">Http://github.com/chaitin/cloudwalker</a></p><h2><b>检测界面和 HTML 报告</b></h2><img src="https://pic1.zhimg.com/v2-36b3d8ca7f107c4f0f744296d84fcf72_r.jpg" data-caption="" data-size="normal" data-rawwidth="1729" data-rawheight="973" data-watermark="watermark" data-original-src="v2-36b3d8ca7f107c4f0f744296d84fcf72" data-watermark-src="v2-d58aefaff2167af4f63f86746f03fb7b" data-private-watermark-src=""><h2><b>测试演示</b></h2><p>命令行 gif 演示：<a href="http://g.recordit.co/nVfELJPZIP.gif">http://g.recordit.co/nVfELJPZIP.gif</a></p><img src="https://pic3.zhimg.com/v2-44c292265d2da9286b81ed40f469794e_r.jpg" data-caption="" data-size="normal" data-rawwidth="913" data-rawheight="947" data-watermark="watermark" data-original-src="v2-44c292265d2da9286b81ed40f469794e" data-watermark-src="v2-c58a3ac8e69322be7aa5451a2c54b04a" data-private-watermark-src=""><p>HTML 报告 gif 演示：<a href="http://g.recordit.co/HCbHc9yq3o.gif">http://g.recordit.co/HCbHc9yq3o.gif</a></p><img src="https://pic4.zhimg.com/v2-da6d14b0dc132086e4a5f7fae14f70e4_r.jpg" data-caption="" data-size="normal" data-rawwidth="1177" data-rawheight="930" data-watermark="watermark" data-original-src="v2-da6d14b0dc132086e4a5f7fae14f70e4" data-watermark-src="v2-4e8d01abf52b63f0ddc3540340016520" data-private-watermark-src=""><p><br></p><h2>使用环境要求</h2><ul><li>主流 Linux 发行版（内核不能太老，至少 2.6.32，否则会由于 Go 语言不支持直接打印 FATAL: kernel too old）</li><li>MacOS 可自行编译</li><li>Windows 暂不支持</li></ul><h2><b>可执行文件使用方法</b></h2><p>用户可以直接运行可执行文件，参数可以是单个文件或目录（软链接）。对于目录会进行递归检测，但是不会跟进软链接。用户可用 `-output` 选项将检测结果导出到文件，推荐添加 `-html` 选项使用 HTML 文档格式进行导出。</p><img src="https://pic4.zhimg.com/v2-2eef04b659cab8056346ff0a25cd0479_r.jpg" data-caption="" data-size="normal" data-rawwidth="1164" data-rawheight="428" data-watermark="watermark" data-original-src="v2-2eef04b659cab8056346ff0a25cd0479" data-watermark-src="v2-e3abd74f1adbcfcf2a72138d1da00460" data-private-watermark-src=""><h2><b>手动编译使用方法</b></h2><p>用户可以在 `/php` 目录中执行 `make` 编译 PHP-Ast 解析插件，之后进入 `/bin` 目录使用 `go build` 编译程序主体，待编译完成后该目录下运行可执行文件。</p><p><br></p><h2><b>后记</b></h2><p>牧云（CloudWalker）的方向是基于Agent的深度服务器工作负载安全平台，在云计算技术发展的大语境下，给混合云的复杂环境提供一个不同的、从内部进行观察的安全视角，提升资产能见度并有效防御入侵。根据项目计划会逐步覆盖服务器资产管理、威胁扫描、Webshell 查杀、基线检测等各项功能。</p><p>牧云（CloudWalker）开源计划也将秉持自由、共享的开源精神，持续营造社区。希望更多朋友参与进来，共同打造出具有更强大功能和更人性的管理思路的牧云（CloudWalker）。</p><p>长亭科技也是一个长期致力开源社区的网络安全企业，其他系列开源工具，了解一下：</p><p>https://github.com/chaitin/passionfruit 是iOS应用逆向与分析工具，可以大大加速iOS应用安全分析过程；</p><p>https://github.com/chaitin/yanshi 是长亭雷池（SafeLine）下一代Web应用防火墙核心引擎使用到的代码生成工具。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
