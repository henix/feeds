<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>手把手教你用Rust写Proxy，开坑篇</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/90459884">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-7fa14b9260bcffa27fa35165f6610eab_b.jpg" alt=""></div><p>项目地址 [rust-miniproxy](<a href="https://link.zhihu.com/?target=https%3A//github.com/importcjj/rust-miniproxy" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/importcjj/ru</span><span class="invisible">st-miniproxy</span><span class="ellipsis"></span></a>)</p><p>使用Rust 1.39.0实现的简易代理，同时支持HTTP，HTTPS和SOCKS5协议。本项目仅用于学习交流。</p><h2>如何编译</h2><p>首先安装Rust，如何安装请移步<a href="https://link.zhihu.com/?target=https%3A//www.rust-lang.org/learn/get-started" class=" wrap external" target="_blank" rel="nofollow noreferrer">官网</a> 注意由于需要使用async/await，所以需要指定rust版本为1.39(stable)</p><div class="highlight"><pre><code class="language-text">cargo build --release</code></pre></div><p>默认开启TCP加速，使用<a href="https://link.zhihu.com/?target=https%3A//github.com/importcjj/gkd-rs" class=" wrap external" target="_blank" rel="nofollow noreferrer">gkd-rs</a>提供加速功能。 可在编译时使用--no-default-features关闭加速功能。</p><p>二进制文件会在项目目录的target/release文件夹下，找到两个名为<code>minilocal</code>和<code>miniserver</code>的二进制文件即可。关于如何交叉编译，请自行搜索。不过我自己在macbook上交叉编译就没成功过。</p><h2>如何使用</h2><p>本代理分为两部分：<code>minilocal</code>和<code>miniserver</code>。<code>miniserver</code>运行于网络服务器上，<code>minilocal</code>运行于本地。</p><p>a. 先在服务器上部署<code>miniserver</code>，启动的时候会随机产生一个base64编码的密码</p><div class="highlight"><pre><code class="language-text">RUST_LOG=mini=info ./miniserver -h 0.0.0.0 -p 59999 -d</code></pre></div><p>b. 然后在本地启动<code>minilocal</code>，需要指定server的通讯密码</p><div class="highlight"><pre><code class="language-text">RUST_LOG=mini=info ./minilocal -s &#34;xxx.xx.xx.xx:59999&#34; -p 9998 -P xxxxxx</code></pre></div><p>c. 进行系统代理设定，代理地址为<code>127.0.0.0:9998</code>，或者也可以设置自动代理，PAC文件地址为<code>http://127.0.0.1:9998/pac</code>。本代理同时支持HTTP，HTTPS和SOCKS5协议</p><h2>原理</h2><h2>什么是代理?</h2><p>客户端与服务器之前通讯时，需要经过中间的网络终端中转，这个中间的服务器就是代理服务器。</p><h2>代理的功能?</h2><blockquote>以下内容摘自网络百科</blockquote><p>提供代理服务的计算机系统或其它类型的网络终端称为代理服务器（英文：Proxy Server）。一个完整的代理请求过程为：客户端首先与代理服务器创建连接，接着根据代理服务器所使用的代理协议，请求对目标服务器创建连接、或者获得目标服务器的指定资源（如：文件）。在后一种情况中，代理服务器可能对目标服务器的资源下载至本地缓存，如果客户端所要获取的资源在代理服务器的缓存之中，则代理服务器并不会向目标服务器发送请求，而是直接传回已缓存的资源。一些代理协议允许代理服务器改变客户端的原始请求、目标服务器的原始响应，以满足代理协议的需要。代理服务器的选项和设置在计算机程序中，通常包括一个“防火墙”，允许用户输入代理地址，它会遮盖他们的网络活动，可以允许绕过互联网过滤实现网络访问。</p><p>代理服务器的基本行为就是接收客户端发送的请求后转发给其他服务器。代理不改变请求URI，会直接发送给前方持有资源的目标服务器。</p><h2>代理协议有哪些？</h2><p>本系列中只涉及几种常用的协议</p><ul><li>SOCKS5</li><li>HTTP代理</li><li>HTTPS代理</li></ul><h2>这些代理协议存在什么问题？</h2><p>这些代理协议在通讯或者建立通讯的时候存在明文传输的情况，所以使用时可能会被网络提供者监测。这样的话就存在一定的隐私泄露问题。比如你通过HTTPS代理服务器访问pornhub时，由于浏览器会先发出一个CONNECT请求，报文内容中会包含pornhub服务器的地址。网管就会知道你在逛什么网站了。</p><p>那么该如何解决这一问题呢？有人就提出将代理服务器分成两部分，程序A运行在用户本地，它支持常规的代理协议，另一部分程序B运行在我们的服务器上。A和B之间的通讯采用我们自己定义的协议及加密方式。这样一来我们的网络访问请求将变得非常隐秘，不容易被识别。</p><p>综上所述，整个代理结构如下:</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-57071cb35d69a3d8b8e4aafddedee092_b.jpg" data-caption="" data-size="normal" data-rawwidth="855" data-rawheight="393" class="origin_image zh-lightbox-thumb" width="855" data-original="https://pic3.zhimg.com/v2-57071cb35d69a3d8b8e4aafddedee092_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-57071cb35d69a3d8b8e4aafddedee092_b.jpg" data-caption="" data-size="normal" data-rawwidth="855" data-rawheight="393" class="origin_image zh-lightbox-thumb lazy" width="855" data-original="https://pic3.zhimg.com/v2-57071cb35d69a3d8b8e4aafddedee092_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-57071cb35d69a3d8b8e4aafddedee092_b.jpg"/></figure><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
