<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>使用 Tendermint 开发自己的链</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/48821038">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-f49d42ebdfbf142db1b350bd7fd1ba7e_r.jpg" alt=""></div><p>（这是 1024 节写的文章，时间线以 1024 前后为准）</p><p>前两周上线了我们为 Cybermiles 提供的 supernode，因为 Cybermiles 主网使用了 Tendermint，于是上周便研究了一下 Tendermint，边学边写了个 slides 介绍 Tendermint。</p><p>Tendermint 是一个脱胎于 PBFT 的 consensus engine，并在此之上构建了一个 Appliation BlockChain Interface (ABCI)，让 blockchain 的开发者可以关注于如何提供服务，以及维系服务的状态，而把如何达成共识，如何管理 mempool，如何进行安全的 p2p 通讯这样的琐事交给 Tendermint 来处理。Tendermint 自身是 golang 撰写的，其 ABCI 接口用 protobuf 实现，并使用 raw TCP 或者 http2 (gRPC) 和 application layer 通讯。</p><p><br></p><img src="https://pic3.zhimg.com/v2-7a34bf6c6882df480118044dd4f282ba_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="910" data-watermark="watermark" data-original-src="v2-7a34bf6c6882df480118044dd4f282ba" data-watermark-src="v2-2d5156ad3d668a756accafabefba34d6" data-private-watermark-src=""><p><br></p><p>周日，闲来无事，想用 tendermint 做点东西。无奈 tendermint 没有提供 elixir 的 ABCI 实现，社区的 erlang 实现又缺失一些东西，且我很不喜欢 erlang 下用 Record 来描述 protobuf 的方式，于是用 Tony 的 protobuf 库，写了个 elixir 的 ABCI 实现，放在 github.com/arcblock/ex_abci 上，并随后实现了 Tendermint 自身提供的 counter example app - 用区块链的不可篡改性来维护一个全网唯一的计数器。</p><p>使用 ex_abci，counter app 的核心代码也就几十行，就是实现 info，check_tx，deliver_tx 几个接口即可：</p><img src="https://pic1.zhimg.com/v2-ac8401876804a94f7ca99c97f9c3f8dc_r.jpg" data-caption="" data-size="normal" data-rawwidth="1033" data-rawheight="1015" data-watermark="watermark" data-original-src="v2-ac8401876804a94f7ca99c97f9c3f8dc" data-watermark-src="v2-0b09e0d77e071c5a128b59966766fff0" data-private-watermark-src=""><p><br></p><p>这样的 app 当 hello world 还可以，用来验证 Tendermint 是否靠谱，本身并不靠谱。Tendermint 还提供了一个 kv store 的 example，也没有 get 到区块链的核心要素，于是我便萌生了搞一个足够简单，最好能在几百行内演示区块链技术的 Simple Chain。那什么算是区块链的核心要素呢，我觉得是这幅图 - Merkle Patricia Tree (MPT)：</p><p><br></p><img src="https://pic1.zhimg.com/v2-8bd68bc480907702264be223b7be41d7_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="763" data-watermark="watermark" data-original-src="v2-8bd68bc480907702264be223b7be41d7" data-watermark-src="v2-70b4756d4121554ffdb40baf1a9557eb" data-private-watermark-src=""><p><br></p><p>这是以太坊保存其 World State 的核心 - 我相信我的读者们了解 patricia tree (prefix tree, radix tree, 或者叫 trie)，有一些区块链知识的读者应该知道 merkle tree，MPT 结合二者，组织出一个自带验证的 persistent data structure（函数式编程语言保存 list / map 的方式），关于 MPT 和以及上图，我们的工程师丁沛灵同学在上次北京 Hackathon 有一个精彩的讲座，感兴趣的同学可以去 youtube arcblock channel 上找：ArcBlock’s Introduction to Blockchain，在 37 分钟附近开始讲 MPT，大约 10 分钟，非常之深入浅出。篇幅有限，我这里就不详细展开。</p><p>关于 Simple Chain，产品上我是这么考虑的：</p><ol><li>账号系统兼容以太坊</li><li>完整使用 Tendermint 的全部接口，并探索它们的意义</li><li>chain 的状态使用 MPT 保存，并将每个 block commit 后的 state root 提交给 Tendermint</li><li>chain 能够具有基本的容错 - 比如 tx 执行到一半，crash 了，可以恢复到上一个 block 的 state 继续往下执行</li><li>Transaction 使用简化版本的 Ethereum tx，一个 TX 只包含 from, to, nonce, total 和 pub key</li><li>MPT 里保存类似 Ethereum 的 account，每个 account 有自己的 balance，nonce 和 num_txs</li><li>client RPC 直接整合在 Wallet 模块里，方便演示</li></ol><p>花了两天的功夫，一个粗糙的，未经过多节点测试的版本终于实现了，源码见：ex_abci/examples/simple_chain。我们谈谈其主要对外接口：</p><ol><li>Wallet.new: 生成离线账号</li><li>Wallet.declare: 每个 Wallet 第一次可以让系统给自己打 10000 个 token，这个主要方便测试</li><li>Wallet.transfer：一个账户给另一个账户打钱。两方的 address 对应的 account 会在 chain 的 MPT 里更新，每个 block commit 之后，MPT root，也就是 app state 会写入 block header。</li><li>Wallet.info / Wallet.chain_info：访问 account 的信息 / chain 的信息</li></ol><p>下面是运行时的整个过程。</p><p>初始化：</p><p><br></p><img src="https://pic1.zhimg.com/v2-6b7bef4eaaab05d89ceee14925245b44_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="399" data-watermark="watermark" data-original-src="v2-6b7bef4eaaab05d89ceee14925245b44" data-watermark-src="v2-958e75aa1074a94bafdb8c9b291f435a" data-private-watermark-src=""><p><br></p><p>Wallet 状态：</p><p><br></p><img src="https://pic3.zhimg.com/v2-b3e684a14ebef8c4500a7f840c121872_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="425" data-watermark="watermark" data-original-src="v2-b3e684a14ebef8c4500a7f840c121872" data-watermark-src="v2-eff42e9aba2e7b0cf43b5346c7eb5cdc" data-private-watermark-src=""><p><br></p><p>转账：</p><p><br></p><img src="https://pic4.zhimg.com/v2-452de83ffae5efe7552e8ccbe66730b5_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="638" data-watermark="watermark" data-original-src="v2-452de83ffae5efe7552e8ccbe66730b5" data-watermark-src="v2-c5131ce9e0538611afdda9f9a3af4c77" data-private-watermark-src=""><p><br></p><p><br></p><img src="https://pic3.zhimg.com/v2-ef5828e115f07797008b3f08f4b635a7_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="1070" data-watermark="watermark" data-original-src="v2-ef5828e115f07797008b3f08f4b635a7" data-watermark-src="v2-5190c6a0db69ba1e7a205943d3345456" data-private-watermark-src=""><p><br></p><p><br></p><img src="https://pic4.zhimg.com/v2-b70278b546420f6935120f614efd829a_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="623" data-watermark="watermark" data-original-src="v2-b70278b546420f6935120f614efd829a" data-watermark-src="v2-56354152c62f15c9b02cf24e82fc8359" data-private-watermark-src=""><p><br></p><p>Tendermint block:</p><p><br></p><img src="https://pic4.zhimg.com/v2-93b2be74e5c2cab7d74ae49ab15e02b1_r.jpg" data-caption="" data-size="normal" data-rawwidth="1022" data-rawheight="642" data-watermark="watermark" data-original-src="v2-93b2be74e5c2cab7d74ae49ab15e02b1" data-watermark-src="v2-563feca3eb32540d3d1df202f20ac9bc" data-private-watermark-src=""><p><br></p><p>转账结束后的状态：</p><p><br></p><img src="https://pic4.zhimg.com/v2-52ea92306e747934f53b6bff70c43ee4_r.jpg" data-caption="" data-size="normal" data-rawwidth="715" data-rawheight="112" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p><br></p><p>这个 Simple Chain 主要使用到的技术：</p><ol><li>Tendermint 和 ex_abci，这是自然</li><li>Elixir 下的 MPT 实现：merkle_patricia_tree</li><li>Tony 的 protobuf 实现。我们在 MPT 里存储 account，其 value 也是用 protobuf 定义的</li><li>keccakf1600：ethereum 的 sha3 的实现，用来产生 account address 和各种需要 hash 的场合（注意，我们这里并没有使用 double hash）</li><li>libsecp256k1：ECDSA 的实现，主要用来生成 wallet，以及 transaction 的 sign 和 verify</li></ol><p>目前代码量在 400 行内，基本上一目了然，用来理解 Tendermint 和区块链技术的基本逻辑再好不过。感兴趣的读者可以安装 tendermint，下载 <a href="http://github.com/arcblock/ex_abci">github.com/arcblock/ex_abci</a> 尝试。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
