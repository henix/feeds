<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ABT network 部署记</title>
</head>
<body>
<p><a href="https://mp.weixin.qq.com/s?timestamp=1563045201&amp;src=3&amp;ver=1&amp;signature=RgE3tzerfWydduIiOwscBgiOq0LLVHa0fOKfk4*bOYI2YpxawWHVMKMQW8zLTItl9TWD36OJ9cjJpOgnPxPNAz-hSKTHedWGFTVmdrwRPkYMBE4RUdLhdHO9R0sCM*DKorFBR6imBQ6zzMJJ1t4gS4*JKSMpzJYHs5YNI*yHuoc=">原文</a></p>
<div id="js_top_ad_area" class="top_banner"></div><div class="rich_media_inner">

        
        
        <div id="page-content" class="rich_media_area_primary">
          <div class="rich_media_area_primary_inner">
                                    
                        

            <div id="img-content">

                
                <h2 class="rich_media_title" id="activity-name">
                    
                    
                    ABT network 部署记

                                                                                </h2>
                <div id="meta_content" class="rich_media_meta_list">
                                                            <span id="copyright_logo" class="rich_media_meta rich_media_meta_text meta_tag_text">原创：</span>
                                                            <span class="rich_media_meta rich_media_meta_text">
                                                <span id="js_author_name" class="rich_media_meta_link" data-rewardsn="" data-timestamp="" data-canreward="0">陈小天</span>
                                            </span>
                                        
                                                                                                            <span class="rich_media_meta rich_media_meta_nickname" id="profileBt">
                      <a href="javascript:void(0);" id="js_name">
                        程序人生                      </a>
                      <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                          <div class="profile_inner">
                              <strong class="profile_nickname">程序人生</strong>
                              <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                              <p class="profile_meta">
                              <label class="profile_meta_label">微信号</label>
                              <span class="profile_meta_value">programmer_life</span>
                              </p>

                              <p class="profile_meta">
                              <label class="profile_meta_label">功能介绍</label>
                              <span class="profile_meta_value">十年漫漫程序人生，打过各种杂，也做过让我骄傲的软件；管理过数十人的团队，还带领一班兄弟姐妹创过业，目前在硅谷一家创业公司担任 VP。关注程序人生，了解程序猿，学做程序猿，做好程序猿，让我们的程序人生精彩满满。</span>
                              </p>
                              
                          </div>
                          <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                              <i class="profile_arrow arrow_out"></i>
                              <i class="profile_arrow arrow_in"></i>
                          </span>
                      </div>
                    </span>


                    <em id="publish_time" class="rich_media_meta rich_media_meta_text"></em>





                </div>
                
                
                
                
                                                
                                                                
                                
                
                <div class="rich_media_content " id="js_content">
                    

                    

                    
                    
                    <section class="level2" style='color: rgb(0, 0, 0);font-family: -apple-system, "SF UI Text", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif, "Helvetica Neue", Helvetica, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);'><h2 style="margin-top: 38px;margin-bottom: 10px;font-weight: bold;-webkit-font-smoothing: subpixel-antialiased;cursor: text;font-size: 24px;border-bottom: 2px solid rgb(0, 179, 139);color: rgb(0, 179, 138);height: 57px;line-height: 62px;display: inline-block;">题记</h2><p style="margin-right: 10px;margin-bottom: 20px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">两天前，也就是 3 月 29 日，ABT network 正式发布。ABT network 以完全去中心化方式连接编织多条区块链形成的网络，以云节点和织链为网的方式重新定义了新一代区块链基础架构。本文谈谈 ABT network 诞生前发生的有趣经历。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">为方便阅读，先简单介绍一下本文谈到的一些概念：</p><ul style="" class=" list-paddingleft-2"><li><p><span style="font-size: 15px;">ABT network：多条使用 ArcBlock 技术打造的区块链形成的网路。</span></p></li><li><p><span style="font-size: 15px;">ABT </span><span style="font-size: 15px;">chain</span><span style="font-size: 15px;"> node：ArcBlock 使用 forge framework 打造的区块链节点软件。</span></p></li><li><p><span style="font-size: 15px;">Forge framework：ArcBlock 为区块链开发打造的框架，可以看做区块链世界里的 Ruby on Rails。</span></p></li></ul></section><section class="level2" style='color: rgb(0, 0, 0);font-family: -apple-system, "SF UI Text", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif, "Helvetica Neue", Helvetica, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);'><h2 style="margin-top: 38px;margin-bottom: 10px;font-weight: bold;-webkit-font-smoothing: subpixel-antialiased;cursor: text;font-size: 24px;border-bottom: 2px solid rgb(0, 179, 139);color: rgb(0, 179, 138);height: 57px;line-height: 62px;display: inline-block;">打造人人都可部署的节点</h2><p style="margin-right: 10px;margin-bottom: 20px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">在开发 Forge framework 和 ABT chain node 时，我们有一个深深的信念：运行在 Forge 之上的区块链项目可以是阳春白雪，也可以是下里巴人；可以是每日千百万级 transaction 的大型应用，也可以是独立开发者及其小圈子的自娱自乐。因而，一个节点只要有过得去的算力，就可以运行 Forge，这样，只要愿意，人人都可以部署自己可负担的节点。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">那什么算是「过得去的算力」呢？考虑到 app 开发者的开发期的经济能力，我们将其定位在单节点月支出在 $15 以内，在 Digital Ocean 上，这对应：</p><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="0.43046875" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/SER9L29WQ0ibwd4ZomMcNo1XVSC6IkONNOGqHgxSkvsIYjAU8aKDdbLuecEa1KfzVHySV0La49OGpsQGmbOuD4w/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" style=""></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">也就是 1GB / 1CPU / 25GB disk 一路到 2GB / 2CPU / 60GB disk 的乞丐版云主机。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">在今年一二月份的大部分开发时间里，我们都在使用 $5 的至尊乞丐版主机 —— 而且，我们一口气在美西 (SF)，美东 (NY)，西欧 (London) 和东南亚 (Singapore) 部署了四个节点，组成一个 p2p 网络，来开发 Forge。我们相信，极端恶劣的环境，能打造尽可能健壮的软件，让各种问题都提前暴露出来。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">有了环境，我们需要有足够模拟真实应用场景的流量。为此我们开发了一个 simulator，并且做了一个简单的描述语言来描述我们如何开启 simulation（节选）:</p><section class="code-snippet__fix code-snippet__js"><ul class="code-snippet__line-index code-snippet__js"><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li><li></ul><pre class="code-snippet__js" data-lang="properties"><code><span class="code-snippet_outer"><span class="code-snippet__attr">pools</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">account_migrate</span>: <span class="code-snippet__string">5</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">create_asset</span>: <span class="code-snippet__string">5</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">declare</span>: <span class="code-snippet__string">5</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">exchange</span>: <span class="code-snippet__string">5</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">transfer</span>: <span class="code-snippet__string">10</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">update_asset</span>: <span class="code-snippet__string">5</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">consume_asset</span>: <span class="code-snippet__string">5</span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">poke</span>: <span class="code-snippet__string">5</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">meta</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__attr">tick</span>: <span class="code-snippet__string">500</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">simulations</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__meta">-</span> <span class="code-snippet__string">name: exchange token and assets</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">interval</span>: <span class="code-snippet__string">2</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">num</span>: <span class="code-snippet__string">2</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">type</span>: <span class="code-snippet__string">exchange</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">settings</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">      <span class="code-snippet__attr">value</span>: <span class="code-snippet__string">"1000..20000"</span></span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer">  <span class="code-snippet__meta">-</span> <span class="code-snippet__string">name: transfer token and assets</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">interval</span>: <span class="code-snippet__string">5</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">num</span>: <span class="code-snippet__string">2</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">type</span>: <span class="code-snippet__string">transfer</span></span></code><code><span class="code-snippet_outer">    <span class="code-snippet__attr">settings</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">      <span class="code-snippet__attr">value</span>: <span class="code-snippet__string">"1000..5000"</span></span></code><code><span class="code-snippet_outer">      <span class="code-snippet__attr">after</span>:<span class="code-snippet__string"></span></span></code><code><span class="code-snippet_outer">        <span class="code-snippet__meta">-</span> <span class="code-snippet__string">interval: 1</span></span></code><code><span class="code-snippet_outer">          <span class="code-snippet__attr">action</span>: <span class="code-snippet__string">consume_asset</span></span></code></pre></section><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">通过改变 pool size，我们可以调节并发程度，通过控制 tick，我们控制 traffic 的速率；通过添加更多的 simulation，我们改变 traffic 的多样性。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">在 simulator 的作用下，很长一段时间里，我们的开发网络三天两头 crash —— 一会 out of memory，一会 too many open files，一会 gen_server tiemout，一会 tcp send/receive buffer full。这些问题，如果换上个 4G memory / 4 CPU / 100G disk 的主机，只有很小的概率才暴露出来，而我们主动让其发生在开发环境中，使得大部分问题得到了妥善处理。比如说，我们发现我们使用的 consensus engine 不稳定，时不时 crash，crash 之后很容易把 state db 写坏，使得节点彻底崩溃，无法恢复。对此，我们的做法是，一旦 consensus engine crash，我们让 Forge 自动 crash（可惜了 erlang VM 强大的 crash recover 机制），然后由我们开发的 forge starter 将 forge 重启。重启后，我们回溯到上一个区块的数据，重新 apply，如果 consensus engine 可以恢复，那么旧继续往后走；否则便继续 crash 和继续回溯。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">在这样严苛的环境下 Forge 逐渐成长，至尊乞丐节点组成的网络，不断死亡，不断重生，就像「明日边缘」里的汤姆克鲁斯，从小白一路成长为小强，迎来了第一百万个 transaction。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">好景不长，在大约 1.5M txs 时，网络再次 crash：</p><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="0.6140625" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/SER9L29WQ0ibwd4ZomMcNo1XVSC6IkONNm89vg6vcljWNF4iaxBia0tUqTBTGjnLa9rMPGzOSa1ggu6qRprmzBqhg/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" style=""></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">这次 crash 的一干二净，所有节点全军覆没，连 ssh 都上不去。Digital Ocean 的监控显示 CPU 基本为 0，正琢磨着是不是 disk 写满了，一台机器回光返照，给我登上去 du 的机会。果然，25G 的 disk 被吃得一干二净。take snapshot，换大硬盘，搞定。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">三月上旬我们终于抛弃了 $5 的机器，换装 $15 的「大」节点。在 Digital Ocean 的云上，我们同时跑了好几个网络，做 rolling upgrade。之前我们一周一个 milestone，出一个大版本，若干小版本，三月第二周起，我们每天出一个版本，因而，版本太多而网络不够用了。。。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">很快，1 million txs 的里程碑被 5 million 取代：</p><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="1.0359375" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/SER9L29WQ0ibwd4ZomMcNo1XVSC6IkONNeTpIfc3Cjibz9xc2v9xJ65nzcSe8kD3C9z6CBaicftxiaufYrRHuufpBg/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" style=""></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">继而被 6M，7M，… 取代。后来我们 breaking change 太多，也就没有继续累积这个数字。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">可以让区块链节点稳定地在 $15 的机器上部署是我们 ArcBlock 的一个创举。我们做过别的公链的节点 —— 对方给出的推荐配置，一个节点一个月要一千多美金。如果一个应用开发者开发者，想部署一个自己的链，初期通过自己的节点来服务其用户，假设节点部署在全球四个区域：每个区域两个节点，那单单是这样一笔开销，就超过上万美金每月 —— 没有充沛现金的小玩家，是烧不起这个钱的。所以我们希望这个数字能够低至几百。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">然而 Digital Ocean 毕竟是服务于小客户的，一个严肃的 dApp，在开发阶段使用 DO 无可厚非，在生产环境 —— 当链上线之后，更具实力的云服务是更好的选择，比如我们自己的 ABT network 就部署在 aws。</p></section><section class="level2" style='color: rgb(0, 0, 0);font-family: -apple-system, "SF UI Text", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif, "Helvetica Neue", Helvetica, Arial, sans-serif;font-size: 16px;text-align: start;white-space: normal;background-color: rgb(255, 255, 255);'><h2 style="margin-top: 38px;margin-bottom: 10px;font-weight: bold;-webkit-font-smoothing: subpixel-antialiased;cursor: text;font-size: 24px;border-bottom: 2px solid rgb(0, 179, 139);color: rgb(0, 179, 138);height: 57px;line-height: 62px;display: inline-block;">简约而不简单的生产环境</h2><p style="margin-right: 10px;margin-bottom: 20px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">由于 ABT network 强调织链为网，我们首发三条以化学元素「氩（Argon）」「溴（Bromine）」「钛（Titanium）」命名的元素链（其中 Bromine 是一条专门运行最新 nightly build 版本的测试链）。因而我们需要为这三条链准备安全可信的生产环境。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">我们是这样考虑线上的生产环境的：</p><ol type="1" style="" class=" list-paddingleft-2"><li><p><span style="font-size: 15px;">每条链都部署到亚太欧美四个区域；</span></p></li><li><p><span style="font-size: 15px;">Argon 和 Titanium 各十六个节点；Bromine 四个节点</span></p></li><li><p><span style="font-size: 15px;">所有节点都只对外暴露 p2p 端口；</span></p></li><li><p><span style="font-size: 15px;">节点的 GraphQL RPC 和自带的区块浏览器通过 ELB 允许外部访问，而 gRPC 只允许本地访问；</span></p></li><li><p><span style="font-size: 15px;">每个 region，每条链的 ELB 的域名，由 route 53 按照 latency 来 load balancing。</span></p></li></ol><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">最重要的，要自动化，要足够省钱。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">自动化，这个不消说，我们已经有深厚的 ansible / terraform 经验。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">省钱是个学问。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">按照上面的配置，哪怕只用物美价廉的 c4.large / c5.large，每个节点配 110G EBS，每条链每个区域都配一个 ELB，一个月下来光固定成本就要 $3721。</p><blockquote style="margin-top: 15px;margin-bottom: 15px;border-left-width: 4px;border-left-color: rgb(221, 221, 221);padding-top: 0px;padding-right: 15px;padding-left: 15px;color: rgb(119, 119, 119);"><p style="margin-right: 10px;margin-left: 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">计算公式： 0.11 (c4.large 价格) x 36 x 24 x 31 + 36 x 110 x 0.12 (EBS 价格) + 25 (ELB 价格) x 12</p></blockquote><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">这其中，EC2 占了大头，接近 $3000。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">我们的目标，是尽可能降低这个成本。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">于是我们的目光投向了 spot instance。下图是 spot instance 在 us-east-2 和 ap-southeast-1 的价格走势：</p><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="0.60078125" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/SER9L29WQ0ibwd4ZomMcNo1XVSC6IkONNMKLKsiaaGA9JFOgT0yMjR6iafaHhud1x5TFzGIG7r1kFeQSJEZnDM2KA/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" style=""></p><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="0.6046875" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/SER9L29WQ0ibwd4ZomMcNo1XVSC6IkONNvukwfPMbetN1S4fp93OlKibvLxBbCEhlKRZew3ZRlJibY5EDH1uwxT1w/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" style=""></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">价格基本稳定在 on-demand instance 的 2 折，也就意味着 EC2 这块，我们可以把成本降到 $600，总价只需 $1300 每月。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">然而用 spot instance，绕不过去的坎就是万一 instance 被杀掉，如何尽快恢复服务？尤其是验证人节点？</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">我们采用的方式是 root disk 和 data disk 分离，Forge 存储的所有数据放 data disk，而 Forge 的配置，节点私钥，验证人私钥，放 root disk，然后在初始化之后备份到一个 AES 加密的，只允许单次写的 S3 bucket 中。之后，在节点运行的时候，每条链每个区域定期备份某一个健康节点的 data disk。这样，当验证人节点被杀掉时，我们可以从最近的一个备份中恢复 data disk，然后从 S3 中找回该验证人节点的私钥和配置。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">这个思路说起来挺简单直观，做起来可要颇费一番心思的。不过最终我们趟平了这条路，证明了它是可行的，对 dApp 开发者，甚至其他区块链的同行，这种使用 spot instance 运行区块链节点的方式都有借鉴意义。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">最终我们的部署脚本 forge-deploy 分成四部分：</p><ol type="1" style="" class=" list-paddingleft-2"><li><p><span style="font-size: 15px;">只需要一次性运行的脚本：比如为每个区域每个 VPC 创建 security group</span></p></li><li><p><span style="font-size: 15px;">制作 Forge AMI 的脚本：我们每 release 一个新的版本，都会创建一个新的 AMI。</span></p></li><li><p><span style="font-size: 15px;">创建一条新链所需要的资源的脚本：比如创建 spot request，EBS，创建 ELB，target group，设置 listener (及 listener rules)，创建域名及域名解析的 policy。</span></p></li><li><p><span style="font-size: 15px;">管理一条已有链的脚本：比如初始化链，重启节点，升级节点，修复损坏的节点，添加新的节点等</span></p></li></ol><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">三月的最后两周，forge-deploy 在原有零散脚本（部署 DO 机器的脚本）的基础上边开发边测试 —— 我们的链建了拆，拆了建，两周趟过了很多区块链团队可能一年都没有趟过的路：最多的时候我们有 6 条链并行运行，算上那些朝生暮死的 abtchain，origin，bigbang，test，abc 等链，我们前前后后创建了和销毁了三十多条链 —— 注意，这里说的是多区域多节点的链，单个节点的链并不包含在内。</p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">由于之前累积了足够的自信，在 ABT network 上线的那一天，我们自负地把之前为发布已经创建好的三条链：Argon，Bromine 和 Titanium 在上线倒计时前不到半小时拆掉重新发布，让整个团队和社区关心我们的人可以看到区块从零到一的跃迁。虽然中间有点波折 —— 部署脚本运行得比预想要慢一些 —— 因而在发布倒计时结束后我们还没有部署完成，但最终，耽搁了大约二十分钟，三条链还是如愿上线。每条链的部署只需要两条命令：</p><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="0.2140625" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/SER9L29WQ0ibwd4ZomMcNo1XVSC6IkONNTvMNvj7SqO2iaw018EZcWiabZGhib1AMcKoTXyicNCMliaFZTIxtN7Y5V1g/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" style=""></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">其中，create_fleet 会在四个区域里都做这些事情：</p><ol type="1" style="" class=" list-paddingleft-2"><li><p><span style="font-size: 15px;">获取当前区域的 default VPC id</span></p></li><li><p><span style="font-size: 15px;">获取 VPC 的 subnet id</span></p></li><li><p><span style="font-size: 15px;">获取预先创建好的几个 security group 的 id</span></p></li><li><p><span style="font-size: 15px;">用预设的配置为验证人节点申请 spot fleet</span></p></li><li><p><span style="font-size: 15px;">用预设的配置为哨兵节点申请 spot fleet</span></p></li><li><p><span style="font-size: 15px;">等待所有申请好的 instance 可以正常工作</span></p></li><li><p><span style="font-size: 15px;">创建 ELB</span></p></li><li><p><span style="font-size: 15px;">创建 target group，并将所有 instance 加入 target group</span></p></li><li><p><span style="font-size: 15px;">获取预先上传好的证书 id</span></p></li><li><p><span style="font-size: 15px;">创建两个 ELB listener，80 端口直接 301 到 443，而 443 端口把流量转发到 target group</span></p></li><li><p><span style="font-size: 15px;">创建 DNS 域名记录，设置 latency based policy</span></p></li></ol><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">当四个区域都完成之后，为这条链的所有 instance 创建 ansible inventory，以便后续处理。</p><p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="0.3828125" data-s="300,640" src="https://mmbiz.qpic.cn/mmbiz_jpg/SER9L29WQ0ibwd4ZomMcNo1XVSC6IkONNTYdlN1E8VSvlsoMryZpFERcFdLu6Ojcfe30ficP5jniaIicx5uUicucALA/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" style=""></p><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">接下来，在 init_forge_network 里，会做这些事情：</p><ol type="1" style="" class=" list-paddingleft-2"><li><p><span style="font-size: 15px;">把 data disk mount 到对应的 instance 上，并格式化文件系统为 XFS</span></p></li><li><p><span style="font-size: 15px;">使用临时配置文件启动 Forge，生成 node key 和 validator key</span></p></li><li><p><span style="font-size: 15px;">把生成的 key 备份到 S3</span></p></li><li><p><span style="font-size: 15px;">根据 inventory file，找出验证人节点，将其 validator address 写入 genesis 配置中</span></p></li><li><p><span style="font-size: 15px;">启动 forge</span></p></li></ol><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">所有节点起来后，稍候片刻，一条链就完美诞生了！</p><hr style="border-style: solid;border-width: 1px 0 0;border-color: rgba(0,0,0,0.1);-webkit-transform-origin: 0 0;-webkit-transform: scale(1, 0.5);transform-origin: 0 0;transform: scale(1, 0.5);"><p style="margin: 20px 10px;max-width: 100%;min-height: 1em;white-space: pre-wrap;color: rgb(84, 84, 84);text-align: justify;line-height: 28px;box-sizing: border-box !important;overflow-wrap: break-word !important;">如果你想了解更多有关 ABT network 的信息，可以访问：abtnetwork.io，或者戳「阅读原文」。</p></section><p><br></p>
                </div>
                <script nonce="1650403663" type="text/javascript">
                    var first_sceen__time = (+new Date());

                    if ("" == 1 && document.getElementById('js_content')) {
                        document.getElementById('js_content').addEventListener("selectstart",function(e){ e.preventDefault(); });
                    }

                    
                    (function(){
                        if (navigator.userAgent.indexOf("WindowsWechat") != -1){
                            var link = document.createElement('link');
                            var head = document.getElementsByTagName('head')[0];
                            link.rel = 'stylesheet';
                            link.type = 'text/css';
                            link.href = "//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg_new/winwx435ee6.css";
                            head.appendChild(link);
                        }
                    })();
                </script>

                
                <div class="ct_mpda_wrp" id="js_sponsor_ad_area" style="display:none;"></div>

                
                <div class="read-more__area" id="js_more_read_area" style="display:none;">
                    
                </div>

                
                                <div class="reward_area tc reward_area_primary" id="js_reward_area" style="display:none;">
                    <div class="reward-avatar" style="display: none;" id="js_reward_avatar">
                        <img src="" alt="" id="js_reward_author_head">
                    </div>
                    
                                                                    <div class="reward-author" style="display: none;" id="js_reward_author">陈小天</div>
                                                                                    <p>
                        <a class="reward_button" id="js_reward_link" href="##"><span id="js_reward_link_text">赞赏</span></a>
                    </p>
                    <div id="js_reward_inner" class="reward_area_inner" style="display:none;">
                        <p class="weui-loadmore weui-loadmore_line reward_user_tips" id="js_reward_total_parent">
                          <span class="weui-loadmore__tips">
                            <a href="##" id="js_reward_total"></a> <span id="js_reward_total_text">人赞赏</span>
                        </span>
                        </p>
                        
                        <div id="js_reward_list" class="reward_user_list"></div>
                    </div>
                </div>
                                <div class="reward_qrcode_area reward_area tc" id="js_reward_qrcode" style="display:none;">
                    <p class="tips_global">长按二维码向我转账</p>
                                        <p class="reward_tips"></p>
                    <span class="reward_qrcode_img_wrp"><img class="reward_qrcode_img" id="js_reward_qrcode_img"></span>
                    <p class="tips_global">受苹果公司新规定影响，微信 iOS 版的赞赏功能被关闭，可通过二维码转账支持公众号。</p>
                </div>
                                                
                
                            </div>
                                    
                        <div class="article_modify_area tips_global_primary article_modify_area_primary">
              文章已于<span id="js_modify_time"></span>修改            </div>
                        


                        
            <ul id="js_hotspot_area" class="article_extend_area"></ul>


            

            


<div class="rich_media_tool" id="js_toobar3">

        <a class="media_tool_meta meta_primary" id="js_view_source" href="##">阅读原文</a>
        <div id="js_read_area3" class="media_tool_meta tips_global_primary meta_primary" style="display:none;">阅读 <span id="readNum3"></span></div>

    <span style="display:none;" class="media_tool_meta meta_extra meta_praise" id="like_old">
        <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum_old"></span>
    </span>

    <span style="display:none;" class="media_tool_meta meta_extra meta_like" id="like3">
        <button class="like_btn" id="js_like_btn"> 
          <span id="js_like_wording"> 在看</span><span class="like_num" id="likeNum3"></span>
        </button>
    </span>

    <div id="js_like_educate" style="display:none">
        <div class="weui-mask"></div>
        <div class="weui-dialog weui-dialog_haokan">
        <div class="weui-dialog__hd"><strong class="weui-dialog__title" id="educate_title">已同步到看一看</strong></div>
        <div class="weui-dialog__bd">
          <img class="pic_haokan" src="//res.wx.qq.com/mmbizwap/zh_CN/htmledition/images/pic/appmsg/pic_haokan42f400.png">
            你的朋友会在“发现-看一看”看到你点击“在看”的内容        </div>
        <div class="weui-dialog__ft" id="educate_btn" style="display: none">
          <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_default" id="js_cancel">取消</a>
          <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="js_confirm">发送</a>
        </div>
        <div class="weui-dialog__ft" id="educate_btn2" style="display: none">
          <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="js_acknowledge">我知道了</a>
        </div>
        </div>
    </div>

    <div id="js_unlike_educate" style="display:none">
        <div class="weui-mask"></div>
        <div class="weui-dialog">
        
        <div class="weui-dialog__bd">
            已取消，想法已同步删除        </div>
        <div class="weui-dialog__ft">
          <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="js_unlike_know">知道了</a>
        </div>
        </div>
    </div>

    
    </div>


<div class="like_comment_wrp" id="js_a_like_comment" style="display: none;">
  <div class="like_comment_inner">
    <div class="like_comment_hd" style="display:none" id="js_like_title"></div>
    <div class="like_comment_bd">
      <div class="tips_global_primary like_comment_tips">
        <i class="weui-icon-success"></i>已同步到看一看<a href="javascript:;" class="like_comment_share_link" id="js_a_like_comment_share">写下你的想法</a>
      </div>
    </div>
    <div class="like_comment_ft">
      <span id="js_a_like_comment_msg" class="like_comment_msg" style="visibility:hidden">最多200字，当前共<span id="js_a_like_current_cnt"></span>字</span>
      <button class="like_comment_btn" disabled id="js_a_like_confirm">发送</button>
    </div>
  </div>
</div>

<div id="js_like_toast" style="display: none;">
  <div class="weui-mask_transparent"></div>
  <div class="weui-toast">
    <i class="weui-icon-success-no-circle weui-icon_toast"></i>
    <p class="weui-toast__content" id="js_toast_msg">已发送</p>
  </div>
</div>


<div style="display: none;" id="js_b_comment_panel" class="like_comment_primary_pop">
  <div class="like_comment_primary_wrp" id="js_b_wrp">
    <div class="like_comment_primary_inner">
      <div class="like_comment_primary_hd">
        <h4 class="like_comment_primary_title">
          朋友将在看一看看到        </h4>
        <button id="js_b_like_confirm" class="like_comment_primary_btn">确定</button>
      </div>
      <div id="js_b_comment_text_first" class="like_comment_primary_bd">
        <span class="tips_global_primary">
          写下你的想法...        </span>
      </div>
    </div>
  </div>
  <div class="like_comment_primary_mask" id="js_mask_1"></div>
</div>

<div style="display: none;" id="js_b_comment_final">
  <div class="like_comment_primary_wrp editing" id="js_comment_wrp">
    <div class="like_comment_primary_inner">
      <div class="like_comment_primary_hd">
        <button class="like_comment_primary_cancel" id="js_b_comment_cancel">取消</button>
        <h4 class="like_comment_primary_title"> 发布到看一看 </h4>
        <button class="like_comment_primary_btn" id="js_b_comment_confirm">确定</button>
      </div>
      <div class="like_comment_primary_bd">
        <textarea class="like_comment_textarea weui-textarea" placeholder="写下你的想法..." id="js_b_comment_text_second"></textarea>
      </div>
      <span class="like_comment_msg" id="js_b_like_comment_msg" style="visibility: hidden;">最多200字，当前共<span id="js_b_like_current_cnt"></span>字</span>
    </div>
  </div>
  <div class="like_comment_primary_mask" id="js_mask_2"></div>
</div>

<div id="js_loading" style=" display: none;">
    <div class="weui-mask_transparent"></div>
    <div class="weui-toast">
        <i class="weui-loading weui-icon_toast"></i>
        <p class="weui-toast__content">发送中</p>
    </div>
</div>

<div id="js_fail" style="display:none">
    <div class="weui-mask"></div>
    <div class="weui-dialog">
    <div class="weui-dialog__bd">
        网络异常，请稍后重试    </div>
    <div class="weui-dialog__ft">
      <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary" id="js_fail_inform">知道了</a>
    </div>
    </div>
</div>



                        <div class="rich_media_tool" id="js_sg_bar">

                                <a class="media_tool_meta meta_primary" href="https://www.abtnetwork.io/en/" target="_blank">阅读原文</a>
                                
            </div>
                      </div>
        </div>

        <div class="rich_media_area_primary sougou" id="sg_tj" style="display:none"></div>


        
        <div class="rich_media_area_extra">
          <div class="rich_media_area_extra_inner">
              
              <div id="js_share_appmsg">
              </div>

              
                            <div class="mpda_bottom_container" id="js_bottom_ad_area"></div>
                            
              <div id="js_iframetest" style="display:none;"></div>
                            
                            
              <div class="rich_media_extra rich_media_extra_discuss" id="js_cmt_container" style="display:none">
                

                
                <div class="discuss_mod" id="js_friend_cmt_area" style="display:none">
                  
                  
                  
                </div>

                                <div class="discuss_mod" id="js_cmt_area" style="display:none">
                </div>
                              </div>
          </div>
        </div>

        
        <div id="js_pc_qr_code" class="qr_code_pc_outer" style="display:none;">
            <div class="qr_code_pc_inner">
                <div class="qr_code_pc">
                    <img id="js_pc_qr_code_img" class="qr_code_pc_img">
                    <p>微信扫一扫<br>关注该公众号</p>
                </div>
            </div>
        </div>
    </div>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
