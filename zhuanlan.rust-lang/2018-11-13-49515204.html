<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Rust 在 Windows 下使用 CLion 进行调试</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/49515204">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-62ca848fbf03afd0d8a31cf7edf3b1e9_r.jpg" alt=""></div><h2><b>前言：</b></h2><p>就性能或者其他各方面来说，在 Windows 上使用 MSVC 作为后端当然是最好的，也是官方默认的安装选项。</p><img src="https://pic2.zhimg.com/v2-c4c8739aaa85004fb659f27166c73130_r.jpg" data-caption="滚动到页面下方展开即可看到" data-size="normal" data-rawwidth="1417" data-rawheight="569" data-watermark="watermark" data-original-src="v2-c4c8739aaa85004fb659f27166c73130" data-watermark-src="v2-417559ac788bbc55c7ac5b320d5ebd89" data-private-watermark-src=""><img src="https://pic3.zhimg.com/v2-a20851ee3191f905f912bb22a7c16f15_r.jpg" data-caption="勾选 Visual C++ 生成工具" data-size="normal" data-rawwidth="1255" data-rawheight="644" data-watermark="watermark" data-original-src="v2-a20851ee3191f905f912bb22a7c16f15" data-watermark-src="v2-4cea71ca847a77a19672dd81620759fa" data-private-watermark-src=""><p>只是需要下载大概 800M 左右的数据，占用 5G 左右的安装空间，对开发者来说倒是习以为常，对很多想尝试或者了解的人就有点不太友好了。</p><p>初学者可以选择 x86_64-pc-windows-gnu 版本的 msi 安装包（不到 200MB），图形化界面，安装即用（不涉及到需要编译 C/C++ 代码或者 ABI 兼容问题时都是完全 OK 的，出现需求了再配置即可），编译出来的 exe 在性能和大小上和 MSVC 版略有不同：</p><img src="https://pic4.zhimg.com/v2-df57a5f5d059465ef4ecb556a3149726_r.jpg" data-caption="影响不大" data-size="normal" data-rawwidth="575" data-rawheight="44" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>其实使用 MSVC 后端更主要的问题是调试，参看 <a href="https://areweideyet.com/">https://areweideyet.com/</a> 列出的各 IDE / Editer 的支持情况 。在 Windows 上比较好的解决办法是使用 VS Code ，安装 <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools">C/C++</a> 插件再稍作配置即可调试，但是就目前的使用体验来说，调试问题是解决了，编码体验却真的不怎么样，<a href="https://github.com/rust-lang-nursery/rls-vscode">rls-vscode</a> 只是勉强能用，而且 issue 提个不断，更新却接近停滞。</p><p>使用 CLion + <a href="https://intellij-rust.github.io/">intellij-rust</a> 是比较好的选择，不过 CLion 不支持 MSVC 工具链的调试，所以我们需要使用 windows-gnu 工具链来生成目标代码，然后在 CLion 里使用 GDB 来调试。</p><p>推荐的做法是安装 MSYS2，再使用 MSYS2 安装 MinGW toolchains，但是目前 CLion 还不支持 MinGW-w64 的 GDB 8.2 版本：</p><img src="https://pic1.zhimg.com/v2-0ed77109991906e0c969ed8476e6d8fb_r.jpg" data-caption="踩坑了" data-size="normal" data-rawwidth="615" data-rawheight="341" data-watermark="watermark" data-original-src="v2-0ed77109991906e0c969ed8476e6d8fb" data-watermark-src="v2-f8ad4bc1c3bb822c37022ec369453677" data-private-watermark-src=""><p>没关系，除了MSYS2，还有 <a href="https://mingw-w64.org/doku.php">GCC for Windows 64 &amp; 32 bits [mingw-w64]</a> 可选择，Cygwin 就算了。</p><hr><h2><b>安装：</b></h2><p>安装很简单，步骤为：</p><p>下载 MinGW-w64 并解压 -&gt; 配置环境变量 Path -&gt; 配置 CLion -&gt; 安装或者配置 Rust</p><p><br></p><p>在 <a href="https://sourceforge.net/projects/mingw-w64/files/">MinGW-w64 - for 32 and 64 bit Windows</a> 页面下方可以找到安装文件，可以选择 installer 按步骤安装，也可以直接下载 7z 压缩包，我选择了 GCC-8.1.0 x86_64-posix-seh  7z 包，<a href="https://wiki.qt.io/MinGW-64-bit">线程模型和异常处理</a>和你的 Rust 工具链版本保持一致。解压缩到你喜欢的目录，我解压缩在 C:\Dev 下。</p><p><br></p><p>添加 MinG-w64 的 bin 到环境变量 Path 中：</p><img src="https://pic3.zhimg.com/v2-4d163869d991ebceafbc14c33287c7db_r.jpg" data-caption="" data-size="normal" data-rawwidth="527" data-rawheight="252" data-watermark="watermark" data-original-src="v2-4d163869d991ebceafbc14c33287c7db" data-watermark-src="v2-dc2691ed45312a66e0ced8ebc32efca1" data-private-watermark-src=""><p><br></p><p>在 CLion 的 Settings &gt; Build, Execution, Deployment &gt; Toolchains 里配置 MinGW ：</p><img src="https://pic3.zhimg.com/v2-926786a060dbd6f448e3846e99d03e1a_r.jpg" data-caption="" data-size="normal" data-rawwidth="610" data-rawheight="370" data-watermark="watermark" data-original-src="v2-926786a060dbd6f448e3846e99d03e1a" data-watermark-src="v2-6b76ae0e6956a2a7e26b08573f839c62" data-private-watermark-src=""><p><br></p><p>下载并运行 <a href="https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-gnu/rustup-init.exe">x86_64-pc-windows-gnu-rustup-init</a> ，按提示完成安装即可。</p><p><br></p><p><b>补充：</b></p><p>如果你下载的是默认的 rustup-init.exe ，可以先跳过它的警告，Continue 继续到下一步，输入 2 （Customize installation）回车，在 Default host triple? 下输入 x86_64-pc-windows-gnu ，剩下两项直接回车保持默认，最后输入 1 回车开始安装，效果一样：</p><img src="https://pic2.zhimg.com/v2-13ddbd9d3cf00cd39693bea5ff4d532e_r.jpg" data-caption="" data-size="normal" data-rawwidth="591" data-rawheight="452" data-watermark="watermark" data-original-src="v2-13ddbd9d3cf00cd39693bea5ff4d532e" data-watermark-src="v2-5473a6cb83cfe25c84e71e3a8f37ea06" data-private-watermark-src=""><p><br></p><p>如果你之前已经安装好了Rust，你还是可以方便地通过 rustup 来安装和切换工具链，这也是 Rust 的优点之一。运行 rustup toolchain install xxx 安装，rustup override xxx 和 rustup target xxx 切换，自行 Google。</p><p><br></p><p>打开一个 Rust 项目测试下：</p><img src="https://pic2.zhimg.com/v2-0a2348923ed538eacb2b46dce96b6a02_r.jpg" data-caption="完美调试" data-size="normal" data-rawwidth="1078" data-rawheight="466" data-watermark="watermark" data-original-src="v2-0a2348923ed538eacb2b46dce96b6a02" data-watermark-src="v2-3b477faa599b0ece0e220bb6c5067a2e" data-private-watermark-src=""><hr><h2><b>后记：</b></h2><p>windows-gnu 版本的 Rust 是自带 gcc 和 ld 的：</p><img src="https://pic3.zhimg.com/v2-0ef634ab2094ed4b104d3aa99a34487b_r.jpg" data-caption="" data-size="normal" data-rawwidth="649" data-rawheight="214" data-watermark="watermark" data-original-src="v2-0ef634ab2094ed4b104d3aa99a34487b" data-watermark-src="v2-cfd8f74863437a817f33d975a35e2e99" data-private-watermark-src=""><p>所以它可以不依赖 MSVC 生成 exe ，不过目录里的 GCC-WARNING.txt 有云：</p><blockquote>gcc.exe contained in this folder cannot be used for compiling C files - it is onlyused <br>as a linker. </blockquote><p><br></p><p>CLion 自带的 JRE 是基于 OpenJRE 的，对字体渲染上有点问题，可以把安装目录下的 jre64 删除或者重命名成其他，再在 Oracle 下载一个 .tar.gz 版本的 JRE ，解压缩后文件夹更名为 jre64 粘贴到 CLion 安装目录即可。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
