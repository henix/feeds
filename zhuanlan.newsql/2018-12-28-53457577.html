<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>TiPrometheus：基于 TiDB 的 TSDB | TiDB Hackathon 优秀项目</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/53457577">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-f0ec6cb07659b51a79c3ac8332284862_b.jpg" alt=""></div><blockquote>本文作者是<b>菜哥和他的朋友们队</b>的<b>于畅</b>同学，他们的项目<b> TiPrometheus</b>已经被 Prometheus adapter 合并。该项目分两个小项目，分别解决了时序数据的存储与计算问题。存储主要兼容 Prometheus 语法和数据格式，实现了精确查询、模糊查询，完全兼容现有语法。所有数据仅存在 TiKV 中。计算主要通过 TiKV 调用 Lua 实现，通过 Lua 动态扩展实现数据计算的功能。</blockquote><h2><b>项目简介</b></h2><p>既然你关注了 TiDB， 想必你一定是个关注 Infrastructure 的硬汉子。监控作为 Infra 不可或缺的一环，其核心便是 <b>TSDB（time series database）</b>。</p><p>TSDB 是一种以时间为主要索引的数据库。主要用来存储大量以时间为序列的指标数据，数据结构也比较简单，通常包括特征信息，指标数据和 timestamp。常见的 TSDB 包括 InfluxDB，OpenTSDB，Prometheus。</p><p>而 Prometheus 是一整套监控系统，时序数据库是它的存储部分，下面这张架构图来自于 Prometheus 官方，简单概括了其架构和生态的组成。</p><figure><noscript><img src="https://pic1.zhimg.com/v2-761c4f11257f1592da39e85a1f9ecccc_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="564" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic1.zhimg.com/v2-761c4f11257f1592da39e85a1f9ecccc_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-761c4f11257f1592da39e85a1f9ecccc_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="564" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic1.zhimg.com/v2-761c4f11257f1592da39e85a1f9ecccc_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-761c4f11257f1592da39e85a1f9ecccc_b.jpg"></figure><p>Prometheus 还支持一个图上没有体现的功能 Remote Storage，可以进行远程的读写，对查询是透明的。这个功能主要是用来做长存储。<b>我们的项目就是实现了一个基于 TiKV 的TSDB 来做 Prometheus 的 Remote Storage。</b></p><h2><b>核心实现</b></h2><p>Prometheus 记录的数据结构分为两部分 label, samples。label 记录了一些特征信息。samples 包含了指标数据和 timestamp。</p><div class="highlight"><pre><code class="language-text"><span></span>"labels": [{
 "job":        "node",
 "instance":   "123.123.1.211:9090",
}]
"samples":[{
 "timestamp": 1473305798
 "value": 0.9
}]
</code></pre></div><p>label 和时间范围结合，可以查询到需要的 value。</p><p>为了查询这些记录，我们需要构建两种索引 label index 和 time index，并以特殊的 key 存储 value。</p><ul><li><b>label index</b></li></ul><p>每对 label 为会以 index:label:&lt;name&gt;#&lt;latency&gt; 为key，labelID 为 value 存入。新的记录会追加到 value 后面。这是一种搜索中常用的倒排索引。</p><ul><li><b>time index</b></li></ul><p>每个 sample 项会以 index:label:&lt;name&gt;#&lt;latency&gt; 为 key，timestamp 为 value。splitTime为时间切片的起始点。新的 timestamp 会追加到 value 后面。</p><ul><li><b>doc 存储</b></li></ul><p>我们将每一条 samples 记录以 timeseries:doc:&lt;labelID&gt;:&lt;timestamp&gt; 为 key 存入 TiKV，其中 labelID 是 label 全文的散列值。</p><p>下面做一个梳理。</p><figure><noscript><img src="https://pic2.zhimg.com/v2-f02edf9c84cde9b4a085350a4026c971_b.jpg" data-caption="" data-size="normal" data-rawwidth="893" data-rawheight="679" class="origin_image zh-lightbox-thumb" width="893" data-original="https://pic2.zhimg.com/v2-f02edf9c84cde9b4a085350a4026c971_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-f02edf9c84cde9b4a085350a4026c971_b.jpg" data-caption="" data-size="normal" data-rawwidth="893" data-rawheight="679" class="origin_image zh-lightbox-thumb lazy" width="893" data-original="https://pic2.zhimg.com/v2-f02edf9c84cde9b4a085350a4026c971_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-f02edf9c84cde9b4a085350a4026c971_b.jpg"></figure><ul><li><b>写入过程</b></li></ul><ol><li>生成 labelID</li><li>构建 label index，index:label:&lt;name&gt;#&lt;latency&gt; "labelID,labelID"</li><li>构建 time index，index:timeseries:&lt;labelID&gt;:&lt;splitTime&gt; "ts,ts"</li><li>写入时序数据，timeseries:doc:&lt;labelID&gt;:&lt;timestamp&gt; "value"</li></ol><ul><li><b>查询过程</b></li></ul><p>1. 根据倒排索引查出 labelID 的集合，多对 label 的查询会对 labelID 集合求交集。</p><p>2. 根据 labelID 和时间范围内的时间分片查询包含的 timestamp。</p><p>3. 根据 labelID 和 timestamp 查出所需的 value。</p><blockquote><i>扯完这些没用的我们来聊些正经的。</i></blockquote><h2><b>我们为什么要做这样一个项目</b></h2><p>在 2018 年下半年，PingCAP 组织的 Hackathon，当时作为萌新即将参加比赛，想着一定要文体两开花，弘扬开源文化。</p><p>萌生了四个想法：</p><ul><li>TiKV TSDB</li><li>Machine Learning on TiSpark</li><li>魔改 TiKV + Lua 做成 mapreduce</li><li>geo 全文检索</li></ul><p><b>核心想法</b></p><p>1. 能做出来，符合参赛要求。</p><p>2. 确实能解决生产问题而不是一个比赛项目。</p><p>摸了摸头发，觉得 ML on TiSpark 太硬核，根本做不完。</p><p>TiHaoop 也太硬核，也做不完。</p><p>geo 没在厂里的生产中遇到什么问题。</p><p>最后辗转反侧思考一番，拍脑袋决定双线操作，做基于 TiKV 的 TSDB 和 TiKV + Lua，完成时序检索功能的同时，增加更丰富的算子（比赛前两天才想好做什么）。</p><h2><b>比赛过程</b></h2><ul><li><b>周五</b></li></ul><p>原计划，提前看看 rust，作为 rust 萌新。</p><p>于是前一天和同事借了本 rust 书，准备一天速成 rust。</p><p>后来发现还是看电视剧更管用。</p><ul><li><b>Day 1（周六）</b></li></ul><p>周六参加比赛的时候，原以为会有个很长的开场致辞，所以决定 10 点再去。</p><p>到了现场，发现大家已经开始撸代码了？？？</p><p>整体过程还算顺利，但其中也遇到了一些问题。</p><p>Prometheus 的依赖和 TiKV 的一些依赖不兼容，于是 fork 一份 Prometheus 依赖，野路子改两行，兼容了。</p><p>下午 5 点的时候，时序基本实现了，但联调发现有数据读写不一致的情况。因菜哥的一个 bug 导致，然后开始了漫长的 debug，一共历时 5 个小时（特别说明，我们组叫菜哥和他的朋友们）。</p><p>晚 10 点，准备回家了，不准备再 debug 了，一个 bug 查了 5 个小时。作为娱乐队，熬夜写代码是不可能。</p><p>各回各家，各找各妈。</p><ul><li><b>Day 2（周日）</b></li></ul><p>开始漫长的半天精通 Lua 虚拟机 + rust。</p><p>也遇到了一些问题，比如为什么 TiKV 编译这么慢？？？一天只有 24 次编译机会？？？</p><p>下午 2 点，作为第一个讲的团队，及时生成了一个 PPT ，毕竟 PPT 工程师的基础还在。</p><figure><noscript><img src="https://pic2.zhimg.com/v2-ab7635a51549e55ae4798cbed9fe0b7d_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="648" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic2.zhimg.com/v2-ab7635a51549e55ae4798cbed9fe0b7d_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-ab7635a51549e55ae4798cbed9fe0b7d_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="648" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic2.zhimg.com/v2-ab7635a51549e55ae4798cbed9fe0b7d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-ab7635a51549e55ae4798cbed9fe0b7d_b.jpg"></figure><ul><li><b>一周后的周一</b></li></ul><p>之前写的渣代码，简单写了个 README。抱着尝试的心态，给 Prometheus adapter 提了个 PR。</p><p><b>然后，居然被合进去了！！！</b></p><p><b>一下午写的代码居然被合进去了！！！</b></p><h2><b>成果</b></h2><p>彻底打通了 TiKV 和 Prometheus。</p><p>为 TiKV 的时序存储和计算提供了一个思路（之前做过 TiDB 存储时序数据）。</p><p>为 Prometheus 的长存储提供了一个还算好用的方案（M3 其实还可以，Thanos 是分片机制，不能算真正意义的分布式存储）。</p><p>已在公司生产环境试用，需要经过大数据量的测试，如果没问题计划替代现有方案。</p><h2><b>感悟</b></h2><p>参加 Hackathon，和周末加两天班没有太大的区别。</p><p>最先开始来，只是想混个奖品，比如说书包。去年参加 DevCon 给的布袋用了一年，还没坏，今年准备再领一个。</p><p>见到了很多年龄比我们小，但技术又还不错的小伙伴，比如兰海他们组，udf 那个组。也见到了一些年龄稍长的参赛者。</p><p>他们的存在，让我们在充满杂事的日常工作中又有了继续奋斗的动力。</p><p>似乎，当时选择这个行业没有错，而不仅仅是一份工作。</p><p>Just for fun。</p><h2><b>感谢</b></h2><p>感谢唐刘老师和申砾老师的指导。</p><p>感谢 PingCAP 举办了这场大型网友见面活动，收获颇丰。</p><p><b>项目地址：</b></p><p><a href="http://link.zhihu.com/?target=https%3A//github.com/bragfoo/TiPrometheus" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/bragfoo/TiPr</span><span class="invisible">ometheus</span><span class="ellipsis"></span></a></p><p>（代码比较渣，思路供参考）。</p><blockquote><i>打个广告：由菜哥和他的朋友们翻译的书：《Go 语言并发之道》已登陆京东、淘宝。非常棒一本 Go 语言书籍，搜索即可购买。</i></blockquote><h2><b>参考资料：</b></h2><p>1. <a href="http://link.zhihu.com/?target=https%3A//fabxc.org/tsdb/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">fabxc.org/tsdb/</span><span class="invisible"></span></a></p><p>2.<a href="http://link.zhihu.com/?target=https%3A//docs.influxdata.com/influxdb/v1.7/concepts/storage_engine/" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">docs.influxdata.com/inf</span><span class="invisible">luxdb/v1.7/concepts/storage_engine/</span><span class="ellipsis"></span></a></p><p>3. <a href="http://link.zhihu.com/?target=https%3A//github.com/prometheus/prometheus/tree/release-1.8/storage" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/prometheus/p</span><span class="invisible">rometheus/tree/release-1.8/storage</span><span class="ellipsis"></span></a></p><p><br></p><blockquote>TiDB Hackathon 2018 共评选出六个优秀项目，本系列文章将由这六个项目成员主笔，分享他们的参赛经验和成果。我们非常希望本届 Hackathon 诞生的优秀项目能够在社区中延续下去，感兴趣的小伙伴们可以加入进来哦。<br><b>延伸阅读：</b><br><a href="http://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzI3NDIxNTQyOQ%3D%3D%26mid%3D2247487370%26idx%3D1%26sn%3D72d9d52558e83eb97cd709c67b5a4149%26chksm%3Deb1628e0dc61a1f60bb99ffe2fe42fafe91570159094fc5e3d46039b5490bd0c391ee500b8d6%26scene%3D21%23wechat_redirect" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiDB Hackathon 2018 回顾</a><br><a href="http://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzI3NDIxNTQyOQ%3D%3D%26mid%3D2247487370%26idx%3D2%26sn%3D7eb3d41b2b5cf2a8a440b12121796e2d%26chksm%3Deb1628e0dc61a1f6719856b0eeadd4e878c3b59e0127f8b8f65ed1fb99b2a8981739b5449ce7%26scene%3D21%23wechat_redirect" class=" wrap external" target="_blank" rel="nofollow noreferrer">天真贝叶斯学习机 | 优秀项目分享</a><br><a href="http://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s%3F__biz%3DMzI3NDIxNTQyOQ%3D%3D%26mid%3D2247487451%26idx%3D2%26sn%3D5f1ee6e838c3a86556fcd556662112c5%26scene%3D21%23wechat_redirect" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiQuery：All Diagnosis in SQL | 优秀项目分享</a><br><a href="http://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s%3F__biz%3DMzI3NDIxNTQyOQ%3D%3D%26mid%3D2247487479%26idx%3D1%26sn%3D8a8861419dd22344a021667545005769%26scene%3D21%23wechat_redirect" class=" wrap external" target="_blank" rel="nofollow noreferrer">让 TiDB 访问多种数据源 | 优秀项目分享</a><br><a href="http://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s%3F__biz%3DMzI3NDIxNTQyOQ%3D%3D%26mid%3D2247487479%26idx%3D2%26sn%3D3a601b2ff9100a9797605a825e478c01%26scene%3D21%23wechat_redirect" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiDB Lab 诞生记 | 优秀项目分享</a><br><a href="http://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/_o_4XRJ22NfAfBvUFQqueQ" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiEye：Region 信息变迁历史可视化工具 | TiDB Hackathon 2018 优秀项目分享</a><br><a href="http://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/sg3RiE8Fp96aQZlo1MM0hg" class=" wrap external" target="_blank" rel="nofollow noreferrer">TiPrometheus：基于 TiDB 的 TSDB | TiDB Hackathon 优秀项目分享</a><br><a href="http://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/q3ZHJ2rxMqfpdRd2oof2xw" class=" wrap external" target="_blank" rel="nofollow noreferrer">TBSSQL 的那些事 | TiDB Hackathon 优秀项目分享</a></blockquote>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
