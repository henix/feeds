<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>SIGGRAPH Asia 2014 见闻之《高效地使用大量光源于实时着色》课程</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/20065746">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/23423e75e7f5802c65c692a84e880732_r.jpg" alt=""></div><p>在 SIGGRAPH Asia 2014 中，《<a href="http://sa2014.siggraph.org/en/attendees/courses.html?view=session&amp;type=courses&amp;sessionid=36" data-editable="true" data-title="高效地使用大量光源于实时着色（Efficient Real-TimeShading with Many Lights）" class="">高效地使用大量光源于实时着色（Efficient Real-TimeShading with Many Lights）</a>》是和游戏技术最接近的课程之一。三位主讲分别是 Ola Olsson（瑞典查尔姆斯理工大学博士）、Emil Persson（Avalanche Studios研究部负责人）、Markus Billeter（瑞典查尔姆斯理工大学博士候选人）。课程内容比较前向、延迟、分块、群组和相关技术实现大量动态光源的渲染管道。由于现时未获演讲稿的电子版本，笔者尽量以记忆及相关文献简单介绍一下本课程的重点。</p><p>（标题相片来自 <a href="https://unsplash.com/pixelperfect" class="" data-editable="true" data-title="Ryan Pouncy | Unsplash">Ryan Pouncy | Unsplash</a>）</p><p>近年，实时渲染管道经历了一连串变革，全动态光源对这些变革有重要影响。传统的前向 渲染（forward rendering）管道在渲染<equation>n</equation>个物体在<equation>m</equation>个光源下着色，需要绘制<equation>\mathrm{O}(nm)</equation>次。当需要越来越复杂的游戏场景，更多光源，这种方式成为CPU及GPU的性能瓶颈。在2004年 GDC 出现了延迟渲染（deferred rendering）管道的讨论[4]，所有物体都先绘制在一组屏幕空间的缓冲（称为几何缓冲区／G-buffer，见图1），再逐光源对该缓冲着色，复杂度变成<equation>\mathrm{O}(n+m)</equation>。另一种相关的技术在同一届 GDC 中发表，被称为延迟光照（deferred lighing）[3]，几年后也被称为前期光照通道（light pre-pass）[2]。通过这类“延迟”方式，已可以大量增加物体和光源的数量，渲染出更复杂的场景。然而，这种延迟方式有几个问题。首先，只能使用统一的材质着色器，而且其参数受限（每个参数需要相应的G-buffer），这对于游戏的画面风格造成很大的限制。第二，在性能上虽然复杂度降低了，但读写G-buffer的内存带宽用量成为了性能瓶颈。由于GPU的计算性能不断提升但显存带宽却提升缓慢，使延迟渲染越来越不适合近代的GPU。第三，不能处理半透明及多重采样抗锯齿（MultiSampling Anti-Aliasing, MSAA）。</p><img src="https://pic2.zhimg.com/6785b11244a43e41af1c05e194ce6baa_r.jpg" data-rawwidth="635" data-rawheight="156"><p>图1：延迟渲染的几何缓冲区／G-buffer及渲染结果（维基百科图片）</p><p>因为这些因素，近几年催生出另一族渲染管道的方式，称为分块渲染（tiled rendering） [5]。分块渲染有多个变种，先说分块延迟渲染（tiled deferred rendering）。在前面提及，延迟渲染的瓶颈在于读写 G-buffer，在大量光源下，具体瓶颈将位于每个光源对 G-buffer的读取及与颜色缓冲区（color buffer）混合。这里的问题是，每个光源，即使它们的影响范围在屏幕空间上有重疉，因为每个光源是在不同的绘制中进行，所以会重复读取G-buffer中相同位置的数据，计算后以相加混合方式写入颜色缓冲。光源越多，内存带宽用量越大。而分块延迟渲染则是把屏幕分拆成细小的栅格，例如每 32 × 32 象素作为一个分块（tile）。然后，计算每个分块会受到哪些光源影响，把那些光源的索引储存在分块的光源列表里。最后，逐个分块进行着色，对每像素读取 G-buffer 和光源列表及相关的光源信息。因此，G-buffer的数据只会被读取1次且仅1次，写入 color buffer 也是1次且仅1次，大幅降低内存带宽用量。不过，这种方法需要计算 光源会影响哪些分块，这个计算又称为光源剔除（light culling），可以在 CPU 或 GPU（通常以 compute shader 实现）中进行。用GPU计算的好处是，GPU 计算这类工作比 CPU 更快，也减少 CPU／GPU 数据传输。而且，可以计算每个分块的深度范围（depth range），作更有效的剔除。</p><p><img src="https://pic2.zhimg.com/49b59030967f2235ad2a8234edb1af97_r.jpg" data-rawwidth="634" data-rawheight="230">图2：分块渲染（图片来自 Olaolss 的<a href="http://www.cse.chalmers.se/~olaolss/main_frame.php?contents=publication&amp;id=tiled_shading" data-editable="true" data-title="网页">网页</a>）</p><p>有趣的是，这种分块方式也可以用于前向渲染，这称为分块前向渲染（tiled forward rendering）[1]。当计算好光源列表，前向渲染时就按屏幕位置读取相关的光源信息去着色。那么，就可以同时解决延迟渲染的各种问题，又不需要像传统前向渲染对物体进行多次绘制。这种分块渲染似乎已经很理想，但如果增加更多光源，而场景又比较空扩，每个分块的光源数量就会变得更多。虽然做了深度范围的优化可缓解这个问题，但如果在视野里有很多深度不连续区域（depth discontinuities），如图3，那么该优化也无能为力了。为了解决这个问题，研究者想 出了不同的新方法。</p><img src="https://pic3.zhimg.com/52868fa6e6e2ebb88302578fcca66f17_r.jpg" data-rawwidth="634" data-rawheight="241"><p>图3：深度不连续的场景（图片来自[8]）</p><p>Olsson、Billeter 及他们的导师 Ulf Assarsson 在2012年发表了一种新的改善方式，名为分群组渲染（clustered rendering）[6][7]。这里的群组（cluster）是指分块（tile）在深度上进一步划分，这种体积数据使每个单位储存更少量的光源（图4）。在渲染时，除了考虑着色像素的屏幕坐标，还考虑到深度的坐标，去索引群组并取得光源信息。这个简单的概念优化了光源剔除，使光源数目能进一步提升。</p><img src="https://pic3.zhimg.com/cd524bc2ec178f2f70feea8b8719111b_r.jpg" data-rawwidth="634" data-rawheight="229"><p>图4：群组渲染（图片来自Olaolss的网页 3）</p><p>据游戏业界的Persson称，以他所知，暂时未有已发行游戏使用了群组渲染技术。而他 在Avalanche Studios开发中的《正当防卫3（Just Cause 3）》则使用了此技术[8]。对于实际在游戏中应用群组渲染技术，他表示非常乐观。在开发本作中，他从实际的场景中发现，如果简单地使用指数方式划分深度，较近的范围可能有太多群组，而使效率变差。所以他把最近的群组加深，有效改善此问题。另外，由于该作主要是室外大型场景，远景就不使用真正的动态光照，而仅使用公告板作渲染。</p><img src="https://pic2.zhimg.com/deddc1eadc674477b0213b58432b4586_r.jpg" data-rawwidth="634" data-rawheight="354"><p>图5：Avalanche 工作室对群组深度分布的优化（图片来自[8]）</p><p>不过，在光照上还有一个未有完善解决的问题，就是阴影。笔者记得，以前在解决虚拟点 光源模拟全局光照的阴影问题时，曾出现一种名为不完美阴影贴图（imperfect shadow map, ISM）的技术[9]。刚好在这课程的前一天 Square Enix 的德吉雄介也谈到使用ISM于他们的全局渲染管道中[10]。然而，本课程中 Olsson 就介绍了他和 Billeter 及其他同事合作发明的一个方案， 称为虚拟阴影贴图（virtual shadow map），采用类似 id Tech 5 的虚拟纹理（virtual texturing）技术，去动态按阴影采样需求动态分配阴影贴图的纹理空间。其结果也是不错的，虽然使用了较大量的显存，但似乎在这一代游戏机平台上是有可能应用到的。</p><p>最后 Billeter 讲述在移动平台上实现多光源的尝试，由于移动设备的内存带宽比PC的问题 更大，使用分块或群组渲染都更有竞争力。可望在近一两年内在高端手机游戏中实际应用。</p><h2>参考文献</h2><p>[1] Markus Billeter, Ola Olsson, and Ulf Assarsson. Tiled forward shading. GPU Pro 4: Advanced Rendering Techniques, 4:99, 2013.</p><p>[2] Wolfgang Engel. Designing a renderer for multiple lights–the light pre-pass renderer. ShaderX7: Advanced rendering techniques, 2009.</p><p>[3] Rich Geldreich, Matt Pritchard, and John Brooks. <a href="http://www.tenacioussoftware.com/gdc_2004_deferred_shading.ppt" data-editable="true" data-title="Deferred lighting and shading">Deferred lighting and shading</a>. In Game Developers Conference, volume2, 2004.</p><p>[4] Shawn Hargreaves and Mark Harris. <a href="http://www.shawnhargreaves.com/DeferredShading.pdf" data-editable="true" data-title="Deferred shading">Deferred shading</a>. In Game Developers Conference, volume 2, 2004.</p><p>[5] Ola Olsson and Ulf Assarsson. <a href="http://www.cse.chalmers.se/~olaolss/get_file.php?filename=papers/Improved%20Ray%20Hierarchy%20Alias%20Free%20Shadows.pdf" data-editable="true" data-title="Tiled shading">Tiled shading</a>. Journal of Graphics, GPU, and Game Tools, 15(4):235–251, 2011.</p><p>[6] Ola Olsson, Markus Billeter, and Ulf Assarsson. <a href="http://www.cse.chalmers.se/~olaolss/get_file.php?filename=papers/clustered_shading_preprint.pdf" data-editable="true" data-title="Clustered deferred and forward shading">Clustered deferred and forward shading</a>. In HPG ’12: Proceedings of the Conference on High Performance Graphics 2012, 2012.</p><p>[7] Ola Olsson, Markus Billeter, and Ulf Assarsson. <a href="http://www.cse.chalmers.se/~olaolss/get_file.php?filename=papers/tiled_shading_siggraph_2012.pdf" data-editable="true" data-title="Tiled and clustered forward shading">Tiled and clustered forward shading</a>. In SIGGRAPH ’12: ACM SIGGRAPH 2012 Talks, New York, NY, US- A, 2012. ACM.</p><p>[8] Emil Persson and Ola Olsson. <a href="http://www.cse.chalmers.se/~olaolss/get_file.php?filename=papers/siggraph_2013.pdf" data-editable="true" data-title="Practical clustered deferred and forward shading">Practical clustered deferred and forward shading</a>. SIGGRAPH Course: Advances in Real-Time Rendering in Games, 2013.</p><p>[9] Tobias Ritschel, Thorsten Grosch, Min H Kim, H-P Seidel, Carsten Dachsbacher, and Jan Kautz. <a href="http://people.mpi-inf.mpg.de/~ritschel/Papers/ISM.pdf" data-editable="true" data-title="Imperfect shadow maps for efficient computation of indirect illumination" class="">Imperfect shadow maps for efficient computation of indirect illumination</a>. In ACM Transactions on Graphics (TOG), volume 27, page 129. ACM, 2008.</p><p>[10] Yusuke Tokuyoshi. <a href="http://www.jp.square-enix.com/info/library/pdf/Virtual%20Spherical%20Gaussian%20Lights%20for%20Real-Time%20Glossy%20Indirect%20Illumination.pdf" data-editable="true" data-title="Virtual spherical gaussian lights for real-time glossy indirect illumination" class="">Virtual spherical gaussian lights for real-time glossy indirect illumination</a>. In SIGGRAPH Asia 2014 Technical Briefs, page 17. ACM, 2014.</p><p>本文原于2014年12月15日在腾讯内部揭载，获授权公开。</p><p><img src="https://pic1.zhimg.com/d5005df8aebb185aa03d5b7fdfe4ce0d_r.jpg" data-rawwidth="150" data-rawheight="150"><a href="http://miloyip.com/2014/many-lights/" data-editable="true" data-title="SIGGRAPH Asia 2014 见闻之《高效地使用大量光源于实时着色》课程">SIGGRAPH Asia 2014 见闻之《高效地使用大量光源于实时着色》课程</a></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
