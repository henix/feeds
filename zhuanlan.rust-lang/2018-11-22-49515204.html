<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Rust 在 Windows 下使用 CLion 进行调试</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/49515204">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-62ca848fbf03afd0d8a31cf7edf3b1e9_b.jpg" alt=""></div><h2><b>前言：</b></h2><p>就性能、兼容性或者其他各方面来说，在 Windows 上使用 MSVC 作为后端当然是最好的，也是官方默认的安装选项。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-417559ac788bbc55c7ac5b320d5ebd89_b.jpg" data-size="normal" data-rawwidth="1417" data-rawheight="569" class="origin_image zh-lightbox-thumb" width="1417" data-original="https://pic2.zhimg.com/v2-417559ac788bbc55c7ac5b320d5ebd89_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-417559ac788bbc55c7ac5b320d5ebd89_b.jpg" data-size="normal" data-rawwidth="1417" data-rawheight="569" class="origin_image zh-lightbox-thumb lazy" width="1417" data-original="https://pic2.zhimg.com/v2-417559ac788bbc55c7ac5b320d5ebd89_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-417559ac788bbc55c7ac5b320d5ebd89_b.jpg"><figcaption>滚动到页面下方展开即可看到</figcaption></figure><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-4cea71ca847a77a19672dd81620759fa_b.jpg" data-size="normal" data-rawwidth="1255" data-rawheight="644" class="origin_image zh-lightbox-thumb" width="1255" data-original="https://pic3.zhimg.com/v2-4cea71ca847a77a19672dd81620759fa_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-4cea71ca847a77a19672dd81620759fa_b.jpg" data-size="normal" data-rawwidth="1255" data-rawheight="644" class="origin_image zh-lightbox-thumb lazy" width="1255" data-original="https://pic3.zhimg.com/v2-4cea71ca847a77a19672dd81620759fa_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-4cea71ca847a77a19672dd81620759fa_b.jpg"><figcaption>勾选 Visual C++ 生成工具</figcaption></figure><p>只是需要下载大概 1G 左右的数据，占用 5G 左右的安装空间，对开发者来说倒是习以为常，对很多想尝试或者了解的人就有点不太友好了。</p><p>初学者可以选择 x86_64-pc-windows-gnu 版本的 <a href="http://link.zhihu.com/?target=https%3A//www.rust-lang.org/zh-CN/other-installers.html" class=" wrap external" target="_blank" rel="nofollow noreferrer">msi 安装包</a>（不到 200MB），图形化界面，安装即用，除非你用到了需要 C/C++ 编译的第三方库，或者生成的结果需要和 ABI 不同目标代码进行交互，否则就不用再安装其他或者配置什么。GNU ABI target 的 exe 在性能和大小上可能会和 MSVC ABI target 有一些差距：</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-1c6384060b9d2c5f7f924aeed29a965e_b.jpg" data-size="normal" data-rawwidth="459" data-rawheight="43" class="origin_image zh-lightbox-thumb" width="459" data-original="https://pic3.zhimg.com/v2-1c6384060b9d2c5f7f924aeed29a965e_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-1c6384060b9d2c5f7f924aeed29a965e_b.jpg" data-size="normal" data-rawwidth="459" data-rawheight="43" class="origin_image zh-lightbox-thumb lazy" width="459" data-original="https://pic3.zhimg.com/v2-1c6384060b9d2c5f7f924aeed29a965e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-1c6384060b9d2c5f7f924aeed29a965e_b.jpg"><figcaption>不用太在意</figcaption></figure><p>其实使用 MSVC 作为后端更主要的问题是调试（参看 <a href="http://link.zhihu.com/?target=https%3A//areweideyet.com/" class=" wrap external" target="_blank" rel="nofollow noreferrer">https://areweideyet.com</a> 列出的 IDE / Editer 在各平台上对 Debugging 的支持情况）。虽然在 Windows 上可以比较方便地使用 VS Code 来调试，但是就目前的使用体验来说，调试问题是解决了，写代码的体验却真的不怎么样，<a href="http://link.zhihu.com/?target=https%3A//github.com/rust-lang-nursery/rls-vscode" class=" wrap external" target="_blank" rel="nofollow noreferrer">rls-vscode</a> 只是勉强能用。</p><p>使用 CLion + <a href="http://link.zhihu.com/?target=https%3A//intellij-rust.github.io/" class=" wrap external" target="_blank" rel="nofollow noreferrer">intellij-rust</a> 是目前的理想选择，不过 CLion 不支持 MSVC 工具链的调试，所以我们需要生成 GNU ABI 的目标文件，然后在 CLion 里使用 GDB 来调试。</p><p>获取 GCC 工具链的推荐做法是安装 MSYS2 ，再使用 MSYS2 中的 pacman 安装 MinGW toolchains，但是目前 CLion （2018.2.5 版本）还不支持 MinGW-w64 的 GDB 8.2 版本：</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-f8ad4bc1c3bb822c37022ec369453677_b.jpg" data-size="normal" data-rawwidth="615" data-rawheight="341" class="origin_image zh-lightbox-thumb" width="615" data-original="https://pic4.zhimg.com/v2-f8ad4bc1c3bb822c37022ec369453677_r.jpg"></noscript><img src="https://pic4.zhimg.com/v2-f8ad4bc1c3bb822c37022ec369453677_b.jpg" data-size="normal" data-rawwidth="615" data-rawheight="341" class="origin_image zh-lightbox-thumb lazy" width="615" data-original="https://pic4.zhimg.com/v2-f8ad4bc1c3bb822c37022ec369453677_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-f8ad4bc1c3bb822c37022ec369453677_b.jpg"><figcaption>踩坑了</figcaption></figure><p>没关系，除了MSYS2，还有 <a href="http://link.zhihu.com/?target=https%3A//mingw-w64.org/doku.php" class=" wrap external" target="_blank" rel="nofollow noreferrer">GCC for Windows 64 &amp; 32 bits [mingw-w64]</a> 可选择，Cygwin 已经过时就不要再用了。</p><hr><h2><b>安装：</b></h2><p>安装很简单，步骤为：</p><p>下载 MinGW-w64 并解压 -&gt; 配置环境变量 Path -&gt; 配置 CLion -&gt; 安装或者配置 Rust 。</p><p><br></p><p>1、在 <a href="http://link.zhihu.com/?target=https%3A//sourceforge.net/projects/mingw-w64/files/" class=" wrap external" target="_blank" rel="nofollow noreferrer">MinGW-w64 - for 32 and 64 bit Windows</a> 页面下方可以找到安装文件，可以下载 installer 按步骤安装，也可以直接下载 7z 压缩包。我选择了 GCC-6.4.0 x86_64-posix-seh  7z 包，<a href="http://link.zhihu.com/?target=https%3A//wiki.qt.io/MinGW-64-bit" class=" wrap external" target="_blank" rel="nofollow noreferrer">线程模型和异常处理</a>以及版本和你的 Rust GNU 工具链中的 GCC 版本保持一致。</p><p><i>如果你安装了 stable-gnu 的 toolchain ，那选择一个兼容的 MinGW 版本即可，我们只会用到 GDB 相关组件；没有安装的话，就要考虑版本，因为 cargo 需要 gcc 作为后端参与编译，这个时候对 MinGW 版本是有要求的 。如果你不确定选择哪个 MinGW 版本，你可以运行 rustup toolchain install stable-gnu 来安装 gnu 工具链，完成后然后找到 .rustup\toolchains\...gnu\lib\rustlib\...-gnu\bin\ 下的工具链附带的 gcc.exe ，运行 gcc -v 来查看其信息，然后确定版本。这不是必须的，之后你可以运行 rustup toolchain uninstall stable-gnu 来删除掉。</i></p><p>将下载的 7z 压缩包解压缩到你喜欢的目录，我解压缩在 C:\Dev 下。</p><p><br></p><p>2、添加 MinGW-w64 的 bin 到环境变量 Path 中：</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-34b61eb2c0fa7b9516c7953d18441d03_b.jpg" data-caption="" data-size="normal" data-rawwidth="527" data-rawheight="340" class="origin_image zh-lightbox-thumb" width="527" data-original="https://pic4.zhimg.com/v2-34b61eb2c0fa7b9516c7953d18441d03_r.jpg"></noscript><img src="https://pic4.zhimg.com/v2-34b61eb2c0fa7b9516c7953d18441d03_b.jpg" data-caption="" data-size="normal" data-rawwidth="527" data-rawheight="340" class="origin_image zh-lightbox-thumb lazy" width="527" data-original="https://pic4.zhimg.com/v2-34b61eb2c0fa7b9516c7953d18441d03_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-34b61eb2c0fa7b9516c7953d18441d03_b.jpg"></figure><p><br></p><p>3、在 CLion 的 Settings &gt; Build, Execution, Deployment &gt; Toolchains 里配置 MinGW ：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-255ab8dd8ca699c6689d136ce0c8bd35_b.jpg" data-caption="" data-size="normal" data-rawwidth="774" data-rawheight="378" class="origin_image zh-lightbox-thumb" width="774" data-original="https://pic2.zhimg.com/v2-255ab8dd8ca699c6689d136ce0c8bd35_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-255ab8dd8ca699c6689d136ce0c8bd35_b.jpg" data-caption="" data-size="normal" data-rawwidth="774" data-rawheight="378" class="origin_image zh-lightbox-thumb lazy" width="774" data-original="https://pic2.zhimg.com/v2-255ab8dd8ca699c6689d136ce0c8bd35_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-255ab8dd8ca699c6689d136ce0c8bd35_b.jpg"></figure><p><br></p><p>4、下载并运行 <a href="http://link.zhihu.com/?target=https%3A//static.rust-lang.org/rustup/dist/x86_64-pc-windows-gnu/rustup-init.exe" class=" wrap external" target="_blank" rel="nofollow noreferrer">x86_64-pc-windows-gnu-rustup-init</a> ，按提示完成安装即可。</p><p><br></p><p><b>补充：</b></p><p>如果你下载的是默认的 rustup-init.exe ，可以先跳过它的警告，Continue 继续到下一步，输入 2 （Customize installation）回车，在 Default host triple? 下输入 x86_64-pc-windows-gnu ，剩下两项直接回车保持默认，最后输入 1 回车开始安装，效果一样：</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-5473a6cb83cfe25c84e71e3a8f37ea06_b.jpg" data-caption="" data-size="normal" data-rawwidth="591" data-rawheight="452" class="origin_image zh-lightbox-thumb" width="591" data-original="https://pic3.zhimg.com/v2-5473a6cb83cfe25c84e71e3a8f37ea06_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-5473a6cb83cfe25c84e71e3a8f37ea06_b.jpg" data-caption="" data-size="normal" data-rawwidth="591" data-rawheight="452" class="origin_image zh-lightbox-thumb lazy" width="591" data-original="https://pic3.zhimg.com/v2-5473a6cb83cfe25c84e71e3a8f37ea06_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-5473a6cb83cfe25c84e71e3a8f37ea06_b.jpg"></figure><p><br></p><p>如果你之前已经安装好了Rust，你还是可以方便地通过 rustup 来切换目标，实现交叉编译。运行 rustup target add x86_64-pc-windows-gnu 安装编译组件， cargo build --target=x86_64-pc-windows-gnu 即可生成 GNU ABI 的目标代码。交叉编译不需要切换工具链，使用你已有的工具链即可。</p><p><br></p><p>最后打开一个 Rust 项目测试下：</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-3b477faa599b0ece0e220bb6c5067a2e_b.jpg" data-size="normal" data-rawwidth="1078" data-rawheight="466" class="origin_image zh-lightbox-thumb" width="1078" data-original="https://pic3.zhimg.com/v2-3b477faa599b0ece0e220bb6c5067a2e_r.jpg"></noscript><img src="https://pic3.zhimg.com/v2-3b477faa599b0ece0e220bb6c5067a2e_b.jpg" data-size="normal" data-rawwidth="1078" data-rawheight="466" class="origin_image zh-lightbox-thumb lazy" width="1078" data-original="https://pic3.zhimg.com/v2-3b477faa599b0ece0e220bb6c5067a2e_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-3b477faa599b0ece0e220bb6c5067a2e_b.jpg"><figcaption>调试展示</figcaption></figure><hr><h2><b>后记：</b></h2><p>pc-windows-gnu 工具链是自带 gcc 和 ld 的：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-cfd8f74863437a817f33d975a35e2e99_b.jpg" data-caption="" data-size="normal" data-rawwidth="649" data-rawheight="214" class="origin_image zh-lightbox-thumb" width="649" data-original="https://pic2.zhimg.com/v2-cfd8f74863437a817f33d975a35e2e99_r.jpg"></noscript><img src="https://pic2.zhimg.com/v2-cfd8f74863437a817f33d975a35e2e99_b.jpg" data-caption="" data-size="normal" data-rawwidth="649" data-rawheight="214" class="origin_image zh-lightbox-thumb lazy" width="649" data-original="https://pic2.zhimg.com/v2-cfd8f74863437a817f33d975a35e2e99_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-cfd8f74863437a817f33d975a35e2e99_b.jpg"></figure><p>所以它可以不依赖 MSVC 生成 exe ，不过目录里的 GCC-WARNING.txt 有云：</p><blockquote>gcc.exe contained in this folder cannot be used for compiling C files - it is onlyused <br>as a linker. </blockquote><p><br></p><p>CLion 自带的 JRE 是基于 OpenJDK 的，在字体渲染上有点问题，可以把安装目录下的 jre64 删除或者重命名成其他，再在 Oracle 下载一个 .tar.gz 版本的 JRE ，解压缩后文件夹更名为 jre64 粘贴到 CLion 安装目录，或者在环境变量中配置 JAVA_HOME ，都可。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
