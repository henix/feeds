<div class="title-image"><img src="https://pic4.zhimg.com/v2-897efb5b298c75e3f8ece404672f8d6b_b.jpg" alt=""></div><blockquote>2019 年 1 月 19 日，TiDB 发布 3.0 Beta 版，对应 master branch 的 TiDB-Ansible。相比 2.1 版本，该版本对系统稳定性、优化器、统计信息以及执行引擎做了很多改进。</blockquote><h2><b>TiDB</b></h2><p><b>新特性</b></p><ul><li>支持 View</li><li>支持 Window Function</li><li>支持 Range Partition</li><li>支持 Hash Partition</li></ul><p><br></p><p><b>SQL 优化器</b></p><ul><li>重新支持聚合消除的优化规则</li><li>优化 <code>NOT EXISTS</code> 子查询，将其转化为 Anti Semi Join</li><li>添加 <code>tidb_enable_cascades_planner</code> 变量以支持新的 Cascades 优化器。目前 Cascades 优化器尚未实现完全，默认关闭</li><li>支持在事务中使用 Index Join</li><li>优化 Outer Join 上的常量传播，使得对 Join 结果里和 Outer 表相关的过滤条件能够下推过 Outer Join 到 Outer 表上，减少 Outer Join 的无用计算量，提升执行性能</li><li>调整投影消除的优化规则到聚合消除之后，消除掉冗余的 <code>Project</code> 算子</li><li>优化 <code>IFNULL</code> 函数，当输入参数具有非 NULL 的属性的时候，消除该函数</li><li>支持对 <code>_tidb_rowid</code> 构造查询的 Range，避免全表扫，减轻集群压力</li><li>优化 <code>IN</code> 子查询为先聚合后做 Inner Join 并，添加变量 <code>tidb_opt_insubq_to_join_and_agg</code> 以控制是否开启该优化规则并默认打开</li><li>支持在 <code>DO</code> 语句中使用子查询</li><li>添加 Outer Join 消除的优化规则，减少不必要的扫表和 Join 操作，提升执行性能</li><li>修改 <code>TIDB_INLJ</code> 优化器 Hint 的行为，优化器将使用 Hint 中指定的表当做 Index Join 的 Inner 表</li><li>更大范围的启用 <code>PointGet</code>，使得当 Prepare 语句的执行计划缓存生效时也能利用上它</li><li>引入贪心的 Join Reorder 算法，优化多表 Join 时 Join 顺序选择的问题</li><li>支持 View</li><li>支持 Window Function</li><li>当 <code>TIDB_INLJ</code> 未生效时，返回 warning 给客户端，增强易用性</li><li>支持根据过滤条件和表的统计信息推导过滤后数据的统计信息的功能</li><li>增强 Range Partition 的 Partition Pruning 优化规则</li></ul><p><br></p><p><b>SQL 执行引擎</b></p><ul><li>优化 Merge Join 算子，使其支持空的 <code>ON</code> 条件</li><li>优化日志，打印执行 <code>EXECUTE</code> 语句时使用的用户变量</li><li>优化日志，为 <code>COMMIT</code> 语句打印慢查询信息</li><li>支持 <code>EXPLAIN ANALYZE</code> 功能，使得 SQL 调优过程更加简单</li><li>优化列很多的宽表的写入性能</li><li>支持 <code>admin show next_row_id</code></li><li>添加变量 <code>tidb_init_chunk_size</code> 以控制执行引擎使用的初始 Chunk 大小</li><li>完善 <code>shard_row_id_bits</code>，对自增 ID 做越界检查</li></ul><p><br></p><p><b><code>Prepare</code>语句</b></p><ul><li>对包含子查询的 <code>Prepare</code> 语句，禁止其添加到 <code>Prepare</code> 语句的执行计划缓存中，确保输入不同的用户变量时执行计划的正确性</li><li>优化 <code>Prepare</code> 语句的执行计划缓存，使得当语句中包含非确定性函数的时候，该语句的执行计划也能被缓存</li><li>优化 <code>Prepare</code> 语句的执行计划缓存，使得 <code>DELETE</code>/<code>UPDATE</code>/<code>INSERT</code> 的执行计划也能被缓存</li><li>优化 <code>Prepare</code> 语句的执行计划缓存，当执行 <code>DEALLOCATE</code> 语句时从缓存中剔除对应的执行计划</li><li>优化 <code>Prepare</code> 语句的执行计划缓存，通过控制其内存使用以避免缓存过多执行计划导致 TiDB OOM 的问题</li><li>优化 <code>Prepare</code> 语句，使得 <code>ORDER BY</code>/<code>GROUP BY</code>/<code>LIMIT</code> 子句中可以使用 “?” 占位符</li></ul><p><br></p><p><b>权限管理</b></p><ul><li>增加对 <code>ANALYZE</code> 语句的权限检查</li><li>增加对 <code>USE</code> 语句的权限检查</li><li>增加对 <code>SET GLOBAL</code> 语句的权限检查</li><li>增加对 <code>SHOW PROCESSLIST</code> 语句的权限检查</li></ul><p><br></p><p><b>Server</b></p><ul><li>支持了对 SQL 语句的 <code>Trace</code> 功能</li><li>支持了插件框架</li><li>支持同时使用 <code>unix_socket</code> 和 TCP 两种方式连接数据库</li><li>支持了系统变量 <code>interactive_timeout</code></li><li>支持了系统变量 <code>wait_timeout</code></li><li>提供了变量 <code>tidb_batch_commit</code>，可以按语句数将事务分解为多个事务</li><li>支持 <code>ADMIN SHOW SLOW</code> 语句，方便查看慢日志</li></ul><p><br></p><p><b>兼容性</b></p><ul><li>支持了 <code>ALLOW_INVALID_DATES</code> 这种 SQL mode</li><li>提升了 load data 对 CSV 文件的容错能力</li><li>支持了 MySQL 320 握手协议</li><li>支持将 unsigned bigint 列声明为自增列</li><li>支持 <code>SHOW CREATE DATABASE IF NOT EXISTS</code> 语法</li><li>当过滤条件中包含用户变量时不对其进行谓词下推的操作，更加兼容 MySQL 中使用用户变量模拟 Window Function 的行为</li></ul><p><br></p><p><b>DDL</b></p><ul><li>支持快速恢复误删除的表</li><li>支持动态调整 ADD INDEX 的并发数</li><li>支持更改表或者列的字符集到 utf8/utf8mb4</li><li>默认字符集从 <code>utf8</code> 变为 <code>utf8mb4</code></li><li>支持 RANGE PARTITION</li></ul><h2><b>Tools</b></h2><p><b>TiDB-Lightning</b></p><ul><li>大幅优化 SQL 转 KV 的处理速度</li><li>对单表支持 batch 导入，提高导入性能和稳定性</li></ul><p><br></p><h2><b>PD</b></h2><ul><li>增加 <code>RegionStorage</code> 单独存储 Region 元信息</li><li>增加 shuffle hot region 调度</li><li>增加调度参数相关 Metrics</li><li>增加集群 Label 信息相关 Metrics</li><li>增加导入数据场景模拟</li><li>修复 Leader 选举相关的 Watch 问题</li></ul><p><br></p><h2><b>TiKV</b></h2><ul><li>支持了分布式 GC</li><li>在 Apply snapshot 之前检查 RocksDB level 0 文件，避免产生 Write stall</li><li>支持了逆向 <code>raw_scan</code> 和 <code>raw_batch_scan</code></li><li>更好的夏令时支持</li><li>支持了使用 HTTP 方式获取监控信息</li><li>支持批量方式接收和发送 Raft 消息</li><li>引入了新的存储引擎 Titan</li><li>升级 gRPC 到 v1.17.2</li><li>支持批量方式接收客户端请求和发送回复</li><li>多线程 Apply</li><li>线程 Raftstore</li></ul><p><br></p><p><b>英文版 Release Notes</b><br></p><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/docs/blob/master/releases/3.0beta.md" data-draft-node="block" data-draft-type="link-card" data-image="https://pic3.zhimg.com/v2-2e73d3d3251663decc70dfbbe5be5f6a_ipico.jpg" data-image-width="283" data-image-height="283" class=" wrap external" target="_blank" rel="nofollow noreferrer">pingcap/docs</a><p></p>