<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>【必看】机器学习应用量化投资必须要踩的那些坑！</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/34475061">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-1f33ef2a74bc4f6928f716dc70b99b1e_r.jpg" alt=""></div><p>前四期传送门：</p><p>【系列54】<a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653287512&amp;idx=1&amp;sn=14ee62549dab3c64468f78b3dbfd39a5&amp;chksm=802e364db759bf5bb5abffc6a50f72d0e31722c178e01ce11a3d48fb28386055e741c9ecce8d&amp;scene=21#wechat_redirect">因子的有效性分析基于7种机器学习算法</a></p><p>【系列53】<a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653287481&amp;idx=1&amp;sn=dcb1dda1e2362d8297ae1a97845cf02e&amp;chksm=802e362cb759bf3a3aaea75af824451a3dba7345ecc73e27facc4b917792835fdd2878403c8c&amp;scene=21#wechat_redirect">基于XGBoost的量化金融实战</a></p><p>【系列52】<a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653287306&amp;idx=1&amp;sn=9f374874636e7d6d52a9b3d92d6aa81b&amp;chksm=802e319fb759b8896acf2ed9529da88a8fda0d76d6a3b816854e9ad5eeecfd6f4af75dd65804&amp;scene=21#wechat_redirect">基于Python预测股价的那些人那些坑</a></p><p>【系列51】<a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653287197&amp;idx=1&amp;sn=9630389a52c7d0be4c1feaf3a534c2ce&amp;chksm=802e3108b759b81ed11174f71b23fb73abe5c4ebad0f9d480b6efbd8f7e644de6b2232dc63fa&amp;scene=21#wechat_redirect">通过ML、Time Series模型学习股价行为</a></p><img src="https://pic3.zhimg.com/v2-e38fa3ed8bcdd825f7746f42bd2e4775_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="570"><p>今天，继续我们的机器学习应用量化投资系列。本期我们介绍一篇杨勇团队撰写的研究报告。希望大家在写策略注意这些问题。 </p><h2><b>前言</b></h2><p><b>从高频到低频</b></p><p>机器学习在高频量化策略上应用更加容易。</p><p><b>从线性到非线性</b></p><p>机器学习下的非线性比线性更能榨取数据的价值，但也更容易过度拟合，因此需要合理使用。</p><p><b>从单次分析到推进分析</b></p><p>推进分析更加符合实盘状态下盘后更新模型的实际情况。</p><p><b>从分类到回归</b></p><p>回归经常能优于简单的分成两类。</p><p><b>预测值相关</b></p><p>好的预测值不一定带来好的交易信号。</p><h2><b>标准神经网络回归大盘择时策略</b></h2><p><b>1.1. 设想和目标</b></p><p>运用机器学习对过去的模式进行识别，并预测未来。也即，用当前实时数据与过去所有数据进行模式匹配，若过去模式显示会大概率上涨下跌，则相应做多做空，否则不做操作。原本该模型是为日内策略设计的，也就是收盘平仓，但由于目前平今仓手续费昂贵，所以改为第二天开盘平。</p><p><b>1.2. 理论、方法及数据源</b></p><p>和所有量化策略相似，研究假设过去发生的事情未来会重复发生（也即挑战市场弱有效的假设）。另一重要假设是指数现货和指数期货之间相关性很高，接近1。这个假设是合理，因为在流动性充足的市场，如果现货和期货之间的任何偏差都可以造成套利机会。故可以用现货做期货。方法为传统的深度学习方法。数据源来自天软、万得，主要是中证500指数，沪深300指数，以及对应的期货主力合约。</p><p><b>1.3. 交易成本与策略执行</b></p><p>在此策略的历史数据回测中，成交成本假设为日内单边千分之一，隔日单边万分之3。也即在成交中假设1.5个指数点的冲击成本。这样的假设充分包含了目前股指期货低流动性的现实。</p><p><b>1.4. 算法和模型</b></p><p>该算法共有7个模型，分别对应10:00,10:30,11:00,13:00,13:30,14:00,14:30的决策时间点。每个模型的本质是相似的，唯一的不同只在于越向后的模型，所能拥有的供机器决策数据越多。例如在10:30做决策会比10:00做决策多出半小时的数据。每个模型本身都是监督式学习。用价量指标来预测收益。若基于机器学习的预测值触及多头开仓阈值，则做多；若基于机器学习的预测值触及空头开仓阈值，则做空。反之维持原来仓位。</p><p><b>1.5. 结论</b></p><p>在日内单边千分之一，隔日单边万分之3的成交假设下，策略表现如下：</p><blockquote>夏普：3.55<br>最大回撤：17.05%<br>胜率：62.69<br>盈亏比：1.31<br>年化：80.36%</blockquote><img src="https://pic2.zhimg.com/v2-969ba198529defa23be5ac24dd392b76_r.jpg" data-caption="" data-size="normal" data-rawwidth="890" data-rawheight="337"><img src="https://pic3.zhimg.com/v2-59e13eea274e23ab5a664f85cb34d77d_r.jpg" data-caption="" data-size="normal" data-rawwidth="887" data-rawheight="351"><p><b>1.6. 策略因子归因</b></p><p>用前述的策略因子归因方法，可以看出一些非常重要的特点。</p><p>可以从图中看到，开盘的前一个小时行情数据产生的因子和收盘最后一个小时行情数据产生的因子是非常重要的，如14:30到15:00的收益。这与人的主观经验是一致的，开盘前一小时交投最活跃，基本能反应当天的市场情绪和主导全天的走势。而收盘最后一小时由于经常是对第二天情绪的猜测，所以从它的走势经常能推断出第二天市场的方向。</p><p>另外，盘中两个小时交投最不活跃，随机性也越大。单独用盘中两个小时作为因子去预测未来收益相对来说效果会差一些。</p><img src="https://pic4.zhimg.com/v2-8885a17924d2d9cec6ddec3a38dc52ed_r.jpg" data-caption="" data-size="normal" data-rawwidth="428" data-rawheight="413"><p><b>1.7. 风险点及未来的改进方向</b></p><p>风险点主要有：</p><p>（1）期货和现货突然性的暂时偏离（在当前负基差的情况下和低成交量下，尤其可能发生）</p><p>（2）市场结构发生了深刻的变化（投资者类型，投资者风险偏好等等），导致过去的数据不再能预测未来。例如去年股灾期间国家队的大规模救市。</p><p>（3）市场流动性不足，导致成交需要付出巨大成本或者无法成交。以中证500为例，本模型单笔收益大约在千分之三左右，如果买卖价差长期超过5个指数点，将对策略的盈利能力造成毁灭性的打击。目前股指期货受限以来买卖价差大约为1-2个指数点。</p><p>（4）没有合适的报撤单逻辑。如果出现单边市场，简单的用限价单的报撤会导致以最不利的价格成交。</p><p><br></p><h2><b>从低频到高频</b></h2><p>为了比较高频分钟线与日线策略的区别，我们也设计了一个日线策略。这个策略是基于传统技术指标做特征，例如昨日收盘价相对于过去几日的均线的位置，以及高开低开情况等等。去预测未来的一日的收益。</p><p><b>2.1. 算法和模型</b></p><p>该算法每日决策一次，每个模型本身都是监督式学习。用价量指标来预测收益。若基于机器学习的预测值触及多头开仓阈值，则做多；若基于机器学习的预测值触及空头开仓阈值，则做空。反之维持原来仓位。</p><p><b>2.2. 结论</b></p><p>在日内单边千分之一，隔日单边万分之3的成交假设下，策略表现如下：</p><blockquote>夏普：0.68<br>最大回撤：36.92%<br>胜率：53.21<br>盈亏比：0.99<br>年化： 19.02%</blockquote><img src="https://pic4.zhimg.com/v2-eb9ce977f34138a563fde4edbb01e911_r.jpg" data-caption="" data-size="normal" data-rawwidth="885" data-rawheight="326"><img src="https://pic2.zhimg.com/v2-5d018a9cba0517416247afae7184babb_r.jpg" data-caption="" data-size="normal" data-rawwidth="889" data-rawheight="342"><img src="https://pic4.zhimg.com/v2-2c5ecabff105fc8b09af9ef450ac22c3_r.jpg" data-caption="" data-size="normal" data-rawwidth="805" data-rawheight="163"><p><b>1.3. 高频背后的一些逻辑</b></p><p><b>2.3.1. 数据</b></p><p>通常来说，对机器学习模型，数据量越大越好。在假设能反映出目前市场的前提下，尽可能多的增加训练集的长度，对机器学习的模型算法收敛和模型稳定性是大有裨益的。假设是日线，以每年250个交易日为例，那么2010年到2017年就是大约1700个数据点。但如果是分钟线，同样是每年250个交易日，每个交易日240根分钟线，那么一共就有1700*240=408,000的数据点。显然后者就比前者多了好几个数量级。</p><p>但是并不是数据量的增加可以无限的，数据量的增加会收到其他客观条件所约束，如运算速度和交易成本。</p><p><b>2.3.1.1. 运算速度</b></p><p>举例期货的例子来说，交易所每500毫秒推送一个tick，所以理论上，2010年到2017年就可以有49,000,000个数据点。如果假设交易策略是简单的每500毫秒预测一次，那么数据点的增加在实盘中就并没有什么用处。因为在CPU下，神经网络的计算用时不太可能在500毫秒之内。所以在一个决策时间点内没有算完，就已经进入了下一个决策时间点，实盘当中根本交易不到。</p><p><b>2.3.1.2. 交易成本</b></p><p>同样上一个期货的例子。如果是非做市类策略，那么算上冲击成本后的交易成本通常双边至少要达到千分之一。在500毫秒乃至更长一些的时间尺度，由于时间时间尺度偏短，波动很难非常大，所以这是一个非常难覆盖交易成本。</p><p><b>2.3.1.3. 日内消息面</b></p><p>国内股市实行每日交易时间是四份小时。四个小时内出现基本面新消息的概率较小。而隔日的话，各种消息面容易打破股价自身的运行规律。使得预测的准确性大幅降低。</p><p><b>2.3.1.4.</b> 行为金融</p><p>人的行为在短期内是比较固定的。比如日内短线的追涨杀跌等等，这些都是由人性所决定的。但是随着时间的拉长，特别是两个交易日之间，人会冷静下来，情绪会淡化。</p><p><br></p><h2><b>从线性到非线性</b></h2><p>为了比较线性模型与非线性模型的区别，我们也设计了一个线性模型。这个策略是基于传统线性核函数的支持向量机回归，使用标准的神经网络回归策略一样的因子和预测目标。</p><p><b>3.1. 算法和模型</b></p><p>算法与模型基本和标准的神经网络回归策略一样，不同的是，神经网络被替换成了线性核函数的支持向量机回归。</p><p><b>3.2. 结论</b></p><p>在日内单边千分之一，隔日单边万分之3的成交假设下，策略表现如下：</p><blockquote>夏普：0.95<br>最大回撤：29.71%<br>胜率：49.64<br>盈亏比：1.23<br>年化：17.67%</blockquote><img src="https://pic4.zhimg.com/v2-b6f5f4fb6371357a81405e6feabb7fe4_r.jpg" data-caption="" data-size="normal" data-rawwidth="887" data-rawheight="338"><img src="https://pic3.zhimg.com/v2-38f522e07fa61e47311117d06f41a886_r.jpg" data-caption="" data-size="normal" data-rawwidth="894" data-rawheight="367"><img src="https://pic3.zhimg.com/v2-83118faa54190d798b117e216be46a8f_r.jpg" data-caption="" data-size="normal" data-rawwidth="892" data-rawheight="337"><img src="https://pic1.zhimg.com/v2-6e3d0f4d07ea71a48f83947786d68033_r.jpg" data-caption="" data-size="normal" data-rawwidth="798" data-rawheight="163"><p><b>3.3. 非线性背后的一些逻辑和讨论</b></p><p><b>3.3.1. 金融市场大概率是非线性的</b></p><p>金融市场大概率是非线性的，举例而言，业内研究发现，不是高开幅度越大，当日的后续走势就越向上。如果当日高开0~0.5%左右，那么当日大概率是上扬的，但是如果高开的过大，当日就容易高开低走。</p><p><b>3.3.2.  Bias-VarianceTrade off</b></p><img src="https://pic4.zhimg.com/v2-e463aeb59570d5950456182d6adeb3fe_r.jpg" data-caption="" data-size="normal" data-rawwidth="723" data-rawheight="1188"><img src="https://pic4.zhimg.com/v2-1acc02f20b8c80ed566fa29a70784ddf_r.jpg" data-caption="Dropout 算法" data-size="normal" data-rawwidth="500" data-rawheight="230"><p>如上图所示，被舍弃的神经元用X表示出来了。所有指向它和从它发出的有向箭头都被斩断。</p><p><b>3.3.3. 人的理解方式经常是线性的</b></p><p>正向线性思维的特点是，思维从某一个点开始，沿着正向向前以线性拓展，经过一个或是几个点，最终达到思维的正确结果。举例而言，经常有人会认为，如果过去100年平均每年的生产力提升是一千亿，那么未来一年统计上的期望生产力提升也是一千亿。这里就犯了一个常见错误。人类生产力的提升经常是指数级别上升的，所以未来一年统计上的期望生产力提升应该不止一千亿。</p><p>正是因为人的思维方式是线性的，在理解非线性的时候会直观上比较困难。为了增加读者对非线性的直观理解，我们将在下一篇中重点阐述。</p><p><br></p><h2><b>从单次分析到推进分析</b></h2><p><b>4.1. 算法和模型</b></p><p>算法与模型基本和标准的神经网络回归策略一样，不同的是，我们这次要比较第一篇报告中写了单次分析和推进分析。</p><p>下面是单次分析的常见方法：</p><img src="https://pic4.zhimg.com/v2-10eaa572edc2c9bb80992ac07ad96e93_r.jpg" data-caption="" data-size="normal" data-rawwidth="724" data-rawheight="74"><p>上图给了一个单次分析的实例。实际上单次分析就是把整个样本分为互不重叠的两个部分。白色的是样本内，灰色的是样本外。首先用样本内的数据训练机器学习模型，然后用这个建立好的机器学习模型直接放入样本外数据进行检验，如果在样本外的数据依然说明该模型效果很好，那么在一定程度上说明该模型可以处理实际的问题而推进分析的样本内外常常变化。</p><img src="https://pic4.zhimg.com/v2-47f7b1b20a6dda17406cb528e7ab7c56_r.jpg" data-caption="" data-size="normal" data-rawwidth="730" data-rawheight="194"><p>上图是一种推进分析的方法。推进分析有个最为明显的特点，就是样本外的交易长度仅为一个交易周期。同样的，首先用样本内的数据训练机器学习模型，然后用这个建立好的机器学习模型直接放入样本外数据进行检验。在T1时刻，用0~T1的数据训练模型，然后在T1~T2的数据去检验模型；在T2时刻，用0~T2的数据训练模型，然后在T2~T3的数据去检验模型；在T3时刻，用0~T3的数据训练模型，然后在T3~T4的数据去检验模型，以此类推。最后将所有灰色框内的检验结果汇总，就是推进分析下总的样本外结果。</p><p><b>4.2. 结论</b></p><p>在日内单边千分之一，隔日单边万分之3的成交假设下，策略表现如下：</p><blockquote>夏普：2.66<br>最大回撤：17.24%<br>胜率：57.56<br>盈亏比：1.22<br>年化：56.38%</blockquote><img src="https://pic4.zhimg.com/v2-93f1c4b4391948be4591dd72568ab5d4_r.jpg" data-caption="" data-size="normal" data-rawwidth="885" data-rawheight="282"><img src="https://pic1.zhimg.com/v2-a03e23c9026dca225287389073ab33a8_r.jpg" data-caption="" data-size="normal" data-rawwidth="888" data-rawheight="298"><img src="https://pic2.zhimg.com/v2-b029cadec3c51aa0d869a68378d78f88_r.jpg" data-caption="" data-size="normal" data-rawwidth="888" data-rawheight="343"><img src="https://pic3.zhimg.com/v2-bfd31babbaccc71c254dd3bd81034547_r.jpg" data-caption="" data-size="normal" data-rawwidth="794" data-rawheight="162"><p><b>4.3. 单次分析和推进分析的逻辑讨论</b></p><p>在逻辑上，推进分析更接近实盘。因为在实盘中，经常地，模型会每日在盘后更新。所以如果是这样，在回测时候，也应该假定，在T日末，模型会被重新训练，也即是站在T日的模型和站在T+1的模型也应当是不一样的。这样做的显著好处是，不论是回测还是实盘，每个模型都能用到站在当前时点上最新的数据。坏处也很显著，在回测时候，对历史上的每一天都要建立一个模型，这样的计算量是巨大的。</p><p>另外推进分析也有不同的方法。</p><img src="https://pic1.zhimg.com/v2-9627ee0c4ec83e3ce7b73450a6051e84_r.jpg" data-caption="" data-size="normal" data-rawwidth="810" data-rawheight="208"><p>上图是另一种推进分析的方法（Rolling）。与之前推进分析的方法不同，在T2时刻，用0~T2的数据训练模型，然后在T2~T3的数据去检验模型；在T3时刻，我们并不像之前一样，用0~T3的数据训练模型，而是用T1~T3的数据训练模型，然后同样的在T3~T4的数据去检验模型，以此类推。最后将所有灰色框内的检验结果汇总，就是推进分析下总的样本外结果。</p><p>使用全样本做推进分析和使用过去n期样本做推进分析之间没有优劣之分。选择时候大体上要遵循两个基本原则，一个是数据要具有对当前市场状态的代表性，另一个数据量要尽可能多。使用过去n期样本通常能对当前市场状态的代表性，使用全样本做推进分析。</p><p><br></p><h2><b>从分类到回归</b></h2><p><b>5.1. 算法和模型</b></p><p>算法与模型基本和标准的神经网络回归策略一样，不同的是，预测目标不再是某段时间的收益，而是一个二分类。也即，大于0的时候是上涨分类，小于0的时候是下跌分类。</p><p><b>5.2. 结论</b></p><p>在日内单边千分之一，隔日单边万分之3的成交假设下，策略表现如下：</p><blockquote>夏普：1.66<br>最大回撤：25.30%<br>胜率：49.72%<br>盈亏比：1.39<br>年化：30.91%</blockquote><img src="https://pic2.zhimg.com/v2-3362bc9ff3f7b250fcbf5675523f1925_r.jpg" data-caption="" data-size="normal" data-rawwidth="888" data-rawheight="294"><img src="https://pic3.zhimg.com/v2-0d537f23041608c16a00817b2b13dfb1_r.jpg" data-caption="" data-size="normal" data-rawwidth="888" data-rawheight="319"><img src="https://pic4.zhimg.com/v2-91b71a3b927eb85ca174dba987737674_r.jpg" data-caption="" data-size="normal" data-rawwidth="895" data-rawheight="341"><img src="https://pic1.zhimg.com/v2-edb04cc8fc9e8ed1d0c010294eddc976_r.jpg" data-caption="" data-size="normal" data-rawwidth="800" data-rawheight="162"><p><b>5.3. 分类与回归的逻辑讨论</b></p><p>分类的逻辑是，市场的状态是离散可分的。如果按照上例，涨0.1%和涨10%都会归结到上涨一栏。但是事实上，涨0.1%和涨10%是截然不同的，前者很可能是随机扰动，而后者一定是市场情绪的体现。但是随机扰动与市场情绪的分界点是很难确定的，涨0.1%是随机扰动，但是涨0.5%是不是随机扰动呢？所以分类有个天生的问题，以什么标准来划分类，如何划分类？我们也曾经尝试过划分成5类，7类，但是由于划分的类过多，效果也不及二分类。</p><p><br></p><h2><b>预测值相关</b></h2><p><b>6.1. 算法和模型</b></p><p>算法与模型基本和标准的神经网络回归策略一样。在标准神经网络回归，我们只有当大于一个阈值的时候，做多。小于一个阈值的时候做空。但是在该策略中，再算出预测值后，直接预测值大于0就做多，小于0就做空。</p><p><b>6.2. 结论</b></p><p>在日内单边千分之一，隔日单边万分之3的成交假设下，策略表现如下：</p><blockquote>夏普：2.17<br>最大回撤：26.05%<br>胜率：46.68%<br>盈亏比：1.75<br>年化：43.92%</blockquote><img src="https://pic4.zhimg.com/v2-4a1631f8ec1b942036d0c37561aca1e4_r.jpg" data-caption="" data-size="normal" data-rawwidth="888" data-rawheight="318"><img src="https://pic1.zhimg.com/v2-1d079e829a45e76f1099cc8e856aed04_r.jpg" data-caption="" data-size="normal" data-rawwidth="890" data-rawheight="338"><img src="https://pic1.zhimg.com/v2-2e27e4c6c26a27ecaa9f320b06d5db53_r.jpg" data-caption="" data-size="normal" data-rawwidth="888" data-rawheight="354"><img src="https://pic1.zhimg.com/v2-808a4d46bf83936d11d563571d80d7a9_r.jpg" data-caption="" data-size="normal" data-rawwidth="800" data-rawheight="164"><p><b>6.3. 预测值相关的逻辑</b></p><p>预测值可以从上述的回测看到，预测值如果按照简单的大于0，小于0交易，效果并不是特别出色。目前业内比较公认的结论是，预测值的强度代表方向的概率。举例而言，如果一个预测值是0.1%，一个是1%，那么后者实际上涨的概率大于前者。因此，选择一个合适的阈值变的至关重要。可能的确定阈值的方法可以是，历史上预测值的平均数加上一个历史上预测值的标准差作为看多阈值；历史上预测值的平均数减去一个历史上预测值的标准差作为看空阈值。</p><p>一个绝对值较大的预测阈值容易漏掉一些真正的上涨机会（统计上的Type II error），而一个绝对值比较小的预测阈值容易错误的开多仓（统计上的Type I error）。同时，绝对值预测阈值越小，越容易达到阈值，越容易触发交易，交易频率就越高，交易成本就越高。反之交易就越不频繁，交易成本就越低。</p><p>杨勇团队</p><p>分析师：周袤</p><p>联系方式：18601798125</p><b><img src="https://pic1.zhimg.com/v2-4cf3f189e3fb128dc0be0314b7e07019_r.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="367"></b><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
