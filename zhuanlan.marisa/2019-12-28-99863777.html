<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>半环和迷宫</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/99863777">原文</a></p>
<p>故事要靠设置悬念吸引读者，比如迷宫探险。希腊神话有米诺斯的迷宫，讲的是可怜的王子要去斩杀牛头怪，借助了公主赠与的毛线团才成功走出迷宫。中国的迷宫故事有点不一样，走迷宫从来不是技术活，重点是心魔，至于打破心魔拿到宝物以后故事就没有悬念了。跟米诺斯迷宫比较类似的是蚁穿九珠曲，讲的是松赞干布的求婚使者借助蚂蚁和蜜糖完成丝穿九曲明珠的的故事。我觉得迷宫故事有悬念跟递归程序有结果很类似，弹性毛线团就像尾递归的返回值，处理好探索迷宫的顺序，找到牛头怪就对了，而蚂蚁身上绑的丝线就像是原始递归的高阶carrier，可以用来标记或者缓存所有中间结果，借助CPS风格还能让我们逆转这些结果的构造顺序，有人用thread描述在递归函数中把普通carrier提升为高阶carrier的行为，我觉得非常形象，另外Haskell的tying the knot甚至能让我们在探索过程中同时使用来自过去和未来的结果。在Haskell里实现递归如此自然而美好得益于inductive type和recursion schemes，递归程序变成了递归数据结构之间的整体变换，最好的情况是分而治之用pattern functor把输入展开再折叠成输出<sup data-text="" data-url="https://bartoszmilewski.com/2018/12/20/open-season-on-hylomorphisms/" data-draft-node="inline" data-draft-type="reference" data-numero="1">[1]</sup>，数据结构动态地驱动计算逻辑，想避免类型封闭的坏处还可以用finally tagless直接表示输出结果抽象语法树的折叠过程，这样就省掉了展开这一步，往往比较复杂的情况是在动态规划折叠过程中如何选择carrier，了解一些常见的代数结构非常有帮助。</p><div class="highlight"><pre><code class="language-haskell"><span class="cm">{-# LANGUAGE TypeFamilies      #-}</span>
<span class="cm">{-# LANGUAGE ViewPatterns      #-}</span>
<span class="cm">{-# LANGUAGE DeriveFunctor     #-}</span>
<span class="cm">{-# LANGUAGE FlexibleContexts  #-}</span>
<span class="cm">{-# LANGUAGE OverloadedStrings #-}</span>

<span class="kr">import</span> <span class="nn">Data.String</span>
<span class="kr">import</span> <span class="nn">Test.QuickCheck</span> <span class="k">hiding</span> <span class="p">(</span><span class="nf">label</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Bool</span> <span class="p">(</span><span class="nf">bool</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Monoid</span> <span class="p">((</span><span class="o">&lt;&gt;</span><span class="p">))</span>
<span class="kr">import</span> <span class="nn">Data.Char</span> <span class="p">(</span><span class="nf">isAlphaNum</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Foldable</span> <span class="p">(</span><span class="nf">toList</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Control.Lens</span> <span class="k">hiding</span> <span class="p">((</span><span class="o">&lt;.&gt;</span><span class="p">))</span>
<span class="kr">import</span> <span class="nn">Control.Arrow</span> <span class="p">((</span><span class="o">&amp;&amp;&amp;</span><span class="p">),</span> <span class="p">(</span><span class="o">***</span><span class="p">))</span>
<span class="kr">import</span> <span class="nn">Control.Applicative</span> <span class="p">(</span><span class="nf">liftA2</span><span class="p">,</span> <span class="nf">liftA3</span><span class="p">)</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Set</span> <span class="k">as</span> <span class="n">S</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Map</span> <span class="k">as</span> <span class="n">M</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.IntSet</span> <span class="k">as</span> <span class="n">IS</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.IntMap</span> <span class="k">as</span> <span class="n">IM</span></code></pre></div><p>今天我们来聊聊一个同时存在两种折叠方法的代数结构——半环。文中很多例子都可以用catamorphism，histomorphism，hylomorphism来写，当然有些在五行之外，比如图，我们会聊到Andrey Mokhov和Martin Erwig在Algebraic Graph方面的探索。半环是包含两种兼容幺半群的一种代数结构（R，+，*，0，1），这套表示来源于自然数，对应着计数的加法原理和乘法原理。半环需要满足环的一系列公理，比如加法和乘法满足幺半群公理，严格来说环的乘法并不需要幺元的存在，此外还要求加法可交换。所谓兼容意味着乘法之于加法可分配，另外加法的幺元可吸收，这是额外添加的半环公理，因为相比于环缺少了加法逆元无法证明加法幺元可吸收。如果定义好合适的相等关系，这些公理都可以作为QuickCheck的特性。自然数和布尔代数是最常见的两种半环结构，布尔代数常常用来解释闭包性质，比如连通性或者判定问题。此外两种半环类型的积仍然是半环，类似于predicate可组合，返回值是半环的一元函数是半环。任何的半环都包含两种幺半群，可以定义相应的加法幺半群和乘法幺半群wrapper，接着定义对应半环列表的折叠，即累和累积，布尔代数的add其实就是any，mul其实就是all。把半环和自然数的类比继续下去，还可以定义向量的点乘，即乘积和。<br/></p><div class="highlight"><pre><code class="language-haskell"><span class="c1">-- (R, +, *, 0, 1)</span>
<span class="c1">-- (R, +, 0) commutative monoid</span>
<span class="c1">-- (R, *, 1) monoid</span>
<span class="c1">-- distributive: (r1 + r2) * r3 = r1 * r3 + r2 * r3, r1 * (r2 + r3) = r1 * r2 + r1 * r3</span>
<span class="c1">-- annihilating: zero * r = zero = r * zero</span>
<span class="kr">class</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="kr">where</span>
  <span class="nf">zero</span><span class="p">,</span> <span class="nf">one</span> <span class="ow">::</span> <span class="nf">r</span>  
  <span class="p">(</span><span class="o">&lt;+&gt;</span><span class="p">)</span> <span class="ow">::</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
  <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span> <span class="ow">::</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
  
  <span class="nf">add</span> <span class="ow">::</span> <span class="kt">Foldable</span> <span class="nf">t</span> <span class="ow">=&gt;</span> <span class="nf">t</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
  <span class="nf">add</span> <span class="ow">=</span> <span class="nf">foldr</span> <span class="p">(</span><span class="o">&lt;+&gt;</span><span class="p">)</span> <span class="nf">zero</span>
  
  <span class="nf">mul</span> <span class="ow">::</span> <span class="kt">Foldable</span> <span class="nf">t</span> <span class="ow">=&gt;</span> <span class="nf">t</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
  <span class="nf">mul</span> <span class="ow">=</span> <span class="nf">foldr</span> <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span> <span class="nf">one</span>

  <span class="nf">dot</span> <span class="ow">::</span> <span class="kt">Foldable</span> <span class="nf">t</span> <span class="ow">=&gt;</span> <span class="nf">t</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">t</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
  <span class="nf">dot</span> <span class="nf">xs</span> <span class="nf">ys</span> <span class="ow">=</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">zipWith</span> <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span> <span class="p">(</span><span class="nf">toList</span> <span class="nf">xs</span><span class="p">)</span> <span class="p">(</span><span class="nf">toList</span> <span class="nf">ys</span><span class="p">))</span>
    
<span class="kr">infixl</span> <span class="mi">6</span> <span class="o">&lt;+&gt;</span>
<span class="kr">infixl</span> <span class="mi">7</span> <span class="o">&lt;.&gt;</span>
  
<span class="nf">law_commA</span> <span class="nf">a</span> <span class="nf">b</span> <span class="ow">=</span> <span class="nf">a</span> <span class="o">&lt;+&gt;</span> <span class="nf">b</span> <span class="o">==</span> <span class="nf">b</span> <span class="o">&lt;+&gt;</span> <span class="nf">a</span>
<span class="nf">law_unitA</span> <span class="nf">a</span> <span class="ow">=</span> <span class="nf">zero</span> <span class="o">&lt;+&gt;</span> <span class="nf">a</span> <span class="o">==</span> <span class="nf">a</span> <span class="o">&amp;&amp;</span> <span class="nf">a</span> <span class="o">&lt;+&gt;</span> <span class="nf">zero</span> <span class="o">==</span> <span class="nf">a</span>
<span class="nf">law_asscA</span> <span class="nf">a</span> <span class="nf">b</span> <span class="nf">c</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">a</span> <span class="o">&lt;+&gt;</span> <span class="nf">b</span><span class="p">)</span> <span class="o">&lt;+&gt;</span> <span class="nf">c</span> <span class="o">==</span> <span class="nf">a</span> <span class="o">&lt;+&gt;</span> <span class="p">(</span><span class="nf">b</span> <span class="o">&lt;+&gt;</span> <span class="nf">c</span><span class="p">)</span>
<span class="nf">law_unitM</span> <span class="nf">a</span> <span class="ow">=</span> <span class="nf">one</span> <span class="o">&lt;.&gt;</span> <span class="nf">a</span> <span class="o">==</span> <span class="nf">a</span> <span class="o">&amp;&amp;</span> <span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="nf">one</span> <span class="o">==</span> <span class="nf">a</span>
<span class="nf">law_asscM</span> <span class="nf">a</span> <span class="nf">b</span> <span class="nf">c</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="nf">b</span><span class="p">)</span> <span class="o">&lt;.&gt;</span> <span class="nf">c</span> <span class="o">==</span> <span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="p">(</span><span class="nf">b</span> <span class="o">&lt;.&gt;</span> <span class="nf">c</span><span class="p">)</span>
<span class="nf">law_anniL</span> <span class="nf">a</span> <span class="ow">=</span> <span class="nf">zero</span> <span class="o">&lt;.&gt;</span> <span class="nf">a</span> <span class="o">==</span> <span class="nf">zero</span>
<span class="nf">law_anniR</span> <span class="nf">a</span> <span class="ow">=</span> <span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="nf">zero</span> <span class="o">==</span> <span class="nf">zero</span>
<span class="nf">law_distL</span> <span class="nf">a</span> <span class="nf">b</span> <span class="nf">c</span> <span class="ow">=</span> <span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="p">(</span><span class="nf">b</span> <span class="o">&lt;+&gt;</span> <span class="nf">c</span><span class="p">)</span> <span class="o">==</span> <span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="nf">b</span> <span class="o">&lt;+&gt;</span> <span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="nf">c</span>
<span class="nf">law_distR</span> <span class="nf">a</span> <span class="nf">b</span> <span class="nf">c</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">a</span> <span class="o">&lt;+&gt;</span> <span class="nf">b</span><span class="p">)</span> <span class="o">&lt;.&gt;</span> <span class="nf">c</span> <span class="o">==</span> <span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="nf">c</span> <span class="o">&lt;+&gt;</span> <span class="nf">b</span> <span class="o">&lt;.&gt;</span> <span class="nf">c</span>

<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="kt">Bool</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="kt">False</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="kt">True</span>
  <span class="p">(</span><span class="o">&lt;+&gt;</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="o">||</span><span class="p">)</span>
  <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="o">&amp;&amp;</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="kt">Integer</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="mi">0</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="mi">1</span>
  <span class="p">(</span><span class="o">&lt;+&gt;</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span>
  <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span>
  
<span class="kr">instance</span> <span class="p">(</span><span class="kt">Semiring</span> <span class="nf">r</span><span class="p">,</span> <span class="kt">Semiring</span> <span class="nf">s</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Semiring</span> <span class="p">(</span><span class="nf">r</span><span class="p">,</span> <span class="nf">s</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">zero</span><span class="p">,</span> <span class="nf">zero</span><span class="p">)</span>
  <span class="nf">one</span>  <span class="ow">=</span> <span class="p">(</span><span class="nf">one</span> <span class="p">,</span> <span class="nf">one</span> <span class="p">)</span>
  <span class="p">(</span><span class="nf">r1</span><span class="p">,</span> <span class="nf">s1</span><span class="p">)</span> <span class="o">&lt;+&gt;</span> <span class="p">(</span><span class="nf">r2</span><span class="p">,</span> <span class="nf">s2</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">r1</span> <span class="o">&lt;+&gt;</span> <span class="nf">r2</span><span class="p">,</span> <span class="nf">s1</span> <span class="o">&lt;+&gt;</span> <span class="nf">s2</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">r1</span><span class="p">,</span> <span class="nf">s1</span><span class="p">)</span> <span class="o">&lt;.&gt;</span> <span class="p">(</span><span class="nf">r2</span><span class="p">,</span> <span class="nf">s2</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">r1</span> <span class="o">&lt;.&gt;</span> <span class="nf">r2</span><span class="p">,</span> <span class="nf">s1</span> <span class="o">&lt;.&gt;</span> <span class="nf">s2</span><span class="p">)</span>  

<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">Semiring</span> <span class="p">(</span><span class="nf">x</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="nf">const</span> <span class="nf">zero</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="nf">const</span> <span class="nf">one</span>
  <span class="p">(</span><span class="o">&lt;+&gt;</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">liftA2</span> <span class="p">(</span><span class="o">&lt;+&gt;</span><span class="p">)</span>
  <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">liftA2</span> <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span></code></pre></div><p><br/>在看具体的例子之前，再介绍几个辅助类型类。类似于自由幺半群的生成元或者生成文法的字符，我们定义一个类型类Language来把字符提升为半环。如果半环存在偏序关系，给半环添加求不动点的闭包运算就构成Kleene Algebra，可以用来解决图的最短最长最宽路径问题，其实就是Floyd–Warshall最短路径算法。事实上半环与动态规划的联系比这还要紧密，许多最优子结构都依赖半环的单调有序性。之前聊到偏序关系可以由格用代数方法定义，我们可以用半环的加法运算往半环上加序结构。为什么是加法呢？因为乘法不可交换。直觉上可以想成编写词典，乘法是用字符构造单词，加法把单词总结为词典，类似的乘法对应着动态规划的不同阶段，加法对应着每个阶段的总结，单调性保证了最后得到的是整个问题的最大值或者最小值，也就是最优子结构<sup data-text="Huang, Liang. 2008. Advanced Dynamic Programming in Semiring and Hypergraph Frameworks" data-url="" data-draft-node="inline" data-draft-type="reference" data-numero="2">[2]</sup>。半环跟许多代数结构联系非常紧密，比如分配格就是一种加法乘法满足幂等律的半环，半模是定义在半环基础上的一种代数结构，典型的例子就是线性代数的向量空间。<br/></p><div class="highlight"><pre><code class="language-haskell"><span class="c1">-- idempotent: r + r = r</span>
<span class="c1">-- partial order: a &lt;= b &lt;=&gt; lub a b = b</span>
<span class="c1">-- idepotent imply monotonic: a &lt;= b =&gt; a &lt;+&gt; r &lt;= b &lt;+&gt; r, &lt;.&gt; r &lt;= b &lt;.&gt; r, r &lt;.&gt; a &lt;= r &lt;.&gt; b    </span>
<span class="kr">class</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">IdempotentSemiring</span> <span class="nf">r</span> <span class="kr">where</span>
  <span class="nf">lub</span> <span class="ow">::</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
  <span class="nf">lub</span> <span class="ow">=</span> <span class="p">(</span><span class="o">&lt;+&gt;</span><span class="p">)</span>

<span class="c1">-- (S, +, *, 0, 1), closed</span>
<span class="c1">-- fixpoint: star r = one + r * star r</span>
<span class="kr">class</span> <span class="kt">IdempotentSemiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">KleeneAlgebra</span> <span class="nf">r</span> <span class="kr">where</span>
  <span class="nf">star</span> <span class="ow">::</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
  <span class="nf">star</span> <span class="nf">r</span> <span class="ow">=</span> <span class="nf">one</span> <span class="o">&lt;+&gt;</span> <span class="nf">plus</span> <span class="nf">r</span>
  
  <span class="nf">plus</span> <span class="ow">::</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
  <span class="nf">plus</span> <span class="nf">r</span> <span class="ow">=</span> <span class="nf">r</span> <span class="o">&lt;.&gt;</span> <span class="nf">star</span> <span class="nf">r</span>
  
<span class="kr">class</span> <span class="kt">Language</span> <span class="nf">a</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="nf">a</span>
  <span class="nf">symbol</span> <span class="ow">::</span> <span class="kt">Alphabet</span> <span class="nf">a</span> <span class="ow">-&gt;</span> <span class="nf">a</span>

<span class="kr">instance</span> <span class="kt">Language</span> <span class="kt">Char</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="kt">Char</span> <span class="ow">=</span> <span class="kt">Char</span>  
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="nf">id</span>

<span class="kr">instance</span> <span class="kt">Language</span> <span class="kt">Int</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="kt">Int</span> <span class="ow">=</span> <span class="kt">Int</span>  
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="nf">id</span>
  
<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Language</span> <span class="nf">b</span><span class="p">,</span> <span class="p">(</span><span class="kt">Alphabet</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">b</span><span class="p">)</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="nf">a</span><span class="p">,</span> <span class="nf">b</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="nf">a</span><span class="p">,</span> <span class="nf">b</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="nf">a</span><span class="p">,</span> <span class="nf">b</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">Alphabet</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">b</span><span class="p">)</span>  
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="nf">symbol</span> <span class="o">***</span> <span class="nf">symbol</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">a</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="nf">x</span> <span class="ow">-&gt;</span> <span class="nf">a</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="nf">x</span> <span class="ow">-&gt;</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="nf">x</span> <span class="ow">-&gt;</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Alphabet</span> <span class="nf">a</span>  
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="nf">const</span> <span class="o">.</span> <span class="nf">symbol</span>

<span class="kr">instance</span> <span class="kt">Language</span> <span class="p">[</span><span class="nf">a</span><span class="p">]</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">[</span><span class="nf">a</span><span class="p">]</span> <span class="ow">=</span> <span class="p">[</span><span class="nf">a</span><span class="p">]</span>  
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="nf">id</span>
  
<span class="kr">newtype</span> <span class="kt">Add</span> <span class="nf">r</span> <span class="ow">=</span> <span class="kt">Add</span> <span class="nf">r</span> <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Eq</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">Monoid</span> <span class="p">(</span><span class="kt">Add</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">mempty</span> <span class="ow">=</span> <span class="kt">Add</span> <span class="nf">zero</span>
  <span class="kt">Add</span> <span class="nf">r1</span> <span class="p">`</span><span class="nf">mappend</span><span class="p">`</span> <span class="kt">Add</span> <span class="nf">r2</span> <span class="ow">=</span> <span class="kt">Add</span> <span class="p">(</span><span class="nf">r1</span> <span class="o">&lt;+&gt;</span> <span class="nf">r2</span><span class="p">)</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">r</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">r</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Add</span> <span class="nf">r</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="kt">Add</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Add</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Alphabet</span> <span class="nf">r</span>
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="kt">Add</span> <span class="o">.</span> <span class="nf">symbol</span>
  
<span class="kr">newtype</span> <span class="kt">Mul</span> <span class="nf">r</span> <span class="ow">=</span> <span class="kt">Mul</span> <span class="nf">r</span> <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Eq</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">Monoid</span> <span class="p">(</span><span class="kt">Mul</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">mempty</span> <span class="ow">=</span> <span class="kt">Mul</span> <span class="nf">one</span>
  <span class="kt">Mul</span> <span class="nf">r1</span> <span class="p">`</span><span class="nf">mappend</span><span class="p">`</span> <span class="kt">Mul</span> <span class="nf">r2</span> <span class="ow">=</span> <span class="kt">Mul</span> <span class="p">(</span><span class="nf">r1</span> <span class="o">&lt;.&gt;</span> <span class="nf">r2</span><span class="p">)</span> 

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">r</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">r</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Mul</span> <span class="nf">r</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="kt">Mul</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Mul</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Alphabet</span> <span class="nf">r</span>
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="kt">Mul</span> <span class="o">.</span> <span class="nf">symbol</span></code></pre></div><p><br/>第一个例子是集合，集合加上最常见的两种运算交与并就构成一个满足公理的半环，这里为了避免谈论集合的有限性，我们添加了特殊集合表示全集，如果仅仅考虑有限集合的幂集就不必如此，此外集合的差和交，并和补两两也都构成半环。如果集合的元素是幺半群，那么集合还有另外一种半环结构，这几乎可以算是自由半环，其实Haskell定义自由半环不太容易，主要是因为表示自由可交换幺半群不易，如果用Set [a]则增添了多余的公理，而用[[a]]则缺少必需的公理。这种表示是定义形式语言的基础，形式语言可能是用到半环最多的领域了，表示形式语言的形式文法，自动机，状态机以及正则表达式都跟半环有关，识别形式语言的CKY算法和Viterbi算法也都是半环的应用，Dolan的Fun With Semiring<sup data-text="Stephen Dolan. 2013. Fun with semirings: a functional pearl on the abuse of linear algebra" data-url="" data-draft-node="inline" data-draft-type="reference" data-numero="3">[3]</sup>强烈建议读一读，里面讲到了线性变换作为半环的各种有趣应用。<br/></p><div class="highlight"><pre><code class="language-haskell"><span class="c1">-- semiring over set, powerset, upper sets</span>
<span class="c1">-- (union, intersection) (symmetic difference, intersection) (union, relative complement)</span>
<span class="kr">data</span> <span class="kt">Set</span> <span class="nf">a</span> <span class="ow">=</span> <span class="kt">Universe</span> <span class="o">|</span> <span class="kt">Set</span> <span class="p">(</span><span class="kt">S</span><span class="o">.</span><span class="kt">Set</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Eq</span><span class="p">)</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Ord</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Arbitrary</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Arbitrary</span> <span class="p">(</span><span class="kt">Set</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">arbitrary</span> <span class="ow">=</span> <span class="nf">sized</span> <span class="nf">gen</span> <span class="kr">where</span>
    <span class="nf">gen</span> <span class="nf">n</span> <span class="ow">=</span> <span class="nf">choose</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">n</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="nf">\k</span> <span class="ow">-&gt;</span> <span class="kr">if</span> <span class="nf">k</span> <span class="o">==</span> <span class="nf">n</span> <span class="kr">then</span> <span class="nf">return</span> <span class="kt">Universe</span> <span class="kr">else</span> <span class="nf">fmap</span> <span class="kt">Set</span> <span class="p">(</span><span class="nf">resize</span> <span class="nf">k</span> <span class="nf">arbitrary</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Ord</span> <span class="nf">a</span> <span class="ow">=&gt;</span> <span class="kt">Semiring</span> <span class="p">(</span><span class="kt">Set</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="kt">Set</span> <span class="kt">S</span><span class="o">.</span><span class="nf">empty</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="kt">Universe</span>
  <span class="kt">Universe</span> <span class="o">&lt;+&gt;</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">Universe</span>
  <span class="kr">_</span> <span class="o">&lt;+&gt;</span> <span class="kt">Universe</span> <span class="ow">=</span> <span class="kt">Universe</span>
  <span class="kt">Set</span> <span class="nf">a</span> <span class="o">&lt;+&gt;</span> <span class="kt">Set</span> <span class="nf">b</span><span class="ow">=</span> <span class="kt">Set</span> <span class="o">$</span> <span class="kt">S</span><span class="o">.</span><span class="nf">union</span> <span class="nf">a</span> <span class="nf">b</span>
  <span class="kt">Universe</span> <span class="o">&lt;.&gt;</span> <span class="nf">a</span> <span class="ow">=</span> <span class="nf">a</span>
  <span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="kt">Universe</span> <span class="ow">=</span> <span class="nf">a</span>
  <span class="kt">Set</span> <span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="kt">Set</span> <span class="nf">b</span><span class="ow">=</span> <span class="kt">Set</span> <span class="o">$</span> <span class="kt">S</span><span class="o">.</span><span class="nf">intersection</span> <span class="nf">a</span> <span class="nf">b</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">a</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Set</span> <span class="nf">a</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="kt">Set</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Set</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Alphabet</span> <span class="nf">a</span>  
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="kt">Set</span> <span class="o">.</span> <span class="kt">S</span><span class="o">.</span><span class="nf">singleton</span> <span class="o">.</span> <span class="nf">symbol</span>

<span class="c1">-- semiring over set of monoid, almost free semiring [[a]], formal language (define regular language algebraically)</span>
<span class="kr">newtype</span> <span class="kt">Seq</span> <span class="nf">a</span> <span class="ow">=</span> <span class="kt">Seq</span> <span class="p">(</span><span class="kt">S</span><span class="o">.</span><span class="kt">Set</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Eq</span><span class="p">)</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Ord</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Arbitrary</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Arbitrary</span> <span class="p">(</span><span class="kt">Seq</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">arbitrary</span> <span class="ow">=</span> <span class="nf">fmap</span> <span class="kt">Seq</span> <span class="nf">arbitrary</span> 
  
<span class="kr">instance</span> <span class="p">(</span><span class="kt">Monoid</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Ord</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Semiring</span> <span class="p">(</span><span class="kt">Seq</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="kt">Seq</span> <span class="kt">S</span><span class="o">.</span><span class="nf">empty</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="kt">Seq</span> <span class="p">(</span><span class="kt">S</span><span class="o">.</span><span class="nf">singleton</span> <span class="nf">mempty</span><span class="p">)</span>
  <span class="kt">Seq</span> <span class="nf">as</span> <span class="o">&lt;+&gt;</span> <span class="kt">Seq</span> <span class="nf">bs</span> <span class="ow">=</span> <span class="kt">Seq</span> <span class="p">(</span><span class="kt">S</span><span class="o">.</span><span class="nf">union</span> <span class="nf">as</span> <span class="nf">bs</span><span class="p">)</span>
  <span class="kt">Seq</span> <span class="nf">as</span> <span class="o">&lt;.&gt;</span> <span class="kt">Seq</span> <span class="nf">bs</span> <span class="ow">=</span> <span class="kt">Seq</span> <span class="p">(</span><span class="nf">foldMap</span> <span class="p">(</span><span class="nf">flip</span> <span class="kt">S</span><span class="o">.</span><span class="nf">map</span> <span class="nf">bs</span> <span class="o">.</span> <span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">))</span> <span class="nf">as</span><span class="p">)</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">a</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Seq</span> <span class="nf">a</span><span class="p">),</span> <span class="kt">Ord</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="kt">Seq</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Seq</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Alphabet</span> <span class="nf">a</span>  
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="kt">Seq</span> <span class="o">.</span> <span class="kt">S</span><span class="o">.</span><span class="nf">singleton</span> <span class="o">.</span> <span class="nf">symbol</span></code></pre></div><p><br/>下面是分别用递归函数，recursion scheme，final tagless风格实现的正则表达式，这里我们分别只写了一种函数，algebra或者interpreter，但却得到了一类东西。这种通过在原结构里面加carrier实现多态的方法其实很常见，形式语言叫weight，程序语言叫annotation，动态规划叫memoization，自动微分叫derivation，图论叫label。通过选择不同的半环类型carrier可以得到不同的解释器，如果是同态那正确性更容易得到保证，比如选择布尔代数，那它就是正则匹配，如果选择自然数，那它就是在计算不同正则匹配方式的数目。这样的定义几乎算得上是Free Kleene Algebra，唯一不足的是无法保证Kleene Algebra闭包运算的公理，所以比如在计算（ab）*匹配空字符串时数目其实是不对的<sup data-text="Sebastian Fischer, Frank Huch, and Thomas Wilke. 2010. A play on regular expressions" data-url="" data-draft-node="inline" data-draft-type="reference" data-numero="4">[4]</sup>。</p><div class="highlight"><pre><code class="language-haskell"><span class="c1">-- Regex r</span>
<span class="kr">data</span> <span class="kt">Re</span> <span class="nf">r</span> <span class="ow">=</span> <span class="kt">Emp</span>
          <span class="o">|</span> <span class="kt">Eps</span>
          <span class="o">|</span> <span class="kt">Tok</span> <span class="p">(</span><span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span>
          <span class="o">|</span> <span class="kt">Alt</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span>
          <span class="o">|</span> <span class="kt">Cat</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span>
          <span class="o">|</span> <span class="kt">Rep</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span>
  
<span class="kr">instance</span> <span class="p">(</span><span class="kt">Eq</span> <span class="nf">r</span><span class="p">,</span> <span class="kt">Semiring</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Show</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Rep</span> <span class="kt">Emp</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showString</span> <span class="s">&#34;_&#34;</span>
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="kt">Eps</span> <span class="ow">=</span> <span class="nf">showString</span> <span class="s">&#34;$&#34;</span>      
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="kt">Emp</span> <span class="ow">=</span> <span class="nf">showString</span> <span class="s">&#34;^&#34;</span>
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Cat</span> <span class="nf">r</span> <span class="kt">Emp</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showString</span> <span class="s">&#34;^&#34;</span>
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Cat</span> <span class="kt">Emp</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showString</span> <span class="s">&#34;^&#34;</span>  
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Tok</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showString</span> <span class="o">$</span> <span class="nf">filter</span> <span class="p">((</span><span class="o">==</span> <span class="nf">one</span><span class="p">)</span> <span class="o">.</span> <span class="nf">r</span><span class="p">)</span> <span class="p">(</span><span class="nf">enumFromTo</span> <span class="nf">minBound</span> <span class="nf">maxBound</span><span class="p">)</span>
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Alt</span> <span class="kt">Emp</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="nf">r</span>
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Alt</span> <span class="nf">r</span> <span class="kt">Emp</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="nf">r</span>  
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Alt</span> <span class="nf">r</span> <span class="nf">s</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showParen</span> <span class="p">(</span><span class="nf">p</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">$</span> <span class="nf">showsPrec</span> <span class="mi">7</span> <span class="nf">r</span> <span class="o">.</span> <span class="nf">showString</span> <span class="s">&#34;|&#34;</span> <span class="o">.</span> <span class="nf">showsPrec</span> <span class="mi">7</span> <span class="nf">s</span>
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Cat</span> <span class="kt">Eps</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="nf">r</span>  
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Cat</span> <span class="nf">r</span> <span class="kt">Eps</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="nf">r</span>  
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Cat</span> <span class="nf">r</span> <span class="nf">s</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">showParen</span> <span class="p">(</span><span class="nf">p</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">$</span> <span class="nf">showsPrec</span> <span class="mi">8</span> <span class="nf">r</span> <span class="o">.</span> <span class="nf">showsPrec</span> <span class="mi">8</span> <span class="nf">s</span>
  <span class="nf">showsPrec</span> <span class="nf">p</span> <span class="p">(</span><span class="kt">Rep</span> <span class="nf">r</span><span class="p">)</span>   <span class="ow">=</span> <span class="nf">showParen</span> <span class="p">(</span><span class="nf">p</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">$</span> <span class="nf">showsPrec</span> <span class="mi">9</span> <span class="nf">r</span> <span class="o">.</span> <span class="nf">showString</span> <span class="s">&#34;*&#34;</span>
    
<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">Arbitrary</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">arbitrary</span> <span class="ow">=</span> <span class="nf">sized</span> <span class="nf">gen</span> <span class="kr">where</span>
    <span class="nf">gen</span> <span class="mi">0</span> <span class="ow">=</span> <span class="nf">frequency</span> <span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="nf">pure</span> <span class="nf">zero</span><span class="p">),</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="nf">pure</span> <span class="nf">one</span><span class="p">)]</span>
    <span class="nf">gen</span> <span class="mi">1</span> <span class="ow">=</span> <span class="nf">symbol</span> <span class="o">&lt;$&gt;</span> <span class="nf">arbitraryASCIIChar</span> <span class="p">`</span><span class="nf">suchThat</span><span class="p">`</span> <span class="nf">isAlphaNum</span>
    <span class="nf">gen</span> <span class="nf">n</span> <span class="ow">=</span> <span class="kr">do</span>
      <span class="nf">f</span> <span class="ow">&lt;-</span> <span class="nf">bool</span> <span class="o">&lt;$&gt;</span> <span class="nf">pure</span> <span class="p">(</span><span class="nf">\a</span> <span class="nf">b</span> <span class="ow">-&gt;</span> <span class="kt">Rep</span> <span class="nf">a</span><span class="p">)</span> <span class="o">&lt;*&gt;</span> <span class="nf">pure</span> <span class="p">(</span><span class="nf">\a</span> <span class="nf">b</span> <span class="ow">-&gt;</span> <span class="kt">Rep</span> <span class="nf">b</span><span class="p">)</span> <span class="o">&lt;*&gt;</span> <span class="nf">frequency</span> <span class="p">[(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">pure</span> <span class="nf">zero</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nf">pure</span> <span class="nf">one</span><span class="p">)]</span>      
      <span class="nf">g</span> <span class="ow">&lt;-</span> <span class="nf">bool</span> <span class="o">&lt;$&gt;</span> <span class="nf">pure</span> <span class="p">(</span><span class="o">&lt;+&gt;</span><span class="p">)</span>           <span class="o">&lt;*&gt;</span> <span class="nf">pure</span> <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span>           <span class="o">&lt;*&gt;</span> <span class="nf">frequency</span> <span class="p">[(</span><span class="mi">3</span><span class="p">,</span> <span class="nf">pure</span> <span class="nf">zero</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nf">pure</span> <span class="nf">one</span><span class="p">)]</span>
      <span class="nf">c</span> <span class="ow">&lt;-</span> <span class="nf">bool</span> <span class="o">&lt;$&gt;</span> <span class="nf">pure</span> <span class="nf">f</span>               <span class="o">&lt;*&gt;</span> <span class="nf">pure</span> <span class="nf">g</span>               <span class="o">&lt;*&gt;</span> <span class="nf">frequency</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">pure</span> <span class="nf">zero</span><span class="p">),</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="nf">pure</span> <span class="nf">one</span><span class="p">)]</span>
      <span class="nf">k</span> <span class="ow">&lt;-</span> <span class="nf">choose</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nf">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="nf">c</span> <span class="o">&lt;$&gt;</span> <span class="nf">gen</span> <span class="nf">k</span> <span class="o">&lt;*&gt;</span> <span class="nf">gen</span> <span class="p">(</span><span class="nf">n</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nf">k</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">Semiring</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="kt">Emp</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="kt">Eps</span>
  <span class="kt">Emp</span> <span class="o">&lt;+&gt;</span> <span class="nf">re</span> <span class="ow">=</span> <span class="nf">re</span>
  <span class="nf">re</span> <span class="o">&lt;+&gt;</span> <span class="kt">Emp</span> <span class="ow">=</span> <span class="nf">re</span>
  <span class="kt">Eps</span> <span class="o">&lt;+&gt;</span> <span class="kt">Eps</span> <span class="ow">=</span> <span class="kt">Eps</span>
  <span class="kt">Eps</span> <span class="o">&lt;+&gt;</span> <span class="kt">Rep</span> <span class="nf">re</span> <span class="ow">=</span> <span class="kt">Rep</span> <span class="nf">re</span>
  <span class="kt">Rep</span> <span class="nf">re</span> <span class="o">&lt;+&gt;</span> <span class="kt">Eps</span> <span class="ow">=</span> <span class="kt">Rep</span> <span class="nf">re</span>
  <span class="nf">ra</span> <span class="o">&lt;+&gt;</span> <span class="nf">rb</span> <span class="ow">=</span> <span class="kt">Alt</span> <span class="nf">ra</span> <span class="nf">rb</span> 
  <span class="kt">Eps</span> <span class="o">&lt;.&gt;</span> <span class="nf">re</span> <span class="ow">=</span> <span class="nf">re</span>
  <span class="nf">re</span> <span class="o">&lt;.&gt;</span> <span class="kt">Eps</span> <span class="ow">=</span> <span class="nf">re</span>
  <span class="kt">Emp</span> <span class="o">&lt;.&gt;</span> <span class="nf">re</span> <span class="ow">=</span> <span class="kt">Emp</span>
  <span class="nf">re</span> <span class="o">&lt;.&gt;</span> <span class="kt">Emp</span> <span class="ow">=</span> <span class="kt">Emp</span>
  <span class="nf">ra</span> <span class="o">&lt;.&gt;</span> <span class="nf">rb</span> <span class="ow">=</span> <span class="kt">Cat</span> <span class="nf">ra</span> <span class="nf">rb</span>

<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">IdempotentSemiring</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">KleeneAlgebra</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">star</span> <span class="kt">Eps</span> <span class="ow">=</span> <span class="kt">Eps</span>
  <span class="nf">star</span> <span class="kt">Emp</span> <span class="ow">=</span> <span class="kt">Eps</span>
  <span class="nf">star</span> <span class="p">(</span><span class="kt">Rep</span> <span class="nf">re</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">star</span> <span class="nf">re</span>
  <span class="nf">star</span> <span class="nf">re</span> <span class="ow">=</span> <span class="kt">Rep</span> <span class="nf">re</span>
  
<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Re</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Char</span>  
  <span class="nf">symbol</span> <span class="nf">c</span> <span class="ow">=</span> <span class="kt">Tok</span> <span class="o">$</span> <span class="nf">bool</span> <span class="nf">zero</span> <span class="nf">one</span> <span class="o">.</span> <span class="p">(</span><span class="o">==</span> <span class="nf">c</span><span class="p">)</span>

<span class="nf">partition</span> <span class="ow">::</span> <span class="p">[</span><span class="nf">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="p">[[[</span><span class="nf">a</span><span class="p">]]]</span>  
<span class="nf">partition</span> <span class="kt">[]</span>     <span class="ow">=</span> <span class="p">[</span><span class="kt">[]</span><span class="p">]</span>
<span class="nf">partition</span> <span class="p">[</span><span class="nf">x</span><span class="p">]</span>    <span class="ow">=</span> <span class="p">[[[</span><span class="nf">x</span><span class="p">]]]</span>
<span class="nf">partition</span> <span class="p">(</span><span class="nf">x</span><span class="kt">:</span><span class="nf">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">concat</span> <span class="p">[[(</span><span class="nf">x</span> <span class="kt">:</span> <span class="nf">p</span><span class="p">)</span> <span class="kt">:</span> <span class="nf">ps</span><span class="p">,</span> <span class="p">[</span><span class="nf">x</span><span class="p">]</span> <span class="kt">:</span> <span class="nf">p</span> <span class="kt">:</span> <span class="nf">ps</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nf">p</span><span class="kt">:</span><span class="nf">ps</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="nf">partition</span> <span class="nf">xs</span><span class="p">]</span>

<span class="nf">match</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">Re</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
<span class="nf">match</span> <span class="kt">Emp</span> <span class="nf">s</span> <span class="ow">=</span> <span class="nf">zero</span>
<span class="nf">match</span> <span class="kt">Eps</span> <span class="nf">s</span> <span class="ow">=</span> <span class="nf">bool</span> <span class="nf">zero</span> <span class="nf">one</span> <span class="p">(</span><span class="nf">null</span> <span class="nf">s</span><span class="p">)</span>
<span class="nf">match</span> <span class="p">(</span><span class="kt">Tok</span> <span class="nf">f</span><span class="p">)</span> <span class="nf">s</span> <span class="ow">=</span> <span class="kr">case</span> <span class="nf">s</span> <span class="kr">of</span> <span class="p">[</span><span class="nf">c</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="nf">f</span> <span class="nf">c</span><span class="p">;</span> <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="nf">zero</span>
<span class="nf">match</span> <span class="p">(</span><span class="kt">Alt</span> <span class="nf">a</span> <span class="nf">b</span><span class="p">)</span> <span class="nf">s</span> <span class="ow">=</span> <span class="nf">match</span> <span class="nf">a</span> <span class="nf">s</span> <span class="o">&lt;+&gt;</span> <span class="nf">match</span> <span class="nf">b</span> <span class="nf">s</span>
<span class="nf">match</span> <span class="p">(</span><span class="kt">Cat</span> <span class="nf">a</span> <span class="nf">b</span><span class="p">)</span> <span class="nf">s</span> <span class="ow">=</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">fmap</span> <span class="p">(</span><span class="nf">uncurry</span> <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span> <span class="o">.</span> <span class="p">(</span><span class="nf">match</span> <span class="nf">a</span> <span class="o">***</span> <span class="nf">match</span> <span class="nf">b</span><span class="p">)</span> <span class="o">.</span> <span class="nf">flip</span> <span class="nf">splitAt</span> <span class="nf">s</span><span class="p">)</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="nf">length</span> <span class="nf">s</span><span class="p">])</span>
<span class="nf">match</span> <span class="p">(</span><span class="kt">Rep</span> <span class="nf">a</span><span class="p">)</span> <span class="nf">s</span> <span class="ow">=</span> <span class="nf">add</span> <span class="p">[</span><span class="nf">mul</span> <span class="p">[</span><span class="nf">match</span> <span class="nf">a</span> <span class="nf">ss</span> <span class="o">|</span> <span class="nf">ss</span> <span class="ow">&lt;-</span> <span class="nf">ps</span><span class="p">]</span> <span class="o">|</span> <span class="nf">ps</span> <span class="ow">&lt;-</span> <span class="nf">partition</span> <span class="nf">s</span><span class="p">]</span>

<span class="c1">-- recursion scheme</span>
<span class="kr">data</span> <span class="kt">ReF</span> <span class="nf">r</span> <span class="nf">re</span> <span class="ow">=</span> <span class="kt">EmpF</span> <span class="o">|</span> <span class="kt">EpsF</span> <span class="o">|</span> <span class="kt">TokF</span> <span class="p">(</span><span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span> <span class="o">|</span> <span class="kt">AltF</span> <span class="nf">re</span> <span class="nf">re</span> <span class="o">|</span> <span class="kt">CatF</span> <span class="nf">re</span> <span class="nf">re</span> <span class="o">|</span> <span class="kt">RepF</span> <span class="nf">re</span> <span class="kr">deriving</span> <span class="kt">Functor</span>

<span class="nf">alg</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">ReF</span> <span class="nf">r</span> <span class="p">(</span><span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
<span class="nf">alg</span> <span class="kt">EmpF</span> <span class="ow">=</span> <span class="nf">emp</span>
<span class="nf">alg</span> <span class="kt">EpsF</span> <span class="ow">=</span> <span class="nf">eps</span>
<span class="nf">alg</span> <span class="p">(</span><span class="kt">TokF</span> <span class="nf">f</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">\s</span> <span class="ow">-&gt;</span> <span class="kr">case</span> <span class="nf">s</span> <span class="kr">of</span> <span class="p">[</span><span class="nf">c</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="nf">f</span> <span class="nf">c</span><span class="p">;</span> <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="nf">zero</span>
<span class="nf">alg</span> <span class="p">(</span><span class="kt">AltF</span> <span class="nf">a</span> <span class="nf">b</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">alt</span> <span class="nf">a</span> <span class="nf">b</span>
<span class="nf">alg</span> <span class="p">(</span><span class="kt">CatF</span> <span class="nf">a</span> <span class="nf">b</span><span class="p">)</span><span class="ow">=</span> <span class="nf">cat</span> <span class="nf">a</span> <span class="nf">b</span>
<span class="nf">alg</span> <span class="p">(</span><span class="kt">RepF</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">rep</span> <span class="nf">a</span>

<span class="nf">project</span> <span class="kt">Emp</span> <span class="ow">=</span> <span class="kt">EmpF</span>
<span class="nf">project</span> <span class="kt">Eps</span> <span class="ow">=</span> <span class="kt">EpsF</span>
<span class="nf">project</span> <span class="p">(</span><span class="kt">Tok</span> <span class="nf">f</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">TokF</span> <span class="nf">f</span>
<span class="nf">project</span> <span class="p">(</span><span class="kt">Alt</span> <span class="nf">a</span> <span class="nf">b</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">AltF</span> <span class="nf">a</span> <span class="nf">b</span>
<span class="nf">project</span> <span class="p">(</span><span class="kt">Cat</span> <span class="nf">a</span> <span class="nf">b</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">CatF</span> <span class="nf">a</span> <span class="nf">b</span>
<span class="nf">project</span> <span class="p">(</span><span class="kt">Rep</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">RepF</span> <span class="nf">a</span>

<span class="nf">cata</span> <span class="nf">alg</span> <span class="ow">=</span> <span class="kr">let</span> <span class="nf">go</span> <span class="ow">=</span> <span class="nf">alg</span> <span class="o">.</span> <span class="nf">fmap</span> <span class="p">(</span><span class="nf">cata</span> <span class="nf">alg</span><span class="p">)</span> <span class="o">.</span> <span class="nf">project</span> <span class="kr">in</span> <span class="nf">go</span>

<span class="c1">-- finally tagless</span>

<span class="nf">emp</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
<span class="nf">emp</span> <span class="ow">=</span> <span class="nf">\s</span> <span class="ow">-&gt;</span> <span class="nf">zero</span>

<span class="nf">eps</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
<span class="nf">eps</span> <span class="ow">=</span> <span class="nf">\s</span> <span class="ow">-&gt;</span> <span class="kr">if</span> <span class="nf">null</span> <span class="nf">s</span> <span class="kr">then</span> <span class="nf">one</span> <span class="kr">else</span> <span class="nf">zero</span>

<span class="nf">tok</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
<span class="nf">tok</span> <span class="nf">c</span> <span class="ow">=</span> <span class="nf">\s</span> <span class="ow">-&gt;</span> <span class="kr">if</span> <span class="nf">s</span> <span class="o">==</span> <span class="p">[</span><span class="nf">c</span><span class="p">]</span> <span class="kr">then</span> <span class="nf">one</span> <span class="kr">else</span> <span class="nf">zero</span>

<span class="nf">alt</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span>
<span class="nf">alt</span> <span class="nf">a</span> <span class="nf">b</span> <span class="ow">=</span> <span class="nf">\s</span> <span class="ow">-&gt;</span> <span class="nf">a</span> <span class="nf">s</span> <span class="o">&lt;+&gt;</span> <span class="nf">b</span> <span class="nf">s</span>

<span class="nf">cat</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span>
<span class="nf">cat</span> <span class="nf">a</span> <span class="nf">b</span> <span class="ow">=</span> <span class="nf">\s</span> <span class="ow">-&gt;</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">fmap</span> <span class="p">(</span><span class="nf">uncurry</span> <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span> <span class="o">.</span> <span class="p">(</span><span class="nf">a</span> <span class="o">***</span> <span class="nf">b</span><span class="p">)</span> <span class="o">.</span> <span class="nf">flip</span> <span class="nf">splitAt</span> <span class="nf">s</span><span class="p">)</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="nf">length</span> <span class="nf">s</span><span class="p">])</span>

<span class="nf">rep</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">String</span> <span class="ow">-&gt;</span> <span class="nf">r</span><span class="p">)</span>
<span class="nf">rep</span> <span class="nf">a</span> <span class="ow">=</span> <span class="nf">\s</span> <span class="ow">-&gt;</span> <span class="nf">add</span> <span class="p">[</span><span class="nf">mul</span> <span class="p">[</span><span class="nf">a</span> <span class="nf">ss</span> <span class="o">|</span> <span class="nf">ss</span> <span class="ow">&lt;-</span> <span class="nf">ps</span><span class="p">]</span> <span class="o">|</span> <span class="nf">ps</span> <span class="ow">&lt;-</span> <span class="nf">partition</span> <span class="nf">s</span><span class="p">]</span></code></pre></div><p><br/><br/>列表或者树都有良好的代数性质，无论是折叠还是展开都非常方便，图算得上异类，形象点说线头太多，没法一手拎起来，如果退一步，选择两种不同的数据结构在Haskell里处理图，我们还是能在正确性，灵活性甚至性能方面取得良好的平衡。构造图可以用基于半环的点边集合表示<sup data-text="Andrey Mokhov. 2017. Algebraic graphs with class" data-url="" data-draft-node="inline" data-draft-type="reference" data-numero="5">[5]</sup>，加法运算定义为点边集合的并，乘法定义类似，除了新增添的桥接左右两边点的边集合，可以验证加法乘法满足结合律和分配律，与半环相比不同点在于加法幺元和乘法幺元重合导致不存在消去零元，这一般不影响我们用半环构造图，可以证明所有的有向图和无向图都可以如此构造，背后用到的是图和关系的同构。我们还可以把图声明为数类型类的实例，这样可以用普通的算术式表示图，比如数的阶乘表示链，0*（1+2+3）表示星图，还可以重载字符串类型类，我们可以非常简洁直观地写各种图相关的DSL，比如计算图或者Todo List。</p><div class="highlight"><pre><code class="language-haskell"><span class="c1">-- Relation v e</span>
<span class="kr">data</span> <span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">=</span> <span class="kt">Rel</span> <span class="p">(</span><span class="kt">S</span><span class="o">.</span><span class="kt">Set</span> <span class="nf">v</span><span class="p">)</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="kt">Map</span> <span class="p">(</span><span class="nf">v</span><span class="p">,</span><span class="nf">v</span><span class="p">)</span> <span class="nf">e</span><span class="p">)</span> <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Eq</span><span class="p">,</span> <span class="kt">Functor</span><span class="p">)</span>
 
<span class="kr">instance</span> <span class="p">(</span><span class="kt">Semiring</span> <span class="nf">e</span><span class="p">,</span> <span class="kt">Ord</span> <span class="nf">v</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Semiring</span> <span class="p">(</span><span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="kt">Rel</span> <span class="kt">S</span><span class="o">.</span><span class="nf">empty</span> <span class="kt">M</span><span class="o">.</span><span class="nf">empty</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="kt">Rel</span> <span class="kt">S</span><span class="o">.</span><span class="nf">empty</span> <span class="kt">M</span><span class="o">.</span><span class="nf">empty</span>
  <span class="kt">Rel</span> <span class="nf">vx</span> <span class="nf">ex</span> <span class="o">&lt;+&gt;</span> <span class="kt">Rel</span> <span class="nf">vy</span> <span class="nf">ey</span> <span class="ow">=</span> <span class="kt">Rel</span> <span class="p">(</span><span class="kt">S</span><span class="o">.</span><span class="nf">union</span> <span class="nf">vx</span> <span class="nf">vy</span><span class="p">)</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="nf">union</span> <span class="nf">ex</span> <span class="nf">ey</span><span class="p">)</span>
  <span class="kt">Rel</span> <span class="nf">vx</span> <span class="nf">ex</span> <span class="o">&lt;.&gt;</span> <span class="kt">Rel</span> <span class="nf">vy</span> <span class="nf">ey</span> <span class="ow">=</span> <span class="kt">Rel</span> <span class="p">(</span><span class="kt">S</span><span class="o">.</span><span class="nf">union</span> <span class="nf">vx</span> <span class="nf">vy</span><span class="p">)</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="nf">unions</span> <span class="p">[</span><span class="nf">ex</span><span class="p">,</span><span class="nf">ey</span><span class="p">,</span><span class="kt">M</span><span class="o">.</span><span class="nf">fromList</span> <span class="o">$</span> <span class="p">(</span><span class="nf">\x</span> <span class="nf">y</span> <span class="ow">-&gt;</span> <span class="p">((</span><span class="nf">x</span><span class="p">,</span><span class="nf">y</span><span class="p">),</span><span class="nf">one</span><span class="p">))</span> <span class="o">&lt;$&gt;</span> <span class="kt">S</span><span class="o">.</span><span class="nf">toList</span> <span class="nf">vx</span> <span class="o">&lt;*&gt;</span> <span class="kt">S</span><span class="o">.</span><span class="nf">toList</span> <span class="nf">vy</span><span class="p">])</span>
  
<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">v</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Alphabet</span> <span class="nf">v</span>  
  <span class="nf">symbol</span> <span class="nf">c</span> <span class="ow">=</span> <span class="kt">Rel</span> <span class="p">(</span><span class="kt">S</span><span class="o">.</span><span class="nf">singleton</span> <span class="p">(</span><span class="nf">symbol</span> <span class="nf">c</span><span class="p">))</span> <span class="kt">M</span><span class="o">.</span><span class="nf">empty</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">Num</span> <span class="p">(</span><span class="kt">Alphabet</span> <span class="nf">v</span><span class="p">),</span> <span class="kt">Ord</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">Semiring</span> <span class="nf">e</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Num</span> <span class="p">(</span><span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">fromInteger</span> <span class="ow">=</span> <span class="nf">symbol</span> <span class="o">.</span> <span class="nf">fromInteger</span>
  <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="o">&lt;+&gt;</span><span class="p">)</span>
  <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="o">&lt;.&gt;</span><span class="p">)</span>
  <span class="nf">signum</span> <span class="ow">=</span> <span class="nf">const</span> <span class="nf">one</span>
  <span class="nf">abs</span> <span class="ow">=</span> <span class="nf">id</span>
  <span class="nf">negate</span> <span class="ow">=</span> <span class="nf">id</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">IsString</span> <span class="p">(</span><span class="kt">Alphabet</span> <span class="nf">v</span><span class="p">),</span> <span class="kt">Ord</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">v</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">IsString</span> <span class="p">(</span><span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">fromString</span> <span class="ow">=</span> <span class="nf">symbol</span> <span class="o">.</span> <span class="nf">fromString</span>
      
<span class="c1">-- Path a</span>
<span class="kr">data</span> <span class="kt">Path</span> <span class="nf">a</span> <span class="ow">=</span> <span class="kt">Path</span> <span class="p">{</span> <span class="nf">sign</span> <span class="ow">::</span> <span class="nf">a</span><span class="p">,</span> <span class="nf">router</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Path</span> <span class="nf">a</span><span class="p">]</span> <span class="p">}</span> <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Functor</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Eq</span> <span class="nf">a</span> <span class="ow">=&gt;</span> <span class="kt">Eq</span> <span class="p">(</span><span class="kt">Path</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kt">Path</span> <span class="nf">a</span> <span class="kr">_</span> <span class="o">==</span> <span class="kt">Path</span> <span class="nf">b</span> <span class="kr">_</span> <span class="ow">=</span> <span class="nf">a</span> <span class="o">==</span> <span class="nf">b</span>
      
<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">a</span> <span class="ow">=&gt;</span> <span class="kt">Semiring</span> <span class="p">(</span><span class="kt">Path</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="kt">Path</span> <span class="nf">zero</span> <span class="kt">[]</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="kt">Path</span> <span class="nf">one</span> <span class="kt">[]</span>
  <span class="kt">Path</span> <span class="nf">a</span> <span class="nf">as</span> <span class="o">&lt;+&gt;</span> <span class="kt">Path</span> <span class="nf">b</span> <span class="nf">bs</span> <span class="ow">=</span> <span class="kt">Path</span> <span class="p">(</span><span class="nf">a</span> <span class="o">&lt;+&gt;</span> <span class="nf">b</span><span class="p">)</span> <span class="p">(</span><span class="nf">as</span> <span class="o">++</span> <span class="nf">bs</span><span class="p">)</span>
  <span class="nf">ta</span><span class="o">@</span><span class="p">(</span><span class="kt">Path</span> <span class="nf">a</span> <span class="nf">as</span><span class="p">)</span> <span class="o">&lt;.&gt;</span> <span class="kt">Path</span> <span class="nf">b</span> <span class="nf">bs</span> <span class="ow">=</span> <span class="kt">Path</span> <span class="p">(</span><span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="nf">b</span><span class="p">)</span> <span class="p">[</span><span class="nf">ta</span><span class="p">]</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">a</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Path</span> <span class="nf">a</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="kt">Path</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Path</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Alphabet</span> <span class="nf">a</span>  
  <span class="nf">symbol</span> <span class="nf">a</span> <span class="ow">=</span> <span class="kt">Path</span> <span class="p">(</span><span class="nf">symbol</span> <span class="nf">a</span><span class="p">)</span> <span class="kt">[]</span>

<span class="c1">-- Tree a</span>
<span class="kr">data</span> <span class="kt">Tree</span> <span class="nf">a</span> <span class="ow">=</span> <span class="kt">Tree</span> <span class="p">{</span> <span class="nf">root</span> <span class="ow">::</span> <span class="nf">a</span><span class="p">,</span> <span class="nf">forest</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Tree</span> <span class="nf">a</span><span class="p">]</span> <span class="p">}</span> <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Functor</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Eq</span> <span class="nf">a</span> <span class="ow">=&gt;</span> <span class="kt">Eq</span> <span class="p">(</span><span class="kt">Tree</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kt">Tree</span> <span class="nf">a</span> <span class="kr">_</span> <span class="o">==</span> <span class="kt">Tree</span> <span class="nf">b</span> <span class="kr">_</span> <span class="ow">=</span> <span class="nf">a</span> <span class="o">==</span> <span class="nf">b</span>

<span class="kr">instance</span> <span class="kt">Semiring</span> <span class="nf">a</span> <span class="ow">=&gt;</span> <span class="kt">Semiring</span> <span class="p">(</span><span class="kt">Tree</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="kt">Tree</span> <span class="nf">zero</span> <span class="kt">[]</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="kt">Tree</span> <span class="nf">one</span> <span class="kt">[]</span>
  <span class="kt">Tree</span> <span class="nf">a</span> <span class="nf">as</span> <span class="o">&lt;+&gt;</span> <span class="kt">Tree</span> <span class="nf">b</span> <span class="nf">bs</span> <span class="ow">=</span> <span class="kt">Tree</span> <span class="p">(</span><span class="nf">a</span> <span class="o">&lt;+&gt;</span> <span class="nf">b</span><span class="p">)</span> <span class="p">(</span><span class="nf">as</span> <span class="o">++</span> <span class="nf">bs</span><span class="p">)</span>
  <span class="kt">Tree</span> <span class="nf">a</span> <span class="nf">as</span> <span class="o">&lt;.&gt;</span> <span class="nf">tb</span><span class="o">@</span><span class="p">(</span><span class="kt">Tree</span> <span class="nf">b</span> <span class="nf">bs</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Tree</span> <span class="p">(</span><span class="nf">a</span> <span class="o">&lt;.&gt;</span> <span class="nf">b</span><span class="p">)</span> <span class="p">[</span><span class="nf">tb</span><span class="p">]</span>
  
<span class="kr">instance</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">a</span> <span class="o">~</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Tree</span> <span class="nf">a</span><span class="p">))</span> <span class="ow">=&gt;</span> <span class="kt">Language</span> <span class="p">(</span><span class="kt">Tree</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Tree</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Alphabet</span> <span class="nf">a</span>  
  <span class="nf">symbol</span> <span class="nf">a</span> <span class="ow">=</span> <span class="kt">Tree</span> <span class="p">(</span><span class="nf">symbol</span> <span class="nf">a</span><span class="p">)</span> <span class="kt">[]</span>

<span class="c1">-- Tropical a</span>
<span class="kr">data</span> <span class="kt">Tropical</span> <span class="nf">a</span> <span class="ow">=</span> <span class="kt">Infinity</span> <span class="o">|</span> <span class="kt">Dist</span> <span class="nf">a</span> <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">,</span> <span class="kt">Eq</span><span class="p">,</span> <span class="kt">Functor</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Ord</span> <span class="nf">a</span> <span class="ow">=&gt;</span> <span class="kt">Ord</span> <span class="p">(</span><span class="kt">Tropical</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">_</span> <span class="o">&lt;=</span> <span class="kt">Infinity</span>    <span class="ow">=</span> <span class="kt">True</span>
  <span class="kt">Infinity</span> <span class="o">&lt;=</span> <span class="kr">_</span>    <span class="ow">=</span> <span class="kt">False</span>
  <span class="kt">Dist</span> <span class="nf">m</span> <span class="o">&lt;=</span> <span class="kt">Dist</span> <span class="nf">n</span> <span class="ow">=</span> <span class="nf">m</span> <span class="o">&lt;=</span> <span class="nf">n</span>
  
<span class="kr">instance</span> <span class="p">(</span><span class="kt">Ord</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Num</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Semiring</span> <span class="p">(</span><span class="kt">Tropical</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">zero</span> <span class="ow">=</span> <span class="kt">Infinity</span>
  <span class="nf">one</span> <span class="ow">=</span> <span class="kt">Dist</span> <span class="mi">0</span>
  <span class="kt">Infinity</span> <span class="o">&lt;+&gt;</span> <span class="nf">n</span>    <span class="ow">=</span> <span class="nf">n</span>
  <span class="nf">n</span> <span class="o">&lt;+&gt;</span> <span class="kt">Infinity</span>    <span class="ow">=</span> <span class="nf">n</span>
  <span class="kt">Dist</span> <span class="nf">m</span> <span class="o">&lt;+&gt;</span> <span class="kt">Dist</span> <span class="nf">n</span> <span class="ow">=</span> <span class="kt">Dist</span> <span class="p">(</span><span class="nf">min</span> <span class="nf">m</span> <span class="nf">n</span><span class="p">)</span>
  <span class="kt">Infinity</span> <span class="o">&lt;.&gt;</span> <span class="nf">n</span>    <span class="ow">=</span> <span class="kt">Infinity</span>
  <span class="nf">n</span> <span class="o">&lt;.&gt;</span> <span class="kt">Infinity</span>    <span class="ow">=</span> <span class="kt">Infinity</span>
  <span class="kt">Dist</span> <span class="nf">m</span> <span class="o">&lt;.&gt;</span> <span class="kt">Dist</span> <span class="nf">n</span> <span class="ow">=</span> <span class="kt">Dist</span> <span class="p">(</span><span class="nf">m</span> <span class="o">+</span> <span class="nf">n</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Language</span> <span class="p">(</span><span class="kt">Tropical</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="kr">type</span> <span class="kt">Alphabet</span> <span class="p">(</span><span class="kt">Tropical</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">a</span>  
  <span class="nf">symbol</span> <span class="ow">=</span> <span class="kt">Dist</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Num</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Ord</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">IdempotentSemiring</span> <span class="p">(</span><span class="kt">Tropical</span> <span class="nf">a</span><span class="p">)</span>

<span class="kr">instance</span> <span class="p">(</span><span class="kt">Num</span> <span class="nf">a</span><span class="p">,</span> <span class="kt">Ord</span> <span class="nf">a</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">KleeneAlgebra</span> <span class="p">(</span><span class="kt">Tropical</span> <span class="nf">a</span><span class="p">)</span> <span class="kr">where</span>
  <span class="nf">star</span> <span class="ow">=</span> <span class="nf">const</span> <span class="nf">one</span></code></pre></div><p><br/><br/>我们知道图的点边集合表示无法高效地表达各类图算法，在Haskell里也无法做类型匹配，解决这个问题可以把图换成邻接表，注意到IntMap在Haskell可以支持最坏情况几乎常数级的查找和删除操作，可以再做一个优化把点encode成自然数，结合ViewPatterns扩展，我们就能用类型匹配来表达各类图算法，这就是Inductive Graphs and Functional Graph Algorithm<sup data-text="Erwig, Martin. 2001. Inductive Graphs and Functional Graph Algorithms " data-url="" data-draft-node="inline" data-draft-type="reference" data-numero="6">[6]</sup>这篇文章表达的意思。为了缓存遍历图的过程，我们再定义几个辅助类，Path用来记录前向遍历Fanin的所有路径，Tree用来记录后向遍历Fanout的所有路径，乘法定义的不同体现了方向；Tropical半环以及引申出的其他半环则常常用于路径长度宽度相关的算法。mkGraph负责将点边集合表示转换为邻接表，context用在类型匹配中从图中剥离一个特定的点，如果用Haskell的IntMap实现可以假定常数复杂度。BFS和DFS的表示也非常直观，并且是多态的，选择不同的label得到不同的递归函数，比如把Seq String用在BFS得到的是从根到这一点的所有最短路径，把Seq String换为Path（Seq String）得到的是所有路径以及它们的所有子路径，把Tropical半环(max,+)用在DFS得到高度，如果用Dist（-1）标记所有边就能得到深度，别忘了半环可以组合，比如可以把它们wrap进Path或者Tree，这样其实是缓存了所有计算过程，两个半环的和仍然是半环，BFS用(Tropical Int, Seq String)可以计算图的半径以及给出所有可能的半径。有向无环图拓扑排序也可以表达，比如今年Advent of code第六天的两道题用这套方法解决起来就很顺手，数DAG里面有序对的数目可以用自然数半环，最后每个顶点总结时额外加一就行。之前说过幂等半环可以定义偏序，我们还可以表达更一般的最短路径算法Dijkstra。</p><div class="highlight"><pre><code class="language-haskell"><span class="kr">type</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="kt">Map</span> <span class="nf">v</span> <span class="kt">Int</span><span class="p">,</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span><span class="p">,</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span><span class="p">))</span>

<span class="nf">mkGraph</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="nf">v</span> <span class="ow">=&gt;</span> <span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span>
<span class="nf">mkGraph</span> <span class="p">(</span><span class="kt">Rel</span> <span class="nf">vs</span> <span class="nf">es</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="nf">encode</span><span class="p">,</span> <span class="kt">M</span><span class="o">.</span><span class="nf">foldrWithKey</span> <span class="p">(</span><span class="nf">\k</span> <span class="nf">v</span> <span class="ow">-&gt;</span> <span class="nf">succ</span> <span class="nf">k</span> <span class="nf">v</span> <span class="o">.</span> <span class="nf">pred</span> <span class="nf">k</span> <span class="nf">v</span><span class="p">)</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">empty</span> <span class="nf">es</span><span class="p">)</span>
  <span class="kr">where</span>
    <span class="nf">encode</span> <span class="ow">=</span> <span class="kt">M</span><span class="o">.</span><span class="nf">fromList</span> <span class="o">$</span> <span class="nf">zip</span> <span class="p">(</span><span class="kt">S</span><span class="o">.</span><span class="nf">toList</span> <span class="nf">vs</span><span class="p">)</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="p">]</span>
    <span class="nf">pred</span> <span class="p">(</span><span class="nf">s</span><span class="p">,</span> <span class="nf">t</span><span class="p">)</span> <span class="nf">e</span> <span class="ow">=</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">insertWith</span> <span class="p">(</span><span class="nf">\nv</span> <span class="ow">-&gt;</span> <span class="nf">_1</span> <span class="o">%~</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">union</span> <span class="p">(</span><span class="nf">nv</span> <span class="o">^.</span> <span class="nf">_1</span><span class="p">))</span> <span class="p">(</span><span class="nf">encode</span> <span class="kt">M</span><span class="o">.!</span> <span class="nf">t</span><span class="p">)</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="nf">singleton</span> <span class="p">(</span><span class="nf">encode</span> <span class="kt">M</span><span class="o">.!</span> <span class="nf">s</span><span class="p">)</span> <span class="nf">e</span><span class="p">,</span><span class="nf">t</span><span class="p">,</span><span class="kt">IM</span><span class="o">.</span><span class="nf">empty</span><span class="p">)</span>
    <span class="nf">succ</span> <span class="p">(</span><span class="nf">s</span><span class="p">,</span> <span class="nf">t</span><span class="p">)</span> <span class="nf">e</span> <span class="ow">=</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">insertWith</span> <span class="p">(</span><span class="nf">\nv</span> <span class="ow">-&gt;</span> <span class="nf">_3</span> <span class="o">%~</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">union</span> <span class="p">(</span><span class="nf">nv</span> <span class="o">^.</span> <span class="nf">_3</span><span class="p">))</span> <span class="p">(</span><span class="nf">encode</span> <span class="kt">M</span><span class="o">.!</span> <span class="nf">s</span><span class="p">)</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="nf">empty</span><span class="p">,</span><span class="nf">s</span><span class="p">,</span><span class="kt">IM</span><span class="o">.</span><span class="nf">singleton</span> <span class="p">(</span><span class="nf">encode</span> <span class="kt">M</span><span class="o">.!</span> <span class="nf">t</span><span class="p">)</span> <span class="nf">e</span><span class="p">)</span>

<span class="nf">context</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span><span class="p">,</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span><span class="p">),</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span><span class="p">)</span>
<span class="nf">context</span> <span class="nf">v</span> <span class="ow">=</span> <span class="p">(</span><span class="o">^.</span> <span class="nf">_2</span> <span class="o">.</span> <span class="nf">at</span> <span class="nf">v</span><span class="p">)</span> <span class="o">&amp;&amp;&amp;</span> <span class="p">(</span><span class="nf">_2</span> <span class="o">%~</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">delete</span> <span class="nf">v</span><span class="p">)</span>

<span class="nf">bft</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">e</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span>
<span class="nf">bft</span> <span class="kt">[]</span>     <span class="kr">_</span>                                <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">acc</span>
<span class="nf">bft</span> <span class="p">(</span><span class="nf">v</span><span class="kt">:</span><span class="nf">vs</span><span class="p">)</span> <span class="p">(</span><span class="nf">context</span> <span class="nf">v</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Nothing</span><span class="p">,</span>      <span class="nf">g</span><span class="p">))</span> <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">bft</span> <span class="nf">vs</span> <span class="nf">g</span> <span class="nf">acc</span>
<span class="nf">bft</span> <span class="p">(</span><span class="nf">v</span><span class="kt">:</span><span class="nf">vs</span><span class="p">)</span> <span class="p">(</span><span class="nf">context</span> <span class="nf">v</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Just</span> <span class="p">(</span><span class="nf">p</span><span class="p">,</span><span class="nf">c</span><span class="p">,</span><span class="nf">s</span><span class="p">),</span> <span class="nf">g</span><span class="p">))</span> <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">bft</span> <span class="p">(</span><span class="nf">vs</span> <span class="o">++</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">keys</span> <span class="nf">s</span><span class="p">)</span> <span class="nf">g</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="nf">insert</span> <span class="nf">v</span> <span class="p">(</span><span class="nf">summary</span> <span class="nf">p</span> <span class="nf">acc</span><span class="p">)</span> <span class="nf">acc</span><span class="p">)</span>
  <span class="kr">where</span>
    <span class="nf">summary</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
    <span class="nf">summary</span> <span class="nf">vs</span> <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">liftA3</span> <span class="nf">bool</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">const</span> <span class="nf">one</span><span class="p">)</span> <span class="nf">null</span> <span class="o">.</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">elems</span> <span class="o">$</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">mapMaybeWithKey</span> <span class="p">(</span><span class="nf">\i</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="o">&lt;.&gt;</span> <span class="nf">e</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">lookup</span> <span class="nf">i</span> <span class="nf">acc</span><span class="p">)</span> <span class="nf">vs</span>

<span class="nf">dft</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">e</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span>
<span class="nf">dft</span> <span class="kt">[]</span>     <span class="kr">_</span>                                <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">acc</span>
<span class="nf">dft</span> <span class="p">(</span><span class="nf">v</span><span class="kt">:</span><span class="nf">vs</span><span class="p">)</span> <span class="p">(</span><span class="nf">context</span> <span class="nf">v</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Nothing</span><span class="p">,</span>      <span class="nf">g</span><span class="p">))</span> <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">dft</span> <span class="nf">vs</span> <span class="nf">g</span> <span class="nf">acc</span>
<span class="nf">dft</span> <span class="p">(</span><span class="nf">v</span><span class="kt">:</span><span class="nf">vs</span><span class="p">)</span> <span class="p">(</span><span class="nf">context</span> <span class="nf">v</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Just</span> <span class="p">(</span><span class="nf">p</span><span class="p">,</span><span class="nf">c</span><span class="p">,</span><span class="nf">s</span><span class="p">),</span> <span class="nf">g</span><span class="p">))</span> <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">uncurry</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="nf">insert</span> <span class="nf">v</span><span class="p">)</span> <span class="o">.</span> <span class="p">(</span><span class="nf">summary</span> <span class="nf">s</span> <span class="o">&amp;&amp;&amp;</span> <span class="nf">id</span><span class="p">)</span> <span class="o">$</span> <span class="nf">dft</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="nf">keys</span> <span class="nf">s</span> <span class="o">++</span> <span class="nf">vs</span><span class="p">)</span> <span class="nf">g</span> <span class="nf">acc</span>
  <span class="kr">where</span>
    <span class="nf">summary</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
    <span class="nf">summary</span> <span class="nf">vs</span> <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">liftA3</span> <span class="nf">bool</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">const</span> <span class="nf">one</span><span class="p">)</span> <span class="nf">null</span> <span class="o">.</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">elems</span> <span class="o">$</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">mapMaybeWithKey</span> <span class="p">(</span><span class="nf">\i</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="nf">e</span> <span class="o">&lt;.&gt;</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">lookup</span> <span class="nf">i</span> <span class="nf">acc</span><span class="p">)</span> <span class="nf">vs</span>

<span class="nf">dag&#39;</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">e</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">e</span>
<span class="nf">dag&#39;</span> <span class="kt">[]</span>     <span class="kr">_</span>                                <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">acc</span>
<span class="nf">dag&#39;</span> <span class="p">(</span><span class="nf">v</span><span class="kt">:</span><span class="nf">vs</span><span class="p">)</span> <span class="p">(</span><span class="nf">context</span> <span class="nf">v</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Nothing</span><span class="p">,</span>      <span class="nf">g</span><span class="p">))</span> <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">dag&#39;</span> <span class="nf">vs</span> <span class="nf">g</span> <span class="nf">acc</span>
<span class="nf">dag&#39;</span> <span class="p">(</span><span class="nf">v</span><span class="kt">:</span><span class="nf">vs</span><span class="p">)</span> <span class="p">(</span><span class="nf">context</span> <span class="nf">v</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Just</span> <span class="p">(</span><span class="nf">p</span><span class="p">,</span><span class="nf">c</span><span class="p">,</span><span class="nf">s</span><span class="p">),</span> <span class="nf">g</span><span class="p">))</span> <span class="nf">acc</span> <span class="ow">=</span> <span class="kr">if</span> <span class="nf">all</span> <span class="p">(</span><span class="nf">flip</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">member</span> <span class="nf">acc</span><span class="p">)</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="nf">keys</span> <span class="nf">p</span><span class="p">)</span>
  <span class="kr">then</span> <span class="nf">dag&#39;</span> <span class="p">(</span><span class="nf">vs</span> <span class="o">++</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">keys</span> <span class="nf">s</span><span class="p">)</span> <span class="nf">g</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="nf">insert</span> <span class="nf">v</span> <span class="p">(</span><span class="nf">summary</span> <span class="nf">p</span> <span class="nf">acc</span><span class="p">)</span> <span class="nf">acc</span><span class="p">)</span>  
  <span class="kr">else</span> <span class="nf">dag&#39;</span> <span class="nf">vs</span> <span class="p">(</span><span class="nf">_2</span> <span class="o">%~</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">insert</span> <span class="nf">v</span> <span class="p">(</span><span class="nf">p</span><span class="p">,</span><span class="nf">c</span><span class="p">,</span><span class="nf">s</span><span class="p">)</span> <span class="o">$</span> <span class="nf">g</span><span class="p">)</span> <span class="nf">acc</span>
  <span class="kr">where</span>
    <span class="nf">summary</span> <span class="ow">::</span> <span class="kt">Semiring</span> <span class="nf">r</span> <span class="ow">=&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="kt">IntMap</span> <span class="nf">r</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
    <span class="nf">summary</span> <span class="nf">vs</span> <span class="nf">acc</span> <span class="ow">=</span> <span class="nf">liftA3</span> <span class="nf">bool</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">const</span> <span class="nf">one</span><span class="p">)</span> <span class="nf">null</span> <span class="o">.</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">elems</span> <span class="o">$</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">mapMaybeWithKey</span> <span class="p">(</span><span class="nf">\i</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="o">&lt;.&gt;</span> <span class="nf">e</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">lookup</span> <span class="nf">i</span> <span class="nf">acc</span><span class="p">)</span> <span class="nf">vs</span>

<span class="nf">path</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">r</span><span class="p">,</span> <span class="kt">Semiring</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Path</span> <span class="p">(</span><span class="kt">Alphabet</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
<span class="nf">path</span> <span class="p">(</span><span class="kt">Path</span> <span class="nf">n</span> <span class="nf">t</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">fmap</span> <span class="p">(</span><span class="nf">symbol</span> <span class="o">.</span> <span class="nf">sign</span><span class="p">)</span> <span class="nf">t</span><span class="p">)</span> <span class="o">&lt;.&gt;</span> <span class="nf">symbol</span> <span class="nf">n</span> <span class="o">&lt;+&gt;</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">fmap</span> <span class="nf">path</span> <span class="nf">t</span><span class="p">)</span>

<span class="nf">tree</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">r</span><span class="p">,</span> <span class="kt">Semiring</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Tree</span> <span class="p">(</span><span class="kt">Alphabet</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
<span class="nf">tree</span> <span class="p">(</span><span class="kt">Tree</span> <span class="nf">r</span> <span class="nf">f</span><span class="p">)</span> <span class="ow">=</span> <span class="nf">symbol</span> <span class="nf">r</span> <span class="o">&lt;.&gt;</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">fmap</span> <span class="p">(</span><span class="nf">symbol</span> <span class="o">.</span> <span class="nf">root</span><span class="p">)</span> <span class="nf">f</span><span class="p">)</span> <span class="o">&lt;+&gt;</span> <span class="nf">add</span> <span class="p">(</span><span class="nf">fmap</span> <span class="nf">tree</span> <span class="nf">f</span><span class="p">)</span>

<span class="nf">pair</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Language</span> <span class="nf">r</span><span class="p">,</span> <span class="kt">Semiring</span> <span class="nf">r</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="p">[(</span><span class="kt">Alphabet</span> <span class="nf">r</span><span class="p">,</span> <span class="kt">Alphabet</span> <span class="nf">r</span><span class="p">)]</span> <span class="ow">-&gt;</span> <span class="nf">r</span>
<span class="nf">pair</span> <span class="ow">=</span> <span class="nf">uncurry</span> <span class="nf">dot</span> <span class="o">.</span> <span class="nf">unzip</span> <span class="o">.</span> <span class="nf">fmap</span> <span class="p">(</span><span class="nf">symbol</span> <span class="o">***</span> <span class="nf">symbol</span><span class="p">)</span>

<span class="nf">label</span> <span class="ow">::</span> <span class="p">((</span><span class="nf">v</span><span class="p">,</span> <span class="nf">v</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="nf">e</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">Rel</span> <span class="nf">v</span> <span class="nf">e</span>
<span class="nf">label</span> <span class="nf">f</span> <span class="p">(</span><span class="kt">Rel</span> <span class="nf">vs</span> <span class="nf">em</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Rel</span> <span class="nf">vs</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="nf">mapWithKey</span> <span class="nf">f</span> <span class="nf">em</span><span class="p">)</span>

<span class="nf">bfs</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Ord</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">Semiring</span> <span class="nf">e</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="nf">v</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">M</span><span class="o">.</span><span class="kt">Map</span> <span class="nf">v</span> <span class="nf">e</span>
<span class="nf">bfs</span> <span class="nf">vs</span> <span class="nf">g</span> <span class="ow">=</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">foldrWithKey</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="nf">insert</span> <span class="o">.</span> <span class="nf">view</span> <span class="nf">_2</span> <span class="o">.</span> <span class="p">(</span><span class="nf">snd</span> <span class="nf">g</span> <span class="kt">IM</span><span class="o">.!</span><span class="p">))</span> <span class="kt">M</span><span class="o">.</span><span class="nf">empty</span> <span class="p">(</span><span class="nf">bft</span> <span class="p">(</span><span class="nf">fmap</span> <span class="p">(</span><span class="nf">fst</span> <span class="nf">g</span> <span class="kt">M</span><span class="o">.!</span><span class="p">)</span> <span class="nf">vs</span><span class="p">)</span> <span class="nf">g</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">empty</span><span class="p">)</span>
    
<span class="nf">dfs</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Ord</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">Semiring</span> <span class="nf">e</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="nf">v</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">M</span><span class="o">.</span><span class="kt">Map</span> <span class="nf">v</span> <span class="nf">e</span>
<span class="nf">dfs</span> <span class="nf">vs</span> <span class="nf">g</span> <span class="ow">=</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">foldrWithKey</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="nf">insert</span> <span class="o">.</span> <span class="nf">view</span> <span class="nf">_2</span> <span class="o">.</span> <span class="p">(</span><span class="nf">snd</span> <span class="nf">g</span> <span class="kt">IM</span><span class="o">.!</span><span class="p">))</span> <span class="kt">M</span><span class="o">.</span><span class="nf">empty</span> <span class="p">(</span><span class="nf">dft</span> <span class="p">(</span><span class="nf">fmap</span> <span class="p">(</span><span class="nf">fst</span> <span class="nf">g</span> <span class="kt">M</span><span class="o">.!</span><span class="p">)</span> <span class="nf">vs</span><span class="p">)</span> <span class="nf">g</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">empty</span><span class="p">)</span>

<span class="nf">dag</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Ord</span> <span class="nf">v</span><span class="p">,</span> <span class="kt">Semiring</span> <span class="nf">e</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="kt">Graph</span> <span class="nf">v</span> <span class="nf">e</span> <span class="ow">-&gt;</span> <span class="kt">M</span><span class="o">.</span><span class="kt">Map</span> <span class="nf">v</span> <span class="nf">e</span>
<span class="nf">dag</span> <span class="nf">g</span> <span class="ow">=</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">foldrWithKey</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="nf">insert</span> <span class="o">.</span> <span class="nf">view</span> <span class="nf">_2</span> <span class="o">.</span> <span class="p">(</span><span class="nf">snd</span> <span class="nf">g</span> <span class="kt">IM</span><span class="o">.!</span><span class="p">))</span> <span class="kt">M</span><span class="o">.</span><span class="nf">empty</span> <span class="p">(</span><span class="nf">dag&#39;</span> <span class="p">(</span><span class="nf">filter</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="nf">null</span> <span class="o">.</span> <span class="nf">view</span> <span class="nf">_1</span> <span class="o">.</span> <span class="p">(</span><span class="nf">snd</span> <span class="nf">g</span> <span class="kt">IM</span><span class="o">.!</span><span class="p">))</span> <span class="p">(</span><span class="kt">IM</span><span class="o">.</span><span class="nf">keys</span> <span class="p">(</span><span class="nf">snd</span> <span class="nf">g</span><span class="p">)))</span> <span class="nf">g</span> <span class="kt">IM</span><span class="o">.</span><span class="nf">empty</span><span class="p">)</span></code></pre></div><p>了解半环能够让我们更深刻地理解问题和算法，避免当局者迷，直觉上半环代表着两种计算模式，并行和串行，也正好对应着走迷宫的两种情形，在分岔路口做选择和埋头往前走扩展当前的路径。半环的应用不止于此，下面的文章还会聊到多项式，自动微分和字典树Trie。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
