<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>【精选】卡尔曼滤波及其在配对交易中的应用</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/47471981">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-79b42484586f17c15d0d9b30cbec73b4_r.jpg" alt=""></div><p></p><img src="https://pic4.zhimg.com/v2-f389a4f62cb51f3ae4c0db4468b7ecfc_r.jpg" data-caption="" data-size="normal" data-rawwidth="1000" data-rawheight="400" data-watermark="watermark" data-original-src="v2-f389a4f62cb51f3ae4c0db4468b7ecfc" data-watermark-src="v2-91940980656c229c6cb060d187a770fd" data-private-watermark-src=""><p>来源：人工智能与量化交易</p><p>原文：<a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653289194&amp;idx=1&amp;sn=bab6eb5cb22272e8b11335548b9b813f&amp;chksm=802e38ffb759b1e9b447b7a8fd83617b77a2eab21f88d7fc7fed7eb3f67d51f0824f99e3ace0&amp;token=680616212&amp;lang=zh_CN#rd">【精选】卡尔曼滤波及其在配对交易中的应用</a></p><p><br></p><h2><b>前沿</b></h2><p>听过卡尔曼滤波的差不多有两年的时间了，虽然大致上明白其原理，但是也是直到现在才能够彻底掌握下来。主要是卡尔曼滤波算法涉及到比较复杂的数学公式推导。在很多博客上都有写卡尔曼滤波的相关文章，但都是花非常大的篇幅来通过一些例子来通俗地讲解卡尔曼滤波，对于不知道其数学原理的读者来说，看完之后依然是一知半解。</p><p>本文会先讲解最简单的单变量卡尔曼滤波，让大家知道卡尔曼滤波大致是什么样的，然后再详细地给出公式的推导过程，最后展示卡尔曼滤波在配对交易中的应用。</p><h2><b>卡尔曼滤波</b></h2><p>卡尔曼滤波(Kalman filtering)一种利用线性系统状态方程，通过系统输入输出观测数据，对系统状态进行最优估计的算法。由于观测数据中包括系统中的噪声和干扰的影响，所以最优估计也可看作是滤波过程。</p><p>最简单的单变量卡尔曼滤波，可以认为，我们观测的时间序列是存在噪声的，而我们可以通过卡尔曼滤波，过滤掉噪声，而得到了去除噪声之后的状态序列。</p><img src="https://pic1.zhimg.com/v2-5e03720d025f04c3df03b6c4402bd5db_r.jpg" data-caption="" data-size="normal" data-rawwidth="372" data-rawheight="243" data-watermark="watermark" data-original-src="v2-5e03720d025f04c3df03b6c4402bd5db" data-watermark-src="v2-8c46b3a401a9f3185e669bf5ab512d0c" data-private-watermark-src=""><img src="https://pic3.zhimg.com/v2-21cdfaade0f9d4ec0d6ff9e4abb10f8f_r.jpg" data-caption="" data-size="normal" data-rawwidth="733" data-rawheight="318" data-watermark="watermark" data-original-src="v2-21cdfaade0f9d4ec0d6ff9e4abb10f8f" data-watermark-src="v2-6450abe900b92da71042a7c081da5c84" data-private-watermark-src=""><img src="https://pic3.zhimg.com/v2-da545d25389142a9710f3078c7687a38_r.jpg" data-caption="" data-size="normal" data-rawwidth="733" data-rawheight="373" data-watermark="watermark" data-original-src="v2-da545d25389142a9710f3078c7687a38" data-watermark-src="v2-60aa43691efadccd43d23585d5efb2ec" data-private-watermark-src=""><img src="https://pic2.zhimg.com/v2-a9a6e1d6a75c45c07347e8a292d0e5ba_r.jpg" data-caption="" data-size="normal" data-rawwidth="741" data-rawheight="484" data-watermark="watermark" data-original-src="v2-a9a6e1d6a75c45c07347e8a292d0e5ba" data-watermark-src="v2-fa4d68df336752b198bae4415ba00c0c" data-private-watermark-src=""><img src="https://pic3.zhimg.com/v2-979e02aef2d5e953b7823c6d8e7b8a90_r.jpg" data-caption="" data-size="normal" data-rawwidth="736" data-rawheight="363" data-watermark="watermark" data-original-src="v2-979e02aef2d5e953b7823c6d8e7b8a90" data-watermark-src="v2-13db4d00eda4512e6c13d47623150e9e" data-private-watermark-src=""><img src="https://pic2.zhimg.com/v2-ab77e1d0cbf30bc41789041bdefff492_r.jpg" data-caption="" data-size="normal" data-rawwidth="734" data-rawheight="329" data-watermark="watermark" data-original-src="v2-ab77e1d0cbf30bc41789041bdefff492" data-watermark-src="v2-eaa269c2fff556f5e0b7f303aff963ef" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-bf5c034c8dfec167eb4141b188701105_r.jpg" data-caption="" data-size="normal" data-rawwidth="739" data-rawheight="326" data-watermark="watermark" data-original-src="v2-bf5c034c8dfec167eb4141b188701105" data-watermark-src="v2-55b61b967b93eb04e355b649a85cd0e0" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-0ffad80375c223dd2cdaf31461e34049_r.jpg" data-caption="" data-size="normal" data-rawwidth="727" data-rawheight="503" data-watermark="watermark" data-original-src="v2-0ffad80375c223dd2cdaf31461e34049" data-watermark-src="v2-dbaed2336a998ce6d88ce6c76e551f93" data-private-watermark-src=""><img src="https://pic2.zhimg.com/v2-7e0e22167e7e43ce364394eedf9e1714_r.jpg" data-caption="" data-size="normal" data-rawwidth="738" data-rawheight="487" data-watermark="watermark" data-original-src="v2-7e0e22167e7e43ce364394eedf9e1714" data-watermark-src="v2-db6448c21aaf2312459184c798b995fc" data-private-watermark-src=""><img src="https://pic4.zhimg.com/v2-4b24d979c6eb446e25b42cbb3b6c2aca_r.jpg" data-caption="" data-size="normal" data-rawwidth="724" data-rawheight="329" data-watermark="watermark" data-original-src="v2-4b24d979c6eb446e25b42cbb3b6c2aca" data-watermark-src="v2-0b156df51a0c695514984f386ca7ac86" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-d938450512745cb15602b198aca34978_r.jpg" data-caption="" data-size="normal" data-rawwidth="742" data-rawheight="537" data-watermark="watermark" data-original-src="v2-d938450512745cb15602b198aca34978" data-watermark-src="v2-0bf8605943b446e5e4afd389b88dade3" data-private-watermark-src=""><img src="https://pic2.zhimg.com/v2-ffa29391e67f5e2932a242ff003e9763_r.jpg" data-caption="" data-size="normal" data-rawwidth="730" data-rawheight="341" data-watermark="watermark" data-original-src="v2-ffa29391e67f5e2932a242ff003e9763" data-watermark-src="v2-3e4a2d77d87ec65c7b8f9f30ba6481f4" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-69a1db86f4ab18a7148a2db0b91d3548_r.jpg" data-caption="" data-size="normal" data-rawwidth="745" data-rawheight="379" data-watermark="watermark" data-original-src="v2-69a1db86f4ab18a7148a2db0b91d3548" data-watermark-src="v2-655175c57c4c59ba8cf6a15217d20655" data-private-watermark-src=""><img src="https://pic3.zhimg.com/v2-dfc2ba26c71fdf44809da097d8d93faf_r.jpg" data-caption="" data-size="normal" data-rawwidth="734" data-rawheight="265" data-watermark="watermark" data-original-src="v2-dfc2ba26c71fdf44809da097d8d93faf" data-watermark-src="v2-b068366fbe23dc09e203085a7a9ee949" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-7c2357cf02d76b165087cb5dce3992f9_r.jpg" data-caption="" data-size="normal" data-rawwidth="739" data-rawheight="423" data-watermark="watermark" data-original-src="v2-7c2357cf02d76b165087cb5dce3992f9" data-watermark-src="v2-5b694b53a025459d9cc815efdcabe162" data-private-watermark-src=""><img src="https://pic2.zhimg.com/v2-1bc5b317f6bd3ee872ecea67abf6ccf1_r.jpg" data-caption="" data-size="normal" data-rawwidth="724" data-rawheight="439" data-watermark="watermark" data-original-src="v2-1bc5b317f6bd3ee872ecea67abf6ccf1" data-watermark-src="v2-8dbf00aad691cb361d65e63f57072074" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-c13c36c9201a4bcbb6fa349247f084e7_r.jpg" data-caption="" data-size="normal" data-rawwidth="733" data-rawheight="170" data-watermark="watermark" data-original-src="v2-c13c36c9201a4bcbb6fa349247f084e7" data-watermark-src="v2-d36ff040c96d82689a4b93b81dc97988" data-private-watermark-src=""><h2><b>卡尔曼滤波在配对交易的应用</b></h2><p>关于什么配对交易，什么是统计套利中的协整，知乎上有非常好的回答，在这里我们只讨论卡尔曼滤波在配对交易中的应用。</p><p>在配对交易中，我们构造了如下回归方程</p><img src="https://pic2.zhimg.com/v2-cd16031f9176460bb6d3b1011abedb1b_r.jpg" data-caption="" data-size="normal" data-rawwidth="108" data-rawheight="24" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>然后利用该方程在样本外进行套利。那么，假如我们这里的a和B是会改变的，那么我们如何动态地去调整回归方程的系数？我们可以使用如下滤波的方式。</p><p>建立观测方程</p><img src="https://pic3.zhimg.com/v2-b7440764e902d93bd455651052956dc9_r.jpg" data-caption="" data-size="normal" data-rawwidth="134" data-rawheight="51" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>建立状态方程</p><img src="https://pic1.zhimg.com/v2-67c9f84e23f22de0c1833cc707a38d30_r.jpg" data-caption="" data-size="normal" data-rawwidth="114" data-rawheight="51" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>我们需要估计的状态为</p><img src="https://pic4.zhimg.com/v2-b14ec9378392899b2eee8b1629957d28_r.jpg" data-caption="" data-size="normal" data-rawwidth="34" data-rawheight="51" data-watermark="" data-original-src="" data-watermark-src="" data-private-watermark-src=""><p>下面以焦炭和螺纹为例，采用焦炭和螺纹主力连续合约的收盘价数据：</p><img src="https://pic2.zhimg.com/v2-fa28d0956ed52ba5a9830ae595727080_r.jpg" data-caption="" data-size="normal" data-rawwidth="276" data-rawheight="204" data-watermark="watermark" data-original-src="v2-fa28d0956ed52ba5a9830ae595727080" data-watermark-src="v2-791d27406dd0ac1389a7a7fdd025228f" data-private-watermark-src=""><img src="https://pic1.zhimg.com/v2-49aee8882a8b4d19af90ba8dfdbc664a_r.jpg" data-caption="" data-size="normal" data-rawwidth="484" data-rawheight="328" data-watermark="watermark" data-original-src="v2-49aee8882a8b4d19af90ba8dfdbc664a" data-watermark-src="v2-3712f723db86c33a67412dbde9878dc9" data-private-watermark-src=""><code lang="python"># 以焦炭的收盘价数据作为x，螺纹的收盘价数据作为y
# 螺纹价格 = alpha + beta * 焦炭价格 + 随机误差 
from pykalman import KalmanFilter

#建立观测矩阵
observation_matrices = np.vstack(( np.ones(len(df[:'2013'])),
                                  df.loc[:'2013','焦炭'].values )).T
Shape = observation_matrices.shape
observation_matrices = observation_matrices.reshape(Shape[0],1,Shape[1])

#定义卡尔曼滤波的方程
kf = KalmanFilter(transition_matrices=np.array([[1,0],[0,1]]), #转移矩阵为单位阵
                  observation_matrices=observation_matrices)
np.random.seed(0)

# 使用2013年以前的数据，采用EM算法，估计出初始状态，
# 初始状态的协方差，观测方程和状态方程误差的协方差
kf.em(df.loc[:'2013','螺纹'])


#对2013年的数据做滤波
filter_mean,filter_cov = kf.filter(df.loc[:'2013','螺纹'])#观测值为螺纹

#从2014年开始滚动
start_index = np.where(df.index.year==2014)[0][0]

for i in range(start_index,len(df)):
    observation_matrix = np.array([[1,df['焦炭'].values[i]]])
    observation = df['螺纹'].values[i]

    #以上一个时刻的状态，状态的协方差以及当前的观测值，得到当前状态的估计
    next_filter_mean,next_filter_cov = kf.filter_update(
            filtered_state_mean = filter_mean[-1],
            filtered_state_covariance = filter_cov[-1],
            observation = observation,
            observation_matrix = observation_matrix)

    filter_mean = np.vstack((filter_mean,next_filter_mean))
    filter_cov = np.vstack((filter_cov,next_filter_cov.reshape(1,2,2)))

#得到alpha和beta
alpha = pd.Series(filter_mean[start_index:,0], index = df.index[start_index:])
beta = pd.Series(filter_mean[start_index:,1], index = df.index[start_index:])</code><p>得到alpha和beta的值如下：</p><img src="https://pic4.zhimg.com/v2-0527c4fa6584115cb5e6d13bf62454e5_r.jpg" data-caption="" data-size="normal" data-rawwidth="479" data-rawheight="352" data-watermark="watermark" data-original-src="v2-0527c4fa6584115cb5e6d13bf62454e5" data-watermark-src="v2-2d073636c05abe1a7bf33b15102705a5" data-private-watermark-src=""><h2><b>推荐阅读</b></h2><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653289074&amp;idx=1&amp;sn=e859d363eef9249236244466a1af41b6&amp;chksm=802e3867b759b1717f77e07a51ee5671e8115130c66562577280ba1243cba08218add04f1f00&amp;token=449379994&amp;lang=zh_CN&amp;scene=21#wechat_redirect">1、经过多年交易之后你应该学到的东西（深度分享）</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653289050&amp;idx=1&amp;sn=60043a5c95b877dd329a5fd150ddacc4&amp;chksm=802e384fb759b1598e500087374772059aa21b31ae104b3dca04331cf4b63a233c5e04c1945a&amp;token=449379994&amp;lang=zh_CN&amp;scene=21#wechat_redirect">2、监督学习标签在股市中的应用（代码+书籍）</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653289028&amp;idx=1&amp;sn=631cbc728b0f857713fc65841e48e5d1&amp;chksm=802e3851b759b147dc92afded432db568d9d77a1b97ef22a1e1a376fa0bc39b55781c18b5f4f&amp;token=449379994&amp;lang=zh_CN&amp;scene=21#wechat_redirect">3、2018年学习Python最好的5门课程</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653289018&amp;idx=1&amp;sn=8c411f676c2c0d92b0dd218f041bee4b&amp;chksm=802e382fb759b139ffebf633ac14cdd0f21938e4613fe632d5d9231dab3d2aca95a11628378a&amp;token=449379994&amp;lang=zh_CN&amp;scene=21#wechat_redirect">4、全球投行顶尖机器学习团队全面分析</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653289014&amp;idx=1&amp;sn=3762d405e332c599a21b48a7dc4df587&amp;chksm=802e3823b759b135928d55044c2729aea9690f86752b680eb973d1a376dc53cfa18287d0060b&amp;token=449379994&amp;lang=zh_CN&amp;scene=21#wechat_redirect">5、使用Tensorflow预测股票市场变动</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTc0Mjg0Mg==&amp;mid=2653289110&amp;idx=1&amp;sn=538d00046a15fb2f70a56be79f71e6b9&amp;chksm=802e3883b759b1950252499ea9a7b1fadaa4748ec40b8a1a8d7da0d5c17db153bd86548060fb&amp;token=1336933869&amp;lang=zh_CN&amp;scene=21#wechat_redirect">6、被投资圈残害的清北复交学生们</a></p><p><br></p><p><b>在量化投资的道路上</b></p><p><b>你不是一个人在战斗</b></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
