<div class="title-image"><img src="https://pic1.zhimg.com/77f5a8c831914c602fb4cf4aabdfe133_b.jpg" alt=""></div><p>导语：我们经常在抓反弹时感觉像在抓一只刺猬，不知道该怎么下手。左侧交易会不会买在半山腰？右侧交易会不会进场太 晚？什么时候买入真是让人头疼。切莫苦恼，你完全可以通过历史数据统计判断反弹的时机。本文就将抛砖引玉地介绍一种简单的统计方法，它不能保证抓反弹次次 成功，但可以让你对多错少，累积起来就是真实的收益！</p><p>本文是量化课堂的<a class=" wrap external" href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/1608%3Ff%3Dzh" target="_blank" rel="nofollow noreferrer">《均值回归入门》</a>的进阶版，并且用到<a class=" wrap external" href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/2086%3Ff%3Dzh" target="_blank" rel="nofollow noreferrer">《指标效果的统计分析》</a>一文中的统计方法。</p><h4>动机</h4><p>我们先回顾一下均值回归的基本概要：</p><p>股票的价格会以它的均线为中心进行波动。也就是说，当标的价格由于波动而偏离移动均线时，它将调整并重新归于均线。那么如果我们如果能捕捉偏离股价的回归，就可以从此获利。</p><p>在入门篇文章里我们尝试了一个非常简单的均值回归策略，也发现了相应的问题：那就是无法准确判断何时买入，也缺乏买在半山腰之后的处置机制。本篇要讲的是，统计历史数据中价格偏离所对应的反弹幅度，选择胜率最高的偏离度作为入场信号。<br/></p><h4>波动大小的相对性</h4><p>在入门篇文章中我们粗略地以价格和均线的偏差作为买入的评估标准，但它有一个弊端，那就是忽略了股价波动的相对性。假如股票 A 在一段时间里每天振幅 3%，股票 B 在同样一段时间里每日振幅 0.5%，今天我们发现 A 和 B 的股价都和均线偏离了 2%，我们认为那支的偏离更显著呢？是 B 对吧。</p><p>举实例来说。下图是某支股票的 60 分钟线，中间紫色曲线为股价的 5 日均线。可以看出在蓝色线段标明的时间里，股价波动平缓。在两个粉色箭头处，股价比均线分别高 4.1% 和低 5.9%。这些波动较前段时间更为剧烈，可以告诉我们股价发生了偏离。</p><p><figure><noscript><img data-rawheight="574" data-rawwidth="1083" src="https://pic2.zhimg.com/9ad8df5d8735790bd61693de31eebab9_b.png" class="origin_image zh-lightbox-thumb" width="1083" data-original="https://pic2.zhimg.com/9ad8df5d8735790bd61693de31eebab9_r.jpg"/></noscript><img data-rawheight="574" data-rawwidth="1083" src="https://pic2.zhimg.com/9ad8df5d8735790bd61693de31eebab9_b.png" class="origin_image zh-lightbox-thumb lazy" width="1083" data-original="https://pic2.zhimg.com/9ad8df5d8735790bd61693de31eebab9_r.jpg" data-actualsrc="https://pic2.zhimg.com/9ad8df5d8735790bd61693de31eebab9_b.png"/></figure>再看下图，这是同一支股票在另一段时间的 60 分钟线。这段时间里价格波动幅度大，在粉色箭头的位置，价格和均线的差距分别为5.3% 和 5.1%，但我们不将其视为显著的价格偏离。</p><p>那么我们该如何测量近期波动幅度的大小呢？这就要涉及到统计学中的标准差概念。</p><h4>标准差</h4><p>标准差（standard deviation），通常用小写希腊字母 σ（sigma，读“西格玛”）表示。通俗地讲，一组数据的标准差就是这组数据离均值的普遍差距。</p><p>假设 x1,x2,…,xn 是我们观测到的一组数据，这组数据的均值是 μ=(x1+x2+⋯+xn)/n<br/>标准差的计算公式为<br/></p><figure><noscript><img data-rawheight="88" data-rawwidth="491" src="https://pic4.zhimg.com/e22d767af1303268a2d29c30d6954cdf_b.png" class="origin_image zh-lightbox-thumb" width="491" data-original="https://pic4.zhimg.com/e22d767af1303268a2d29c30d6954cdf_r.jpg"/></noscript><img data-rawheight="88" data-rawwidth="491" src="https://pic4.zhimg.com/e22d767af1303268a2d29c30d6954cdf_b.png" class="origin_image zh-lightbox-thumb lazy" width="491" data-original="https://pic4.zhimg.com/e22d767af1303268a2d29c30d6954cdf_r.jpg" data-actualsrc="https://pic4.zhimg.com/e22d767af1303268a2d29c30d6954cdf_b.png"/></figure><p>这里 xt−μ 计算的是第 t 项数据和均值的差值。将这 n 项差值的平方取了平均，再算出平方根，我们得到的是这组数与均值偏差的一个标准。如果这组数据的波动较大，那么 σ 相应也会较大；相反的，如果这组数据波动小，那么 σ 会更接近零。 举例来说，假设我们有一组数据 A=(1,0,0,0,0−1,0,0,0,0)，如下</p><figure><noscript><img data-rawheight="705" data-rawwidth="1073" src="https://pic1.zhimg.com/bb768c03a325af11a049292a96c2fdf0_b.png" class="origin_image zh-lightbox-thumb" width="1073" data-original="https://pic1.zhimg.com/bb768c03a325af11a049292a96c2fdf0_r.jpg"/></noscript><img data-rawheight="705" data-rawwidth="1073" src="https://pic1.zhimg.com/bb768c03a325af11a049292a96c2fdf0_b.png" class="origin_image zh-lightbox-thumb lazy" width="1073" data-original="https://pic1.zhimg.com/bb768c03a325af11a049292a96c2fdf0_r.jpg" data-actualsrc="https://pic1.zhimg.com/bb768c03a325af11a049292a96c2fdf0_b.png"/></figure><p>它的平均值是 00，标准差是<br/></p><figure><noscript><img data-rawheight="92" data-rawwidth="463" src="https://pic1.zhimg.com/281f1872cf1164cb674f92451dfd4200_b.png" class="origin_image zh-lightbox-thumb" width="463" data-original="https://pic1.zhimg.com/281f1872cf1164cb674f92451dfd4200_r.jpg"/></noscript><img data-rawheight="92" data-rawwidth="463" src="https://pic1.zhimg.com/281f1872cf1164cb674f92451dfd4200_b.png" class="origin_image zh-lightbox-thumb lazy" width="463" data-original="https://pic1.zhimg.com/281f1872cf1164cb674f92451dfd4200_r.jpg" data-actualsrc="https://pic1.zhimg.com/281f1872cf1164cb674f92451dfd4200_b.png"/></figure><p>这时如果下一项出现的数据是 x11=1，可以算出它和均值的差是 (1−0)/σ≈2.23 倍标准差，可以被视为是一个较大的波动。 在另一种情况里，假设我们的数据是 B=(1,−1,1,−1,1,−1,1,−1,1,−1)，如下图</p><figure><noscript><img data-rawheight="709" data-rawwidth="1079" src="https://pic2.zhimg.com/dd5906c9a1584fb85129bccedc821d91_b.png" class="origin_image zh-lightbox-thumb" width="1079" data-original="https://pic2.zhimg.com/dd5906c9a1584fb85129bccedc821d91_r.jpg"/></noscript><img data-rawheight="709" data-rawwidth="1079" src="https://pic2.zhimg.com/dd5906c9a1584fb85129bccedc821d91_b.png" class="origin_image zh-lightbox-thumb lazy" width="1079" data-original="https://pic2.zhimg.com/dd5906c9a1584fb85129bccedc821d91_r.jpg" data-actualsrc="https://pic2.zhimg.com/dd5906c9a1584fb85129bccedc821d91_b.png"/></figure><p>可以直观地看出波动较大。这组数据同样是均值等于 0，它的标准差是<br/></p><figure><noscript><img data-rawheight="85" data-rawwidth="592" src="https://pic1.zhimg.com/bcaff1f2c959c5673807feb768f46b88_b.png" class="origin_image zh-lightbox-thumb" width="592" data-original="https://pic1.zhimg.com/bcaff1f2c959c5673807feb768f46b88_r.jpg"/></noscript><img data-rawheight="85" data-rawwidth="592" src="https://pic1.zhimg.com/bcaff1f2c959c5673807feb768f46b88_b.png" class="origin_image zh-lightbox-thumb lazy" width="592" data-original="https://pic1.zhimg.com/bcaff1f2c959c5673807feb768f46b88_r.jpg" data-actualsrc="https://pic1.zhimg.com/bcaff1f2c959c5673807feb768f46b88_b.png"/></figure><br/>明显比数据 A 的标准差更大。这时如果出现新的数据 x11=1，由于它和均值的差距等同于标准，我们不认为它是一个很大的波动。<p>有了这个概念，我们可以构造一种利用标准差来测量当日股价波动幅度的方法。取过去 N 天收盘价，并取其标准差 σ，设今日股价为 P 并且 N 日均线值为 MAN，计算<br/></p><figure><noscript><img data-rawheight="86" data-rawwidth="186" src="https://pic4.zhimg.com/ffb063374ce0e2da318698506c2960f3_b.png" class="content_image" width="186"/></noscript><img data-rawheight="86" data-rawwidth="186" src="https://pic4.zhimg.com/ffb063374ce0e2da318698506c2960f3_b.png" class="content_image lazy" width="186" data-actualsrc="https://pic4.zhimg.com/ffb063374ce0e2da318698506c2960f3_b.png"/></figure><p>这个值得含义是，相较过去 N 天的价格，今日股价与均值的偏差为 ρ 倍的标准差。如果绝对值 |ρ| 比较大，我们判定今日价格波动比历史波动更为突出；反之，如果 |ρ| 比较小，我们判定今日的波动很普通。嗯，这个 ρ 嘛，为了方便起见，作者就自行起一个名字吧，就叫它“N 日偏离倍数好了”。</p><p>好，可以合理地判定波动大小了，那么应该如何利用这些信息判断何时入场呢？</p><h4>偏离倍数和赢输的统计</h4><p>我们没法凭空预测偏离倍数在多大的情况下价格会反弹，也不能盲目地认为偏离倍数越高越好。我们干脆穷举，对历史上所有的偏离倍数（范围），统计其后后股价的走势，然后将胜率最高的偏离倍数视为入场信号，在其出现时买入。</p><p>接下来的统计方法请参阅量化课堂文章<a class=" wrap external" href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/2086%3Ff%3Dzh" target="_blank" rel="nofollow noreferrer">《指标效果的统计分析》</a>。</p><p>按照文中的思路，我们要计量的指标是上一节中介绍的 N 日偏离倍数 ρ。另外，我们只记录 ρ&lt;−1 的情况，因为如果 ρ≥−1，那说明价格偏离不大，则不构成回归信号。</p><p>我们将要统计的结果进行如下判定：设定观测输赢的天数 T，止盈的 σ 倍数 u，止损的 σ 倍数 d。如果在未来的 T 天里，股价先上涨 σ⋅u，则记作“赢”；先下跌 σ⋅d，则记作“输”；如果 T 天股价都没离开这个区间，则记作“平”。</p><p>以某股票从 2006 年到 2016 年的数据为例，统计结果如下：</p><figure><noscript><img data-rawheight="730" data-rawwidth="1085" src="https://pic4.zhimg.com/6afc4da09d8de1efc54ff3fa2d9a6e1f_b.png" class="origin_image zh-lightbox-thumb" width="1085" data-original="https://pic4.zhimg.com/6afc4da09d8de1efc54ff3fa2d9a6e1f_r.jpg"/></noscript><img data-rawheight="730" data-rawwidth="1085" src="https://pic4.zhimg.com/6afc4da09d8de1efc54ff3fa2d9a6e1f_b.png" class="origin_image zh-lightbox-thumb lazy" width="1085" data-original="https://pic4.zhimg.com/6afc4da09d8de1efc54ff3fa2d9a6e1f_r.jpg" data-actualsrc="https://pic4.zhimg.com/6afc4da09d8de1efc54ff3fa2d9a6e1f_b.png"/></figure><p>通过直接看图可估测出 ρ 在 2.3 到 3.0 的区间里胜率很高。我们再通过<a href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/2086" class=" wrap external" target="_blank" rel="nofollow noreferrer">文章中</a>取最佳指标区间的算法获取一个胜率最高的偏离倍数区间。这里，我们想选定一个区间宽度 w，并在以上统计中计算一个宽度为 w 的横轴区间（w 个连续竖条），需要它的胜率（绿色区域总和除以红色区域总和）是最高的。当然，还需要设置一个最小数据比 θ，区间内的数据量必须高于总数据量的 θ 倍，不然区间内的统计缺乏可信性。</p><p>我们设置参数：区间宽度 w=5，最小数据比 θ=0.05。通过计算，得到区间 [−2.6,3.1]，区间中的数据如下：</p><p><figure><noscript><img data-rawheight="388" data-rawwidth="373" src="https://pic2.zhimg.com/b340fa6abfac6d91da99a6098a62e539_b.png" class="content_image" width="373"/></noscript><img data-rawheight="388" data-rawwidth="373" src="https://pic2.zhimg.com/b340fa6abfac6d91da99a6098a62e539_b.png" class="content_image lazy" width="373" data-actualsrc="https://pic2.zhimg.com/b340fa6abfac6d91da99a6098a62e539_b.png"/></figure>其中赢 (5,7,4,3,8) 次，输 (1,4,2,3,2)。计算出输赢率为<br/></p><figure><noscript><img data-rawheight="68" data-rawwidth="279" src="https://pic2.zhimg.com/ed4147a5d7516f91e1a1599c2e614b0d_b.png" class="content_image" width="279"/></noscript><img data-rawheight="68" data-rawwidth="279" src="https://pic2.zhimg.com/ed4147a5d7516f91e1a1599c2e614b0d_b.png" class="content_image lazy" width="279" data-actualsrc="https://pic2.zhimg.com/ed4147a5d7516f91e1a1599c2e614b0d_b.png"/></figure><br/>也就是说，根据历史统计，如果当偏离倍数在 −3.1 和 −2.6 之间时买入该股票，输赢的预期是 27 赢比 12 输，当然，还有 2 次平局。<br/><h4>策略和回测</h4><p>其实策略的主要部分已经完成，只要加上对资金和仓位的管理，就可以构成一个可运行的策略。这里我们就构建一个很简单的方案。</p><p>设定如上一节所述每的参数：均线天数 N，统计输赢天数 T，止盈倍数 u，止损倍数 d，区间宽度 w，和最小数据比 θ。每交易日执行以下操作：<br/>一、全仓卖出应当止盈或止损的股票，或持有超过 T 天的股票；<br/>二、执行上一节的统计方法来更新每一支股票的最佳偏离倍数区间；<br/>三、如果空仓，选定任意一支偏离倍数在最佳区间内的股票并全仓买入，如果所有股票都不符合则空仓。买入时记录止盈线 u 倍 σ 和止损线 d 倍 σ，并设置如果 T 日内未触碰止盈或止损线，也全部卖出。</p><p>来看一看回测结果。以下回测使用的股票池只包含 1 或 2 支标的股，这样便于看出策略对于个股发出的信号。文章最后的策略代码只适用于小规模的股票池；对于更大的股票池，信号会更加密集，因此需要调整每支股票的 持仓量并且分别止盈止损，读者可以自行进行修改，或等待量化课堂未来的文章。另外，我们的回测从 2011 年开始，这样保证回测开始时就有一定的历史数据储备。</p><p>首先是股票 002013 的回测，使用参数 N=30，T=30，u=d=1，w=4，θ=0.05，回测结果如下。</p><p><figure><noscript><img data-rawheight="447" data-rawwidth="1085" src="https://pic2.zhimg.com/15d77c587f003e2646d5be0b6fcdd461_b.png" class="origin_image zh-lightbox-thumb" width="1085" data-original="https://pic2.zhimg.com/15d77c587f003e2646d5be0b6fcdd461_r.jpg"/></noscript><img data-rawheight="447" data-rawwidth="1085" src="https://pic2.zhimg.com/15d77c587f003e2646d5be0b6fcdd461_b.png" class="origin_image zh-lightbox-thumb lazy" width="1085" data-original="https://pic2.zhimg.com/15d77c587f003e2646d5be0b6fcdd461_r.jpg" data-actualsrc="https://pic2.zhimg.com/15d77c587f003e2646d5be0b6fcdd461_b.png"/></figure>策略在震荡市中产生比较稳定的收益，并保持比较小的回撤。在牛市中完全不产生信号，因此没有半点反应，倒是在股灾之后稳稳地抓好了反弹，在短期内获取大量收益。 还使用同样的参数，我们看 002230 的回测。</p><p><figure><noscript><img data-rawheight="372" data-rawwidth="1087" src="https://pic1.zhimg.com/7871aaf88f8d7dd90753dc40d2f90424_b.png" class="origin_image zh-lightbox-thumb" width="1087" data-original="https://pic1.zhimg.com/7871aaf88f8d7dd90753dc40d2f90424_r.jpg"/></noscript><img data-rawheight="372" data-rawwidth="1087" src="https://pic1.zhimg.com/7871aaf88f8d7dd90753dc40d2f90424_b.png" class="origin_image zh-lightbox-thumb lazy" width="1087" data-original="https://pic1.zhimg.com/7871aaf88f8d7dd90753dc40d2f90424_r.jpg" data-actualsrc="https://pic1.zhimg.com/7871aaf88f8d7dd90753dc40d2f90424_b.png"/></figure>同样是在震荡市中表现良好，但在股灾中抓反弹一度失利，不过后期在弥补损失之余获得了更高的收益。 观看回测最下方的“每日买卖”图可看出这个策略产生的信号和交易实则不多，在股票池里放入多支股票的话可以轮回抓取反弹，产生叠加的收益。比如，下图是将上面两支股票的作为标的回测，对比的指数是沪深300。</p><figure><noscript><img data-rawheight="373" data-rawwidth="1083" src="https://pic3.zhimg.com/fb4d434e3032b4b0170794a01c237d42_b.png" class="origin_image zh-lightbox-thumb" width="1083" data-original="https://pic3.zhimg.com/fb4d434e3032b4b0170794a01c237d42_r.jpg"/></noscript><img data-rawheight="373" data-rawwidth="1083" src="https://pic3.zhimg.com/fb4d434e3032b4b0170794a01c237d42_b.png" class="origin_image zh-lightbox-thumb lazy" width="1083" data-original="https://pic3.zhimg.com/fb4d434e3032b4b0170794a01c237d42_r.jpg" data-actualsrc="https://pic3.zhimg.com/fb4d434e3032b4b0170794a01c237d42_b.png"/></figure><br/><h4>结语</h4><p>嗯，我们看看啊…总结就是三点。首先是均值回归核心思路：</p><p>价格偏离均线太多就会弹回来</p><p>然后是，我们怎么判断偏离多少呢？</p><p>价格减去均线除以历史波动的标准差可以丈量偏离的程度</p><p>判断入场的话…</p><p>利用历史统计的偏离倍数对应的输赢率判断入场时机</p><p>最后还要指出，本篇文章旨为抛砖引玉，展示一种思路。文中的统计方法比较粗糙，策略也比较简单。想要在实战中应用的话，还需要进一步拓展、打磨并结 合其他的方法，才能构造出一套成熟的交易策略。量化课堂未来的文章会在此策略上升级改进，结合凯利公式进行动态的仓位调整，敬请期待。<br/></p><h4>函数和变量说明书</h4><p>函数说明书</p><p><figure><noscript><img data-rawheight="567" data-rawwidth="1079" src="https://pic4.zhimg.com/1b6a5dcc27ca874d2dcc7ce0140253f3_b.png" class="origin_image zh-lightbox-thumb" width="1079" data-original="https://pic4.zhimg.com/1b6a5dcc27ca874d2dcc7ce0140253f3_r.jpg"/></noscript><img data-rawheight="567" data-rawwidth="1079" src="https://pic4.zhimg.com/1b6a5dcc27ca874d2dcc7ce0140253f3_b.png" class="origin_image zh-lightbox-thumb lazy" width="1079" data-original="https://pic4.zhimg.com/1b6a5dcc27ca874d2dcc7ce0140253f3_r.jpg" data-actualsrc="https://pic4.zhimg.com/1b6a5dcc27ca874d2dcc7ce0140253f3_b.png"/></figure>全局变量说明书</p><figure><noscript><img data-rawheight="713" data-rawwidth="951" src="https://pic1.zhimg.com/24756a84e6b332a98afaa70636f2c078_b.png" class="origin_image zh-lightbox-thumb" width="951" data-original="https://pic1.zhimg.com/24756a84e6b332a98afaa70636f2c078_r.jpg"/></noscript><img data-rawheight="713" data-rawwidth="951" src="https://pic1.zhimg.com/24756a84e6b332a98afaa70636f2c078_b.png" class="origin_image zh-lightbox-thumb lazy" width="951" data-original="https://pic1.zhimg.com/24756a84e6b332a98afaa70636f2c078_r.jpg" data-actualsrc="https://pic1.zhimg.com/24756a84e6b332a98afaa70636f2c078_b.png"/></figure><p>到JoinQuant查看代码并与作者交流讨论：<a class=" wrap external" href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/1899%3Ff%3Dzh" target="_blank" rel="nofollow noreferrer">【量化课堂】均值回归进阶策略</a></p>