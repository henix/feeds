<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>AWS 及 IAM 答疑</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/20333735">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/1065ac0e567c2c5be1f77d870a4101db_r.jpg" alt=""></div><p>以下是昨日的文章『深入了解IAM和访问控制』发布之后，一些读者的疑问。</p><p>Q: 我想开始学习 AWS，从哪里入手？</p><p>A: 先去注册 AWS account，然后看官方的文档。AWS 头一年很多服务在一定的额度下都是免费使用的，如果只是学习，不会有任何花费。不过要注意在你不用的时候或者一年后清理所使用的资源。有些读者使用了一年，忘记了，结果交了好几十甚至好几百的冤枉钱。</p><p>Q: 我已经注册账号了，怎么入门？</p><p>A: 开始入门 AWS 的时候，非常不建议大家使用 AWS management console。图形界面上的操作很不利于学习和总结，往往是做了一系列复杂的操作之后，自己都把自己绕晕了，下次做相同的事情，不看文档还是不知道怎么做。最好的入门是使用 AWS CLI 和 AWS SDK。比如要学习 S3，那就尝试着使用 AWS CLI 创建 bucket，给 bucket 设置权限，添加文件，删除文件等。然后同样的事情再用 SDK 尝试一下。AWS SDK 的文档并不是十分清晰，所以先从 CLI 入手理解概念会有助于你使用 SDK。</p><p>Q: saws 是个什么鬼？</p><p>A: saws 是个 AWS CLI 的辅助工具。你可以在 github 上找到这个工具的源代码和使用说明。它为 AWS CLI 加入了有限的 auto completion，使用起来方便多了。在 AWS re:invent 2015 上，Amazon 也宣布他们会提供类似的，更加强大的 CLI 工具。在此之前，saws 是最好的 CLI 选择。</p><p>Q: 有什么好的书籍资料么？</p><p>A: 我暂时也没有找到好的书籍资料，最全面但也是最原始的资料来自于 AWS 的官方文档和官方 blog。建议遇到问题的时候 google / stackoverflow，还解决不了可以咨询程序君 —— 如果问题本身能够戳中程序君使其愿意花时间研究。:)</p><p>Q: 怎么不介绍阿里云，这么推销 AWS，你是不是收了广告费？</p><p>A: 阿里云虽然很有潜力，但目前和 AWS 不在一个量级。Azure 我没有使用过，所以没有发言权。我喜欢 AWS，自己在大量使用，也希望把我学到的分享出来，促成我自己的二次学习，至于广告费嘛，我倒是真心希望 Amazon 能够给我点广告费，至少给我些 credit 涵盖我日常的 AWS 花费，或者赞助我的 AWS re:invent 的门票。</p><p>Q: 能不能介绍 AWS 和 Openstack 的异同？</p><p>A: 不能。没有调查就没有发言权。何况我目前没有深入研究 openstack 的动力。</p><p>Q: 中国区的 AWS 没有 cognito，如何在 IOS SDK 里面（通过 IAM）使用 DynamoDB？</p><p>A: 终于看到一个和 IAM 相关的问题，泪流满面。接下来我好好回答一下。</p><p>我没有遇见过类似的情况，所以斗胆建议两个 solution：</p><ul><li>创建一个 user，为其分配 DynamoDB 相关 table 的权限，并生成 AccessKey。在 IOS 的代码中，使用这个 user 访问 DynamoDB。</li><li>创建一个 user，没有任何权限，但是允许它 AssumeRole 到一个拥有 DynamoDB 相关 table 的 role 上面。使用这个 user 访问 DynamoDB。</li></ul><p>两种方式都不算太好，因为这个用户被写死在 IOS 的代码中。但既然问题的前提是无法使用 cognito，那么，在矮子里拔将军，我们选后一个 solution。因为，通过 AssumeRole 和 STS (Security Token Service) 产生临时的可以访问 DynamoDB 的 AccessKey 和 Session，更安全一些，也能够一定程度辨识用户（通过 SessionToken）。</p><p>首先我们需要创建一个 Role，允许其执行 sts:AssumeRole，这个 role 的 policy 如下：</p><img src="https://pic4.zhimg.com/ae1f2a07716f1935bdb0daf3459e5e0b_r.png" data-rawwidth="546" data-rawheight="268"><p>接下来创建这个 role：</p><img src="https://pic4.zhimg.com/d93bcdec500a26049b3a987c4b2a5edb_r.png" data-rawwidth="1021" data-rawheight="492"><p>现在这个 role 允许 tyr 这个用户去获取临时 token，提升权限，获得 role 中的权限 tyr。然而，这个 role 本身尚无任何权限，按照问题的描述，我们给这个 role 创建一个 policy，可以访问 DynamoDB 中的 table assume-role-test：</p><img src="https://pic3.zhimg.com/c69e919cfbcac2d8cae494af7da55775_r.png" data-rawwidth="854" data-rawheight="225"><p>我们把这个 policy attach到 刚才创建的 role 里：</p><img src="https://pic4.zhimg.com/2d632a756e86ac9f22e3b0646b5bc000_r.png" data-rawwidth="1203" data-rawheight="355"><p>我们假设已经有一个没有任何权限的 user 叫 tyr，对于这个 user，我们需要允许其访问放在创建的 role，所以要创建一个 policy 并将其 attach 到 tyr 身上：</p><img src="https://pic4.zhimg.com/c19b77756e164c7e8591da30e6dc8d7f_r.png" data-rawwidth="637" data-rawheight="224"><img src="https://pic1.zhimg.com/19bcdeca8e6dfe28f34d4aa291adefec_r.png" data-rawwidth="1121" data-rawheight="363"><p>这样，在 AWS SDK 中就可以使用 tyr 的 AccessKey 来访问 STS，提升权限，获得临时的 AccessKey，然后访问 DynamoDB。为简便起见，下面的代码使用 nodejs：</p><img src="https://pic1.zhimg.com/82f00b1e32cc58dc5efcaf309acd4bab_r.png" data-rawwidth="625" data-rawheight="887"><p>执行结果：</p><img src="https://pic3.zhimg.com/78ba13d5d3294bc5b6ac59fe71f3dd6a_r.png" data-rawwidth="1357" data-rawheight="239"><p>我们看到，AssumeRole 为你创建了一个临时的 user，其 ARN 包含你在代码中指定的 RoleSessionName。对于不同的 IOS 客户端，你可以使用不同的名字，这样，即便你没有一套用户账号体系，也可以在后台分辨出不同的用户行为。如果你使用第一种方案，所有的访问都来自于用户 tyr，便无从分辨了。</p><p>相关的 policy document 和代码可以访问：<a href="https://github.com/tyrchen/assumeRole%E3%80%82" data-editable="true" data-title="https://github.com/tyrchen/assumeRole。">https://github.com/tyrchen/assumeRole。</a></p><p>IOS 的处理可以以此类推。</p><p>如果您觉得这篇文章不错，请点赞。多谢！</p><p>欢迎订阅公众号『程序人生』（搜索微信号 programmer_life）。每篇文章都力求原汁原味，北京时间中午12点左右，美西时间下午8点左右与您相会。</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
