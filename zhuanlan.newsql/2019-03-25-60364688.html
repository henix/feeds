<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>DM 源码阅读系列文章（二）整体架构介绍</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/60364688">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-64291d80dfd671d9f228c3b60168dc6b_b.jpg" alt=""></div><p>作者：张学程</p><p>本文为 DM 源码阅读系列文章的第二篇，<a href="https://zhuanlan.zhihu.com/p/59792129" class="internal">第一篇文章</a> 简单介绍了 DM 源码阅读的目的和规划，以及 DM 的源码结构以及工具链。从本篇文章开始，我们会正式开始阅读 DM 的源码。</p><p>本篇文章主要介绍 DM 的整体架构，包括 DM 有哪些组件、各组件分别实现什么功能、组件之间交互的数据模型和 RPC 实现。</p><h2>整体架构</h2><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-b805930cc05983c17b93042ade7332d8_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="464" class="origin_image zh-lightbox-thumb" width="939" data-original="https://pic1.zhimg.com/v2-b805930cc05983c17b93042ade7332d8_r.jpg"></noscript><img src="https://pic1.zhimg.com/v2-b805930cc05983c17b93042ade7332d8_b.jpg" data-caption="" data-size="normal" data-rawwidth="939" data-rawheight="464" class="origin_image zh-lightbox-thumb lazy" width="939" data-original="https://pic1.zhimg.com/v2-b805930cc05983c17b93042ade7332d8_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-b805930cc05983c17b93042ade7332d8_b.jpg"></figure><p>通过上面的 DM 架构图，我们可以看出，除上下游数据库及 Prometheus 监控组件外，DM 自身有 DM-master、DM-worker 及 dmctl 这 3 个组件。其中，DM-master 负责管理和调度数据同步任务的各项操作，DM-worker 负责执行具体的数据同步任务，dmctl 提供用于管理 DM 集群与数据同步任务的各项命令。</p><h2>DM-master</h2><p>DM-master 的入口代码在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/cmd/dm-master/main.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">cmd/dm-master/main.go</a></code>，其中主要操作包括：</p><ol><li>调用 <code>cfg.Parse</code> 解析命令行参数与参数配置文件</li><li>调用 <code>log.SetLevelByString</code> 设置进程的 log 输出级别</li><li>调用 <code>signal.Notify</code> 注册系统 signal 通知，用于接受到指定信号时退出进程等</li><li>调用 <code>server.Start</code> 启动 RPC server，用于响应来自 dmctl 与 DM-worker 的请求</li></ol><p>在上面的操作中，可以看出其中最关键的是步骤 4，其对应的实现代码在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/master/server.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/master/server.go</a></code> 中，其核心为 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/master/server.go%23L46" class=" wrap external" target="_blank" rel="nofollow noreferrer">Server</a></code> 这个 struct，其中的主要 fields 包括：</p><ul><li><code>rootLis, svr</code>：监听网络连接，分发 RPC 请求给对应的 handler。</li><li><code>workerClients</code>：维护集群各 DM-worker ID 到对应的 RPC client 的映射关系。</li><li><code>taskWorkers</code>：维护用于执行各同步（子）任务的 DM-worker ID 列表。</li><li><code>lockKeeper</code>：管理在协调处理 sharding DDL 时的 lock 信息。</li><li><code>sqlOperatorHolder</code>：管理手动 skip/replace 指定 sharding DDL 时的 SQL operator 信息。</li></ul><p>在本篇文章中，我们暂时不会关注 <code>lockKeeper</code> 与 <code>sqlOperatorHolder</code>，其具体的功能与代码实现会在后续相关文章中进行介绍。</p><p>在 DM-master Server 的入口方法 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/master/server.go%23L82" class=" wrap external" target="_blank" rel="nofollow noreferrer">Start</a></code> 中：</p><ol><li>通过 <code>net.Listen</code> 初始化 <code>rootLis</code> 并用于监听 TCP 连接（借助 <a href="http://link.zhihu.com/?target=https%3A//github.com/soheilhy/cmux" class=" wrap external" target="_blank" rel="nofollow noreferrer">soheilhy/cmux</a>，我们在同一个 port 同时提供 gRPC 与 HTTP 服务）。</li><li>根据读取的配置信息（<code>DeployMap</code>），初始化用于连接到各 DM-worker 的 RPC client 并保存在 <code>workerClients</code> 中。</li><li>通过 <code>pb.RegisterMasterServer</code> 注册 gRPC server（<code>svr</code>），并将该 <code>Server</code> 作为各 services 的 implementation。</li><li>调用 <code>m.Serve</code> 开始提供服务。</li></ol><p>DM-master 提供的 RPC 服务包括 DM 集群管理、同步任务管理等，对应的 service 以 Protocol Buffers 格式定义在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/proto/dmmaster.proto" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/proto/dmmaster.proto</a></code> 中，对应的 generated 代码在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/pb/dmmaster.pb.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/pb/dmmaster.pb.go</a></code> 中。各 service 的具体实现在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/master/server.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/master/server.go</a></code> 中（<code>*Server</code>）。</p><h2>DM-worker</h2><p>DM-worker 的结构与 DM-master 类似，其入口代码在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/cmd/dm-worker/main.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">cmd/dm-worker/main.go</a></code> 中。各 RPC services 的 Protocol Buffers 格式定义在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/proto/dmworker.proto" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/proto/dmworker.proto</a></code> 中，对应的 generated 代码在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/pb/dmworker.pb.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/pb/dmworker.pb.go</a></code> 中，对应的实现代码在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/worker/server.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/worker/server.go</a></code> 中（<code>*Server</code>）。DM-worker 的启动流程与 DM-master 类似，在此不再额外说明。</p><p><code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/worker/server.go%23L42" class=" wrap external" target="_blank" rel="nofollow noreferrer">Server</a></code> 这个 struct 的主要 fields 除用于处理 RPC 的 <code>rootLis</code> 与 <code>svr</code> 外，另一个是用于管理同步任务与 relay log 的 <code>worker</code>（相关代码在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/worker/worker.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/worker/worker.go</a></code> 中）。</p><p>在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/worker/worker.go%23L43" class=" wrap external" target="_blank" rel="nofollow noreferrer">Worker</a></code> 这个 struct 中，主要 fields 包括：</p><ul><li><code>subTasks</code>：维护该 DM-worker 上的所有同步子任务信息。</li><li><code>relayHolder</code>：对 relay 处理单元相关操作进行简单封装，转发相关操作请求给 relay 处理单元，获取 relay 处理单元的状态信息。</li><li><code>relayPurger</code>：根据用户配置及相关策略，尝试定期对 relay log 进行 purge 操作。</li></ul><p>数据同步子任务管理的代码实现主要在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/worker/subtask.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/worker/subtask.go</a></code> 中， relay 处理单元管理的代码实现主要在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/worker/relay.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/worker/relay.go</a></code> 中，对 relay log 进行 purge 操作的代码实现主要在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/relay/purger/" class=" wrap external" target="_blank" rel="nofollow noreferrer">relay/purger</a></code> pkg 中。在本篇文章中，我们暂时只关注 DM 架构相关的实现，上述各功能的具体实现将在后续的相关文章中展开介绍。</p><p><code>Worker</code> 的入口方法为 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/worker/worker.go%23L93" class=" wrap external" target="_blank" rel="nofollow noreferrer">Start</a></code>，其中的主要操作包括：</p><ol><li>通过 <code>w.relayHolder.Start</code> 启动 relay 处理单元，开始从上游拉取 binlog。</li><li>通过 <code>w.relayPurger.Start</code> 启动后台 purge 线程，尝试对 relay log 进行定期 purge。</li></ol><p>其他的操作主要还包括处理 <code>Server</code> 转发而来的同步任务管理、relay 处理单元管理、状态信息查询等。</p><h2>dmctl</h2><p>dmctl 的入口代码在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/cmd/dm-ctl/main.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">cmd/dm-ctl/main.go</a></code>，其操作除参数解析与 signal 处理外，主要为调用 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/cmd/dm-ctl/main.go%23L83" class=" wrap external" target="_blank" rel="nofollow noreferrer">loop</a></code> 进入命令处理循环、等待用户输入操作命令。</p><p>在 <code>loop</code> 中，我们借助 <a href="http://link.zhihu.com/?target=https%3A//github.com/chzyer/readline" class=" wrap external" target="_blank" rel="nofollow noreferrer">chzyer/readline</a> 提供命令行交互环境，读取用户输入的命令并输出命令执行结果。一个命令的处理流程为：</p><ol><li>调用 <code>l.Readline</code> 读取用户输入的命令</li><li>判断是否需要退出命令行交互环境（exit 命令）或需要进行处理</li><li>调用 <code>ctl.Start</code> 进行命令分发与处理</li></ol><p>dmctl 的具体命令处理实现在 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/ctl/" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/ctl</a></code> pkg 中，入口为 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/ctl/ctl.go" class=" wrap external" target="_blank" rel="nofollow noreferrer">dm/ctl/ctl.go</a></code> 中的 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/ctl/ctl.go%23L46" class=" wrap external" target="_blank" rel="nofollow noreferrer">Start</a></code> 方法，命令的分发与参数解析借助于 <a href="http://link.zhihu.com/?target=https%3A//github.com/spf13/cobra" class=" wrap external" target="_blank" rel="nofollow noreferrer">spf13/cobra</a>。命令的具体功能实现在相应的子 pkg 中：</p><ul><li><code>master</code>：dmctl 与 DM-master 交互的命令，是当前 DM 推荐的命令交互方式。</li><li><code>worker</code>：dmctl 与 DM-worker 交互的命令，主要用于开发过程中进行 debug，当前并没有实现所有 DM-worker 支持的命令，未来可能废弃。</li><li><code>common</code>：多个命令依赖的通用操作及 dmctl 依赖的配置信息等。</li></ul><p>每个 dmctl 命令，其主要对应的实现包括 3 个部分：</p><ol><li>在各命令对应的实现源文件中，通过 <code>New***Cmd</code> 形式的方法创建 <code>cobra.Command</code> 对象。</li><li>在 <code>dm/ctl/ctl.go</code> 中通过调用 <code>rootCmd.AddCommand</code> 添加该命令。</li><li>在各命令对应的实现源文件中，通过 <code>***Func</code> 形式的方法实现参数验证、RPC 调用等具体功能。</li></ol><h2>任务管理调用链示例</h2><p>让我们用一个启动数据同步任务的操作示例来说明 DM 中的组件交互与 RPC 调用流程。</p><ol><li>用户在 dmctl 命令行交互环境中输入 start-task 命令及相应参数。</li><li>dmctl 在 <code>dm/ctl/ctl.go</code> 的 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/ctl/ctl.go%23L46" class=" wrap external" target="_blank" rel="nofollow noreferrer">Start</a></code> 方法中进行命令分发，请求 <code>dm/ctl/master/start_task.go</code> 中的 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/ctl/master/start_task.go%23L39" class=" wrap external" target="_blank" rel="nofollow noreferrer">startTaskFunc</a></code> 处理命令。</li><li><code>startTaskFunc</code> 通过 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/ctl/master/start_task.go%23L61" class=" wrap external" target="_blank" rel="nofollow noreferrer">cli.StartTask</a></code> 调用 DM-master 上的 RPC 方法。</li><li>DM-master 中的 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/master/server.go%23L182" class=" wrap external" target="_blank" rel="nofollow noreferrer">Server.StartTask</a></code> 方法（<code>dm/master/server.go</code>）响应来自 dmctl 的 RPC 请求。</li><li><code>Server.Start</code> 从 <code>workerClients</code> 中获取任务对应 DM-worker 的 RPC client，并通过 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/master/server.go%23L243" class=" wrap external" target="_blank" rel="nofollow noreferrer">cli.StartSubTask</a></code> 调用 DM-worker 上的 RPC 方法。</li><li>DM-worker 中的 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/worker/server.go%23L139" class=" wrap external" target="_blank" rel="nofollow noreferrer">Server.StartSubTask</a></code> 方法（<code>dm/worker/server.go</code>）响应来自 DM-master 的 RPC 请求。</li><li><code>Server.StartSubTask</code> 中将任务管理请求转发给 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/worker/worker.go%23L144" class=" wrap external" target="_blank" rel="nofollow noreferrer">Worker.StartSubTask</a></code>（<code>dm/worker/worker.go</code>），并将处理结果通过 RPC 返回给 DM-master。</li><li>DM-master 将 DM-worker 返回的 RPC 响应重新封装后通过 RPC 返回给 dmctl。</li><li>dmctl 通过 <code><a href="http://link.zhihu.com/?target=https%3A//github.com/pingcap/dm/blob/3fcf24daa5/dm/ctl/common/util.go%23L69" class=" wrap external" target="_blank" rel="nofollow noreferrer">common.PrettyPrintResponse</a></code> 输出命令操作的 RPC 响应。</li></ol><h2>小结</h2><p>在本篇文章中，我们主要介绍了 DM 的各个组件的入口函数，最后以 dmctl 的 start-task 为例介绍了交互的调用流程细节。下一篇文章我们会开始介绍 DM-worker 组件内各数据同步处理单元（relay-unit, dump-unit, load-unit, sync-unit）的设计原理与具体实现。</p><p><b>更多阅读：</b></p><a href="http://link.zhihu.com/?target=https%3A//www.pingcap.com/blog-cn/%23DM-%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB" data-draft-node="block" data-draft-type="link-card" data-image="https://pic2.zhimg.com/v2-60ab5bd867c2434d70c957a02a2169e1_ipico.jpg" data-image-width="1200" data-image-height="1200" class=" wrap external" target="_blank" rel="nofollow noreferrer">博客</a><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
</body>
</html>
