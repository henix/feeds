<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>H1-212 CTF writeup</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/31386355">原文</a></p>
<div class="title-image"><img src="https://pic1.zhimg.com/v2-5b18cdd62aeead010f1748e71463bf10_r.png" alt=""></div><h2><b>题目介绍</b></h2><p>acme.org 的工程师在 https://104.236.20.43/ 上推出了新管理面板的新服务器。他坚信他的服务器不会被黑客攻击。他在里面设置了一个“机关”，一旦 flag 文件被读取他就会知道。他也提到 apache 的默认页面也在那儿，不过是他有意为之并无什么特殊意义。你的目标是什么呢？得到 flag !</p><p>Time to hack!</p><img src="https://pic4.zhimg.com/v2-e591ed7a8f94dfb1a2de49bc7048491b_r.gif" data-caption="" data-size="normal" data-rawwidth="320" data-rawheight="240" data-thumbnail="https://pic4.zhimg.com/v2-e591ed7a8f94dfb1a2de49bc7048491b_b.jpg"><h2><b>目标侦查 </b></h2><p>在真正攻击之前，我首先是尽可能多的收集关于目标的信息。这些步骤包括对主机运行一些简单的命令，像 host 、 dig 、nslookup 等。然后，我在 shodan 上搜索了 Ip，使用了一些 google 搜索语法，尝试了 DNS 反向域名查找，构成了我信息收集的过程。不出所料，果然开放了 22 和 80 端口。而此时我正在进行被动侦查阶段，并记录下我的发现。</p><p>现在是时候与主机直接交互了。我在 nmap 上展开了完整的 TCP 扫描以确定是否有其他端口开放，结果证明只开放了 22 和 80 端口。在扫描过程中，我浏览了这个网站，发现了有名的 apache 默认页面，但是正如 acme.org 的工程师提到的，这是故意的并无其它含义。另外，主机还泄露了 web 服务器的版本：apache v2.4.18，并且运行在 Ubuntu 的发行版本上。为了最精彩的部分，我仔细阅读了 apache 默认页面，企图找到蛛丝马迹，但都无济于事。</p><h2><b>打破常规 </b></h2><p>为了这个得到 flag，我打算穷尽自己储备的知识并进行不懈的尝试！如果你不敢打破常规、大胆尝试，那你还算是个黑客吗？</p><img src="https://pic1.zhimg.com/v2-35950b06117f82535ef577f0d80cc9f0_r.jpg" data-caption="" data-size="normal" data-rawwidth="800" data-rawheight="533"><p><a href="https://twitter.com/jobertabma/status/930273559946989569">Jobert 的话</a> 引起了我的注意：CTF 中爆破服务器并不是解决问题的关键。</p><blockquote>大约12小时前，我们推出了一场CTF，为了赢得H1-212（NYC）12月份的入场券，与全球顶尖的黑客切磋。从那时起，34,921,283个请求发送到服务器。但只有两个人解决了这个问题。<b>也许暴力破解不是解决问题的关键</b>。</blockquote><p>虽然不抱任何希望，我还是决定使用 burpsuite 的 intruder 模块跑几个字典试试。其中一个字典是我用 ceWL 自定义生成的。CTF 中我大多数情况见到是文件和目录名都被隐藏在主页里面。</p><p>在发送了几千个 HTTP 请求之后，唯一发现的是 /flag 这个目录。在看到文件内容之前我猜想，不出意外里面可能是：</p><blockquote>真的认为有这么简单吗？继续挖掘吧！</blockquote><h2><b>改变战略</b></h2><blockquote>疯狂就是一遍又一遍地做同样的事情，却期待着不同的结果。</blockquote><p>此刻，我感觉自己什么也做不了。运行自动化工具可能也不会有任何发现。以我过去 CTF 的经验来看，题目的描述内容或许隐藏着线索。当我重读题目后发现了这么几个问题:</p><p>1. 为什么要提到 acme.org ？</p><p>2. 这和真实的域名 acme.org 有何联系？</p><p>3. 难道服务器是运行在指向 acme.org 的虚拟主机上？</p><p>4. 为什么他们要提到一个 admin panel ？</p><p>5. 这儿有个叫 admin.acme.org 的虚拟主机？</p><p>现在是时候揭晓答案了。</p><h2><b>虚拟主机发现</b></h2><p>这里我打算编写一个快速的脚本来枚举虚拟主机，但当我想起了Jobert的<a href="https://github.com/jobertabma/virtual-host-discovery">虚拟主机扫描</a>工具，我又确保添加了 104.236.20.43 到 /etc/hosts 中，关键字 admin 就在这款工具的字典列表里并且可以触发它。</p><img src="https://pic1.zhimg.com/v2-8d3e30043cba9e16c554ab065e7e7b9a_r.jpg" data-caption="" data-size="normal" data-rawwidth="876" data-rawheight="70"><h2><b>Admin panel</b></h2><p>正如所料，虚拟主机的发现结果变得有意思了，虚拟主机 admin.acme.org 存在并且分配给你一个奇怪的 cookie: admin=no 。</p><img src="https://pic3.zhimg.com/v2-482deb6775ef62872b7f57b7628f8bcf_r.jpg" data-caption="" data-size="normal" data-rawwidth="628" data-rawheight="331"><p>正如每个人都会做的一样，我把请求发送到了 repeater ，将 admin=no 改为 admin=yes 。我知道不会这么简单，但是服务器返回了一个 405 Method Not Allowed 。</p><img src="https://pic4.zhimg.com/v2-ff3a99309b78355e80301f57aaf368e5_r.jpg" data-caption="" data-size="normal" data-rawwidth="584" data-rawheight="210"><p>显然，服务器并不支持我的 HTTP GET 请求，那为什么不用一个空的 body 来发送一个 POST 请求呢？此刻，事情就变得有趣了。服务器响应了一个 406 Not Acceptable 错误。</p><img src="https://pic2.zhimg.com/v2-ed734611c54a75e80866b35aa24d7e7e_r.jpg" data-caption="" data-size="normal" data-rawwidth="1262" data-rawheight="273"><p>将 cookie 从 admin=yes 转换回 admin=no ，并发送同样的 POST 请求会得到一个 200 OK 的响应。</p><img src="https://pic1.zhimg.com/v2-c1d94a40954191d601324218d040fca3_r.jpg" data-caption="" data-size="normal" data-rawwidth="1262" data-rawheight="268"><p>奇怪的行为。经过一番在线搜索后我发现了 406 Not Acceptable:</p><blockquote>根据请求中接收到的主动协商报头字段，目标资源不具有用户代理可接受的当前表示，并且服务器不愿意提供默认表示。<br>来源：<a href="https://httpstatuses.com/406">httpstatuses</a> </blockquote><p>我打算用大量不同的值通过 intruder 来 fuzz User-Agent 和 Accept 请求头，但是响应包的大小并没有改变。尽管我也向 <a href="https://admin.acme.org/">https://admin.acme.org/</a> 发送 POST 请求，然而并没有发现其路径下的任何文件。 emmmmm，PHP 可以运行吗？</p><p>就是 PHP ！我向 /index.php 发送了 HTTP 请求。</p><img src="https://pic1.zhimg.com/v2-93d2770951b030135d7615965b5ffdb0_r.jpg" data-caption="" data-size="normal" data-rawwidth="1264" data-rawheight="271"><h2><b>缺失的请求头</b></h2><img src="https://pic2.zhimg.com/v2-6d89c1171cdfad78fe2517a0224f8c57_r.jpg" data-caption="" data-size="normal" data-rawwidth="1262" data-rawheight="294"><p>看到来自服务器的 418 I’m a teapot 响应了吗？太奇怪了，我花了数个小时来弄懂它的意图，并向<br><a href="https://tools.ietf.org/html/rfc2324">HTCPCP </a>发送了几种不同的请求。我决定将关注点放在原始的 POST 请求上并仔细分析。</p><p>看着这个请求头，我认为这儿好像有什么东西缺失了。实际上，这里是缺了 Content-Type 头。尝试了 application/xml、application/php、text/plain 和 text/html 这几种 MIME 类型之后，我得到了一个 application.json 类型的响应。</p><code lang="text">{"error":{"body":"unable to decode"}}</code><p>上面的错误表明应用需要一个 json 格式的 body ，发送 body 内容为{}的请求，得到如下的结果</p><code lang="text">{"error":{"domain":"required"}} 。</code><img src="https://pic1.zhimg.com/v2-df3cea886423c5f7da9f0d9f9aeb1ce4_r.jpg" data-caption="" data-size="normal" data-rawwidth="1265" data-rawheight="334"><p>看来需要一个 domain参数，将 body 从 {} 改为 {"domain":"test123"}，这次产生了不同的错误：</p><code lang="text">{"error":{"domain":"incorrect value, .com domain expected"}}</code><img src="https://pic2.zhimg.com/v2-6ebb731104e969c34c64d285c7c14925_r.jpg" data-caption="" data-size="normal" data-rawwidth="1263" data-rawheight="341"><p>期望一个 “.com” 形式的域名。改为 test.com 产生同样的错误。尝试了不同的组合之后发现 <a href="http://www.test123.com/">www.test123.com</a> 得到了不同的响应：</p><code lang="text">{"error":{"domain":"incorrect value, sub domain should contain 212"}}</code><img src="https://pic2.zhimg.com/v2-3ee54c5ca5f3da72a816087d8d4ce1d6_r.jpg" data-caption="" data-size="normal" data-rawwidth="1294" data-rawheight="335"><h2><b>神秘的数字</b></h2><p>所以，子域名必须要包含数字 212 。最后尝试 212.test123.com 终于得到了有用响应：</p><code lang="text">{"next":"\/read.php?id=0"}</code><img src="https://pic4.zhimg.com/v2-92e5787950556dcf8edb872bcfee3b06_r.jpg" data-caption="" data-size="normal" data-rawwidth="1261" data-rawheight="338"><p>向 /read.php?id=0 发送 GET 请求，返回：{"data":"}</p><img src="https://pic4.zhimg.com/v2-8b6bb1f34fd3e0d5859b5fc061e0f257_r.jpg" data-caption="" data-size="normal" data-rawwidth="1262" data-rawheight="275"><p>将 id 增加 1 ，得到相同的结果：{"data":"}，当id 大于等于2时，得到如下的错误：</p><code lang="text">{"error":{"row":"incorrect row"}}</code><img src="https://pic3.zhimg.com/v2-00a9f9287cc383b4cfe25545e634cbaf_r.jpg" data-caption="" data-size="normal" data-rawwidth="1264" data-rawheight="271"><p>向 index.php 发送更多的请求 id 值就会依次加 1 。</p><p>接下来的思路是 SSRF 。怎样确定服务器会验证我提供的域名呢？出于好奇，我打算用真实存在的域名来测试。</p><p>我使用简单的 google 语法 ：site:212.*.com 找到了 212.huelectricbike.com 这个域名。</p><p>这次我用新找到的域名：212.huelectricbike.com 向 /index.php 发送 POST 请求。</p><p>令我大吃一惊的是：使用新生成的 id 回到 /read.php 页面，竟然出现了一大串 base64 加密的数据。</p><code lang="text">{"data":"PCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBYSFRNTCAxLjAgVHJhbnNpdGlvbmFsLy9FTiIKICAgICAgICAiaHR..."}</code><img src="https://pic3.zhimg.com/v2-b2c92c288d96b9f9e5acd341baf7fe3b_r.jpg" data-caption="" data-size="normal" data-rawwidth="1293" data-rawheight="377"><p>解码发现这些数据正是 212.huelectricbike.com 主页的源代码：</p><code lang="text">base64 -d &lt;&lt;&lt; PCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBYSFRNTCAxLjAgVHJhbnNpdGlvbmFsLy9FTiIKICAgICAgICAiaHR...</code><img src="https://pic2.zhimg.com/v2-66da5b17c1a656c00341416bda88d5fc_r.jpg" data-caption="" data-size="normal" data-rawwidth="1223" data-rawheight="252"><h2><b>深入挖掘</b></h2><p>目前为止，我所得到信息有：</p><p>1. 212.*.com 站点对应用程序是有用的；</p><p>2. 该应用返回了网站的源码 ；</p><p>3. 应用对源码采用了 base64 加密；</p><p>4. 应用程序使用会随着每次请求而递增的 id 将加密后的数据存储在一种特殊的文件或数据库中；</p><p>5. 向 /index.php?id=ID_HERE 发送 GET 请求是有机会看到加密值的；</p><p>6. Id 似乎是为特定 用户生成的，意味着我不能查看别的用后存储的数据，这通过使用不同的 ip 测试得出的；</p><p>7. 应用程序似乎有某种正则机制来过滤一些模式和字符。</p><p>现在是时候来绕过这些过滤了，在测试了 \ / = - @ . % { } [ ] 这几个字符后，我发现 % 会在域名中被过滤掉：</p><code lang="text">Request body:
{"domain":"212.huelectricbike%.com.com"}
Response:
{"error":{"domain":"domain cannot contain %"}} </code><img src="https://pic1.zhimg.com/v2-38ff680810eefb936ed5ce8e3cb6f8ed_r.jpg" data-caption="" data-size="normal" data-rawwidth="1264" data-rawheight="346"><p>尝试了几种不同的绕过之后，我考虑到了未编码的 CRLF 注入，因为应用只是过滤了 % 而没有过滤 \ 。</p><h2><b>Let's Play Fetch</b></h2><p>如果我能用 CRLF 注入绕过过滤并强制应用程序从<a href="https://0xc0ffee.io/">我自己的域</a>返回数据，那会怎么样呢？如果我能成功绕过过滤，我就可以向本地主机发送请求从而得到更多的信息。</p><p>在使用我自己的域之前，如果对这个站点进行 CRLF 注入会怎样呢？</p><code lang="text">Request Body:
{"domain":"\r\n212.huelectricbike.com"} 
Response:
{"next":"\/read.php?id=9"} </code><img src="https://pic2.zhimg.com/v2-4ae52cde4e0b5d366ccd0d45af1c2aa0_r.jpg" data-caption="" data-size="normal" data-rawwidth="1264" data-rawheight="340"><p>Id 从7 到 9 递增了2！我太激动了！这说明发送了2个请求而不是一个。接下来是绕过域名里必需神秘数字 212 。</p><p>经过多次失败的尝试，我发现可以绕过程序限定的 212 和.com ,并且意识到其实不需要回车符：</p><code lang="text">Request body:
{"domain":"212\n0xc0ffee.io\n.com"} 
Response:
{"next":"\/read.php?id=15"} </code><p>漂亮的 GET 请求从目标主机发送到了我自己的服务器上：</p><img src="https://pic4.zhimg.com/v2-141b99b4407472737b4323677e6b97d2_r.jpg" data-caption="" data-size="normal" data-rawwidth="639" data-rawheight="37"><p>并且真的返回了主页的源码。这次 id 递增了3，因为应用程序接受了三个请求（212，0xc0ffee.io，.com），显然这次的请求更加吸引我。</p><img src="https://pic1.zhimg.com/v2-68faca0ae020742fc32034e22f4e9627_r.jpg" data-caption="" data-size="normal" data-rawwidth="1299" data-rawheight="562"><p>实际发生了什么：</p><p>1. 212 被程序执行了，也就是换行符被解析执行了；</p><p>2. 0xc0ffee.io<br>也被程序执行了，换行符被执行了；</p><p>3. .com 也被执行了。</p><h2><b>躲猫猫</b></h2><p>好了，那么 flag 藏在哪儿了呢？正如之前说过的，如果可以绕过过滤那么就能获得来自本地主机的数据。</p><p>发送如下的请求不会得到有用的响应：</p><code lang="text">Request body: {"domain":"212\nlocalhost\n.com"}
Response:
{"error":{"domain":"incorrect value, .com domain
expected"}} </code><p>然而，过会儿我发现，我所需要的只是在 localhost 旁加一个点：</p><code lang="text">Request body:
{"domain":"212\nlocalhost.\n.com"} 
Response:
{"next":"\/read.php?id=21"}</code><img src="https://pic3.zhimg.com/v2-3e516f680a16f504323ff93bc034d538_r.jpg" data-caption="" data-size="normal" data-rawwidth="1329" data-rawheight="675"><p>正如上图所示，请求了Localhost:80 并返回 web 服务器的主页。为了确认一下，我发送了 /flag 请求却得到了这个臭名昭著的响应：</p><blockquote>You really thought it would be that easy? Keep digging!</blockquote><p>Emmmm，好吧，我知道 SSH 端口是开放的虽然不能建立连接，但我可以抓取 banner 信息呀：</p><code lang="text">Request:
{"domain":"212\nlocalhost.:22\n.com"} Notice the :22 next
to .localhost? 
Response: {"next":"\/read.php?id=27"} </code><img src="https://pic1.zhimg.com/v2-9f8212451d24be23cadd6853e9fc3e69_r.jpg" data-caption="" data-size="normal" data-rawwidth="1296" data-rawheight="422"><p>太棒了，我可以进行端口扫描。有没有开放内部端口呢？是时候打开 intruder 了，我快速生成了一个 0-65535 的数字列表：seq 65535&gt; port.txt</p><img src="https://pic3.zhimg.com/v2-0cba25630eeadbf25f144cfb237d7a51_r.jpg" data-caption="" data-size="normal" data-rawwidth="1303" data-rawheight="464"><img src="https://pic1.zhimg.com/v2-da08f40e7a00f5b13ccb89e39a61f6c3_r.jpg" data-caption="" data-size="normal" data-rawwidth="867" data-rawheight="433"><p>在 194-200（除了22-80）响应长度都是相同的，我需要再次运行 intruder 但这次针对 read.php?id=ID_HERE 。</p><p>每个空的响应 {"data":""} 都有 178 个字节，但这里出现了一个210 字节长的响应并且 数据还被 bease64 加密了的：</p><img src="https://pic3.zhimg.com/v2-7792d5afe45acf764e6019098d8af562_r.jpg" data-caption="" data-size="normal" data-rawwidth="772" data-rawheight="176"><img src="https://pic4.zhimg.com/v2-e8866ab39d05d86972d77319fd049485_r.jpg" data-caption="" data-size="normal" data-rawwidth="712" data-rawheight="322"><p>哇，一些内部 HTTP 端口是开放的，现在我需要用得到的正确 id 去连接正确的端口。</p><p>当 intruder 向 localhost:1337 发送请求时分配给我的 id 是 2653 。</p><h2>问题的结尾</h2><p>目前获得信息是：</p><p>1. 内部 HTTP 服务器 监听着 1337端口；</p><p>2. 主页显示：Hmm, where would it be?</p><p>歪，为什么不试试 /flag ，可能在这儿，对吗？</p><p>请求 body: {"domain":"212\nlocalhost.:1337/flag\n.com"}</p><img src="https://pic3.zhimg.com/v2-0d2ff566803e2900cb9b2f770094eb9c_r.jpg" data-caption="" data-size="normal" data-rawwidth="624" data-rawheight="574"><p>在这儿呢：</p><code lang="text">FLAG: 
CF,2dsV\/]fRAYQ.TDEp`w"M(%mU;p9+9FD{Z48X*Jtt{%vS($g7\S):f%=P[Y@nka=&lt;tqhnF&lt;aq=K5:BC@Sb*{[%z"+@yPb/nfFna&lt;e$hv{p8r2[vMMF52y:z/Dh;{6
</code><img src="https://pic4.zhimg.com/v2-db62433e049b6242c2429b219b2d175a_r.jpg" data-caption="" data-size="normal" data-rawwidth="800" data-rawheight="533"><h2><b>总结</b></h2><p>无论我能否赢得这场 NYC 之旅，这次的 CTF 都绝对是一次有趣的经历，我很感激自己能有这次练习的机会成为一个更好的 hacker 。我在这次 CTF 中学到的一点是永不放弃（事实上，喝咖啡的休息时间让我有了新思路），同时质疑应用程序中的每个功能。</p><p>很开心成为解决这个问题的少数黑客之一！</p><p>感谢HackerOne，Jobert Abma和在这个项目上努力工作的其他人。期待更多的挑战。</p><p><br></p><p>原文：https://0xc0ffee.io/writeups/h1-212/</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
