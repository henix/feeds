<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>【全新量化入门系列5】读取context中的数据与条件判断</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/40551631">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-e3cf2dc28861b63e284ec7c514c271a6_b.jpg" alt=""></div><p>本文是<a href="https://link.zhihu.com/?target=https%3A//www.joinquant.com/post/13149%3Ftag%3Dalgorithm" class=" wrap external" target="_blank" rel="nofollow noreferrer">《量化交易零基础入门教程》</a>中的第五篇，点击链接可查看该系列详情。</p><h2><b>摘要</b></h2><ul><li>context的含义</li><li>context的结构</li><li>context的读取方法</li><li>条件判断语句</li><li>止损的含义及其实现方法</li></ul><p class="ztext-empty-paragraph"><br/></p><p><b>前言</b></p><p>通过前文的讲解，我们已经能理解最开始的那个简单的策略例子，如下：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-7dea9eca92dee24359951457aaef2c6c_b.jpg" data-caption="" data-size="normal" data-rawwidth="562" data-rawheight="125" class="origin_image zh-lightbox-thumb" width="562" data-original="https://pic1.zhimg.com/v2-7dea9eca92dee24359951457aaef2c6c_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-7dea9eca92dee24359951457aaef2c6c_b.jpg" data-caption="" data-size="normal" data-rawwidth="562" data-rawheight="125" class="origin_image zh-lightbox-thumb lazy" width="562" data-original="https://pic1.zhimg.com/v2-7dea9eca92dee24359951457aaef2c6c_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-7dea9eca92dee24359951457aaef2c6c_b.jpg"/></figure><p>接下来，我们将在此基础上进行改进与举例，学习新内容。</p><p class="ztext-empty-paragraph"><br/></p><p><b>context的结构</b></p><p>context是一个回测系统建立的Context类型的对象，其中存储了如当前策略运行的时间点、所持有的股票、数量、持仓成本等数据。</p><p class="ztext-empty-paragraph"><br/></p><p>对象可以理解为特殊类型的变量，对象的结构往往比我们之前见过的list与dict更复杂，被定义好的对象是有名字的，比如context是一个变量，它的变量类型是一个Context类型的对象，就像dict包括key与value，Context类型的对象也包括很多属性，而且可以嵌套另一个种类型的对象，结构见下图。</p><p class="ztext-empty-paragraph"><br/></p><p>图中只包括了主要与常用的内容，详细介绍可以看API文档：Context对象。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-8da6d0c6b4617cff6ed169f5b85dc295_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="717" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic2.zhimg.com/v2-8da6d0c6b4617cff6ed169f5b85dc295_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-8da6d0c6b4617cff6ed169f5b85dc295_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="717" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic2.zhimg.com/v2-8da6d0c6b4617cff6ed169f5b85dc295_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-8da6d0c6b4617cff6ed169f5b85dc295_b.jpg"/></figure><p>关于对象的知识非常复杂繁多，目前我们只需学习如何取用context中的数据就好。</p><p class="ztext-empty-paragraph"><br/></p><p><b>context中的数据取用方法</b></p><p class="ztext-empty-paragraph"><br/></p><p>获取对象类型变量内包含的数据方法是用英文句号隔开，而当包含的是另一个对象时，只需在应用英文句号隔开即可，例子如下：</p><figure data-size="normal"><noscript><img src="https://pic4.zhimg.com/v2-0db0eb707df0e290424d3e6cef417d33_b.jpg" data-caption="" data-size="normal" data-rawwidth="623" data-rawheight="215" class="origin_image zh-lightbox-thumb" width="623" data-original="https://pic4.zhimg.com/v2-0db0eb707df0e290424d3e6cef417d33_r.jpg"/></noscript><img src="https://pic4.zhimg.com/v2-0db0eb707df0e290424d3e6cef417d33_b.jpg" data-caption="" data-size="normal" data-rawwidth="623" data-rawheight="215" class="origin_image zh-lightbox-thumb lazy" width="623" data-original="https://pic4.zhimg.com/v2-0db0eb707df0e290424d3e6cef417d33_r.jpg" data-actualsrc="https://pic4.zhimg.com/v2-0db0eb707df0e290424d3e6cef417d33_b.jpg"/></figure><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-5bcbd1b3fa15124919be015ec957d21a_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="723" class="origin_image zh-lightbox-thumb" width="1080" data-original="https://pic3.zhimg.com/v2-5bcbd1b3fa15124919be015ec957d21a_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-5bcbd1b3fa15124919be015ec957d21a_b.jpg" data-caption="" data-size="normal" data-rawwidth="1080" data-rawheight="723" class="origin_image zh-lightbox-thumb lazy" width="1080" data-original="https://pic3.zhimg.com/v2-5bcbd1b3fa15124919be015ec957d21a_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-5bcbd1b3fa15124919be015ec957d21a_b.jpg"/></figure><p>当要获取的对象内的数据是另一种有结构的变量类型时，比如dict或list，正常按照该变量类型进一步取用数据即可。例如context.portfolio.positions是一个dict，我们就可以应用之前讲过的dict 的用法来使用它，例子如下，这次给出了完整代码。</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-35f24575e13eee9747c4acf6e59971a9_b.jpg" data-caption="" data-size="normal" data-rawwidth="817" data-rawheight="381" class="origin_image zh-lightbox-thumb" width="817" data-original="https://pic2.zhimg.com/v2-35f24575e13eee9747c4acf6e59971a9_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-35f24575e13eee9747c4acf6e59971a9_b.jpg" data-caption="" data-size="normal" data-rawwidth="817" data-rawheight="381" class="origin_image zh-lightbox-thumb lazy" width="817" data-original="https://pic2.zhimg.com/v2-35f24575e13eee9747c4acf6e59971a9_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-35f24575e13eee9747c4acf6e59971a9_b.jpg"/></figure><p>常用的context数据写法如下，推荐自己试下。</p><p class="ztext-empty-paragraph"><br/></p><p><b>1. 当前时间 </b></p><p>context.current_dt</p><p><b>2. 当前时间的“年-月-日”的字符串格式 </b></p><p>context.current_dt.strftime(&#34;%Y-%m-%d&#34;)</p><p><b>3. 前一个交易日 </b></p><p>context.previous_date</p><p><b>4. 当前可用资金 </b></p><p>context.portfolio.avaliable_cash</p><p><b>5. 持仓价值 </b></p><p>context.portfolio.positions_value</p><p><b>6. 累计收益 </b></p><p>context.portfolio.returns</p><p><b>7. 当前持有股票 </b></p><p>context.portfolio.positions.keys()</p><p><b>8. 当前持有的某股票的开仓均价</b> context.portfolio.positions[&#39;xxxxxx.xxxx&#39;].avg_cost</p><p><b>9.当前持有的某股票的可卖持仓量</b>context.portfolio.positions[&#39;xxxxxx.xxxx&#39;].closeable_amount</p><p class="ztext-empty-paragraph"><br/></p><p><b>条件判断</b></p><p class="ztext-empty-paragraph"><br/></p><p>能够获取context的数据后，我们会考虑利用这些数据丰富策略的逻辑，但在此之前我们还要学习if条件判断语句，如下：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-456ccef041f857a4bae92acd8ad2f0d1_b.jpg" data-caption="" data-size="normal" data-rawwidth="718" data-rawheight="307" class="origin_image zh-lightbox-thumb" width="718" data-original="https://pic2.zhimg.com/v2-456ccef041f857a4bae92acd8ad2f0d1_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-456ccef041f857a4bae92acd8ad2f0d1_b.jpg" data-caption="" data-size="normal" data-rawwidth="718" data-rawheight="307" class="origin_image zh-lightbox-thumb lazy" width="718" data-original="https://pic2.zhimg.com/v2-456ccef041f857a4bae92acd8ad2f0d1_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-456ccef041f857a4bae92acd8ad2f0d1_b.jpg"/></figure><p>举几个例子：</p><figure data-size="normal"><noscript><img src="https://pic1.zhimg.com/v2-4c2ea75a00949d81b6d60d527acbfc88_b.jpg" data-caption="" data-size="normal" data-rawwidth="743" data-rawheight="506" class="origin_image zh-lightbox-thumb" width="743" data-original="https://pic1.zhimg.com/v2-4c2ea75a00949d81b6d60d527acbfc88_r.jpg"/></noscript><img src="https://pic1.zhimg.com/v2-4c2ea75a00949d81b6d60d527acbfc88_b.jpg" data-caption="" data-size="normal" data-rawwidth="743" data-rawheight="506" class="origin_image zh-lightbox-thumb lazy" width="743" data-original="https://pic1.zhimg.com/v2-4c2ea75a00949d81b6d60d527acbfc88_r.jpg" data-actualsrc="https://pic1.zhimg.com/v2-4c2ea75a00949d81b6d60d527acbfc88_b.jpg"/></figure><p>条件判断语句比较简单，但还需说明的是条件的写法中用到的运算符：</p><figure data-size="normal"><noscript><img src="https://pic3.zhimg.com/v2-a72593bc78255c6522d181062895aed6_b.jpg" data-caption="" data-size="normal" data-rawwidth="544" data-rawheight="555" class="origin_image zh-lightbox-thumb" width="544" data-original="https://pic3.zhimg.com/v2-a72593bc78255c6522d181062895aed6_r.jpg"/></noscript><img src="https://pic3.zhimg.com/v2-a72593bc78255c6522d181062895aed6_b.jpg" data-caption="" data-size="normal" data-rawwidth="544" data-rawheight="555" class="origin_image zh-lightbox-thumb lazy" width="544" data-original="https://pic3.zhimg.com/v2-a72593bc78255c6522d181062895aed6_r.jpg" data-actualsrc="https://pic3.zhimg.com/v2-a72593bc78255c6522d181062895aed6_b.jpg"/></figure><p><b>止损</b></p><p class="ztext-empty-paragraph"><br/></p><p>狭义的止损是指当亏损达到一定幅度后下单卖出该股票的操作，目的是减少进一步的亏损。广义则指在狭义的思路上衍生的复杂的减少亏损的方法。更多的情况下指狭义的止损。综合运用前文的讲过的内容我们已经可以实现当亏损达到一定幅度后下单卖出该股票的止损操作了，不妨先自己思考下再继续学习。</p><p class="ztext-empty-paragraph"><br/></p><p>通过context的数据可以得到持有股票的成本和现价，从而可以算出该股票的盈亏情况，运用条件判断语句根据盈亏情况从而决定是否卖出股票，从而实现止损操作，代码如下：</p><figure data-size="normal"><noscript><img src="https://pic2.zhimg.com/v2-34fb0f9b0189c1aa4e40cab2a959d95d_b.jpg" data-caption="" data-size="normal" data-rawwidth="729" data-rawheight="373" class="origin_image zh-lightbox-thumb" width="729" data-original="https://pic2.zhimg.com/v2-34fb0f9b0189c1aa4e40cab2a959d95d_r.jpg"/></noscript><img src="https://pic2.zhimg.com/v2-34fb0f9b0189c1aa4e40cab2a959d95d_b.jpg" data-caption="" data-size="normal" data-rawwidth="729" data-rawheight="373" class="origin_image zh-lightbox-thumb lazy" width="729" data-original="https://pic2.zhimg.com/v2-34fb0f9b0189c1aa4e40cab2a959d95d_r.jpg" data-actualsrc="https://pic2.zhimg.com/v2-34fb0f9b0189c1aa4e40cab2a959d95d_b.jpg"/></figure><p>设置回测时间为从2017-03-01到2017-03-31，初始资金为100000，频率为天。回测发现会在2017-03-20触发止损。</p><p class="ztext-empty-paragraph"><br/></p><p><b>自测与自学</b></p><ul><li>实践下文中的例子。</li><li>阅读API文档中Context对象，了解下其中的结构与内容。</li><li>写一个策略，内容为在20180301买入一个股票，在20180321卖出一个股票。股票可以自己定。</li><li>试着根据止损的例子实现止盈，即指当盈利达到一定幅度后下单卖出股票。</li><li>写一个自定义函数，功能是判断一个年份是否是闰年。<br/>闰年定义为：普通年（不能被100整除的年份）能被4整除的为闰年。（如2004年就是闰年,1999年不是闰年）；<br/>世纪年（能被100整除的年份）能被400整除的是闰年。(如2000年是闰年，1900年不是闰年)【提示:利用取余运算（%）判断是否整除】</li></ul>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
