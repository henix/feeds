<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>TiDB 助力卡思数据视频大数据业务创新</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/48674946">原文</a></p>
<div class="title-image"><img src="https://pic3.zhimg.com/v2-632a19539faeb998a4f082d80f81c175_r.jpg" alt=""></div><p>卡思数据是国内领先的视频全网数据开放平台，依托领先的数据挖掘与分析能力，为视频内容创作者在节目创作和用户运营方面提供数据支持，为广告主的广告投放提供数据参考和效果监测，为内容投资提供全面客观的价值评估。</p><img src="https://pic4.zhimg.com/v2-07b63db2487756269fd6da9db5d051ce_r.jpg" data-caption="" data-size="normal" data-rawwidth="1594" data-rawheight="753" data-watermark="watermark" data-original-src="v2-07b63db2487756269fd6da9db5d051ce" data-watermark-src="v2-69ee6da76a96003dff0ae2094e22aaef" data-private-watermark-src=""><p> 图 1 卡思数据产品展示图</p><h2><b>业务发展遇到的痛点</b></h2><p>卡思数据首先通过分布式爬虫系统进行数据抓取，每天新增数据量在 50G - 80G 之间，并且入库时间要求比较短，因此对数据库写入性能要求很高，由于数据增长比较快，对数据库的扩展性也有很高的要求。数据抓取完成后，对数据进行清洗和计算，因为数据量比较大，单表 5 亿 + 条数据，所以对数据库的查询性能要求很高。</p><p>起初卡思数据采用的是多个 MySQL 实例和一个 MongoDB 集群，如图 2。</p><ul><li>MySQL 存储业务相关数据，直接面向用户，对事务的要求很高，但在海量数据存储方面偏弱，由于单行较大，单表数据超过千万或 10G 性能就会急剧下降。</li><li>MongoDB 存储最小单元的数据，MongoDB 有更好的写入性能，保证了每天数据爬取存储速度；对海量数据存储上，MongoDB 内建的分片特性，可以很好的适应大数据量的需求。</li></ul><img src="https://pic4.zhimg.com/v2-146fd37a7dbce48dd44ca485ffaaf630_r.jpg" data-caption="" data-size="normal" data-rawwidth="777" data-rawheight="330" data-watermark="watermark" data-original-src="v2-146fd37a7dbce48dd44ca485ffaaf630" data-watermark-src="v2-db7288bb62cc10adb9d3df1ba44def5c" data-private-watermark-src=""><p>图 2 起初卡思数据架构图 </p><p>但是随着业务发展，暴露出一些问题。</p><ul><li>MySQL 在大数据量的场景下，查询性能难以满足要求，并且扩展能力偏弱，如果采用分库分表方式，需要对业务代码进行全面改造，成本非常高。</li><li>MongoDB 对复杂事务的不支持，前台业务需要用到数据元及连表查询，当前架构支持的不太友好。</li></ul><h2><b>架构优化</b></h2><p><b>1. 需求</b></p><p>针对我们遇到的问题，我们急需这样一款数据库：</p><ul><li>兼容 MySQL 协议，数据迁移成本和代码改造成本低</li><li>插入性能强</li><li>大数据量下的实时查询性能强，无需分库分表</li><li>水平扩展能力强</li><li>稳定性强，产品最好有成熟的案例</li></ul><p><b>2. 方案调研</b></p><p>未选择 TiDB 之前我们调研了几个数据库，Greenplum、HybirdDB for MySQL（PetaData）以及 PolarDB。Greenplum 由于插入性能比较差，并且跟 MySQL 协议有一些不兼容，首先被排除。</p><p>HybirdDB for MySQL 是阿里云推出的 HTAP 关系型数据库，我们在试用一段时间发现一些问题：</p><p>一是复杂语句导致计算引擎拥堵，阻塞所有业务，经常出现查询超时的情况。</p><p>二是连表查询性能低下，网络 I/O 出现瓶颈。举一个常见的关联查询，cd_video 表，2200 万数据，cd_program_video 表，节目和视频的关联表，4700 万数据，在关联字段上都建有索引，如下 SQL：</p><p>select <a href="http://v.id">v.id</a>,v.url,v.extra_id,v.title fromcd_video v join cd_program_video pv on <a href="http://v.id">v.id</a> = pv.video_id where program_id =xxx；</p><p>当相同查询并发超过一定数量时，就会频繁报数据库计算资源不可用的错误。</p><p>三是 DDL 操作比较慢，该字段等操作基本需要几分钟，下发至节点后易出现死锁。</p><p>PolarDB 是阿里云新推出新一代关系型数据库，主要思想是计算和存储分离架构，使用共享存储技术。由于写入还是单点写入，插入性能有上限，未来我们的数据采集规模还会进一步提升，这有可能成为一个瓶颈。另外由于只有一个只读实例，在对大表进行并发查询时性能表现一般。</p><p><b>3. 选择 TiDB</b></p><p>在经历了痛苦的传统解决方案的折磨以及大量调研及对比后，卡思数据最终选择了 TiDB 作为数据仓库及业务数据库。</p><p>TiDB 结合了传统的 RDBMS 和 NoSQL 的最佳特性，高度兼容 MySQL，具备强一致性和高可用性，100% 支持标准的 ACID 事务。由于是 Cloud Native 数据库，可通过并行计算发挥机器性能，在大数量的查询下性能表现良好，并且支持无限的水平扩展，可以很方便的通过加机器解决性能和容量问题。另外提供了非常完善的运维工具，大大减轻数据库的运维工作。</p><h2><b>上线 TiDB</b></h2><p>卡思数据目前配置了两个 32C64G 的 TiDB、三个 4C16G 的 PD、四个 32C128G 的 TiKV。数据量大约 60 亿条、4TB 左右，每天新增数据量大约 5000 万，单节点 QPS 峰值为 3000 左右。</p><p>由于数据迁移不能影响线上业务，卡思数据在保持继续使用原数据架构的前提下，使用 Mydumper、Loader 进行数据迁移，并在首轮数据迁移完成后使用 Syncer 进行增量同步。</p><p>卡思数据部署了数据库监控系统（Prometheus/Grafana）来实时监控服务状态，可以非常清晰的查看服务器问题。</p><p><b>由于 TiDB 对 MySQL 的高度兼容性，在数据迁移完成后，几乎没有对代码做任何修改，平滑实现了无侵入升级。</b></p><p>目前卡思数据的架构如图 3：</p><img src="https://pic1.zhimg.com/v2-fac44545432ecf26d884a7440c333c9f_r.jpg" data-caption="" data-size="normal" data-rawwidth="794" data-rawheight="606" data-watermark="watermark" data-original-src="v2-fac44545432ecf26d884a7440c333c9f" data-watermark-src="v2-75128212ab54ea15dc91b47a7cce596d" data-private-watermark-src=""><p>图 3 目前卡思数据架构图</p><p>查询性能，单表最小 1000 万，最大 8 亿，有比较复杂的连表查询，整体响应延时非常稳定，监控展示如图 4、图 5。</p><img src="https://pic3.zhimg.com/v2-54d64dec60af44a379f55b6ff9b4ab84_r.jpg" data-caption="" data-size="normal" data-rawwidth="866" data-rawheight="279" data-watermark="watermark" data-original-src="v2-54d64dec60af44a379f55b6ff9b4ab84" data-watermark-src="v2-5c0d79b3b7dfa1bd50565bca3bc4dbe0" data-private-watermark-src=""><p>图 4 Duration 监控展示图</p><img src="https://pic2.zhimg.com/v2-0ac9b8d8cd9b6de67cac4a3540531b85_r.jpg" data-caption="" data-size="normal" data-rawwidth="866" data-rawheight="244" data-watermark="watermark" data-original-src="v2-0ac9b8d8cd9b6de67cac4a3540531b85" data-watermark-src="v2-a700f65ed736c50ffbc6ad1db8695976" data-private-watermark-src=""><p> 图 5 QPS 监控展示图</p><h2><b>未来展望</b></h2><p>目前的卡思数据已全部迁移至 TiDB，但对 TiDB 的使用还局限在数据存储上，可以说只实现了 OLTP。卡思数据准备深入了解 OLAP，将目前一些需要实时返回的复杂查询、数据分析下推至 TiDB。既减少计算服务的复杂性，又可增加数据的准确性。</p><h2><b>感谢 PingCAP</b></h2><p>非常感谢 PingCAP 小伙伴们在数据库上线过程中的大力支持，每次遇到困难都能及时、细心的给予指导，非常的专业和热心。相信 PingCAP 会越来越好，相信 TiDB 会越来越完善，引领 NewSQL 的发展。</p><p><br></p><blockquote><b>作者：刘广信，火星文化技术经理</b></blockquote><p></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
