<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Erlang能在OSv上启动了</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/19916813">原文</a></p>
<p>仅仅是能启动。</p><p>这是为了给还不存在的<b>Web IDE</b>找个合适的运行环境。虽然也可以基于AlpineLinux之类的微型Linux发行版来做，毕竟还是要写点脚本啥的，略麻烦。就去试试OSv了。</p><p>一开始按OSv Wiki上的说法，是要编译成.so才能运行的。我改了Makefile把beam改成beam.so，结果发现，Erlang在编译完beam之后，会用这个新编译出来的beam去编译erlang代码。那么问题就来了，改成.so之后根本就没法直接 exec 啊，make到这一步就失败了。</p><p>后来一想，这也不是什么问题，大不了既生成beam又生成beam.so就可以了嘛。没错，这样是能编译通过了。但是在OSv上怎么都运行不起来。在OSv的邮件列表里找，还没找到类似的问题，就看到说不用非得编译成.so的，只要编译成Position Independent Executable就可以了。那就把Makefile改回来。</p><p>我猜是默认开了很多选项，才导致启动不起来的。最后发现几乎都关完了还是开不起来。又去仔细看了看OSv Wiki，发现其实就是有个函数没实现嘛。那就照着样子弄个空的上去。结果还是启动不了，"erts_poll_init(): Failed to get max number of files:"。邮件列表里查了下，就是因为sysconf的实现是不完全的，随便返回个很大的整数就好了。打上<a data-title="add sched_getaffinity stub and implement sysconf(_SC_OPEN_MAX) ·  e422589 · cloudius-systems/osv · GitHub" data-editable="true" href="https://github.com/cloudius-systems/osv/commit/e42258914b9b65791b1c64bee0391a5c2b0790c7">补丁</a>，一个单线程的Erlang可以启动了。 <br></p><p>接着把SMP支持打开吧。却又启动不起来。结果发现有人在试图运行Go时，就已经碰到了类似的问题。用了他的<a class="" data-title="Google 网上论坛" data-editable="true" href="https://groups.google.com/d/msg/osv-dev/C6Qc2dyv_jc/qKjA0K1ATWoJ">补丁</a>，确实可以启动了。启动之后，我明显感觉到CPU风扇在加速。一看，top里qemu进程的CPU占用率是接近200%啊。在我还在找这是哪里的问题时，有人把之前那个补丁改好<a data-title="Add support for waking up only a given amount of threads ·  50a431a · cloudius-systems/osv · GitHub" data-editable="true" href="https://github.com/cloudius-systems/osv/commit/50a431a731af759ed3a2e774fd19b5808676cf49">提交</a>进去了。他应该是没注意到开了SMP会出问题。</p><p>找来找去也没找到Erlang每个线程功能的文档。后来在<a data-title="Etsukata blog: Erlang VM(BEAM) スレッド構成" data-editable="true" class="" href="http://blog.etsukata.com/2014/02/erlang-vmbeam.html">Etsukata blog: Erlang VM(BEAM) スレッド構成</a>里才看到比较详细的说明。对照后发现就只有主线程和child waiter线程在占用CPU。看了下代码，就是OSv的<a data-title="select" data-editable="true" class="" href="https://github.com/cloudius-systems/osv/commit/a2a4b3193d20fb0536f9ab2485b7b970a1be047c">select</a>和<a data-title="libc: Fix waitpid return code ·  45a7032 · cloudius-systems/osv · GitHub" data-editable="true" href="https://github.com/cloudius-systems/osv/commit/45a703299c91c4bd839380a85daac34797855ad2">waitpid</a>有问题。改了就好了。</p><p>流水帐完了。<b>还不赶紧来写个Web IDE</b>。 </p><p>就是这样</p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
