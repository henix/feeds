<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Rust Quiz 解读：Quiz 22</title>
</head>
<body>
<p><a href="https://zhuanlan.zhihu.com/p/53599961">原文</a></p>
<div class="title-image"><img src="https://pic4.zhimg.com/v2-27785f4d62d62024a054a78b168015d1_b.jpg" alt=""></div><blockquote>来自于RustFest 2018 大会上Alex Crichton 和 David Tolnay两位大佬的轻演讲主题：Rust Quiz<br><a href="http://link.zhihu.com/?target=https%3A//github.com/dtolnay/rust-quiz" class=" wrap external" target="_blank" rel="nofollow noreferrer">rust-quiz源码</a><br><a href="http://link.zhihu.com/?target=https%3A//dtolnay.github.io/rust-quiz/18" class=" wrap external" target="_blank" rel="nofollow noreferrer">在线练习和解答</a><br><a href="http://link.zhihu.com/?target=https%3A//www.youtube.com/watch%3Fv%3DQtDj9R6vtA8%26index%3D6%26list%3DPLgC1L0fKd7UlpVTHVfLYVtudVx8CzbSxW%26t%3D0s" class=" wrap external" target="_blank" rel="nofollow noreferrer">视频</a><br>不得不说，两位大佬出的题非常具有迷惑性，一不留神就落入了陷阱。</blockquote><h2><b>Quiz  22:</b></h2><p>下面这段代码输出什么？</p><div class="highlight"><pre><code class="language-rust"><span></span><span class="n">macro_rules</span><span class="o">!</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$a</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$a</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$b</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$a</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$b</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$c</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$a</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$b</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$c</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$d</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">"4"</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$a</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$b</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$c</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$d</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$e</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">"5"</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$a</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$b</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$c</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$d</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$e</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$f</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">"6"</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$a</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$b</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$c</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$d</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$e</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$f</span>:<span class="nc">tt</span><span class="w"> </span><span class="cp">$g</span>:<span class="nc">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">"7"</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="o">!</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="o">!</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="o">!</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="o">!</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0e1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="o">!</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0e-1</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><p><b>输出结果： 22222</b></p><h2><b>考察要点：</b></h2><ol><li>声明宏模式分支匹配规则</li><li>Rust如何对表达式进行词法分析</li></ol><p>Quiz代码中定义了m!宏，通过该宏可以判断Rust如何对表达式进行解析。</p><p>在main函数中：</p><p><code>m!(-1)</code>，其中<code>-1</code>，会被Rust分词为两个独立词条（Token）：<code>-</code>和<code>1</code>。所以，宏调用会匹配到第二个模式条件分支，最终输出：<code>2</code>。</p><p>Rust对于数字<code>1</code>、<code>1.</code>、<code>1.0</code>、<code>1.0e1</code>和<code>1.0e-1</code>均会识别为一个词条。所以，剩余的4个宏调用，也同样会输出： <code>2</code>。</p><p><code>-</code>永远都会被识别为独立的词条，比如下面这段代码：</p><div class="highlight"><pre><code class="language-rust"><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">3</span><span class="k">i32</span><span class="p">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><p>输出结果是：<code>-81</code>。</p><p><br></p><p><a href="http://link.zhihu.com/?target=https%3A//dtolnay.github.io/rust-quiz/22" class=" wrap external" target="_blank" rel="nofollow noreferrer">点此查看 Rust Quiz 22</a></p>
<script async defer="defer" src="https://www.googletagmanager.com/gtag/js?id=UA-7909075-5"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-7909075-5');
</script>
<script>
var _hmt = _hmt || [];
</script>
<script async defer="defer" src="https://hm.baidu.com/hm.js?e3d40295e416616ddc21287da9646d31"></script>
</body>
</html>
